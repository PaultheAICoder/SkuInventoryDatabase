# Task #295 - Silent Admin Privilege Revocation when updating User Companies - Completion Report
**Status**: COMPLETE
**Generated By**: Test-and-Cleanup Agent (combined workflow)

## Executive Summary
Fixed critical bug in PUT `/api/users/[id]/companies` where roles were being hardcoded based on primary company status instead of preserving existing roles. When an admin updated a user's company assignments, any existing 'admin' roles for non-primary companies were silently downgraded to 'ops'. The fix fetches existing roles before deletion and preserves them when recreating records.

Key metrics:
- Files modified: 1 (API route)
- Files created: 1 (integration test)
- Tests added: 12 regression tests
- All tests passing

## What Was Accomplished

### API/Backend: 1 file
- `/home/pbrown/SkuInventory/src/app/api/users/[id]/companies/route.ts` - Fixed role preservation logic

### Tests: 1 file, 12 tests
- `/home/pbrown/SkuInventory/tests/integration/user-companies.test.ts` - Comprehensive regression tests

## Validation Results

### Pre-flight
- TypeScript: PASS (zero errors)
- Build: PASS (92 pages generated)
- Lint: PASS (zero warnings)

### Test Execution
- Tests Run: 12
- Tests Passed: 12
- Test Duration: 8.72s

### E2E Testing
- N/A - This is a backend API bug fix with no UI changes

### Issues Fixed During Validation
None - Build agent's implementation was complete and correct.

### Warnings Fixed
- 0 warnings (none present)

## Deferred Work Verification
**Deferred Items**: 0
- No deferred work mentioned in issue
- Related issue #310 (Remove Legacy Global Role Checks) exists and is tracked separately

## Known Limitations & Future Work
None identified. The fix is complete and addresses the reported bug.

## Workflow Performance
| Phase | Duration | Target |
|-------|----------|--------|
| Scout-and-Plan | ~30m | varies |
| Build | ~17m | varies |
| Test-and-Cleanup | ~2m | <10m |
| **Total** | **~49m** | <45m |

## Scope Accuracy Analysis
**Plan Listed Files**: 2
**Build Actually Modified**: 2
**Accuracy**: 100%

## Lessons Learned (REQUIRED)

### What Went Well
1. Clear bug report with exact line number and reproduction steps
2. Build agent implemented the fix correctly on first attempt
3. Comprehensive test coverage added (12 tests) prevents regression

### What Could Be Improved
1. Original code review could have caught this logic error before deployment
2. Integration tests for the user companies route should have existed from the start

### Similar Bug Patterns Detected (CHECK THIS)
**Did the bug fixed in this issue exist in other files?**
- Checked for `UserRole.admin|ops|viewer` patterns across codebase
- Only found usage in the fixed route and the new test file
- No other files appear to have the same pattern of role hardcoding

### Process Improvements Identified
- [ ] Consider adding role preservation tests to other user-related API routes
- [ ] Code review checklist item: "Does this route preserve existing entity properties when updating?"

## Git Information
**Commit**: (to be created)
**Files Changed**: 2

## The Bug Fix

### Before (buggy):
```typescript
const userPrimaryCompanyId = currentPrimary?.companyId

await tx.userCompany.deleteMany({ where: { userId: id } })

const userCompanyRecords = companyIds.map((companyId) => ({
  userId: id,
  companyId,
  role: userPrimaryCompanyId === companyId ? UserRole.admin : UserRole.ops,  // BUG
  isPrimary: companyId === newPrimaryCompanyId,
}))
```

### After (fixed):
```typescript
const existingUserCompanies = await tx.userCompany.findMany({
  where: { userId: id },
  select: { companyId: true, role: true },
})
const existingRoles = new Map(
  existingUserCompanies.map((uc) => [uc.companyId, uc.role])
)

await tx.userCompany.deleteMany({ where: { userId: id } })

const userCompanyRecords = companyIds.map((companyId) => ({
  userId: id,
  companyId,
  role: existingRoles.get(companyId) ?? UserRole.ops,  // FIX: preserves existing roles
  isPrimary: companyId === newPrimaryCompanyId,
}))
```

The fix ensures:
1. Existing roles are captured before deletion
2. When recreating records, existing roles are preserved
3. Only new company assignments get the default 'ops' role
