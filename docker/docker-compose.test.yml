# docker/docker-compose.test.yml
# Test environment Docker services
# IMPORTANT: This runs in PARALLEL with production, NOT as a replacement
#
# Port Architecture:
#   - Web:      2345 (external) -> 4500 (internal)
#   - Database: 2346 (external) -> 5432 (internal)
#
# Usage:
#   cd docker && docker compose -f docker-compose.test.yml up -d
#
# Access:
#   Web: http://172.16.20.50:2345
#   DB:  postgresql://inventory_test:inventory_test_2025@localhost:2346/inventory_test

services:
  app-test:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: inventory-app-test
    restart: unless-stopped
    ports:
      - '2345:4500'
    environment:
      - NODE_ENV=test
      - DATABASE_URL=postgresql://inventory_test:inventory_test_2025@db-test:5432/inventory_test
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - NEXTAUTH_URL=http://172.16.20.50:2345
      - INTERNAL_API_URL=http://127.0.0.1:4500
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - GITHUB_API_TOKEN=${GITHUB_API_TOKEN:-}
    depends_on:
      db-test:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'wget', '-q', '--spider', 'http://127.0.0.1:4500/api/health']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - inventory-test-net

  db-test:
    image: postgres:16-alpine
    container_name: inventory-db-test
    restart: unless-stopped
    ports:
      - '2346:5432'
    environment:
      POSTGRES_USER: inventory_test
      POSTGRES_PASSWORD: inventory_test_2025
      POSTGRES_DB: inventory_test
    volumes:
      - postgres_data_test:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U inventory_test -d inventory_test']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - inventory-test-net

volumes:
  postgres_data_test:

networks:
  inventory-test-net:
    driver: bridge
