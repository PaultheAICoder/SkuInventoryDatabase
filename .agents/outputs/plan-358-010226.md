# Implementation Plan
**Generated**: 2026-01-02T10:30:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: Issue #358
**Estimated Build Time**: 4-6 hours
**Complexity**: Moderate

## Investigation Summary

### Request Analysis
**Type**: Feature
**Source**: GitHub Issue #358
**Priority**: P2 (as per spec User Story 3)

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="duplicate"` or `--filter="recommendations"`

### Issue Validation
**Status**: Valid
**Recent Changes**: Recommendation engine core (KEYWORD_GRADUATION) was implemented in recent issues. DUPLICATE_KEYWORD infrastructure (types, enum, UI styling) already exists but detection logic is not implemented.

### Current State Assessment
- **Existing components**:
  - `RecommendationType.DUPLICATE_KEYWORD` enum already defined in Prisma schema and TypeScript types
  - `RecommendationCard.tsx` already has styling/icon config for DUPLICATE_KEYWORD (AlertTriangle, yellow)
  - `generator.ts` has TODO comments for DUPLICATE_KEYWORD implementation
  - Recommendation model and ChangeLogEntry model already support this type
  - `ChangeLogTable.tsx` and filters already handle DUPLICATE_KEYWORD display
- **Database**: No changes needed - Recommendation model already supports DUPLICATE_KEYWORD type
- **API Routes**: `/api/recommendations` POST endpoint calls `generateRecommendations()` which needs extension
- **Types**: Already complete in `src/types/recommendations.ts`

### Dependencies & Blockers
1. None identified - all infrastructure exists

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Moderate
**Effort**: 4-6 hours
**Risk**: Low - follows established patterns exactly

### Patterns Identified
**Primary**: `/home/pbrown/SkuInventory/src/services/recommendations/keyword-graduation.ts` - Copy structure for duplicate detection
**Secondary**: `/home/pbrown/SkuInventory/src/services/recommendations/generator.ts` - Extend to call duplicate finder

### Ripple Effect Analysis
**Files Identified**: 6
- `/home/pbrown/SkuInventory/src/services/recommendations/duplicate-detection.ts` - NEW FILE
- `/home/pbrown/SkuInventory/src/services/recommendations/index.ts` - Add exports
- `/home/pbrown/SkuInventory/src/services/recommendations/generator.ts` - Integrate duplicate detection
- `/home/pbrown/SkuInventory/src/components/features/RecommendationCard.tsx` - Add DUPLICATE_KEYWORD specific display
- `/home/pbrown/SkuInventory/src/components/features/AcceptRejectModal.tsx` - Add campaign selector for accept action
- `/home/pbrown/SkuInventory/src/lib/recommendation-utils.ts` - Utility functions (already has label)

---

## Executive Summary

Implement duplicate keyword detection for the recommendation engine. This feature finds keywords that appear in multiple campaigns for the same brand, allowing users to consolidate them and avoid bidding against themselves. The implementation follows the established pattern from keyword-graduation.ts and requires creating a new detection service, integrating it into the generator, and adding campaign selection UI for the accept action.

## Phase 1: Service Layer - Duplicate Detection

### Subtask 1.1: Create Duplicate Detection Service
**File**: `/home/pbrown/SkuInventory/src/services/recommendations/duplicate-detection.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/services/recommendations/keyword-graduation.ts`
**Instructions**:
1. Create new file with the following structure:
   ```typescript
   /**
    * Duplicate Keyword Detection Service
    *
    * Identifies keywords appearing in multiple campaigns for the same brand.
    * Prevents bidding against yourself by flagging duplicates for consolidation.
    */
   ```

2. Define types:
   - `DuplicateKeywordGroup`: Keyword, list of campaign occurrences with metrics
   - `CampaignOccurrence`: campaignId, campaignName, matchType, metrics (spend, orders, sales, impressions, clicks, acos)
   - `DuplicateRecommendation`: Similar to GraduationRecommendation but type `DUPLICATE_KEYWORD`

3. Implement `findDuplicateKeywords(brandId: string, lookbackDays: number)`:
   - Query KeywordMetric using Prisma groupBy on [keyword, campaignId, matchType]
   - Filter to only include keywords appearing in 2+ campaigns
   - Aggregate metrics per occurrence
   - Return grouped results

4. Implement `generateDuplicateRecommendation(group: DuplicateKeywordGroup, keywordMetricId: string | null)`:
   - Build rationale showing all campaigns and their metrics
   - Calculate confidence based on data quality
   - Set expectedImpact based on potential spend optimization
   - Store campaign occurrences in metadata for UI display

**Prisma groupBy query pattern**:
```typescript
const keywordMetrics = await prisma.keywordMetric.groupBy({
  by: ['keyword', 'campaignId', 'matchType'],
  where: {
    campaignId: { in: campaignIds },
    date: { gte: startDate },
  },
  _sum: {
    spend: true,
    orders: true,
    sales: true,
    impressions: true,
    clicks: true,
  },
  _count: {
    id: true,
  },
})
```

**Completion Criteria**:
- [ ] File created with proper JSDoc comments
- [ ] Types exported: DuplicateKeywordGroup, CampaignOccurrence, DuplicateRecommendation
- [ ] findDuplicateKeywords function implemented
- [ ] generateDuplicateRecommendation function implemented
- [ ] `npx tsc --noEmit` passes

### Subtask 1.2: Export Duplicate Detection from Index
**File**: `/home/pbrown/SkuInventory/src/services/recommendations/index.ts`
**Pattern**: Follow existing exports in the file
**Instructions**:
1. Add export block for duplicate detection:
   ```typescript
   // Duplicate Keyword Detection
   export {
     findDuplicateKeywords,
     generateDuplicateRecommendation,
     type DuplicateKeywordGroup,
     type CampaignOccurrence,
     type DuplicateRecommendation,
   } from './duplicate-detection'
   ```

**Completion Criteria**:
- [ ] Exports added
- [ ] `npx tsc --noEmit` passes

## Phase 2: Generator Integration

### Subtask 2.1: Integrate Duplicate Detection into Generator
**File**: `/home/pbrown/SkuInventory/src/services/recommendations/generator.ts`
**Pattern**: Follow pattern of graduation candidate processing (lines 79-101)
**Instructions**:
1. Add imports at top:
   ```typescript
   import {
     findDuplicateKeywords,
     generateDuplicateRecommendation,
     type DuplicateKeywordGroup,
     type DuplicateRecommendation,
   } from './duplicate-detection'
   ```

2. Update `GenerateRecommendationsResult` type to handle multiple recommendation types:
   - Change `recommendations: Array<{ type: string; keyword: string; confidence: string }>`

3. Add duplicate detection call in `generateRecommendations()` after graduation candidates:
   ```typescript
   // Find duplicate keywords
   const duplicateGroups = await findDuplicateKeywords(brandId, lookbackDays)

   // Generate recommendations for each duplicate group
   for (const group of duplicateGroups) {
     try {
       const latestMetric = await findLatestKeywordMetricId(
         group.keyword,
         group.occurrences[0].campaignId
       )
       const recommendation = generateDuplicateRecommendation(group, latestMetric)
       duplicateRecommendations.push(recommendation)
     } catch (error) {
       // ... error handling
     }
   }
   ```

4. Update `saveRecommendations()` to handle DUPLICATE_KEYWORD type:
   - Use union type for recommendations parameter
   - Check for existing PENDING DUPLICATE_KEYWORD recommendations by keyword + brandId (not campaignId)

5. Update function comments to reflect new capability

**Completion Criteria**:
- [ ] Imports added
- [ ] Duplicate detection integrated into generateRecommendations()
- [ ] saveRecommendations handles both recommendation types
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds

## Phase 3: Frontend - Display Enhancements

### Subtask 3.1: Enhance RecommendationCard for DUPLICATE_KEYWORD
**File**: `/home/pbrown/SkuInventory/src/components/features/RecommendationCard.tsx`
**Pattern**: Existing card structure, add conditional rendering for DUPLICATE_KEYWORD type
**Instructions**:
1. Add helper function to extract campaign occurrences from metadata:
   ```typescript
   interface CampaignOccurrence {
     campaignId: string
     campaignName: string
     matchType: string
     spend: number
     orders: number
     acos: number
   }

   function getCampaignOccurrences(metadata: Record<string, unknown> | null): CampaignOccurrence[] {
     if (!metadata || !metadata.occurrences) return []
     return metadata.occurrences as CampaignOccurrence[]
   }
   ```

2. Add conditional rendering in CardContent for DUPLICATE_KEYWORD type:
   - Show "Found in X campaigns" heading
   - List each campaign with name, match type, spend, orders, ACOS
   - Use small table or list format

   Example JSX:
   ```tsx
   {recommendation.type === 'DUPLICATE_KEYWORD' && (
     <div className="bg-muted/50 p-3 rounded-md">
       <p className="text-sm font-medium mb-2">
         Found in {getCampaignOccurrences(recommendation.metadata).length} campaigns:
       </p>
       <div className="space-y-2 text-sm">
         {getCampaignOccurrences(recommendation.metadata).map((occ, idx) => (
           <div key={occ.campaignId} className="flex justify-between items-center">
             <span className="font-medium">{occ.campaignName}</span>
             <span className="text-muted-foreground">
               ${occ.spend.toFixed(2)} | {occ.orders} orders | {(occ.acos * 100).toFixed(1)}% ACOS
             </span>
           </div>
         ))}
       </div>
     </div>
   )}
   ```

**Completion Criteria**:
- [ ] Campaign occurrences displayed for DUPLICATE_KEYWORD recommendations
- [ ] Shows all metrics per campaign (spend, orders, ACOS)
- [ ] `npx tsc --noEmit` passes
- [ ] UI renders correctly (manual verification)

### Subtask 3.2: Add Campaign Selector to Accept Modal for DUPLICATE_KEYWORD
**File**: `/home/pbrown/SkuInventory/src/components/features/AcceptRejectModal.tsx`
**Pattern**: Follow existing mode-based conditional rendering
**Instructions**:
1. Add new prop to interface:
   ```typescript
   interface AcceptRejectModalProps {
     // ... existing props
     recommendationType?: RecommendationType
     campaignOptions?: Array<{ id: string; name: string }>
   }
   ```

2. Add state for selected campaign:
   ```typescript
   const [selectedCampaignId, setSelectedCampaignId] = useState<string>('')
   ```

3. Add conditional rendering in the modal content when mode === 'accept' AND recommendationType === 'DUPLICATE_KEYWORD':
   ```tsx
   {mode === 'accept' && recommendationType === 'DUPLICATE_KEYWORD' && campaignOptions && campaignOptions.length > 0 && (
     <div className="space-y-2">
       <Label htmlFor="campaign">
         Keep keyword in campaign <span className="text-destructive">*</span>
       </Label>
       <Select value={selectedCampaignId} onValueChange={setSelectedCampaignId}>
         <SelectTrigger id="campaign">
           <SelectValue placeholder="Select campaign to keep" />
         </SelectTrigger>
         <SelectContent>
           {campaignOptions.map((campaign) => (
             <SelectItem key={campaign.id} value={campaign.id}>
               {campaign.name}
             </SelectItem>
           ))}
         </SelectContent>
       </Select>
       <p className="text-xs text-muted-foreground">
         The keyword will be removed from other campaigns.
       </p>
     </div>
   )}
   ```

4. Update validation in handleConfirm:
   ```typescript
   if (mode === 'accept' && recommendationType === 'DUPLICATE_KEYWORD' && campaignOptions?.length && !selectedCampaignId) {
     setError('Please select which campaign to keep the keyword in')
     return
   }
   ```

5. Update onConfirm call to include selectedCampaignId:
   ```typescript
   await onConfirm({
     notes: mode === 'accept' ? notes.trim() || undefined : undefined,
     reason: mode === 'reject' ? reason.trim() : undefined,
     snoozeDays: mode === 'snooze' ? parseInt(snoozeDays, 10) : undefined,
     selectedCampaignId: mode === 'accept' && recommendationType === 'DUPLICATE_KEYWORD' ? selectedCampaignId : undefined,
   })
   ```

6. Update onConfirm prop type signature to include selectedCampaignId

**Completion Criteria**:
- [ ] Campaign selector appears for DUPLICATE_KEYWORD accept action
- [ ] Validation requires campaign selection
- [ ] Selected campaign ID passed to onConfirm
- [ ] `npx tsc --noEmit` passes

### Subtask 3.3: Update RecommendationCard to Pass Campaign Options to Modal
**File**: `/home/pbrown/SkuInventory/src/components/features/RecommendationCard.tsx`
**Instructions**:
1. Extract campaign options from metadata when opening accept modal for DUPLICATE_KEYWORD:
   ```typescript
   const campaignOptions = recommendation.type === 'DUPLICATE_KEYWORD'
     ? getCampaignOccurrences(recommendation.metadata).map(occ => ({
         id: occ.campaignId,
         name: occ.campaignName,
       }))
     : undefined
   ```

2. Pass to AcceptRejectModal:
   ```tsx
   <AcceptRejectModal
     open={showAcceptModal}
     onOpenChange={setShowAcceptModal}
     mode="accept"
     keyword={displayName}
     recommendationType={recommendation.type}
     campaignOptions={campaignOptions}
     onConfirm={handleAccept}
   />
   ```

3. Update handleAccept to include selectedCampaignId in notes:
   ```typescript
   const handleAccept = async (data: { notes?: string; selectedCampaignId?: string }) => {
     setIsActioning(true)
     try {
       // For DUPLICATE_KEYWORD, include the selected campaign in notes
       let acceptNotes = data.notes
       if (recommendation.type === 'DUPLICATE_KEYWORD' && data.selectedCampaignId) {
         const selectedCampaign = campaignOptions?.find(c => c.id === data.selectedCampaignId)
         acceptNotes = `Kept in campaign: ${selectedCampaign?.name || data.selectedCampaignId}${data.notes ? `. ${data.notes}` : ''}`
       }
       await onAccept(recommendation.id, acceptNotes)
     } finally {
       setIsActioning(false)
     }
   }
   ```

**Completion Criteria**:
- [ ] Campaign options extracted from metadata
- [ ] Props passed to AcceptRejectModal
- [ ] Accept handler logs selected campaign
- [ ] `npx tsc --noEmit` passes

## Phase 4: Validation and Testing

### Subtask 4.1: Verify Build and TypeScript
**Instructions**:
1. Run full TypeScript check: `npx tsc --noEmit`
2. Run build: `npm run build`
3. Run lint: `npm run lint`

**Completion Criteria**:
- [ ] `npx tsc --noEmit` passes with no errors
- [ ] `npm run build` completes successfully
- [ ] `npm run lint` passes (or only pre-existing warnings)

### Subtask 4.2: Manual Verification
**Instructions**:
1. Start test environment if not running
2. Access test app at http://172.16.20.50:2345
3. Navigate to Recommendations page
4. Click "Generate Recommendations" button
5. Verify DUPLICATE_KEYWORD recommendations appear (if test data has duplicates)
6. Verify card displays campaign occurrences with metrics
7. Click Accept on a duplicate recommendation
8. Verify campaign selector appears in modal
9. Select a campaign and accept
10. Verify change log entry includes selected campaign

**Completion Criteria**:
- [ ] DUPLICATE_KEYWORD recommendations generate (with appropriate test data)
- [ ] Campaign occurrences display correctly
- [ ] Accept modal shows campaign selector
- [ ] Acceptance logs selected campaign

---

## Summary of Deliverables
**Files Created**: 1
- `/home/pbrown/SkuInventory/src/services/recommendations/duplicate-detection.ts`

**Files Modified**: 4
- `/home/pbrown/SkuInventory/src/services/recommendations/index.ts`
- `/home/pbrown/SkuInventory/src/services/recommendations/generator.ts`
- `/home/pbrown/SkuInventory/src/components/features/RecommendationCard.tsx`
- `/home/pbrown/SkuInventory/src/components/features/AcceptRejectModal.tsx`

## Handoff to Build Agent
1. Execute subtasks in exact order (Phase 1 -> 2 -> 3 -> 4)
2. Complete each subtask fully before moving to next
3. Test completion criteria before proceeding
4. Follow reference patterns exactly from keyword-graduation.ts

## Test Strategy Note
- No automated tests required for this feature
- Manual verification against test environment
- Build and TypeScript checks are the primary validation

## Spec Reference
**Feature Spec**: `/home/pbrown/SkuInventory/specs/001-recommendation-engine/spec.md`
**User Story**: User Story 3 - Duplicate Keyword Detection (Priority: P2)

### Acceptance Criteria from Spec
1. **Given** the same keyword (exact match) appears in 2+ campaigns for the same brand, **When** recommendations are generated, **Then** a "Duplicate Keyword" recommendation is created showing all instances
2. **Given** a duplicate recommendation exists, **When** I view details, **Then** I see each campaign where the keyword appears with individual performance metrics
3. **Given** a duplicate recommendation exists, **When** I accept it, **Then** the system logs which campaign I chose to keep the keyword in

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 10m |
| **Total** | **30m** |
