# Scout Report: Reorder view lead-time hints and prioritized list

## Request Analysis
**Type**: Enhancement
**Source**: GitHub Issue #19
**Priority**: Medium

## Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="reorder|lead.*time|urgency"` for testing

## Issue Validation
**Status**: ✅ Valid
**Recent Changes**:
- Issue #18 (Dec 3) added dashboard time filter and sparklines - does NOT conflict
- No related closed issues found that would make this obsolete
- Current code shows reorder status calculation exists (calculateReorderStatus in src/services/inventory.ts)
- CriticalComponentsList exists but lacks lead-time hints and urgency sorting

## Current State

### Existing Components
- ✅ **Database**: leadTimeDays field exists in Component model (prisma/schema.prisma line 103)
- ✅ **Service**: calculateReorderStatus function exists (src/services/inventory.ts lines 71-86)
- ✅ **Service**: getComponentQuantities exists (src/services/inventory.ts lines 41-63)
- ✅ **Service**: getCompanySettings exists (src/services/inventory.ts lines 14-25)
- ✅ **Component**: CriticalComponentsList exists (src/components/features/CriticalComponentsList.tsx)
- ✅ **Component**: ReorderStatusBadge exists (src/components/features/ReorderStatusBadge.tsx)
- ✅ **API**: Dashboard API exists (src/app/api/dashboard/route.ts)
- ✅ **Type**: ReorderStatus type defined (src/types/index.ts line 28)
- ✅ **Type**: ComponentResponse includes leadTimeDays (src/types/component.ts line 60)
- ✅ **Settings**: reorderWarningMultiplier in company settings (src/types/settings.ts line 8)

### Current Dashboard Implementation
- Dashboard page at src/app/(dashboard)/page.tsx (client component)
- Fetches from /api/dashboard endpoint
- Shows CriticalComponentsList with top 10 critical components
- Currently sorts by deficit (line 127-131): `(reorderPoint - quantityOnHand)`
- Shows deficit column but NO lead-time information
- No hint text like "Order soon (X days lead time)"

### Current CriticalComponentsList
**Location**: /home/pbrown/SkuInventory/src/components/features/CriticalComponentsList.tsx
**Current Columns**:
1. Component (name + skuCode)
2. On Hand
3. Reorder Point
4. Deficit (calculated as reorderPoint - quantityOnHand)
5. Status (badge only)

**Missing**:
- Lead time information
- Hint text for urgency
- More sophisticated urgency sorting

### Reorder Status Calculation Logic
**Location**: /home/pbrown/SkuInventory/src/services/inventory.ts lines 71-86

```typescript
function calculateReorderStatus(
  quantityOnHand: number,
  reorderPoint: number,
  reorderWarningMultiplier: number = 1.5
): ReorderStatus
```

- Critical: quantityOnHand <= reorderPoint
- Warning: quantityOnHand <= reorderPoint * reorderWarningMultiplier
- OK: quantityOnHand > reorderPoint * reorderWarningMultiplier

## Dependencies & Blockers

**None identified**. All required infrastructure exists:
1. ✅ Database field: leadTimeDays exists
2. ✅ API returns leadTimeDays in component responses
3. ✅ Dashboard fetches critical components
4. ✅ CriticalComponentsList displays them
5. ✅ Company settings available for defaults

**Can Proceed?**: YES

## Complexity Assessment
**Complexity**: Small to Moderate
**Effort**: 3-6 hours
**Risk**: Low

### Why Small to Moderate:
1. **Existing Pattern**: CriticalComponentsList already exists and works
2. **Data Available**: leadTimeDays already in database and API responses
3. **No Schema Changes**: No migrations needed
4. **Isolated Changes**: Only affects reorder display components
5. **Clear Requirements**: PRD specifies exact behavior

### Implementation Phases:
1. **Phase 1** (1-2h): Add leadTimeDays to dashboard API response for critical components
2. **Phase 2** (1-2h): Enhance CriticalComponentsList with lead-time hint text and column
3. **Phase 3** (1h): Implement urgency sorting algorithm
4. **Phase 4** (1h): Add tests for hint generation and urgency ordering

## Patterns to Follow

### Primary Pattern: CriticalComponentsList Enhancement
**File**: /home/pbrown/SkuInventory/src/components/features/CriticalComponentsList.tsx

**Current Pattern**:
- Card with table layout
- Maps over components array
- Displays component data in rows
- Links to component detail pages
- Shows status badges

**Enhancement Approach**:
- Add "Lead Time" column after Deficit
- Add "Urgency Hint" column or integrate into Status column
- Generate hint text based on status + lead time

### Secondary Pattern: Dashboard Stats Display
**File**: /home/pbrown/SkuInventory/src/components/features/DashboardStats.tsx

**Pattern**: Card-based stat display with clear labels

### Tertiary Pattern: Component Filtering/Sorting
**File**: /home/pbrown/SkuInventory/src/app/(dashboard)/components/page.tsx (lines 59-108)

**Pattern**: Post-fetch filtering and sorting for computed fields

## Files to Create/Modify

### Files to Modify

1. **/home/pbrown/SkuInventory/src/app/api/dashboard/route.ts**
   - **Purpose**: Add leadTimeDays to criticalComponents response
   - **Change**: Include leadTimeDays in the component selection and mapping
   - **Lines**: ~88 (select), ~117-122 (mapping)
   - **Risk**: Low - just adding a field

2. **/home/pbrown/SkuInventory/src/components/features/CriticalComponentsList.tsx**
   - **Purpose**: Add lead-time column and hint text
   - **Changes**:
     - Add leadTimeDays to CriticalComponent interface (line 14-21)
     - Add "Lead Time" table header
     - Add leadTimeDays cell
     - Add urgency hint generation function
     - Display hint text (could be tooltip, badge variant, or separate column)
   - **Risk**: Low - isolated UI component

3. **/home/pbrown/SkuInventory/src/app/(dashboard)/page.tsx**
   - **Purpose**: Update DashboardData type to include leadTimeDays
   - **Change**: Add leadTimeDays to criticalComponents array type (line 27-34)
   - **Risk**: Low - type only

4. **/home/pbrown/SkuInventory/src/services/inventory.ts** (OPTIONAL)
   - **Purpose**: Add urgency calculation helper function
   - **Changes**: Add calculateUrgencyScore() function if sorting logic is complex
   - **Risk**: Low - new pure function
   - **Note**: Could be done in dashboard API route instead

### Files to Create

1. **/home/pbrown/SkuInventory/tests/unit/reorder-urgency.test.ts** (or similar)
   - **Purpose**: Test hint generation and urgency sorting logic
   - **Pattern**: Follow /home/pbrown/SkuInventory/tests/unit/inventory-service.test.ts
   - **Tests**:
     - Hint text generation for different statuses and lead times
     - Urgency sorting order
     - Edge cases (0 lead time, critical with long lead time, etc.)

## Final Sweep Results

### Services Search
**Files in src/services/**: 7 files checked
- ✅ inventory.ts - contains calculateReorderStatus (will use, not modify)
- ✅ No other services need changes

### API Routes Search
**Usages in src/app/api/**: 14 files reference reorderStatus
- ✅ /home/pbrown/SkuInventory/src/app/api/dashboard/route.ts - WILL MODIFY
- ✅ /home/pbrown/SkuInventory/src/app/api/components/route.ts - already returns leadTimeDays, no change
- ✅ /home/pbrown/SkuInventory/src/app/api/components/[id]/route.ts - no change needed
- ✅ /home/pbrown/SkuInventory/src/app/api/export/components/route.ts - no change needed

### Type Definitions
**Types affected**: 1 type extended
- ✅ DashboardData interface in src/app/(dashboard)/page.tsx - WILL MODIFY
- ✅ ComponentResponse already has leadTimeDays - no change
- ✅ ReorderStatus type - no change

### Components Search
**Components using reorderStatus**: 4 components
- ✅ /home/pbrown/SkuInventory/src/components/features/CriticalComponentsList.tsx - WILL MODIFY
- ✅ /home/pbrown/SkuInventory/src/components/features/ComponentTable.tsx - no change (different context)
- ✅ /home/pbrown/SkuInventory/src/components/features/ReorderStatusBadge.tsx - might enhance for hints
- ✅ /home/pbrown/SkuInventory/src/app/(dashboard)/page.tsx - WILL MODIFY (type only)

### Test Files
**Test files found**: 2 relevant tests
- ✅ /home/pbrown/SkuInventory/tests/unit/inventory-service.test.ts - pattern to follow
- ✅ /home/pbrown/SkuInventory/tests/e2e/component-reorder-pagination.spec.ts - might need update if UI changes significantly

**All Affected Files** (comprehensive list):
1. /home/pbrown/SkuInventory/src/app/api/dashboard/route.ts - add leadTimeDays to response
2. /home/pbrown/SkuInventory/src/app/(dashboard)/page.tsx - update type definition
3. /home/pbrown/SkuInventory/src/components/features/CriticalComponentsList.tsx - add column and hints
4. /home/pbrown/SkuInventory/tests/unit/reorder-urgency.test.ts - NEW FILE for tests

**Optional Enhancements**:
5. /home/pbrown/SkuInventory/src/components/features/ReorderStatusBadge.tsx - could add hint tooltip
6. /home/pbrown/SkuInventory/src/services/inventory.ts - could add urgency helper (not required)

## Ripple Effect Analysis

### Function: calculateReorderStatus (src/services/inventory.ts)
**Direct Callers**: 6 files
- src/app/api/dashboard/route.ts (line 103)
- src/app/api/components/route.ts (lines 84, 135)
- src/app/(dashboard)/components/page.tsx (lines 76, 131)
- src/app/api/components/[id]/route.ts
- src/services/export.ts

**Change Impact**: NONE - not modifying this function signature
**Status**: ✅ No ripple effect

### Component: CriticalComponentsList
**Usage**: 1 location
- src/app/(dashboard)/page.tsx (line 115)

**Change Impact**: Interface change only (adding leadTimeDays field)
**Required Update**: Dashboard API must pass leadTimeDays
**Status**: ✅ Isolated change, already planned

### API Endpoint: /api/dashboard
**Consumers**: 1 client
- src/app/(dashboard)/page.tsx (line 64)

**Change Impact**: Response type expanded (backward compatible)
**Status**: ✅ Safe - adding optional field

**TOTAL FILES AFFECTED**: 4 core files + 1 new test file = 5 files

## Urgency Sorting Algorithm (Design)

### Proposed Urgency Score
```typescript
// Pseudocode for urgency calculation
function calculateUrgencyScore(
  quantityOnHand: number,
  reorderPoint: number,
  leadTimeDays: number
): number {
  const deficit = reorderPoint - quantityOnHand
  const deficitRatio = deficit / Math.max(reorderPoint, 1)

  // Higher score = more urgent
  // Factor 1: Deficit ratio (0 to 1+)
  // Factor 2: Lead time (longer = more urgent)

  const urgency = (deficitRatio * 100) + (leadTimeDays * 0.5)
  return urgency
}
```

### Sort Order (Descending Urgency)
1. Critical with long lead time (highest urgency)
2. Critical with short lead time
3. Warning components not shown in critical list

### Hint Text Examples
Based on status + lead time:

| Status | Lead Time | Hint Text |
|--------|-----------|-----------|
| Critical | 0-3 days | "Order immediately" |
| Critical | 4-7 days | "Order soon (X days lead time)" |
| Critical | 8-14 days | "Order within 1 week (X days lead time)" |
| Critical | 15+ days | "Order urgently (X weeks lead time)" |
| Warning | Any | Not shown in critical list |

## Acceptance Criteria

Based on Issue #19:

- [ ] **AC1**: Warning/Critical components appear in a prioritized reorder view with lead-time hint text
  - Verify CriticalComponentsList shows leadTimeDays column
  - Verify hint text displays with appropriate urgency message
  - Verify filtering shows Critical and Warning components

- [ ] **AC2**: Sorting reflects urgency (e.g., deficit magnitude/reorder point)
  - Verify components sorted by urgency score
  - Verify critical with long lead time appears before critical with short lead time
  - Verify components with same status sorted by deficit

- [ ] **AC3**: Filters work
  - Verify can filter by category (if added)
  - Verify existing dashboard filters don't break
  - Note: Issue doesn't specify new filters, only that existing ones should work

- [ ] **AC4**: Tests cover hint generation and ordering logic
  - Unit tests for hint text generation
  - Unit tests for urgency score calculation
  - Unit tests for sorting order

## Handoff to Plan Agent

### Summary
Issue #19 requests enhancing the existing CriticalComponentsList component on the dashboard with lead-time-based hints and improved urgency sorting. All required data (leadTimeDays) already exists in the database and is returned by component APIs. The implementation involves:
1. Adding leadTimeDays to the dashboard API response for critical components
2. Enhancing CriticalComponentsList UI to show lead time and urgency hints
3. Implementing urgency-based sorting (deficit + lead time)
4. Adding unit tests for the new logic

This is a focused enhancement with minimal ripple effects, building on existing infrastructure.

### Key Points
1. **Low Risk**: No database migrations, all data exists
2. **Isolated Scope**: Changes confined to dashboard and CriticalComponentsList
3. **Existing Patterns**: Follow current CriticalComponentsList table structure
4. **Clear Requirements**: PRD specifies "Order soon (X days lead time)" hint text
5. **Testing**: Unit tests for hint generation and sorting, possibly E2E update
6. **No Breaking Changes**: Purely additive enhancement

### Suggested Implementation Phases

**Phase 1: Backend Enhancement** (1-2 hours)
- Modify /api/dashboard to include leadTimeDays in criticalComponents response
- Update DashboardData type definition
- Test API returns correct data

**Phase 2: UI Enhancement** (1-2 hours)
- Add leadTimeDays to CriticalComponent interface
- Add "Lead Time" table column
- Implement hint text generation function
- Display hints (as tooltip, badge variant, or text)

**Phase 3: Urgency Sorting** (1 hour)
- Implement calculateUrgencyScore function
- Update sorting in dashboard API to use urgency score
- Test sort order with various scenarios

**Phase 4: Testing** (1 hour)
- Write unit tests for hint generation
- Write unit tests for urgency calculation and sorting
- Update E2E tests if UI significantly changes
- Verify all acceptance criteria

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Issue Parsing | 2m |
| Codebase Exploration | 8m |
| Pattern Identification | 5m |
| Final Sweep | 3m |
| Report Writing | 12m |
| **Total** | **30m** |
