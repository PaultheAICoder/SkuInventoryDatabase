# Implementation Plan
**Generated**: 2026-01-02T09:15:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: Issue #352
**Estimated Build Time**: 1-2 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Bug
**Source**: GitHub Issue #352
**Priority**: Medium

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED
**Suggested Filter**: `--testPathPattern="layout"` or general dashboard tests

### Issue Validation
**Status**: Valid
**Recent Changes**: Commit `2a28164` (issue #333) introduced the company-specific role check in layout.tsx that caused this regression

### Current State Assessment
- **Root Cause**: The Settings menu visibility is gated by `isAdmin` check on line 161 of layout.tsx
- **The Check**: `const isAdmin = getClientCompanyRole(session?.user) === 'admin'` (line 78)
- **Problem**: `getClientCompanyRole()` returns the role for the **currently selected company**
- **Result**: If user is admin only for "Tonsil Tech" but has `ops`/`viewer` role for other companies, Settings disappears when switching companies
- **Expected**: Settings should always be visible if user is admin in ANY of their companies

### Dependencies & Blockers
None - this is a single-file fix with no database changes

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Simple
**Effort**: 1-2 hours
**Risk**: Low - isolated UI change, no backend impact

### Patterns Identified
**Primary**: `src/app/(dashboard)/layout.tsx:78` - current isAdmin check
**Secondary**: `src/lib/utils.ts:73-79` - getClientCompanyRole function (for reference only, not to modify)

### Ripple Effect Analysis
**Files Identified**: 1 (only layout.tsx)
**Other usages of getClientCompanyRole are CORRECT and should NOT be changed**:
- `src/app/(dashboard)/integrations/page.tsx:121` - company-specific sync permissions (CORRECT)
- `src/app/(dashboard)/forecasts/page.tsx:39` - company-specific edit permissions (CORRECT)

**IMPORTANT**: Only the Settings menu visibility logic in layout.tsx needs to change. The other usages correctly gate company-specific actions.

---

## Executive Summary
Fix the Settings menu visibility by changing the admin check from "is admin for currently selected company" to "is admin in any company the user belongs to". This is a single-line change in the dashboard layout component.

## Phase 1: Fix Settings Menu Visibility

### Subtask 1.1: Update isAdmin check in layout.tsx
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/layout.tsx`
**Line**: 78
**Pattern**: Check if user has admin role in any company using `session?.user?.companies.some()`

**Instructions**:
1. Locate line 78 with the current check:
   ```typescript
   const isAdmin = getClientCompanyRole(session?.user) === 'admin'
   ```
2. Replace with a check that iterates over all user's companies:
   ```typescript
   const isAdminInAnyCompany = session?.user?.companies?.some(c => c.role === 'admin') ?? false
   ```
3. Update the variable name usage on line 161 from `isAdmin` to `isAdminInAnyCompany`

**Current Code (line 78)**:
```typescript
const isAdmin = getClientCompanyRole(session?.user) === 'admin'
```

**New Code (line 78)**:
```typescript
// Settings menu should be visible if user is admin in ANY company (cross-company feature)
const isAdminInAnyCompany = session?.user?.companies?.some(c => c.role === 'admin') ?? false
```

**Update References**:
- Line 101: `const filteredMainNavigation = mainNavigation.filter((item) => !item.adminOnly || isAdmin)`
  - Change to: `const filteredMainNavigation = mainNavigation.filter((item) => !item.adminOnly || isAdminInAnyCompany)`
- Line 161: `{isAdmin && (`
  - Change to: `{isAdminInAnyCompany && (`

**Cleanup**:
- Remove the import `getClientCompanyRole` from line 6 if it's no longer used elsewhere in the file

**Validation Commands**:
```bash
# TypeScript check
npx tsc --noEmit

# Build check
npm run build

# Lint check
npm run lint
```

**Completion Criteria**:
- [ ] `isAdmin` variable renamed to `isAdminInAnyCompany`
- [ ] Check changed from `getClientCompanyRole(session?.user) === 'admin'` to `session?.user?.companies?.some(c => c.role === 'admin') ?? false`
- [ ] All 3 references to the variable updated (lines 78, 101, 161)
- [ ] Import cleanup if `getClientCompanyRole` is no longer used
- [ ] TypeScript compiles without errors
- [ ] Build completes without errors
- [ ] Lint passes

### Subtask 1.2: Verify import can be removed
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/layout.tsx`
**Line**: 6

**Instructions**:
1. Check if `getClientCompanyRole` is used elsewhere in layout.tsx besides line 78
2. If not used, remove it from the import statement:
   ```typescript
   // Before
   import { cn, getClientCompanyRole } from '@/lib/utils'
   // After
   import { cn } from '@/lib/utils'
   ```

**Completion Criteria**:
- [ ] Unused imports removed
- [ ] No TypeScript errors

---

## Phase 2: Manual Verification

### Subtask 2.1: Manual Testing Steps
**Purpose**: Verify the fix works correctly

**Test Steps**:
1. Log in as a user who is admin for Tonsil Tech but ops/viewer for other companies
2. Navigate to Dashboard - Settings should be visible in sidebar
3. Switch to a different company where user has ops role
4. Verify Settings menu is STILL visible in sidebar
5. Switch to a company where user has viewer role
6. Verify Settings menu is STILL visible in sidebar
7. Click on Settings - should navigate to settings page
8. Verify sub-navigation items still work

**Edge Cases to Consider**:
- User with admin role in ALL companies (should work)
- User with admin role in ONLY ONE company (should work)
- User with NO admin role in any company (Settings should NOT appear)

**Completion Criteria**:
- [ ] Settings visible when on company where user is admin
- [ ] Settings visible when on company where user is ops
- [ ] Settings visible when on company where user is viewer
- [ ] All settings sub-pages accessible

---

## Summary of Deliverables
**Files Created**: 0
**Files Modified**: 1
- `/home/pbrown/SkuInventory/src/app/(dashboard)/layout.tsx` (lines 6, 78, 101, 161)

## Handoff to Build Agent
1. Execute Subtask 1.1 - update the isAdmin logic
2. Execute Subtask 1.2 - clean up imports if needed
3. Run validation commands after each subtask
4. Test completion criteria before marking complete
5. The fix is surgical and isolated - no ripple effects expected

## Test Strategy Note
- TARGETED testing: Focus on layout/navigation behavior
- No unit tests to add (UI behavior change)
- Manual verification recommended via browser

## Technical Notes
- The `session.user.companies` array contains objects with `{ id, name, role }` structure
- The `role` field can be `'admin'`, `'ops'`, or `'viewer'`
- Using `.some()` with optional chaining and nullish coalescing handles edge cases

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 10m |
| **Total** | **30m** |
