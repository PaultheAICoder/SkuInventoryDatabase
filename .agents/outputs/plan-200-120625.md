# Implementation Plan
**Generated**: 2025-12-06T17:30:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #200
**Estimated Build Time**: 4-6 hours
**Complexity**: Moderate

## Investigation Summary

### Request Analysis
**Type**: Enhancement (Security/Data Integrity)
**Source**: GitHub Issue #200
**Priority**: High (Multi-tenancy enforcement for data isolation)

### Task Classification
**Category**: REFACTORING
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="finished-goods"` for service tests

### Issue Validation
**Status**: Valid
**Recent Changes**: No recent commits directly affecting tenant isolation in lot.ts or finished-goods.ts
**Related Closed Issues**: #198 (BOM service) and #199 (Inventory service) provide implementation patterns

### Current State Assessment

**`src/services/lot.ts`:**
- `getLotBalance(lotId)` - No companyId enforcement
- `getAffectedSkusForLot(lotId)` - No companyId enforcement
- `calculateExpiryStatus` - Pure function, no database access (no change needed)

**`src/services/finished-goods.ts`:**
- `getSkuQuantity(skuId, locationId?)` - No companyId enforcement
- `getSkuQuantities(skuIds, locationId?)` - No companyId enforcement
- `getSkuInventorySummary(skuId)` - No companyId enforcement
- `adjustFinishedGoods` - Has companyId param (verify usage)
- `receiveFinishedGoods` - Has companyId param (verify usage), calls getSkuQuantity internally
- `transferFinishedGoods` - Has companyId param, validates locations, calls getSkuQuantity internally
- `createOutboundTransaction` - Has companyId param, calls getSkuQuantity internally

### Dependencies & Blockers
1. None - Can be done independently

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Moderate
**Effort**: 4-6 hours
**Risk**: Medium (changes affect multiple callers, need to update internal calls)

### Patterns Identified
**Primary**: `/home/pbrown/SkuInventory/src/services/inventory.ts:46-58` - `getComponentQuantity` pattern for verifying entity ownership before query
**Secondary**: `/home/pbrown/SkuInventory/src/services/bom.ts:9-26` - Joining through related entity for tenant verification

### Ripple Effect Analysis
**Files Identified**: 10

**Service Files (source changes):**
1. `/home/pbrown/SkuInventory/src/services/lot.ts` - Update 2 functions
2. `/home/pbrown/SkuInventory/src/services/finished-goods.ts` - Update 3 query functions + 4 internal calls

**API Route Callers:**
3. `/home/pbrown/SkuInventory/src/app/api/lots/[id]/route.ts:44` - calls `getLotBalance`
4. `/home/pbrown/SkuInventory/src/app/api/lots/[id]/trace/route.ts:108` - calls `getAffectedSkusForLot`
5. `/home/pbrown/SkuInventory/src/app/api/skus/route.ts:88` - calls `getSkuQuantities`
6. `/home/pbrown/SkuInventory/src/app/api/skus/[id]/route.ts:82` - calls `getSkuInventorySummary`
7. `/home/pbrown/SkuInventory/src/app/api/skus/[id]/inventory/route.ts:35` - calls `getSkuInventorySummary`
8. `/home/pbrown/SkuInventory/src/app/api/export/skus/route.ts:52` - calls `getSkuQuantities`

**Test Files:**
9. `/home/pbrown/SkuInventory/tests/unit/finished-goods-service.test.ts` - Update mock calls and add tenant isolation tests

---

## Executive Summary
Add companyId parameter to Lot and Finished Goods service query functions and enforce tenant isolation through database queries. This follows the pattern established in #198 (BOM service) and #199 (Inventory service) for defense-in-depth multi-tenancy. Functions will verify entity ownership before returning data, preventing cross-tenant access even if API layer checks are bypassed.

## Phase 1: Update Lot Service Layer

### Subtask 1.1: Add companyId to getLotBalance
**File**: `/home/pbrown/SkuInventory/src/services/lot.ts`
**Pattern**: Follow `src/services/inventory.ts:46-58` for ownership verification
**Instructions**:
1. Update function signature to add `companyId: string` parameter
2. Add lot ownership verification through component relationship:
```typescript
export async function getLotBalance(lotId: string, companyId: string): Promise<number> {
  // Verify lot belongs to company via component
  const lot = await prisma.lot.findFirst({
    where: {
      id: lotId,
      component: { companyId },
    },
    select: { id: true },
  })
  if (!lot) {
    throw new Error('Lot not found or access denied')
  }

  const balance = await prisma.lotBalance.findUnique({
    where: { lotId },
    select: { quantity: true },
  })

  return balance?.quantity.toNumber() ?? 0
}
```
**Validation**:
```bash
npx tsc --noEmit
```
**Completion Criteria**:
- [ ] Function signature updated with companyId parameter
- [ ] Ownership verification added through component.companyId
- [ ] Error thrown when lot not found or doesn't belong to company
- [ ] TypeScript compiles without errors

### Subtask 1.2: Add companyId to getAffectedSkusForLot
**File**: `/home/pbrown/SkuInventory/src/services/lot.ts`
**Pattern**: Follow `src/services/inventory.ts:46-58` for ownership verification
**Instructions**:
1. Update function signature to add `companyId: string` parameter
2. Add lot ownership verification through component relationship:
```typescript
export async function getAffectedSkusForLot(lotId: string, companyId: string): Promise<AffectedSkuResponse[]> {
  // Verify lot belongs to company via component
  const lot = await prisma.lot.findFirst({
    where: {
      id: lotId,
      component: { companyId },
    },
    select: { id: true },
  })
  if (!lot) {
    throw new Error('Lot not found or access denied')
  }

  // Rest of existing implementation unchanged...
```
3. Keep the rest of the function logic unchanged
**Validation**:
```bash
npx tsc --noEmit
```
**Completion Criteria**:
- [ ] Function signature updated with companyId parameter
- [ ] Ownership verification added through component.companyId
- [ ] Error thrown when lot not found or doesn't belong to company
- [ ] TypeScript compiles without errors

## Phase 2: Update Finished Goods Query Functions

### Subtask 2.1: Add companyId to getSkuQuantity
**File**: `/home/pbrown/SkuInventory/src/services/finished-goods.ts`
**Pattern**: Follow `src/services/inventory.ts:46-58`
**Instructions**:
1. Update function signature: `(skuId: string, companyId: string, locationId?: string)`
2. Add SKU ownership verification before query:
```typescript
export async function getSkuQuantity(
  skuId: string,
  companyId: string,
  locationId?: string
): Promise<number> {
  // Verify SKU belongs to company
  const sku = await prisma.sKU.findFirst({
    where: { id: skuId, companyId },
    select: { id: true },
  })
  if (!sku) {
    throw new Error('SKU not found or access denied')
  }

  const where: Prisma.FinishedGoodsLineWhereInput = { skuId }
  if (locationId) {
    where.locationId = locationId
  }

  const result = await prisma.finishedGoodsLine.aggregate({
    where,
    _sum: { quantityChange: true },
  })

  return result._sum.quantityChange?.toNumber() ?? 0
}
```
**Validation**:
```bash
npx tsc --noEmit
```
**Completion Criteria**:
- [ ] Function signature updated with companyId as second parameter
- [ ] SKU ownership verification added
- [ ] Error thrown when SKU not found or doesn't belong to company
- [ ] TypeScript compiles without errors

### Subtask 2.2: Add companyId to getSkuQuantities
**File**: `/home/pbrown/SkuInventory/src/services/finished-goods.ts`
**Pattern**: Follow `src/services/inventory.ts:142-192` for batch validation
**Instructions**:
1. Update function signature: `(skuIds: string[], companyId: string, locationId?: string)`
2. Filter to only SKUs the company owns:
```typescript
export async function getSkuQuantities(
  skuIds: string[],
  companyId: string,
  locationId?: string
): Promise<Map<string, number>> {
  // Filter to only SKUs the company owns
  if (skuIds.length === 0) {
    return new Map()
  }

  const validSkus = await prisma.sKU.findMany({
    where: { id: { in: skuIds }, companyId },
    select: { id: true },
  })
  const validIds = validSkus.map((s) => s.id)

  // If no valid SKUs, return map with zeros for all requested IDs
  if (validIds.length === 0) {
    const quantities = new Map<string, number>()
    for (const id of skuIds) {
      quantities.set(id, 0)
    }
    return quantities
  }

  const where: Prisma.FinishedGoodsLineWhereInput = {
    skuId: { in: validIds },
  }
  if (locationId) {
    where.locationId = locationId
  }

  const results = await prisma.finishedGoodsLine.groupBy({
    by: ['skuId'],
    where,
    _sum: { quantityChange: true },
  })

  const quantities = new Map<string, number>()

  // Initialize all requested IDs to 0
  for (const id of skuIds) {
    quantities.set(id, 0)
  }

  // Set actual quantities for valid SKUs
  for (const result of results) {
    quantities.set(result.skuId, result._sum.quantityChange?.toNumber() ?? 0)
  }

  return quantities
}
```
**Validation**:
```bash
npx tsc --noEmit
```
**Completion Criteria**:
- [ ] Function signature updated with companyId as second parameter
- [ ] Filter added to only query company-owned SKUs
- [ ] Non-owned SKU IDs return 0 (not an error, matches inventory.ts pattern)
- [ ] TypeScript compiles without errors

### Subtask 2.3: Add companyId to getSkuInventorySummary
**File**: `/home/pbrown/SkuInventory/src/services/finished-goods.ts`
**Pattern**: Follow subtask 2.1 pattern
**Instructions**:
1. Update function signature: `(skuId: string, companyId: string)`
2. Add SKU ownership verification:
```typescript
export async function getSkuInventorySummary(
  skuId: string,
  companyId: string
): Promise<SkuInventorySummary> {
  // Verify SKU belongs to company
  const sku = await prisma.sKU.findFirst({
    where: { id: skuId, companyId },
    select: { id: true },
  })
  if (!sku) {
    throw new Error('SKU not found or access denied')
  }

  // Rest of existing implementation unchanged...
```
3. Keep remaining function logic unchanged
**Validation**:
```bash
npx tsc --noEmit
```
**Completion Criteria**:
- [ ] Function signature updated with companyId parameter
- [ ] SKU ownership verification added
- [ ] Error thrown when SKU not found or doesn't belong to company
- [ ] TypeScript compiles without errors

### Subtask 2.4: Update internal calls in finished-goods.ts
**File**: `/home/pbrown/SkuInventory/src/services/finished-goods.ts`
**Instructions**:
Update these internal calls to pass companyId:

1. Line ~192 in `receiveFinishedGoods`:
```typescript
// Change from:
const newBalance = await getSkuQuantity(skuId, locationId)
// To:
const newBalance = await getSkuQuantity(skuId, companyId, locationId)
```

2. Line ~236 in `transferFinishedGoods`:
```typescript
// Change from:
const available = await getSkuQuantity(skuId, fromLocationId)
// To:
const available = await getSkuQuantity(skuId, companyId, fromLocationId)
```

3. Line ~298 in `createOutboundTransaction`:
```typescript
// Change from:
const currentQty = await getSkuQuantity(skuId, locationId)
// To:
const currentQty = await getSkuQuantity(skuId, companyId, locationId)
```

4. Line ~329 in `createOutboundTransaction`:
```typescript
// Change from:
const newBalance = await getSkuQuantity(skuId, locationId)
// To:
const newBalance = await getSkuQuantity(skuId, companyId, locationId)
```
**Validation**:
```bash
npx tsc --noEmit
npm run build
```
**Completion Criteria**:
- [ ] All 4 internal calls updated to pass companyId
- [ ] TypeScript compiles without errors
- [ ] Build completes without errors

## Phase 3: Update API Route Callers

### Subtask 3.1: Update lots/[id]/route.ts
**File**: `/home/pbrown/SkuInventory/src/app/api/lots/[id]/route.ts`
**Instructions**:
Update line 44 to pass selectedCompanyId to getLotBalance:
```typescript
// Change from:
const balance = await getLotBalance(id)
// To:
const balance = await getLotBalance(id, selectedCompanyId)
```
**Validation**:
```bash
npx tsc --noEmit
```
**Completion Criteria**:
- [ ] getLotBalance call updated to pass companyId
- [ ] TypeScript compiles without errors

### Subtask 3.2: Update lots/[id]/trace/route.ts
**File**: `/home/pbrown/SkuInventory/src/app/api/lots/[id]/trace/route.ts`
**Instructions**:
Update line 108 to pass selectedCompanyId to getAffectedSkusForLot:
```typescript
// Change from:
const affectedSkus: AffectedSkuResponse[] = await getAffectedSkusForLot(id)
// To:
const affectedSkus: AffectedSkuResponse[] = await getAffectedSkusForLot(id, selectedCompanyId)
```
**Validation**:
```bash
npx tsc --noEmit
```
**Completion Criteria**:
- [ ] getAffectedSkusForLot call updated to pass companyId
- [ ] TypeScript compiles without errors

### Subtask 3.3: Update skus/route.ts
**File**: `/home/pbrown/SkuInventory/src/app/api/skus/route.ts`
**Instructions**:
Update line 88 to pass selectedCompanyId to getSkuQuantities:
```typescript
// Change from:
skuIds.length > 0 ? getSkuQuantities(skuIds, locationId) : new Map<string, number>(),
// To:
skuIds.length > 0 ? getSkuQuantities(skuIds, selectedCompanyId!, locationId) : new Map<string, number>(),
```
**Validation**:
```bash
npx tsc --noEmit
```
**Completion Criteria**:
- [ ] getSkuQuantities call updated to pass companyId
- [ ] TypeScript compiles without errors

### Subtask 3.4: Update skus/[id]/route.ts
**File**: `/home/pbrown/SkuInventory/src/app/api/skus/[id]/route.ts`
**Instructions**:
Update line 82 to pass selectedCompanyId to getSkuInventorySummary:
```typescript
// Change from:
const finishedGoodsInventory = await getSkuInventorySummary(id)
// To:
const finishedGoodsInventory = await getSkuInventorySummary(id, selectedCompanyId!)
```
**Validation**:
```bash
npx tsc --noEmit
```
**Completion Criteria**:
- [ ] getSkuInventorySummary call updated to pass companyId
- [ ] TypeScript compiles without errors

### Subtask 3.5: Update skus/[id]/inventory/route.ts
**File**: `/home/pbrown/SkuInventory/src/app/api/skus/[id]/inventory/route.ts`
**Instructions**:
Update line 35 to pass selectedCompanyId to getSkuInventorySummary:
```typescript
// Change from:
const inventory = await getSkuInventorySummary(id)
// To:
const inventory = await getSkuInventorySummary(id, selectedCompanyId!)
```
**Validation**:
```bash
npx tsc --noEmit
```
**Completion Criteria**:
- [ ] getSkuInventorySummary call updated to pass companyId
- [ ] TypeScript compiles without errors

### Subtask 3.6: Update export/skus/route.ts
**File**: `/home/pbrown/SkuInventory/src/app/api/export/skus/route.ts`
**Instructions**:
Update line 52 to pass selectedCompanyId to getSkuQuantities:
```typescript
// Change from:
const fgQuantities = await getSkuQuantities(skuIds, locationId)
// To:
const fgQuantities = await getSkuQuantities(skuIds, selectedCompanyId!, locationId)
```
**Validation**:
```bash
npx tsc --noEmit
```
**Completion Criteria**:
- [ ] getSkuQuantities call updated to pass companyId
- [ ] TypeScript compiles without errors

## Phase 4: Update Tests

### Subtask 4.1: Update finished-goods-service.test.ts mock calls
**File**: `/home/pbrown/SkuInventory/tests/unit/finished-goods-service.test.ts`
**Instructions**:
1. Add SKU mock to prisma mock setup:
```typescript
vi.mock('@/lib/db', () => ({
  prisma: {
    finishedGoodsLine: {
      aggregate: vi.fn(),
      groupBy: vi.fn(),
    },
    location: {
      findMany: vi.fn(),
      findFirst: vi.fn(),
    },
    transaction: {
      create: vi.fn(),
    },
    sKU: {
      findFirst: vi.fn(),
      findMany: vi.fn(),
    },
    $transaction: vi.fn(),
  },
}))
```

2. Update all test calls to include companyId parameter (e.g., 'company-1')

3. Add mock for SKU verification in tests:
```typescript
vi.mocked(prisma.sKU.findFirst).mockResolvedValue({ id: 'sku-1' } as never)
// or for batch:
vi.mocked(prisma.sKU.findMany).mockResolvedValue([{ id: 'sku-1' }] as never)
```

4. Add tests for cross-tenant access denial:
```typescript
it('throws error when SKU does not belong to company', async () => {
  vi.mocked(prisma.sKU.findFirst).mockResolvedValue(null)

  await expect(getSkuQuantity('sku-1', 'wrong-company')).rejects.toThrow(
    'SKU not found or access denied'
  )
})
```
**Validation**:
```bash
npm test -- --filter="finished-goods"
```
**Completion Criteria**:
- [ ] Prisma mock updated to include sKU model
- [ ] All existing tests updated to pass companyId
- [ ] New tests added for cross-tenant access denial
- [ ] All tests pass

## Phase 5: Final Validation

### Subtask 5.1: Run full validation
**Instructions**:
1. Run TypeScript check: `npx tsc --noEmit`
2. Run build: `npm run build`
3. Run linter: `npm run lint`
4. Run tests: `npm test`
**Validation**:
```bash
npx tsc --noEmit && npm run build && npm run lint && npm test
```
**Completion Criteria**:
- [ ] TypeScript compiles without errors
- [ ] Build completes without errors
- [ ] Linter passes
- [ ] All tests pass

---

## Summary of Deliverables
**Files Created**: 0
**Files Modified**: 9
- `/home/pbrown/SkuInventory/src/services/lot.ts`
- `/home/pbrown/SkuInventory/src/services/finished-goods.ts`
- `/home/pbrown/SkuInventory/src/app/api/lots/[id]/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/lots/[id]/trace/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/skus/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/skus/[id]/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/skus/[id]/inventory/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/export/skus/route.ts`
- `/home/pbrown/SkuInventory/tests/unit/finished-goods-service.test.ts`

## Handoff to Build Agent
1. Execute subtasks in exact order (Phases 1-5)
2. Complete each subtask fully before moving to next
3. Test completion criteria at each step using validation commands
4. Follow reference patterns exactly from bom.ts and inventory.ts
5. Note: Internal calls in finished-goods.ts (Phase 2.4) depend on Phase 2.1 completing first

## Test Strategy Note
- Use Vitest for unit tests
- TARGETED strategy: Focus on finished-goods-service.test.ts
- Filter: `npm test -- --filter="finished-goods"`

## Performance Metrics
| Phase | Estimated Duration |
|-------|----------|
| Phase 1 (Lot Service) | 30m |
| Phase 2 (Finished Goods) | 60m |
| Phase 3 (API Routes) | 45m |
| Phase 4 (Tests) | 60m |
| Phase 5 (Validation) | 15m |
| **Total** | **~3.5h** |

## Risk Assessment
- **Medium Risk**: Changes affect multiple callers; ensure all updated atomically
- **Mitigation**: TypeScript will catch any missed callers at compile time
- **Rollback**: Git revert if issues found in testing
