# Implementation Plan
**Generated**: 2025-12-04 17:15 UTC
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #150
**Estimated Build Time**: 1-2 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Bug
**Source**: GitHub Issue #150
**Priority**: Medium

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED
**Suggested Filter**: `--testPathPattern="orders"` or None (no existing test)

### Issue Validation
**Status**: Valid
**Recent Changes**: `1cd8685 feat(issue #95): add order review queue UI` (created the page)

### Root Cause Analysis

The `/orders` page hangs on "Loading orders..." indefinitely when there are no orders because of a **missing session loading state check**.

**Current Code Flow** (`src/app/(dashboard)/orders/page.tsx`):
1. Line 14: `isLoading` is initialized to `true`
2. Lines 59-63: `useEffect` only calls `fetchOrders()` when `session?.user?.selectedCompanyId` is truthy
3. Lines 65-75: If `isLoading` is `true`, show "Loading orders..." message

**The Bug**: When the session is still loading (during initial page load), `session?.user?.selectedCompanyId` is `undefined`. The `useEffect` never fires, so `fetchOrders()` is never called, and `isLoading` remains `true` forever.

**Evidence**:
- The `OrderReviewTable` component (lines 159-164) correctly handles empty orders with "No orders found." message
- The API route (lines 41-46) correctly returns `{ data: [], meta: {...} }` when no Shopify connection exists
- The issue is that the page never reaches these components because loading state never transitions

**Comparison with working pages**:
- `src/app/(dashboard)/settings/alerts/page.tsx` (lines 21, 52, 74): Uses `status === 'loading'` check from `useSession`
- `src/app/(dashboard)/transactions/page.tsx` (lines 126-129): Calls fetch unconditionally, using `selectedCompanyId` only as dependency

### Current State Assessment
- **Existing components**: `OrderReviewTable` handles empty state correctly
- **API Routes**: `/api/shopify/orders` returns proper empty response
- **Types**: No changes needed
- **Database**: No changes needed

### Dependencies & Blockers
None - this is a simple frontend fix.

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Simple
**Effort**: 1-2 hours
**Risk**: Low - surgical fix to loading state logic

### Patterns Identified
**Primary**: `src/app/(dashboard)/settings/alerts/page.tsx` - uses `status` from `useSession()` and checks `status === 'loading'`
**Secondary**: `src/app/(dashboard)/transactions/page.tsx` - calls fetch unconditionally

### Ripple Effect Analysis
**Files Identified**: 1
- `/home/pbrown/SkuInventory/src/app/(dashboard)/orders/page.tsx` - primary fix location

**Potential Additional Files**: These pages have the same pattern and may need similar fixes:
- `src/app/(dashboard)/settings/page.tsx` - has same conditional fetch issue
- `src/app/(dashboard)/forecasts/page.tsx` - has same conditional fetch issue
- `src/app/(dashboard)/settings/integrations/shopify/page.tsx` - has same conditional fetch issue

However, per the issue scope, we focus only on the orders page. Other pages can be addressed in separate issues if needed.

---

## Executive Summary

Fix the orders page loading state by destructuring `status` from `useSession()` and properly handling the session loading state. When session is loading, show the loading indicator. When session is loaded but `selectedCompanyId` is missing or no orders exist, properly transition to the loaded state.

---

## Phase 1: Fix Loading State Logic

### Subtask 1.1: Add session status to useSession destructuring

**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/orders/page.tsx`
**Pattern**: Follow `src/app/(dashboard)/settings/alerts/page.tsx` line 21
**Line**: 10

**Current Code**:
```typescript
const { data: session } = useSession()
```

**New Code**:
```typescript
const { data: session, status } = useSession()
```

**Instructions**:
1. Destructure `status` from `useSession()` hook on line 10
2. This provides access to the session loading state ('loading', 'authenticated', 'unauthenticated')

**Completion Criteria**:
- [ ] `status` is destructured from `useSession()`
- [ ] No TypeScript errors

---

### Subtask 1.2: Update useEffect to handle session loading properly

**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/orders/page.tsx`
**Pattern**: Follow `src/app/(dashboard)/settings/alerts/page.tsx` lines 51-65
**Lines**: 59-63

**Current Code**:
```typescript
useEffect(() => {
  if (session?.user?.selectedCompanyId) {
    fetchOrders()
  }
}, [session?.user?.selectedCompanyId, fetchOrders])
```

**New Code**:
```typescript
useEffect(() => {
  // Don't fetch while session is loading
  if (status === 'loading') return

  // If authenticated with a company selected, fetch orders
  if (session?.user?.selectedCompanyId) {
    fetchOrders()
  } else {
    // Session loaded but no company - stop loading
    setIsLoading(false)
  }
}, [status, session?.user?.selectedCompanyId, fetchOrders])
```

**Instructions**:
1. Add early return when `status === 'loading'` to wait for session
2. Add `else` branch to set `isLoading(false)` when session is loaded but no company is selected
3. Add `status` to the dependency array

**Completion Criteria**:
- [ ] Loading state properly handles session loading
- [ ] Loading state transitions to false when session loaded but no company
- [ ] `status` is in the dependency array

---

### Subtask 1.3: Update the loading state render condition

**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/orders/page.tsx`
**Pattern**: Follow `src/app/(dashboard)/settings/alerts/page.tsx` line 74
**Lines**: 65-75

**Current Code**:
```typescript
if (isLoading) {
  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-3xl font-bold">Order Review</h1>
        <p className="text-muted-foreground">Review and approve synced Shopify orders</p>
      </div>
      <div className="py-10 text-center text-muted-foreground">Loading orders...</div>
    </div>
  )
}
```

**New Code**:
```typescript
if (status === 'loading' || isLoading) {
  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-3xl font-bold">Order Review</h1>
        <p className="text-muted-foreground">Review and approve synced Shopify orders</p>
      </div>
      <div className="py-10 text-center text-muted-foreground">Loading orders...</div>
    </div>
  )
}
```

**Instructions**:
1. Update condition to check both `status === 'loading'` and `isLoading`
2. This ensures we show loading while session is being determined AND while fetching orders

**Completion Criteria**:
- [ ] Loading UI shows during session loading
- [ ] Loading UI shows during orders fetch
- [ ] Loading UI disappears when both are done

---

## Phase 2: Validation

### Subtask 2.1: Run TypeScript check

**Command**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] No TypeScript errors

---

### Subtask 2.2: Run build

**Command**:
```bash
npm run build
```

**Completion Criteria**:
- [ ] Build completes successfully
- [ ] No warnings related to orders page

---

### Subtask 2.3: Run lint

**Command**:
```bash
npm run lint
```

**Completion Criteria**:
- [ ] Lint passes
- [ ] No ESLint warnings on modified file

---

### Subtask 2.4: Manual verification (via test environment)

**Test URL**: http://172.16.20.50:2345/orders

**Test Steps**:
1. Ensure test database has no Shopify orders (or clear existing orders)
2. Navigate to /orders page
3. Observe that page shows "Loading orders..." briefly then shows the OrderReviewTable with "No orders found."
4. Verify no perpetual loading state

**Completion Criteria**:
- [ ] Page does not hang on "Loading orders..."
- [ ] Empty state message "No orders found." is displayed
- [ ] Page is functional and responsive

---

## Summary of Deliverables

**Files Created**: 0
**Files Modified**: 1
- `/home/pbrown/SkuInventory/src/app/(dashboard)/orders/page.tsx`

**Changes Summary**:
1. Destructure `status` from `useSession()` (line 10)
2. Update useEffect to handle session loading state (lines 59-63)
3. Update loading condition to include session status (line 65)

---

## Handoff to Build Agent

1. Execute subtasks in exact order (1.1 -> 1.2 -> 1.3 -> 2.1 -> 2.2 -> 2.3)
2. Each subtask has specific code changes - follow exactly
3. Test completion criteria before moving to next subtask
4. Follow reference patterns from `settings/alerts/page.tsx`

---

## Test Strategy Note

- **Unit tests**: No existing unit tests for orders page - consider adding in future
- **E2E tests**: Manual verification via test environment is sufficient for this bug fix
- **Regression**: The fix is surgical and follows established patterns

---

## Related Issues for Future Consideration

The following pages have the same pattern bug and may need similar fixes:
- `src/app/(dashboard)/settings/page.tsx`
- `src/app/(dashboard)/forecasts/page.tsx`
- `src/app/(dashboard)/settings/integrations/shopify/page.tsx`

These should be addressed in separate issues to avoid scope creep.

---

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 8m |
| Validation | 2m |
| Planning | 5m |
| **Total** | **15m** |
