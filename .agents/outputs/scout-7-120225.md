# Scout Report: Add Test Coverage for Auth, Tenant Scoping, Inventory Math, Import/Export

## Request Analysis
**Type**: Enhancement
**Source**: GitHub Issue #7
**Priority**: High

## Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: `npm test` (all unit tests), `npm run test:e2e` (all e2e tests)

## Issue Validation
**Status**: ✅ Valid
**Recent Changes**:
- Some test infrastructure already in place (Vitest, Playwright configured)
- Existing tests: 5 unit tests, 6 e2e tests
- Build completes successfully without errors
- Recent work on issues #1, #2, #5, #6, #22 added features that need test coverage

**Comment from Issue #6**: Identifies additional test coverage opportunities:
- Build transaction API integration tests
- Settings UI E2E tests
- Performance monitoring for settings fetch

## Current State

### Testing Infrastructure
- ✅ Vitest configured (`vitest.config.ts`)
- ✅ Playwright configured (`playwright.config.ts`)
- ✅ Test scripts in package.json: `npm test`, `npm run test:e2e`
- ✅ Basic test setup file (`tests/setup.ts`)
- ✅ Seed data available (`prisma/seed.ts`) with test users

### Existing Unit Tests (5 files)
1. ✅ `tests/unit/inventory-service.test.ts` - Tests `calculateReorderStatus` with various multipliers (99 tests total)
2. ✅ `tests/unit/BuildFooter.test.tsx` - Component test
3. ✅ `tests/unit/claude-client.test.ts` - Feedback system
4. ✅ `tests/unit/feedback-types.test.ts` - Feedback types
5. ✅ `tests/unit/increment-version.test.ts` - Version increment logic

### Existing E2E Tests (6 files)
1. ✅ `tests/e2e/tenant-scoping.spec.ts` - Basic tenant scoping checks (404 handling)
2. ✅ `tests/e2e/build-footer.spec.ts` - Build footer UI
3. ✅ `tests/e2e/component-reorder-pagination.spec.ts` - Component filtering
4. ✅ `tests/e2e/sku-recent-transactions.spec.ts` - SKU transactions
5. ✅ `tests/e2e/screenshot-dashboard.spec.ts` - Dashboard smoke test
6. ✅ `tests/e2e/test-feedback-api.spec.ts` - Feedback API

### Missing Test Coverage (from Issue #7)

#### Unit Tests Needed
1. ❌ **Inventory Math Functions** (`src/services/inventory.ts`)
   - `getComponentQuantity` - aggregation logic
   - `getComponentQuantities` - batch aggregation
   - `checkInsufficientInventory` - shortage calculation
   - `createReceiptTransaction` - transaction creation
   - `createAdjustmentTransaction` - adjustment logic
   - `createBuildTransaction` - build logic with allowNegativeInventory
   - `canDeleteComponent` - BOM dependency check

2. ❌ **BOM Calculation Functions** (`src/services/bom.ts`)
   - `calculateBOMUnitCost` - unit cost calculation
   - `calculateBOMUnitCosts` - batch cost calculation
   - `calculateMaxBuildableUnits` - buildable units for one SKU
   - `calculateMaxBuildableUnitsForSKUs` - batch buildable units

3. ❌ **Import/Export CSV Functions**
   - `src/services/import.ts`:
     - `parseCSV` - CSV parsing with quotes, escaping
     - `processComponentImport` - validation and error handling
     - `processSKUImport` - validation and error handling
   - `src/services/export.ts`:
     - `toCSV` - CSV generation
     - `escapeCSVField` - field escaping (commas, quotes, newlines)

#### API Integration Tests Needed
1. ❌ **Authentication Tests**
   - Unauthenticated requests return 401
   - Session-based authentication works
   - Different user roles (admin, ops, viewer) have correct permissions

2. ❌ **Tenant Scoping Tests** (expand existing)
   - Components API (`/api/components`, `/api/components/[id]`)
   - SKUs API (`/api/skus`, `/api/skus/[id]`)
   - BOMs API (`/api/bom-versions/[id]`, `/api/skus/[id]/bom-versions`)
   - Transactions API (`/api/transactions/*`)
   - Settings API (`/api/settings`)
   - Cross-tenant access returns 404 (not 403 or 200)

3. ❌ **Build/Receipt/Adjustment Flow Tests**
   - POST `/api/transactions/receipt` - creates receipt, updates inventory
   - POST `/api/transactions/adjustment` - creates adjustment
   - POST `/api/transactions/build` - with sufficient inventory
   - POST `/api/transactions/build` - with insufficient inventory (blocked)
   - POST `/api/transactions/build` - with insufficient inventory + allowNegativeInventory setting

4. ❌ **Settings Integration Tests**
   - GET `/api/settings` - returns company settings
   - POST `/api/settings` - saves settings, validates schema
   - Settings affect business logic (reorderWarningMultiplier, allowNegativeInventory, defaultLeadTimeDays)

5. ❌ **Import/Export API Tests**
   - POST `/api/import/components` - valid CSV
   - POST `/api/import/components` - invalid CSV (validation errors)
   - POST `/api/import/skus` - valid/invalid
   - GET `/api/export/components` - returns CSV with proper escaping
   - GET `/api/export/skus` - returns CSV
   - GET `/api/export/transactions` - returns CSV

#### E2E Smoke Tests Needed
1. ❌ **Full User Flow**
   - Login as admin → create component → create SKU → create BOM → record receipt → build SKU → export transactions
   - Verify negative inventory handling with settings toggle
   - Verify reorder status updates based on settings

## Dependencies & Blockers

### Available Resources
- ✅ Vitest and Playwright already installed
- ✅ Testing utilities: `@testing-library/react`, `@testing-library/jest-dom`
- ✅ Seed data with 3 test users (admin, ops, viewer)
- ✅ Existing test patterns to follow

### Missing Dependencies
- ❌ No test database setup/teardown utilities (need to create)
- ❌ No API test helpers for authenticated requests (need to create)
- ❌ No test fixtures for common data (components, SKUs, BOMs)

**Can Proceed?**: YES WITH SETUP

## Complexity Assessment
**Complexity**: Complex
**Effort**: 16-24 hours (broken down below)
**Risk**: Medium

### Effort Breakdown
1. **Test Infrastructure** (2-3 hours)
   - Database setup/teardown helpers
   - API test utilities (authenticated requests)
   - Test fixtures/factories

2. **Unit Tests** (6-8 hours)
   - Inventory math: 3-4 hours
   - BOM calculations: 2-3 hours
   - Import/Export CSV: 1-2 hours

3. **API Integration Tests** (6-8 hours)
   - Auth & tenant scoping: 2-3 hours
   - Transaction flows: 2-3 hours
   - Settings & import/export: 2 hours

4. **E2E Tests** (2-3 hours)
   - Full user flow smoke tests
   - Cross-browser/role testing

5. **CI Integration** (1-2 hours)
   - Add GitHub Actions workflow
   - Configure test database
   - Run tests on PR/push

## Patterns to Follow

### Unit Test Pattern
**Primary**: `/home/pbrown/SkuInventory/tests/unit/inventory-service.test.ts`
- Uses Vitest (`describe`, `it`, `expect`)
- Tests pure functions with various inputs
- Groups related tests with `describe` blocks
- Uses descriptive test names

### E2E Test Pattern
**Primary**: `/home/pbrown/SkuInventory/tests/e2e/tenant-scoping.spec.ts`
- Uses Playwright with `test.describe`, `test`, `expect`
- Includes `beforeEach` for login setup
- Tests authenticated user flows
- Verifies API responses and UI state

### API Route Pattern
**Primary**: `/home/pbrown/SkuInventory/src/app/api/components/route.ts`
- Uses `getServerSession(authOptions)` for auth
- Checks `session?.user` for authentication
- Checks `session.user.role` for authorization
- Uses `brandId` or `companyId` for tenant scoping
- Returns proper status codes (401, 404, 409, 500)

**Secondary**: `/home/pbrown/SkuInventory/src/app/api/transactions/build/route.ts`
- Shows role-based access control (viewer cannot create)
- Shows tenant scoping verification before operations
- Shows settings integration (`getCompanySettings`)

### Service Pattern
**Primary**: `/home/pbrown/SkuInventory/src/services/inventory.ts`
- Pure functions that accept IDs and return data
- Uses Prisma for database queries
- Handles Decimal types properly
- Returns typed results

## Files to Create/Modify

### Files to Create

#### Test Infrastructure
1. `/home/pbrown/SkuInventory/tests/helpers/db.ts` - Database setup/teardown utilities
2. `/home/pbrown/SkuInventory/tests/helpers/api.ts` - API test helpers (authenticated requests)
3. `/home/pbrown/SkuInventory/tests/fixtures/data.ts` - Test data factories

#### Unit Tests
4. `/home/pbrown/SkuInventory/tests/unit/inventory-transactions.test.ts` - Transaction creation tests
5. `/home/pbrown/SkuInventory/tests/unit/bom-calculations.test.ts` - BOM math tests
6. `/home/pbrown/SkuInventory/tests/unit/csv-import.test.ts` - Import parsing/validation
7. `/home/pbrown/SkuInventory/tests/unit/csv-export.test.ts` - Export formatting/escaping

#### API Integration Tests
8. `/home/pbrown/SkuInventory/tests/integration/auth.test.ts` - Authentication tests
9. `/home/pbrown/SkuInventory/tests/integration/tenant-scoping.test.ts` - Tenant isolation tests
10. `/home/pbrown/SkuInventory/tests/integration/transactions.test.ts` - Transaction flow tests
11. `/home/pbrown/SkuInventory/tests/integration/settings.test.ts` - Settings integration
12. `/home/pbrown/SkuInventory/tests/integration/import-export.test.ts` - Import/export API

#### E2E Tests
13. `/home/pbrown/SkuInventory/tests/e2e/full-workflow.spec.ts` - Complete user journey
14. `/home/pbrown/SkuInventory/tests/e2e/settings-integration.spec.ts` - Settings UI integration

#### CI/CD
15. `/home/pbrown/SkuInventory/.github/workflows/test.yml` - GitHub Actions workflow

### Files to Modify
16. `/home/pbrown/SkuInventory/vitest.config.ts` - Add integration test support
17. `/home/pbrown/SkuInventory/package.json` - Add test:integration script
18. `/home/pbrown/SkuInventory/tests/setup.ts` - Add global test setup/teardown

## Final Sweep Results

### Services Search
**Inventory Service** (`src/services/inventory.ts`):
- 10 exported functions, only 1 has unit tests (`calculateReorderStatus`)
- Missing: transaction functions, quantity aggregation, deletion checks

**BOM Service** (`src/services/bom.ts`):
- 9 exported functions, 0 have unit tests
- Missing: all BOM calculation and management functions

**Import Service** (`src/services/import.ts`):
- 5 exported functions, 0 have unit tests
- Missing: CSV parsing, validation, template generation

**Export Service** (`src/services/export.ts`):
- 4 exported functions, 0 have unit tests
- Missing: CSV generation, field escaping

### API Routes
14 API route directories identified:
- `/api/auth` - NextAuth
- `/api/components` - ✅ Partial tenant scoping tests
- `/api/skus` - ✅ Partial tenant scoping tests
- `/api/bom-versions` - ✅ Partial tenant scoping tests
- `/api/transactions` - ❌ No integration tests
- `/api/settings` - ❌ No integration tests
- `/api/import/*` - ❌ No integration tests
- `/api/export/*` - ❌ No integration tests
- `/api/dashboard` - ❌ No integration tests
- `/api/feedback` - ✅ Has E2E test
- `/api/users` - ❌ No integration tests
- `/api/health` - ❌ No tests (low priority)

### Type Definitions
All types are in `src/types/`:
- `component.ts`, `sku.ts`, `transaction.ts`, `settings.ts`
- Zod schemas used for validation
- Well-defined for testing

### Test Files
**Current**: 11 test files (5 unit, 6 e2e)
**Needed**: 15 new test files
**Total Coverage**: ~26 test files after completion

## All Affected Files (Comprehensive List)

### Service Layer (needs unit tests)
- `/home/pbrown/SkuInventory/src/services/inventory.ts` - 9 untested functions
- `/home/pbrown/SkuInventory/src/services/bom.ts` - 9 untested functions
- `/home/pbrown/SkuInventory/src/services/import.ts` - 5 untested functions
- `/home/pbrown/SkuInventory/src/services/export.ts` - 4 untested functions

### API Routes (need integration tests)
- `/home/pbrown/SkuInventory/src/app/api/components/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/components/[id]/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/skus/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/skus/[id]/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/transactions/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/transactions/build/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/transactions/receipt/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/transactions/adjustment/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/settings/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/import/components/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/import/skus/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/export/components/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/export/skus/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/export/transactions/route.ts`

### Supporting Files
- `/home/pbrown/SkuInventory/src/lib/auth.ts` - Authentication logic
- `/home/pbrown/SkuInventory/src/lib/db.ts` - Database connection
- `/home/pbrown/SkuInventory/src/types/component.ts` - Component types/schemas
- `/home/pbrown/SkuInventory/src/types/sku.ts` - SKU types/schemas
- `/home/pbrown/SkuInventory/src/types/transaction.ts` - Transaction types/schemas
- `/home/pbrown/SkuInventory/src/types/settings.ts` - Settings types/schemas

## Acceptance Criteria

- [ ] **Unit Tests**
  - [ ] Inventory math functions (calculateReorderStatus, buildable units, insufficient inventory check)
  - [ ] BOM unit cost calculations
  - [ ] CSV parsing handles quotes, commas, newlines correctly
  - [ ] CSV escaping handles special characters correctly
  - [ ] All unit tests pass with `npm test`

- [ ] **API Integration Tests**
  - [ ] Auth-required endpoints return 401 for unauthenticated requests
  - [ ] All CRUD endpoints enforce tenant scoping (return 404 for cross-tenant access)
  - [ ] Build transaction respects allowNegativeInventory setting
  - [ ] Receipt/adjustment transactions update inventory correctly
  - [ ] Settings save/load properly and validate schema
  - [ ] Import/export APIs handle valid and invalid CSV data

- [ ] **E2E Tests**
  - [ ] Full workflow: login → create component → create SKU → build → export
  - [ ] Settings changes affect business logic (reorder status, negative inventory)
  - [ ] Different user roles have appropriate access
  - [ ] All e2e tests pass with `npm run test:e2e`

- [ ] **CI Integration**
  - [ ] GitHub Actions workflow runs tests on PR/push
  - [ ] Test database is properly configured
  - [ ] All tests pass in CI environment

- [ ] **Code Quality**
  - [ ] Test coverage for critical paths reaches baseline (>60% for services)
  - [ ] No test errors or warnings
  - [ ] Tests follow existing patterns
  - [ ] Test names are descriptive and clear

## Handoff to Plan Agent

**Summary**:
This issue requires comprehensive test coverage for a mature codebase that currently has minimal testing. The existing infrastructure (Vitest, Playwright) is in place, but most business logic and API endpoints lack tests. The work is split into three main categories: (1) unit tests for pure functions in the service layer, (2) API integration tests for authentication, authorization, and tenant scoping, and (3) E2E tests for critical user workflows. The highest priority areas are inventory math (calculations that affect money/inventory), tenant scoping (security-critical), and import/export (data integrity).

**Key Points**:
1. Testing infrastructure exists but needs database helpers and API utilities
2. 27 service functions need unit tests (only 1 currently tested)
3. 15+ API endpoints need integration tests for auth/tenant scoping
4. CSV import/export needs both unit and integration tests (escaping, validation)
5. Settings integration needs testing (affects business logic in 5+ endpoints)
6. E2E tests should cover full user workflows with different roles
7. CI/CD integration needed (GitHub Actions)
8. Estimated 16-24 hours total effort

**Suggested Phases**:
1. **Phase 1 - Foundation** (3-4 hours): Test helpers, fixtures, database utilities
2. **Phase 2 - Unit Tests** (6-8 hours): Service layer functions (inventory, BOM, import/export)
3. **Phase 3 - Integration Tests** (6-8 hours): API routes (auth, tenant scoping, transactions, settings)
4. **Phase 4 - E2E Tests** (2-3 hours): Critical user workflows
5. **Phase 5 - CI Setup** (1-2 hours): GitHub Actions, test database config

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Issue Parsing | 2m |
| Codebase Exploration | 12m |
| Pattern Identification | 8m |
| Comprehensive Analysis | 15m |
| Report Writing | 8m |
| **Total** | **45m** |
