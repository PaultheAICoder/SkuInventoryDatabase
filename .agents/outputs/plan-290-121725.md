# Implementation Plan
**Generated**: 2025-12-17T10:45:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #290
**Estimated Build Time**: 3-4 hours
**Complexity**: Medium

## Investigation Summary

### Request Analysis
**Type**: Bug - Security / Authorization
**Source**: GitHub Issue #290
**Priority**: High

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="lot"` or `--testPathPattern="lot"`

### Issue Validation
**Status**: Valid - vulnerability confirmed
**Recent Changes**:
- `feat(issue #84): implement FEFO lot selection for build consumption` - Added lotOverrides feature
- `feat(issue #199): add companyId enforcement to inventory service layer` - But did not cover lotOverrides

### Current State Assessment

**The Bug**: `createBuildTransaction` in `src/services/inventory.ts` accepts `lotOverrides` parameter and uses the provided `lotId` values directly to update `LotBalance` without verifying:
1. The lot exists
2. The lot belongs to the correct component
3. **CRITICAL**: The lot's component belongs to the user's selected company

**Affected Code Paths**:

| Location | Issue | Severity |
|----------|-------|----------|
| `src/services/inventory.ts` lines 1026-1045 | `lotOverrides` used directly without tenant validation | CRITICAL |
| `src/services/lot-selection.ts` lines 208-244 | `validateLotOverrides` exists but lacks `companyId` param | HIGH |
| `src/app/api/transactions/build/route.ts` line 151 | `validateLotOverrides` is NOT called before `createBuildTransaction` | HIGH |

**Safe Code Paths** (no action needed):
- FEFO lot selection (lines 1048-1055): Uses `bomLine.componentId` which comes from BOM already validated for company
- `checkExpiredLotsForBuild`: Uses `bomVersionId` which is validated upstream in route
- `getAvailableLotsForComponent`: Only used internally with validated componentIds

### Dependencies & Blockers
1. None - all required patterns exist in codebase

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Medium
**Effort**: 3-4 hours
**Risk**: Low - Clear patterns exist for company validation via `component.companyId`

### Patterns Identified
**Primary**: `src/services/lot.ts` lines 28-39 - `getLotBalance` function shows correct pattern:
```typescript
const lot = await prisma.lot.findFirst({
  where: {
    id: lotId,
    component: { companyId },
  },
  select: { id: true },
})
if (!lot) {
  throw new Error('Lot not found or access denied')
}
```

**Secondary**: `src/app/api/lots/[id]/route.ts` lines 25-31 - Shows lot query with company scoping via component relation

### Ripple Effect Analysis
**Files Identified**: 3

| File | Why Affected |
|------|--------------|
| `src/services/lot-selection.ts` | Update `validateLotOverrides` to accept and validate `companyId` |
| `src/app/api/transactions/build/route.ts` | Add call to `validateLotOverrides` with `selectedCompanyId` |
| `tests/integration/lot-consumption.test.ts` | Add cross-tenant security tests |

**No other files use `lotOverrides`** - pattern search confirmed only 3 files reference this feature.

---

## Executive Summary

This fix adds tenant validation to the build transaction lot override feature. Currently, a user can pass arbitrary UUIDs in `lotOverrides` and if valid lot IDs, will consume inventory from ANY company. The fix updates `validateLotOverrides` to accept a `companyId` parameter and verify lots belong to that company via the component relation, then calls this validation from the API route before processing the build.

## Phase 1: Update Service Layer Validation

### Subtask 1.1: Add companyId parameter to validateLotOverrides
**File**: `/home/pbrown/SkuInventory/src/services/lot-selection.ts`
**Pattern**: Follow `src/services/lot.ts:28-39` (`getLotBalance`)
**Instructions**:

1. Update function signature to require `companyId`:
```typescript
export async function validateLotOverrides(
  overrides: Array<{
    componentId: string
    allocations: Array<{ lotId: string; quantity: number }>
  }>,
  companyId: string  // NEW PARAMETER
): Promise<{ valid: boolean; errors: string[] }>
```

2. Update the lot query to include company validation via component:
```typescript
const lot = await prisma.lot.findFirst({  // Change from findUnique
  where: {
    id: alloc.lotId,
    component: { companyId },  // ADD COMPANY SCOPING
  },
  include: { balance: true },
})
```

3. Update error message for not found to be security-safe (don't reveal if lot exists):
```typescript
if (!lot) {
  errors.push(`Lot ${alloc.lotId} not found or access denied`)
  continue
}
```

**Validation Commands**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Function signature updated to require `companyId`
- [ ] Query uses `findFirst` with `component: { companyId }` filter
- [ ] Error message does not leak information about lot existence
- [ ] TypeScript compiles without errors

### Subtask 1.2: Update componentId validation to use company-scoped lookup
**File**: `/home/pbrown/SkuInventory/src/services/lot-selection.ts`
**Pattern**: Follow existing lot-component validation pattern
**Instructions**:

The current check `lot.componentId !== override.componentId` is still valid, but we should verify the component itself belongs to the company. Since we're already filtering by `component.companyId` in the lot query, this provides dual validation. However, add explicit component existence check:

After the lot validation block (around line 234), add:
```typescript
// Also verify the component in the override belongs to the company
const component = await prisma.component.findFirst({
  where: {
    id: override.componentId,
    companyId,
  },
  select: { id: true },
})
if (!component) {
  errors.push(`Component ${override.componentId} not found or access denied`)
  continue  // Skip all allocations for this component
}
```

Actually, reviewing the code more carefully - the current structure validates per-allocation. Better approach: validate the component ONCE before iterating allocations. Restructure the for loop:

```typescript
for (const override of overrides) {
  // First validate the component belongs to the company
  const component = await prisma.component.findFirst({
    where: {
      id: override.componentId,
      companyId,
    },
    select: { id: true },
  })
  if (!component) {
    errors.push(`Component ${override.componentId} not found or access denied`)
    continue // Skip all allocations for invalid component
  }

  for (const alloc of override.allocations) {
    // ... existing lot validation with company scope
  }
}
```

**Validation Commands**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Component validation added with company scoping
- [ ] Component validation happens before allocation loop
- [ ] Invalid components skip all their allocations
- [ ] TypeScript compiles without errors

## Phase 2: Update API Route to Call Validation

### Subtask 2.1: Import and call validateLotOverrides in build route
**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/build/route.ts`
**Pattern**: Follow existing validation pattern at lines 66-77 (location validation)
**Instructions**:

1. Add import at top of file (around line 7):
```typescript
import { createBuildTransaction, getCompanySettings, checkInsufficientInventory, checkExpiredLotsForBuild } from '@/services/inventory'
import { validateLotOverrides } from '@/services/lot-selection'  // ADD THIS
```

2. Add validation block BEFORE calling `createBuildTransaction` (after line 130, before the try block at line 132):
```typescript
// Validate lot overrides if provided
if (data.lotOverrides && data.lotOverrides.length > 0) {
  const lotValidation = await validateLotOverrides(data.lotOverrides, selectedCompanyId)
  if (!lotValidation.valid) {
    return error(
      `Invalid lot overrides: ${lotValidation.errors.join('; ')}`,
      400
    )
  }
}
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Import added for `validateLotOverrides`
- [ ] Validation called when `lotOverrides` is provided
- [ ] Returns 400 with clear error message on validation failure
- [ ] TypeScript compiles without errors
- [ ] Build completes without errors

## Phase 3: Add Integration Tests

### Subtask 3.1: Add cross-tenant lot override security test
**File**: `/home/pbrown/SkuInventory/tests/integration/lot-consumption.test.ts`
**Pattern**: Follow existing test structure in same file (e.g., lines 304-365)
**Instructions**:

**IMPORTANT**: All test sessions (admin, ops, viewer) are in the SAME company (Tonsil Tech). The test must create a second company dynamically to test cross-tenant scenarios.

Add a new describe block after the existing "Build with manual lot overrides" section. First, add a helper to create a second company with brand:

```typescript
/**
 * Helper to create a second company for cross-tenant testing
 */
async function createSecondCompanyWithBrand(): Promise<{
  companyId: string
  brandId: string
  userId: string
}> {
  const prisma = getIntegrationPrisma()
  const timestamp = Date.now()

  // Create a second company
  const company = await prisma.company.create({
    data: {
      name: `Test Company ${timestamp}`,
    },
  })

  // Create a brand for the second company
  const brand = await prisma.brand.create({
    data: {
      companyId: company.id,
      name: `Test Brand ${timestamp}`,
    },
  })

  // Create a default location for the second company
  await prisma.location.create({
    data: {
      companyId: company.id,
      name: 'Main Warehouse',
      type: 'warehouse',
      isDefault: true,
      isActive: true,
    },
  })

  // Get existing admin user ID (we'll use the same user but different company context)
  const userId = TEST_SESSIONS.admin!.user.id

  return { companyId: company.id, brandId: brand.id, userId }
}

/**
 * Helper to create component in a specific company/brand
 */
async function createComponentInCompany(
  companyId: string,
  brandId: string,
  userId: string
): Promise<{ id: string; name: string }> {
  const prisma = getIntegrationPrisma()
  const timestamp = Date.now()
  const component = await prisma.component.create({
    data: {
      brandId,
      companyId,
      name: `Cross-Tenant Component ${timestamp}`,
      skuCode: `CTC-${timestamp}`,
      category: 'Test',
      unitOfMeasure: 'each',
      costPerUnit: 10.0,
      createdById: userId,
      updatedById: userId,
    },
  })
  return { id: component.id, name: component.name }
}

describe('Build with cross-tenant lot override security', () => {
  it('rejects lot override with lot from different company', async () => {
    // Use admin session for Company A (primary)
    setTestSession(TEST_SESSIONS.admin!)
    const companyAId = TEST_SESSIONS.admin!.user.companyId
    const userId = TEST_SESSIONS.admin!.user.id

    // Create component and lot in Company A
    const componentA = await createTestComponentInDb(companyAId)
    const lotFromCompanyA = await createLotWithBalance(
      componentA.id,
      'LOT-COMPANY-A',
      100,
      new Date('2025-06-01')
    )

    // Create Company B dynamically
    const companyB = await createSecondCompanyWithBrand()

    // Create component and SKU in Company B
    const componentB = await createComponentInCompany(
      companyB.companyId,
      companyB.brandId,
      userId
    )
    await createLotWithBalance(componentB.id, 'LOT-COMPANY-B', 100)

    // Create SKU in Company B
    const prisma = getIntegrationPrisma()
    const skuB = await prisma.sKU.create({
      data: {
        brandId: companyB.brandId,
        companyId: companyB.companyId,
        name: `Cross-Tenant SKU ${Date.now()}`,
        internalCode: `CTSKU-${Date.now()}`,
        salesChannel: 'Amazon',
        createdById: userId,
        updatedById: userId,
      },
    })

    // Create BOM for SKU B
    await prisma.bOMVersion.create({
      data: {
        skuId: skuB.id,
        versionName: 'v1.0',
        effectiveStartDate: new Date('2020-01-01'),
        isActive: true,
        createdById: userId,
        lines: {
          create: [{ componentId: componentB.id, quantityPerUnit: 1 }],
        },
      },
    })

    // Switch session to Company B context
    setTestSession({
      user: {
        ...TEST_SESSIONS.admin!.user,
        companyId: companyB.companyId,
        selectedCompanyId: companyB.companyId,
        companyName: 'Test Company',
      },
    })

    // Attempt build in Company B using lot from Company A (should fail)
    const request = createTestRequest('/api/transactions/build', {
      method: 'POST',
      body: {
        skuId: skuB.id,
        unitsToBuild: 1,
        date: new Date().toISOString().split('T')[0],
        outputToFinishedGoods: false,
        lotOverrides: [
          {
            componentId: componentB.id, // Company B's component
            allocations: [
              { lotId: lotFromCompanyA.lotId, quantity: 1 } // Company A's lot!
            ],
          },
        ],
      },
    })

    const response = await createBuild(request)
    const result = await parseRouteResponse(response)

    // Should be rejected
    expect(result.status).toBe(400)
    expect(result.error).toContain('not found or access denied')

    // Verify Company A's lot was NOT consumed
    const lotABalance = await prisma.lotBalance.findUnique({
      where: { lotId: lotFromCompanyA.lotId },
    })
    expect(lotABalance?.quantity.toNumber()).toBe(100) // Unchanged
  })

  it('rejects lot override with component from different company', async () => {
    // Use admin session for Company A
    setTestSession(TEST_SESSIONS.admin!)
    const companyAId = TEST_SESSIONS.admin!.user.companyId
    const userId = TEST_SESSIONS.admin!.user.id

    // Create component and lot in Company A
    const componentA = await createTestComponentInDb(companyAId)
    const lotA = await createLotWithBalance(componentA.id, 'LOT-A-COMP', 100)

    // Create Company B dynamically
    const companyB = await createSecondCompanyWithBrand()

    // Create component and SKU in Company B
    const componentB = await createComponentInCompany(
      companyB.companyId,
      companyB.brandId,
      userId
    )
    await createLotWithBalance(componentB.id, 'LOT-B-COMP', 100)

    // Create SKU in Company B
    const prisma = getIntegrationPrisma()
    const skuB = await prisma.sKU.create({
      data: {
        brandId: companyB.brandId,
        companyId: companyB.companyId,
        name: `Cross-Tenant SKU2 ${Date.now()}`,
        internalCode: `CTSKU2-${Date.now()}`,
        salesChannel: 'Amazon',
        createdById: userId,
        updatedById: userId,
      },
    })

    // Create BOM for SKU B using componentB
    await prisma.bOMVersion.create({
      data: {
        skuId: skuB.id,
        versionName: 'v1.0',
        effectiveStartDate: new Date('2020-01-01'),
        isActive: true,
        createdById: userId,
        lines: {
          create: [{ componentId: componentB.id, quantityPerUnit: 1 }],
        },
      },
    })

    // Switch session to Company B context
    setTestSession({
      user: {
        ...TEST_SESSIONS.admin!.user,
        companyId: companyB.companyId,
        selectedCompanyId: companyB.companyId,
        companyName: 'Test Company',
      },
    })

    // Attempt build using Company A's component in override
    const request = createTestRequest('/api/transactions/build', {
      method: 'POST',
      body: {
        skuId: skuB.id,
        unitsToBuild: 1,
        date: new Date().toISOString().split('T')[0],
        outputToFinishedGoods: false,
        lotOverrides: [
          {
            componentId: componentA.id, // Company A's component!
            allocations: [{ lotId: lotA.lotId, quantity: 1 }],
          },
        ],
      },
    })

    const response = await createBuild(request)
    const result = await parseRouteResponse(response)

    expect(result.status).toBe(400)
    expect(result.error).toContain('not found or access denied')
  })
})
```

**Note**: These tests dynamically create a second company to properly test cross-tenant isolation. The test cleanup in `cleanupBeforeTest` will need to also clean up the dynamically created company and related data.

**Validation Commands**:
```bash
npm test -- --testPathPattern="lot-consumption"
```

**Completion Criteria**:
- [ ] Test for cross-tenant lot override rejection added
- [ ] Test for cross-tenant component in override rejection added
- [ ] Tests verify that cross-tenant lots are NOT consumed
- [ ] All tests pass

### Subtask 3.2: Add unit test for validateLotOverrides with companyId
**File**: `/home/pbrown/SkuInventory/tests/unit/lot-selection.test.ts`
**Pattern**: Follow existing unit tests in the file
**Instructions**:

Add tests for the updated `validateLotOverrides` function:

```typescript
describe('validateLotOverrides with company scoping', () => {
  it('rejects lot from different company', async () => {
    // This test would require mocking prisma
    // Add based on existing mock patterns in the test file
  })

  it('accepts valid lot from same company', async () => {
    // Add positive case test
  })

  it('rejects component from different company', async () => {
    // Test component-level validation
  })
})
```

**Validation Commands**:
```bash
npm test -- --testPathPattern="lot-selection"
```

**Completion Criteria**:
- [ ] Unit tests added for company-scoped validation
- [ ] Tests cover both positive and negative cases
- [ ] All tests pass

## Phase 4: Final Validation

### Subtask 4.1: Run full validation suite
**File**: N/A (validation only)
**Instructions**:

Run all validation commands to ensure no regressions:

```bash
# TypeScript compilation
npx tsc --noEmit

# Build
npm run build

# Lint
npm run lint

# Run related tests
npm test -- --testPathPattern="lot"

# Run all tests (smoke test)
npm test
```

**Completion Criteria**:
- [ ] TypeScript compiles with no errors
- [ ] Build completes with no errors
- [ ] Lint passes with no errors/warnings
- [ ] All lot-related tests pass
- [ ] Full test suite passes

---

## Summary of Deliverables
**Files Created**: 0
**Files Modified**: 3
- `/home/pbrown/SkuInventory/src/services/lot-selection.ts` - Add companyId validation
- `/home/pbrown/SkuInventory/src/app/api/transactions/build/route.ts` - Call validation
- `/home/pbrown/SkuInventory/tests/integration/lot-consumption.test.ts` - Add security tests

## Handoff to Build Agent
1. Execute subtasks in exact order (Phase 1 -> Phase 2 -> Phase 3 -> Phase 4)
2. Complete all Phase 1 subtasks before Phase 2
3. Test completion criteria before next subtask
4. Follow reference patterns exactly (especially `src/services/lot.ts:28-39`)

## Test Strategy Note
- Use Vitest for unit and integration tests
- Integration tests in `tests/integration/lot-consumption.test.ts` test the full API route
- Unit tests in `tests/unit/lot-selection.test.ts` test service function in isolation
- Run `npm test -- --testPathPattern="lot"` for targeted testing

## Performance Metrics
| Phase | Estimated Duration |
|-------|-------------------|
| Investigation | 20m |
| Validation | 5m |
| Planning | 15m |
| **Total** | **40m** |
