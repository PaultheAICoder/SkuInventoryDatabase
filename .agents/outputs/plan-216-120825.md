# Implementation Plan
**Generated**: 2025-12-08T22:30:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #216
**Estimated Build Time**: 2-4 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Enhancement (Feature continuation)
**Source**: GitHub Issue #216
**Priority**: Medium
**Parent Issue**: #172 (Phases 1 & 2 completed)

### Task Classification
**Category**: NEW_FEATURE (continuation of partially implemented feature)
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="feedback"` or `--filter="email"`

### Issue Validation
**Status**: Valid
**Recent Changes**: Issue #172 completed Phases 1 & 2 on Dec 4, 2025

### Current State Assessment

**CRITICAL FINDING**: Phase 3 (Email Reply Processing) is ALREADY IMPLEMENTED.

After thorough investigation of the codebase, the following components are already in place:

#### Already Implemented (From Phase 1 & 2):

1. **Database Layer** - Complete
   - `Feedback` model with all required fields (status, emailMessageId, verifiedAt, resolvedAt)
   - `FeedbackReply` model for audit trail
   - `FeedbackStatus` enum: pending, in_progress, resolved, verified, reopened

2. **Email Parsing Service** - Complete
   - `/home/pbrown/SkuInventory/src/services/email-parsing.ts`
   - `parseReplyDecision()` - Parses emails for "verified" vs "changes_requested"
   - `extractIssueNumber()` - Extracts issue # from email subject
   - `isReplyEmail()` - Detects reply emails
   - Keyword detection for verification and change requests

3. **Email Reply Processing** - Complete
   - `/home/pbrown/SkuInventory/src/services/feedback.ts`
   - `processEmailReply()` - Full implementation including:
     - Parsing email body
     - Updating feedback status to 'verified' or 'reopened'
     - Creating follow-up GitHub issues via Octokit
     - Recording FeedbackReply audit records

4. **Microsoft Graph Email Service** - Complete (Stubbed)
   - `/home/pbrown/SkuInventory/src/lib/graph-email.ts`
   - `fetchNewReplies()` - Fetches emails from inbox
   - `sendGraphEmail()` - Sends emails
   - Graceful degradation when not configured

5. **Cron Endpoint for Polling (Option A)** - Complete
   - `/home/pbrown/SkuInventory/src/app/api/cron/email-monitor/route.ts`
   - Protected by CRON_SECRET
   - Polls inbox every 5 minutes (when called by external cron)
   - Validates sender matches original submitter
   - Processes replies and updates feedback status

6. **GitHub Webhook for Issue Closed** - Complete
   - `/home/pbrown/SkuInventory/src/app/api/webhooks/github/route.ts`
   - Sends resolution notification email to user

7. **Tests** - Complete
   - 52 unit tests covering feedback service and types

### What is NOT Implemented (The Actual Gap):

The only thing missing is **Azure AD configuration** - the environment variables are documented but not yet configured:
- `AZURE_TENANT_ID`
- `AZURE_CLIENT_ID`
- `AZURE_CLIENT_SECRET`
- `FEEDBACK_EMAIL`

### Recommendation: No Code Changes Required

**The issue #216 requirements are ALREADY SATISFIED by the existing implementation.**

The three options mentioned in the issue:
- **Option A (Polling)**: Already implemented via `/api/cron/email-monitor`
- **Option B (Webhooks)**: Would require additional Microsoft Graph webhook setup, but is NOT necessary
- **Option C (Manual Verification Links)**: Could be added as enhancement, but is NOT required

### Dependencies & Blockers
1. **Azure AD Configuration** - Environment variables pending
2. **External Cron Service** - Need to set up cron job to call `/api/cron/email-monitor`

**Can Proceed?**: YES - but this is a CONFIGURATION task, not a CODE task

---

## Executive Summary

**Phase 3 email reply processing is already fully implemented.** The codebase contains:
- Complete email parsing with keyword detection
- Microsoft Graph API integration (stubbed pending Azure config)
- Cron-based polling endpoint
- GitHub follow-up issue creation
- Comprehensive audit trail

The ONLY remaining work is **configuration**:
1. Set up Azure AD application and obtain credentials
2. Configure environment variables
3. Set up external cron job to trigger the email monitor endpoint

## Recommended Action

### Option 1: Close Issue #216 (Recommended)

Close this issue as "already implemented" with the following note:

```
Phase 3 email reply processing was implemented as part of #172. All code is complete:
- Email parsing: src/services/email-parsing.ts
- Reply processing: src/services/feedback.ts (processEmailReply)
- Cron endpoint: src/app/api/cron/email-monitor/route.ts
- Graph email service: src/lib/graph-email.ts

Remaining work (configuration-only):
1. Configure Azure AD application with Mail.Read permission
2. Set AZURE_TENANT_ID, AZURE_CLIENT_ID, AZURE_CLIENT_SECRET, FEEDBACK_EMAIL in environment
3. Set up external cron to call POST /api/cron/email-monitor with Bearer CRON_SECRET every 5 minutes

See completion doc: completion-docs/2025-12-04-issue-172-feedback-loop.md
```

### Option 2: Create Configuration-Only Plan

If a formal implementation cycle is desired, the following subtasks would apply:

---

## Phase 0: Verification (Optional)

### Subtask 0.1: Verify Existing Implementation
**File**: Multiple (verification only)
**Instructions**:
1. Run existing email-parsing tests: `npm test -- --testPathPattern="feedback"`
2. Verify build passes: `npm run build`
3. Confirm Graph email service exists with proper error handling
**Completion Criteria**: [ ] Tests pass [ ] Build passes [ ] Code review confirms implementation

---

## Phase 1: Documentation (Optional Enhancement)

### Subtask 1.1: Create Azure AD Setup Guide
**File**: `/home/pbrown/SkuInventory/docs/configuration/azure-ad-email.md` (NEW)
**Instructions**:
1. Document Azure AD app registration steps
2. Document required API permissions (Mail.Read, Mail.Send)
3. Document environment variable configuration
4. Include testing/verification steps
**Completion Criteria**: [ ] Guide complete [ ] Steps verified

### Subtask 1.2: Add Cron Job Setup Documentation
**File**: `/home/pbrown/SkuInventory/docs/configuration/cron-jobs.md` (NEW or append)
**Instructions**:
1. Document cron endpoint URL and authentication
2. Provide example cron configurations (crontab, systemd timer, Vercel cron)
3. Document expected response format
**Completion Criteria**: [ ] Documentation complete

---

## Phase 2: State Persistence Enhancement (Optional)

### Subtask 2.1: Add lastCheckTime to Database
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Rationale**: Currently lastCheckTime is stored in memory (resets on server restart)
**Instructions**:
1. Add `SystemConfig` model or similar for persistent settings
2. Store lastCheckTime in database instead of memory
3. This is an enhancement, not a blocker
**Completion Criteria**: [ ] Schema updated [ ] Migration created [ ] Email monitor uses DB

---

## Ripple Effect Analysis
**Files Identified**: 0 new code files needed
- All code for email reply processing already exists
- No ripple effects since implementation is complete

---

## Summary of Deliverables
**Files Created**: 0 (code already exists)
**Files Modified**: 0 (no changes needed)
**Documentation Needed**: Azure AD setup guide, cron job configuration

## Test Strategy Note
- Existing tests: 52 feedback-related unit tests
- No new tests needed unless enhancements are implemented

## Handoff to Build Agent

**NO BUILD REQUIRED** - This issue should be:
1. Closed as "already implemented"
2. OR converted to a documentation-only task
3. OR converted to a configuration task (Azure AD setup)

If enhancements are desired (Option C manual verification links, persistent cron state), create separate issues for those.

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 12m |
| Validation | 3m |
| Planning | 5m |
| **Total** | **20m** |

---

## Appendix: Existing Implementation Reference

### Email Parsing Keywords (Already Implemented)

**Verification Keywords** (in `/home/pbrown/SkuInventory/src/services/email-parsing.ts`):
```typescript
const VERIFY_KEYWORDS = [
  'verified', 'looks good', 'works', 'fixed', 'confirmed',
  'approved', 'great', 'perfect', 'thank you', 'thanks',
  'all good', 'working now', 'issue resolved', 'problem solved',
]
```

**Change Request Keywords**:
```typescript
const CHANGE_KEYWORDS = [
  'changes needed', 'not working', 'still broken', 'issue remains',
  'problem persists', 'needs more work', "doesn't work", "does not work",
  'still not', 'still having', 'not fixed', 'still see',
  'same issue', 'same problem', 'different issue', 'another issue',
]
```

### Email Processing Flow (Already Implemented)

```
1. External cron calls /api/cron/email-monitor (every 5 min)
2. Endpoint fetches new emails via Graph API (fetchNewReplies)
3. For each reply email:
   a. Extract issue number from subject
   b. Find Feedback record by issue number
   c. Verify sender matches original submitter
   d. Parse email body (parseReplyDecision)
   e. If "verified": Update status, create FeedbackReply
   f. If "changes_requested": Create follow-up GitHub issue, update status to "reopened"
4. Return processing results
```

### Environment Variables (Documented in .env.example)

```
AZURE_TENANT_ID=your-tenant-id
AZURE_CLIENT_ID=your-client-id
AZURE_CLIENT_SECRET=your-client-secret
FEEDBACK_EMAIL=ai-coder@vital-enterprises.com
CRON_SECRET=your-cron-secret-here-min-16-chars
```
