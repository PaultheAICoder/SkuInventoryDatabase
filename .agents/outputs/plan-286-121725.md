# Implementation Plan
**Generated**: 2025-12-17T15:30:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #286
**Estimated Build Time**: 2-3 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Bug (Security - Authorization/tenant scoping)
**Source**: GitHub Issue #286
**Priority**: Critical (data exposure vulnerability)

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED
**Suggested Filter**: `--testPathPattern="forecasts"`

### Issue Validation
**Status**: Valid - confirmed by code review
**Recent Changes**:
- `7906e0c fix(issue #191): add companyId filtering to inventory calculations` (within 60 days)
- `5f774dd feat(issue #119): add forecast export and integration tests`
- `9f2bb4a feat(issue #116): add API endpoints for forecast data`
- `6a91a29 feat(issue #115): implement forecast service with consumption calculation`

### Current State Assessment

**The Bug**: Forecast API routes use `session.user.selectedCompanyId` directly without validating that it is present. If `selectedCompanyId` is `undefined` or `null` (due to stale session, tampered token, or edge case), Prisma queries run without a company filter, potentially exposing data from all companies.

**Affected Files (4 total)**:
1. `/home/pbrown/SkuInventory/src/app/api/forecasts/route.ts` (line 50) - GET endpoint, list forecasts
2. `/home/pbrown/SkuInventory/src/app/api/export/forecasts/route.ts` (line 43) - GET endpoint, export forecasts CSV
3. `/home/pbrown/SkuInventory/src/app/api/forecasts/config/route.ts` (lines 48, 78, 81) - GET/PUT config
4. `/home/pbrown/SkuInventory/src/app/api/forecasts/[componentId]/route.ts` (line 44) - GET single forecast

**Note**: The `[componentId]` route has some protection since it verifies the component belongs to `selectedCompanyId` before returning data (line 47-57), but still uses the potentially-undefined value without validation first.

**How the bug manifests**:
```typescript
// Current code (forecasts/route.ts line 50):
const selectedCompanyId = session.user.selectedCompanyId
// No validation! Passes undefined to service...

// In service (forecast.ts line 217):
const components = await prisma.component.findMany({
  where: {
    companyId,  // If undefined, no company filter!
    isActive: true,
  },
  ...
})
```

### Dependencies & Blockers
None - all required utilities exist.

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Simple
**Effort**: 2-3 hours
**Risk**: Low (straightforward validation pattern exists in codebase)

### Patterns Identified
**Primary Reference**: `/home/pbrown/SkuInventory/src/app/api/users/route.ts` (lines 35-41)
```typescript
const selectedCompanyId = session.user.selectedCompanyId

if (!selectedCompanyId) {
  return NextResponse.json(
    { error: 'No company selected. Please refresh the page and try again.' },
    { status: 400 }
  )
}
```

**Secondary Reference**: `/home/pbrown/SkuInventory/src/app/api/skus/[id]/route.ts` (lines 36-39)
```typescript
const selectedCompanyId = session.user.selectedCompanyId
if (!selectedCompanyId) {
  return error('No company selected. Please select a company from the sidebar.', 400)
}
```

**Preferred Pattern**: Use the `error()` helper from `@/lib/api-response` for consistency.

### Ripple Effect Analysis
**Files Identified**: 4 API route files + 1 test file

| File | Modification Type |
|------|-------------------|
| `src/app/api/forecasts/route.ts` | Add selectedCompanyId validation |
| `src/app/api/export/forecasts/route.ts` | Add selectedCompanyId validation |
| `src/app/api/forecasts/config/route.ts` | Add selectedCompanyId validation (2 places) |
| `src/app/api/forecasts/[componentId]/route.ts` | Add selectedCompanyId validation |
| `tests/integration/forecasts.test.ts` | Add regression tests for missing company |

---

## Executive Summary

This is a critical security bug where forecast API endpoints accept requests without validating that `selectedCompanyId` is present in the session. The fix adds validation checks to 4 API route files following the existing pattern used in other routes (e.g., `users/route.ts`, `skus/[id]/route.ts`). Returns 400 error when `selectedCompanyId` is missing. Includes regression tests to prevent future occurrences.

---

## Phase 1: API Route Fixes

### Subtask 1.1: Add selectedCompanyId Validation to GET /api/forecasts
**File**: `/home/pbrown/SkuInventory/src/app/api/forecasts/route.ts`
**Pattern**: Follow `src/app/api/skus/[id]/route.ts` lines 36-39

**Instructions**:
1. Import the `error` helper if not already imported (it already is via `parseQuery` import line)
2. After line 50 (`const selectedCompanyId = session.user.selectedCompanyId`), add validation check:
```typescript
if (!selectedCompanyId) {
  return error('No company selected. Please select a company from the sidebar.', 400)
}
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Validation check added after selectedCompanyId assignment
- [ ] Returns 400 error with appropriate message when missing
- [ ] TypeScript compiles without errors
- [ ] Build succeeds

### Subtask 1.2: Add selectedCompanyId Validation to GET /api/export/forecasts
**File**: `/home/pbrown/SkuInventory/src/app/api/export/forecasts/route.ts`
**Pattern**: Follow `src/app/api/skus/[id]/route.ts` lines 36-39

**Instructions**:
1. Import `error` from `@/lib/api-response` (add to existing import on line 5):
   Change: `import { unauthorized, serverError } from '@/lib/api-response'`
   To: `import { unauthorized, serverError, error } from '@/lib/api-response'`
2. After line 43 (`const selectedCompanyId = session.user.selectedCompanyId`), add validation check:
```typescript
if (!selectedCompanyId) {
  return error('No company selected. Please select a company from the sidebar.', 400)
}
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] `error` helper imported
- [ ] Validation check added after selectedCompanyId assignment
- [ ] Returns 400 error with appropriate message when missing
- [ ] TypeScript compiles without errors
- [ ] Build succeeds

### Subtask 1.3: Add selectedCompanyId Validation to GET/PUT /api/forecasts/config
**File**: `/home/pbrown/SkuInventory/src/app/api/forecasts/config/route.ts`
**Pattern**: Follow `src/app/api/skus/[id]/route.ts` lines 36-39

**Instructions**:
1. Import `error` from `@/lib/api-response` (add to existing import on line 4):
   Change: `import { success, unauthorized, forbidden, serverError, parseBody } from '@/lib/api-response'`
   To: `import { success, unauthorized, forbidden, serverError, parseBody, error } from '@/lib/api-response'`

2. In GET handler (around line 48), change direct usage to validated pattern:
   Before:
   ```typescript
   const config = await getFullConfig(session.user.selectedCompanyId)
   ```
   After:
   ```typescript
   const selectedCompanyId = session.user.selectedCompanyId
   if (!selectedCompanyId) {
     return error('No company selected. Please select a company from the sidebar.', 400)
   }
   const config = await getFullConfig(selectedCompanyId)
   ```

3. In PUT handler (around lines 77-81), add similar validation before using selectedCompanyId:
   After the role check (line 70) and before line 77, add:
   ```typescript
   const selectedCompanyId = session.user.selectedCompanyId
   if (!selectedCompanyId) {
     return error('No company selected. Please select a company from the sidebar.', 400)
   }
   ```
   Then update lines 78 and 81 to use `selectedCompanyId` instead of `session.user.selectedCompanyId`

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] `error` helper imported
- [ ] GET handler validates selectedCompanyId
- [ ] PUT handler validates selectedCompanyId
- [ ] All usages updated to use validated variable
- [ ] TypeScript compiles without errors
- [ ] Build succeeds

### Subtask 1.4: Add selectedCompanyId Validation to GET /api/forecasts/[componentId]
**File**: `/home/pbrown/SkuInventory/src/app/api/forecasts/[componentId]/route.ts`
**Pattern**: Follow `src/app/api/skus/[id]/route.ts` lines 36-39

**Instructions**:
1. Import `error` from `@/lib/api-response` (add to existing import on line 4):
   Change: `import { success, unauthorized, notFound, serverError } from '@/lib/api-response'`
   To: `import { success, unauthorized, notFound, serverError, error } from '@/lib/api-response'`

2. After line 44 (`const selectedCompanyId = session.user.selectedCompanyId`), add validation check:
```typescript
if (!selectedCompanyId) {
  return error('No company selected. Please select a company from the sidebar.', 400)
}
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] `error` helper imported
- [ ] Validation check added after selectedCompanyId assignment
- [ ] Returns 400 error with appropriate message when missing
- [ ] TypeScript compiles without errors
- [ ] Build succeeds

---

## Phase 2: Regression Tests

### Subtask 2.1: Add Regression Tests for Missing selectedCompanyId
**File**: `/home/pbrown/SkuInventory/tests/integration/forecasts.test.ts`
**Pattern**: Follow existing test patterns in the file

**Instructions**:
1. Add a test helper to create a session with missing selectedCompanyId.
   Add after line 67 (after TEST_SESSIONS definition usage):
```typescript
/**
 * Create a test session with missing selectedCompanyId for security testing
 */
function createSessionWithoutCompany(): TestUserSession {
  return {
    user: {
      id: TEST_SESSIONS.admin!.user.id,
      email: TEST_SESSIONS.admin!.user.email,
      name: TEST_SESSIONS.admin!.user.name,
      role: TEST_SESSIONS.admin!.user.role,
      companyId: TEST_SESSIONS.admin!.user.companyId,
      companyName: TEST_SESSIONS.admin!.user.companyName,
      selectedCompanyId: undefined as unknown as string, // Simulate missing company
    },
  }
}
```

2. Add test cases for each endpoint. Insert these tests in appropriate describe blocks:

In `describe('GET /api/forecasts', () => {` block (after existing tests, around line 107):
```typescript
    it('returns 400 when selectedCompanyId is missing', async () => {
      setTestSession(createSessionWithoutCompany())

      const response = await getForecasts(createTestRequest('/api/forecasts'))

      expect(response.status).toBe(400)
      const json = await response.json()
      expect(json.message).toContain('No company selected')
    })
```

In `describe('GET /api/forecasts/config', () => {` block (after existing tests, around line 141):
```typescript
    it('returns 400 when selectedCompanyId is missing', async () => {
      setTestSession(createSessionWithoutCompany())

      const response = await getConfig()

      expect(response.status).toBe(400)
      const json = await response.json()
      expect(json.message).toContain('No company selected')
    })
```

In `describe('PUT /api/forecasts/config', () => {` block (after existing tests, around line 188):
```typescript
    it('returns 400 when selectedCompanyId is missing', async () => {
      setTestSession(createSessionWithoutCompany())

      const putRequest = new Request('http://localhost/api/forecasts/config', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ lookbackDays: 45 }),
      })

      const response = await putConfig(putRequest as never)

      expect(response.status).toBe(400)
      const json = await response.json()
      expect(json.message).toContain('No company selected')
    })
```

In `describe('GET /api/export/forecasts', () => {` block (after existing tests, around line 276):
```typescript
    it('returns 400 when selectedCompanyId is missing', async () => {
      setTestSession(createSessionWithoutCompany())

      const response = await exportForecasts(createTestRequest('/api/export/forecasts'))

      expect(response.status).toBe(400)
      const json = await response.json()
      expect(json.message).toContain('No company selected')
    })
```

3. Import `TestUserSession` type if needed (check if it's already imported from auth-mock)

**Validation Commands**:
```bash
npm test -- --testPathPattern="forecasts"
```

**Completion Criteria**:
- [ ] Helper function created for sessions without selectedCompanyId
- [ ] Test added for GET /api/forecasts
- [ ] Test added for GET /api/forecasts/config
- [ ] Test added for PUT /api/forecasts/config
- [ ] Test added for GET /api/export/forecasts
- [ ] All new tests pass
- [ ] Existing tests still pass

### Subtask 2.2: Add Test for GET /api/forecasts/[componentId]
**File**: `/home/pbrown/SkuInventory/tests/integration/forecasts.test.ts`

**Instructions**:
1. Import the route handler for the component forecast endpoint. Add to imports section (after line 24):
```typescript
import { GET as getComponentForecast } from '@/app/api/forecasts/[componentId]/route'
```

2. Add a new describe block for testing the [componentId] endpoint (after the export forecasts describe block):
```typescript
describe('GET /api/forecasts/[componentId]', () => {
  it('returns 400 when selectedCompanyId is missing', async () => {
    setTestSession(createSessionWithoutCompany())

    // Create a component to get an ID
    const component = await createTestComponentInDb(TEST_SESSIONS.admin!.user.companyId)

    const request = createTestRequest(`/api/forecasts/${component.id}`)
    const params = { params: Promise.resolve({ componentId: component.id }) }

    const response = await getComponentForecast(request, params)

    expect(response.status).toBe(400)
    const json = await response.json()
    expect(json.message).toContain('No company selected')
  })

  it('returns forecast for valid component', async () => {
    setTestSession(TEST_SESSIONS.admin!)
    const component = await createTestComponentInDb(TEST_SESSIONS.admin!.user.companyId)

    const request = createTestRequest(`/api/forecasts/${component.id}`)
    const params = { params: Promise.resolve({ componentId: component.id }) }

    const response = await getComponentForecast(request, params)
    const json = await response.json()

    expect(response.status).toBe(200)
    expect(json.data.componentId).toBe(component.id)
  })

  it('returns 401 for unauthenticated request', async () => {
    clearTestSession()
    const component = await createTestComponentInDb(TEST_SESSIONS.admin!.user.companyId)

    const request = createTestRequest(`/api/forecasts/${component.id}`)
    const params = { params: Promise.resolve({ componentId: component.id }) }

    const response = await getComponentForecast(request, params)

    expect(response.status).toBe(401)
  })
})
```

**Validation Commands**:
```bash
npm test -- --testPathPattern="forecasts"
```

**Completion Criteria**:
- [ ] Import added for [componentId] route handler
- [ ] New describe block added for [componentId] endpoint
- [ ] Test for missing selectedCompanyId passes
- [ ] Test for valid component passes
- [ ] Test for unauthenticated request passes

---

## Phase 3: Final Validation

### Subtask 3.1: Run Full Test Suite and Build Verification
**Instructions**:
1. Run TypeScript type checking:
```bash
npx tsc --noEmit
```

2. Run the build:
```bash
npm run build
```

3. Run all forecast tests:
```bash
npm test -- --testPathPattern="forecasts"
```

4. Run lint check:
```bash
npm run lint
```

**Completion Criteria**:
- [ ] TypeScript compiles without errors
- [ ] Build succeeds
- [ ] All forecast tests pass (including new regression tests)
- [ ] Lint passes

---

## Summary of Deliverables

**Files Modified**: 5
| File | Changes |
|------|---------|
| `src/app/api/forecasts/route.ts` | Add selectedCompanyId validation |
| `src/app/api/export/forecasts/route.ts` | Add selectedCompanyId validation + import error helper |
| `src/app/api/forecasts/config/route.ts` | Add selectedCompanyId validation (GET + PUT) + import error helper |
| `src/app/api/forecasts/[componentId]/route.ts` | Add selectedCompanyId validation + import error helper |
| `tests/integration/forecasts.test.ts` | Add regression tests for missing company scenario |

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 -> Phase 2 -> Phase 3)
2. After each file modification, run `npx tsc --noEmit` to verify types
3. Follow reference patterns exactly from `/home/pbrown/SkuInventory/src/app/api/skus/[id]/route.ts`
4. Use the `error()` helper consistently (not `NextResponse.json()` directly)
5. Ensure all new tests pass before marking Phase 2 complete

## Test Strategy Note
- Use Vitest for integration tests
- Run with: `npm test -- --testPathPattern="forecasts"`
- Expected runtime: ~30 seconds for forecast test file

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 8m |
| Validation | 3m |
| Planning | 5m |
| **Total** | **16m** |

---

## Related Files Quick Reference

**Pattern Files**:
- `/home/pbrown/SkuInventory/src/app/api/users/route.ts` (lines 35-41) - validation pattern
- `/home/pbrown/SkuInventory/src/app/api/skus/[id]/route.ts` (lines 36-39) - preferred pattern using error() helper
- `/home/pbrown/SkuInventory/src/lib/api-response.ts` (lines 31-46) - error helper definition

**Service Files** (for reference, no changes needed):
- `/home/pbrown/SkuInventory/src/services/forecast.ts` - service layer (queries are correctly scoped if companyId is provided)

**Test Helpers**:
- `/home/pbrown/SkuInventory/tests/helpers/auth-mock.ts` - session mocking utilities
- `/home/pbrown/SkuInventory/tests/helpers/integration-context.ts` - test utilities
