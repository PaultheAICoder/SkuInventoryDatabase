# Implementation Plan
**Generated**: 2025-12-06T14:30:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #185
**Estimated Build Time**: 4-6 hours
**Complexity**: Moderate

## Investigation Summary

### Request Analysis
**Type**: Enhancement
**Source**: GitHub Issue #185
**Priority**: Medium

**User Requirements** (from issue):
1. Remove "All Brands" option from dropdown - only show individual brands
2. Show only brands/companies the user is assigned to (not all brands)
3. When new company added and user assigned, it should immediately appear in dropdown
4. When user selects company from dropdown, whole page updates for that company's items
5. Real-time updates

### Task Classification
**Category**: REFACTORING (UI behavior change with minimal new code)
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="CompanyBrandSelector|auth"`

### Issue Validation
**Status**: Valid
**Recent Changes**:
- `b0cadbd` feat(issue #167): add unified company/brand selector with cascading menu
- `132766f` fix(issue #173): add user validation to catch stale JWT tokens

### Current State Assessment

**Component Architecture**:
1. **CompanyBrandSelector** (`src/components/features/CompanyBrandSelector.tsx`)
   - Currently shows "All Brands" option as first item in brand submenu (lines 203-213)
   - Uses `companiesWithBrands` from session which is populated at login
   - Calls `/api/companies/switch` and `/api/brands/switch` APIs
   - Updates session via `updateSession()` which triggers re-renders

2. **Session Data Structure** (`src/lib/auth.ts`)
   - `companiesWithBrands` is populated at login from `UserCompany` join table
   - Currently includes all brands for each company user has access to
   - Already scoped to user's assigned companies via `UserCompany` model

3. **Page Refresh Pattern**:
   - Client pages (Dashboard, Orders, Settings, etc.) use `useEffect` with `session?.user?.selectedCompanyId` and `session?.user?.selectedBrandId` as dependencies
   - When session updates via `updateSession()`, these pages automatically re-fetch their data
   - Server-rendered pages (Components, SKUs, Lots) use `getServerSession()` and would need a page reload for changes to take effect

4. **API Routes**:
   - `/api/companies/switch` - switches company, auto-selects first brand
   - `/api/brands/switch` - switches brand within company, allows `null` for "All Brands"

### Dependencies & Blockers
None - all required infrastructure exists.

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Moderate
**Effort**: 4-6 hours
**Risk**: Low

### Patterns Identified
**Primary**: `src/components/features/CompanyBrandSelector.tsx` - main component to modify
**Secondary**: `src/lib/auth.ts` - session data population
**Reference**: `src/app/(dashboard)/page.tsx` - pattern for reactive data refresh

### Ripple Effect Analysis
**Files Identified**: 7 files potentially affected

**Core Changes** (must modify):
1. `src/components/features/CompanyBrandSelector.tsx` - Remove "All Brands" UI option
2. `src/lib/auth.ts` - Ensure first brand is auto-selected (not null)
3. `src/app/api/brands/switch/route.ts` - Block null brandId (or keep for backward compat)
4. `src/app/api/companies/switch/route.ts` - Ensure first brand is always selected

**Verification Only** (no changes expected):
5. `src/types/component.ts` - Verify no type changes needed
6. Dashboard page - Verify real-time updates work
7. Other pages using `selectedBrandId` - Verify they handle non-null brand

---

## Executive Summary

This feature removes the "All Brands" option from the company/brand dropdown selector, ensuring users always have a specific brand selected. The implementation requires:
1. Removing the "All Brands" menu item from the CompanyBrandSelector component
2. Updating auth logic to always select first brand (never null)
3. Modifying display text to show just brand name (no "All Brands" fallback)
4. Adding page refresh after company/brand switch for server-rendered pages

The existing session update mechanism already triggers real-time updates for client-side pages. Server-rendered pages will need an explicit `router.refresh()` call to reflect changes.

---

## Phase 1: Update CompanyBrandSelector Component

### Subtask 1.1: Remove "All Brands" Menu Item
**File**: `/home/pbrown/SkuInventory/src/components/features/CompanyBrandSelector.tsx`
**Pattern**: Existing dropdown structure
**Instructions**:

1. Remove the "All Brands" DropdownMenuItem (lines 203-213):
   ```tsx
   // DELETE THIS BLOCK:
   <DropdownMenuItem
     className="cursor-pointer"
     onClick={() => handleBrandSelect(company.id, null, null)}
   >
     <Tag className="mr-2 h-4 w-4" />
     <span className="flex-1">All Brands</span>
     {company.id === session.user.selectedCompanyId &&
      session.user.selectedBrandId === null && (
       <Check className="ml-2 h-4 w-4 shrink-0" />
     )}
   </DropdownMenuItem>
   ```

2. Update the `currentDisplay` variable (line 166-168) to always show brand name:
   ```tsx
   // BEFORE:
   const currentDisplay = session.user.selectedBrandName
     ? `${session.user.selectedCompanyName} / ${session.user.selectedBrandName}`
     : `${session.user.selectedCompanyName} / All Brands`

   // AFTER:
   const currentDisplay = `${session.user.selectedCompanyName} / ${session.user.selectedBrandName || 'No Brand'}`
   ```

3. Remove the "All Brands" logic from `handleBrandSelect` function (lines 103-130):
   - Remove the `else if (brandId === null ...)` block that handles switching to "All Brands"
   - Remove the toast message that mentions "All Brands"

4. Add `router.refresh()` after successful company/brand switch to update server-rendered pages:
   - Import `useRouter` from `next/navigation`
   - After `updateSession()` succeeds, call `router.refresh()`

**Validation**:
```bash
npx tsc --noEmit
npm run lint
```

**Completion Criteria**:
- [ ] "All Brands" menu item removed from dropdown
- [ ] Display always shows brand name (no "All Brands" fallback)
- [ ] Handler no longer accepts null brandId
- [ ] `router.refresh()` called after switch
- [ ] TypeScript compiles without errors

### Subtask 1.2: Update handleBrandSelect Logic
**File**: `/home/pbrown/SkuInventory/src/components/features/CompanyBrandSelector.tsx`
**Instructions**:

1. Simplify the `handleBrandSelect` function signature - brandId is now always a string:
   ```tsx
   // BEFORE:
   const handleBrandSelect = async (companyId: string, brandId: string | null, _brandName: string | null) => {

   // AFTER:
   const handleBrandSelect = async (companyId: string, brandId: string, brandName: string) => {
   ```

2. Remove all conditional logic that handles `brandId === null`

3. Simplify toast messages to always show the brand name

4. After successful switch, call `router.refresh()` to update server-rendered pages

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Function only accepts non-null brandId
- [ ] All null checks removed
- [ ] Toast messages simplified
- [ ] `router.refresh()` integrated

---

## Phase 2: Update Auth Session Logic

### Subtask 2.1: Ensure First Brand Auto-Selected at Login
**File**: `/home/pbrown/SkuInventory/src/lib/auth.ts`
**Pattern**: Existing auth callback structure
**Instructions**:

1. In the `authorize` function, verify that `selectedBrandId` is ALWAYS set to first brand (line 139):
   ```tsx
   // This should already be:
   selectedBrandId: brands[0]?.id ?? null,

   // Keep as-is, but verify brands array is never empty for companies with brands
   ```

2. In the JWT callback `trigger === 'update'` handling (lines 190-200), ensure brand switching always requires a valid brand:
   - The existing code allows `null` - need to verify this doesn't cause issues

3. Consider: If a company has zero brands, what should happen?
   - Currently returns `null` - this is acceptable edge case
   - UI should not break if brand is null

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] First brand is auto-selected at login
- [ ] Session callbacks handle brand switch correctly
- [ ] Edge case of company with no brands handled gracefully

### Subtask 2.2: Update Company Switch API
**File**: `/home/pbrown/SkuInventory/src/app/api/companies/switch/route.ts`
**Instructions**:

1. Verify the company switch endpoint already auto-selects first brand (lines 60-72):
   ```tsx
   // This is already correct:
   const selectedBrandId = brands[0]?.id ?? null
   const selectedBrandName = brands[0]?.name ?? null
   ```

2. No changes needed - this already auto-selects first brand

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Verified first brand is auto-selected on company switch
- [ ] No code changes needed in this file

### Subtask 2.3: Update Brand Switch API (Optional)
**File**: `/home/pbrown/SkuInventory/src/app/api/brands/switch/route.ts`
**Instructions**:

1. **Decision**: Keep or remove `brandId: null` support?
   - **Recommendation**: Keep for backward compatibility but log warning
   - The UI will no longer send null, but API should handle gracefully

2. If keeping null support, add warning log:
   ```tsx
   if (brandId === null) {
     console.warn('Deprecated: null brandId in brand switch - All Brands mode being phased out')
   }
   ```

3. Alternative: Return 400 error for null brandId:
   ```tsx
   if (brandId === null) {
     return forbidden('All Brands mode is no longer supported. Please select a specific brand.')
   }
   ```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Decided on null handling approach
- [ ] Implemented chosen approach
- [ ] TypeScript compiles

---

## Phase 3: Real-Time Update Enhancement

### Subtask 3.1: Add Router Refresh to CompanyBrandSelector
**File**: `/home/pbrown/SkuInventory/src/components/features/CompanyBrandSelector.tsx`
**Instructions**:

1. Add import for `useRouter`:
   ```tsx
   import { useRouter } from 'next/navigation'
   ```

2. Initialize router in component:
   ```tsx
   const router = useRouter()
   ```

3. After successful session update in `handleBrandSelect`, call refresh:
   ```tsx
   // After updateSession succeeds:
   router.refresh()
   ```

4. This ensures server-rendered pages (Components, SKUs, Lots) get fresh data

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Router imported and initialized
- [ ] `router.refresh()` called after successful switch
- [ ] Build completes without errors

### Subtask 3.2: Verify Client-Side Pages React to Session Changes
**Files to verify** (no changes expected):
- `/home/pbrown/SkuInventory/src/app/(dashboard)/page.tsx` - Dashboard
- `/home/pbrown/SkuInventory/src/app/(dashboard)/orders/page.tsx` - Orders
- `/home/pbrown/SkuInventory/src/app/(dashboard)/transactions/page.tsx` - Transactions
- `/home/pbrown/SkuInventory/src/app/(dashboard)/forecasts/page.tsx` - Forecasts

**Instructions**:
1. Verify each page has `session?.user?.selectedCompanyId` and/or `session?.user?.selectedBrandId` in useEffect dependencies
2. These pages should already auto-refresh when session changes
3. No code changes needed - just verification

**Completion Criteria**:
- [ ] Dashboard verified (line 119)
- [ ] Orders verified (line 70)
- [ ] Transactions verified (line 129)
- [ ] Forecasts verified (lines 58, 112)

---

## Phase 4: Testing and Validation

### Subtask 4.1: Manual Testing Checklist
**Instructions**:

1. Login as user with multiple companies/brands
2. Verify dropdown does NOT show "All Brands" option
3. Select different brand within same company
   - Verify toast shows brand name
   - Verify page data updates
4. Select brand from different company
   - Verify company AND brand switch
   - Verify page data updates for new company
5. Navigate to server-rendered page (Components)
   - Switch brand
   - Verify page refreshes with new data
6. Create new company, assign user, refresh
   - Verify new company appears in dropdown

**Completion Criteria**:
- [ ] All manual tests pass
- [ ] No console errors
- [ ] Real-time updates working

### Subtask 4.2: Build Verification
**Instructions**:
```bash
npx tsc --noEmit
npm run lint
npm run build
```

**Completion Criteria**:
- [ ] TypeScript compiles without errors
- [ ] Lint passes
- [ ] Build completes successfully

---

## Summary of Deliverables

**Files Modified**:
1. `src/components/features/CompanyBrandSelector.tsx` - Main changes
2. `src/lib/auth.ts` - Verification only (no changes expected)
3. `src/app/api/brands/switch/route.ts` - Optional: deprecation warning

**Lines of Code Changed**: ~50 lines removed, ~10 lines added

**Breaking Changes**: None - backward compatible

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 -> Phase 2 -> Phase 3 -> Phase 4)
2. Complete each subtask fully before moving to next
3. Test completion criteria before next subtask
4. Run TypeScript check after each phase
5. Run full build after Phase 3

## Test Strategy Note

- Use manual testing for this UI change
- Verify in browser with multiple company/brand scenarios
- No unit tests required for this UI refactoring

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 25m |
| Validation | 10m |
| Planning | 15m |
| **Total** | **50m** |

---

## Appendix: Code Snippets

### Current CompanyBrandSelector Structure (to be modified)

```tsx
// Lines 202-228 - Current submenu with "All Brands" option
<DropdownMenuSubContent className="min-w-[180px]">
  {/* REMOVE THIS "All Brands" ITEM */}
  <DropdownMenuItem
    className="cursor-pointer"
    onClick={() => handleBrandSelect(company.id, null, null)}
  >
    <Tag className="mr-2 h-4 w-4" />
    <span className="flex-1">All Brands</span>
    {company.id === session.user.selectedCompanyId &&
     session.user.selectedBrandId === null && (
      <Check className="ml-2 h-4 w-4 shrink-0" />
    )}
  </DropdownMenuItem>
  {/* KEEP individual brand items */}
  {company.brands.map((brand) => (
    <DropdownMenuItem
      key={brand.id}
      className="cursor-pointer"
      onClick={() => handleBrandSelect(company.id, brand.id, brand.name)}
    >
      <Tag className="mr-2 h-4 w-4" />
      <span className="flex-1 truncate">{brand.name}</span>
      {brand.id === session.user.selectedBrandId && (
        <Check className="ml-2 h-4 w-4 shrink-0" />
      )}
    </DropdownMenuItem>
  ))}
</DropdownMenuSubContent>
```

### Expected Final Structure

```tsx
<DropdownMenuSubContent className="min-w-[180px]">
  {/* Only individual brands - no "All Brands" option */}
  {company.brands.map((brand) => (
    <DropdownMenuItem
      key={brand.id}
      className="cursor-pointer"
      onClick={() => handleBrandSelect(company.id, brand.id, brand.name)}
    >
      <Tag className="mr-2 h-4 w-4" />
      <span className="flex-1 truncate">{brand.name}</span>
      {brand.id === session.user.selectedBrandId && (
        <Check className="ml-2 h-4 w-4 shrink-0" />
      )}
    </DropdownMenuItem>
  ))}
</DropdownMenuSubContent>
```
