# Scout Report: Add recent transactions section to SKU detail

## Request Analysis
**Type**: Enhancement
**Source**: GitHub Issue #22
**Priority**: Medium

## Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: None (small scoped feature)

## Issue Validation
**Status**: Valid - Feature is outlined in PRD (6.4/6.8) but not yet implemented
**Recent Changes**:
- 7916e5e - Recent fix to client page params and edit pages
- 8eea67e - Build/shipment transactions feature completed (Phase 7)
- SKU detail page last modified Dec 2, 2025 as part of params fix

**Verification**: Component detail page (/home/pbrown/SkuInventory/src/app/(dashboard)/components/[id]/page.tsx lines 302-344) already has this exact feature implemented - confirmed pattern exists.

## Current State

### Existing Components
- SKU detail page: /home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/page.tsx - Currently displays SKU details and BOM versions, but NO recent transactions section
- Component detail page: /home/pbrown/SkuInventory/src/app/(dashboard)/components/[id]/page.tsx - HAS recent transactions section (lines 302-344) - PRIMARY PATTERN TO FOLLOW
- Transactions list page: /home/pbrown/SkuInventory/src/app/(dashboard)/transactions/page.tsx - Already supports filtering by skuId (line 52, 82)

### Database
- Transaction model: Prisma schema lines 128-154 - Has skuId field (line 134)
- TransactionLine model: Prisma schema lines 156-166 - Links transactions to components
- Relationship: SKU.transactions (line 190 in schema) - ONE-TO-MANY relationship already exists

### API Routes
- GET /api/components/[id]: /home/pbrown/SkuInventory/src/app/api/components/[id]/route.ts (lines 49-62) - FETCHES recent transactions for components via transactionLines relation
- GET /api/skus/[id]: /home/pbrown/SkuInventory/src/app/api/skus/[id]/route.ts - DOES NOT currently include recent transactions
- GET /api/transactions: /home/pbrown/SkuInventory/src/app/api/transactions/route.ts - Supports skuId filter (line 28)

### Types
- ComponentDetailResponse: /home/pbrown/SkuInventory/src/types/component.ts (lines 78-84) - Includes recentTransactions array
- SKUDetailResponse: /home/pbrown/SkuInventory/src/types/sku.ts (lines 63-65) - DOES NOT include recentTransactions
- TransactionResponse: /home/pbrown/SkuInventory/src/types/transaction.ts (lines 72-88) - Full transaction type with lines

## Dependencies & Blockers

### Prerequisites
- Tenant scoping: Already implemented in transaction queries (line 26 in /home/pbrown/SkuInventory/src/app/api/transactions/route.ts)
- Transaction data: Build/shipment transactions completed in Phase 7
- Authentication: Already handled by getServerSession in all API routes

### Libraries/Tools
- All required libraries already installed:
  - Prisma ORM (for database queries)
  - Next.js 14 App Router (API routes)
  - shadcn/ui Table component (already used in component detail)
  - lucide-react (icons)

**Can Proceed?**: YES - No blockers identified

## Complexity Assessment
**Complexity**: Simple
**Effort**: 2-3 hours
**Risk**: Low

**Reasoning**:
- Direct 1:1 pattern match with component detail page (lines 302-344)
- Database relationship already exists (SKU.transactions)
- No new database models or migrations needed
- Straightforward API modification following existing pattern
- UI component can be copied almost exactly from component detail

## Patterns to Follow

### Primary Pattern: Component Detail Recent Transactions
**File**: /home/pbrown/SkuInventory/src/app/api/components/[id]/route.ts (lines 49-62)

**Database Query Pattern**:
```typescript
// Include recent transactions in Prisma query
transactionLines: {
  take: 10,
  orderBy: { transaction: { createdAt: 'desc' } },
  include: {
    transaction: {
      select: {
        id: true,
        type: true,
        date: true,
        createdAt: true,
      },
    },
  },
},
```

**Response Transform** (lines 120-126):
```typescript
recentTransactions: component.transactionLines.map((line) => ({
  id: line.transaction.id,
  type: line.transaction.type,
  date: line.transaction.date.toISOString(),
  quantityChange: line.quantityChange.toString(),
  createdAt: line.transaction.createdAt.toISOString(),
}))
```

**UI Pattern**: /home/pbrown/SkuInventory/src/app/(dashboard)/components/[id]/page.tsx (lines 302-344)
- Card wrapper with title "Recent Transactions"
- CardDescription: "Last 10 inventory changes for this component"
- Table with columns: Date, Type, Quantity Change
- Color coding: green for positive, red for negative changes
- Link to "View All Transactions" with filter

### Secondary Pattern: Transaction List Filtering
**File**: /home/pbrown/SkuInventory/src/app/(dashboard)/transactions/page.tsx (line 336)
- Link format: `/transactions?componentId=${component.id}`
- For SKU: should be `/transactions?skuId=${sku.id}`

## Files to Create/Modify

### 1. Type Definition (MODIFY)
**File**: /home/pbrown/SkuInventory/src/types/sku.ts
**Purpose**: Add recentTransactions to SKUDetailResponse interface (lines 63-65)
**Change**: Add array property matching ComponentDetailResponse pattern

### 2. API Route (MODIFY)
**File**: /home/pbrown/SkuInventory/src/app/api/skus/[id]/route.ts
**Purpose**: Fetch and include recent transactions in GET handler (lines 19-94)
**Change**:
- Add transactions include in Prisma query (after line 40)
- Transform and add to response (after line 78)
**Note**: SKU has direct transactions relation, simpler than Component which uses transactionLines

### 3. SKU Detail Page (MODIFY)
**File**: /home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/page.tsx
**Purpose**: Display recent transactions section
**Change**: Add Card section similar to component detail (after line 210, before Build Dialog)
**Pattern**: Copy from component detail lines 302-344, adapt for SKU context

## Final Sweep Results

### Comprehensive Search Results

**Services Search**: 0 files found in src/services/
- No service layer functions affected by this change

**API Routes**: 1 usage in src/app/api/
- /home/pbrown/SkuInventory/src/app/api/skus/[id]/route.ts - MUST MODIFY

**Type Definitions**: 1 type affected
- /home/pbrown/SkuInventory/src/types/sku.ts - SKUDetailResponse MUST MODIFY

**Components**: 5 components using SKU detail API:
- /home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/page.tsx - MUST MODIFY (primary target)
- /home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/edit/page.tsx - NO CHANGE (does not use recentTransactions)
- /home/pbrown/SkuInventory/src/components/features/BOMVersionForm.tsx - NO CHANGE (does not use recentTransactions)
- /home/pbrown/SkuInventory/src/components/features/SKUForm.tsx - NO CHANGE (does not use recentTransactions)
- /home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/bom/new/page.tsx - NO CHANGE (does not use recentTransactions)

**Test Files**: 0 test files currently reference SKU detail
- No existing tests need updating

### All Affected Files (comprehensive list):
1. /home/pbrown/SkuInventory/src/types/sku.ts - Add recentTransactions to SKUDetailResponse interface
2. /home/pbrown/SkuInventory/src/app/api/skus/[id]/route.ts - Include transactions in query, add to response
3. /home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/page.tsx - Display recent transactions section

**TOTAL FILES AFFECTED**: 3 files

## Ripple Effect Analysis

### Function: GET /api/skus/[id] (route.ts lines 20-94)

**Direct Callers**: 5 files identified
1. /home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/page.tsx - Line 35 - WILL USE new field
2. /home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/edit/page.tsx - Does NOT use recentTransactions
3. /home/pbrown/SkuInventory/src/components/features/BOMVersionForm.tsx - Does NOT use recentTransactions
4. /home/pbrown/SkuInventory/src/components/features/SKUForm.tsx - Does NOT use recentTransactions
5. /home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/bom/new/page.tsx - Does NOT use recentTransactions

**Indirect Callers**: None (no wrapper functions)

**TOTAL FILES AFFECTED BY API CHANGE**: 1 file will actively use the new field
**BACKWARD COMPATIBILITY**: YES - Adding optional field to response object, existing consumers unaffected

### Type: SKUDetailResponse (sku.ts lines 63-65)

**Direct Usage**: 1 file
- /home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/page.tsx - Line 22 - MUST update to use new field

**Indirect Usage**: None

**TOTAL FILES AFFECTED BY TYPE CHANGE**: 1 file

## Acceptance Criteria

- [ ] SKU detail page (/skus/[id]) displays "Recent Transactions" card section
- [ ] Card shows last 10 transactions for that SKU (build transactions primarily)
- [ ] Table displays: Date, Type (badge), and Quantity Change (for build: units built)
- [ ] Data respects tenant scoping (companyId filter already in place)
- [ ] "View All Transactions" link navigates to /transactions?skuId={id}
- [ ] Transaction data matches format from transactions API
- [ ] No TypeScript errors or warnings
- [ ] Build completes successfully (npm run build)
- [ ] Tests cover fetching and rendering (if test infrastructure exists)

## Handoff to Plan Agent

### Summary
Add a "Recent Transactions" section to the SKU detail page to show the last 10 build/shipment transactions for the SKU. This feature mirrors the existing implementation on the component detail page (lines 302-344) and requires minimal changes: extending the SKUDetailResponse type to include recentTransactions, modifying the GET /api/skus/[id] endpoint to fetch transactions via the existing SKU.transactions Prisma relation, and adding a Card component to display the transactions table. The database relationship already exists, and this is a straightforward additive enhancement with no breaking changes.

### Key Points
1. **Exact Pattern Match**: Component detail page already implements this feature (lines 302-344) - copy and adapt
2. **Simple Database Query**: SKU has direct `transactions` relation (simpler than Component which uses transactionLines)
3. **3 Files to Modify**: Type definition, API route, and UI page
4. **No Breaking Changes**: Adding optional field to response - backward compatible
5. **Low Risk**: Well-established pattern, no new dependencies, no migrations needed
6. **PRD Requirement**: Feature specified in PRD 6.4/6.8, completing missing functionality

### Suggested Phases
**Phase 1: Backend (Types + API)**
1. Update SKUDetailResponse type to include recentTransactions array
2. Modify GET /api/skus/[id] to include transactions in Prisma query
3. Transform and add transactions to response
4. Verify API response with curl/browser

**Phase 2: Frontend (UI)**
1. Add Recent Transactions Card section to SKU detail page
2. Copy table structure from component detail
3. Adapt for SKU context (focus on build transactions, show unitsBuild)
4. Add "View All Transactions" link with skuId filter

**Phase 3: Verification**
1. Run build (npm run build)
2. Test with real SKU that has transaction history
3. Verify tenant scoping works correctly
4. Test "View All Transactions" link navigates correctly

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Issue Parsing | 2m |
| Codebase Exploration | 8m |
| Pattern Identification | 5m |
| Final Sweep & Ripple Analysis | 6m |
| Report Writing | 9m |
| **Total** | **30m** |
