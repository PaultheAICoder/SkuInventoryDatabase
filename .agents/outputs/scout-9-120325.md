# Scout Report: Multi-location inventory and finished goods tracking

## Request Analysis
**Type**: New Feature (Enhancement)
**Source**: GitHub Issue #9
**Priority**: Medium (V2 roadmap feature)

## Task Classification
**Category**: NEW_FEATURE (major architectural change)
**Test Strategy**: FULL (requires complete suite - architectural changes affecting transactions, inventory queries, and business logic)
**Suggested Filter**: None (full test suite recommended due to scope)

## Issue Validation
**Status**: Valid - Feature clearly defined, prerequisites met
**Recent Changes**: No overlapping closed issues found. Recent work on defect tracking (#15), initial inventory import (#8), and auth/tenant scoping completed. Schema stable since last major feature additions.

**Prerequisite Status**:
- Tenant scoping (#2): COMPLETED (verified in schema, all transactions scoped to companyId)
- Single-location architecture: CONFIRMED (no location dimension exists)

## Current State

### Database Schema (prisma/schema.prisma)
**Current Single-Location Architecture:**
- **Transaction model** (lines 128-157): NO location field
  - Scoped to `companyId` only
  - Types: receipt, build, adjustment, initial
  - Related to SKU and BOMVersion but NOT location

- **TransactionLine model** (lines 159-169): NO location field
  - Links to Transaction and Component
  - Contains quantityChange (can be positive or negative)
  - NO from/to location support

- **Component model** (lines 93-119): NO location tracking
  - Belongs to Brand
  - Has basic inventory metadata (reorderPoint, leadTimeDays, costPerUnit)

- **SKU model** (lines 175-197): NO finished goods inventory tracking
  - Only BOM definitions exist
  - NO on-hand finished goods quantity

**Tables Needed:**
- NEW: `Location` - Define warehouses, 3PL, FBA, finished goods areas
- NEW: `InventoryBalance` (optional) - Denormalized per-location balances for performance
- NEW: `Transfer` OR extend Transaction - Track inter-location transfers

**Relationships Needed:**
- Company -> Location (1:many)
- Location -> Transaction (1:many) - where inventory changes occur
- Location -> InventoryBalance (1:many) - if using denormalized approach

### Services Layer (src/services/inventory.ts)

**Key Functions - ALL Single-Location:**

1. **getComponentQuantity** (lines 30-36):
   - Aggregates ALL TransactionLines for a component
   - NO location filtering
   - Returns single global quantity

2. **getComponentQuantities** (lines 41-63):
   - Batch version of above
   - Groups by componentId ONLY (not location)
   - Returns Map<componentId, quantity>
   - **MUST CHANGE TO**: Map<componentId, Map<locationId, quantity>>

3. **Transaction Creation Functions** (lines 91-305):
   - `createReceiptTransaction` - NO location parameter
   - `createAdjustmentTransaction` - NO location parameter
   - `createInitialTransaction` - NO location parameter
   - `createBuildTransaction` (lines 418-548):
     - Consumes components from global pool
     - NO finished goods output to location
     - NO location-aware inventory check

4. **checkInsufficientInventory** (lines 338-385):
   - Checks global inventory only
   - **MUST CHANGE TO**: Check specific location inventory

### API Routes (src/app/api/transactions/*)

**Current Pattern (ALL single-location):**
- `/api/transactions/receipt/route.ts` - NO location field
- `/api/transactions/adjustment/route.ts` - NO location field
- `/api/transactions/build/route.ts` - NO location field
- `/api/transactions/initial/route.ts` - NO location field
- `/api/transactions/route.ts` - Lists all transactions, NO location filter

**Pattern to Follow:**
- Validate user's company owns the component/SKU
- Use service layer functions for business logic
- Use Prisma transactions for atomic operations
- Return standardized API responses (created, success, error)

### Components & Dashboard (Frontend)

**Files Using Inventory Quantities (35 files found):**
- `src/app/api/components/route.ts` - Lists components with `quantityOnHand` (global)
- `src/app/api/components/[id]/route.ts` - Component detail with global quantity
- `src/app/api/dashboard/route.ts` - Dashboard stats (global quantities)
- `src/components/features/ComponentTable.tsx` - Displays global quantities
- `src/components/features/CriticalComponentsList.tsx` - Uses global reorder logic
- `src/app/(dashboard)/components/page.tsx` - Component list page

**ALL display single global quantity - will need per-location breakdown**

## Dependencies & Blockers

### Prerequisites (SATISFIED)
1. Tenant scoping (#2): COMPLETED
   - All transactions already scoped to companyId
   - Auth enforces company boundaries
   - Safe to add location dimension within company

### New Dependencies Required
1. **Default Location Migration**:
   - Existing transactions need a default locationId
   - Suggest: Auto-create "Main Warehouse" location per company
   - Backfill all existing transactions to default location

2. **Finished Goods Tracking**:
   - Requires new concept: SKU inventory (separate from components)
   - Need SKU-level TransactionLines (currently only Component lines exist)
   - OR: Separate FinishedGoodsInventory table

3. **Transfer Transaction Type**:
   - New transaction type: `transfer`
   - Needs both `fromLocationId` and `toLocationId`
   - Must be atomic (deduct from source, add to destination)

**Can Proceed?**: YES (with proper phasing)

**Blockers**: NONE (all prerequisites met)

## Complexity Assessment
**Complexity**: COMPLEX
**Effort**: 40-60 hours (requires multiple phases)
**Risk**: MEDIUM-HIGH
- Significant schema changes
- ALL inventory queries need location dimension
- Backward compatibility required for existing data
- Performance implications (queries become more complex)

## Patterns to Follow

### Primary Pattern: Transaction Services
**File**: `/home/pbrown/SkuInventory/src/services/inventory.ts`
**Use for**:
- Transaction creation with Prisma transactions
- Inventory validation logic
- Cost calculations and snapshots

**Pattern**:
```typescript
return prisma.$transaction(async (tx) => {
  // 1. Validate entities exist
  // 2. Create transaction with lines
  // 3. Update related entities if needed
  // 4. Return with includes
})
```

### Secondary Pattern: API Routes
**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/receipt/route.ts`
**Use for**:
- Session validation
- Role-based authorization
- Input validation with zod schemas
- Tenant scoping (verify entity belongs to user's company)
- Service layer calls
- Response formatting

### Tertiary Pattern: BOM Services
**File**: `/home/pbrown/SkuInventory/src/services/bom.ts`
**Use for**:
- Batch quantity calculations
- calculateMaxBuildableUnitsForSKUs - shows how to handle location-aware calculations

## Files to Create

### Database
1. **Migration**: `prisma/migrations/YYYYMMDD_add_locations.sql`
   - Add Location table
   - Add locationId to Transaction
   - Add fromLocationId, toLocationId to Transaction (for transfers)
   - Add default location and backfill existing data
   - Add TransactionLine SKU support (for finished goods)

### Backend Services
2. **Location Service**: `src/services/location.ts`
   - CRUD operations for locations
   - Default location logic
   - Active location validation

3. **Transfer Service**: `src/services/transfer.ts`
   - createTransfer (atomic from/to)
   - Transfer validation
   - Inter-location inventory checks

### API Routes
4. **Location Routes**:
   - `src/app/api/locations/route.ts` - List/Create locations
   - `src/app/api/locations/[id]/route.ts` - Update/Delete location

5. **Transfer Routes**:
   - `src/app/api/transactions/transfer/route.ts` - Create transfer

### Types
6. **Type Definitions**:
   - `src/types/location.ts` - Location schemas and responses
   - `src/types/transfer.ts` - Transfer transaction schemas

### Frontend Components
7. **Location Management**:
   - `src/components/features/LocationForm.tsx`
   - `src/components/features/LocationTable.tsx`
   - `src/app/(dashboard)/settings/locations/page.tsx`

8. **Inventory Views**:
   - `src/components/features/InventoryByLocationTable.tsx`
   - Update ComponentTable to show per-location breakdown

9. **Transfer UI**:
   - `src/components/features/TransferForm.tsx`

## Files to Modify (Comprehensive List)

### Database Schema
1. `/home/pbrown/SkuInventory/prisma/schema.prisma`
   - Add Location model
   - Add Transaction.locationId (required)
   - Add Transaction.fromLocationId, toLocationId (for transfers)
   - Add transfer to TransactionType enum
   - Add TransactionLine.skuId (for finished goods output)

### Services Layer (ALL inventory calculations)
2. `/home/pbrown/SkuInventory/src/services/inventory.ts`
   - **getComponentQuantity**: Add locationId parameter (optional)
   - **getComponentQuantities**: Change signature to support location filtering
     - CURRENT: `(componentIds: string[]) => Map<string, number>`
     - NEW: `(componentIds: string[], locationId?: string) => Map<string, number>`
     - OR: Return nested map: `Map<string, Map<string, number>>` (componentId -> locationId -> quantity)
   - **createReceiptTransaction**: Add locationId parameter (required)
   - **createAdjustmentTransaction**: Add locationId parameter (required)
   - **createInitialTransaction**: Add locationId parameter (required)
   - **createBuildTransaction**: Add consumptionLocationId and outputLocationId parameters
   - **checkInsufficientInventory**: Add locationId parameter for location-specific checks

3. `/home/pbrown/SkuInventory/src/services/bom.ts`
   - **calculateMaxBuildableUnits**: Add locationId parameter
   - **calculateMaxBuildableUnitsForSKUs**: Add locationId parameter
   - Update to use location-aware getComponentQuantities

### API Routes - Transactions (7 files)
4. `/home/pbrown/SkuInventory/src/app/api/transactions/receipt/route.ts`
   - Add locationId to request schema
   - Pass to service layer

5. `/home/pbrown/SkuInventory/src/app/api/transactions/adjustment/route.ts`
   - Add locationId to request schema
   - Pass to service layer

6. `/home/pbrown/SkuInventory/src/app/api/transactions/build/route.ts`
   - Add consumptionLocationId to request schema
   - Add outputLocationId for finished goods (optional)
   - Update insufficient inventory check to be location-aware

7. `/home/pbrown/SkuInventory/src/app/api/transactions/initial/route.ts`
   - Add locationId to request schema
   - Pass to service layer

8. `/home/pbrown/SkuInventory/src/app/api/transactions/route.ts`
   - Add locationId query parameter for filtering
   - Include location in response

9. `/home/pbrown/SkuInventory/src/app/api/transactions/[id]/route.ts`
   - Include location in detail response

### API Routes - Components (3 files)
10. `/home/pbrown/SkuInventory/src/app/api/components/route.ts`
    - Return per-location breakdown OR location filter
    - Update to use location-aware quantities

11. `/home/pbrown/SkuInventory/src/app/api/components/[id]/route.ts`
    - Show per-location breakdown in detail view
    - Update constrained SKUs calculation to be location-aware

12. `/home/pbrown/SkuInventory/src/app/api/export/components/route.ts`
    - Export with location column(s)

### API Routes - BOM/SKU (4 files)
13. `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/route.ts`
    - Update buildable units calculation (location-aware)

14. `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/activate/route.ts`
    - No direct changes, but verify buildable units logic

15. `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/clone/route.ts`
    - No direct changes, but verify buildable units logic

16. `/home/pbrown/SkuInventory/src/app/api/skus/[id]/bom-versions/route.ts`
    - Update buildable units calculation (location-aware)

### API Routes - Dashboard
17. `/home/pbrown/SkuInventory/src/app/api/dashboard/route.ts`
    - Update component stats (location filter or aggregate)
    - Update critical components (location-aware)
    - Update buildable SKUs (location-aware)

### Types (3 files)
18. `/home/pbrown/SkuInventory/src/types/component.ts`
    - Add locationQuantities to ComponentResponse
    - Add location filter to ComponentListQuery

19. `/home/pbrown/SkuInventory/src/types/transaction.ts`
    - Add locationId to all transaction schemas
    - Add fromLocationId, toLocationId for transfers
    - Add transfer type to TransactionResponse

20. `/home/pbrown/SkuInventory/src/types/bom.ts`
    - Add location parameters where buildable units calculated

### Frontend Components (4 files)
21. `/home/pbrown/SkuInventory/src/components/features/ComponentTable.tsx`
    - Display per-location quantities OR location filter

22. `/home/pbrown/SkuInventory/src/components/features/CriticalComponentsList.tsx`
    - Location-aware critical component logic

23. `/home/pbrown/SkuInventory/src/components/features/TransactionDetail.tsx`
    - Display location information

24. `/home/pbrown/SkuInventory/src/components/features/BOMVersionList.tsx`
    - Location-aware buildable units

### Frontend Pages (2 files)
25. `/home/pbrown/SkuInventory/src/app/(dashboard)/components/page.tsx`
    - Location filter/breakdown

26. `/home/pbrown/SkuInventory/src/app/(dashboard)/page.tsx`
    - Dashboard with location awareness

### Export/Import (2 files)
27. `/home/pbrown/SkuInventory/src/services/export.ts`
    - Export with location data

28. `/home/pbrown/SkuInventory/src/app/api/import/initial-inventory/route.ts`
    - Support location in import

### Tests (2+ files)
29. `/home/pbrown/SkuInventory/tests/unit/inventory-quantity.test.ts`
    - Update to test location-aware quantities

30. `/home/pbrown/SkuInventory/tests/integration/transactions.test.ts`
    - Add location to all transaction tests

## Final Sweep Results

**Services Search**: 2 files in src/services/
- `inventory.ts` - ALL core functions need location parameter
- `bom.ts` - Uses getComponentQuantities, needs location support

**API Routes**: 17 route files affected
- 6 transaction routes (receipt, adjustment, build, initial, list, detail)
- 3 component routes (list, detail, export)
- 4 BOM/SKU routes
- 1 dashboard route
- 3 export/import routes

**Type Definitions**: 3 type files
- `component.ts` - Response and query types
- `transaction.ts` - All transaction schemas
- `bom.ts` - Buildable units calculations

**Components**: 6 component files
- ComponentTable, CriticalComponentsList, TransactionDetail, BOMVersionList
- 2 page components (dashboard, components page)

**Test Files**: 2 core test files (more will need updates)
- Unit tests for inventory quantities
- Integration tests for transactions

**TOTAL FILES AFFECTED**: ~30 existing files + ~9 new files = **39 files**

## Ripple Effect Analysis

### Critical Function: getComponentQuantities

**Current Signature**:
```typescript
getComponentQuantities(componentIds: string[]): Promise<Map<string, number>>
```

**New Signature (Option A - Location Filter)**:
```typescript
getComponentQuantities(componentIds: string[], locationId?: string): Promise<Map<string, number>>
```

**New Signature (Option B - All Locations)**:
```typescript
getComponentQuantities(componentIds: string[], options?: {
  locationId?: string,
  includeAllLocations?: boolean
}): Promise<Map<string, Map<string, number>>>
```

**Direct Callers** (17 files):
1. `src/services/bom.ts` (2 usages)
   - calculateMaxBuildableUnits (line 84)
   - calculateMaxBuildableUnitsForSKUs (line 137)
2. `src/app/api/components/route.ts` (2 usages)
   - GET handler with reorderStatus filter (line 79)
   - GET handler regular (line 130)
3. `src/app/api/components/[id]/route.ts` (1 usage)
   - GET handler for detail (NOT DIRECTLY - uses getComponentQuantity)
4. `src/app/api/dashboard/route.ts` (1 usage)
   - GET handler for stats (line 86)
5. `src/app/api/export/components/route.ts` (usage expected)
6. `src/app/api/bom-versions/[id]/route.ts` (usage via bom service)
7. `src/app/api/skus/[id]/bom-versions/route.ts` (usage via bom service)
8. Frontend: `src/app/(dashboard)/components/page.tsx` (indirect via API)

**Indirect Callers** (via BOM service):
- All SKU detail pages
- All BOM version pages
- Build transaction validation

**TOTAL FILES REQUIRING UPDATES**: 30+ files

**Strategy**:
- Add optional locationId parameter (backward compatible initially)
- Update all callers to pass locationId or handle Map<Map<>> structure
- Phase 1: Make locationId optional with default location fallback
- Phase 2: Make locationId required after UI updates

## Acceptance Criteria

From Issue #9:
- [ ] Admin can create/edit/deactivate locations
- [ ] Receipts/adjustments/builds can be recorded against a chosen location
- [ ] Balances update per location and roll up correctly
- [ ] Transfers between locations adjust both sides atomically
- [ ] Transfers visible in history
- [ ] Finished goods from builds can be recorded into a finished-goods location
- [ ] Components/SKUs pages display per-location breakdown and totals
- [ ] AuthZ enforced (viewer cannot change stock/locations)
- [ ] Tests cover location-aware transactions and transfers

**Additional Technical Criteria**:
- [ ] Migration includes default location and backfill
- [ ] All existing API endpoints remain backward compatible initially
- [ ] Performance: location-aware queries use proper indexes
- [ ] Atomicity: transfers are truly atomic (both sides or neither)
- [ ] Zero downtime migration possible

## Handoff to Plan Agent

### Summary
This is a **major architectural feature** adding multi-location support to a currently single-location inventory system. The current system tracks all component inventory globally without location awareness. This feature requires:

1. **Database schema changes**: New Location table, location foreign keys on transactions, support for inter-location transfers
2. **Core service layer changes**: ALL inventory quantity functions must become location-aware
3. **Extensive API updates**: 30+ files need modifications to support location dimension
4. **UI overhaul**: All inventory displays need per-location breakdowns or filters
5. **Backward compatibility**: Existing data must migrate to a default location
6. **New functionality**: Location management, transfer transactions, finished goods tracking

The ripple effect is substantial - the core `getComponentQuantities` function is used in 17+ files, and its signature change propagates through the entire system.

### Key Points
1. **Prerequisite satisfied**: Tenant scoping (#2) is complete, making location dimension safe to add
2. **No schema conflicts**: Current schema has no location-related fields
3. **Clear patterns exist**: Transaction services and API routes follow consistent patterns
4. **Test infrastructure exists**: Unit and integration tests in place, need expansion
5. **Complexity justified**: Issue is marked as V2 roadmap feature, complexity matches expectations
6. **Phasing required**: Feature must be implemented in phases (locations first, then transfers, then finished goods)

### Suggested Phases

**Phase 1: Foundation (8-12 hours)**
- Add Location table and management
- Create default location migration
- Add locationId to Transaction (optional, defaults to default location)
- Update transaction creation endpoints to accept optional locationId
- Basic location management UI

**Phase 2: Location-Aware Inventory (12-16 hours)**
- Update getComponentQuantities to support location filtering
- Modify all inventory display APIs to show per-location breakdown
- Update component table UI with location filter/breakdown
- Update dashboard to be location-aware
- Add location column to exports

**Phase 3: Transfers (8-12 hours)**
- Add transfer transaction type
- Implement atomic transfer service
- Create transfer API endpoint
- Build transfer UI form
- Add transfer history view

**Phase 4: Finished Goods (12-16 hours)**
- Add SKU inventory tracking (separate from component inventory)
- Update build transactions to output finished goods to location
- Create finished goods inventory views
- Update buildable units calculations to consider finished goods
- Add finished goods exports

**Phase 5: Testing & Polish (4-8 hours)**
- Comprehensive test coverage for all location features
- Performance optimization (indexes, query patterns)
- Migration testing (backward compatibility)
- Documentation updates

**Total Estimated Effort**: 44-64 hours across 5 phases

## Performance Metrics

| Phase | Duration |
|-------|----------|
| Issue Parsing | 2m |
| Codebase Exploration | 12m |
| Schema Analysis | 8m |
| Service Layer Analysis | 10m |
| API Route Analysis | 15m |
| Ripple Effect Analysis | 18m |
| Pattern Identification | 8m |
| Report Writing | 22m |
| **Total** | **95m** |

**Files Read**: 15
**Files Searched**: 113 (total TypeScript files in project)
**Dependencies Identified**: 3 (default location, finished goods tracking, transfer atomicity)
**Affected Files**: 39 (30 existing + 9 new)
**Test Files**: 2 core files (plus integration tests to be updated)
