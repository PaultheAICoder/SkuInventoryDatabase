# Implementation Plan
**Generated**: 2025-12-09T21:45:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: Issue #238
**Estimated Build Time**: 2-3 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Enhancement (Phase 4 of multi-phase feedback system)
**Source**: GitHub Issue #238
**Priority**: Medium

### Task Classification
**Category**: REFACTORING (improving existing implementation with idempotency safeguards)
**Test Strategy**: TARGETED - Focus on feedback-service and email-monitor tests
**Suggested Filter**: `--filter="feedback"` or run all unit tests

### Issue Validation
**Status**: Valid - Issue describes improvements to already-implemented functionality
**Recent Changes**:
- `6405af9` feat(issue #237): integrate feedback service with webhook, API, and email monitor
- `659bf42` feat(issue #236): add feedback service with CRUD operations
- `f4e3be0` feat(issue #235): add CRON_SECRET and Feedback database migration

**Key Finding**: Phases 1-3 have been completed. The email monitor ALREADY uses database-backed state (Tasks 1 and 3 from Issue #238 are DONE). However, several idempotency and error handling improvements are still needed.

### Current State Assessment

**Already Implemented (from Phases 1-3):**
- Database-backed `lastCheckTime` via `EmailMonitorState` table
- `getLastCheckTime()` and `updateLastCheckTime()` in feedback service
- Feedback record creation on issue close via webhook
- Feedback status updates when email replies are processed
- `getResolvedFeedback()` function exists but is NOT used in email monitor

**Still Needed (Issue #238 gaps):**
- Idempotency: Check `responseEmailId` to skip already-processed emails
- Status filter: Skip feedback not in `resolved` status
- Error handling: Don't update `lastCheckTime` if ALL emails failed
- Better logging: Include reason for each skipped email
- Optional improvement: Use `getResolvedFeedback()` instead of querying GitHub first

### Dependencies & Blockers
None - all prerequisites from Phases 1-3 are in place.

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Low (targeted improvements to existing working code)
**Effort**: 2-3 hours
**Risk**: Low - adding safeguards to existing functionality

### Patterns Identified
**Primary**: Current email monitor implementation at `src/app/api/cron/email-monitor/route.ts`
**Secondary**: Feedback service at `src/services/feedback.ts`

### Ripple Effect Analysis
**Files Identified**: 2-3 files

| File | Change Type | Reason |
|------|-------------|--------|
| `src/app/api/cron/email-monitor/route.ts` | Modify | Add idempotency checks and error handling |
| `tests/unit/email-monitor.test.ts` | Create (optional) | Add unit tests for idempotency logic |
| `src/services/feedback.ts` | No change | Already has all needed functions |

---

## Executive Summary

This implementation adds idempotency safeguards to the email monitor endpoint to prevent duplicate processing and improve error handling. The core functionality (database-backed state, feedback status updates) was completed in Phases 1-3. This phase focuses on defensive programming: checking if emails were already processed, validating feedback status before updates, and only persisting `lastCheckTime` when processing succeeds.

---

## Phase 1: Add Idempotency Checks

### Subtask 1.1: Add responseEmailId duplicate check
**File**: `/home/pbrown/SkuInventory/src/app/api/cron/email-monitor/route.ts`
**Pattern**: Current feedback lookup pattern at lines 168-177
**Instructions**:
1. After fetching feedback by issue number (line 168), add check:
   ```typescript
   // Check if this email was already processed (idempotency)
   if (feedback.responseEmailId === email.id) {
     console.log(`[Email Monitor] Email ${email.id} already processed for issue #${issueNumber}, skipping`)
     continue
   }
   ```
2. Add this check BEFORE the action processing (before line 166)
**Validation**:
```bash
npx tsc --noEmit
npm run build
```
**Completion Criteria**:
- [ ] TypeScript compiles without errors
- [ ] Duplicate email check logs message and continues
- [ ] Check happens before any GitHub API calls or status updates

### Subtask 1.2: Add feedback status validation
**File**: `/home/pbrown/SkuInventory/src/app/api/cron/email-monitor/route.ts`
**Pattern**: Current feedback lookup
**Instructions**:
1. After fetching feedback by issue number, check status:
   ```typescript
   // Only process replies for feedback in 'resolved' status
   if (feedback.status !== 'resolved') {
     console.log(`[Email Monitor] Feedback for issue #${issueNumber} not in resolved status (${feedback.status}), skipping`)
     continue
   }
   ```
2. This check should happen after the duplicate check but before processing
**Validation**:
```bash
npx tsc --noEmit
```
**Completion Criteria**:
- [ ] Status check prevents processing of non-resolved feedback
- [ ] Appropriate log message includes current status

---

## Phase 2: Improve Error Handling

### Subtask 2.1: Only update lastCheckTime on successful processing
**File**: `/home/pbrown/SkuInventory/src/app/api/cron/email-monitor/route.ts`
**Current behavior**: `updateLastCheckTime(newCheckTime)` called at line 84 BEFORE processing emails
**New behavior**: Only update if at least one email processed successfully OR no errors
**Instructions**:
1. Move `const newCheckTime = new Date()` to line ~83 (keep it)
2. Remove the early `await updateLastCheckTime(newCheckTime)` at line 84
3. Add conditional update AFTER processing loop (around line 258):
   ```typescript
   // Only update lastCheckTime if processing was successful
   // This prevents losing emails if all processing fails
   if (results.errors.length === 0 || results.processed > 0) {
     await updateLastCheckTime(newCheckTime)
   } else {
     console.warn('[Email Monitor] All emails failed to process, not updating lastCheckTime')
   }
   ```
4. Update the response to indicate whether lastCheckTime was updated
**Validation**:
```bash
npx tsc --noEmit
npm run build
```
**Completion Criteria**:
- [ ] lastCheckTime not updated when all emails fail
- [ ] lastCheckTime updated when at least one succeeds
- [ ] lastCheckTime updated when there are no errors
- [ ] Warning logged when lastCheckTime not updated

### Subtask 2.2: Add skipped counter to results
**File**: `/home/pbrown/SkuInventory/src/app/api/cron/email-monitor/route.ts`
**Instructions**:
1. Add `skipped: 0` to results object initialization (line ~86):
   ```typescript
   const results = {
     processed: 0,
     verified: 0,
     changesRequested: 0,
     skipped: 0,
     errors: [] as string[],
   }
   ```
2. Increment `results.skipped++` for each continue statement with a skip reason
3. Add skipped reasons array for detailed logging:
   ```typescript
   skippedReasons: [] as string[],
   ```
4. Log skip reason to array when continuing
**Validation**:
```bash
npx tsc --noEmit
```
**Completion Criteria**:
- [ ] Response includes skipped count
- [ ] Each skip reason is tracked

---

## Phase 3: Refactor to use database-first approach (Optional Enhancement)

**NOTE**: This phase is optional and implements the "match emails to Feedback records" pattern from Issue #238 Task 2. The current implementation works correctly but queries GitHub for each email. This refactor would be more efficient for high volume.

### Subtask 3.1: Fetch resolved feedback records first
**File**: `/home/pbrown/SkuInventory/src/app/api/cron/email-monitor/route.ts`
**Current approach**: For each email -> extract issue number -> query GitHub -> query database
**New approach**: Fetch all resolved feedback -> For each email -> match by issue number -> verify with GitHub only if needed
**Instructions**:
1. Import `getResolvedFeedback` (already in imports but unused)
2. Before email loop, fetch resolved feedback:
   ```typescript
   const resolvedFeedback = await getResolvedFeedback()
   console.log(`[Email Monitor] Found ${resolvedFeedback.length} feedback records awaiting verification`)
   ```
3. In email loop, find matching feedback first:
   ```typescript
   const feedback = resolvedFeedback.find(f => f.githubIssueNumber === issueNumber)
   if (!feedback) {
     console.log(`[Email Monitor] No resolved feedback for issue #${issueNumber}`)
     results.skipped++
     continue
   }
   ```
4. Keep GitHub query for issue data (needed for labels, body)

**Trade-off Analysis**:
- Pro: Single database query instead of one per email
- Pro: Only queries GitHub when there's a matching feedback record
- Con: Loads all resolved feedback into memory (acceptable for typical volume)

**Decision**: Mark as OPTIONAL - current implementation is correct, this is optimization

**Validation**:
```bash
npx tsc --noEmit
npm run build
```
**Completion Criteria**:
- [ ] Resolved feedback fetched once at start
- [ ] Email matching uses in-memory lookup
- [ ] GitHub queries only for matched emails
- [ ] All existing functionality preserved

---

## Phase 4: Verification and Testing

### Subtask 4.1: Run TypeScript and build checks
**Instructions**:
```bash
cd /home/pbrown/SkuInventory
npx tsc --noEmit
npm run build
npm run lint
```
**Completion Criteria**:
- [ ] No TypeScript errors
- [ ] Build completes successfully
- [ ] No lint errors

### Subtask 4.2: Run existing tests
**Instructions**:
```bash
cd /home/pbrown/SkuInventory
npm test -- --filter="feedback"
```
**Completion Criteria**:
- [ ] All feedback-related tests pass
- [ ] No regressions

### Subtask 4.3: Manual API verification (optional)
**Instructions**:
```bash
# Test endpoint responds correctly when not configured
curl -X GET http://172.16.20.50:2345/api/cron/email-monitor \
  -H "Authorization: Bearer $CRON_SECRET"
```
**Expected**: Returns `status: 'skipped'` with reason about missing Azure config
**Completion Criteria**:
- [ ] Endpoint returns expected response
- [ ] CRON_SECRET authentication works

---

## Summary of Deliverables

**Files Modified**: 1
- `src/app/api/cron/email-monitor/route.ts` - Add idempotency checks and error handling

**Files Created**: 0 (optional unit tests could be added)

**Key Changes**:
1. Check `responseEmailId` to prevent duplicate processing
2. Validate feedback status is `resolved` before processing
3. Only update `lastCheckTime` when processing succeeds
4. Track and report skipped emails with reasons

---

## Acceptance Criteria Checklist (from Issue #238)

| Criteria | Subtask |
|----------|---------|
| lastCheckTime persists across deploys | Already done (Phase 1-3) |
| Emails are not processed twice | Subtask 1.1 |
| Feedback status correctly updated to verified/changes_requested | Already done (Phase 1-3) |
| Follow-up issues created and linked | Already done (Phase 1-3) |
| Comprehensive logging for debugging | Subtask 2.2 |
| Build passes with no TypeScript errors | Subtask 4.1 |

---

## Handoff to Build Agent

1. Execute subtasks in order: 1.1 -> 1.2 -> 2.1 -> 2.2 -> 4.1 -> 4.2
2. Phase 3 (database-first approach) is OPTIONAL - implement only if time permits
3. Test completion criteria before proceeding to next subtask
4. All validation commands must pass

## Test Strategy Note
- Use Vitest for unit tests
- Run `npm test -- --filter="feedback"` for targeted testing
- Full test suite: `npm test`

## Performance Metrics

| Phase | Estimated Duration |
|-------|-------------------|
| Investigation | 25m |
| Validation | 10m |
| Planning | 20m |
| **Total Scout-Plan** | **55m** |
| **Estimated Build** | **2h** |

---

## Code Reference: Current Email Monitor Structure

```typescript
// Current flow (simplified):
// 1. Get lastCheckTime from database
// 2. Fetch new emails since lastCheckTime
// 3. Update lastCheckTime immediately (BUG: should be at end)
// 4. For each email:
//    a. Extract issue number from subject
//    b. Query GitHub for issue
//    c. Extract submitter email from issue body
//    d. Verify sender matches submitter
//    e. Parse reply for action
//    f. Look up feedback by issue number
//    g. Update feedback status (MISSING: check if already processed)
// 5. Return results

// Changes needed:
// - Move lastCheckTime update to end, only on success
// - Add responseEmailId check at step 4f
// - Add feedback.status check at step 4f
// - Track skipped emails with reasons
```
