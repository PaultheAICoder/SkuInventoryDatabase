# Implementation Plan
**Generated**: 2025-12-17T14:30:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: Issue #302 - Harden User Primary Company Logic
**Estimated Build Time**: 4-6 hours
**Complexity**: Medium

---

## Investigation Summary

### Request Analysis
**Type**: Enhancement (Database Constraint)
**Source**: GitHub Issue #302
**Priority**: Medium (Data Integrity, Defense-in-Depth)

### Task Classification
**Category**: NEW_FEATURE (Database Constraint)
**Test Strategy**: TARGETED - Tests for primary company enforcement
**Suggested Filter**: `--filter="primary|UserCompany|isPrimary"`

### Issue Validation
**Status**: Valid
**Recent Changes**:
- Issue #214/#223/#224 completed refactoring User-Company relationship to single source of truth
- Issue #295 fixed role preservation when updating company assignments
- isPrimary flag exists but has no database constraint

### Current State Assessment

#### Database Schema
```
UserCompany Model (prisma/schema.prisma lines 152-166):
- id: String @id @default(uuid())
- userId: String
- companyId: String
- role: UserRole @default(ops)
- isPrimary: Boolean @default(false)  // <-- CURRENT: Application-level enforcement only
- assignedAt: DateTime @default(now())
- @@unique([userId, companyId])
- @@index([userId])
- @@index([companyId])
```

**Current Data State (Test DB)**:
| Users | UserCompany Records | Users with 0 Primary | Users with >1 Primary |
|-------|---------------------|----------------------|-----------------------|
| 6 | 10 | 0 | 0 |

All users currently have exactly 1 primary company - data is consistent.

#### Existing Constraints on UserCompany
- `UserCompany_pkey` - Primary key on `id`
- `UserCompany_userId_companyId_key` - Unique constraint on (userId, companyId)
- `UserCompany_userId_fkey` - Foreign key to User
- `UserCompany_companyId_fkey` - Foreign key to Company
- **NO constraint for one primary per user** (application-level only)

#### Code Locations Using isPrimary

1. **src/lib/auth.ts** (5 occurrences):
   - Line 41: `user?.userCompanies.find(uc => uc.isPrimary)`
   - Line 72: Fallback `|| user.userCompanies[0]`
   - Line 86: Fallback `|| user.userCompanies[0]`
   - Line 110: `user.userCompanies.find(uc => uc.isPrimary)`

2. **src/app/api/users/[id]/companies/route.ts** (5 occurrences):
   - Line 149: `where: { userId: id, isPrimary: true }`
   - Line 178: `isPrimary: companyId === newPrimaryCompanyId`

3. **src/app/api/users/route.ts** (2 occurrences):
   - Line 93, 208: `isPrimary: true` when creating UserCompany

4. **src/app/api/users/[id]/route.ts** (1 occurrence):
   - Line 54: Select isPrimary in query

5. **src/services/amazon-ads/sync.ts** (2 occurrences):
   - Line 169: `where: { isPrimary: true }`
   - Line 174: Role check includes isPrimary

6. **prisma/seed.ts** (3 occurrences):
   - Lines 83, 113, 143: `isPrimary: true` when seeding users

7. **src/types/user.ts** (1 occurrence):
   - Line 58: `isPrimary: boolean` in UserCompanyAssignment interface

### Dependencies & Blockers
1. **No Blockers**: Data is already consistent (all users have exactly 1 primary)
2. **Precedent**: BOMVersion partial unique index exists as pattern

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Medium
**Effort**: 4-6 hours
**Risk**: Low - Pattern exists, data is already consistent

**Risk Factors**:
- Migration failure if data becomes inconsistent before migration runs
- Existing application logic has fallbacks - not strictly enforced

### Patterns Identified
**Primary**: `prisma/migrations/20251206155748_add_single_active_bom_constraint/migration.sql`
- Shows exact pattern for partial unique index
- Includes rollback instructions

**Secondary**: `completion-docs/2025-12-06-issue-196-single-active-bom-constraint.md`
- Shows documentation pattern and error handling notes

### Ripple Effect Analysis
**Files Identified**: 3 (minimal changes)
- `prisma/schema.prisma` - Add documentation comment
- `prisma/migrations/[timestamp]_add_one_primary_per_user_constraint/migration.sql` - New migration
- `tests/integration/user-companies.test.ts` - Add constraint violation test (optional)

**No code changes required** - Only database constraint and documentation.

---

## Executive Summary
Add a PostgreSQL partial unique index on the UserCompany table to enforce the "one primary company per user" business rule at the database level. This follows the established pattern from Issue #196 (single active BOM per SKU) and provides defense-in-depth against race conditions, manual database edits, or application logic bugs.

## Design Decision: Partial Unique Index vs FK on User Table

The issue suggests two approaches:
1. **Partial Unique Index** (RECOMMENDED): `CREATE UNIQUE INDEX ON "UserCompany"("userId") WHERE "isPrimary" = true`
2. **Move primaryCompanyId to User table**: Add `primaryCompanyId` FK to User model

### Why Partial Unique Index is Better:
1. **No Schema Change**: UserCompany already has isPrimary, no new columns needed
2. **Consistent Pattern**: Matches existing BOMVersion.isActive constraint
3. **Less Code Change**: No refactoring of auth.ts or other files
4. **Preserves Flexibility**: Users can have 0 companies (account being set up) or N companies with exactly 1 primary
5. **Simple Migration**: Just add constraint, no data movement

### Why NOT Move to User Table:
1. **Requires Major Refactoring**: Would need to update auth.ts, all API routes, types
2. **Data Movement**: Need to migrate isPrimary data to User table
3. **Dual Maintenance**: Would have both User.primaryCompanyId AND UserCompany.isPrimary during transition
4. **Circular Reference Risk**: User -> Company -> UserCompany -> User

---

## Phase 1: Database Constraint

### Subtask 1.1: Verify Data Consistency (Pre-Migration Check)
**File**: N/A (SQL verification only)
**Instructions**:
1. Run verification query to ensure no users have 0 or >1 primary companies:
```sql
SELECT
  u.id, u.email,
  COUNT(CASE WHEN uc."isPrimary" = true THEN 1 END) as primary_count
FROM "User" u
LEFT JOIN "UserCompany" uc ON u.id = uc."userId"
GROUP BY u.id, u.email
HAVING COUNT(CASE WHEN uc."isPrimary" = true THEN 1 END) != 1;
```
2. Result should be empty (0 rows)
3. If any violations exist, fix them before migration

**Completion Criteria**:
- [ ] Verification query returns 0 rows
- [ ] Document current state before migration

### Subtask 1.2: Create Prisma Migration for Partial Unique Index
**File**: `prisma/migrations/[timestamp]_add_one_primary_per_user_constraint/migration.sql`
**Pattern**: Follow `prisma/migrations/20251206155748_add_single_active_bom_constraint/migration.sql`
**Instructions**:
1. Create empty migration:
```bash
npx prisma migrate dev --create-only --name add_one_primary_per_user_constraint
```
2. Edit the generated migration file to contain:
```sql
-- CreateIndex: Enforce one primary company per user at database level
-- This partial unique index allows multiple non-primary company assignments per user
-- but only ONE primary company per user
CREATE UNIQUE INDEX "one_primary_company_per_user" ON "UserCompany"("userId") WHERE "isPrimary" = true;
```
3. Run migration:
```bash
npx prisma migrate dev
```
4. Verify index was created:
```sql
SELECT indexname, indexdef FROM pg_indexes WHERE indexname = 'one_primary_company_per_user';
```

**Completion Criteria**:
- [ ] Migration file created
- [ ] Migration runs successfully
- [ ] Index exists in database
- [ ] `npx prisma generate` completes successfully

### Subtask 1.3: Add Documentation Comment to Prisma Schema
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Pattern**: Follow BOMVersion documentation pattern (lines 431-432)
**Instructions**:
1. Add comment above UserCompany model (around line 152):
```prisma
// Note: Partial unique index "one_primary_company_per_user" enforces one isPrimary=true per userId
// Created via raw SQL migration (Prisma doesn't support partial unique indexes in schema)
model UserCompany {
```
2. Update the existing comment on line 161:
```prisma
  isPrimary  Boolean  @default(false) // Designates user's default company (enforced by DB constraint)
```

**Completion Criteria**:
- [ ] Documentation comment added before model
- [ ] isPrimary comment updated
- [ ] Schema still valid (`npx prisma validate`)

---

## Phase 2: Validation & Tests

### Subtask 2.1: Verify Constraint Works (Manual Test)
**File**: N/A (SQL test)
**Instructions**:
1. Attempt to insert a second primary company for a user (should fail):
```sql
-- This should fail with unique_violation error
INSERT INTO "UserCompany" ("id", "userId", "companyId", "role", "isPrimary", "assignedAt")
SELECT
  gen_random_uuid(),
  (SELECT "userId" FROM "UserCompany" WHERE "isPrimary" = true LIMIT 1),
  (SELECT id FROM "Company" LIMIT 1 OFFSET 1),
  'ops',
  true,  -- Attempting second primary
  NOW();
```
2. Verify error message mentions `one_primary_company_per_user` constraint
3. Verify original data unchanged

**Completion Criteria**:
- [ ] Insert fails with expected error
- [ ] Error code is 23505 (unique_violation)
- [ ] Database state unchanged after failed insert

### Subtask 2.2: Add Integration Test for Constraint Violation (Optional)
**File**: `/home/pbrown/SkuInventory/tests/integration/user-companies.test.ts`
**Pattern**: Follow existing test patterns in the file
**Instructions**:
1. Add test case to verify database constraint:
```typescript
describe('PUT /api/users/[id]/companies - Database Constraint', () => {
  it('database constraint prevents multiple primary companies', async () => {
    // This test verifies the database-level constraint works
    // Application logic should prevent this, but constraint is defense-in-depth
    const prisma = getIntegrationPrisma()

    // Try to directly set two companies as primary (bypassing API)
    const testUser = await prisma.user.findFirst({
      where: { email: { contains: 'test' } },
      include: { userCompanies: true }
    })

    if (!testUser || testUser.userCompanies.length < 2) {
      // Skip if test user doesn't have multiple companies
      return
    }

    // Attempt to set second company as primary should fail
    await expect(
      prisma.userCompany.update({
        where: {
          userId_companyId: {
            userId: testUser.id,
            companyId: testUser.userCompanies.find(uc => !uc.isPrimary)!.companyId
          }
        },
        data: { isPrimary: true }
      })
    ).rejects.toThrow(/unique|one_primary_company_per_user/)
  })
})
```
2. Run test to verify:
```bash
npm test -- --filter="Database Constraint"
```

**Completion Criteria**:
- [ ] Test added (optional but recommended)
- [ ] Test passes
- [ ] All existing tests still pass

### Subtask 2.3: Run Full Test Suite
**File**: N/A
**Instructions**:
1. Run TypeScript check: `npx tsc --noEmit`
2. Run build: `npm run build`
3. Run lint: `npm run lint`
4. Run tests: `npm test`

**Completion Criteria**:
- [ ] TypeScript check passes
- [ ] Build succeeds
- [ ] Lint passes
- [ ] All tests pass

---

## Summary of Deliverables
**Files Created**: 1
- `prisma/migrations/[timestamp]_add_one_primary_per_user_constraint/migration.sql`

**Files Modified**: 2
- `prisma/schema.prisma` (documentation comments)
- `tests/integration/user-companies.test.ts` (optional - new test case)

## Handoff to Build Agent
1. Execute subtasks in exact order
2. Verify data consistency BEFORE running migration (Subtask 1.1)
3. Use test database (port 2346) for all operations
4. Follow BOMVersion constraint as pattern exactly
5. Run full test suite before marking complete

## Test Strategy Note
- Use Vitest for unit tests
- Integration tests require TEST_DATABASE_URL
- Manual SQL verification for constraint behavior

## Rollback Instructions
If migration needs to be reverted:
```sql
DROP INDEX IF EXISTS "one_primary_company_per_user";
```

## Error Handling Note
When the constraint is violated, PostgreSQL returns error code `23505` (unique_violation). The existing application logic in `src/app/api/users/[id]/companies/route.ts` manages isPrimary correctly (deletes all records and recreates with exactly one primary), so this constraint should never be violated in normal operation. The constraint is a safety net for:
- Race conditions during concurrent updates
- Manual database edits
- Future bugs in application logic

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 10m |
| **Total** | **30m** |
