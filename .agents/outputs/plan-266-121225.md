# Implementation Plan
**Generated**: 2025-12-12T19:45:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #266 - feat(002): Add data retention cleanup cron routes (T067-T069)
**Estimated Build Time**: 3-4 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Feature (New cron route and documentation)
**Source**: GitHub Issue #266
**Priority**: Medium (Phase 9 Polish task)

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED (affected modules only)
**Suggested Filter**: `--filter="retention"` or None (manual verification)

### Issue Validation
**Status**: Valid
**Recent Changes**: No recent commits affect this work. This is new functionality for T067-T069.

### Current State Assessment
- **Existing components**:
  - Cron pattern: `src/app/api/cron/ads-sync/route.ts` (POST, X-Cron-Secret header auth)
  - Cron pattern: `src/app/api/cron/alerts/route.ts` (GET, Bearer token auth)
  - Cron pattern: `src/app/api/cron/email-monitor/route.ts` (GET, Bearer token auth)
  - Retention pattern: `src/services/notifications.ts` has `deleteOldNotifications()` (lines 218-236)

- **Database models involved**:
  - `KeywordMetric` - prisma/schema.prisma:791-836 (has `createdAt` field)
  - `SalesDaily` - prisma/schema.prisma:838-870 (has `createdAt` field)
  - `SyncLog` - prisma/schema.prisma:893-932 (has `startedAt`, `status` fields)

- **API Routes**: New route at `/api/cron/retention-cleanup`

- **Documentation**:
  - `docs/operations/` directory exists with EMAIL-MONITOR-CRON.md as reference
  - systemd templates in `scripts/systemd/` for cron setup

### Dependencies & Blockers
1. None - all required infrastructure exists

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Simple (follows existing patterns exactly)
**Effort**: 3-4 hours
**Risk**: Low (isolated changes, no database schema changes)

### Patterns Identified
**Primary**: `src/services/notifications.ts:deleteOldNotifications()` (lines 220-236)
- Date calculation pattern using `setDate()`
- `prisma.*.deleteMany()` with date filter
- Returns count of deleted records

**Secondary**: `src/app/api/cron/ads-sync/route.ts`
- CRON_SECRET verification pattern
- Error handling and response structure
- POST method for cron endpoint

**Tertiary**: `docs/operations/EMAIL-MONITOR-CRON.md`
- Documentation structure for cron setup
- systemd timer/service configuration

### Ripple Effect Analysis
**Files Identified**: 3 new files + 0 modified files
- New: `src/services/retention.ts` (retention cleanup service)
- New: `src/app/api/cron/retention-cleanup/route.ts` (cron endpoint)
- New: `docs/operations/CRON-SCHEDULER-SETUP.md` (documentation)

**No ripple effects** - this is a self-contained addition with no impact on existing code.

---

## Executive Summary
Implement automated data retention cleanup for the ads data ingestion feature. This creates a new cron endpoint that deletes old KeywordMetric records (12 months), SalesDaily records (12 months), and SyncLog records (12 months for completed, 24 months for failed). Documentation will provide scheduler configuration for external cron services.

## Phase 1: Service Layer

### Subtask 1.1: Create Retention Cleanup Service
**File**: `/home/pbrown/SkuInventory/src/services/retention.ts`
**Pattern**: Follow `src/services/notifications.ts:deleteOldNotifications()` (lines 220-236)

**Instructions**:
1. Create new file `src/services/retention.ts`
2. Implement the following functions:

```typescript
/**
 * Retention Cleanup Service
 *
 * Handles automated deletion of old records per data retention policy.
 * - KeywordMetric: 12 months
 * - SalesDaily: 12 months
 * - SyncLog: 12 months (completed), 24 months (failed)
 */

import { prisma } from '@/lib/db'

export interface RetentionCleanupResult {
  keywordMetricsDeleted: number
  salesDailyDeleted: number
  syncLogsDeleted: number
  totalDeleted: number
  duration: number
}

/**
 * Delete KeywordMetric records older than specified months
 */
export async function deleteOldKeywordMetrics(olderThanMonths: number = 12): Promise<number> {
  const cutoffDate = new Date()
  cutoffDate.setMonth(cutoffDate.getMonth() - olderThanMonths)

  const result = await prisma.keywordMetric.deleteMany({
    where: {
      createdAt: { lt: cutoffDate },
    },
  })

  return result.count
}

/**
 * Delete SalesDaily records older than specified months
 */
export async function deleteOldSalesDaily(olderThanMonths: number = 12): Promise<number> {
  const cutoffDate = new Date()
  cutoffDate.setMonth(cutoffDate.getMonth() - olderThanMonths)

  const result = await prisma.salesDaily.deleteMany({
    where: {
      createdAt: { lt: cutoffDate },
    },
  })

  return result.count
}

/**
 * Delete SyncLog records based on status:
 * - Completed/partial: 12 months
 * - Failed: 24 months (keep longer for debugging)
 */
export async function deleteOldSyncLogs(
  completedOlderThanMonths: number = 12,
  failedOlderThanMonths: number = 24
): Promise<number> {
  const completedCutoff = new Date()
  completedCutoff.setMonth(completedCutoff.getMonth() - completedOlderThanMonths)

  const failedCutoff = new Date()
  failedCutoff.setMonth(failedCutoff.getMonth() - failedOlderThanMonths)

  // Delete completed/partial sync logs older than 12 months
  const completedResult = await prisma.syncLog.deleteMany({
    where: {
      status: { in: ['completed', 'partial'] },
      startedAt: { lt: completedCutoff },
    },
  })

  // Delete failed sync logs older than 24 months
  const failedResult = await prisma.syncLog.deleteMany({
    where: {
      status: 'failed',
      startedAt: { lt: failedCutoff },
    },
  })

  return completedResult.count + failedResult.count
}

/**
 * Run full retention cleanup
 */
export async function runRetentionCleanup(): Promise<RetentionCleanupResult> {
  const startTime = Date.now()

  const keywordMetricsDeleted = await deleteOldKeywordMetrics()
  const salesDailyDeleted = await deleteOldSalesDaily()
  const syncLogsDeleted = await deleteOldSyncLogs()

  return {
    keywordMetricsDeleted,
    salesDailyDeleted,
    syncLogsDeleted,
    totalDeleted: keywordMetricsDeleted + salesDailyDeleted + syncLogsDeleted,
    duration: Date.now() - startTime,
  }
}
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] File created at `src/services/retention.ts`
- [ ] All four functions implemented: `deleteOldKeywordMetrics`, `deleteOldSalesDaily`, `deleteOldSyncLogs`, `runRetentionCleanup`
- [ ] TypeScript compiles without errors
- [ ] Follows deleteOldNotifications pattern from notifications.ts

---

## Phase 2: API Route

### Subtask 2.1: Create Retention Cleanup Cron Route
**File**: `/home/pbrown/SkuInventory/src/app/api/cron/retention-cleanup/route.ts`
**Pattern**: Follow `src/app/api/cron/ads-sync/route.ts`

**Instructions**:
1. Create directory `src/app/api/cron/retention-cleanup/`
2. Create `route.ts` with POST handler
3. Use X-Cron-Secret header authentication (like ads-sync)
4. Return cleanup results in response

```typescript
/**
 * POST /api/cron/retention-cleanup
 *
 * Scheduled endpoint for data retention cleanup.
 * Deletes old records per retention policy:
 * - KeywordMetric: 12 months
 * - SalesDaily: 12 months
 * - SyncLog: 12 months (completed), 24 months (failed)
 *
 * Authenticated via X-Cron-Secret header.
 */

import { NextRequest, NextResponse } from 'next/server'
import { runRetentionCleanup } from '@/services/retention'

export async function POST(request: NextRequest) {
  const startTime = Date.now()

  try {
    // Verify cron secret
    const cronSecret = process.env.CRON_SECRET
    const providedSecret = request.headers.get('X-Cron-Secret')

    if (!cronSecret || cronSecret.length < 16) {
      console.error('[Retention Cleanup] CRON_SECRET not properly configured')
      return NextResponse.json(
        { error: 'Server configuration error' },
        { status: 500 }
      )
    }

    if (providedSecret !== cronSecret) {
      return NextResponse.json(
        { error: 'Invalid cron secret' },
        { status: 401 }
      )
    }

    console.log('[Retention Cleanup] Starting retention cleanup...')

    const result = await runRetentionCleanup()

    console.log(
      `[Retention Cleanup] Complete: ${result.totalDeleted} records deleted ` +
      `(KeywordMetric: ${result.keywordMetricsDeleted}, SalesDaily: ${result.salesDailyDeleted}, ` +
      `SyncLog: ${result.syncLogsDeleted}) in ${result.duration}ms`
    )

    return NextResponse.json({
      success: true,
      ...result,
      timestamp: new Date().toISOString(),
    })
  } catch (error) {
    console.error('[Retention Cleanup] Error:', error)
    return NextResponse.json(
      {
        success: false,
        error: error instanceof Error ? error.message : 'Unknown error',
        duration: Date.now() - startTime,
        timestamp: new Date().toISOString(),
      },
      { status: 500 }
    )
  }
}
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Route created at `src/app/api/cron/retention-cleanup/route.ts`
- [ ] POST handler with X-Cron-Secret authentication
- [ ] Calls `runRetentionCleanup()` from retention service
- [ ] Returns detailed results including counts per model
- [ ] Includes console logging for audit trail
- [ ] Build passes

---

## Phase 3: Documentation

### Subtask 3.1: Create Scheduler Configuration Documentation
**File**: `/home/pbrown/SkuInventory/docs/operations/CRON-SCHEDULER-SETUP.md`
**Pattern**: Follow `docs/operations/EMAIL-MONITOR-CRON.md`

**Instructions**:
1. Create comprehensive documentation for all cron endpoints
2. Include systemd timer examples
3. Document recommended schedules

```markdown
# Cron Scheduler Setup

## Overview

This document describes how to configure external schedulers (cron, systemd timers, or cloud schedulers) to call the inventory application's cron endpoints.

## Cron Endpoints

| Endpoint | Method | Schedule | Purpose |
|----------|--------|----------|---------|
| `/api/cron/alerts` | GET | Every 15 min | Low-stock alert evaluation |
| `/api/cron/email-monitor` | GET | Every 5 min | Poll feedback inbox for replies |
| `/api/cron/ads-sync` | POST | Daily 3:00 AM | Sync Amazon Ads data |
| `/api/cron/retention-cleanup` | POST | Daily 4:00 AM | Delete old records per retention policy |

## Authentication

All cron endpoints require authentication via the `CRON_SECRET` environment variable.

### Header Formats

- **GET endpoints** (alerts, email-monitor): `Authorization: Bearer <CRON_SECRET>`
- **POST endpoints** (ads-sync, retention-cleanup): `X-Cron-Secret: <CRON_SECRET>`

### Setting Up CRON_SECRET

1. Generate a secure secret:
   ```bash
   openssl rand -base64 32
   ```

2. Add to your environment configuration:
   - Docker: `docker/.env`
   - systemd: Service file `Environment=` directive

## Recommended Schedules

| Endpoint | Schedule | Cron Expression | Rationale |
|----------|----------|-----------------|-----------|
| alerts | Every 15 min | `*/15 * * * *` | Frequent checks for low-stock |
| email-monitor | Every 5 min | `*/5 * * * *` | Quick response to feedback |
| ads-sync | Daily 3:00 AM | `0 3 * * *` | Off-peak hours, daily data |
| retention-cleanup | Daily 4:00 AM | `0 4 * * *` | After ads-sync, minimal load |

## systemd Timer Configuration

### Example: Retention Cleanup Timer

Create `/etc/systemd/system/inventory-retention-cleanup.timer`:

```ini
[Unit]
Description=Run Inventory Retention Cleanup daily at 4 AM

[Timer]
OnCalendar=*-*-* 04:00:00
AccuracySec=5min
Persistent=true

[Install]
WantedBy=timers.target
```

Create `/etc/systemd/system/inventory-retention-cleanup.service`:

```ini
[Unit]
Description=Inventory Retention Cleanup - Delete old records
After=network-online.target docker.service
Wants=network-online.target
Requires=docker.service

[Service]
Type=oneshot
Environment="CRON_SECRET=your-cron-secret-here"
ExecStart=/usr/bin/curl -s -X POST "http://172.16.20.50:4545/api/cron/retention-cleanup" \
    -H "X-Cron-Secret: ${CRON_SECRET}" \
    -H "Content-Type: application/json" \
    -o /var/log/inventory/retention-cleanup-last.json \
    -w "\nHTTP_CODE:%{http_code}\n"
TimeoutSec=300

StandardOutput=append:/var/log/inventory/retention-cleanup.log
StandardError=append:/var/log/inventory/retention-cleanup.log

[Install]
WantedBy=multi-user.target
```

Enable and start:

```bash
sudo systemctl daemon-reload
sudo systemctl enable inventory-retention-cleanup.timer
sudo systemctl start inventory-retention-cleanup.timer
```

### Example: Ads Sync Timer

Create `/etc/systemd/system/inventory-ads-sync.timer`:

```ini
[Unit]
Description=Run Inventory Ads Sync daily at 3 AM

[Timer]
OnCalendar=*-*-* 03:00:00
AccuracySec=5min
Persistent=true

[Install]
WantedBy=timers.target
```

Create `/etc/systemd/system/inventory-ads-sync.service`:

```ini
[Unit]
Description=Inventory Ads Sync - Sync Amazon Ads data
After=network-online.target docker.service
Wants=network-online.target
Requires=docker.service

[Service]
Type=oneshot
Environment="CRON_SECRET=your-cron-secret-here"
ExecStart=/usr/bin/curl -s -X POST "http://172.16.20.50:4545/api/cron/ads-sync" \
    -H "X-Cron-Secret: ${CRON_SECRET}" \
    -H "Content-Type: application/json" \
    -o /var/log/inventory/ads-sync-last.json \
    -w "\nHTTP_CODE:%{http_code}\n"
TimeoutSec=600

StandardOutput=append:/var/log/inventory/ads-sync.log
StandardError=append:/var/log/inventory/ads-sync.log

[Install]
WantedBy=multi-user.target
```

## Traditional Crontab

Add to `/etc/crontab` or user crontab:

```bash
# Inventory Cron Jobs
CRON_SECRET=your-cron-secret-here
INVENTORY_URL=http://172.16.20.50:4545

# Low-stock alerts - every 15 minutes
*/15 * * * * root curl -s -X GET "${INVENTORY_URL}/api/cron/alerts" -H "Authorization: Bearer ${CRON_SECRET}" >> /var/log/inventory/alerts.log 2>&1

# Email monitor - every 5 minutes
*/5 * * * * root curl -s -X GET "${INVENTORY_URL}/api/cron/email-monitor" -H "Authorization: Bearer ${CRON_SECRET}" >> /var/log/inventory/email-monitor.log 2>&1

# Ads sync - daily at 3 AM
0 3 * * * root curl -s -X POST "${INVENTORY_URL}/api/cron/ads-sync" -H "X-Cron-Secret: ${CRON_SECRET}" >> /var/log/inventory/ads-sync.log 2>&1

# Retention cleanup - daily at 4 AM
0 4 * * * root curl -s -X POST "${INVENTORY_URL}/api/cron/retention-cleanup" -H "X-Cron-Secret: ${CRON_SECRET}" >> /var/log/inventory/retention-cleanup.log 2>&1
```

## Cloud Scheduler (Vercel/Railway/etc.)

Most cloud platforms support cron job configuration:

### Vercel Cron

Add to `vercel.json`:

```json
{
  "crons": [
    {
      "path": "/api/cron/alerts",
      "schedule": "*/15 * * * *"
    },
    {
      "path": "/api/cron/ads-sync",
      "schedule": "0 3 * * *"
    },
    {
      "path": "/api/cron/retention-cleanup",
      "schedule": "0 4 * * *"
    }
  ]
}
```

Note: Vercel Cron sets the `CRON_SECRET` automatically via the Vercel platform.

## Data Retention Policy

The retention cleanup endpoint enforces the following policies:

| Model | Retention Period | Rationale |
|-------|-----------------|-----------|
| KeywordMetric | 12 months | Performance data analysis window |
| SalesDaily | 12 months | Year-over-year comparison |
| SyncLog (completed) | 12 months | Audit trail |
| SyncLog (failed) | 24 months | Extended debugging period |

## Monitoring

### Check Timer Status

```bash
# List all inventory timers
systemctl list-timers | grep inventory

# Check specific timer
sudo systemctl status inventory-retention-cleanup.timer
```

### View Logs

```bash
# Recent cleanup activity
tail -50 /var/log/inventory/retention-cleanup.log

# Last response
cat /var/log/inventory/retention-cleanup-last.json | jq .
```

### Manual Trigger

```bash
# Trigger retention cleanup manually
curl -X POST "http://172.16.20.50:4545/api/cron/retention-cleanup" \
  -H "X-Cron-Secret: $(grep CRON_SECRET /home/pbrown/SkuInventory/docker/.env | cut -d= -f2)"
```

## Troubleshooting

| Issue | Cause | Solution |
|-------|-------|----------|
| 401 Unauthorized | CRON_SECRET mismatch | Verify secret matches docker/.env |
| 500 Server Error | Database connection | Check app and database health |
| Timeout | Large cleanup | Increase TimeoutSec (retention can take time) |
| No records deleted | No old data | Normal - data hasn't aged past retention period |

## Related Documentation

- [Email Monitor Cron](./EMAIL-MONITOR-CRON.md) - Detailed email monitor setup
- [Webhook Setup](./WEBHOOK-SETUP.md) - GitHub webhook configuration
```

**Validation**:
- Review document for completeness
- Verify all endpoints are documented

**Completion Criteria**:
- [ ] Documentation file created at `docs/operations/CRON-SCHEDULER-SETUP.md`
- [ ] All four cron endpoints documented
- [ ] Recommended schedules included
- [ ] systemd timer/service examples provided
- [ ] Traditional crontab examples provided
- [ ] Data retention policy documented
- [ ] Monitoring and troubleshooting sections included

---

## Phase 4: Verification

### Subtask 4.1: Run Build and Lint Checks
**Instructions**:
1. Run TypeScript check
2. Run build
3. Run lint

**Validation**:
```bash
npx tsc --noEmit
npm run build
npm run lint
```

**Completion Criteria**:
- [ ] `npx tsc --noEmit` passes with no errors
- [ ] `npm run build` completes successfully
- [ ] `npm run lint` passes with no warnings

---

## Summary of Deliverables
**Files Created**: 3
- `src/services/retention.ts` - Retention cleanup service
- `src/app/api/cron/retention-cleanup/route.ts` - Cron API endpoint
- `docs/operations/CRON-SCHEDULER-SETUP.md` - Scheduler documentation

**Files Modified**: 0

## Handoff to Build Agent
1. Execute subtasks in exact order (Phase 1 -> Phase 2 -> Phase 3 -> Phase 4)
2. Create retention service first (Phase 1)
3. Create API route that imports the service (Phase 2)
4. Create documentation (Phase 3)
5. Verify all checks pass (Phase 4)
6. Follow reference patterns exactly from:
   - `src/services/notifications.ts:deleteOldNotifications()` for service
   - `src/app/api/cron/ads-sync/route.ts` for API route
   - `docs/operations/EMAIL-MONITOR-CRON.md` for documentation

## Test Strategy Note
- Manual verification only for this feature (no automated tests required)
- Test with curl command against test environment (port 2345)
- Verify authentication works correctly

## Reference Files Summary

| Purpose | File | Lines |
|---------|------|-------|
| Delete pattern | `src/services/notifications.ts` | 218-236 |
| Cron route pattern | `src/app/api/cron/ads-sync/route.ts` | 1-47 |
| Cron route pattern (GET) | `src/app/api/cron/alerts/route.ts` | 1-86 |
| Documentation pattern | `docs/operations/EMAIL-MONITOR-CRON.md` | Full file |
| Prisma KeywordMetric | `prisma/schema.prisma` | 791-836 |
| Prisma SalesDaily | `prisma/schema.prisma` | 838-870 |
| Prisma SyncLog | `prisma/schema.prisma` | 893-932 |

## Performance Metrics
| Phase | Estimated Duration |
|-------|-------------------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 10m |
| **Total** | **30m** |
