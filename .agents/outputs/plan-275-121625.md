# Implementation Plan
**Generated**: 2025-12-16T12:16:25Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #275
**Estimated Build Time**: 2-3 hours
**Complexity**: Low-Medium

## Investigation Summary

### Request Analysis
**Type**: Bug Fix + UI Enhancement
**Source**: GitHub Issue #275
**Priority**: High (user cannot use the feature)

**Issue Description**:
The Record Build dialog has multiple problems:
1. Cannot select any SKUs in the dropdown (critical bug)
2. Layout is cramped with text "very close together"
3. Fields are hard to read
4. Dialog functionality is unclear to the user

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED - Test BuildDialog functionality
**Suggested Filter**: `--filter="Build"` or None

### Issue Validation
**Status**: Valid
**Recent Changes**: Issue #274 (closed Dec 16) fixed a related Radix UI Select crash but did NOT fix the SKU filtering bug

### Current State Assessment

**Root Cause Analysis - SKU Dropdown Empty (CRITICAL)**:
The BuildDialog has a data binding bug that prevents any SKUs from appearing:

1. **API Response** (`/api/skus/route.ts` lines 107-113):
   ```typescript
   activeBom: activeBom
     ? { id: activeBom.id, versionName: activeBom.versionName, unitCost: ... }
     : null,
   ```

2. **BuildDialog Filter** (lines 131-132):
   ```typescript
   data.data.filter((sku: SKUOption) => sku.hasActiveBom).map(...)
   ```

3. **Problem**: API returns `activeBom` (object or null), but filter checks `hasActiveBom` (undefined on all SKUs).

**Effect**: `sku.hasActiveBom` is always `undefined` (falsy), so ALL SKUs are filtered out and the dropdown is empty.

**UI Layout Issues**:
- BuildDialog uses `sm:max-w-[500px]` while similar dialogs (ReceiptDialog, AdjustmentDialog) use `sm:max-w-[425px]`
- SKU SelectItem uses complex nested `div` with flex layout (only dialog to do this)
- Many fields packed into the form with collapsible sections adding visual complexity
- No visual grouping or section headers for clarity

**Existing Components**:
- BuildDialog.tsx - Main component with bugs
- Dialog UI component - Standard shadcn/ui, works correctly
- Select UI component - Standard Radix UI, works correctly
- API route `/api/skus` - Returns correct data format

**Database**: No changes needed
**API Routes**: No changes needed (returns correct data)
**Types**: BuildDialog local interface needs update

### Dependencies & Blockers
None - this is a self-contained bug fix in BuildDialog.tsx

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Low-Medium
**Effort**: 2-3 hours
**Risk**: Low - isolated changes to one component

### Patterns Identified
**Primary**: `/home/pbrown/SkuInventory/src/components/features/ReceiptDialog.tsx`
- Clean layout with `sm:max-w-[425px]`
- Simple SelectItem content (text only)
- Clear visual hierarchy

**Secondary**: `/home/pbrown/SkuInventory/src/components/features/AdjustmentDialog.tsx`
- Similar form structure
- Good spacing with `grid gap-4 py-4`

### Ripple Effect Analysis
**Files Identified**: 1 file

| File | Why Affected |
|------|--------------|
| `src/components/features/BuildDialog.tsx` | Primary bug fix and UI improvements |

**Note**: QuickEntryForm.tsx has similar `hasActiveBom` in interface but doesn't filter by it (no bug there).

---

## Executive Summary
Fix critical bug where SKU dropdown shows no options (filter checks non-existent `hasActiveBom` instead of `activeBom`), and improve dialog layout for better readability by simplifying SelectItem content and adding clearer visual structure.

---

## Phase 1: Fix Critical SKU Dropdown Bug

### Subtask 1.1: Update SKUOption Interface
**File**: `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx`
**Pattern**: Match API response format from `/api/skus/route.ts`
**Lines**: 29-35

**Instructions**:
1. Change the `SKUOption` interface to use `activeBom` instead of `hasActiveBom`:

```typescript
// BEFORE (lines 29-35):
interface SKUOption {
  id: string
  name: string
  internalCode: string
  maxBuildableUnits: number | null
  hasActiveBom: boolean
}

// AFTER:
interface SKUOption {
  id: string
  name: string
  internalCode: string
  maxBuildableUnits: number | null
  activeBom: {
    id: string
    versionName: string
    unitCost: string
  } | null
}
```

**Completion Criteria**:
- [ ] Interface matches API response structure
- [ ] TypeScript compiles without errors

### Subtask 1.2: Fix SKU Filter Logic
**File**: `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx`
**Lines**: 130-139

**Instructions**:
1. Update the filter to check `activeBom` existence instead of `hasActiveBom`:

```typescript
// BEFORE (lines 131-139):
setSkus(
  data.data.filter((sku: SKUOption) => sku.hasActiveBom).map((sku: SKUOption) => ({
    id: sku.id,
    name: sku.name,
    internalCode: sku.internalCode,
    maxBuildableUnits: sku.maxBuildableUnits,
    hasActiveBom: sku.hasActiveBom,
  }))
)

// AFTER:
setSkus(
  data.data.filter((sku: SKUOption) => sku.activeBom !== null).map((sku: SKUOption) => ({
    id: sku.id,
    name: sku.name,
    internalCode: sku.internalCode,
    maxBuildableUnits: sku.maxBuildableUnits,
    activeBom: sku.activeBom,
  }))
)
```

**Completion Criteria**:
- [ ] Filter uses `activeBom !== null` instead of `hasActiveBom`
- [ ] Mapped object includes `activeBom` property
- [ ] TypeScript compiles without errors

---

## Phase 2: Improve Dialog Layout and Readability

### Subtask 2.1: Simplify SKU SelectItem Content
**File**: `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx`
**Lines**: 445-454

**Instructions**:
1. Simplify the SKU SelectItem to use a simpler format (name followed by buildable count in parentheses), matching the pattern used in other dialogs:

```typescript
// BEFORE (lines 445-454):
{skus.map((sku) => (
  <SelectItem key={sku.id} value={sku.id}>
    <div className="flex items-center justify-between gap-2">
      <span>{sku.name}</span>
      <span className="text-xs text-muted-foreground" suppressHydrationWarning>
        ({sku.maxBuildableUnits?.toLocaleString() ?? '0'} buildable)
      </span>
    </div>
  </SelectItem>
))}

// AFTER:
{skus.map((sku) => (
  <SelectItem key={sku.id} value={sku.id}>
    <span suppressHydrationWarning>
      {sku.name} ({sku.maxBuildableUnits?.toLocaleString() ?? '0'} buildable)
    </span>
  </SelectItem>
))}
```

**Completion Criteria**:
- [ ] SelectItem content is simple text, not nested div with flex
- [ ] Buildable units still displayed
- [ ] suppressHydrationWarning preserved for toLocaleString()

### Subtask 2.2: Add Empty State Message for SKU Dropdown
**File**: `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx`
**Lines**: 444-456 (around SelectContent)

**Instructions**:
1. Add a helpful message when no SKUs with active BOMs are available:

```typescript
// AFTER SelectContent opening tag, before the map:
<SelectContent>
  {skus.length === 0 && !isLoadingSkus && (
    <div className="px-2 py-4 text-sm text-muted-foreground text-center">
      No SKUs with active BOMs found.
      <br />
      Create a BOM for your SKUs first.
    </div>
  )}
  {skus.map((sku) => (
    // ... existing SelectItem code
  ))}
</SelectContent>
```

**Completion Criteria**:
- [ ] Empty state message displayed when skus.length === 0 and not loading
- [ ] Message provides helpful guidance to user

### Subtask 2.3: Improve Form Field Spacing
**File**: `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx`
**Lines**: 313 (grid container)

**Instructions**:
1. Increase gap in the form grid from `gap-4` to `gap-5` for better readability:

```typescript
// BEFORE (line 313):
<div className="grid gap-4 py-4">

// AFTER:
<div className="grid gap-5 py-4">
```

**Completion Criteria**:
- [ ] Grid gap increased for better spacing
- [ ] Form fields have more breathing room

### Subtask 2.4: Add Section Headers for Form Groups
**File**: `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx`

**Instructions**:
1. Add a visual divider and label before the Location section (around line 519) to group related fields:

```typescript
// Add before the Location field (around line 519):
{/* Location Settings */}
<div className="col-span-4 border-t pt-4 mt-2">
  <p className="text-sm font-medium text-muted-foreground mb-4">Location Settings</p>
</div>

<div className="grid grid-cols-4 items-center gap-4">
  <Label htmlFor="location" className="text-right">
    Location
  </Label>
  // ... rest of Location select
```

**Completion Criteria**:
- [ ] Visual separator added before Location fields
- [ ] Section header provides context for location-related fields

---

## Phase 3: Validation and Testing

### Subtask 3.1: Verify TypeScript Compilation
**Instructions**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] No TypeScript errors

### Subtask 3.2: Verify Build
**Instructions**:
```bash
npm run build
```

**Completion Criteria**:
- [ ] Build completes without errors

### Subtask 3.3: Manual Testing Checklist
**Instructions**:
Test at http://172.16.20.50:2345 (test environment)

1. Navigate to SKU detail page with an active BOM
2. Click "Build" button
3. Verify:
   - [ ] SKU dropdown shows SKUs with active BOMs
   - [ ] SKU dropdown displays "name (X buildable)" format
   - [ ] If no SKUs available, helpful message is shown
   - [ ] Form fields have improved spacing
   - [ ] Location section has visual grouping
   - [ ] Dialog is easier to read overall
4. Submit a build transaction:
   - [ ] Select SKU works
   - [ ] Build completes successfully

---

## Summary of Deliverables

**Files Modified**: 1
- `src/components/features/BuildDialog.tsx`

**Changes**:
1. Fix `SKUOption` interface to match API response (`activeBom` instead of `hasActiveBom`)
2. Fix filter logic to use `activeBom !== null`
3. Simplify SelectItem content (remove nested flex div)
4. Add empty state message for SKU dropdown
5. Increase form grid gap for better spacing
6. Add section header for Location fields

---

## Handoff to Build Agent
1. Execute subtasks in exact order (Phase 1 before Phase 2)
2. The critical fix is Phase 1 - SKU dropdown must work
3. Phase 2 improves UX but is secondary to functionality
4. Test completion criteria after each subtask
5. Run TypeScript check and build verification before testing

## Test Strategy Note
- Use manual testing for UI changes
- Verify at test environment http://172.16.20.50:2345
- Do NOT modify production database (port 4546)

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 10m |
| **Total** | **30m** |
