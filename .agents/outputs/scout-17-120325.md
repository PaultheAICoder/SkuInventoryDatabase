# Scout Report: Add inventory snapshot import from Excel (XLSX) files

## Request Analysis
**Type**: Feature
**Source**: GitHub Issue #17
**Priority**: Medium

## Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="import|xlsx|snapshot"`

## Issue Validation
**Status**: Valid
**Recent Changes**:
- Issue #8 (closed Dec 2) implemented initial inventory CSV import
- Recent commit d7951f2: "feat(issue #8): add initial inventory import & opening balance transactions"
- Issue #7 (closed Dec 2) added comprehensive test coverage for import/export

The issue is valid and builds directly on the existing CSV import infrastructure. The request for XLSX support is a logical extension of the CSV import functionality that was just implemented.

## Current State

### Existing Import Infrastructure
**Status**: ROBUST - Comprehensive CSV import system already in place

1. **Database Models**: All required models exist
   - Component model (Prisma schema lines 93-119)
   - Transaction model with 'initial' type
   - TransactionLine model for component quantity changes

2. **Services Layer**: `/home/pbrown/SkuInventory/src/services/import.ts`
   - CSV parsing: `parseCSV()` function with quote handling (lines 27-71)
   - Header normalization: `normalizeHeader()` (lines 76-82)
   - Component import: `processComponentImport()` (lines 295-323)
   - Initial inventory import: `processInitialInventoryImport()` (lines 361-389)
   - Template generation: `generateComponentTemplate()`, `generateInitialInventoryTemplate()`
   - Import result types: `ImportResult<T>`, `ImportSummary<T>` (lines 10-22)

3. **API Routes**: Working CSV import endpoints
   - `/home/pbrown/SkuInventory/src/app/api/import/components/route.ts` - Component CSV import
   - `/home/pbrown/SkuInventory/src/app/api/import/initial-inventory/route.ts` - Initial inventory CSV import
   - `/home/pbrown/SkuInventory/src/app/api/import/template/[type]/route.ts` - Template download
   - Pattern: multipart/form-data file upload, validation, error collection, result summary

4. **Transaction Creation**: `/home/pbrown/SkuInventory/src/services/inventory.ts`
   - `createInitialTransaction()` function (lines 229-305)
   - Handles Prisma transactions, cost updates, component lookup
   - Returns structured transaction result

5. **UI Components**: Reusable import interface
   - `/home/pbrown/SkuInventory/src/components/features/ImportForm.tsx` - File upload with template download
   - `/home/pbrown/SkuInventory/src/components/features/ImportResultDialog.tsx` - Results display
   - `/home/pbrown/SkuInventory/src/app/(dashboard)/import/page.tsx` - Existing import page with 3 import types

6. **Type Safety**: Full TypeScript schemas
   - Zod validation schemas in `src/services/import.ts`
   - Component types in `/home/pbrown/SkuInventory/src/types/component.ts`
   - API response types defined

### What Does NOT Exist

1. **XLSX Package**: NOT installed
   - `npm list xlsx` returns empty
   - No xlsx imports found in codebase
   - **BLOCKER**: Must install `xlsx` (SheetJS) package

2. **XLSX Parsing Service**: No XLSX-specific parsing logic
   - Need XLSX file reading function
   - Need sheet-to-rows conversion
   - Need column mapping for non-standard formats

3. **Auto-SKU Generation**: No SKU code generation function
   - Issue specifies auto-generating SKU codes from item names
   - Example: "3pk IFU" → "3PK-IFU"
   - No existing pattern for this in codebase

4. **Filename Date Extraction**: No date parsing from filenames
   - Issue wants to extract date from `2025-11-13_TonsilTech_Inventory.xlsx`
   - Not currently implemented

5. **Component Auto-Creation**: No "create-if-not-exists" pattern
   - Current initial-inventory import expects components to exist
   - Issue wants to create components if they don't exist
   - Need combined component creation + initial transaction logic

6. **Preview/Dry-Run**: No import preview functionality
   - Issue requests preview before committing
   - Current implementation directly imports
   - Need two-phase: parse → preview → commit

7. **Duplicate Handling Strategy**: No configurable duplicate handling
   - Issue wants configurable: skip/update/error
   - Current implementation always skips duplicates
   - Need user-selectable strategy

## Dependencies & Blockers

### Must Install
1. **xlsx package** (SheetJS)
   ```bash
   npm install xlsx
   npm install --save-dev @types/xlsx
   ```

### No Other Blockers
All other infrastructure exists:
- Database schema: Ready
- Transaction creation: Ready (`createInitialTransaction`)
- Component creation: Pattern exists in `/home/pbrown/SkuInventory/src/app/api/components/route.ts`
- UI components: Reusable
- API patterns: Established

**Can Proceed?**: YES - After installing xlsx package

## Complexity Assessment
**Complexity**: Moderate
**Effort**: 8-12 hours
**Risk**: Low

### Breakdown
- **XLSX Parsing Service** (2-3 hours): New service function, sheet reading, column mapping
- **SKU Code Generation** (1-2 hours): Algorithm implementation, validation, uniqueness checks
- **Snapshot Import API** (2-3 hours): New endpoint, component auto-creation, transaction creation
- **Preview Functionality** (2-3 hours): Two-phase flow, preview response format, UI updates
- **Testing** (1-2 hours): Unit tests for SKU generation, integration tests for import flow

**Risk Factors**:
- Low: Building on proven CSV import patterns
- Low: XLSX library is mature and well-documented
- Medium: Preview feature adds complexity to flow

## Patterns to Follow

### Primary Patterns

1. **Import Service Pattern**: `/home/pbrown/SkuInventory/src/services/import.ts`
   - Copy structure: parse → validate → transform → results
   - Use same `ImportResult<T>` and `ImportSummary<T>` types
   - Follow CSV parsing approach but adapt for XLSX

2. **API Route Pattern**: `/home/pbrown/SkuInventory/src/app/api/import/initial-inventory/route.ts`
   - File upload handling (multipart/form-data)
   - Session/auth checks
   - Brand lookup
   - Row-by-row processing with error collection
   - Return structured `ImportResult`

3. **Transaction Creation**: `/home/pbrown/SkuInventory/src/services/inventory.ts`
   - Use `createInitialTransaction()` (lines 229-305)
   - Prisma transaction wrapper
   - Cost snapshot handling

4. **Component Creation**: `/home/pbrown/SkuInventory/src/app/api/components/route.ts`
   - Brand scoping
   - Duplicate checking
   - Validation with `createComponentSchema`

### Secondary Patterns

5. **UI Component**: `/home/pbrown/SkuInventory/src/components/features/ImportForm.tsx`
   - Extend to support `.xlsx` file extension
   - Reuse for inventory-snapshot import type

6. **Results Display**: `/home/pbrown/SkuInventory/src/components/features/ImportResultDialog.tsx`
   - Already supports all import types
   - Add 'inventory-snapshot' type if needed

## Files to Create

### Service Layer
1. `/home/pbrown/SkuInventory/src/services/xlsx-import.ts`
   - Purpose: XLSX file parsing and conversion to rows
   - Functions: `parseXLSX()`, `extractDateFromFilename()`, `generateSkuCode()`
   - Pattern: Similar to `src/services/import.ts` but for XLSX

### API Routes
2. `/home/pbrown/SkuInventory/src/app/api/import/inventory-snapshot/route.ts`
   - Purpose: Handle XLSX upload, parse, create components + initial transactions
   - Methods: POST (with optional `preview=true` query param)
   - Pattern: Follow `/home/pbrown/SkuInventory/src/app/api/import/initial-inventory/route.ts`

### UI Components
3. `/home/pbrown/SkuInventory/src/components/features/InventorySnapshotImportDialog.tsx` (OPTIONAL)
   - Purpose: Specialized dialog for snapshot import with preview
   - Alternative: Extend existing ImportForm component
   - Decision: Recommend extending ImportForm rather than new component

### Types (OPTIONAL)
4. `/home/pbrown/SkuInventory/src/types/xlsx-import.ts` (OPTIONAL)
   - Purpose: Type definitions for snapshot import
   - Alternative: Add to existing `src/services/import.ts`
   - Decision: Add to existing file for consistency

## Files to Modify

### Service Layer
1. `/home/pbrown/SkuInventory/src/services/import.ts`
   - Add: `InventorySnapshotRowData` type
   - Add: `generateSkuCode()` utility function
   - Add: `extractDateFromFilename()` utility function
   - Reason: Keep all import-related types and utilities together

### UI Components
2. `/home/pbrown/SkuInventory/src/components/features/ImportForm.tsx`
   - Modify: Line 90 - Change `accept=".csv"` to `accept=".csv,.xlsx"`
   - Add: Handle 'inventory-snapshot' import type
   - Reason: Support XLSX file uploads

3. `/home/pbrown/SkuInventory/src/components/features/ImportResultDialog.tsx`
   - Add: Case for 'inventory-snapshot' type in `getTypeLabels()` (lines 70-79)
   - Reason: Display correct labels for snapshot imports

4. `/home/pbrown/SkuInventory/src/app/(dashboard)/import/page.tsx`
   - Add: New ImportForm section for inventory-snapshot
   - Add: State for inventory-snapshot results
   - Add: Handler for inventory-snapshot import
   - Reason: Expose new import type in UI

### Dependencies
5. `/home/pbrown/SkuInventory/package.json`
   - Add: `"xlsx": "^0.18.5"` to dependencies
   - Add: `"@types/xlsx": "^0.0.36"` to devDependencies (if not auto-installed)
   - Reason: Required for XLSX parsing

### Template Route (OPTIONAL)
6. `/home/pbrown/SkuInventory/src/app/api/import/template/[type]/route.ts`
   - Add: Case for 'inventory-snapshot' to generate XLSX template
   - Alternative: Keep CSV template for simplicity
   - Decision: Recommend CSV template initially, XLSX later if needed

## Final Sweep Results

### Services Search
**Files in src/services/**:
- `/home/pbrown/SkuInventory/src/services/import.ts` - Will be extended with utilities
- `/home/pbrown/SkuInventory/src/services/inventory.ts` - Uses `createInitialTransaction` (no changes needed)

### API Routes
**Usages in src/app/api/**:
- `/home/pbrown/SkuInventory/src/app/api/import/components/route.ts` - Reference pattern
- `/home/pbrown/SkuInventory/src/app/api/import/initial-inventory/route.ts` - Primary reference
- `/home/pbrown/SkuInventory/src/app/api/import/template/[type]/route.ts` - May need update
- `/home/pbrown/SkuInventory/src/app/api/components/route.ts` - Component creation pattern

### Type Definitions
**Types affected**:
- `/home/pbrown/SkuInventory/src/types/component.ts` - `createComponentSchema` used for validation
- `/home/pbrown/SkuInventory/src/services/import.ts` - `ImportResult`, `ImportSummary` types reused

### Components
**Components using import code**:
- `/home/pbrown/SkuInventory/src/components/features/ImportForm.tsx` - Needs XLSX support
- `/home/pbrown/SkuInventory/src/components/features/ImportResultDialog.tsx` - Needs snapshot type
- `/home/pbrown/SkuInventory/src/app/(dashboard)/import/page.tsx` - Needs snapshot section

### Test Files
**Test files to create/update**:
- No existing tests found for import services (based on issue #7)
- Need to create: `tests/services/xlsx-import.test.ts`
- Need to create: `tests/api/import/inventory-snapshot.test.ts`

### All Affected Files (Comprehensive List)

**NEW FILES** (3):
1. `/home/pbrown/SkuInventory/src/services/xlsx-import.ts` - XLSX parsing service
2. `/home/pbrown/SkuInventory/src/app/api/import/inventory-snapshot/route.ts` - Snapshot import API
3. `/home/pbrown/SkuInventory/tests/services/xlsx-import.test.ts` - Unit tests

**MODIFIED FILES** (5):
1. `/home/pbrown/SkuInventory/package.json` - Add xlsx dependency
2. `/home/pbrown/SkuInventory/src/services/import.ts` - Add utilities
3. `/home/pbrown/SkuInventory/src/components/features/ImportForm.tsx` - XLSX file support
4. `/home/pbrown/SkuInventory/src/components/features/ImportResultDialog.tsx` - Snapshot type label
5. `/home/pbrown/SkuInventory/src/app/(dashboard)/import/page.tsx` - Add snapshot import section

**REFERENCE FILES** (No changes, used as patterns):
1. `/home/pbrown/SkuInventory/src/app/api/import/initial-inventory/route.ts` - Primary API pattern
2. `/home/pbrown/SkuInventory/src/app/api/import/components/route.ts` - Component creation pattern
3. `/home/pbrown/SkuInventory/src/services/inventory.ts` - Transaction creation
4. `/home/pbrown/SkuInventory/src/types/component.ts` - Validation schemas

**TOTAL FILES AFFECTED**: 8 files (3 new, 5 modified)

## Acceptance Criteria

From issue #17:

- [ ] Can upload XLSX file via UI
- [ ] Components created with auto-generated SKU codes
- [ ] `initial` transactions created with correct quantities
- [ ] Date extracted from filename when available
- [ ] Preview shows what will be imported before committing
- [ ] Handles duplicate item names (configurable: skip/update/error)
- [ ] Import summary shows success/failure counts
- [ ] Existing component import still works (no regression)
- [ ] All tests passing, build succeeds without warnings

## Implementation Notes

### SKU Code Generation Algorithm
Per issue specification:
```typescript
function generateSkuCode(itemName: string): string {
  return itemName
    .toUpperCase()
    .replace(/[^A-Z0-9\s]/g, '')  // Remove special chars
    .trim()
    .split(/\s+/)
    .map(word => word.slice(0, 4))  // First 4 chars of each word
    .join('-')
    .slice(0, 20);  // Max 20 chars
}
```

Examples:
- "3pk IFU" → "3PK-IFU"
- "Bubble Mailers" → "BUBB-MAIL"
- "Large tools" → "LARG-TOOL"

### Expected XLSX Format
From sample files in project root:
- Column 1: `Item` (item name)
- Column 2: `Current Balance` (quantity)

Sample data (from `/home/pbrown/SkuInventory/2025-11-13_TonsilTech_Inventory.xlsx`):
| Item | Current Balance |
|------|-----------------|
| 3pk IFU | 5069 |
| 3pk boxes | 4525 |
| Avery labels | 4840 |

### Date Extraction Pattern
```typescript
function extractDateFromFilename(filename: string): Date | null {
  // Match pattern: YYYY-MM-DD_*
  const match = filename.match(/(\d{4})-(\d{2})-(\d{2})/);
  if (match) {
    return new Date(match[0]);
  }
  return null;
}
```

### Preview vs Commit Flow
**Option 1**: Two-step API calls
1. POST `/api/import/inventory-snapshot?preview=true` - Returns preview data
2. POST `/api/import/inventory-snapshot` - Commits import

**Option 2**: Single API with client-side confirmation
1. POST `/api/import/inventory-snapshot` - Parse and return preview
2. User confirms in dialog
3. Re-submit with `confirmed=true` param

**Recommendation**: Option 1 for cleaner separation

### Duplicate Handling Strategy
**Issue wants**: Configurable strategy (skip/update/error)

**Current behavior** (from existing imports):
- Components import: Skip duplicates, log error
- Initial inventory import: Skip if initial transaction exists

**Recommendation for MVP**:
- Phase 1: Always create components (skip if exists)
- Phase 2: Add strategy parameter later

### Integration Points
1. **Component Creation**: Use existing pattern from `/home/pbrown/SkuInventory/src/app/api/components/route.ts`
2. **Transaction Creation**: Use `createInitialTransaction` from `/home/pbrown/SkuInventory/src/services/inventory.ts`
3. **Brand Scoping**: Follow pattern from all import routes (get active brand)
4. **Error Collection**: Follow pattern from `/home/pbrown/SkuInventory/src/app/api/import/initial-inventory/route.ts`

## Handoff to Plan Agent

### Summary
Issue #17 requests Excel (XLSX) file import for inventory snapshots, building on the recently-completed CSV import infrastructure (issue #8). The existing system provides robust CSV import with file upload, validation, error handling, and UI components. This feature extends that infrastructure to support XLSX files with TonsilTech's format (Item, Current Balance columns), auto-generate SKU codes from item names, extract dates from filenames, and create both components and initial transactions in one import.

The main blocker is the missing `xlsx` package, which must be installed. All other required infrastructure exists: database models, transaction creation services, API patterns, and UI components. The feature is well-scoped with clear examples and sample data files in the project root.

### Key Points
1. **Strong Foundation**: Robust CSV import system just completed (issue #8, closed Dec 2)
2. **One Blocker**: Must install `xlsx` package before implementation
3. **Clear Scope**: Well-defined in issue with examples, sample files, and acceptance criteria
4. **Reusable Patterns**: Can follow existing import routes and services closely
5. **Moderate Complexity**: 8-12 hours, mostly new service for XLSX parsing and SKU generation
6. **Low Risk**: Building on proven patterns, mature XLSX library
7. **Phase Approach**: MVP can skip preview/duplicate-strategy for faster delivery

### Suggested Phases

**Phase 1: Core XLSX Import** (4-5 hours)
- Install xlsx package
- Create `src/services/xlsx-import.ts` with parseXLSX, generateSkuCode, extractDateFromFilename
- Create `/api/import/inventory-snapshot` route
- Basic component auto-creation + initial transaction logic
- Update ImportForm to accept .xlsx files

**Phase 2: UI Integration** (2-3 hours)
- Add inventory-snapshot section to import page
- Update ImportResultDialog for snapshot type
- Test with sample files from project root
- Error handling and validation

**Phase 3: Preview & Polish** (2-3 hours)
- Implement preview functionality
- Add duplicate handling strategy
- Comprehensive testing
- Documentation

**Phase 4: Testing** (1-2 hours)
- Unit tests for SKU generation
- Integration tests for snapshot import
- Test with both sample XLSX files
- Regression test existing CSV imports

## Performance Metrics

| Phase | Duration |
|-------|----------|
| Issue Parsing | 2m |
| Codebase Exploration | 8m |
| Pattern Identification | 5m |
| Report Writing | 12m |
| **Total** | **27m** |

---

**AGENT_RETURN**: scout-17-120325
