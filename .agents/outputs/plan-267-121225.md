# Implementation Plan
**Generated**: 2025-12-12T19:00:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: Issue #267
**Estimated Build Time**: 2-3 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Feature + Verification
**Source**: GitHub Issue #267
**Priority**: Medium

### Task Classification
**Category**: NEW_FEATURE + VERIFICATION
**Test Strategy**: FAST_PATH (isolated changes, existing patterns)
**Suggested Filter**: None (manual testing recommended)

### Issue Validation
**Status**: Valid
**Recent Changes**: Part of 002-ads-data-ingestion branch, related to Phase 9 tasks T070-T071

### Current State Assessment

#### T070: Add Integrations Link to Navigation

**Existing Components:**
- Navigation defined in: `/home/pbrown/SkuInventory/src/app/(dashboard)/layout.tsx`
- Integrations page exists at: `/home/pbrown/SkuInventory/src/app/(dashboard)/integrations/page.tsx` (functional)
- Legacy placeholder exists at: `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/integrations/page.tsx` (deprecated V2 placeholder)

**Current Navigation Array (line 35-50):**
```typescript
const navigation = [
  { name: 'Dashboard', href: '/', icon: LayoutDashboard },
  { name: 'Components', href: '/components', icon: Package },
  { name: 'SKUs', href: '/skus', icon: Boxes },
  { name: 'Transactions', href: '/transactions', icon: ArrowLeftRight },
  { name: 'Lots', href: '/lots', icon: Layers },
  { name: 'Import', href: '/import', icon: Upload },
  { name: 'Analytics', href: '/analytics/defects', icon: BarChart3 },
  { name: 'Forecasts', href: '/forecasts', icon: TrendingDown },
  { name: 'Users', href: '/settings/users', icon: Users, adminOnly: true },
  { name: 'Locations', href: '/settings/locations', icon: MapPin, adminOnly: true },
  { name: 'Brands', href: '/settings/brands', icon: Tag, adminOnly: true },
  { name: 'Categories', href: '/settings/categories', icon: FolderTree, adminOnly: true },
  { name: 'Companies', href: '/settings/companies', icon: Building2, adminOnly: true },
  { name: 'Settings', href: '/settings', icon: Settings, adminOnly: true },
]
```

**Available Icons (confirmed in lucide-react):**
- `Plug` - standard plug icon (recommended)
- `Plug2` - alternate plug icon
- `Link2` - link icon (alternative)
- `Cable` - cable icon (alternative)

#### T071: API Route Authorization Audit

**Routes Analyzed - Authorization Status:**

| Route | File | Current Auth | Required Auth | Status |
|-------|------|-------------|---------------|--------|
| `/api/integrations/amazon-ads/connect` | connect/route.ts | session + admin check | admin | OK |
| `/api/integrations/amazon-ads/disconnect` | disconnect/route.ts | session + admin check | admin | OK |
| `/api/integrations/amazon-ads/sync` | sync/route.ts | session + admin/ops check | admin, ops | OK |
| `/api/integrations/amazon-ads/status` | status/route.ts | session only | authenticated user | OK |
| `/api/integrations/amazon-ads/callback` | callback/route.ts | OAuth state validation | OAuth callback | OK (special) |
| `/api/integrations/shopify/connect` | connect/route.ts | session + userCompany.role=admin | admin | OK |
| `/api/integrations/shopify/disconnect` | disconnect/route.ts | session + userCompany.role=admin | admin | OK |
| `/api/integrations/shopify/sync` | sync/route.ts | session + company validation | authenticated user | NEEDS REVIEW |
| `/api/integrations/shopify/status` | status/route.ts | session + company validation | authenticated user | OK |
| `/api/integrations/shopify/callback` | callback/route.ts | OAuth state validation | OAuth callback | OK (special) |
| `/api/csv/upload` (POST/GET) | upload/route.ts | session + company validation | admin, ops | NEEDS ROLE CHECK |
| `/api/asin-mapping` (GET/POST) | route.ts | session + company validation | admin (issue says admin) | NEEDS ROLE CHECK |
| `/api/asin-mapping/[id]` (DELETE) | [id]/route.ts | session + admin check | admin | OK |
| `/api/notifications` (GET/POST) | route.ts | session + user-scoped | authenticated user (own) | OK |
| `/api/notifications/[id]` (PATCH) | [id]/route.ts | session + user validation | authenticated user (own) | OK |
| `/api/sales-daily` (GET) | route.ts | session + company validation | authenticated user | OK |
| `/api/sync-logs` (GET) | route.ts | session + company filter | admin, ops | NEEDS ROLE CHECK |
| `/api/cron/ads-sync` | ads-sync/route.ts | CRON_SECRET header | CRON_SECRET only | OK |
| `/api/cron/alerts` | alerts/route.ts | Bearer CRON_SECRET | CRON_SECRET only | OK |
| `/api/cron/email-monitor` | email-monitor/route.ts | Bearer CRON_SECRET | CRON_SECRET only | OK |
| `/api/cron/retention-cleanup` | retention-cleanup/route.ts | X-Cron-Secret header | CRON_SECRET only | OK |

### Dependencies & Blockers
1. No blockers - all patterns exist
2. `Plug` icon available in lucide-react (confirmed)

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Simple
**Effort**: 2-3 hours
**Risk**: Low

### Patterns Identified
**Primary**: `/home/pbrown/SkuInventory/src/app/(dashboard)/layout.tsx` lines 44-49 (adminOnly navigation items pattern)
**Secondary**: `/home/pbrown/SkuInventory/src/app/api/integrations/amazon-ads/connect/route.ts` (admin-only API route pattern)
**Tertiary**: `/home/pbrown/SkuInventory/src/app/api/integrations/amazon-ads/sync/route.ts` (admin+ops role check pattern)

### Ripple Effect Analysis
**Files Affected**: 5 files
- `/home/pbrown/SkuInventory/src/app/(dashboard)/layout.tsx` - Add navigation link
- `/home/pbrown/SkuInventory/src/app/api/integrations/shopify/sync/route.ts` - Add role check (admin, ops)
- `/home/pbrown/SkuInventory/src/app/api/csv/upload/route.ts` - Add role check (admin, ops)
- `/home/pbrown/SkuInventory/src/app/api/asin-mapping/route.ts` - Add admin role check for POST
- `/home/pbrown/SkuInventory/src/app/api/sync-logs/route.ts` - Add role check (admin, ops)

---

## Executive Summary

This issue implements two tasks:
1. **T070**: Add "Integrations" navigation link to the dashboard sidebar with `adminOnly: true` using the `Plug` icon from lucide-react
2. **T071**: Audit and fix authorization gaps in 4 API routes that currently allow any authenticated user but should restrict to admin/ops roles

## Phase 1: Add Integrations Navigation Link (T070)

### Subtask 1.1: Import Plug Icon
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/layout.tsx`
**Pattern**: Follow existing lucide-react imports on lines 9-27
**Instructions**:
1. Add `Plug` to the lucide-react import statement
2. Location: Add alphabetically in the import list

**Code Change**:
```typescript
// Change line 9-27 import from:
import {
  LayoutDashboard,
  Package,
  Boxes,
  ArrowLeftRight,
  Upload,
  BarChart3,
  Settings,
  Users,
  MapPin,
  LogOut,
  Menu,
  X,
  Layers,
  Building2,
  TrendingDown,
  Tag,
  FolderTree,
} from 'lucide-react'

// To (add Plug):
import {
  LayoutDashboard,
  Package,
  Boxes,
  ArrowLeftRight,
  Upload,
  BarChart3,
  Settings,
  Users,
  MapPin,
  LogOut,
  Menu,
  X,
  Layers,
  Building2,
  TrendingDown,
  Tag,
  FolderTree,
  Plug,  // ADD THIS
} from 'lucide-react'
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run lint
```

**Completion Criteria**:
- [ ] `Plug` icon imported without TypeScript errors

### Subtask 1.2: Add Integrations to Navigation Array
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/layout.tsx`
**Pattern**: Follow `adminOnly: true` pattern from Users, Locations, etc. (lines 44-49)
**Instructions**:
1. Add Integrations entry to navigation array
2. Position after Forecasts, before Users (logical grouping)
3. Set `adminOnly: true` - only admins manage integrations

**Code Change** (add after line 43, before line 44):
```typescript
const navigation = [
  { name: 'Dashboard', href: '/', icon: LayoutDashboard },
  { name: 'Components', href: '/components', icon: Package },
  { name: 'SKUs', href: '/skus', icon: Boxes },
  { name: 'Transactions', href: '/transactions', icon: ArrowLeftRight },
  { name: 'Lots', href: '/lots', icon: Layers },
  { name: 'Import', href: '/import', icon: Upload },
  { name: 'Analytics', href: '/analytics/defects', icon: BarChart3 },
  { name: 'Forecasts', href: '/forecasts', icon: TrendingDown },
  { name: 'Integrations', href: '/integrations', icon: Plug, adminOnly: true },  // ADD THIS LINE
  { name: 'Users', href: '/settings/users', icon: Users, adminOnly: true },
  // ... rest unchanged
]
```

**Validation Commands**:
```bash
npm run build
npm run lint
```

**Completion Criteria**:
- [ ] Build succeeds without errors
- [ ] Integrations link appears for admin users
- [ ] Integrations link hidden for non-admin users

---

## Phase 2: API Route Authorization Fixes (T071)

### Subtask 2.1: Add Role Check to Shopify Sync Route
**File**: `/home/pbrown/SkuInventory/src/app/api/integrations/shopify/sync/route.ts`
**Pattern**: Follow Amazon Ads sync pattern from `/home/pbrown/SkuInventory/src/app/api/integrations/amazon-ads/sync/route.ts` lines 22-28
**Instructions**:
1. Add role check after userCompany validation (around line 37)
2. Allow admin and ops roles only

**Code Change** (add after line 37, before line 40):
```typescript
// After userCompany validation (line 37), add:

// Admin or Ops only (sync can be triggered by ops team)
if (userCompany.role !== 'admin' && userCompany.role !== 'ops') {
  return NextResponse.json(
    { error: 'Admin or Ops permission required' },
    { status: 403 }
  )
}
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run lint
```

**Completion Criteria**:
- [ ] Route returns 403 for users without admin/ops role
- [ ] No TypeScript errors

### Subtask 2.2: Add Role Check to CSV Upload Route
**File**: `/home/pbrown/SkuInventory/src/app/api/csv/upload/route.ts`
**Pattern**: Follow Amazon Ads sync pattern for role check
**Instructions**:
1. Add userCompany role query to existing findFirst (line 27-33)
2. Add role check after company validation

**Code Change**:

First, update the userCompany query to include role (around line 27):
```typescript
// Change from:
const userCompany = await prisma.userCompany.findFirst({
  where: {
    userId: session.user.id,
    isPrimary: true,
  },
  select: { companyId: true },
})

// To (add role to select):
const userCompany = await prisma.userCompany.findFirst({
  where: {
    userId: session.user.id,
    isPrimary: true,
  },
  select: { companyId: true, role: true },
})
```

Then add role check after line 40 (after userCompany.companyId check):
```typescript
// Admin or Ops only for file uploads
if (userCompany.role !== 'admin' && userCompany.role !== 'ops') {
  return NextResponse.json(
    { error: 'Admin or Ops permission required' },
    { status: 403 }
  )
}
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run lint
```

**Completion Criteria**:
- [ ] POST route returns 403 for users without admin/ops role
- [ ] GET route returns 403 for users without admin/ops role (info endpoint follows same pattern)
- [ ] No TypeScript errors

### Subtask 2.3: Add Role Check to ASIN Mapping POST Route
**File**: `/home/pbrown/SkuInventory/src/app/api/asin-mapping/route.ts`
**Pattern**: Follow DELETE route pattern from `[id]/route.ts` lines 29-44
**Instructions**:
1. Add role query to userCompany in POST function
2. Add admin-only check for creating mappings (per issue requirement)

**Code Change**:

Update userCompany query in POST function (around line 218-223):
```typescript
// Change from:
const userCompany = await prisma.userCompany.findFirst({
  where: { userId: session.user.id, isPrimary: true },
  select: { companyId: true },
})

// To (add role):
const userCompany = await prisma.userCompany.findFirst({
  where: { userId: session.user.id, isPrimary: true },
  select: { companyId: true, role: true },
})
```

Add admin check after userCompany validation (after line 225):
```typescript
// Only admin can create ASIN mappings
if (userCompany.role !== 'admin') {
  return NextResponse.json(
    { error: 'Only admins can create ASIN mappings' },
    { status: 403 }
  )
}
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run lint
```

**Completion Criteria**:
- [ ] POST route returns 403 for non-admin users
- [ ] GET route remains accessible to any authenticated user (read-only is fine)
- [ ] No TypeScript errors

### Subtask 2.4: Add Role Check to Sync Logs Route
**File**: `/home/pbrown/SkuInventory/src/app/api/sync-logs/route.ts`
**Pattern**: Follow Amazon Ads sync pattern
**Instructions**:
1. Add role check for admin/ops users
2. Sync logs should be viewable by admin and ops (operational data)

**Code Change** (add after session check, around line 19):
```typescript
// After session check, add role check:
if (!session?.user) {
  return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
}

// Admin or Ops only for viewing sync logs
if (session.user.role !== 'admin' && session.user.role !== 'ops') {
  return NextResponse.json(
    { error: 'Admin or Ops permission required' },
    { status: 403 }
  )
}
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run lint
```

**Completion Criteria**:
- [ ] Route returns 403 for users without admin/ops role
- [ ] No TypeScript errors

---

## Phase 3: Verification

### Subtask 3.1: Build Verification
**Instructions**:
1. Run full build
2. Verify no TypeScript errors
3. Verify no lint warnings

**Validation Commands**:
```bash
npm run build
npx tsc --noEmit
npm run lint
```

**Completion Criteria**:
- [ ] `npm run build` succeeds
- [ ] `npx tsc --noEmit` reports no errors
- [ ] `npm run lint` reports no warnings

### Subtask 3.2: Manual Testing Checklist
**Instructions**:
Test in browser at http://172.16.20.50:2345 (test environment)

**T070 Tests**:
- [ ] Login as admin user - Integrations link visible in sidebar
- [ ] Login as non-admin user - Integrations link NOT visible
- [ ] Click Integrations link - navigates to /integrations page
- [ ] Integrations link shows Plug icon

**T071 Tests** (use curl or browser dev tools):
- [ ] POST /api/integrations/shopify/sync as non-admin/non-ops - returns 403
- [ ] POST /api/csv/upload as non-admin/non-ops - returns 403
- [ ] POST /api/asin-mapping as non-admin - returns 403
- [ ] GET /api/sync-logs as non-admin/non-ops - returns 403

---

## Summary of Deliverables
**Files Created**: 0
**Files Modified**: 5
1. `/home/pbrown/SkuInventory/src/app/(dashboard)/layout.tsx` - Add Plug import and Integrations nav item
2. `/home/pbrown/SkuInventory/src/app/api/integrations/shopify/sync/route.ts` - Add admin/ops role check
3. `/home/pbrown/SkuInventory/src/app/api/csv/upload/route.ts` - Add admin/ops role check
4. `/home/pbrown/SkuInventory/src/app/api/asin-mapping/route.ts` - Add admin role check to POST
5. `/home/pbrown/SkuInventory/src/app/api/sync-logs/route.ts` - Add admin/ops role check

## Handoff to Build Agent
1. Execute subtasks in exact order (Phase 1 -> Phase 2 -> Phase 3)
2. Validate each file modification before proceeding
3. Run `npm run build` after Phase 1 and Phase 2 complete
4. Follow reference patterns exactly - do not add extra functionality

## Test Strategy Note
- No automated tests needed for navigation changes
- Authorization changes can be verified with manual curl tests
- Build and TypeScript checks are sufficient for validation

## Authorization Summary Table (Final State)

| Route | Required Role | Verification Method |
|-------|--------------|---------------------|
| `/api/integrations/amazon-ads/connect` | admin | Already correct |
| `/api/integrations/amazon-ads/disconnect` | admin | Already correct |
| `/api/integrations/amazon-ads/sync` | admin, ops | Already correct |
| `/api/integrations/amazon-ads/status` | authenticated | Already correct |
| `/api/integrations/shopify/connect` | admin | Already correct |
| `/api/integrations/shopify/disconnect` | admin | Already correct |
| `/api/integrations/shopify/sync` | admin, ops | **TO BE FIXED** |
| `/api/integrations/shopify/status` | authenticated | Already correct |
| `/api/csv/upload` | admin, ops | **TO BE FIXED** |
| `/api/asin-mapping` (GET) | authenticated | Already correct |
| `/api/asin-mapping` (POST) | admin | **TO BE FIXED** |
| `/api/asin-mapping/[id]` (DELETE) | admin | Already correct |
| `/api/notifications/*` | authenticated (own) | Already correct |
| `/api/sales-daily` | authenticated | Already correct |
| `/api/sync-logs` | admin, ops | **TO BE FIXED** |
| `/api/cron/*` | CRON_SECRET | Already correct |

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 10m |
| **Total** | **30m** |
