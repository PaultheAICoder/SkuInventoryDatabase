# Implementation Plan
**Generated**: 2026-01-04 (Scout-and-Plan Agent)
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #363
**Estimated Build Time**: 3-4 hours
**Complexity**: Moderate

---

## Investigation Summary

### Request Analysis
**Type**: Feature (Database Schema Extension)
**Source**: GitHub Issue #363
**Priority**: P1-MVP (Shopify Integration Phase 2 Foundation)

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED (migration verification, TypeScript compilation)
**Suggested Filter**: None (no existing tests for new models)

### Issue Validation
**Status**: Valid
**Recent Changes**:
- `c27efa9` (Dec 30): Added Recommendation Engine schema - shows pattern for adding new enums/models
- `b9c811a` (Dec 15): Amazon Ads & Shopify foundation - created existing ShopifyConnection/ShopifyOrder models

### Current State Assessment

**Existing Shopify Models (in `prisma/schema.prisma`):**
- `ShopifyConnection` (lines 593-609) - OAuth connection to Shopify store
- `ShopifyOrder` (lines 611-632) - Synced orders from Shopify
- `ShopifyOrderLine` (lines 634-649) - Line items within orders
- `SkuChannelMapping` (lines 651-667) - Maps external IDs to internal SKUs
- `ShopifyOrderStatus` enum (lines 292-298) - Order workflow status

**Existing TypeScript Types (in `src/types/`):**
- `src/types/shopify.ts` - API response types (ShopifyProduct, ShopifyVariant already exist as API types)
- `src/types/shopify-connection.ts` - Connection management types
- `src/types/shopify-sync.ts` - Sync operation types
- `src/types/channel-mapping.ts` - Mapping types

**NEW Models Required (from `specs/002-shopify-integration/data-model.md`):**
1. `ShopifyProductStatus` enum - ACTIVE, DRAFT, ARCHIVED
2. `ShopifyProduct` model - Products synced from Shopify
3. `ShopifyVariant` model - Variants of Shopify products
4. `ShopifyCustomer` model - Customer records from Shopify
5. `ChannelDailySales` model - Cross-channel sales aggregation
6. `ChannelMarketingSpend` model - Manual marketing spend entry

**Extended Models Required:**
- `ShopifyOrder` - Add `customerId` FK to `ShopifyCustomer`
- `ShopifyConnection` - Add `products`, `customers` relations
- `Brand` - Add `channelDailySales`, `channelMarketingSpend` relations
- `SKU` - Add `channelDailySales` relation

### Dependencies & Blockers
1. **Database Access**: Test database confirmed accessible (inventory_test on port 2346)
2. **No Blockers**: All prerequisite models exist in schema

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Moderate
**Effort**: 3-4 hours
**Risk**: Low (schema extensions only, no breaking changes to existing models)

### Patterns Identified
**Primary Pattern**: `prisma/schema.prisma` lines 1067-1165 (Recommendation Engine models)
- Shows enum definition pattern
- Shows model with FK relations pattern
- Shows index and unique constraint patterns

**Secondary Pattern**: `prisma/schema.prisma` lines 593-667 (existing Shopify models)
- Shows ShopifyConnection relation pattern
- Shows cascade delete pattern for child models

### Ripple Effect Analysis
**Files Identified**: 5

| File | Reason Affected |
|------|-----------------|
| `prisma/schema.prisma` | Add new models, extend existing models |
| `src/types/shopify.ts` | Add TypeScript interfaces for new DB models |
| `prisma/migrations/` | New migration file created |
| `src/types/index.ts` | May need exports for new types |
| `node_modules/.prisma/client` | Regenerated by `prisma generate` |

**No code changes required** - This is a pure schema extension. Services/components will be added in subsequent issues.

---

## Executive Summary

This issue extends the Prisma database schema with six new models and one enum to support complete Shopify integration: ShopifyProduct, ShopifyVariant, ShopifyCustomer for synced data, plus ChannelDailySales and ChannelMarketingSpend for cross-channel analytics. The ShopifyOrder model will be extended with a customer foreign key. TypeScript interfaces must be created to mirror the new database models.

---

## Phase 1: TypeScript Interfaces

### Subtask 1.1: Add TypeScript interfaces for new database models
**File**: `/home/pbrown/SkuInventory/src/types/shopify.ts`
**Pattern**: Follow existing interface style in the same file (lines 52-73 show ShopifyProduct/ShopifyVariant API types)
**Instructions**:
1. Add new section header comment `// Database Model Types` after line 202
2. Add interfaces that mirror the Prisma models (for use in services/components):

```typescript
// =============================================================================
// Database Model Types (mirror Prisma models)
// =============================================================================

/**
 * Shopify product status enum (mirrors Prisma enum)
 */
export type ShopifyProductStatus = 'ACTIVE' | 'DRAFT' | 'ARCHIVED'

/**
 * Shopify product from database
 */
export interface ShopifyProductRecord {
  id: string
  connectionId: string
  shopifyProductId: string
  title: string
  handle: string | null
  status: ShopifyProductStatus
  vendor: string | null
  productType: string | null
  rawData: Record<string, unknown>
  syncedAt: Date
  createdAt: Date
  updatedAt: Date
  variants?: ShopifyVariantRecord[]
}

/**
 * Shopify variant from database
 */
export interface ShopifyVariantRecord {
  id: string
  productId: string
  shopifyVariantId: string
  title: string
  sku: string | null
  price: number
  inventoryQuantity: number
  rawData: Record<string, unknown>
}

/**
 * Shopify customer from database
 */
export interface ShopifyCustomerRecord {
  id: string
  connectionId: string
  shopifyCustomerId: string
  email: string | null
  firstName: string | null
  lastName: string | null
  ordersCount: number
  totalSpent: number
  firstOrderDate: Date | null
  lastOrderDate: Date | null
  rawData: Record<string, unknown>
  syncedAt: Date
}

/**
 * Channel daily sales for cross-channel analytics
 */
export interface ChannelDailySalesRecord {
  id: string
  brandId: string
  channel: string
  date: Date
  skuId: string | null
  revenue: number
  orders: number
  units: number
  createdAt: Date
  updatedAt: Date
}

/**
 * Channel marketing spend for CAC/ROAS calculation
 */
export interface ChannelMarketingSpendRecord {
  id: string
  brandId: string
  channel: string
  month: Date
  adSpend: number
  notes: string | null
  createdAt: Date
  updatedAt: Date
}
```

**Validation**:
```bash
npx tsc --noEmit
```
**Completion Criteria**:
- [ ] All interfaces added with JSDoc comments
- [ ] TypeScript compiles without errors
- [ ] Types use `string` for UUIDs, `Date` for timestamps, `number` for Decimal

---

## Phase 2: Prisma Schema Extensions

### Subtask 2.1: Add ShopifyProductStatus enum
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Location**: After `ShopifyOrderStatus` enum (after line 298)
**Pattern**: Follow `ShopifyOrderStatus` enum pattern
**Instructions**:
1. Add enum definition:

```prisma
enum ShopifyProductStatus {
  ACTIVE
  DRAFT
  ARCHIVED
}
```

**Completion Criteria**:
- [ ] Enum added after line 298

---

### Subtask 2.2: Add ShopifyProduct model
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Location**: After `ShopifyOrderLine` model (after line 649)
**Pattern**: Follow `ShopifyOrder` model structure
**Instructions**:
1. Add model definition:

```prisma
model ShopifyProduct {
  id               String               @id @default(uuid())
  connectionId     String
  connection       ShopifyConnection    @relation(fields: [connectionId], references: [id])
  shopifyProductId String
  title            String               @db.VarChar(500)
  handle           String?              @db.VarChar(255)
  status           ShopifyProductStatus @default(ACTIVE)
  vendor           String?              @db.VarChar(255)
  productType      String?              @db.VarChar(255)
  rawData          Json                 @default("{}")
  syncedAt         DateTime             @default(now())
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt

  variants ShopifyVariant[]

  @@unique([connectionId, shopifyProductId])
  @@index([connectionId, status])
}
```

**Completion Criteria**:
- [ ] Model added with all fields from data-model.md
- [ ] FK to ShopifyConnection defined
- [ ] Unique constraint on `[connectionId, shopifyProductId]`
- [ ] Index on `[connectionId, status]`

---

### Subtask 2.3: Add ShopifyVariant model
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Location**: Immediately after ShopifyProduct model
**Pattern**: Follow `ShopifyOrderLine` model structure (child with cascade delete)
**Instructions**:
1. Add model definition:

```prisma
model ShopifyVariant {
  id                String         @id @default(uuid())
  productId         String
  product           ShopifyProduct @relation(fields: [productId], references: [id], onDelete: Cascade)
  shopifyVariantId  String         @unique
  title             String         @db.VarChar(255)
  sku               String?        @db.VarChar(100)
  price             Decimal        @db.Decimal(10, 2)
  inventoryQuantity Int            @default(0)
  rawData           Json           @default("{}")

  @@index([productId])
}
```

**Completion Criteria**:
- [ ] Model added with cascade delete on product relation
- [ ] Unique constraint on `shopifyVariantId`
- [ ] Index on `productId`

---

### Subtask 2.4: Add ShopifyCustomer model
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Location**: After ShopifyVariant model
**Pattern**: Follow `ShopifyOrder` model structure
**Instructions**:
1. Add model definition:

```prisma
model ShopifyCustomer {
  id                String            @id @default(uuid())
  connectionId      String
  connection        ShopifyConnection @relation(fields: [connectionId], references: [id])
  shopifyCustomerId String
  email             String?           @db.VarChar(255)
  firstName         String?           @db.VarChar(100)
  lastName          String?           @db.VarChar(100)
  ordersCount       Int               @default(0)
  totalSpent        Decimal           @default(0) @db.Decimal(12, 2)
  firstOrderDate    DateTime?
  lastOrderDate     DateTime?
  rawData           Json              @default("{}")
  syncedAt          DateTime          @default(now())

  orders ShopifyOrder[]

  @@unique([connectionId, shopifyCustomerId])
  @@index([connectionId, email])
}
```

**Completion Criteria**:
- [ ] Model added with denormalized metrics fields
- [ ] FK to ShopifyConnection defined
- [ ] Unique constraint on `[connectionId, shopifyCustomerId]`
- [ ] Index on `[connectionId, email]`

---

### Subtask 2.5: Extend ShopifyOrder with customerId FK
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Location**: Within existing `ShopifyOrder` model (around line 625, after `processedAt`)
**Instructions**:
1. Add customer relation fields after `processedAt DateTime?`:

```prisma
  customerId String?
  customer   ShopifyCustomer? @relation(fields: [customerId], references: [id])
```

2. Add index for customer lookups in the existing indexes section:

```prisma
  @@index([customerId])
```

**Completion Criteria**:
- [ ] `customerId` field added as nullable String
- [ ] `customer` relation defined with proper FK
- [ ] Index on `customerId` added

---

### Subtask 2.6: Extend ShopifyConnection with new relations
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Location**: Within existing `ShopifyConnection` model (after line 605, after `orders ShopifyOrder[]`)
**Instructions**:
1. Add new relation fields:

```prisma
  products  ShopifyProduct[]
  customers ShopifyCustomer[]
```

**Completion Criteria**:
- [ ] `products` relation array added
- [ ] `customers` relation array added

---

### Subtask 2.7: Add ChannelDailySales model
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Location**: After SkuChannelMapping model (after line 667)
**Pattern**: Follow `SalesDaily` model structure (lines 897-929)
**Instructions**:
1. Add model definition:

```prisma
model ChannelDailySales {
  id        String   @id @default(uuid())
  brandId   String
  brand     Brand    @relation(fields: [brandId], references: [id])
  channel   String   @db.VarChar(20)
  date      DateTime @db.Date
  skuId     String?
  sku       SKU?     @relation(fields: [skuId], references: [id])
  revenue   Decimal  @db.Decimal(12, 2)
  orders    Int
  units     Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([brandId, channel, date, skuId])
  @@index([brandId, date])
  @@index([channel, date])
}
```

**Completion Criteria**:
- [ ] Model added with Brand and SKU FKs
- [ ] Unique constraint on `[brandId, channel, date, skuId]`
- [ ] Indexes on `[brandId, date]` and `[channel, date]`

---

### Subtask 2.8: Add ChannelMarketingSpend model
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Location**: After ChannelDailySales model
**Pattern**: Simple model with Brand FK
**Instructions**:
1. Add model definition:

```prisma
model ChannelMarketingSpend {
  id        String   @id @default(uuid())
  brandId   String
  brand     Brand    @relation(fields: [brandId], references: [id])
  channel   String   @db.VarChar(20)
  month     DateTime @db.Date
  adSpend   Decimal  @db.Decimal(12, 2)
  notes     String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([brandId, channel, month])
}
```

**Completion Criteria**:
- [ ] Model added with Brand FK
- [ ] Unique constraint on `[brandId, channel, month]`

---

### Subtask 2.9: Extend Brand model with new relations
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Location**: Within existing `Brand` model (after line 92, after `watchedKeywords WatchedKeyword[]`)
**Instructions**:
1. Add new relation fields:

```prisma
  // V2: Cross-channel analytics relations
  channelDailySales     ChannelDailySales[]
  channelMarketingSpend ChannelMarketingSpend[]
```

**Completion Criteria**:
- [ ] `channelDailySales` relation array added
- [ ] `channelMarketingSpend` relation array added
- [ ] Comment indicates V2 feature

---

### Subtask 2.10: Extend SKU model with ChannelDailySales relation
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Location**: Within existing `SKU` model (after line 430, after `asinMappings AsinSkuMapping[]`)
**Instructions**:
1. Add new relation field:

```prisma
  // V2: Cross-channel analytics relation
  channelDailySales ChannelDailySales[]
```

**Completion Criteria**:
- [ ] `channelDailySales` relation array added
- [ ] Comment indicates V2 feature

---

## Phase 3: Database Migration

### Subtask 3.1: Run Prisma migration
**Instructions**:
1. Generate and run migration:

```bash
cd /home/pbrown/SkuInventory
DATABASE_URL="postgresql://inventory_test:inventory_test_2025@localhost:2346/inventory_test" npx prisma migrate dev --name shopify_integration_v2_schema
```

2. Verify migration created in `prisma/migrations/`

**Validation**:
```bash
ls -la prisma/migrations/ | tail -5
```

**Completion Criteria**:
- [ ] Migration file created with timestamp prefix
- [ ] Migration applied successfully without errors
- [ ] All 6 new tables created
- [ ] ShopifyOrder table extended with customerId column

---

### Subtask 3.2: Regenerate Prisma client
**Instructions**:
```bash
cd /home/pbrown/SkuInventory
npx prisma generate
```

**Completion Criteria**:
- [ ] Prisma client regenerated successfully

---

### Subtask 3.3: Verify migration in test database
**Instructions**:
```bash
docker exec inventory-db-test psql -U inventory_test -d inventory_test -c "\dt" | grep -E "ShopifyProduct|ShopifyVariant|ShopifyCustomer|ChannelDailySales|ChannelMarketingSpend"
```

Expected output should show 5 new tables.

Also verify ShopifyOrder has customerId column:
```bash
docker exec inventory-db-test psql -U inventory_test -d inventory_test -c "\d \"ShopifyOrder\"" | grep customerId
```

**Completion Criteria**:
- [ ] All 5 new tables exist in database
- [ ] ShopifyOrder has customerId column
- [ ] All indexes created

---

## Phase 4: Verification

### Subtask 4.1: TypeScript compilation check
**Instructions**:
```bash
cd /home/pbrown/SkuInventory
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] No TypeScript errors

---

### Subtask 4.2: Build verification
**Instructions**:
```bash
cd /home/pbrown/SkuInventory
npm run build
```

**Completion Criteria**:
- [ ] Build completes without errors

---

### Subtask 4.3: Lint check
**Instructions**:
```bash
cd /home/pbrown/SkuInventory
npm run lint
```

**Completion Criteria**:
- [ ] No linting errors

---

## Summary of Deliverables

**Files Created**: 1
- `prisma/migrations/[timestamp]_shopify_integration_v2_schema/migration.sql`

**Files Modified**: 2
- `prisma/schema.prisma` - 1 enum, 5 new models, 4 model extensions
- `src/types/shopify.ts` - 6 new TypeScript interfaces

**New Database Objects**:
| Type | Name |
|------|------|
| Enum | `ShopifyProductStatus` |
| Table | `ShopifyProduct` |
| Table | `ShopifyVariant` |
| Table | `ShopifyCustomer` |
| Table | `ChannelDailySales` |
| Table | `ChannelMarketingSpend` |
| Column | `ShopifyOrder.customerId` |

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 -> Phase 2 -> Phase 3 -> Phase 4)
2. Phase 2 subtasks can be done in one edit pass to schema.prisma
3. Run migration only after all schema changes complete
4. Verify each completion criterion before proceeding

---

## Test Strategy Note

- No unit tests required for this issue (schema-only changes)
- Verification is via migration success + TypeScript compilation
- Future issues will add service/component tests that use these models

---

## Acceptance Criteria from Issue

- [x] All models created with proper indexes and relations
- [x] Migration runs without errors
- [x] Existing ShopifyOrder/ShopifyOrderLine untouched (only extended)

---

## Performance Metrics

| Phase | Estimated Duration |
|-------|----------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 25m |
| **Total Planning** | **45m** |
| **Estimated Build** | **3-4h** |

---

AGENT_RETURN: plan-363-010426
