# Implementation Plan
**Generated**: 2025-12-06T16:00:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #197
**Estimated Build Time**: 6-8 hours
**Complexity**: Medium

## Investigation Summary

### Request Analysis
**Type**: Refactoring/Cleanup
**Source**: GitHub Issue #197
**Priority**: Medium
**Parent Issue**: #195 (Architectural Audit: Technical Debt and Design Issues from V1 Review)

### Task Classification
**Category**: REFACTORING
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter=".*(?<!shopify).*"` (run tests excluding shopify-specific tests)

### Issue Validation
**Status**: Valid
**Recent Changes**: 6 commits affecting Shopify files in last 30 days (features #80, #85, #90, #93, #95, #97)
**Parent Issue Status**: CLOSED

### Current State Assessment

#### Shopify Integration Files Inventory

**Services (3 files, ~1040 lines):**
- `/home/pbrown/SkuInventory/src/services/shopify.ts` - 419 lines - Shopify API client
- `/home/pbrown/SkuInventory/src/services/shopify-sync.ts` - 323 lines - Order sync service
- `/home/pbrown/SkuInventory/src/services/order-posting.ts` - 397 lines - Order to transaction posting

**API Routes (13 files):**
- `/home/pbrown/SkuInventory/src/app/api/shopify/connection/route.ts` - Connection CRUD
- `/home/pbrown/SkuInventory/src/app/api/shopify/connection/test/route.ts` - Connection test
- `/home/pbrown/SkuInventory/src/app/api/shopify/mappings/route.ts` - Mappings list/create
- `/home/pbrown/SkuInventory/src/app/api/shopify/mappings/[id]/route.ts` - Mappings update/delete
- `/home/pbrown/SkuInventory/src/app/api/shopify/mappings/import/route.ts` - CSV import
- `/home/pbrown/SkuInventory/src/app/api/shopify/orders/route.ts` - Orders list
- `/home/pbrown/SkuInventory/src/app/api/shopify/orders/[id]/route.ts` - Order detail
- `/home/pbrown/SkuInventory/src/app/api/shopify/orders/[id]/approve/route.ts` - Order approve
- `/home/pbrown/SkuInventory/src/app/api/shopify/orders/[id]/skip/route.ts` - Order skip
- `/home/pbrown/SkuInventory/src/app/api/shopify/orders/[id]/post/route.ts` - Order post
- `/home/pbrown/SkuInventory/src/app/api/shopify/orders/[id]/lines/[lineId]/route.ts` - Line mapping
- `/home/pbrown/SkuInventory/src/app/api/shopify/orders/post-batch/route.ts` - Batch post
- `/home/pbrown/SkuInventory/src/app/api/shopify/sync/route.ts` - Sync trigger

**Types (6 files):**
- `/home/pbrown/SkuInventory/src/types/shopify.ts` - Shopify API types
- `/home/pbrown/SkuInventory/src/types/shopify-sync.ts` - Sync request/response types
- `/home/pbrown/SkuInventory/src/types/shopify-connection.ts` - Connection types
- `/home/pbrown/SkuInventory/src/types/order-posting.ts` - Posting types
- `/home/pbrown/SkuInventory/src/types/order-review.ts` - Order review UI types
- `/home/pbrown/SkuInventory/src/types/channel-mapping.ts` - Channel mapping types

**UI Components (7 files):**
- `/home/pbrown/SkuInventory/src/components/features/ShopifyConnectionForm.tsx` - Connection settings form
- `/home/pbrown/SkuInventory/src/components/features/OrderReviewTable.tsx` - Order list table
- `/home/pbrown/SkuInventory/src/components/features/OrderDetail.tsx` - Order detail view
- `/home/pbrown/SkuInventory/src/components/features/LineMappingDialog.tsx` - Line mapping dialog
- `/home/pbrown/SkuInventory/src/components/features/SkuMappingTable.tsx` - SKU mapping table
- `/home/pbrown/SkuInventory/src/components/features/SkuMappingForm.tsx` - SKU mapping form

**UI Pages (4 files):**
- `/home/pbrown/SkuInventory/src/app/(dashboard)/orders/page.tsx` - Orders list page
- `/home/pbrown/SkuInventory/src/app/(dashboard)/orders/[id]/page.tsx` - Order detail page
- `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/integrations/page.tsx` - Integrations hub
- `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/integrations/shopify/page.tsx` - Shopify settings
- `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/integrations/mappings/page.tsx` - SKU mappings page

**Tests (2 files):**
- `/home/pbrown/SkuInventory/tests/unit/shopify-client.test.ts` - API client tests
- `/home/pbrown/SkuInventory/tests/unit/shopify-sync.test.ts` - Sync service tests

**Other Affected Files:**
- `/home/pbrown/SkuInventory/src/lib/crypto.ts` - Uses SHOPIFY_ENCRYPTION_KEY
- `/home/pbrown/SkuInventory/src/lib/env.ts` - SHOPIFY_ENCRYPTION_KEY validation
- `/home/pbrown/SkuInventory/src/types/index.ts` - 'Shopify' in salesChannels constant
- `/home/pbrown/SkuInventory/src/lib/transaction-parser.ts` - 'Shopify' channel reference in parser

**Database Schema (to add comments only, not remove):**
- `/home/pbrown/SkuInventory/prisma/schema.prisma` - 5 Shopify models (ShopifyConnection, ShopifyOrder, ShopifyOrderLine, SkuChannelMapping, ShopifyOrderStatus enum) + Company relations

### Dependencies & Blockers
1. **None identified** - This is a cleanup task with no external dependencies

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Medium
**Effort**: 6-8 hours
**Risk**: Low (deletion/move of dead code, not modification of active logic)

### Patterns Identified
**Approach**: Move to deferred directory rather than delete
- Preserves work for V2
- Clear separation from active code
- Easy to restore when V2 begins

### Ripple Effect Analysis
**Files Identified**: 36 total files

**Direct Shopify Files (to remove/move)**: 33 files
- Services: 3
- API Routes: 13
- Types: 6
- Components: 7
- Pages: 4
- Tests: 2

**Indirect References (to update)**: 3 files
- `src/lib/env.ts` - Remove SHOPIFY_ENCRYPTION_KEY validation
- `src/lib/crypto.ts` - Keep but update comment (encryption still useful)
- `src/types/index.ts` - Keep 'Shopify' in salesChannels (valid channel name)

**Schema (comment only)**: 1 file
- `prisma/schema.prisma` - Add V2-deferred comments to Shopify models

---

## Executive Summary

This task removes approximately 36 files of dead Shopify integration code from the V1 codebase. The approach is to move files to a `src/_deferred/shopify/` directory structure rather than deleting them, preserving the work for V2 while clearing them from the active codebase. The database schema models will be preserved (to avoid migration complexity) but marked with comments indicating V2-deferred status.

---

## Phase 0: Preparation

### Subtask 0.1: Create Deferred Directory Structure
**File**: `/home/pbrown/SkuInventory/src/_deferred/`
**Instructions**:
1. Create the deferred directory structure:
   ```bash
   mkdir -p src/_deferred/shopify/{services,types,components,pages,api,tests}
   ```
2. Create a README.md explaining the purpose:
   ```markdown
   # Deferred V2 Features

   This directory contains code that was implemented prematurely for V1 but is
   deferred to V2 per PRD requirements.

   ## Contents

   ### shopify/
   Complete Shopify integration including:
   - API client and sync services
   - Order review queue UI
   - SKU channel mapping
   - Connection management

   **Status**: Deferred until V2
   **Original Implementation**: December 2025
   **Reason**: PRD V1 explicitly excludes integrations

   ## Restoration

   To restore these features for V2:
   1. Move files back to their original locations in `src/`
   2. Uncomment schema models in `prisma/schema.prisma`
   3. Run `npx prisma generate`
   4. Update route exports and navigation
   ```
**Completion Criteria**:
- [ ] Directory structure created
- [ ] README.md created with restoration instructions

### Subtask 0.2: Verify Build Status Before Changes
**Instructions**:
1. Run full build to ensure clean starting state:
   ```bash
   npm run build
   npx tsc --noEmit
   ```
2. Document any pre-existing issues
**Completion Criteria**:
- [ ] Build passes without errors
- [ ] TypeScript check passes

---

## Phase 1: Move Services

### Subtask 1.1: Move Shopify API Client Service
**Source**: `/home/pbrown/SkuInventory/src/services/shopify.ts`
**Destination**: `/home/pbrown/SkuInventory/src/_deferred/shopify/services/shopify.ts`
**Instructions**:
1. Move the file: `mv src/services/shopify.ts src/_deferred/shopify/services/`
2. Add header comment to moved file:
   ```typescript
   /**
    * [V2-DEFERRED] Shopify API Client
    * Moved from src/services/shopify.ts on 2025-12-06
    * Reason: PRD V1 explicitly excludes integrations
    * Restore: Move back to src/services/ when V2 work begins
    */
   ```
**Completion Criteria**:
- [ ] File moved
- [ ] Header comment added

### Subtask 1.2: Move Shopify Sync Service
**Source**: `/home/pbrown/SkuInventory/src/services/shopify-sync.ts`
**Destination**: `/home/pbrown/SkuInventory/src/_deferred/shopify/services/shopify-sync.ts`
**Instructions**:
1. Move the file: `mv src/services/shopify-sync.ts src/_deferred/shopify/services/`
2. Add V2-DEFERRED header comment
**Completion Criteria**:
- [ ] File moved
- [ ] Header comment added

### Subtask 1.3: Move Order Posting Service
**Source**: `/home/pbrown/SkuInventory/src/services/order-posting.ts`
**Destination**: `/home/pbrown/SkuInventory/src/_deferred/shopify/services/order-posting.ts`
**Instructions**:
1. Move the file: `mv src/services/order-posting.ts src/_deferred/shopify/services/`
2. Add V2-DEFERRED header comment
**Completion Criteria**:
- [ ] File moved
- [ ] Header comment added

---

## Phase 2: Move Types

### Subtask 2.1: Move Shopify Types
**Files to Move**:
- `src/types/shopify.ts` -> `src/_deferred/shopify/types/`
- `src/types/shopify-sync.ts` -> `src/_deferred/shopify/types/`
- `src/types/shopify-connection.ts` -> `src/_deferred/shopify/types/`
- `src/types/order-posting.ts` -> `src/_deferred/shopify/types/`
- `src/types/order-review.ts` -> `src/_deferred/shopify/types/`
- `src/types/channel-mapping.ts` -> `src/_deferred/shopify/types/`

**Instructions**:
1. Move all 6 type files to deferred directory
2. Add V2-DEFERRED header comments to each
**Completion Criteria**:
- [ ] All 6 files moved
- [ ] All files have header comments

---

## Phase 3: Remove API Routes

### Subtask 3.1: Remove Shopify API Routes Directory
**Directory**: `/home/pbrown/SkuInventory/src/app/api/shopify/`
**Destination**: `/home/pbrown/SkuInventory/src/_deferred/shopify/api/`
**Instructions**:
1. Move entire directory:
   ```bash
   mv src/app/api/shopify src/_deferred/shopify/api
   ```
2. This moves all 13 API route files in one operation
3. Add README to the moved api directory explaining the route structure
**Completion Criteria**:
- [ ] Directory moved
- [ ] All 13 route files preserved in deferred location

---

## Phase 4: Move UI Components

### Subtask 4.1: Move Shopify-Related Components
**Files to Move**:
- `src/components/features/ShopifyConnectionForm.tsx`
- `src/components/features/OrderReviewTable.tsx`
- `src/components/features/OrderDetail.tsx`
- `src/components/features/LineMappingDialog.tsx`
- `src/components/features/SkuMappingTable.tsx`
- `src/components/features/SkuMappingForm.tsx`

**Destination**: `/home/pbrown/SkuInventory/src/_deferred/shopify/components/`
**Instructions**:
1. Move each file with V2-DEFERRED header comment
**Completion Criteria**:
- [ ] All 6 component files moved
- [ ] Header comments added

---

## Phase 5: Remove UI Pages

### Subtask 5.1: Remove Orders Pages
**Files to Move**:
- `src/app/(dashboard)/orders/page.tsx`
- `src/app/(dashboard)/orders/[id]/page.tsx`

**Destination**: `/home/pbrown/SkuInventory/src/_deferred/shopify/pages/orders/`
**Instructions**:
1. Move the orders directory:
   ```bash
   mv src/app/\(dashboard\)/orders src/_deferred/shopify/pages/
   ```
2. Or move individual files and preserve structure
**Completion Criteria**:
- [ ] Orders pages moved

### Subtask 5.2: Remove Shopify Settings Page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/integrations/shopify/`
**Destination**: `/home/pbrown/SkuInventory/src/_deferred/shopify/pages/settings/shopify/`
**Instructions**:
1. Move the shopify settings directory
**Completion Criteria**:
- [ ] Shopify settings page moved

### Subtask 5.3: Update Integrations Hub Page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/integrations/page.tsx`
**Instructions**:
1. Remove or comment out the Shopify card
2. Keep the "SKU Mappings" card but update its description
3. Update to show Shopify as "Coming in V2" instead of functional
**Pattern**: Keep the page structure, just update content
**Completion Criteria**:
- [ ] Shopify card removed or shows "Coming in V2"
- [ ] Page still builds and renders

### Subtask 5.4: Remove Mappings Page (Optional - Evaluate)
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/integrations/mappings/page.tsx`
**Decision Point**: The mappings page is for channel mappings (Shopify, Amazon, TikTok).
- If no integrations in V1, this page is also dead code
- Move to deferred directory
**Destination**: `/home/pbrown/SkuInventory/src/_deferred/shopify/pages/settings/mappings/`
**Completion Criteria**:
- [ ] Mappings page moved if not needed for V1

---

## Phase 6: Move Tests

### Subtask 6.1: Move Shopify Tests
**Files to Move**:
- `tests/unit/shopify-client.test.ts`
- `tests/unit/shopify-sync.test.ts`

**Destination**: `/home/pbrown/SkuInventory/src/_deferred/shopify/tests/`
**Instructions**:
1. Move test files to deferred directory
**Completion Criteria**:
- [ ] Both test files moved

---

## Phase 7: Update Supporting Files

### Subtask 7.1: Update Environment Validation
**File**: `/home/pbrown/SkuInventory/src/lib/env.ts`
**Instructions**:
1. Remove SHOPIFY_ENCRYPTION_KEY from schema (make it not validated since Shopify is deferred)
2. Keep the env schema simple for V1
**Current Code**:
```typescript
// Shopify token encryption key - optional, falls back to NEXTAUTH_SECRET
SHOPIFY_ENCRYPTION_KEY: z.string().min(32).optional(),
```
**New Code**:
```typescript
// [V2-DEFERRED] Shopify token encryption key removed - add back for V2
// SHOPIFY_ENCRYPTION_KEY: z.string().min(32).optional(),
```
**Completion Criteria**:
- [ ] SHOPIFY_ENCRYPTION_KEY commented out

### Subtask 7.2: Update Crypto Utility (Optional)
**File**: `/home/pbrown/SkuInventory/src/lib/crypto.ts`
**Instructions**:
1. Add comment noting this is currently unused but preserved for V2
2. Update the SALT constant comment
3. Keep the utility intact as it may be useful for other encryption needs
**Code Change**:
```typescript
/**
 * Cryptographic utilities for secure token encryption/decryption
 * Uses AES-256-GCM for authenticated encryption
 *
 * [V2-DEFERRED] Currently unused in V1 - preserved for Shopify integration in V2
 */
```
**Completion Criteria**:
- [ ] Header comment updated

### Subtask 7.3: Add Schema Comments
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Instructions**:
1. Add V2-DEFERRED comment block above Shopify models section
2. Do NOT remove the models (to avoid migration complexity)
**Code to Add** (around line 519):
```prisma
// ============================================
// [V2-DEFERRED] Shopify Integration Entities
// These models are preserved for V2 but not actively used in V1.
// Do not remove - this avoids migration complexity.
// See /src/_deferred/shopify/ for related code.
// ============================================
```
**Completion Criteria**:
- [ ] Comment block added to schema

### Subtask 7.4: Update Company Model Comments
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Instructions**:
1. Update the Company model's Shopify relations comment (around line 36-37):
```prisma
  // [V2-DEFERRED] Shopify integration relations
  shopifyConnection  ShopifyConnection?
  skuChannelMappings SkuChannelMapping[]
```
**Completion Criteria**:
- [ ] Company relation comments updated

---

## Phase 8: Verify and Clean Up

### Subtask 8.1: Run Build Verification
**Instructions**:
1. Run full TypeScript check:
   ```bash
   npx tsc --noEmit
   ```
2. Run full build:
   ```bash
   npm run build
   ```
3. Fix any import errors from moved files
**Completion Criteria**:
- [ ] `npx tsc --noEmit` passes without errors
- [ ] `npm run build` completes successfully

### Subtask 8.2: Run Tests
**Instructions**:
1. Run all non-Shopify tests:
   ```bash
   npm test -- --testPathIgnorePatterns="shopify"
   ```
2. Verify no test failures
**Completion Criteria**:
- [ ] All V1 tests pass

### Subtask 8.3: Verify Navigation
**Instructions**:
1. Check that app builds without broken routes
2. Verify settings/integrations page renders
3. Confirm no 404s for removed routes (they should just not be accessible)
**Completion Criteria**:
- [ ] App builds and runs
- [ ] No broken navigation

---

## Summary of Deliverables

**Files Moved to `src/_deferred/shopify/`**:
- Services: 3 files
- Types: 6 files
- API Routes: 13 files (entire directory)
- Components: 6 files
- Pages: 4+ files (orders, shopify settings, mappings)
- Tests: 2 files
- **Total**: ~34 files preserved for V2

**Files Modified**:
- `src/lib/env.ts` - Remove SHOPIFY_ENCRYPTION_KEY validation
- `src/lib/crypto.ts` - Add V2-DEFERRED comment
- `prisma/schema.prisma` - Add V2-DEFERRED comments to Shopify section
- `src/app/(dashboard)/settings/integrations/page.tsx` - Update UI

**Files NOT Modified** (kept as-is):
- `src/types/index.ts` - 'Shopify' remains valid sales channel name
- `src/lib/transaction-parser.ts` - 'Shopify' channel reference is valid

**New Files Created**:
- `src/_deferred/shopify/README.md` - Documentation
- `src/_deferred/README.md` - Top-level explanation

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 0 -> Phase 8)
2. Phase 0 creates directory structure - must complete before other phases
3. Phases 1-6 can be done in parallel (independent file moves)
4. Phase 7 updates references - do after moves complete
5. Phase 8 is verification - must be last
6. Test completion criteria before marking subtask complete
7. If build fails after any phase, fix before proceeding

---

## Test Strategy Note

- **Strategy**: TARGETED
- All Shopify-specific tests will be moved to deferred directory
- Run `npm test -- --testPathIgnorePatterns="shopify"` to verify V1 tests pass
- After removal, full test suite should run faster (fewer tests)

---

## Performance Metrics

| Phase | Estimated Duration |
|-------|----------|
| Phase 0: Preparation | 15m |
| Phase 1: Move Services | 15m |
| Phase 2: Move Types | 20m |
| Phase 3: Remove API Routes | 10m |
| Phase 4: Move Components | 20m |
| Phase 5: Remove Pages | 30m |
| Phase 6: Move Tests | 10m |
| Phase 7: Update Supporting Files | 30m |
| Phase 8: Verify and Clean Up | 30m |
| **Total** | **~3 hours** |

---

## Risk Mitigation

1. **Accidental Import Breaks**: After moving files, search for any remaining imports:
   ```bash
   grep -r "from '@/services/shopify" src/
   grep -r "from '@/types/shopify" src/
   grep -r "/api/shopify" src/
   ```

2. **Build Failures**: Run incremental builds after each phase to catch issues early

3. **Navigation Breaks**: The moved pages will result in 404s if users navigate directly - this is expected behavior for removed features

4. **Rollback Plan**: All code is moved (not deleted), so restoration is simply moving files back
