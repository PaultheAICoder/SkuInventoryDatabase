# Implementation Plan
**Generated**: 2025-12-31T06:00:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #336
**Estimated Build Time**: 4-6 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Feature (New Feature)
**Source**: GitHub Issue #336
**Priority**: Medium

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: `--testPathPattern="seed"` or None (seed script only)

### Issue Validation
**Status**: Valid
**Recent Changes**: No recent commits affecting seed structure; seed scripts last modified for inventory data

### Current State Assessment

**Existing Components**:
- `prisma/seed.ts` - Main seed script creating Company, Brand, Users
- `scripts/seed-inventory.ts` - TonsilTech inventory data seeder
- `scripts/populate-inventory-balances.ts` - Balance population script

**Database Model (from investigation)**:
- Company: Top-level entity with settings JSON
- Brand: Belongs to Company, contains Components and SKUs
- Component: Raw materials with inventory tracking (12 per Rise brand)
- SKU: Finished goods with BOM versions (2 per Rise brand)
- BOMVersion: Bill of Materials linking SKUs to Components
- BOMLine: Individual component quantities per BOM
- Location: Storage locations (warehouse, fba, threepl)
- InventoryBalance: O(1) component quantity lookups
- FinishedGoodsBalance: O(1) SKU quantity lookups
- Transaction/TransactionLine: Inventory movements (receipt, build, adjustment)

**Reference Brand (Rise) Structure**:
| Entity | Count |
|--------|-------|
| Components | 12 |
| SKUs | 2 |
| BOM Versions | 2 (one per SKU) |
| BOM Lines | 24 (12 components x 2 SKUs) |
| Locations | 2 (VTM, FBA Warehouse) |
| Transactions | ~216 (192 receipts, 24 builds) |

**User Assignment Pattern**:
- Users are assigned to companies via UserCompany join table
- Each user has one primary company (isPrimary=true)
- Users can access multiple companies with different roles

### Dependencies & Blockers
1. No blockers identified
2. Prisma client available
3. Test database accessible at port 2346
4. All required models exist in schema

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Low/Simple
**Effort**: 4-6 hours
**Risk**: Low - isolated seed script, no schema changes

### Patterns Identified
**Primary**: `/home/pbrown/SkuInventory/scripts/seed-inventory.ts` - Component creation with transactions
**Secondary**: `/home/pbrown/SkuInventory/prisma/seed.ts` - Company/Brand/User creation pattern
**Reference**: Rise brand in test DB - realistic sample data structure

### Ripple Effect Analysis
**Files Identified**: 0 (new script, no modifications to existing code)
- New file: `scripts/seed-sandbox-brand.ts`

This is an isolated feature with no impact on existing functionality.

---

## Executive Summary

Create a standalone seed script that creates a "Sandbox" brand under an existing company (Tonsil Tech) with sample components, SKUs, BOMs, locations, and initial inventory transactions. The script follows existing patterns from `seed-inventory.ts` and uses Rise brand as a structural reference (but with a smaller, simpler dataset for quick testing). All users with access to Tonsil Tech company will automatically have access to the Sandbox brand.

---

## Phase 1: Create Sandbox Brand Seed Script

### Subtask 1.1: Create seed script file structure

**File**: `/home/pbrown/SkuInventory/scripts/seed-sandbox-brand.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/scripts/seed-inventory.ts` lines 1-31
**Instructions**:

1. Create the seed script with Prisma client setup:
```typescript
/**
 * Seed Sandbox brand with sample data for safe testing
 *
 * Usage: DATABASE_URL="..." npx tsx scripts/seed-sandbox-brand.ts
 *
 * For test database:
 * DATABASE_URL="postgresql://inventory_test:inventory_test_2025@localhost:2346/inventory_test" npx tsx scripts/seed-sandbox-brand.ts
 */

import { PrismaClient, Prisma } from '@prisma/client'
import { PrismaPg } from '@prisma/adapter-pg'
import { Pool } from 'pg'

const connectionString = process.env.DATABASE_URL ?? ''
const pool = new Pool({ connectionString })
const adapter = new PrismaPg(pool)
const prisma = new PrismaClient({ adapter })
```

2. Define sample data arrays (similar structure to Rise brand but simpler):

**Components (6 items - simplified supply chain)**:
| Name | SKU Code | Cost | Category | Description |
|------|----------|------|----------|-------------|
| Sample Box | SBOX-001 | 0.50 | Packaging | Cardboard box for shipping |
| Sample Label | SLBL-001 | 0.05 | Packaging | Product label |
| Sample Insert | SINS-001 | 0.10 | Packaging | Information insert |
| Widget A | WDGT-A | 2.00 | Parts | Core product component |
| Widget B | WDGT-B | 1.50 | Parts | Secondary component |
| Bubble Wrap | BWRP-001 | 0.15 | Packaging | Protective packaging |

**SKUs (2 items)**:
| Name | Internal Code | Sales Channel |
|------|---------------|---------------|
| Basic Kit | SBOX-BASIC | Amazon |
| Premium Kit | SBOX-PREMIUM | Amazon |

**BOM Structures**:
- Basic Kit: 1x Box, 1x Label, 1x Insert, 1x Widget A, 1x Bubble Wrap
- Premium Kit: 1x Box, 1x Label, 1x Insert, 1x Widget A, 2x Widget B, 2x Bubble Wrap

**Locations (2)**:
- Main Warehouse (default, type: warehouse)
- FBA Center (type: fba)

**Completion Criteria**:
- [ ] Script file created with proper header comments
- [ ] Prisma client setup matches existing scripts
- [ ] Sample data arrays defined with realistic values

---

### Subtask 1.2: Implement company and brand creation

**File**: `/home/pbrown/SkuInventory/scripts/seed-sandbox-brand.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/prisma/seed.ts` lines 16-40
**Instructions**:

1. Create main() function that:
   - Finds or uses existing "Tonsil Tech" company (upsert pattern)
   - Creates "Sandbox" brand under that company if not exists
   - Uses unique constraint `companyId_name` for brand upsert

```typescript
async function main() {
  console.log('Seeding Sandbox brand with sample data...\n')

  // Get or create company (use existing Tonsil Tech)
  let company = await prisma.company.findFirst({ where: { name: 'Tonsil Tech' } })
  if (!company) {
    // Create company if running standalone
    company = await prisma.company.create({
      data: {
        name: 'Tonsil Tech',
        settings: { /* default settings */ }
      },
    })
    console.log('Created company: Tonsil Tech')
  } else {
    console.log('Found existing company: Tonsil Tech')
  }

  // Create Sandbox brand
  const brand = await prisma.brand.upsert({
    where: {
      companyId_name: {
        companyId: company.id,
        name: 'Sandbox',
      },
    },
    update: {},
    create: {
      companyId: company.id,
      name: 'Sandbox',
    },
  })
  console.log(`Brand: ${brand.name} (${brand.id})`)
```

2. Get admin user for audit fields (createdById, updatedById)

**Completion Criteria**:
- [ ] Company lookup/creation works
- [ ] Brand created with correct unique constraint handling
- [ ] Admin user retrieved for audit fields

---

### Subtask 1.3: Implement location creation

**File**: `/home/pbrown/SkuInventory/scripts/seed-sandbox-brand.ts`
**Pattern**: Follow Location model in schema, similar to Rise brand locations
**Instructions**:

1. Create two locations for the company:

```typescript
// Create locations
const mainWarehouse = await prisma.location.upsert({
  where: {
    companyId_name: {
      companyId: company.id,
      name: 'Sandbox Warehouse',
    },
  },
  update: {},
  create: {
    companyId: company.id,
    name: 'Sandbox Warehouse',
    type: 'warehouse',
    isDefault: false, // Don't override existing default
    isActive: true,
  },
})

const fbaCenter = await prisma.location.upsert({
  where: {
    companyId_name: {
      companyId: company.id,
      name: 'Sandbox FBA',
    },
  },
  update: {},
  create: {
    companyId: company.id,
    name: 'Sandbox FBA',
    type: 'fba',
    isDefault: false,
    isActive: true,
  },
})
console.log(`Created locations: ${mainWarehouse.name}, ${fbaCenter.name}`)
```

**Completion Criteria**:
- [ ] Two locations created with correct types
- [ ] Locations properly scoped to company
- [ ] isDefault=false to avoid conflicts

---

### Subtask 1.4: Implement component creation with initial inventory

**File**: `/home/pbrown/SkuInventory/scripts/seed-sandbox-brand.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/scripts/seed-inventory.ts` lines 79-132
**Instructions**:

1. Create components using the defined data:

```typescript
// Component seed data
const componentData = [
  { name: 'Sample Box', skuCode: 'SBOX-001', cost: 0.50, category: 'Packaging', initialQty: 500 },
  { name: 'Sample Label', skuCode: 'SLBL-001', cost: 0.05, category: 'Packaging', initialQty: 1000 },
  { name: 'Sample Insert', skuCode: 'SINS-001', cost: 0.10, category: 'Packaging', initialQty: 800 },
  { name: 'Widget A', skuCode: 'WDGT-A', cost: 2.00, category: 'Parts', initialQty: 200 },
  { name: 'Widget B', skuCode: 'WDGT-B', cost: 1.50, category: 'Parts', initialQty: 300 },
  { name: 'Bubble Wrap', skuCode: 'BWRP-001', cost: 0.15, category: 'Packaging', initialQty: 600 },
]

const components: Record<string, string> = {} // Store component IDs by skuCode

for (const item of componentData) {
  const existing = await prisma.component.findFirst({
    where: { brandId: brand.id, skuCode: item.skuCode },
  })

  if (existing) {
    components[item.skuCode] = existing.id
    console.log(`  Skipped: ${item.name} (already exists)`)
    continue
  }

  const component = await prisma.component.create({
    data: {
      brandId: brand.id,
      companyId: company.id,
      name: item.name,
      skuCode: item.skuCode,
      category: item.category,
      unitOfMeasure: 'each',
      costPerUnit: item.cost,
      reorderPoint: Math.floor(item.initialQty * 0.2), // 20% reorder point
      leadTimeDays: 7,
      createdById: adminUser.id,
      updatedById: adminUser.id,
    },
  })
  components[item.skuCode] = component.id
  console.log(`  Created component: ${item.name}`)
}
```

2. Create initial inventory transactions and update InventoryBalance:

```typescript
// Create initial inventory transactions
for (const item of componentData) {
  const componentId = components[item.skuCode]

  // Create initial transaction
  await prisma.transaction.create({
    data: {
      companyId: company.id,
      type: 'initial',
      date: new Date(),
      locationId: mainWarehouse.id,
      notes: 'Sandbox initial inventory',
      status: 'approved',
      createdById: adminUser.id,
      lines: {
        create: {
          componentId,
          quantityChange: item.initialQty,
          costPerUnit: item.cost,
        },
      },
    },
  })

  // Update InventoryBalance for O(1) lookups
  await prisma.inventoryBalance.upsert({
    where: {
      componentId_locationId: {
        componentId,
        locationId: mainWarehouse.id,
      },
    },
    create: {
      componentId,
      locationId: mainWarehouse.id,
      quantity: new Prisma.Decimal(item.initialQty),
    },
    update: {
      quantity: new Prisma.Decimal(item.initialQty),
    },
  })
}
console.log('Created initial inventory transactions and balances')
```

**Completion Criteria**:
- [ ] All 6 components created with correct data
- [ ] Initial transactions created with type='initial'
- [ ] InventoryBalance records created for O(1) lookups
- [ ] Idempotent: skips existing components

---

### Subtask 1.5: Implement SKU and BOM creation

**File**: `/home/pbrown/SkuInventory/scripts/seed-sandbox-brand.ts`
**Pattern**: Rise brand BOM structure (12 components per SKU)
**Instructions**:

1. Create SKUs:

```typescript
// SKU seed data with BOM definitions
const skuData = [
  {
    name: 'Basic Kit',
    internalCode: 'SBOX-BASIC',
    salesChannel: 'Amazon',
    bom: [
      { skuCode: 'SBOX-001', qty: 1 },
      { skuCode: 'SLBL-001', qty: 1 },
      { skuCode: 'SINS-001', qty: 1 },
      { skuCode: 'WDGT-A', qty: 1 },
      { skuCode: 'BWRP-001', qty: 1 },
    ],
  },
  {
    name: 'Premium Kit',
    internalCode: 'SBOX-PREMIUM',
    salesChannel: 'Amazon',
    bom: [
      { skuCode: 'SBOX-001', qty: 1 },
      { skuCode: 'SLBL-001', qty: 1 },
      { skuCode: 'SINS-001', qty: 1 },
      { skuCode: 'WDGT-A', qty: 1 },
      { skuCode: 'WDGT-B', qty: 2 },
      { skuCode: 'BWRP-001', qty: 2 },
    ],
  },
]

for (const item of skuData) {
  // Check if SKU exists
  let sku = await prisma.sKU.findFirst({
    where: { brandId: brand.id, internalCode: item.internalCode },
  })

  if (!sku) {
    sku = await prisma.sKU.create({
      data: {
        brandId: brand.id,
        companyId: company.id,
        name: item.name,
        internalCode: item.internalCode,
        salesChannel: item.salesChannel,
        createdById: adminUser.id,
        updatedById: adminUser.id,
      },
    })
    console.log(`  Created SKU: ${item.name}`)
  } else {
    console.log(`  Skipped SKU: ${item.name} (already exists)`)
  }

  // Create BOM version if doesn't exist
  let bomVersion = await prisma.bOMVersion.findFirst({
    where: { skuId: sku.id, isActive: true },
  })

  if (!bomVersion) {
    bomVersion = await prisma.bOMVersion.create({
      data: {
        skuId: sku.id,
        versionName: 'v1',
        effectiveStartDate: new Date(),
        isActive: true,
        notes: 'Initial BOM version',
        createdById: adminUser.id,
      },
    })

    // Create BOM lines
    for (const bomItem of item.bom) {
      await prisma.bOMLine.create({
        data: {
          bomVersionId: bomVersion.id,
          componentId: components[bomItem.skuCode],
          quantityPerUnit: bomItem.qty,
        },
      })
    }
    console.log(`    Created BOM with ${item.bom.length} lines`)
  }
}
```

**Completion Criteria**:
- [ ] Both SKUs created with correct salesChannel
- [ ] BOMVersion created for each SKU with isActive=true
- [ ] BOMLines link components to SKUs with correct quantities
- [ ] Idempotent: skips existing SKUs/BOMs

---

### Subtask 1.6: Add sample transactions (optional enhancement)

**File**: `/home/pbrown/SkuInventory/scripts/seed-sandbox-brand.ts`
**Instructions**:

1. Add a few sample transactions beyond initial inventory to demonstrate the system:
   - 1-2 receipt transactions (restocking)
   - 1-2 build transactions (consume components, produce finished goods)
   - 1 adjustment transaction (inventory correction)

```typescript
// Sample receipt transaction
await prisma.transaction.create({
  data: {
    companyId: company.id,
    type: 'receipt',
    date: new Date(),
    locationId: mainWarehouse.id,
    supplier: 'Sample Supplier Co.',
    notes: 'Sandbox sample receipt',
    status: 'approved',
    createdById: adminUser.id,
    lines: {
      create: [
        { componentId: components['WDGT-A'], quantityChange: 50, costPerUnit: 2.00 },
        { componentId: components['WDGT-B'], quantityChange: 75, costPerUnit: 1.50 },
      ],
    },
  },
})

// Update balances for receipt
await prisma.inventoryBalance.update({
  where: {
    componentId_locationId: {
      componentId: components['WDGT-A'],
      locationId: mainWarehouse.id,
    },
  },
  data: { quantity: { increment: 50 } },
})
await prisma.inventoryBalance.update({
  where: {
    componentId_locationId: {
      componentId: components['WDGT-B'],
      locationId: mainWarehouse.id,
    },
  },
  data: { quantity: { increment: 75 } },
})
console.log('Created sample receipt transaction')
```

**Completion Criteria**:
- [ ] Sample transactions created with proper types
- [ ] InventoryBalance updated to match transactions
- [ ] Demonstrates realistic workflow

---

### Subtask 1.7: Implement script completion and error handling

**File**: `/home/pbrown/SkuInventory/scripts/seed-sandbox-brand.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/scripts/seed-inventory.ts` lines 134-146
**Instructions**:

1. Add completion summary and cleanup:

```typescript
  console.log('\n========================================')
  console.log('Sandbox Brand Seed Summary')
  console.log('========================================')
  console.log(`  Company: ${company.name}`)
  console.log(`  Brand: ${brand.name}`)
  console.log(`  Components: ${componentData.length}`)
  console.log(`  SKUs: ${skuData.length}`)
  console.log(`  Locations: 2`)
  console.log('\nSandbox brand seeded successfully!')
  console.log('Switch to Sandbox brand in the UI to start testing.')

  await pool.end()
}

main()
  .catch((e) => {
    console.error('Error seeding Sandbox brand:', e)
    process.exit(1)
  })
```

**Completion Criteria**:
- [ ] Summary printed with counts
- [ ] Pool closed properly
- [ ] Error handling with exit code 1

---

## Phase 2: Validation and Testing

### Subtask 2.1: Verify TypeScript compilation

**File**: `/home/pbrown/SkuInventory/scripts/seed-sandbox-brand.ts`
**Instructions**:

Run TypeScript check:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] No TypeScript errors
- [ ] All imports resolve correctly

---

### Subtask 2.2: Run seed script on test database

**Instructions**:

1. Execute the seed script against test database:
```bash
DATABASE_URL="postgresql://inventory_test:inventory_test_2025@localhost:2346/inventory_test" npx tsx scripts/seed-sandbox-brand.ts
```

2. Verify data created:
```bash
docker exec inventory-db-test psql -U inventory_test -d inventory_test -c "
SELECT b.name as brand,
  (SELECT COUNT(*) FROM \"Component\" WHERE \"brandId\" = b.id) as components,
  (SELECT COUNT(*) FROM \"SKU\" WHERE \"brandId\" = b.id) as skus
FROM \"Brand\" b WHERE b.name = 'Sandbox';
"
```

**Completion Criteria**:
- [ ] Script runs without errors
- [ ] Sandbox brand created with 6 components and 2 SKUs
- [ ] No duplicate data on re-run (idempotent)

---

### Subtask 2.3: Verify build passes

**Instructions**:

```bash
npm run build
```

**Completion Criteria**:
- [ ] Build completes without errors
- [ ] No new warnings introduced

---

## Summary of Deliverables

**Files Created**: 1
- `/home/pbrown/SkuInventory/scripts/seed-sandbox-brand.ts` - Main seed script

**Files Modified**: 0

**Data Created (in database)**:
- 1 Brand: "Sandbox" (under Tonsil Tech company)
- 2 Locations: "Sandbox Warehouse", "Sandbox FBA"
- 6 Components with initial inventory
- 2 SKUs with active BOMs
- ~10 BOM lines
- Initial + sample transactions

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 -> Phase 2)
2. Use `/home/pbrown/SkuInventory/scripts/seed-inventory.ts` as primary reference
3. Follow Prisma patterns from existing scripts
4. Ensure idempotency (script can be run multiple times safely)
5. Test on TEST database only (port 2346)

---

## Test Strategy Note

- No unit tests required for seed script
- Manual verification via database queries
- Integration testing: run script, verify data in UI

---

## Performance Metrics

| Phase | Duration |
|-------|----------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 10m |
| **Total** | **30m** |
