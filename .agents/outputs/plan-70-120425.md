# Implementation Plan
**Generated**: 2025-12-04T01:30:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: Issue #70 - [Parent #9] Phase 3: Location-aware inventory quantity queries
**Estimated Build Time**: 6-8 hours
**Complexity**: Moderate

## Investigation Summary

### Request Analysis
**Type**: Feature (Enhancement)
**Source**: GitHub Issue #70
**Priority**: High (Part of multi-location inventory tracking roadmap)

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED (affects core inventory calculations)
**Suggested Filter**: `--filter="inventory|bom"`

### Issue Validation
**Status**: Valid - Prerequisites completed
**Recent Changes**:
- `6a431c3` feat(issue #69): add locationId to transactions and transaction services
- Prerequisites #68 (Location model) and #69 (Transaction.locationId) are CLOSED

### Current State Assessment

**Existing components**:
- Location model: EXISTS in schema (lines 41-57) with type, isDefault, isActive fields
- Transaction.locationId: EXISTS (line 196, optional with relation to Location)
- Index on Transaction.locationId: EXISTS (line 218: `@@index([locationId])`)
- Location service: EXISTS at `/home/pbrown/SkuInventory/src/services/location.ts`

**Database**: No migrations needed - schema already supports locationId filtering

**Functions requiring updates**:
1. `getComponentQuantity(componentId)` - Add optional locationId parameter
2. `getComponentQuantities(componentIds)` - Add optional locationId parameter
3. `checkInsufficientInventory(params)` - Add locationId to params
4. `calculateMaxBuildableUnits(skuId)` - Add optional locationId parameter
5. `calculateMaxBuildableUnitsForSKUs(skuIds)` - Add optional locationId parameter

**API Routes requiring updates** (to pass locationId query param):
- `/api/components/route.ts` - GET handler (2 calls to getComponentQuantities)
- `/api/components/[id]/route.ts` - GET handler (1 call to getComponentQuantity)
- `/api/dashboard/route.ts` - GET handler (1 call to getComponentQuantities)
- `/api/bom-versions/[id]/route.ts` - GET handler (1 call to getComponentQuantities)
- `/api/bom-versions/[id]/activate/route.ts` - POST handler (1 call)
- `/api/bom-versions/[id]/clone/route.ts` - POST handler (1 call)
- `/api/skus/[id]/bom-versions/route.ts` - GET/POST handlers (2 calls)
- `/api/export/components/route.ts` - GET handler (1 call)
- `/api/skus/route.ts` - GET handler (1 call via calculateMaxBuildableUnitsForSKUs)
- `/api/skus/[id]/route.ts` - GET/PATCH handlers (2 calls via calculateMaxBuildableUnits)
- `/api/export/skus/route.ts` - GET handler (1 call via calculateMaxBuildableUnits)

**Frontend pages requiring updates** (server components with direct service calls):
- `/app/(dashboard)/components/page.tsx` - 2 calls to getComponentQuantities
- `/app/(dashboard)/skus/page.tsx` - 1 call via calculateMaxBuildableUnitsForSKUs

**Other services requiring updates**:
- `/src/services/lowstock-alert.ts` - 2 calls to getComponentQuantities (lines 205, 312)

**Types**:
- `src/types/component.ts` - May need locationId in query schema (optional)

### Dependencies & Blockers
1. **VERIFIED**: Issue #68 (Location model) - CLOSED
2. **VERIFIED**: Issue #69 (Transaction.locationId) - CLOSED
3. No external dependencies

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Moderate
**Effort**: 6-8 hours
**Risk**: Medium - Core function signatures changing, backward compatibility required

### Patterns Identified

**Primary Pattern**: Existing location filter in transaction services
- File: `/home/pbrown/SkuInventory/src/services/inventory.ts` lines 93-180
- Pattern: `locationId ?? await getDefaultLocationId(companyId)`

**Secondary Pattern**: Query parameter parsing in API routes
- File: `/home/pbrown/SkuInventory/src/app/api/dashboard/route.ts` line 73-78
- Pattern: `const locationId = searchParams.get('locationId') ?? undefined`

### Ripple Effect Analysis

**Files Identified**: 15 files total

**Core Services (2 files)**:
- `/home/pbrown/SkuInventory/src/services/inventory.ts` - Primary changes
- `/home/pbrown/SkuInventory/src/services/bom.ts` - Secondary changes (uses inventory functions)

**API Routes (9 files)**:
- `/home/pbrown/SkuInventory/src/app/api/components/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/components/[id]/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/dashboard/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/activate/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/clone/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/skus/[id]/bom-versions/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/export/components/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/skus/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/skus/[id]/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/export/skus/route.ts`

**Frontend Pages (2 files)**:
- `/home/pbrown/SkuInventory/src/app/(dashboard)/components/page.tsx`
- `/home/pbrown/SkuInventory/src/app/(dashboard)/skus/page.tsx`

**Other Services (1 file)**:
- `/home/pbrown/SkuInventory/src/services/lowstock-alert.ts`

**Types (1 file)**:
- `/home/pbrown/SkuInventory/src/types/component.ts`

**TOTAL FILES AFFECTED**: 15

---

## Executive Summary

This implementation adds optional `locationId` parameter to core inventory quantity calculation functions (`getComponentQuantity`, `getComponentQuantities`, `checkInsufficientInventory`) and BOM buildable unit functions (`calculateMaxBuildableUnits`, `calculateMaxBuildableUnitsForSKUs`). All API routes and frontend pages will be updated to support `?locationId=` query parameter for location-aware filtering. Changes are backward compatible - omitting locationId returns global (all-location) totals.

---

## Phase 1: Core Service Layer - Inventory Functions

### Subtask 1.1: Update getComponentQuantity function
**File**: `/home/pbrown/SkuInventory/src/services/inventory.ts`
**Pattern**: Follow existing Prisma query patterns in same file
**Instructions**:

1. Update function signature to accept optional locationId:
```typescript
export async function getComponentQuantity(
  componentId: string,
  locationId?: string
): Promise<number> {
```

2. Update Prisma query to join through transaction when locationId provided:
```typescript
export async function getComponentQuantity(
  componentId: string,
  locationId?: string
): Promise<number> {
  const whereClause: Prisma.TransactionLineWhereInput = {
    componentId,
  }

  // Add location filter via join to Transaction
  if (locationId) {
    whereClause.transaction = { locationId }
  }

  const result = await prisma.transactionLine.aggregate({
    where: whereClause,
    _sum: { quantityChange: true },
  })
  return result._sum.quantityChange?.toNumber() ?? 0
}
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Function accepts optional locationId parameter
- [ ] When locationId provided, filters by transaction.locationId
- [ ] When locationId omitted, returns global total (backward compatible)
- [ ] TypeScript compiles without errors

### Subtask 1.2: Update getComponentQuantities function
**File**: `/home/pbrown/SkuInventory/src/services/inventory.ts`
**Pattern**: Same pattern as subtask 1.1
**Instructions**:

1. Update function signature (lines 43-45):
```typescript
export async function getComponentQuantities(
  componentIds: string[],
  locationId?: string
): Promise<Map<string, number>> {
```

2. Update Prisma query (lines 46-50):
```typescript
  const whereClause: Prisma.TransactionLineWhereInput = {
    componentId: { in: componentIds },
  }

  // Add location filter via join to Transaction
  if (locationId) {
    whereClause.transaction = { locationId }
  }

  const results = await prisma.transactionLine.groupBy({
    by: ['componentId'],
    where: whereClause,
    _sum: { quantityChange: true },
  })
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Function accepts optional locationId parameter
- [ ] When locationId provided, filters by transaction.locationId
- [ ] When locationId omitted, returns global totals (backward compatible)
- [ ] TypeScript compiles without errors

### Subtask 1.3: Update checkInsufficientInventory function
**File**: `/home/pbrown/SkuInventory/src/services/inventory.ts`
**Pattern**: Follow existing params object pattern at lines 363-366
**Instructions**:

1. Update function params type (lines 363-366):
```typescript
export async function checkInsufficientInventory(params: {
  bomVersionId: string
  unitsToBuild: number
  locationId?: string
}): Promise<InsufficientInventoryItem[]> {
  const { bomVersionId, unitsToBuild, locationId } = params
```

2. Update getComponentQuantities call (line 389):
```typescript
  const quantities = await getComponentQuantities(componentIds, locationId)
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Function params include optional locationId
- [ ] locationId passed to getComponentQuantities
- [ ] TypeScript compiles without errors

### Subtask 1.4: Update createBuildTransaction to pass locationId to checkInsufficientInventory
**File**: `/home/pbrown/SkuInventory/src/services/inventory.ts`
**Pattern**: Follow existing pattern in createBuildTransaction
**Instructions**:

1. Update the checkInsufficientInventory call (lines 483-486):
```typescript
  // Check for insufficient inventory (at the target location if specified)
  const insufficientItems = await checkInsufficientInventory({
    bomVersionId,
    unitsToBuild,
    locationId: locationIdToUse,
  })
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] locationIdToUse passed to checkInsufficientInventory
- [ ] TypeScript compiles without errors

---

## Phase 2: Core Service Layer - BOM Functions

### Subtask 2.1: Update calculateMaxBuildableUnits function
**File**: `/home/pbrown/SkuInventory/src/services/bom.ts`
**Pattern**: Follow existing function signature pattern
**Instructions**:

1. Update function signature (line 60):
```typescript
export async function calculateMaxBuildableUnits(
  skuId: string,
  locationId?: string
): Promise<number | null> {
```

2. Update getComponentQuantities call (line 84):
```typescript
  const quantities = await getComponentQuantities(componentIds, locationId)
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Function accepts optional locationId parameter
- [ ] locationId passed to getComponentQuantities
- [ ] TypeScript compiles without errors

### Subtask 2.2: Update calculateMaxBuildableUnitsForSKUs function
**File**: `/home/pbrown/SkuInventory/src/services/bom.ts`
**Pattern**: Follow existing function signature pattern
**Instructions**:

1. Update function signature (lines 102-104):
```typescript
export async function calculateMaxBuildableUnitsForSKUs(
  skuIds: string[],
  locationId?: string
): Promise<Map<string, number | null>> {
```

2. Update getComponentQuantities call (line 137):
```typescript
  const quantities = await getComponentQuantities(Array.from(allComponentIds), locationId)
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Function accepts optional locationId parameter
- [ ] locationId passed to getComponentQuantities
- [ ] TypeScript compiles without errors
- [ ] Build passes

---

## Phase 3: API Routes - Components

### Subtask 3.1: Update /api/components route
**File**: `/home/pbrown/SkuInventory/src/app/api/components/route.ts`
**Pattern**: Follow dashboard route pattern for query params
**Instructions**:

1. Add locationId to componentListQuerySchema in types file first (Subtask 4.1)

2. Parse locationId from query (after line 30):
```typescript
  const { page, pageSize, search, category, isActive, reorderStatus, sortBy, sortOrder, locationId } =
    queryResult.data
```

3. Update both getComponentQuantities calls (lines 69 and 120):
```typescript
  const quantities = await getComponentQuantities(componentIds, locationId)
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] locationId parsed from query parameters
- [ ] Both getComponentQuantities calls pass locationId
- [ ] TypeScript compiles without errors

### Subtask 3.2: Update /api/components/[id] route
**File**: `/home/pbrown/SkuInventory/src/app/api/components/[id]/route.ts`
**Pattern**: Follow existing searchParams parsing pattern
**Instructions**:

1. Parse locationId from query (after line 128, in GET handler):
```typescript
  const locationId = searchParams.get('locationId') ?? undefined
```

2. Update getComponentQuantity call (line 175):
```typescript
  const quantityOnHand = await getComponentQuantity(id, locationId)
```

3. Update calculateMaxBuildableUnitsForSKUs call (lines 181-183):
```typescript
  const buildableUnits = skuIds.length > 0
    ? await calculateMaxBuildableUnitsForSKUs(skuIds, locationId)
    : new Map<string, number | null>()
```

4. Update getComponentQuantity call in PATCH handler (line 321):
```typescript
  const quantityOnHand = await getComponentQuantity(id)
  // Note: PATCH doesn't need locationId as it returns updated component globally
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] GET handler parses locationId from query
- [ ] getComponentQuantity call passes locationId
- [ ] calculateMaxBuildableUnitsForSKUs passes locationId
- [ ] TypeScript compiles without errors

### Subtask 3.3: Update /api/export/components route
**File**: `/home/pbrown/SkuInventory/src/app/api/export/components/route.ts`
**Pattern**: Follow existing pattern
**Instructions**:

1. Parse locationId from request (update function to accept request):
```typescript
export async function GET(request: NextRequest) {
  // ... existing code ...
  const { searchParams } = new URL(request.url)
  const locationId = searchParams.get('locationId') ?? undefined
```

2. Add NextRequest import if not present.

3. Update getComponentQuantities call (line 36):
```typescript
  const quantities = await getComponentQuantities(componentIds, locationId)
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] GET handler accepts request parameter
- [ ] locationId parsed from query
- [ ] getComponentQuantities passes locationId
- [ ] TypeScript compiles without errors

---

## Phase 4: API Routes - Dashboard

### Subtask 4.1: Update /api/dashboard route
**File**: `/home/pbrown/SkuInventory/src/app/api/dashboard/route.ts`
**Pattern**: Follow existing days parameter parsing pattern
**Instructions**:

1. Parse locationId from query (after line 74):
```typescript
  const locationId = searchParams.get('locationId') ?? undefined
```

2. Update getComponentQuantities call (line 99):
```typescript
  const quantities = await getComponentQuantities(componentIds, locationId)
```

3. Update calculateMaxBuildableUnitsForSKUs call (line 157):
```typescript
  skuIds.length > 0 ? calculateMaxBuildableUnitsForSKUs(skuIds, locationId) : new Map<string, number | null>(),
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] locationId parsed from query parameters
- [ ] getComponentQuantities passes locationId
- [ ] calculateMaxBuildableUnitsForSKUs passes locationId
- [ ] TypeScript compiles without errors

---

## Phase 5: API Routes - BOM Versions

### Subtask 5.1: Update /api/bom-versions/[id] route
**File**: `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/route.ts`
**Pattern**: Follow existing pattern
**Instructions**:

1. Parse locationId from query (after line 23, in GET handler):
```typescript
  const { searchParams } = new URL(request.url)
  const locationId = searchParams.get('locationId') ?? undefined
```

2. Update getComponentQuantities call (line 66):
```typescript
  const quantities = await getComponentQuantities(componentIds, locationId)
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] locationId parsed from query
- [ ] getComponentQuantities passes locationId
- [ ] TypeScript compiles without errors

### Subtask 5.2: Update /api/bom-versions/[id]/activate route
**File**: `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/activate/route.ts`
**Pattern**: Follow existing pattern
**Instructions**:

1. Parse locationId from query (after line 24):
```typescript
  const { searchParams } = new URL(request.url)
  const locationId = searchParams.get('locationId') ?? undefined
```

2. Update getComponentQuantities call (line 50):
```typescript
  const quantities = await getComponentQuantities(componentIds, locationId)
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] locationId parsed from query
- [ ] getComponentQuantities passes locationId
- [ ] TypeScript compiles without errors

### Subtask 5.3: Update /api/bom-versions/[id]/clone route
**File**: `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/clone/route.ts`
**Pattern**: Follow existing pattern
**Instructions**:

1. Parse locationId from query (after line 26):
```typescript
  const { searchParams } = new URL(request.url)
  const locationId = searchParams.get('locationId') ?? undefined
```

2. Update getComponentQuantities call (line 61):
```typescript
  const quantities = await getComponentQuantities(componentIds, locationId)
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] locationId parsed from query
- [ ] getComponentQuantities passes locationId
- [ ] TypeScript compiles without errors

---

## Phase 6: API Routes - SKUs

### Subtask 6.1: Update /api/skus/[id]/bom-versions route
**File**: `/home/pbrown/SkuInventory/src/app/api/skus/[id]/bom-versions/route.ts`
**Pattern**: Follow existing query parsing pattern
**Instructions**:

1. Parse locationId from query in GET handler (after line 33):
```typescript
  const locationId = searchParams.get('locationId') ?? undefined
```

2. Update getComponentQuantities call in GET (line 82):
```typescript
  const quantities = await getComponentQuantities(Array.from(allComponentIds), locationId)
```

3. Parse locationId in POST handler (after line 136):
```typescript
  const { searchParams } = new URL(request.url)
  const locationId = searchParams.get('locationId') ?? undefined
```

4. Update getComponentQuantities call in POST (line 188):
```typescript
  const quantities = await getComponentQuantities(componentIds, locationId)
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Both handlers parse locationId
- [ ] Both getComponentQuantities calls pass locationId
- [ ] TypeScript compiles without errors

### Subtask 6.2: Update /api/skus route
**File**: `/home/pbrown/SkuInventory/src/app/api/skus/route.ts`
**Pattern**: Follow existing query parsing pattern
**Instructions**:

1. Parse locationId from query (after line 30):
```typescript
  const locationId = searchParams.get('locationId') ?? undefined
```

2. Update calculateMaxBuildableUnitsForSKUs call (line 78):
```typescript
  skuIds.length > 0 ? calculateMaxBuildableUnitsForSKUs(skuIds, locationId) : new Map<string, number | null>(),
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] locationId parsed from query
- [ ] calculateMaxBuildableUnitsForSKUs passes locationId
- [ ] TypeScript compiles without errors

### Subtask 6.3: Update /api/skus/[id] route
**File**: `/home/pbrown/SkuInventory/src/app/api/skus/[id]/route.ts`
**Pattern**: Follow existing pattern
**Instructions**:

1. Parse locationId from query in GET handler (after line 27):
```typescript
  const { searchParams } = new URL(request.url)
  const locationId = searchParams.get('locationId') ?? undefined
```

2. Update calculateMaxBuildableUnits call in GET (line 70):
```typescript
  const maxBuildableUnits = await calculateMaxBuildableUnits(id, locationId)
```

3. Update calculateMaxBuildableUnits call in PATCH (line 193):
```typescript
  const maxBuildableUnits = await calculateMaxBuildableUnits(id)
  // Note: PATCH returns globally, no locationId needed
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] GET handler parses locationId
- [ ] calculateMaxBuildableUnits in GET passes locationId
- [ ] TypeScript compiles without errors

### Subtask 6.4: Update /api/export/skus route
**File**: `/home/pbrown/SkuInventory/src/app/api/export/skus/route.ts`
**Pattern**: Follow existing pattern
**Instructions**:

1. Update function to accept request and parse locationId:
```typescript
export async function GET(request: NextRequest) {
  // ... existing code ...
  const { searchParams } = new URL(request.url)
  const locationId = searchParams.get('locationId') ?? undefined
```

2. Add NextRequest import if not present.

3. Update calculateMaxBuildableUnits call (line 48):
```typescript
  maxBuildableUnits = await calculateMaxBuildableUnits(sku.id, locationId)
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] GET handler accepts request parameter
- [ ] locationId parsed from query
- [ ] calculateMaxBuildableUnits passes locationId
- [ ] TypeScript compiles without errors

---

## Phase 7: Frontend Pages

### Subtask 7.1: Update components page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/components/page.tsx`
**Pattern**: Follow existing searchParams pattern
**Instructions**:

1. Add locationId to PageProps searchParams interface (line 16):
```typescript
  searchParams: Promise<{
    page?: string
    pageSize?: string
    search?: string
    category?: string
    reorderStatus?: string
    sortBy?: string
    sortOrder?: string
    locationId?: string
  }>
```

2. Add locationId to getComponents params (line 28):
```typescript
async function getComponents(
  selectedCompanyId: string,
  params: {
    page: number
    pageSize: number
    search?: string
    category?: string
    reorderStatus?: string
    sortBy: string
    sortOrder: 'asc' | 'desc'
    locationId?: string
  }
)
```

3. Update both getComponentQuantities calls (lines 71 and 126):
```typescript
  const quantities = await getComponentQuantities(componentIds, params.locationId)
```

4. Pass locationId in page component (after line 176):
```typescript
  const { components, total } = await getComponents(selectedCompanyId, {
    page,
    pageSize,
    search: params.search,
    category: params.category,
    reorderStatus: params.reorderStatus,
    sortBy: params.sortBy ?? 'name',
    sortOrder: (params.sortOrder as 'asc' | 'desc') ?? 'asc',
    locationId: params.locationId,
  })
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] locationId added to searchParams interface
- [ ] locationId passed through getComponents
- [ ] Both getComponentQuantities calls use locationId
- [ ] TypeScript compiles without errors
- [ ] Build passes

### Subtask 7.2: Update skus page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/skus/page.tsx`
**Pattern**: Follow existing pattern
**Instructions**:

1. Add locationId to SearchParams interface (line 14):
```typescript
interface SearchParams {
  page?: string
  pageSize?: string
  search?: string
  salesChannel?: string
  sortBy?: string
  sortOrder?: string
  locationId?: string
}
```

2. Parse locationId in getSKUs (after line 27):
```typescript
  const locationId = searchParams.locationId
```

3. Update calculateMaxBuildableUnitsForSKUs call (line 73):
```typescript
  skuIds.length > 0 ? calculateMaxBuildableUnitsForSKUs(skuIds, locationId) : new Map<string, number | null>(),
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] locationId added to SearchParams
- [ ] calculateMaxBuildableUnitsForSKUs passes locationId
- [ ] TypeScript compiles without errors
- [ ] Build passes

---

## Phase 8: Types Update

### Subtask 8.1: Add locationId to component query schema
**File**: `/home/pbrown/SkuInventory/src/types/component.ts`
**Pattern**: Follow existing schema pattern
**Instructions**:

1. Add locationId to componentListQuerySchema (after line 46):
```typescript
export const componentListQuerySchema = z.object({
  page: z.coerce.number().int().positive().default(1),
  pageSize: z.coerce.number().int().positive().max(100).default(50),
  search: z.string().optional(),
  category: z.string().optional(),
  isActive: z
    .string()
    .transform((val) => val === 'true')
    .optional(),
  reorderStatus: z.enum(['critical', 'warning', 'ok']).optional(),
  sortBy: z.enum(['name', 'skuCode', 'category', 'costPerUnit', 'reorderPoint', 'createdAt']).default('name'),
  sortOrder: z.enum(['asc', 'desc']).default('asc'),
  locationId: z.string().uuid().optional(),
})
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] locationId added to schema as optional UUID
- [ ] TypeScript compiles without errors

---

## Phase 9: Lowstock Alert Service (Optional - for completeness)

### Subtask 9.1: Update lowstock-alert service (if location-aware alerts desired)
**File**: `/home/pbrown/SkuInventory/src/services/lowstock-alert.ts`
**Pattern**: Follow existing pattern
**Instructions**:

Note: Per issue scope, lowstock alerts are not required to be location-aware in Phase 3. However, for future-proofing, the service functions could accept locationId. This subtask is OPTIONAL.

If implementing:
1. Add locationId parameter to evaluateLowStockAlerts (line 164)
2. Add locationId parameter to getComponentsInAlertStatus (line 290)
3. Update getComponentQuantities calls (lines 205, 312)

**Completion Criteria**:
- [ ] (OPTIONAL) Functions accept locationId
- [ ] (OPTIONAL) Calls pass locationId

---

## Phase 10: Final Validation

### Subtask 10.1: Full build and type check
**Instructions**:
```bash
npx tsc --noEmit
npm run build
npm run lint
```

**Completion Criteria**:
- [ ] TypeScript compiles without errors
- [ ] Build passes without errors
- [ ] Lint passes without errors

### Subtask 10.2: Manual testing checklist
**Instructions**:
1. Test /api/components without locationId - should return global totals
2. Test /api/components?locationId=<valid-uuid> - should return location-filtered totals
3. Test /api/dashboard without locationId - should return global stats
4. Test /api/dashboard?locationId=<valid-uuid> - should return location-filtered stats
5. Test buildable units in SKU list with and without locationId

**Completion Criteria**:
- [ ] Global (no locationId) returns same values as before
- [ ] Location-filtered queries return correct subset
- [ ] No regressions in existing functionality

---

## Summary of Deliverables

**Files Modified**: 15 total
- Core Services: 2 files
  - `/home/pbrown/SkuInventory/src/services/inventory.ts`
  - `/home/pbrown/SkuInventory/src/services/bom.ts`
- API Routes: 9 files
  - `/home/pbrown/SkuInventory/src/app/api/components/route.ts`
  - `/home/pbrown/SkuInventory/src/app/api/components/[id]/route.ts`
  - `/home/pbrown/SkuInventory/src/app/api/dashboard/route.ts`
  - `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/route.ts`
  - `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/activate/route.ts`
  - `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/clone/route.ts`
  - `/home/pbrown/SkuInventory/src/app/api/skus/[id]/bom-versions/route.ts`
  - `/home/pbrown/SkuInventory/src/app/api/export/components/route.ts`
  - `/home/pbrown/SkuInventory/src/app/api/skus/route.ts`
  - `/home/pbrown/SkuInventory/src/app/api/skus/[id]/route.ts`
  - `/home/pbrown/SkuInventory/src/app/api/export/skus/route.ts`
- Frontend Pages: 2 files
  - `/home/pbrown/SkuInventory/src/app/(dashboard)/components/page.tsx`
  - `/home/pbrown/SkuInventory/src/app/(dashboard)/skus/page.tsx`
- Types: 1 file
  - `/home/pbrown/SkuInventory/src/types/component.ts`
- Optional: 1 file
  - `/home/pbrown/SkuInventory/src/services/lowstock-alert.ts`

**Files Created**: 0

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 through Phase 10)
2. Run `npx tsc --noEmit` after each subtask
3. Run `npm run build` after completing each phase
4. All function signature changes must maintain backward compatibility
5. Test completion criteria before proceeding to next subtask
6. Follow reference patterns exactly

## Test Strategy Note
- Primary validation: TypeScript compilation and build
- Manual testing: API endpoints with and without locationId
- Regression: Ensure existing functionality unchanged when locationId omitted

## Performance Metrics
| Phase | Estimated Duration |
|-------|----------|
| Phase 1: Inventory Services | 45m |
| Phase 2: BOM Services | 30m |
| Phase 3: Components API | 30m |
| Phase 4: Dashboard API | 15m |
| Phase 5: BOM Versions API | 30m |
| Phase 6: SKUs API | 45m |
| Phase 7: Frontend Pages | 30m |
| Phase 8: Types | 15m |
| Phase 9: Optional | 15m |
| Phase 10: Validation | 30m |
| **Total** | **4.5-5.5h** |
