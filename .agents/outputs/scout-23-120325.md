# Scout Report: Add Sales Channel Filter to Transactions View

## Request Analysis
**Type**: Enhancement
**Source**: GitHub Issue #23
**Priority**: Medium

## Task Classification
**Category**: NEW_FEATURE (small enhancement)
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="transaction"` or None (small scope)

## Issue Validation
**Status**: Valid and ready to implement
**Recent Changes**: No recent changes to transaction filtering logic detected

## Current State

### Database Schema
- Transaction model in Prisma schema already has `salesChannel` field:
  - Type: `String?` (optional)
  - Database type: `@db.VarChar(50)`
  - Field exists: **YES**
  - No migration needed

### API Route Implementation
**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/route.ts`

**Current Filters Supported** (lines 21-41):
- `type` - Transaction type (receipt, adjustment, build, initial)
- `componentId` - Filter by specific component
- `skuId` - Filter by specific SKU
- `dateFrom` - Start date filter
- `dateTo` - End date filter
- `page`, `pageSize` - Pagination
- `sortBy`, `sortOrder` - Sorting

**salesChannel filter**: NOT currently supported in API route

**How filtering works**:
- Query params parsed via `transactionListQuerySchema` (imported from `@/types/transaction`)
- Where clause built as `Prisma.TransactionWhereInput` object
- Filters applied conditionally with spread syntax: `...(type && { type })`

**Response includes salesChannel**: YES (line 72)

### Type Definitions
**File**: `/home/pbrown/SkuInventory/src/types/transaction.ts`

**transactionListQuerySchema** (lines 72-82):
- Does NOT include salesChannel parameter
- Uses Zod for validation
- Includes: page, pageSize, type, componentId, skuId, dateFrom, dateTo, sortBy, sortOrder

**TransactionResponse interface** (lines 87-106):
- Includes `salesChannel: string | null` (line 93)

**Available Sales Channels** (from `/home/pbrown/SkuInventory/src/types/index.ts`, line 34):
```typescript
export const salesChannels = ['Amazon', 'Shopify', 'TikTok', 'Generic'] as const
```

### UI Implementation
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/transactions/page.tsx`

**Current Filters in State** (lines 49-55):
- `type` - Select dropdown
- `componentId` - (not in UI but in state)
- `skuId` - (not in UI but in state)
- `dateFrom` - Date input
- `dateTo` - Date input

**salesChannel filter**: NOT present in UI or state

**Filter UI Pattern** (lines 166-224):
- Card with CardContent wrapper
- Flex layout with gap-4 for filter inputs
- Each filter has:
  - Label with `text-xs text-muted-foreground`
  - Input/Select component with controlled value
  - Width specified (e.g., `w-[150px]`)
- "Apply" and "Clear" buttons
- Uses `updateFilters()` function to sync URL params

**Existing Select Pattern** (lines 177-192):
```tsx
<Select
  value={filters.type || 'all'}
  onValueChange={(value) => setFilters((prev) => ({ ...prev, type: value === 'all' ? '' : value }))}
>
  <SelectTrigger className="w-[150px]">
    <SelectValue placeholder="All Types" />
  </SelectTrigger>
  <SelectContent>
    {TRANSACTION_TYPES.map((t) => (
      <SelectItem key={t.value} value={t.value}>
        {t.label}
      </SelectItem>
    ))}
  </SelectContent>
</Select>
```

### Export Functionality
**File**: `/home/pbrown/SkuInventory/src/app/api/export/transactions/route.ts`

**Current Export Filters** (lines 23-61):
- `type` - Transaction type filter
- `dateFrom` - Start date
- `dateTo` - End date

**salesChannel filter**: NOT supported in export

**Export includes salesChannel in data**: YES (line 105, 131)

**Export UI Implementation** (line 163 in page.tsx):
```tsx
<ExportButton exportType="transactions" queryParams={exportQueryParams} />
```

`exportQueryParams` object (lines 150-154):
```tsx
const exportQueryParams = {
  type: filters.type,
  dateFrom: filters.dateFrom,
  dateTo: filters.dateTo,
}
```

**Does NOT include salesChannel**: Correct, needs to be added

## Dependencies & Blockers

**None** - All required infrastructure exists:
- Database field: present
- Type definitions: available (`salesChannels` array in `@/types/index.ts`)
- UI components: shadcn Select already used
- Pattern to follow: SKUs page already implements salesChannel filter

**Can Proceed?**: YES

## Complexity Assessment
**Complexity**: Simple
**Effort**: 1-2 hours
**Risk**: Low

**Reasoning**:
- Field already exists in database
- Clear pattern to follow from type filter and SKU page
- Minimal changes required (3 files + 1 type file)
- No schema changes
- No ripple effects to other features

## Patterns to Follow

**Primary Reference**: `/home/pbrown/SkuInventory/src/components/features/SKUTable.tsx` (lines 93-108)
- Implements salesChannel filter using Select dropdown
- Uses `salesChannels` array from `@/types/index.ts`
- Pattern:
  ```tsx
  <Select
    value={searchParams.get('salesChannel') || 'all'}
    onValueChange={(value) => updateFilters({ salesChannel: value === 'all' ? '' : value })}
  >
    <SelectTrigger className="w-[150px]">
      <SelectValue placeholder="All Channels" />
    </SelectTrigger>
    <SelectContent>
      <SelectItem value="all">All Channels</SelectItem>
      {salesChannels.map((channel) => (
        <SelectItem key={channel} value={channel}>
          {channel}
        </SelectItem>
      ))}
    </SelectContent>
  </Select>
  ```

**Secondary Reference**: Current type filter implementation in transactions page
- Shows how to integrate filter into existing UI
- Shows state management pattern

## Files to Create/Modify

### 1. Modify: `/home/pbrown/SkuInventory/src/types/transaction.ts`
**Purpose**: Add salesChannel to query schema
**Lines to modify**: 72-82 (transactionListQuerySchema)
**Change**:
```typescript
export const transactionListQuerySchema = z.object({
  page: z.coerce.number().int().positive().default(1),
  pageSize: z.coerce.number().int().positive().max(100).default(50),
  type: z.enum(['receipt', 'build', 'adjustment', 'initial']).optional(),
  componentId: z.string().uuid().optional(),
  skuId: z.string().uuid().optional(),
  salesChannel: z.string().optional(),  // ADD THIS LINE
  dateFrom: z.coerce.date().optional(),
  dateTo: z.coerce.date().optional(),
  sortBy: z.enum(['date', 'createdAt', 'type']).default('createdAt'),
  sortOrder: z.enum(['asc', 'desc']).default('desc'),
})
```

### 2. Modify: `/home/pbrown/SkuInventory/src/app/api/transactions/route.ts`
**Purpose**: Add salesChannel to where clause
**Lines to modify**: 21 (destructure), 25-42 (where clause)
**Changes**:
- Add `salesChannel` to destructured variables (line 21)
- Add conditional salesChannel filter to where clause (around line 28)

### 3. Modify: `/home/pbrown/SkuInventory/src/app/(dashboard)/transactions/page.tsx`
**Purpose**: Add salesChannel filter to UI
**Lines to modify**:
- Line 4: Add `salesChannels` import from `@/types`
- Lines 49-55: Add `salesChannel` to filters state
- Lines 84: Add salesChannel to params if present
- Lines 110-115: Add salesChannel to initial state and clear
- Lines 150-154: Add salesChannel to exportQueryParams
- Lines 192-213: Add Select dropdown after dateTo filter

**UI Location**: Add after "Date To" input, before Apply/Clear buttons

### 4. Modify: `/home/pbrown/SkuInventory/src/app/api/export/transactions/route.ts`
**Purpose**: Add salesChannel filter to export
**Lines to modify**:
- Line 23-25: Read salesChannel param
- Lines 44-61: Add salesChannel to where clause (after type filter)

## Final Sweep Results

**Services Search**: 0 files - no service layer involvement needed
**API Routes**: 2 routes affected
- `/home/pbrown/SkuInventory/src/app/api/transactions/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/export/transactions/route.ts`

**Type Definitions**: 1 file affected
- `/home/pbrown/SkuInventory/src/types/transaction.ts`

**Components**: 1 page affected
- `/home/pbrown/SkuInventory/src/app/(dashboard)/transactions/page.tsx`

**Test Files**: 1 test file may need new test case
- `/home/pbrown/SkuInventory/tests/integration/transactions.test.ts` (199 transaction-related assertions)
- E2E test file exists but likely doesn't test filtering: `/home/pbrown/SkuInventory/tests/e2e/sku-recent-transactions.spec.ts`

**Imports**: Will need to import `salesChannels` from `@/types/index.ts` in page component

**All Affected Files** (comprehensive list):
1. `/home/pbrown/SkuInventory/src/types/transaction.ts` - Add salesChannel to schema
2. `/home/pbrown/SkuInventory/src/app/api/transactions/route.ts` - Add filter logic
3. `/home/pbrown/SkuInventory/src/app/(dashboard)/transactions/page.tsx` - Add UI filter
4. `/home/pbrown/SkuInventory/src/app/api/export/transactions/route.ts` - Add export filter
5. `/home/pbrown/SkuInventory/tests/integration/transactions.test.ts` - Add test for filter (optional but recommended)

**No ripple effects identified** - salesChannel is already exposed in API responses and stored in database. This change only adds filtering capability.

## Acceptance Criteria

Based on issue requirements:

- [ ] Add salesChannel parameter to transaction list API query schema
- [ ] API route filters transactions by salesChannel when parameter provided
- [ ] Transaction page UI includes Select dropdown for salesChannel filter
- [ ] Select dropdown shows "All Channels" option plus all available channels (Amazon, Shopify, TikTok, Generic)
- [ ] Filter integrates with existing filter UI pattern (same style as Type filter)
- [ ] Clear Filters button resets salesChannel filter
- [ ] Export functionality respects salesChannel filter
- [ ] Filter works correctly with other filters (type, dates)
- [ ] URL params updated when salesChannel filter changes
- [ ] Page resets to page 1 when filter applied

## UI Visibility Requirements
**Element**: Sales Channel Select Filter
**Location**: Transactions page filter bar, between "Date To" and Apply/Clear buttons
**Visibility**: ALL devices (desktop and mobile)
**CSS classes to avoid**: None - standard inline filter, always visible in filter card

## Handoff to Plan Agent

**Summary**:
This is a straightforward filter addition that follows existing patterns. The salesChannel field already exists in the database and is returned in API responses. We need to add filtering capability in 4 locations: the type schema, the API route handler, the export route, and the UI. The SKUs page already implements an identical salesChannel filter that we can copy as a reference. No database changes, no service layer changes, and minimal risk.

**Key Points**:
1. Database field `Transaction.salesChannel` already exists (VARCHAR 50)
2. Sales channels defined in `/home/pbrown/SkuInventory/src/types/index.ts`: ['Amazon', 'Shopify', 'TikTok', 'Generic']
3. Exact pattern to follow exists in SKUTable component (lines 93-108)
4. Export functionality must be updated to respect the filter
5. No migration needed, no type changes to models, no ripple effects
6. Tests should verify filtering works alone and combined with other filters

**Suggested Phases**:
1. Update type schema (transactionListQuerySchema) to accept salesChannel parameter
2. Update API route to filter by salesChannel in where clause
3. Update export route to filter by salesChannel
4. Add UI Select dropdown for salesChannel filter (copy from SKUTable pattern)
5. Update exportQueryParams to include salesChannel
6. Test manually: filter alone, filter with type, filter with dates, clear filters, export with filter
7. Optional: Add integration test for salesChannel filtering

**Estimated Implementation Time**: 1-2 hours including testing

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Issue Parsing | 2m |
| Codebase Exploration | 8m |
| Pattern Identification | 4m |
| Report Writing | 8m |
| **Total** | **22m** |

---
AGENT_RETURN: scout-23-120325
