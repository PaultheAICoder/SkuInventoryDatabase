# Implementation Plan
**Generated**: 2025-12-09T06:00:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #235
**Estimated Build Time**: 1-2 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Enhancement (Phase 1 of multi-phase feedback system restoration)
**Source**: GitHub Issue #235
**Priority**: High (foundation for subsequent phases)

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: FAST_PATH (smoke tests only - schema changes and build verification)
**Suggested Filter**: None (no tests affected by these schema-only changes)

### Issue Validation
**Status**: Valid
**Recent Changes**:
- Commit 20b0d42 removed the Feedback database tables in favor of GitHub-only approach
- The current implementation uses volatile in-memory `lastCheckTime` (line 25 of `/home/pbrown/SkuInventory/src/app/api/cron/email-monitor/route.ts`)
- CRON_SECRET is referenced in `.env.example` (line 39) and `src/lib/env.ts` (line 13) but NOT in `.env` or `docker-compose.prod.yml`

### Current State Assessment
- **CRON_SECRET**:
  - Defined in `.env.example` (line 39): `CRON_SECRET=your-cron-secret-here-min-16-chars`
  - Validated in `src/lib/env.ts` (line 13): `CRON_SECRET: z.string().min(16).optional()`
  - Used in `src/app/api/cron/alerts/route.ts` (line 26) and `src/app/api/cron/email-monitor/route.ts` (line 44)
  - **Missing from**: `.env` and `docker/docker-compose.prod.yml`
- **Database**:
  - No Feedback or EmailMonitorState models exist in current schema
  - User model exists at lines 102-131 of schema with existing relations
  - Most recent migration: `20251206155748_add_single_active_bom_constraint`
- **API Routes**: Email monitor exists at `/api/cron/email-monitor/` using in-memory state
- **Types**: Feedback types exist in `src/types/feedback.ts` but are minimal (no DB types)

### Dependencies & Blockers
1. None - this is Phase 1 foundation work

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Simple
**Effort**: 1-2 hours
**Risk**: Low (additive schema changes, no code modifications in Phase 1)

### Patterns Identified
**Primary**: `prisma/schema.prisma` - Existing enum and model patterns (e.g., TransactionStatus enum at line 244, Transaction model at line 255)
**Secondary**: `docker/docker-compose.prod.yml` - Environment variable passing pattern (lines 24-36)

### Ripple Effect Analysis
**Files Identified**: 3 (all modifications, no code changes in Phase 1)
- `/home/pbrown/SkuInventory/.env` - Add CRON_SECRET
- `/home/pbrown/SkuInventory/docker/docker-compose.prod.yml` - Pass CRON_SECRET to container
- `/home/pbrown/SkuInventory/prisma/schema.prisma` - Add Feedback enum and models, User relation

**Note**: This is Phase 1 only. No service layer or API changes are required - those come in subsequent phases.

---

## Executive Summary
Add CRON_SECRET to environment configuration and create Prisma migration for Feedback and EmailMonitorState database tables. This establishes the foundation for reliable feedback tracking without modifying any existing code.

## Phase 1: Environment Configuration

### Subtask 1.1: Add CRON_SECRET to .env
**File**: `/home/pbrown/SkuInventory/.env`
**Pattern**: Follow existing environment variable format
**Instructions**:
1. Generate a secure 32+ character secret using: `openssl rand -base64 32`
2. Add the following line after the `GITHUB_WEBHOOK_SECRET` line:
```
# Cron Job Secret for /api/cron/* endpoints
CRON_SECRET=<generated-secret>
```

**Validation**:
```bash
grep "CRON_SECRET=" /home/pbrown/SkuInventory/.env
```

**Completion Criteria**:
- [ ] CRON_SECRET is defined in .env
- [ ] Secret is at least 32 characters long

### Subtask 1.2: Add CRON_SECRET to docker-compose.prod.yml
**File**: `/home/pbrown/SkuInventory/docker/docker-compose.prod.yml`
**Pattern**: Follow existing environment variable pattern at lines 24-36
**Instructions**:
1. Add the following line to the `app` service `environment` section (after FEEDBACK_EMAIL):
```yaml
      - CRON_SECRET=${CRON_SECRET}
```

**Validation**:
```bash
grep "CRON_SECRET" /home/pbrown/SkuInventory/docker/docker-compose.prod.yml
```

**Completion Criteria**:
- [ ] CRON_SECRET is passed to app container
- [ ] YAML syntax is valid (no indentation errors)

## Phase 2: Database Schema

### Subtask 2.1: Add FeedbackStatus Enum to Prisma Schema
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Pattern**: Follow existing enum pattern (e.g., TransactionStatus at line 244)
**Instructions**:
1. Add the following enum BEFORE the comment at line 596 (`// Note: Feedback tracking...`):
```prisma
// ============================================
// Feedback Tracking Entities
// ============================================

enum FeedbackStatus {
  pending           // Issue created
  resolved          // Issue closed, notification sent
  verified          // User confirmed fix
  changes_requested // User needs more work
}
```

**Validation**:
```bash
grep -A 6 "enum FeedbackStatus" /home/pbrown/SkuInventory/prisma/schema.prisma
```

**Completion Criteria**:
- [ ] FeedbackStatus enum exists with 4 values

### Subtask 2.2: Add Feedback Model to Prisma Schema
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Pattern**: Follow existing model patterns (e.g., DefectAlert at line 438)
**Instructions**:
1. Add the following model after the FeedbackStatus enum:
```prisma
model Feedback {
  id                    String         @id @default(uuid())
  userId                String
  user                  User           @relation(fields: [userId], references: [id])

  // GitHub link
  githubIssueNumber     Int            @unique
  githubIssueUrl        String         @db.VarChar(500)

  // Status tracking
  status                FeedbackStatus @default(pending)

  // Notification tracking
  notificationSentAt    DateTime?
  notificationMessageId String?        @db.VarChar(255)

  // Response tracking
  responseReceivedAt    DateTime?
  responseEmailId       String?        @db.VarChar(255)
  responseContent       String?        @db.Text
  followUpIssueNumber   Int?
  followUpIssueUrl      String?        @db.VarChar(500)

  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt

  @@index([status])
  @@index([githubIssueNumber])
  @@index([userId])
}
```

**Validation**:
```bash
grep -A 5 "model Feedback" /home/pbrown/SkuInventory/prisma/schema.prisma
```

**Completion Criteria**:
- [ ] Feedback model exists with all fields from issue spec
- [ ] Indexes are defined for status, githubIssueNumber, userId

### Subtask 2.3: Add EmailMonitorState Model to Prisma Schema
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Pattern**: Follow singleton pattern (similar to AlertConfig with @unique on companyId)
**Instructions**:
1. Add the following model after the Feedback model:
```prisma
model EmailMonitorState {
  id            String   @id @default("singleton")
  lastCheckTime DateTime @default(now())
  updatedAt     DateTime @updatedAt
}
```

**Validation**:
```bash
grep -A 5 "model EmailMonitorState" /home/pbrown/SkuInventory/prisma/schema.prisma
```

**Completion Criteria**:
- [ ] EmailMonitorState model exists with singleton id pattern

### Subtask 2.4: Add User Relation to Feedback
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Pattern**: Follow existing User relation patterns (e.g., `bomVersions BOMVersion[]` at line 118)
**Instructions**:
1. Locate the User model (around line 102)
2. Add the following relation after `userCompanies UserCompany[]` (around line 130):
```prisma
  // Feedback relation
  feedbacks         Feedback[]
```

**Validation**:
```bash
grep "feedbacks" /home/pbrown/SkuInventory/prisma/schema.prisma
```

**Completion Criteria**:
- [ ] User model has feedbacks relation
- [ ] Relation is properly defined as array

### Subtask 2.5: Remove Old Comment About GitHub-Only Approach
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Pattern**: N/A
**Instructions**:
1. Locate and remove the comment at the end of the file (around line 596-599):
```prisma
// Note: Feedback tracking is now done via GitHub issues only.
// Submitter info is stored in the issue body (## Submitter Information section).
// This eliminates the need for separate Feedback/FeedbackReply tables.
```

**Validation**:
```bash
grep -c "Feedback tracking is now done via GitHub" /home/pbrown/SkuInventory/prisma/schema.prisma
# Should output: 0
```

**Completion Criteria**:
- [ ] Old comment is removed

## Phase 3: Run Migration

### Subtask 3.1: Generate and Apply Prisma Migration
**File**: N/A (CLI operation)
**Pattern**: Follow existing migration naming pattern in `prisma/migrations/`
**Instructions**:
1. Run Prisma migration:
```bash
cd /home/pbrown/SkuInventory && npx prisma migrate dev --name add_feedback_tracking
```
2. Verify migration was created

**Validation**:
```bash
ls /home/pbrown/SkuInventory/prisma/migrations/ | grep feedback
```

**Completion Criteria**:
- [ ] Migration file created with proper naming
- [ ] Migration applied successfully

### Subtask 3.2: Generate Prisma Client
**File**: N/A (CLI operation)
**Pattern**: N/A
**Instructions**:
1. Run Prisma generate:
```bash
cd /home/pbrown/SkuInventory && npx prisma generate
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Prisma client generated successfully
- [ ] No TypeScript errors

## Phase 4: Build Verification

### Subtask 4.1: Verify Build Passes
**File**: N/A (CLI operation)
**Pattern**: N/A
**Instructions**:
1. Run full build:
```bash
cd /home/pbrown/SkuInventory && npm run build
```

**Validation**:
```bash
# Build should complete without errors
```

**Completion Criteria**:
- [ ] `npm run build` completes successfully
- [ ] No TypeScript errors
- [ ] No linting errors

### Subtask 4.2: Verify Database Tables Exist (Test Environment)
**File**: N/A (CLI operation)
**Pattern**: N/A
**Instructions**:
1. Apply migration to test database:
```bash
DATABASE_URL="postgresql://inventory_test:inventory_test_2025@localhost:2346/inventory_test" npx prisma migrate deploy
```
2. Verify tables exist:
```bash
docker exec inventory-db-test psql -U inventory_test -d inventory_test -c "\\dt" | grep -E "Feedback|EmailMonitorState"
```

**Validation**:
```bash
docker exec inventory-db-test psql -U inventory_test -d inventory_test -c "SELECT COUNT(*) FROM \"Feedback\";" 2>/dev/null || echo "Table check"
```

**Completion Criteria**:
- [ ] Feedback table exists in test database
- [ ] EmailMonitorState table exists in test database

---

## Summary of Deliverables
**Files Created**: 1 (migration file)
**Files Modified**: 3
- `/home/pbrown/SkuInventory/.env` - Added CRON_SECRET
- `/home/pbrown/SkuInventory/docker/docker-compose.prod.yml` - Added CRON_SECRET passthrough
- `/home/pbrown/SkuInventory/prisma/schema.prisma` - Added FeedbackStatus enum, Feedback model, EmailMonitorState model, User.feedbacks relation

## Handoff to Build Agent
1. Execute subtasks in exact order (1.1 -> 1.2 -> 2.1 -> 2.2 -> 2.3 -> 2.4 -> 2.5 -> 3.1 -> 3.2 -> 4.1 -> 4.2)
2. Generate CRON_SECRET using `openssl rand -base64 32` for subtask 1.1
3. Test completion criteria before next subtask
4. Follow reference patterns exactly

## Test Strategy Note
- FAST_PATH: This is a schema-only change with no service or API modifications
- Build verification and TypeScript check are sufficient for Phase 1
- No unit or E2E tests need to run (no behavior changes)

## Out of Scope for Phase 1
The following will be implemented in subsequent phases:
- Service layer for Feedback CRUD operations
- Updating `/api/feedback/route.ts` to create Feedback records
- Updating `/api/webhooks/github/route.ts` to update Feedback status
- Updating `/api/cron/email-monitor/route.ts` to use EmailMonitorState
- TypeScript types for Feedback in `src/types/feedback.ts`

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 8m |
| Validation | 2m |
| Planning | 5m |
| **Total** | **15m** |
