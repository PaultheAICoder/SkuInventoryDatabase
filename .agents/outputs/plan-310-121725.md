# Implementation Plan
**Generated**: 2025-12-17T18:00:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #310
**Estimated Build Time**: 8-10 hours
**Complexity**: Medium

## Investigation Summary

### Request Analysis
**Type**: Security Bug Fix
**Source**: GitHub Issue #310
**Priority**: High (Security Risk)

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="auth\|permission\|role"` or manual verification

### Issue Validation
**Status**: Valid
**Recent Changes**: Multi-tenant architecture established in issues #82, #96, #223, #224, #228

### Current State Assessment
- **Session Structure**: `session.user` contains:
  - `role` - Legacy global role from `User.role` (THIS IS THE PROBLEM)
  - `companies` - Array of `{ id, name, role }` for each company assignment (CORRECT SOURCE)
  - `selectedCompanyId` - Currently active company
  - `selectedCompanyName` - Currently active company name

- **Existing Infrastructure**:
  - `src/lib/permissions.ts` - Has `hasPermission()`, `isRoleAtLeast()` helper functions
  - `src/lib/auth.ts` - JWT/session handling, already includes company-specific roles
  - `session.user.companies` array already contains the per-company role

- **Problem**: API routes and dashboard pages check `session.user.role` (the legacy global role) instead of looking up the role from `session.user.companies` for the `selectedCompanyId`.

### Dependencies & Blockers
None - all infrastructure exists.

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Medium (large surface area but simple pattern)
**Effort**: 8-10 hours
**Risk**: Medium (security-sensitive change, needs thorough testing)

### Patterns Identified
**Primary**: Create helper function `getSelectedCompanyRole()` in `src/lib/auth.ts`
**Secondary**: Use existing `hasPermission()` and `isRoleAtLeast()` from `src/lib/permissions.ts`

### Ripple Effect Analysis
**Files Identified**: 52 total

**Active API Routes (45 files)**:
- `/home/pbrown/SkuInventory/src/app/api/alerts/defects/[id]/route.ts` (3 checks)
- `/home/pbrown/SkuInventory/src/app/api/alerts/defects/route.ts` (1 check)
- `/home/pbrown/SkuInventory/src/app/api/asin-mapping/[id]/route.ts` (1 check)
- `/home/pbrown/SkuInventory/src/app/api/asin-mapping/route.ts` (1 check)
- `/home/pbrown/SkuInventory/src/app/api/brands/[id]/route.ts` (3 checks)
- `/home/pbrown/SkuInventory/src/app/api/brands/route.ts` (2 checks)
- `/home/pbrown/SkuInventory/src/app/api/categories/[id]/route.ts` (3 checks)
- `/home/pbrown/SkuInventory/src/app/api/categories/route.ts` (2 checks)
- `/home/pbrown/SkuInventory/src/app/api/chatbot/route.ts` (1 check)
- `/home/pbrown/SkuInventory/src/app/api/companies/[id]/route.ts` (3 checks)
- `/home/pbrown/SkuInventory/src/app/api/companies/route.ts` (2 checks)
- `/home/pbrown/SkuInventory/src/app/api/csv/upload/route.ts` (2 checks)
- `/home/pbrown/SkuInventory/src/app/api/forecasts/config/route.ts` (1 check)
- `/home/pbrown/SkuInventory/src/app/api/import/components/route.ts` (1 check)
- `/home/pbrown/SkuInventory/src/app/api/import/initial-inventory/route.ts` (1 check)
- `/home/pbrown/SkuInventory/src/app/api/import/inventory-snapshot/route.ts` (1 check)
- `/home/pbrown/SkuInventory/src/app/api/import/skus/route.ts` (1 check)
- `/home/pbrown/SkuInventory/src/app/api/import/template/[type]/route.ts` (1 check)
- `/home/pbrown/SkuInventory/src/app/api/integrations/amazon-ads/connect/route.ts` (1 check)
- `/home/pbrown/SkuInventory/src/app/api/integrations/amazon-ads/disconnect/route.ts` (1 check)
- `/home/pbrown/SkuInventory/src/app/api/integrations/amazon-ads/sync/route.ts` (1 check)
- `/home/pbrown/SkuInventory/src/app/api/locations/[id]/route.ts` (3 checks)
- `/home/pbrown/SkuInventory/src/app/api/locations/route.ts` (1 check)
- `/home/pbrown/SkuInventory/src/app/api/settings/alerts/route.ts` (2 checks)
- `/home/pbrown/SkuInventory/src/app/api/settings/alerts/test/route.ts` (1 check)
- `/home/pbrown/SkuInventory/src/app/api/settings/route.ts` (2 checks)
- `/home/pbrown/SkuInventory/src/app/api/skus/[id]/inventory/receipt/route.ts` (1 check)
- `/home/pbrown/SkuInventory/src/app/api/skus/[id]/inventory/route.ts` (1 check)
- `/home/pbrown/SkuInventory/src/app/api/sync-logs/route.ts` (1 check)
- `/home/pbrown/SkuInventory/src/app/api/transactions/adjustment/route.ts` (1 check)
- `/home/pbrown/SkuInventory/src/app/api/transactions/build/route.ts` (1 check)
- `/home/pbrown/SkuInventory/src/app/api/transactions/drafts/batch-approve/route.ts` (1 check)
- `/home/pbrown/SkuInventory/src/app/api/transactions/drafts/[id]/approve/route.ts` (1 check)
- `/home/pbrown/SkuInventory/src/app/api/transactions/drafts/[id]/reject/route.ts` (1 check)
- `/home/pbrown/SkuInventory/src/app/api/transactions/drafts/[id]/route.ts` (2 checks)
- `/home/pbrown/SkuInventory/src/app/api/transactions/drafts/route.ts` (1 check)
- `/home/pbrown/SkuInventory/src/app/api/transactions/[id]/route.ts` (2 checks)
- `/home/pbrown/SkuInventory/src/app/api/transactions/initial/route.ts` (1 check)
- `/home/pbrown/SkuInventory/src/app/api/transactions/outbound/route.ts` (1 check)
- `/home/pbrown/SkuInventory/src/app/api/transactions/parse/route.ts` (1 check)
- `/home/pbrown/SkuInventory/src/app/api/transactions/receipt/route.ts` (1 check)
- `/home/pbrown/SkuInventory/src/app/api/transactions/transfer/route.ts` (1 check)
- `/home/pbrown/SkuInventory/src/app/api/users/[id]/companies/route.ts` (2 checks)
- `/home/pbrown/SkuInventory/src/app/api/users/[id]/route.ts` (3 checks)
- `/home/pbrown/SkuInventory/src/app/api/users/route.ts` (2 checks)

**Dashboard Pages (6 files)**:
- `/home/pbrown/SkuInventory/src/app/(dashboard)/analytics/defects/page.tsx` (1 check)
- `/home/pbrown/SkuInventory/src/app/(dashboard)/components/new/page.tsx` (1 check)
- `/home/pbrown/SkuInventory/src/app/(dashboard)/components/page.tsx` (1 check)
- `/home/pbrown/SkuInventory/src/app/(dashboard)/import/page.tsx` (1 check)
- `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/alerts/page.tsx` (1 check)
- `/home/pbrown/SkuInventory/src/app/(dashboard)/transactions/new/page.tsx` (1 check)

**Auth Module (1 file)**:
- `/home/pbrown/SkuInventory/src/lib/auth.ts` - Keep `session.user.role` assignment (used for backwards compat), add helper function

**Deferred Shopify Files (15 files)** - NOT IN SCOPE for this issue:
- Files in `/home/pbrown/SkuInventory/src/_deferred/shopify/` are deferred and not active
- These should be updated when Shopify integration is reactivated

---

## Executive Summary

Create a helper function `getSelectedCompanyRole()` that retrieves the user's role for their currently selected company from `session.user.companies`. Replace all direct `session.user.role` checks in API routes and dashboard pages with calls to this helper or inline lookups. This ensures permissions are evaluated against the company-specific role (from `UserCompany.role`) rather than the legacy global role.

---

## Phase 0: Infrastructure Setup

### Subtask 0.1: Add `getSelectedCompanyRole()` Helper to auth.ts
**File**: `/home/pbrown/SkuInventory/src/lib/auth.ts`
**Pattern**: Follow existing `validateCompanyAccess()` pattern (line 378-383)
**Instructions**:
1. Add a new helper function after `validateCompanyAccess()`:
```typescript
/**
 * Get the user's role for their currently selected company
 * Returns the role from UserCompany (multi-tenant) not the legacy User.role
 */
export function getSelectedCompanyRole(
  session: { user: { companies: Array<{ id: string; role?: string }>; selectedCompanyId: string } }
): 'admin' | 'ops' | 'viewer' | undefined {
  const company = session.user.companies.find((c) => c.id === session.user.selectedCompanyId)
  return company?.role as 'admin' | 'ops' | 'viewer' | undefined
}
```

2. Export the function from the module

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Function added to auth.ts
- [ ] TypeScript compiles without errors
- [ ] Build passes

---

## Phase 1: Update API Routes - Admin-Only Endpoints

These routes require `admin` role. Pattern: Replace `session.user.role !== 'admin'` with `getSelectedCompanyRole(session) !== 'admin'`.

### Subtask 1.1: Update /api/users routes
**Files**:
- `/home/pbrown/SkuInventory/src/app/api/users/route.ts` (lines 18, 143)
- `/home/pbrown/SkuInventory/src/app/api/users/[id]/route.ts` (lines 20, 100, 224)
- `/home/pbrown/SkuInventory/src/app/api/users/[id]/companies/route.ts` (lines 20, 87)

**Pattern**: Add import and replace checks
```typescript
// Add import
import { authOptions, getSelectedCompanyRole } from '@/lib/auth'

// Replace
if (session.user.role !== 'admin') {
// With
const companyRole = getSelectedCompanyRole(session)
if (companyRole !== 'admin') {
```

**Completion Criteria**:
- [ ] All 7 checks updated across 3 files
- [ ] Import added to each file
- [ ] TypeScript compiles

### Subtask 1.2: Update /api/companies routes
**Files**:
- `/home/pbrown/SkuInventory/src/app/api/companies/route.ts` (lines 17, 96)
- `/home/pbrown/SkuInventory/src/app/api/companies/[id]/route.ts` (lines 19, 94, 293)

**Instructions**: Same pattern as Subtask 1.1

**Completion Criteria**:
- [ ] All 5 checks updated
- [ ] TypeScript compiles

### Subtask 1.3: Update /api/brands routes
**Files**:
- `/home/pbrown/SkuInventory/src/app/api/brands/route.ts` (lines 18, 126)
- `/home/pbrown/SkuInventory/src/app/api/brands/[id]/route.ts` (lines 19, 81, 207)

**Instructions**: Same pattern as Subtask 1.1

**Completion Criteria**:
- [ ] All 5 checks updated
- [ ] TypeScript compiles

### Subtask 1.4: Update /api/categories routes
**Files**:
- `/home/pbrown/SkuInventory/src/app/api/categories/route.ts` (lines 17, 122)
- `/home/pbrown/SkuInventory/src/app/api/categories/[id]/route.ts` (lines 19, 82, 207)

**Instructions**: Same pattern as Subtask 1.1

**Completion Criteria**:
- [ ] All 5 checks updated
- [ ] TypeScript compiles

### Subtask 1.5: Update /api/locations routes
**Files**:
- `/home/pbrown/SkuInventory/src/app/api/locations/route.ts` (line 102)
- `/home/pbrown/SkuInventory/src/app/api/locations/[id]/route.ts` (lines 20, 75, 195)

**Instructions**: Same pattern as Subtask 1.1

**Completion Criteria**:
- [ ] All 4 checks updated
- [ ] TypeScript compiles

### Subtask 1.6: Update /api/settings routes
**Files**:
- `/home/pbrown/SkuInventory/src/app/api/settings/route.ts` (lines 21, 73)
- `/home/pbrown/SkuInventory/src/app/api/settings/alerts/route.ts` (lines 28, 63)
- `/home/pbrown/SkuInventory/src/app/api/settings/alerts/test/route.ts` (line 37)

**Instructions**: Same pattern as Subtask 1.1

**Completion Criteria**:
- [ ] All 5 checks updated
- [ ] TypeScript compiles

### Subtask 1.7: Update /api/alerts routes
**Files**:
- `/home/pbrown/SkuInventory/src/app/api/alerts/defects/route.ts` (line 62)
- `/home/pbrown/SkuInventory/src/app/api/alerts/defects/[id]/route.ts` (lines 40, 65)

**Instructions**: Same pattern as Subtask 1.1

**Completion Criteria**:
- [ ] All 3 admin checks updated
- [ ] TypeScript compiles

### Subtask 1.8: Update /api/forecasts/config route
**File**: `/home/pbrown/SkuInventory/src/app/api/forecasts/config/route.ts` (line 74)

**Instructions**: Same pattern as Subtask 1.1

**Completion Criteria**:
- [ ] 1 check updated
- [ ] TypeScript compiles

### Subtask 1.9: Update /api/chatbot route
**File**: `/home/pbrown/SkuInventory/src/app/api/chatbot/route.ts` (line 17)

**Instructions**: Same pattern as Subtask 1.1

**Completion Criteria**:
- [ ] 1 check updated
- [ ] TypeScript compiles

### Subtask 1.10: Update /api/asin-mapping routes
**Files**:
- `/home/pbrown/SkuInventory/src/app/api/asin-mapping/route.ts` (line 221)
- `/home/pbrown/SkuInventory/src/app/api/asin-mapping/[id]/route.ts` (line 36)

**Instructions**: Same pattern as Subtask 1.1

**Completion Criteria**:
- [ ] All 2 checks updated
- [ ] TypeScript compiles

### Subtask 1.11: Update /api/integrations routes
**Files**:
- `/home/pbrown/SkuInventory/src/app/api/integrations/amazon-ads/connect/route.ts` (line 24)
- `/home/pbrown/SkuInventory/src/app/api/integrations/amazon-ads/disconnect/route.ts` (line 23)

**Instructions**: Same pattern as Subtask 1.1

**Completion Criteria**:
- [ ] All 2 checks updated
- [ ] TypeScript compiles

---

## Phase 2: Update API Routes - Admin OR Ops Endpoints

These routes require `admin` OR `ops` role. Pattern: Replace compound checks.

### Subtask 2.1: Update /api/csv/upload route
**File**: `/home/pbrown/SkuInventory/src/app/api/csv/upload/route.ts` (lines 37, 230)

**Pattern**:
```typescript
// Replace
if (session.user.role !== 'admin' && session.user.role !== 'ops') {
// With
const companyRole = getSelectedCompanyRole(session)
if (companyRole !== 'admin' && companyRole !== 'ops') {
```

**Completion Criteria**:
- [ ] Both checks updated
- [ ] TypeScript compiles

### Subtask 2.2: Update /api/sync-logs route
**File**: `/home/pbrown/SkuInventory/src/app/api/sync-logs/route.ts` (line 23)

**Instructions**: Same pattern as Subtask 2.1

**Completion Criteria**:
- [ ] 1 check updated
- [ ] TypeScript compiles

### Subtask 2.3: Update /api/integrations/amazon-ads/sync route
**File**: `/home/pbrown/SkuInventory/src/app/api/integrations/amazon-ads/sync/route.ts` (line 23)

**Instructions**: Same pattern as Subtask 2.1

**Completion Criteria**:
- [ ] 1 check updated
- [ ] TypeScript compiles

---

## Phase 3: Update API Routes - Non-Viewer Endpoints

These routes deny `viewer` role. Pattern: Replace `session.user.role === 'viewer'` checks.

### Subtask 3.1: Update Transaction Routes
**Files**:
- `/home/pbrown/SkuInventory/src/app/api/transactions/adjustment/route.ts` (line 19)
- `/home/pbrown/SkuInventory/src/app/api/transactions/build/route.ts` (line 20)
- `/home/pbrown/SkuInventory/src/app/api/transactions/initial/route.ts` (line 19)
- `/home/pbrown/SkuInventory/src/app/api/transactions/outbound/route.ts` (line 20)
- `/home/pbrown/SkuInventory/src/app/api/transactions/parse/route.ts` (line 25)
- `/home/pbrown/SkuInventory/src/app/api/transactions/receipt/route.ts` (line 19)
- `/home/pbrown/SkuInventory/src/app/api/transactions/transfer/route.ts` (line 18)
- `/home/pbrown/SkuInventory/src/app/api/transactions/[id]/route.ts` (lines 166, 304)

**Pattern**:
```typescript
// Replace
if (session.user.role === 'viewer') {
// With
const companyRole = getSelectedCompanyRole(session)
if (companyRole === 'viewer') {
```

**Completion Criteria**:
- [ ] All 9 checks updated across 8 files
- [ ] TypeScript compiles

### Subtask 3.2: Update Draft Transaction Routes
**Files**:
- `/home/pbrown/SkuInventory/src/app/api/transactions/drafts/route.ts` (line 69)
- `/home/pbrown/SkuInventory/src/app/api/transactions/drafts/batch-approve/route.ts` (line 21)
- `/home/pbrown/SkuInventory/src/app/api/transactions/drafts/[id]/route.ts` (lines 68, 123)
- `/home/pbrown/SkuInventory/src/app/api/transactions/drafts/[id]/approve/route.ts` (line 26)
- `/home/pbrown/SkuInventory/src/app/api/transactions/drafts/[id]/reject/route.ts` (line 24)

**Instructions**: Same pattern as Subtask 3.1

**Completion Criteria**:
- [ ] All 6 checks updated across 5 files
- [ ] TypeScript compiles

### Subtask 3.3: Update Import Routes
**Files**:
- `/home/pbrown/SkuInventory/src/app/api/import/components/route.ts` (line 97)
- `/home/pbrown/SkuInventory/src/app/api/import/initial-inventory/route.ts` (line 81)
- `/home/pbrown/SkuInventory/src/app/api/import/inventory-snapshot/route.ts` (line 91)
- `/home/pbrown/SkuInventory/src/app/api/import/skus/route.ts` (line 87)
- `/home/pbrown/SkuInventory/src/app/api/import/template/[type]/route.ts` (line 92)

**Instructions**: Same pattern as Subtask 3.1

**Completion Criteria**:
- [ ] All 5 checks updated
- [ ] TypeScript compiles

### Subtask 3.4: Update SKU Inventory Routes
**Files**:
- `/home/pbrown/SkuInventory/src/app/api/skus/[id]/inventory/route.ts` (line 57)
- `/home/pbrown/SkuInventory/src/app/api/skus/[id]/inventory/receipt/route.ts` (line 20)

**Instructions**: Same pattern as Subtask 3.1

**Completion Criteria**:
- [ ] All 2 checks updated
- [ ] TypeScript compiles

### Subtask 3.5: Update Alert Defects Route (Viewer Check)
**File**: `/home/pbrown/SkuInventory/src/app/api/alerts/defects/[id]/route.ts` (line 26)

**Instructions**: Same pattern as Subtask 3.1 (this is the viewer check, separate from admin checks in 1.7)

**Completion Criteria**:
- [ ] 1 viewer check updated
- [ ] TypeScript compiles

---

## Phase 4: Update Dashboard Pages

Dashboard pages need to get role from companies array. For client components using `useSession`, access `session.user.companies` and `session.user.selectedCompanyId`.

### Subtask 4.1: Update components pages
**Files**:
- `/home/pbrown/SkuInventory/src/app/(dashboard)/components/page.tsx` (line 152)
- `/home/pbrown/SkuInventory/src/app/(dashboard)/components/new/page.tsx` (line 13)

**Pattern for Server Component** (components/new/page.tsx):
```typescript
// Add helper inline or import from lib/auth
const companyRole = session.user.companies.find(
  (c) => c.id === session.user.selectedCompanyId
)?.role

// Replace
if (session.user.role === 'viewer') {
// With
if (companyRole === 'viewer') {
```

**Pattern for Client Component** (components/page.tsx):
```typescript
// Add helper calculation (or create a hook)
const companyRole = session.user.companies?.find(
  (c) => c.id === session.user.selectedCompanyId
)?.role

// Replace
const canCreate = session.user.role !== 'viewer'
// With
const canCreate = companyRole !== 'viewer'
```

**Completion Criteria**:
- [ ] Both pages updated
- [ ] TypeScript compiles
- [ ] Build passes

### Subtask 4.2: Update import page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/import/page.tsx` (line 33)

**Instructions**: Same pattern as Subtask 4.1 (server component)

**Completion Criteria**:
- [ ] Page updated
- [ ] TypeScript compiles

### Subtask 4.3: Update transactions/new page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/transactions/new/page.tsx` (line 14)

**Instructions**: Same pattern as Subtask 4.1 (server component)

**Completion Criteria**:
- [ ] Page updated
- [ ] TypeScript compiles

### Subtask 4.4: Update settings/alerts page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/alerts/page.tsx` (line 59)

**Pattern for Client Component**:
```typescript
// In the useEffect or at component level
const companyRole = session?.user?.companies?.find(
  (c) => c.id === session?.user?.selectedCompanyId
)?.role

// Replace
if (session.user.role !== 'admin') {
// With
if (companyRole !== 'admin') {
```

**Completion Criteria**:
- [ ] Page updated
- [ ] TypeScript compiles

### Subtask 4.5: Update analytics/defects page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/analytics/defects/page.tsx` (line 17)

**Pattern**:
```typescript
// Replace
return <DefectAnalyticsDashboard userRole={session.user.role} />
// With
const companyRole = session.user.companies.find(
  (c) => c.id === session.user.selectedCompanyId
)?.role ?? 'viewer'
return <DefectAnalyticsDashboard userRole={companyRole} />
```

**Completion Criteria**:
- [ ] Page updated
- [ ] TypeScript compiles

---

## Phase 5: Verification and Testing

### Subtask 5.1: Build Verification
**Instructions**:
```bash
npx tsc --noEmit
npm run build
npm run lint
```

**Completion Criteria**:
- [ ] TypeScript compiles without errors
- [ ] Build passes without errors
- [ ] Lint passes without errors

### Subtask 5.2: Manual Testing Checklist
**Instructions**: Test with test environment (port 2345)

1. **Admin User Tests**:
   - [ ] Can access /api/users (list)
   - [ ] Can access /api/companies (list/create)
   - [ ] Can access /api/settings
   - [ ] Can create transactions

2. **Ops User Tests**:
   - [ ] Cannot access /api/users
   - [ ] Cannot access /api/settings
   - [ ] Can create transactions
   - [ ] Can import data

3. **Viewer User Tests**:
   - [ ] Cannot create transactions
   - [ ] Cannot import data
   - [ ] Can view components and SKUs

4. **Multi-Company User Tests**:
   - [ ] User with admin in Company A, viewer in Company B
   - [ ] When switched to Company A: can access admin features
   - [ ] When switched to Company B: cannot access admin features

**Completion Criteria**:
- [ ] All test scenarios pass

---

## Summary of Deliverables

**Files Created**: 0
**Files Modified**: 52 total
- 1 lib file (`src/lib/auth.ts`) - add helper function
- 45 API route files - update role checks
- 6 dashboard page files - update role checks

**Note**: The 15 files in `src/_deferred/shopify/` are OUT OF SCOPE and should be updated when Shopify integration is reactivated.

---

## Handoff to Build Agent

1. Execute Phase 0 first to add the helper function
2. Execute Phases 1-3 for API routes in order
3. Execute Phase 4 for dashboard pages
4. Execute Phase 5 for verification
5. Each subtask can be verified independently with `npx tsc --noEmit`
6. Do NOT modify files in `src/_deferred/` directory

## Test Strategy Note
- Use manual verification via test environment (http://172.16.20.50:2345)
- Test with users having different roles in different companies
- Verify company-switch behavior works correctly

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 25m |
| Validation | 10m |
| Planning | 20m |
| **Total** | **55m** |

---

AGENT_RETURN: plan-310-121725
