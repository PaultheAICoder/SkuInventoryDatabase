# Implementation Plan
**Generated**: 2025-12-09T22:30:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #245
**Estimated Build Time**: 2-3 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Bug Fix
**Source**: GitHub Issue #245
**Priority**: Medium (affects user data integrity)

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="date"` (run date-related tests)

### Issue Validation
**Status**: Valid - same root cause as Issue #217 but different code path
**Recent Changes**:
- Commit `61e35bf` fixed this issue for natural language parsing in `transaction-parser.ts`
- The form-based entry (Zod schemas) was NOT fixed

### Root Cause Analysis

**The Bug**: When a user selects a date like "2025-12-08" using the browser's native date picker, the transaction records "2025-12-07" instead.

**Root Cause**: JavaScript's `new Date("YYYY-MM-DD")` parses date-only strings as UTC midnight, not local midnight.

Example for a user in Pacific Time (UTC-8):
1. User selects December 8, 2025 in browser
2. Browser sends string "2025-12-08"
3. `z.coerce.date()` calls `new Date("2025-12-08")`
4. JavaScript interprets this as **2025-12-08 00:00:00 UTC**
5. In Pacific Time, UTC midnight on Dec 8 is **Dec 7 at 4:00 PM local time**
6. When stored in PostgreSQL with `@db.Date`, the date portion (Dec 7 in some timezone interpretations) may be saved

**The Fix**: Append `T00:00:00` to date-only strings before parsing:
- `new Date("2025-12-08")` = UTC midnight (buggy)
- `new Date("2025-12-08T00:00:00")` = Local midnight (correct)

This fix was already applied in `src/lib/transaction-parser.ts` (lines 371-386) for Issue #217 but was NOT applied to the Zod schema validators.

### Current State Assessment

**Existing Fix (Issue #217)**: The transaction parser (`src/lib/transaction-parser.ts`) already handles this correctly:
```typescript
// Parse the date - IMPORTANT: Append time to prevent UTC midnight interpretation
const dateString = rawParsed.date.includes('T')
  ? rawParsed.date
  : `${rawParsed.date}T00:00:00`
parsedDate = new Date(dateString)
```

**Missing Fix**: The Zod schemas in `src/types/` use `z.coerce.date()` which does NOT apply this fix.

### Affected Files

**Primary Fix Location** (create helper):
- `src/lib/utils.ts` - Add `parseLocalDate()` helper function

**Files Using `z.coerce.date()` (all need to use the helper)**:
1. `src/types/transaction.ts` - Lines 5, 21, 33, 46, 58, 88, 135, 136
2. `src/types/transaction-edit.ts` - Lines 11, 56
3. `src/types/draft.ts` - Line 19
4. `src/types/bom.ts` - Lines 41, 54
5. `src/types/finished-goods.ts` - Lines 10, 22, 48
6. `src/types/analytics.ts` - Lines 5, 6
7. `src/types/index.ts` - Line 40

### Dependencies & Blockers
None - this is a surgical fix with clear pattern to follow.

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Simple
**Effort**: 2-3 hours
**Risk**: Low (fix is well-understood, already proven in transaction-parser.ts)

### Patterns Identified
**Primary Reference**: `src/lib/transaction-parser.ts:371-386` - Existing fix implementation
**Secondary Reference**: `tests/unit/transaction-parser-date.test.ts` - Existing test patterns

### Ripple Effect Analysis
**Files Affected**: 8 type definition files + 1 utility file
**Direct Impact**: All form-based transaction creation
**Indirect Impact**: None - this is input validation only

---

## Executive Summary

This bug is a duplicate of Issue #217 but occurring in a different code path. The fix is to create a custom Zod date schema that normalizes date-only strings to local timezone before parsing. The pattern is already proven in the transaction parser.

## Phase 1: Create Date Parsing Utility

### Subtask 1.1: Add parseLocalDate Helper Function
**File**: `/home/pbrown/SkuInventory/src/lib/utils.ts`
**Pattern**: Follow `src/lib/transaction-parser.ts:371-386`
**Instructions**:
1. Add a new function `parseLocalDate(value: string | Date): Date`
2. If input is already a Date, return it
3. If input is a string without 'T', append `T00:00:00` before parsing
4. If input is a string with 'T', parse directly
5. Return the parsed Date object

```typescript
/**
 * Parse a date string ensuring local timezone interpretation.
 *
 * IMPORTANT: JavaScript's new Date("YYYY-MM-DD") parses as UTC midnight,
 * which can shift the date by -1 day for users west of UTC.
 * By appending "T00:00:00", we force local timezone interpretation.
 *
 * @param value - Date string (YYYY-MM-DD) or Date object
 * @returns Date object in local timezone
 */
export function parseLocalDate(value: string | Date): Date {
  if (value instanceof Date) {
    return value
  }

  // If no time component, append T00:00:00 to force local timezone
  const dateString = value.includes('T') ? value : `${value}T00:00:00`
  return new Date(dateString)
}
```

**Completion Criteria**:
- [ ] Function added to `src/lib/utils.ts`
- [ ] TypeScript compiles: `npx tsc --noEmit`
- [ ] JSDoc comment explains the timezone issue

## Phase 2: Create Custom Zod Date Schema

### Subtask 2.1: Create localDateSchema in Types
**File**: `/home/pbrown/SkuInventory/src/types/index.ts`
**Pattern**: Replace existing `dateSchema`
**Instructions**:
1. Import `parseLocalDate` from `@/lib/utils`
2. Replace or update the existing `dateSchema` (line 40) to use `z.preprocess()` with `parseLocalDate`

```typescript
import { parseLocalDate } from '@/lib/utils'

/**
 * Date schema that handles timezone-safe parsing.
 * Uses parseLocalDate to prevent off-by-one day bugs for UTC- timezones.
 */
export const dateSchema = z.preprocess(
  (val) => {
    if (val instanceof Date) return val
    if (typeof val === 'string') return parseLocalDate(val)
    return val
  },
  z.date()
)
```

**Completion Criteria**:
- [ ] Schema updated in `src/types/index.ts`
- [ ] Import added for `parseLocalDate`
- [ ] TypeScript compiles: `npx tsc --noEmit`

## Phase 3: Update Transaction Schemas

### Subtask 3.1: Update Receipt Schema
**File**: `/home/pbrown/SkuInventory/src/types/transaction.ts`
**Instructions**:
1. Import `dateSchema` from `./index` (or ensure it's re-exported)
2. Replace `z.coerce.date()` with `dateSchema` on line 5

Change from:
```typescript
date: z.coerce.date(),
```
To:
```typescript
date: dateSchema,
```

**Completion Criteria**:
- [ ] Line 5 updated
- [ ] TypeScript compiles

### Subtask 3.2: Update Adjustment Schema
**File**: `/home/pbrown/SkuInventory/src/types/transaction.ts`
**Instructions**:
1. Replace `z.coerce.date()` on line 21 with `dateSchema`

**Completion Criteria**:
- [ ] Line 21 updated
- [ ] TypeScript compiles

### Subtask 3.3: Update Initial Schema
**File**: `/home/pbrown/SkuInventory/src/types/transaction.ts`
**Instructions**:
1. Replace `z.coerce.date()` on line 33 with `dateSchema`

**Completion Criteria**:
- [ ] Line 33 updated
- [ ] TypeScript compiles

### Subtask 3.4: Update Transfer Schema
**File**: `/home/pbrown/SkuInventory/src/types/transaction.ts`
**Instructions**:
1. Replace `z.coerce.date()` on line 46 with `dateSchema`

**Completion Criteria**:
- [ ] Line 46 updated
- [ ] TypeScript compiles

### Subtask 3.5: Update Build Schema
**File**: `/home/pbrown/SkuInventory/src/types/transaction.ts`
**Instructions**:
1. Replace `z.coerce.date()` on line 58 with `dateSchema`

**Completion Criteria**:
- [ ] Line 58 updated
- [ ] TypeScript compiles

### Subtask 3.6: Update Outbound Schema
**File**: `/home/pbrown/SkuInventory/src/types/transaction.ts`
**Instructions**:
1. Replace `z.coerce.date()` on line 88 with `dateSchema`

**Completion Criteria**:
- [ ] Line 88 updated
- [ ] TypeScript compiles

### Subtask 3.7: Update Transaction List Query Schema
**File**: `/home/pbrown/SkuInventory/src/types/transaction.ts`
**Instructions**:
1. Replace `z.coerce.date().optional()` on lines 135-136 with `dateSchema.optional()`

**Completion Criteria**:
- [ ] Lines 135-136 updated
- [ ] TypeScript compiles

## Phase 4: Update Other Affected Schemas

### Subtask 4.1: Update Transaction Edit Schemas
**File**: `/home/pbrown/SkuInventory/src/types/transaction-edit.ts`
**Instructions**:
1. Import `dateSchema` from `./index`
2. Replace `z.coerce.date().optional()` on lines 11 and 56 with `dateSchema.optional()`

**Completion Criteria**:
- [ ] Both occurrences updated
- [ ] TypeScript compiles

### Subtask 4.2: Update Draft Schema
**File**: `/home/pbrown/SkuInventory/src/types/draft.ts`
**Instructions**:
1. Import `dateSchema` from `./index`
2. Replace `z.coerce.date()` on line 19 with `dateSchema`

**Completion Criteria**:
- [ ] Line 19 updated
- [ ] TypeScript compiles

### Subtask 4.3: Update BOM Schemas
**File**: `/home/pbrown/SkuInventory/src/types/bom.ts`
**Instructions**:
1. Import `dateSchema` from `./index`
2. Replace `z.coerce.date()` on line 41 with `dateSchema`
3. Replace `z.coerce.date().optional()` on line 54 with `dateSchema.optional()`

**Completion Criteria**:
- [ ] Both occurrences updated
- [ ] TypeScript compiles

### Subtask 4.4: Update Finished Goods Schemas
**File**: `/home/pbrown/SkuInventory/src/types/finished-goods.ts`
**Instructions**:
1. Import `dateSchema` from `./index`
2. Replace `z.coerce.date()` on lines 10, 22, and 48 with `dateSchema`

**Completion Criteria**:
- [ ] All three occurrences updated
- [ ] TypeScript compiles

### Subtask 4.5: Update Analytics Schema
**File**: `/home/pbrown/SkuInventory/src/types/analytics.ts`
**Instructions**:
1. Import `dateSchema` from `./index`
2. Replace `z.coerce.date().optional()` on lines 5-6 with `dateSchema.optional()`

**Completion Criteria**:
- [ ] Both occurrences updated
- [ ] TypeScript compiles

## Phase 5: Add Regression Tests

### Subtask 5.1: Add Unit Tests for parseLocalDate
**File**: `/home/pbrown/SkuInventory/tests/unit/date-utils.test.ts` (NEW FILE)
**Pattern**: Follow `tests/unit/transaction-parser-date.test.ts`
**Instructions**:
Create new test file to verify the parseLocalDate function:

```typescript
import { describe, it, expect } from 'vitest'
import { parseLocalDate } from '@/lib/utils'

describe('parseLocalDate', () => {
  it('should parse date-only string as local midnight, not UTC', () => {
    const result = parseLocalDate('2025-12-08')

    // Should always be Dec 8 in local time
    expect(result.getDate()).toBe(8)
    expect(result.getMonth()).toBe(11) // December = 11
    expect(result.getFullYear()).toBe(2025)
  })

  it('should pass through Date objects unchanged', () => {
    const input = new Date('2025-12-08T15:30:00')
    const result = parseLocalDate(input)

    expect(result).toBe(input)
    expect(result.getTime()).toBe(input.getTime())
  })

  it('should preserve time component if present', () => {
    const result = parseLocalDate('2025-12-08T14:30:00')

    expect(result.getHours()).toBe(14)
    expect(result.getMinutes()).toBe(30)
  })

  it('should handle ISO timestamps with Z suffix', () => {
    const result = parseLocalDate('2025-12-08T14:30:00Z')

    // With Z suffix, it's UTC time (behavior unchanged)
    expect(result.getTime()).not.toBeNaN()
  })

  it('should handle edge case: last day of month', () => {
    const result = parseLocalDate('2025-11-30')

    expect(result.getDate()).toBe(30)
    expect(result.getMonth()).toBe(10) // November = 10
  })

  it('should handle edge case: leap year Feb 29', () => {
    const result = parseLocalDate('2024-02-29')

    expect(result.getDate()).toBe(29)
    expect(result.getMonth()).toBe(1) // February = 1
    expect(result.getFullYear()).toBe(2024)
  })
})
```

**Completion Criteria**:
- [ ] Test file created
- [ ] Tests pass: `npm test -- --filter="date-utils"`

## Phase 6: Verification

### Subtask 6.1: Build Verification
**Instructions**:
1. Run TypeScript compiler: `npx tsc --noEmit`
2. Run build: `npm run build`
3. Run linter: `npm run lint`

**Completion Criteria**:
- [ ] No TypeScript errors
- [ ] Build succeeds
- [ ] No new lint warnings

### Subtask 6.2: Run Related Tests
**Instructions**:
1. Run date-related tests: `npm test -- --filter="date"`
2. Run transaction tests: `npm test -- --filter="transaction"`

**Completion Criteria**:
- [ ] All date tests pass
- [ ] All transaction tests pass
- [ ] No regressions

---

## Summary of Deliverables

**Files Created**: 1
- `tests/unit/date-utils.test.ts` - New test file

**Files Modified**: 8
- `src/lib/utils.ts` - Add `parseLocalDate` helper
- `src/types/index.ts` - Add `dateSchema` using `parseLocalDate`
- `src/types/transaction.ts` - Replace 7 occurrences of `z.coerce.date()`
- `src/types/transaction-edit.ts` - Replace 2 occurrences
- `src/types/draft.ts` - Replace 1 occurrence
- `src/types/bom.ts` - Replace 2 occurrences
- `src/types/finished-goods.ts` - Replace 3 occurrences
- `src/types/analytics.ts` - Replace 2 occurrences

**Total Changes**: 17 schema fields updated + 1 new utility function + 1 new test file

## Handoff to Build Agent

1. Execute subtasks in exact order (1.1 -> 2.1 -> 3.x -> 4.x -> 5.1 -> 6.x)
2. Run `npx tsc --noEmit` after each file modification
3. The fix pattern is proven - follow `transaction-parser.ts` exactly
4. Test with both date-only strings ("2025-12-08") and ISO timestamps

## Test Strategy Note

- Use Vitest for unit tests (project standard)
- Test filter: `npm test -- --filter="date"`
- The key test assertion: `parseLocalDate("2025-12-08").getDate() === 8` must pass regardless of machine timezone

## Performance Metrics
| Phase | Estimated Duration |
|-------|----------|
| Investigation | 25m |
| Validation | 10m |
| Planning | 15m |
| **Total** | **50m** |

---

## Related Issues
- **Issue #217**: Same bug, fixed in transaction-parser.ts (commit `61e35bf`)
- **Issue #245**: This issue - same bug in form-based entry (Zod schemas)

## References
- Fix pattern: `/home/pbrown/SkuInventory/src/lib/transaction-parser.ts:371-386`
- Test pattern: `/home/pbrown/SkuInventory/tests/unit/transaction-parser-date.test.ts`
- MDN Date docs: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date/Date#date_string
