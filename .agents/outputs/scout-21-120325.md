# Scout Report: Build transactions should apply BOM by effective date (Issue #21)

## Request Analysis
**Type**: Enhancement
**Source**: GitHub Issue #21
**Priority**: Medium
**Complexity**: Medium

## Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="build.*transaction|bom.*date"`

## Issue Validation
**Status**: Valid
**Recent Changes**: No recent commits affecting BOM date selection logic
**Dependencies**: Prisma schema already has effectiveStartDate/effectiveEndDate fields (lines 204-205)

Issue #21 accurately describes the current behavior. The build route currently selects only the active BOM (`isActive: true`) without considering the build date or effective date ranges.

## Current State

### BOM Version Schema (Prisma)
- **File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
- **Lines**: 199-219
- **Fields**:
  - `effectiveStartDate` (DateTime @db.Date) - Required (line 204)
  - `effectiveEndDate` (DateTime? @db.Date) - Optional (line 205)
  - `isActive` (Boolean) - Currently used for BOM selection (line 206)

The schema already supports date-based BOM versioning. All infrastructure is in place.

### Current Build Transaction Flow

**API Route**: `/home/pbrown/SkuInventory/src/app/api/transactions/build/route.ts`
- **Lines 36-39**: Currently selects BOM using `isActive: true` filter
- **Line 51**: Assigns `activeBomVersionId` to the build transaction
- **Problem**: Does not consider the transaction date when selecting BOM version

```typescript
// Current implementation (lines 36-39)
bomVersions: {
  where: { isActive: true },  // <-- ONLY checks isActive flag
  take: 1,
}
```

**Service Layer**: `/home/pbrown/SkuInventory/src/services/inventory.ts`
- **Function**: `createBuildTransaction` (lines 418-548)
- **Input**: Receives `bomVersionId` as parameter (line 421)
- **BOM Selection**: Happens in API layer, service just uses the provided ID
- **Cost Calculation**: Lines 464-482 calculate unit BOM cost from provided bomVersionId
- **No Changes Needed**: Service layer is correctly decoupled

### Other Files Using isActive BOM Selection

**Files requiring analysis** (may need date-based logic):
1. `/home/pbrown/SkuInventory/src/services/bom.ts` (6 occurrences)
   - `calculateMaxBuildableUnits` (line 62) - Uses active BOM for UI display
   - `calculateMaxBuildableUnitsForSKUs` (line 106) - Uses active BOM for UI display
   - `activateBOMVersion` (line 307) - Updates active status
   - `canDeleteComponent` (line 310) - Checks active BOMs
   - `isComponentInActiveBOM` (line 379) - Checks active BOMs

2. `/home/pbrown/SkuInventory/src/app/api/skus/[id]/route.ts`
   - Line 72: Finds active BOM for SKU detail
   - Line 177: Finds active BOM for SKU update

**Note**: All of these are correctly using isActive for "current" operations. Only build transactions need date-based selection.

## Dependencies & Blockers

### Database Schema
- BOMVersion model has all required date fields
- `effectiveStartDate` and `effectiveEndDate` fields already present
- No migrations needed

### Types
- `/home/pbrown/SkuInventory/src/types/transaction.ts` - No changes needed (already has date field)
- `/home/pbrown/SkuInventory/src/types/bom.ts` - No changes needed

### API Routes
- `/home/pbrown/SkuInventory/src/app/api/transactions/build/route.ts` - PRIMARY FILE

### Services
- `/home/pbrown/SkuInventory/src/services/inventory.ts` - NO CHANGES NEEDED (receives bomVersionId)
- `/home/pbrown/SkuInventory/src/services/bom.ts` - NO CHANGES NEEDED

### Components
- BuildDialog does not need changes - it doesn't select BOM, API does

**Can Proceed?**: YES

## Complexity Assessment
**Complexity**: Medium
**Effort**: 2-3 hours
**Risk**: Low

### Why Medium Complexity?
1. Single file to modify (build route)
2. Need to add date-based BOM selection logic
3. Need error handling for missing BOM at date
4. Need to update/create tests
5. Schema already supports this feature

### Risk Analysis
- **Low Risk**: Changes isolated to build transaction API route
- **Service Layer**: No changes needed (already accepts bomVersionId)
- **Database**: No schema changes needed
- **UI**: No changes needed
- **Side Effects**: None - other features correctly use isActive

## Implementation Approach

### Date-Based BOM Selection Logic

Replace the current `isActive: true` query (lines 36-39) with date range query:

```typescript
bomVersions: {
  where: {
    effectiveStartDate: { lte: data.date },
    OR: [
      { effectiveEndDate: null },
      { effectiveEndDate: { gte: data.date } }
    ]
  },
  orderBy: { effectiveStartDate: 'desc' },
  take: 1,
}
```

**Logic**:
- BOM must have started before or on the build date
- BOM must either have no end date (still active) OR end date is on or after build date
- If multiple BOMs match, use the most recent one (orderBy effectiveStartDate desc)

### Error Handling

If no BOM version covers the build date:
```typescript
if (!sku.bomVersions[0]) {
  const buildDateStr = data.date.toISOString().split('T')[0]
  return error(`No BOM version effective on ${buildDateStr} for this SKU`, 400)
}
```

## Patterns to Follow

**Primary Pattern**: `/home/pbrown/SkuInventory/src/services/bom.ts`
- Lines 186-196: `createBOMVersion` function shows how effectiveStartDate/effectiveEndDate are set
- Line 194: When activating a BOM, sets `effectiveEndDate: effectiveStartDate` on old active BOM
- Line 328: `activateBOMVersion` shows date range pattern

**Secondary Pattern**: `/home/pbrown/SkuInventory/tests/integration/transactions.test.ts`
- Lines 286-354: Existing build transaction tests
- Line 319: Shows BOM creation with effectiveStartDate
- Pattern for test structure

## Files to Create/Modify

### Files to Modify
1. `/home/pbrown/SkuInventory/src/app/api/transactions/build/route.ts`
   - **Lines 36-49**: Replace isActive query with date-based query
   - **Purpose**: Implement date-based BOM selection and error handling

### Files to Create/Update
1. `/home/pbrown/SkuInventory/tests/integration/transactions.test.ts` (UPDATE)
   - **Add tests** after existing build tests (after line 462)
   - **Purpose**: Integration tests for backdated builds
   - **Tests**:
     - Build with current date uses active BOM
     - Backdated build uses BOM effective on that date
     - Build fails if no BOM covers the date
     - Multiple BOM versions with overlapping dates use most recent

2. `/home/pbrown/SkuInventory/tests/unit/bom-date-selection.test.ts` (NEW - OPTIONAL)
   - **Purpose**: Unit tests for BOM date selection logic
   - **Tests**:
     - Date range queries work correctly
     - Edge cases (exact start/end dates)
     - Multiple BOMs on same date

## Final Sweep Results

**Services Search**: 2 files in src/services/
- `inventory.ts` - createBuildTransaction (receives bomVersionId, no changes needed)
- `bom.ts` - BOM utility functions (6 isActive usages, all correct for their purpose)

**API Routes**: 1 primary file
- `src/app/api/transactions/build/route.ts` - ONLY FILE TO MODIFY

**Type Definitions**: 1 file reviewed
- `src/types/transaction.ts` - No changes needed (schema already accepts date)

**Components**: 0 files affected
- BuildDialog doesn't select BOM, API does

**Test Files**: 1 file to update
- `tests/integration/transactions.test.ts` - Add new tests for backdated builds

**All Affected Files** (comprehensive list):
1. `/home/pbrown/SkuInventory/src/app/api/transactions/build/route.ts` - PRIMARY CHANGE
2. `/home/pbrown/SkuInventory/tests/integration/transactions.test.ts` - ADD NEW TESTS

## Ripple Effect Analysis

**Function**: BOM selection in build route (lines 36-39)
**Direct Callers**: None (this is the API endpoint)
**Indirect Callers**:
- BuildDialog component (frontend) - No changes needed
- Direct API calls - No changes needed

**Service Layer Check**:
- `createBuildTransaction` (inventory.ts line 418) receives bomVersionId as parameter
- No signature changes needed
- Service layer is decoupled from BOM selection logic

**TOTAL FILES AFFECTED**: 1 primary file (build route) + 1 test file

**Scope Verification**:
- No wrapper functions
- No shared utilities for BOM selection
- Build route directly queries Prisma
- Service layer only uses the provided bomVersionId

## Acceptance Criteria

From Issue #21:
- [ ] Backdated builds pick BOM version by effective date range
  - **Implementation**: Date-based query in build route (lines 36-39)

- [ ] Costs and consumption reflect date-appropriate BOM
  - **Current State**: Service layer uses bomVersionId to calculate costs (line 478)
  - **No Changes Needed**: Once correct BOM is selected, costs are automatic

- [ ] Clear error if no BOM covers the date
  - **Implementation**: Error check after BOM query (line 47)

- [ ] Tests cover current and backdated builds
  - **Implementation**: Add tests to `transactions.test.ts`

Additional criteria:
- [ ] Edge cases tested (date exactly on effectiveStartDate or effectiveEndDate)
- [ ] Build with current date still works (backward compatibility)
- [ ] Error message distinguishes "no BOM exists" from "no BOM effective on this date"

## Handoff to Plan Agent

**Summary**: Issue #21 requests date-based BOM version selection for build transactions instead of always using the active BOM. The schema already supports this with effectiveStartDate/effectiveEndDate fields. Implementation requires modifying only the build API route (lines 36-49) to replace the `isActive: true` filter with a date range query. The service layer requires no changes as it already receives bomVersionId as a parameter and calculates costs correctly. Error handling must be added for cases where no BOM covers the build date. Tests should verify current date builds, backdated builds, missing BOM scenarios, and edge cases with overlapping date ranges.

**Key Points**:
1. **Single file modification** - Only build route needs changes
2. **Schema ready** - effectiveStartDate/effectiveEndDate already exist
3. **Service layer unchanged** - Correctly decoupled
4. **Low risk** - Isolated change, no side effects
5. **Clear test scenarios** - Current date, backdated, missing BOM, overlapping dates

**Suggested Phases**:
1. **Phase 1**: Update build route with date-based BOM query and error handling (lines 36-49)
2. **Phase 2**: Add integration tests for backdated builds to existing test file
3. **Phase 3**: Verify existing build tests still pass (backward compatibility)
4. **Phase 4**: (Optional) Add unit tests for date selection edge cases

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Issue Parsing | 2m |
| Codebase Exploration | 8m |
| Pattern Identification | 4m |
| Ripple Effect Analysis | 5m |
| Report Writing | 8m |
| **Total** | **27m** |

---

AGENT_RETURN: scout-21-120325
