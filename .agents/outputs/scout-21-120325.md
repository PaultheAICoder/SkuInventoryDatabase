# Scout Report: Build transactions should apply BOM by effective date

## Request Analysis
**Type**: Enhancement
**Source**: GitHub Issue #21
**Priority**: Medium

## Task Classification
**Category**: REFACTORING
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="build|bom|transaction"`

## Issue Validation
**Status**: Valid
**Recent Changes**: Last commit to build route was 2025-11-03 (issue #15 - defect tracking)

Issue #21 is valid and accurately describes the current behavior. The build route currently selects only the active BOM (`isActive: true`) without considering the build date or effective date ranges.

## Current State

### Database Schema (prisma/schema.prisma)
- BomVersion model (lines 199-219) has date-based effective range fields:
  - `effectiveStartDate: DateTime @db.Date` (line 204) - REQUIRED
  - `effectiveEndDate: DateTime? @db.Date` (line 205) - OPTIONAL (null means "still active")
  - `isActive: Boolean @default(false)` (line 206) - Currently used for selection

The schema already supports date-based BOM versioning. All infrastructure is in place.

### Current BOM Selection Logic

**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/build/route.ts`

**Current Implementation** (lines 36-51):
```typescript
include: {
  bomVersions: {
    where: { isActive: true },  // <-- ONLY checks isActive flag
    take: 1,
  },
},
```

**Problem**: This query:
1. Ignores the `data.date` parameter (the build date)
2. Only checks `isActive: true`
3. Does NOT consider `effectiveStartDate` or `effectiveEndDate`

**Result**: Backdated builds always use the currently active BOM, not the BOM that was effective on the historical build date.

### Service Layer
**File**: `/home/pbrown/SkuInventory/src/services/inventory.ts`

The `createBuildTransaction` function (lines 418-548):
- Receives `bomVersionId` as a parameter (line 421)
- Does NOT select the BOM itself - that happens in the route handler
- Uses the provided `bomVersionId` to fetch BOM lines and calculate costs
- This function does NOT need modification

### Other Files Using Active BOM Pattern

**Files that query for active BOMs**:
1. `/home/pbrown/SkuInventory/src/services/bom.ts`:
   - `calculateMaxBuildableUnits` (line 62) - uses `isActive: true`
   - `calculateMaxBuildableUnitsForSKUs` (line 106) - uses `isActive: true`
   - These are for UI display (max buildable calculations), NOT historical lookups

2. `/home/pbrown/SkuInventory/src/app/api/skus/[id]/bom-versions/route.ts`:
   - GET endpoint (line 53) - optional filter for active/inactive BOMs (UI display)
   - No changes needed

**None of these other files need modification** - they are for current/display purposes, not historical transaction creation.

## Dependencies & Blockers

**Dependencies**:
- Database: BomVersion model has all required date fields
- Types: No new types needed
- Services: `createBuildTransaction` already accepts `bomVersionId` parameter

**Blockers**: NONE

**Can Proceed?**: YES

## Complexity Assessment
**Complexity**: Simple
**Effort**: 2-3 hours
**Risk**: Low

This is a straightforward query change with clear business logic. The infrastructure already exists.

## Patterns to Follow

**Primary Pattern**: Date-based activation in `/home/pbrown/SkuInventory/src/services/bom.ts`
- See `activateBOMVersion` function (lines 307-360)
- Line 328 shows how effectiveEndDate is set when deactivating: `effectiveEndDate: new Date()`
- This shows the pattern of using effectiveStartDate/EndDate for date ranges

**Secondary Pattern**: BOM listing in `/home/pbrown/SkuInventory/src/app/api/skus/[id]/bom-versions/route.ts`
- Lines 93-94 show how effectiveStartDate and effectiveEndDate are formatted for responses
- This confirms the date fields are working and tested

## Files to Create/Modify

### Files to Modify

1. **`/home/pbrown/SkuInventory/src/app/api/transactions/build/route.ts`**
   - Lines 36-40: Replace the BOM query logic
   - Current: `where: { isActive: true }`
   - New: Query for BOM where `data.date` is between `effectiveStartDate` and `effectiveEndDate`
   - Also update error message on line 48 to clarify "no BOM effective on this date"

### Files to Create

1. **Test file**: `/home/pbrown/SkuInventory/tests/unit/build-bom-date-selection.test.ts`
   - Test selecting BOM by date
   - Test error when no BOM covers the date
   - Test edge cases (date on exact start/end dates)

2. **Integration test additions**: `/home/pbrown/SkuInventory/tests/integration/transactions.test.ts`
   - Currently only has documentation tests (no actual execution)
   - Add real test for backdated build using correct BOM version

## Final Sweep Results

**Comprehensive search for affected code**:

```bash
# Searched for: bomVersions.*where
# Found: 0 direct matches (only standalone bOMVersion.findFirst/findMany)

# Searched for: where.*isActive.*true
# Found: 12 files, only 1 relevant to build transactions

# Searched for: effectiveStartDate|effectiveEndDate
# Found: 11 files - all UI/display related, none need changes
```

**Services Search**: No service layer changes needed
- `createBuildTransaction` already accepts `bomVersionId` parameter
- No wrapper functions that call build transaction creation

**API Routes**: 1 file affected
- `/home/pbrown/SkuInventory/src/app/api/transactions/build/route.ts` (lines 36-51)

**Type Definitions**: No changes needed
- `createBuildSchema` already includes `date` field (line 41 in `/home/pbrown/SkuInventory/src/types/transaction.ts`)

**Components**: No frontend changes needed
- Build dialog already sends date
- Response format unchanged

**Test Files**: 0 existing tests for build transactions
- Need to create new tests

**All Affected Files** (comprehensive list):
1. `/home/pbrown/SkuInventory/src/app/api/transactions/build/route.ts` - BOM selection logic (MODIFY)
2. `/home/pbrown/SkuInventory/tests/unit/build-bom-date-selection.test.ts` - New test file (CREATE)
3. `/home/pbrown/SkuInventory/tests/integration/transactions.test.ts` - Add real tests (MODIFY)

## Ripple Effect Analysis

**Function**: BOM version query in build route (lines 36-40)
**Direct Callers**: None (this is the route handler itself)
**Indirect Callers**: Frontend build dialog calls POST /api/transactions/build

**Impact Analysis**:
- Backend: 1 file, 1 function, ~10 lines of code
- Frontend: 0 changes (already sends date)
- Database: 0 schema changes
- Types: 0 changes

**TOTAL FILES AFFECTED**: 1 modification + 1 new test file = 2 files

This is a minimal-scope change with no ripple effects.

## Acceptance Criteria

From issue #21:
- [ ] Build transaction creation selects BOM version effective on provided build date (respecting start/end dates)
- [ ] If no BOM is effective on that date, return clear error message
- [ ] Unit BOM cost and component consumption reflect date-appropriate BOM
- [ ] Tests cover current date and backdated builds
- [ ] Clear error message when no BOM covers the date

Additional criteria:
- [ ] Edge cases tested (date exactly on effectiveStartDate or effectiveEndDate)
- [ ] Build with current date still works (backward compatibility)
- [ ] Error message distinguishes "no BOM exists" from "no BOM effective on this date"

## Implementation Details

### BOM Selection Query Logic

Current query (lines 36-40):
```typescript
include: {
  bomVersions: {
    where: { isActive: true },
    take: 1,
  },
},
```

New query should be:
```typescript
include: {
  bomVersions: {
    where: {
      effectiveStartDate: { lte: data.date },
      OR: [
        { effectiveEndDate: { gte: data.date } },
        { effectiveEndDate: null },
      ],
    },
    take: 1,
    orderBy: { effectiveStartDate: 'desc' },
  },
},
```

**Logic**:
1. `effectiveStartDate <= buildDate` - BOM started before or on build date
2. `effectiveEndDate >= buildDate OR effectiveEndDate is null` - BOM ended after build date OR is still active
3. Order by `effectiveStartDate desc` to get the most recent BOM if multiple match

**Error Handling** (line 47-49):
Update error message from:
```typescript
if (!sku.bomVersions[0]) {
  return error('SKU has no active BOM', 400)
}
```

To:
```typescript
if (!sku.bomVersions[0]) {
  const buildDateStr = data.date.toISOString().split('T')[0]
  return error(`No BOM version effective on ${buildDateStr} for this SKU`, 400)
}
```

## Handoff to Plan Agent

**Summary**:
Issue #21 requires changing the BOM selection logic in the build transaction route from using only the `isActive` flag to performing a date-based lookup using `effectiveStartDate` and `effectiveEndDate` fields. The database schema already supports this functionality - we just need to update the query logic. This is a minimal-scope change affecting only the build route handler, with no ripple effects to services, types, or frontend code.

**Key Points**:
1. Database schema already has `effectiveStartDate` and `effectiveEndDate` fields on BomVersion model
2. Only file needing modification: `/home/pbrown/SkuInventory/src/app/api/transactions/build/route.ts` (lines 36-51)
3. Service layer (`createBuildTransaction`) already accepts `bomVersionId` parameter - no changes needed
4. Frontend already sends `date` parameter - no changes needed
5. Need to add tests for date-based BOM selection
6. Error message should clarify when no BOM is effective on the specified date
7. Query should handle edge cases: exact start/end dates, null end dates (still active BOMs)

**Suggested Phases**:
1. **Phase 1**: Update BOM selection query in build route (lines 36-40)
   - Change from `isActive: true` to date-range query
   - Handle null `effectiveEndDate` (means still active)
   - Order by `effectiveStartDate desc` to get most recent if multiple match

2. **Phase 2**: Update error handling (lines 47-49)
   - Include the build date in error message
   - Clarify "no BOM effective on this date" vs "no active BOM"

3. **Phase 3**: Create unit tests
   - Test BOM selection with various dates
   - Test error when no BOM covers date
   - Test edge cases (exact start/end dates, null end date)

4. **Phase 4**: Add integration test
   - Test full build transaction with backdated date
   - Verify correct BOM is used and costs are calculated correctly

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Issue Parsing | 2m |
| Codebase Exploration | 12m |
| Pattern Identification | 8m |
| Ripple Analysis | 6m |
| Report Writing | 10m |
| **Total** | **38m** |
