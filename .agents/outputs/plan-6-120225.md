# Implementation Plan
**Generated**: 2025-12-02T22:45:00Z
**Task ID**: Issue #6
**Estimated Build Time**: 6-8 hours
**Complexity**: Medium

## Executive Summary

Fix two critical bugs: (1) seed script writes invalid settings key `blockNegativeInventory` instead of correct `allowNegativeInventory`, and (2) company settings are stored correctly but never applied in business logic. This requires fixing the seed script, creating a missing build transaction API endpoint, and integrating settings into inventory calculations and component creation across 7 files.

## Ripple Effect Verification

**Scout found 6 files calling `calculateReorderStatus` - VERIFIED**:
- `src/services/inventory.ts` (definition)
- `src/app/(dashboard)/components/page.tsx` (2 calls: lines 72, 127)
- `src/app/api/dashboard/route.ts` (1 call: line 92)
- `src/app/api/export/components/route.ts` (1 call: line 54)
- `src/app/api/components/route.ts` (3 calls: lines 81, 132, 231)
- `src/app/api/components/[id]/route.ts` (2 calls: lines 113, 224)

Total call sites: 9 (all need the new multiplier parameter)

## Schema Verification

**Settings schema from `src/types/settings.ts`**:
```typescript
allowNegativeInventory: z.boolean().default(false)
defaultLeadTimeDays: z.coerce.number().int().nonnegative().default(7)
reorderWarningMultiplier: z.coerce.number().positive().default(1.5)
```

**Seed script bug (lines 20-23)**:
```typescript
// WRONG:
settings: { blockNegativeInventory: false }
// CORRECT:
settings: DEFAULT_SETTINGS
```

---

## Phase 1: Fix Seed Script (Quick Win)
*Estimated: 10 minutes*

### Subtask 1.1: Update Seed Script to Use DEFAULT_SETTINGS

**File**: `/home/pbrown/SkuInventory/prisma/seed.ts`
**Pattern**: Import DEFAULT_SETTINGS from settings types
**Instructions**:
1. Add import at top of file:
   ```typescript
   import { DEFAULT_SETTINGS } from '../src/types/settings'
   ```
2. Replace lines 20-23:
   ```typescript
   // BEFORE:
   settings: {
     blockNegativeInventory: false,
   },

   // AFTER:
   settings: DEFAULT_SETTINGS,
   ```
3. Verify import path is correct (may need adjustment for ESM)

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Import added without TypeScript errors
- [ ] Company created with valid `allowNegativeInventory`, `defaultLeadTimeDays`, `reorderWarningMultiplier` keys
- [ ] Fresh database seed works: `npx prisma db seed`

---

## Phase 2: Create Helper Function for Settings Fetch
*Estimated: 30 minutes*

### Subtask 2.1: Add getCompanySettings Utility Function

**File**: `/home/pbrown/SkuInventory/src/services/inventory.ts`
**Pattern**: Follow settings merge pattern from `/home/pbrown/SkuInventory/src/app/api/settings/route.ts` lines 39-45
**Instructions**:
1. Add imports at top of file:
   ```typescript
   import {
     companySettingsSchema,
     DEFAULT_SETTINGS,
     type CompanySettings,
   } from '@/types/settings'
   ```
2. Add new helper function BEFORE the existing functions (around line 5, after imports):
   ```typescript
   /**
    * Fetch and merge company settings with defaults
    * Returns validated settings or defaults if validation fails
    */
   export async function getCompanySettings(companyId: string): Promise<CompanySettings> {
     const company = await prisma.company.findUnique({
       where: { id: companyId },
       select: { settings: true },
     })

     const storedSettings = (company?.settings as Record<string, unknown>) || {}
     const merged = { ...DEFAULT_SETTINGS, ...storedSettings }
     const validated = companySettingsSchema.safeParse(merged)

     return validated.success ? validated.data : DEFAULT_SETTINGS
   }
   ```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Function compiles without errors
- [ ] Function exported from module
- [ ] Returns CompanySettings type

---

## Phase 3: Update calculateReorderStatus Function
*Estimated: 1-2 hours*

### Subtask 3.1: Add reorderWarningMultiplier Parameter to Function

**File**: `/home/pbrown/SkuInventory/src/services/inventory.ts`
**Pattern**: Current function at lines 49-63
**Instructions**:
1. Update function signature at line 49-52:
   ```typescript
   // BEFORE:
   export function calculateReorderStatus(
     quantityOnHand: number,
     reorderPoint: number
   ): ReorderStatus {

   // AFTER:
   export function calculateReorderStatus(
     quantityOnHand: number,
     reorderPoint: number,
     reorderWarningMultiplier: number = 1.5
   ): ReorderStatus {
   ```
2. Update the calculation at line 59 to use the parameter:
   ```typescript
   // BEFORE:
   if (quantityOnHand <= reorderPoint * 1.5) {

   // AFTER:
   if (quantityOnHand <= reorderPoint * reorderWarningMultiplier) {
   ```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Function accepts optional third parameter
- [ ] Default value is 1.5 (backward compatible)
- [ ] TypeScript compiles without errors

### Subtask 3.2: Update API Components Route (GET)

**File**: `/home/pbrown/SkuInventory/src/app/api/components/route.ts`
**Pattern**: Fetch settings at start of handler, pass to all calculateReorderStatus calls
**Instructions**:
1. Add import at top (around line 17):
   ```typescript
   import { getComponentQuantities, calculateReorderStatus, getCompanySettings } from '@/services/inventory'
   ```
2. In GET handler, after session check (around line 26), add settings fetch:
   ```typescript
   const settings = await getCompanySettings(session.user.companyId)
   ```
3. Update line 81 (inside reorderStatus filter block):
   ```typescript
   // BEFORE:
   const status = calculateReorderStatus(quantityOnHand, component.reorderPoint)

   // AFTER:
   const status = calculateReorderStatus(quantityOnHand, component.reorderPoint, settings.reorderWarningMultiplier)
   ```
4. Update line 132 (normal query block):
   ```typescript
   // BEFORE:
   const status = calculateReorderStatus(quantityOnHand, component.reorderPoint)

   // AFTER:
   const status = calculateReorderStatus(quantityOnHand, component.reorderPoint, settings.reorderWarningMultiplier)
   ```
5. Update line 231 (POST handler - component creation):
   ```typescript
   // BEFORE:
   reorderStatus: calculateReorderStatus(0, component.reorderPoint),

   // AFTER:
   reorderStatus: calculateReorderStatus(0, component.reorderPoint, settings.reorderWarningMultiplier),
   ```
   Note: For POST handler, fetch settings separately (add after session check around line 165):
   ```typescript
   const settings = await getCompanySettings(session.user.companyId)
   ```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] All 3 calls updated with settings parameter
- [ ] Settings fetched in both GET and POST handlers
- [ ] No TypeScript errors

### Subtask 3.3: Update API Components [id] Route

**File**: `/home/pbrown/SkuInventory/src/app/api/components/[id]/route.ts`
**Pattern**: Same as 3.2
**Instructions**:
1. Update import at line 15-19:
   ```typescript
   import {
     getComponentQuantity,
     calculateReorderStatus,
     canDeleteComponent,
     getCompanySettings,
   } from '@/services/inventory'
   ```
2. In GET handler, after session check (around line 30), add:
   ```typescript
   const settings = await getCompanySettings(session.user.companyId)
   ```
3. Update line 113:
   ```typescript
   reorderStatus: calculateReorderStatus(quantityOnHand, component.reorderPoint, settings.reorderWarningMultiplier),
   ```
4. In PATCH handler, after session check (around line 145), add:
   ```typescript
   const settings = await getCompanySettings(session.user.companyId)
   ```
5. Update line 224:
   ```typescript
   reorderStatus: calculateReorderStatus(quantityOnHand, component.reorderPoint, settings.reorderWarningMultiplier),
   ```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Both GET and PATCH handlers fetch settings
- [ ] Both calculateReorderStatus calls updated
- [ ] No TypeScript errors

### Subtask 3.4: Update Dashboard Route

**File**: `/home/pbrown/SkuInventory/src/app/api/dashboard/route.ts`
**Pattern**: Same as above
**Instructions**:
1. Update import at line 6:
   ```typescript
   import { getComponentQuantities, calculateReorderStatus, getCompanySettings } from '@/services/inventory'
   ```
2. In GET handler, after getting user (around line 67), add:
   ```typescript
   const settings = await getCompanySettings(session.user.companyId)
   ```
3. Update line 92:
   ```typescript
   const status = calculateReorderStatus(quantityOnHand, component.reorderPoint, settings.reorderWarningMultiplier)
   ```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Settings fetched in GET handler
- [ ] calculateReorderStatus call updated
- [ ] Dashboard stats use company-specific multiplier

### Subtask 3.5: Update Export Components Route

**File**: `/home/pbrown/SkuInventory/src/app/api/export/components/route.ts`
**Pattern**: Same as above
**Instructions**:
1. Update import at line 6:
   ```typescript
   import { getComponentQuantities, calculateReorderStatus, getCompanySettings } from '@/services/inventory'
   ```
2. In GET handler, after getting user (around line 27), add:
   ```typescript
   const settings = await getCompanySettings(session.user.companyId)
   ```
3. Update line 54:
   ```typescript
   const reorderStatus = calculateReorderStatus(quantityOnHand, component.reorderPoint, settings.reorderWarningMultiplier)
   ```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Settings fetched in GET handler
- [ ] calculateReorderStatus call updated
- [ ] CSV export uses company-specific multiplier

### Subtask 3.6: Update Components Page (Server Component)

**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/components/page.tsx`
**Pattern**: Server component fetches settings directly
**Instructions**:
1. Update import at line 9:
   ```typescript
   import { getComponentQuantities, calculateReorderStatus, getCompanySettings } from '@/services/inventory'
   ```
2. In `getComponents` function, add settings parameter:
   ```typescript
   async function getComponents(
     brandId: string,
     companyId: string,  // ADD THIS
     params: { ... }
   )
   ```
3. Inside `getComponents`, fetch settings at start of function:
   ```typescript
   const settings = await getCompanySettings(companyId)
   ```
4. Update line 72 (inside reorderStatus filter):
   ```typescript
   const status = calculateReorderStatus(quantityOnHand, component.reorderPoint, settings.reorderWarningMultiplier)
   ```
5. Update line 127 (normal query):
   ```typescript
   const status = calculateReorderStatus(quantityOnHand, component.reorderPoint, settings.reorderWarningMultiplier)
   ```
6. Update the call at line 182 to pass companyId:
   ```typescript
   const { components, total } = await getComponents(brandId, session.user.companyId, {
   ```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Function signature updated with companyId
- [ ] Both calculateReorderStatus calls updated
- [ ] Page renders without errors

---

## Phase 4: Create Build Transaction API Endpoint
*Estimated: 1-2 hours*

### Subtask 4.1: Create Build Transaction Route Directory and File

**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/build/route.ts` (CREATE)
**Pattern**: Follow `/home/pbrown/SkuInventory/src/app/api/transactions/receipt/route.ts` and `/home/pbrown/SkuInventory/src/app/api/transactions/adjustment/route.ts`
**Instructions**:
1. Create directory: `mkdir -p /home/pbrown/SkuInventory/src/app/api/transactions/build`
2. Create file with content:
```typescript
import { NextRequest, NextResponse } from 'next/server'
import { getServerSession } from 'next-auth'
import { authOptions } from '@/lib/auth'
import { prisma } from '@/lib/db'
import { created, unauthorized, notFound, badRequest, serverError, parseBody } from '@/lib/api-response'
import { createBuildSchema } from '@/types/transaction'
import { createBuildTransaction, getCompanySettings } from '@/services/inventory'

// POST /api/transactions/build - Create a build transaction
export async function POST(request: NextRequest) {
  try {
    const session = await getServerSession(authOptions)
    if (!session?.user) {
      return unauthorized()
    }

    // Check role - Viewer cannot create transactions
    if (session.user.role === 'viewer') {
      return unauthorized('You do not have permission to create transactions')
    }

    const bodyResult = await parseBody(request, createBuildSchema)
    if (bodyResult.error) return bodyResult.error

    const data = bodyResult.data

    // Verify SKU exists and belongs to user's company
    const sku = await prisma.sKU.findFirst({
      where: {
        id: data.skuId,
        brand: {
          company: { id: session.user.companyId },
        },
      },
      include: {
        bomVersions: {
          where: { isActive: true },
          take: 1,
        },
      },
    })

    if (!sku) {
      return notFound('SKU')
    }

    if (!sku.bomVersions[0]) {
      return badRequest('SKU has no active BOM')
    }

    const activeBomVersionId = sku.bomVersions[0].id

    // Get company settings
    const settings = await getCompanySettings(session.user.companyId)

    // Determine if we allow insufficient inventory
    // If settings.allowNegativeInventory is true, OR if user explicitly allows it
    const allowInsufficient = settings.allowNegativeInventory || data.allowInsufficientInventory

    try {
      // Create the build transaction
      const result = await createBuildTransaction({
        companyId: session.user.companyId,
        skuId: data.skuId,
        bomVersionId: activeBomVersionId,
        unitsToBuild: data.unitsToBuild,
        salesChannel: data.salesChannel,
        date: data.date,
        notes: data.notes,
        createdById: session.user.id,
        allowInsufficientInventory: allowInsufficient,
      })

      return created({
        data: {
          id: result.transaction.id,
          type: result.transaction.type,
          date: result.transaction.date.toISOString().split('T')[0],
          sku: result.transaction.sku,
          bomVersion: result.transaction.bomVersion,
          salesChannel: result.transaction.salesChannel,
          unitsBuild: result.transaction.unitsBuild,
          unitBomCost: result.transaction.unitBomCost?.toString() ?? null,
          totalBomCost: result.transaction.totalBomCost?.toString() ?? null,
          notes: result.transaction.notes,
          createdAt: result.transaction.createdAt.toISOString(),
          createdBy: result.transaction.createdBy,
          lines: result.transaction.lines.map((line) => ({
            id: line.id,
            component: line.component,
            quantityChange: line.quantityChange.toString(),
            costPerUnit: line.costPerUnit?.toString() ?? null,
          })),
          warning: result.warning,
          insufficientItems: result.insufficientItems,
        },
      })
    } catch (error) {
      // Handle insufficient inventory error
      if (error instanceof Error && error.message.includes('Insufficient inventory')) {
        // Parse out the insufficient items info if available
        // The service throws with insufficient items detail
        // Return 400 with insufficient items so frontend can show warning
        const { checkInsufficientInventory } = await import('@/services/inventory')
        const insufficientItems = await checkInsufficientInventory({
          bomVersionId: activeBomVersionId,
          unitsToBuild: data.unitsToBuild,
        })

        return NextResponse.json(
          {
            error: 'Insufficient inventory',
            insufficientItems,
          },
          { status: 400 }
        )
      }
      throw error
    }
  } catch (error) {
    console.error('Error creating build transaction:', error)
    return serverError()
  }
}
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
curl -X POST https://172.16.20.50:4543/api/transactions/build -H "Content-Type: application/json" -d '{"skuId":"test","unitsToBuild":1,"date":"2025-12-02"}' -k
# Should return 401 Unauthorized (no session)
```

**Completion Criteria**:
- [ ] Route file created
- [ ] TypeScript compiles without errors
- [ ] Build passes
- [ ] API returns 401 for unauthenticated requests
- [ ] BuildDialog works with new endpoint (manual test)

---

## Phase 5: Apply defaultLeadTimeDays in Component Creation
*Estimated: 30 minutes*

### Subtask 5.1: Update Component Creation to Use Settings Default

**File**: `/home/pbrown/SkuInventory/src/app/api/components/route.ts`
**Pattern**: Apply settings default when user doesn't provide value
**Instructions**:
1. In POST handler, settings is already fetched from Subtask 3.2
2. Update the component creation (around line 200-213) to conditionally use settings default:
   ```typescript
   const component = await prisma.component.create({
     data: {
       brandId,
       name: data.name,
       skuCode: data.skuCode,
       category: data.category,
       unitOfMeasure: data.unitOfMeasure,
       costPerUnit: new Prisma.Decimal(data.costPerUnit),
       reorderPoint: data.reorderPoint,
       // Use settings default if leadTimeDays not provided (0 or undefined)
       leadTimeDays: data.leadTimeDays || settings.defaultLeadTimeDays,
       notes: data.notes,
       createdById: session.user.id,
       updatedById: session.user.id,
     },
     include: {
       createdBy: { select: { id: true, name: true } },
     },
   })
   ```

**Note**: The schema has `.default(0)` for leadTimeDays, so we need to check if the user explicitly provided a non-zero value vs accepting the schema default. The safest approach is:
- If `data.leadTimeDays` is 0 or falsy, use `settings.defaultLeadTimeDays`
- If `data.leadTimeDays` is explicitly provided and non-zero, use that value

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] New components use settings.defaultLeadTimeDays when not explicitly provided
- [ ] Explicit non-zero leadTimeDays values are preserved
- [ ] TypeScript compiles

---

## Phase 6: Final Validation
*Estimated: 1-2 hours*

### Subtask 6.1: Run Full Build and Type Check

**Instructions**:
```bash
cd /home/pbrown/SkuInventory
npx tsc --noEmit
npm run build
npm run lint
```

**Completion Criteria**:
- [ ] No TypeScript errors
- [ ] Build succeeds
- [ ] No lint errors

### Subtask 6.2: Manual Testing Checklist

**Instructions**:
1. **Seed script test**:
   ```bash
   # Reset database and reseed
   npx prisma migrate reset --force
   ```
   Verify company settings in database have correct keys.

2. **Reorder multiplier test**:
   - Login as admin
   - Go to Settings, change reorderWarningMultiplier to 2.0
   - Go to Components page
   - Verify warning threshold changed (quantity <= reorderPoint * 2.0 shows warning)

3. **Build transaction test**:
   - Create a SKU with BOM
   - Try to build units
   - Verify build transaction creates correctly
   - Test with insufficient inventory - verify warning shows

4. **allowNegativeInventory test**:
   - Set allowNegativeInventory to true in settings
   - Try build with insufficient inventory
   - Should succeed without warning prompt

5. **defaultLeadTimeDays test**:
   - Set defaultLeadTimeDays to 14 in settings
   - Create new component without specifying leadTimeDays
   - Verify leadTimeDays is 14

**Completion Criteria**:
- [ ] Seed creates valid settings
- [ ] Reorder multiplier changes behavior
- [ ] Build transactions work
- [ ] allowNegativeInventory setting respected
- [ ] defaultLeadTimeDays applied to new components

---

## Summary of Deliverables

**Files Created**: 1
- `/home/pbrown/SkuInventory/src/app/api/transactions/build/route.ts`

**Files Modified**: 7
1. `/home/pbrown/SkuInventory/prisma/seed.ts` - Fix settings key
2. `/home/pbrown/SkuInventory/src/services/inventory.ts` - Add getCompanySettings, update calculateReorderStatus signature
3. `/home/pbrown/SkuInventory/src/app/api/components/route.ts` - Integrate settings
4. `/home/pbrown/SkuInventory/src/app/api/components/[id]/route.ts` - Integrate settings
5. `/home/pbrown/SkuInventory/src/app/api/dashboard/route.ts` - Integrate settings
6. `/home/pbrown/SkuInventory/src/app/api/export/components/route.ts` - Integrate settings
7. `/home/pbrown/SkuInventory/src/app/(dashboard)/components/page.tsx` - Integrate settings

**Dependencies**:
- Phase 1 can be done independently
- Phase 2 must complete before Phases 3-5
- Phase 3 subtasks can be done in any order after 3.1
- Phase 4 depends on Phase 2
- Phase 5 depends on Phase 3.2 (settings fetch in components route)

---

## Handoff to Build Agent

1. Execute subtasks in exact order within each phase
2. Phase 1 is independent - do it first as quick win
3. Phase 2 creates shared helper - must complete before Phases 3-5
4. For Phase 3, update function signature FIRST (3.1), then all callers
5. Test each file after modification with `npx tsc --noEmit`
6. Run full build after each phase completes
7. Follow reference patterns exactly (settings API pattern at lines 39-45)

**Key Code Patterns**:
- Settings fetch pattern: See `/home/pbrown/SkuInventory/src/app/api/settings/route.ts` lines 39-45
- Transaction API pattern: See `/home/pbrown/SkuInventory/src/app/api/transactions/receipt/route.ts`
- Service function export pattern: See `/home/pbrown/SkuInventory/src/services/inventory.ts`

---

## Performance Metrics

| Phase | Duration |
|-------|----------|
| Scout Review | 5m |
| Pattern Research | 15m |
| Ripple Verification | 5m |
| Plan Writing | 25m |
| **Total** | **50m** |
