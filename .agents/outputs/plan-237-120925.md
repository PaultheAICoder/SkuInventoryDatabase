# Implementation Plan
**Generated**: 2025-12-09T21:05:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #237
**Estimated Build Time**: 3-4 hours
**Complexity**: Moderate

## Investigation Summary

### Request Analysis
**Type**: Enhancement
**Source**: GitHub Issue #237
**Priority**: Medium

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: `feedback-service`

### Issue Validation
**Status**: Valid
**Recent Changes**: Phase 1 (#235) and Phase 2 (#236) completed - database models and feedback service already exist

### Current State Assessment
- **Existing components**:
  - `prisma/schema.prisma` - Feedback and EmailMonitorState models exist (Phase 1)
  - `src/services/feedback.ts` - CRUD operations implemented (Phase 2)
  - `src/types/feedback.ts` - Types defined (Phase 2)
  - `src/app/api/webhooks/github/route.ts` - Webhook handler exists but no database integration
  - `src/app/api/feedback/route.ts` - Feedback submission API exists but no database integration
  - `src/app/api/cron/email-monitor/route.ts` - Uses volatile memory for lastCheckTime
- **Database**: Feedback and EmailMonitorState tables exist
- **API Routes**: Both routes need updates to use feedback service
- **Types**: All necessary types already defined

### Dependencies & Blockers
1. **Phase 1 (#235) - COMPLETE**: CRON_SECRET and database migration done
2. **Phase 2 (#236) - COMPLETE**: Feedback service with CRUD operations done
3. **No blockers**: All dependencies satisfied

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Moderate
**Effort**: 3-4 hours
**Risk**: Low (well-defined patterns exist)

### Patterns Identified
**Primary**: `src/services/feedback.ts` - Use existing service functions
**Secondary**: `src/app/api/components/route.ts` - API route with Prisma integration pattern

### Ripple Effect Analysis
**Files Identified**: 3 files need modification

| File | Change Type | Impact |
|------|-------------|--------|
| `src/app/api/webhooks/github/route.ts` | Modify | Add feedback service integration |
| `src/app/api/feedback/route.ts` | Modify | Create Feedback record after issue creation |
| `src/app/api/cron/email-monitor/route.ts` | Modify | Use database-backed lastCheckTime |

**Helper function needed**: `getUserByEmail()` - Need to look up user by email in webhook handler

---

## Executive Summary

Update three API routes to integrate with the feedback service created in Phase 2:
1. Webhook handler creates/updates Feedback records when GitHub issues are closed
2. Feedback submission API creates Feedback record after GitHub issue creation
3. Email monitor uses database-backed lastCheckTime instead of volatile memory

---

## Phase 1: Webhook Handler Integration

### Subtask 1.1: Add feedback service imports to webhook handler
**File**: `/home/pbrown/SkuInventory/src/app/api/webhooks/github/route.ts`
**Pattern**: Follow existing import style in the file
**Instructions**:
1. Add imports at top of file:
```typescript
import { prisma } from '@/lib/db'
import {
  getFeedbackByIssueNumber,
  createFeedback,
  updateFeedbackStatus,
} from '@/services/feedback'
```
**Validation**: `npx tsc --noEmit`
**Completion Criteria**: [ ] Imports compile without errors

### Subtask 1.2: Add helper function to lookup user by email
**File**: `/home/pbrown/SkuInventory/src/app/api/webhooks/github/route.ts`
**Pattern**: Follow `prisma.user.findUnique` pattern from `src/lib/auth.ts:27`
**Instructions**:
1. Add helper function after `extractSubmitterFromBody`:
```typescript
/**
 * Look up user by email address
 */
async function getUserByEmail(email: string): Promise<{ id: string; name: string | null; email: string } | null> {
  const user = await prisma.user.findUnique({
    where: { email },
    select: { id: true, name: true, email: true },
  })
  return user
}
```
**Validation**: `npx tsc --noEmit`
**Completion Criteria**: [ ] Helper function compiles

### Subtask 1.3: Update POST handler to create/update Feedback record
**File**: `/home/pbrown/SkuInventory/src/app/api/webhooks/github/route.ts`
**Pattern**: Follow the existing issue closed handling block (lines 85-168)
**Instructions**:
1. After the `if (action === 'closed' && issue)` block, around line 99 (after submitter email validation):
2. Add feedback record lookup/creation:
```typescript
// Look up user by email
const user = await getUserByEmail(submitter.email)
if (!user) {
  console.log(`[Webhook] User not found for email ${submitter.email} - skipping feedback tracking`)
  // Continue with email notification but skip feedback tracking
}

// Check if feedback record exists (may have been created by /api/feedback)
let feedback = await getFeedbackByIssueNumber(issueNumber)

if (!feedback && user) {
  // Create feedback record if it doesn't exist
  // (handles issues created outside the feedback dialog)
  feedback = await createFeedback({
    userId: user.id,
    githubIssueNumber: issueNumber,
    githubIssueUrl: issue.html_url,
  })
  console.log(`[Webhook] Created feedback record for issue #${issueNumber}`)
}
```

3. After successful email send (around line 147), update feedback status:
```typescript
if (success) {
  console.log(`[Webhook] Notification email sent to ${submitter.email}`)

  // Update feedback record if it exists
  if (feedback) {
    await updateFeedbackStatus(feedback.id, {
      status: 'resolved',
      notificationSentAt: new Date(),
      // Note: Graph API sendMail doesn't return Message-ID; would need to fetch sent item
    })
    console.log(`[Webhook] Updated feedback #${feedback.id} to resolved`)
  }

  // Add comment to issue noting notification was sent...
```

4. Handle edge case: feedback already in resolved/verified state
```typescript
// Before sending email, check if we should skip re-notification
if (feedback && (feedback.status === 'resolved' || feedback.status === 'verified')) {
  console.log(`[Webhook] Feedback #${feedback.id} already in ${feedback.status} state - skipping re-notification`)
  return new Response('OK', { status: 200 })
}
```

**Validation**: `npx tsc --noEmit` and `npm run build`
**Completion Criteria**:
- [ ] TypeScript compiles without errors
- [ ] Build passes
- [ ] Feedback record created when issue closed
- [ ] Status updated to resolved after email sent

### Subtask 1.4: Update GitHub comment to include Message-ID placeholder
**File**: `/home/pbrown/SkuInventory/src/app/api/webhooks/github/route.ts`
**Pattern**: Existing comment creation (line 155-163)
**Instructions**:
1. Update the comment body to note Message-ID is not available:
```typescript
body: `ðŸ“§ Notification sent to submitter (${submitter.email}) requesting verification.${feedback ? `\nTracking: Feedback #${feedback.id.substring(0, 8)}` : ''}`,
```
Note: Graph API `sendMail` doesn't return Message-ID synchronously. Would need additional API call to fetch from Sent folder. For now, track without Message-ID.

**Validation**: `npm run build`
**Completion Criteria**: [ ] Comment includes feedback tracking reference

---

## Phase 2: Feedback Submission API Integration

### Subtask 2.1: Add feedback service import to feedback route
**File**: `/home/pbrown/SkuInventory/src/app/api/feedback/route.ts`
**Pattern**: Follow existing imports in the file
**Instructions**:
1. Add import at top of file:
```typescript
import { createFeedback } from '@/services/feedback'
```
**Validation**: `npx tsc --noEmit`
**Completion Criteria**: [ ] Import compiles

### Subtask 2.2: Create Feedback record after GitHub issue creation
**File**: `/home/pbrown/SkuInventory/src/app/api/feedback/route.ts`
**Pattern**: After `octokit.issues.create` call (around line 100-109)
**Instructions**:
1. After the issue is created and before returning success, add:
```typescript
const issueUrl = issue.html_url
const issueNumber = issue.number

// Create feedback record to track this submission
try {
  await createFeedback({
    userId: session.user.id,
    githubIssueNumber: issueNumber,
    githubIssueUrl: issueUrl,
  })
  console.log(`[Feedback] Created feedback record for issue #${issueNumber}`)
} catch (feedbackError) {
  // Log but don't fail - the GitHub issue was created successfully
  console.error(`[Feedback] Failed to create feedback record:`, feedbackError)
}

const response: SubmitFeedbackResponse = {
  issueUrl,
  issueNumber,
}
```

**Validation**: `npx tsc --noEmit` and `npm run build`
**Completion Criteria**:
- [ ] Feedback record created when user submits feedback
- [ ] Failure to create record doesn't break issue submission

---

## Phase 3: Email Monitor Database Integration

### Subtask 3.1: Update email monitor to use database-backed lastCheckTime
**File**: `/home/pbrown/SkuInventory/src/app/api/cron/email-monitor/route.ts`
**Pattern**: Use `getLastCheckTime()` and `updateLastCheckTime()` from feedback service
**Instructions**:
1. Remove the volatile memory variable (line 24-25):
```typescript
// REMOVE: let lastCheckTime = new Date(Date.now() - 15 * 60 * 1000)
```

2. Add import:
```typescript
import { getLastCheckTime, updateLastCheckTime } from '@/services/feedback'
```

3. Update GET handler to fetch from database (around line 74):
```typescript
// Replace: const previousCheckTime = lastCheckTime
const previousCheckTime = await getLastCheckTime()

// Later, after processing emails:
// Replace: lastCheckTime = new Date()
await updateLastCheckTime(new Date())
```

4. Update POST handler similarly for manual trigger

**Validation**: `npm run build` and manual test with CRON_SECRET
**Completion Criteria**:
- [ ] lastCheckTime persisted in database
- [ ] Survives server restarts
- [ ] Email deduplication works across restarts

### Subtask 3.2: Update email monitor to update Feedback status on verification
**File**: `/home/pbrown/SkuInventory/src/app/api/cron/email-monitor/route.ts`
**Pattern**: Follow existing action handling (lines 160-215)
**Instructions**:
1. Add imports:
```typescript
import {
  getLastCheckTime,
  updateLastCheckTime,
  getFeedbackByIssueNumber,
  updateFeedbackStatus,
} from '@/services/feedback'
```

2. After processing 'verified' action (around line 169):
```typescript
if (action === 'verified') {
  // Update feedback record status
  const feedback = await getFeedbackByIssueNumber(issueNumber)
  if (feedback) {
    await updateFeedbackStatus(feedback.id, {
      status: 'verified',
      responseReceivedAt: new Date(email.receivedAt),
      responseEmailId: email.id,
      responseContent: cleanedBody.substring(0, 1000), // Truncate long responses
    })
    console.log(`[Email Monitor] Updated feedback #${feedback.id} to verified`)
  }

  // Add comment to issue...
```

3. After processing 'changes_requested' action (around line 203-214):
```typescript
if (action === 'changes_requested') {
  // Create follow-up issue...
  const { data: followUpIssue } = await octokit.issues.create({...})

  // Update feedback record status
  const feedback = await getFeedbackByIssueNumber(issueNumber)
  if (feedback) {
    await updateFeedbackStatus(feedback.id, {
      status: 'changes_requested',
      responseReceivedAt: new Date(email.receivedAt),
      responseEmailId: email.id,
      responseContent: cleanedBody.substring(0, 1000),
      followUpIssueNumber: followUpIssue.number,
      followUpIssueUrl: followUpIssue.html_url,
    })
    console.log(`[Email Monitor] Updated feedback #${feedback.id} to changes_requested`)
  }

  // Add comment to original issue...
```

**Validation**: `npm run build`
**Completion Criteria**:
- [ ] Feedback status updated to 'verified' on verification
- [ ] Feedback status updated to 'changes_requested' with follow-up issue link
- [ ] Response content captured

---

## Phase 4: Edge Case Handling

### Subtask 4.1: Handle missing submitter info in webhook
**File**: `/home/pbrown/SkuInventory/src/app/api/webhooks/github/route.ts`
**Pattern**: Existing logging (line 90-91)
**Instructions**:
Already handled - existing code logs warning and returns OK. No changes needed.
**Completion Criteria**: [ ] Verified existing behavior is correct

### Subtask 4.2: Handle user not found in database
**File**: `/home/pbrown/SkuInventory/src/app/api/webhooks/github/route.ts`
**Instructions**:
Already added in Subtask 1.3 - logs warning but continues with email notification.
**Completion Criteria**: [ ] Email still sent even if user not in database

### Subtask 4.3: Handle email send failure
**File**: `/home/pbrown/SkuInventory/src/app/api/webhooks/github/route.ts`
**Instructions**:
Already handled - status only updated to 'resolved' if email succeeds (Subtask 1.3).
**Completion Criteria**: [ ] Status not updated if email fails

### Subtask 4.4: Handle already resolved/verified feedback
**File**: `/home/pbrown/SkuInventory/src/app/api/webhooks/github/route.ts`
**Instructions**:
Added in Subtask 1.3 - skip re-notification for already resolved/verified feedback.
**Completion Criteria**: [ ] No duplicate notifications

---

## Phase 5: Testing & Validation

### Subtask 5.1: Run existing feedback service tests
**Instructions**:
```bash
npm test -- feedback-service
```
**Completion Criteria**: [ ] All 18 existing tests pass

### Subtask 5.2: Verify build passes
**Instructions**:
```bash
npm run build
npx tsc --noEmit
```
**Completion Criteria**: [ ] No TypeScript errors, build succeeds

### Subtask 5.3: Manual integration test (optional)
**Instructions**:
1. Submit feedback via the feedback dialog
2. Verify Feedback record created in database
3. Close the GitHub issue manually
4. Verify webhook updates Feedback status to 'resolved'
**Note**: Requires test environment with valid GitHub webhook

---

## Summary of Deliverables

**Files Created**: 0
**Files Modified**: 3

| File | Type | Changes |
|------|------|---------|
| `src/app/api/webhooks/github/route.ts` | Modify | Add feedback service integration, user lookup, status updates |
| `src/app/api/feedback/route.ts` | Modify | Create Feedback record after issue creation |
| `src/app/api/cron/email-monitor/route.ts` | Modify | Use database-backed lastCheckTime, update feedback status |

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 -> 2 -> 3 -> 4 -> 5)
2. Complete all subtasks in a phase before moving to next
3. Run `npx tsc --noEmit` after each code change
4. Run `npm run build` before completing each phase
5. Follow reference patterns exactly from feedback service

## Test Strategy Note
- Use Vitest for unit tests
- Existing feedback service tests should continue to pass
- No new tests required for Phase 3 (integration tests would require mocking GitHub API)

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 10m |
| **Total** | **30m** |

---

## Key Implementation Notes

### Graph API Message-ID Limitation
The Microsoft Graph `sendMail` endpoint doesn't return the Message-ID synchronously. To get the Message-ID, you would need to:
1. Send the email
2. Query the Sent Items folder for the recently sent message
3. Extract the `internetMessageId` property

For Phase 3, we'll skip Message-ID tracking as it adds complexity. The feedback can still be matched by issue number.

### User Lookup Strategy
When an issue is closed via webhook, we need to find the user in our database by email. The webhook receives the submitter email from the issue body (format: `**Submitted by**: Name (email@example.com)`).

If the user isn't found (e.g., issue created outside our system), we:
1. Log a warning
2. Still send the notification email
3. Skip creating a Feedback record

This handles edge cases gracefully while maintaining the core notification flow.
