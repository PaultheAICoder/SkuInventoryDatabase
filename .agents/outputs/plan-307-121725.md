# Implementation Plan
**Generated**: 2025-12-17T20:00:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: Issue #307 - Fix Date/Timezone Truncation in UI Formatting
**Estimated Build Time**: 2-3 hours
**Complexity**: Low (remaining work only)

## Investigation Summary

### Request Analysis
**Type**: Bug Fix
**Source**: GitHub Issue #307
**Priority**: Medium

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="date"` for date-utils tests, then full test suite

### Issue Validation
**Status**: Valid - Partially Implemented
**Recent Changes**: Work started, ~80% complete - utility function exists, many files updated

### Current State Assessment

**Already Completed**:
- `toLocalDateString()` utility function exists in `src/lib/utils.ts` (lines 49-63)
- Unit tests exist in `tests/unit/date-utils.test.ts` (all passing)
- 38+ source files already updated to use `toLocalDateString()`
- Build and TypeScript compilation pass

**Remaining Work** (6 source files + 9 test files):
| File | Occurrences | Lines |
|------|-------------|-------|
| `src/lib/transaction-parser.ts` | 2 | 98, 340 |
| `src/services/inventory.ts` | 1 | 759 |
| `src/services/chatbot-queries.ts` | 3 | 154, 207, 245 |
| `src/services/alert.ts` | 2 | 147, 325 |
| `src/_deferred/shopify/services/order-posting.ts` | 1 | 215 |
| **Source Total** | **9** | |

**Test Files** (lower priority):
| File | Occurrences |
|------|-------------|
| `tests/integration/transactions.test.ts` | 30+ |
| `tests/integration/lot-consumption.test.ts` | 8 |
| `tests/integration/location-transactions.test.ts` | 20+ |
| `tests/integration/drafts.test.ts` | 2 |
| `tests/integration/auth.test.ts` | 2 |
| `tests/e2e/receipt-lot-capture.spec.ts` | 1 |
| `tests/unit/component-trend.test.ts` | 14 |
| `tests/unit/analytics-service.test.ts` | 1 |
| `tests/unit/forecast-service.test.ts` | 2 |

### Dependencies & Blockers
1. **Utility function**: Already exists and tested
2. **No external blockers**

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Low (remaining work is mechanical)
**Effort**: 2-3 hours
**Risk**: Low - utility function proven, just mechanical replacements

### Patterns Identified
**Primary**: `src/lib/utils.ts:58-63` - `toLocalDateString()` implementation
**Secondary**: Already-updated files (e.g., `src/services/draft-transaction.ts`)

### Ripple Effect Analysis
**Files Remaining**: 6 source files + 9 test files

All files needing updates do NOT currently import `toLocalDateString`, so each requires:
1. Adding the import statement
2. Replacing the pattern occurrences

---

## Executive Summary

Issue #307 work is ~80% complete. The `toLocalDateString()` utility function exists and is tested. This plan completes the remaining 6 source files and 9 test files that still use the buggy `.toISOString().split('T')[0]` pattern.

---

## Phase 1: Service Layer Files

### Subtask 1.1: Update transaction-parser.ts
**File**: `/home/pbrown/SkuInventory/src/lib/transaction-parser.ts`
**Lines**: 98, 340

**Instructions**:
1. Add import at top of file (after line 9):
```typescript
import { toLocalDateString } from '@/lib/utils'
```

2. Replace line 98:
```typescript
// BEFORE
date: parsed.date || new Date().toISOString().split('T')[0],

// AFTER
date: parsed.date || toLocalDateString(new Date()),
```

3. Replace line 340:
```typescript
// BEFORE
const today = new Date().toISOString().split('T')[0]

// AFTER
const today = toLocalDateString(new Date())
```

**Validation Commands**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Import added
- [ ] Both occurrences replaced
- [ ] TypeScript compiles

### Subtask 1.2: Update inventory.ts
**File**: `/home/pbrown/SkuInventory/src/services/inventory.ts`
**Line**: 759

**Instructions**:
1. Add import (after line 11):
```typescript
import { toLocalDateString } from '@/lib/utils'
```

2. Replace line 759:
```typescript
// BEFORE
expiryDate: lot.expiryDate!.toISOString().split('T')[0],

// AFTER
expiryDate: toLocalDateString(lot.expiryDate!),
```

**Completion Criteria**:
- [ ] Import added
- [ ] Occurrence replaced
- [ ] TypeScript compiles

### Subtask 1.3: Update chatbot-queries.ts
**File**: `/home/pbrown/SkuInventory/src/services/chatbot-queries.ts`
**Lines**: 154, 207, 245

**Instructions**:
1. Add import (after line 15):
```typescript
import { toLocalDateString } from '@/lib/utils'
```

2. Replace line 154:
```typescript
// BEFORE
date: tx.transaction.date.toISOString().split('T')[0],

// AFTER
date: toLocalDateString(tx.transaction.date),
```

3. Replace line 207:
```typescript
// BEFORE
date: tx.transaction.date.toISOString().split('T')[0],

// AFTER
date: toLocalDateString(tx.transaction.date),
```

4. Replace line 245:
```typescript
// BEFORE
date: tx.date.toISOString().split('T')[0],

// AFTER
date: toLocalDateString(tx.date),
```

**Completion Criteria**:
- [ ] Import added
- [ ] All 3 occurrences replaced
- [ ] TypeScript compiles

### Subtask 1.4: Update alert.ts
**File**: `/home/pbrown/SkuInventory/src/services/alert.ts`
**Lines**: 147, 325

**Instructions**:
1. Add import (after line 10):
```typescript
import { toLocalDateString } from '@/lib/utils'
```

2. Replace line 147:
```typescript
// BEFORE
date: a.transaction.date.toISOString().split('T')[0],

// AFTER
date: toLocalDateString(a.transaction.date),
```

3. Replace line 325:
```typescript
// BEFORE
date: alert.transaction.date.toISOString().split('T')[0],

// AFTER
date: toLocalDateString(alert.transaction.date),
```

**Completion Criteria**:
- [ ] Import added
- [ ] Both occurrences replaced
- [ ] TypeScript compiles

---

## Phase 2: Deferred Code

### Subtask 2.1: Update order-posting.ts (Shopify - Deferred)
**File**: `/home/pbrown/SkuInventory/src/_deferred/shopify/services/order-posting.ts`
**Line**: 215

**Note**: This is deferred Shopify code, but should be updated for consistency.

**Instructions**:
1. Add import (after line 16):
```typescript
import { toLocalDateString } from '@/lib/utils'
```

2. Replace line 215:
```typescript
// BEFORE
message: `No BOM version effective on ${order.orderDate.toISOString().split('T')[0]}`,

// AFTER
message: `No BOM version effective on ${toLocalDateString(order.orderDate)}`,
```

**Completion Criteria**:
- [ ] Import added
- [ ] Occurrence replaced
- [ ] TypeScript compiles

---

## Phase 3: Test Files

### Subtask 3.1: Update Integration Test Files
**Files**:
- `/home/pbrown/SkuInventory/tests/integration/transactions.test.ts`
- `/home/pbrown/SkuInventory/tests/integration/lot-consumption.test.ts`
- `/home/pbrown/SkuInventory/tests/integration/location-transactions.test.ts`
- `/home/pbrown/SkuInventory/tests/integration/drafts.test.ts`
- `/home/pbrown/SkuInventory/tests/integration/auth.test.ts`

**Instructions**:
For each file:
1. Add import at top:
```typescript
import { toLocalDateString } from '@/lib/utils'
```

2. Replace ALL instances of:
```typescript
new Date().toISOString().split('T')[0]
```
with:
```typescript
toLocalDateString(new Date())
```

3. For date variable patterns like:
```typescript
today.toISOString().split('T')[0]
twentyDaysAgo.toISOString().split('T')[0]
```
Replace with:
```typescript
toLocalDateString(today)
toLocalDateString(twentyDaysAgo)
```

**Note**: Use `replace_all` option where possible for efficiency.

**Completion Criteria**:
- [ ] All 5 integration test files updated
- [ ] All tests pass

### Subtask 3.2: Update Unit Test Files
**Files**:
- `/home/pbrown/SkuInventory/tests/unit/component-trend.test.ts`
- `/home/pbrown/SkuInventory/tests/unit/analytics-service.test.ts`
- `/home/pbrown/SkuInventory/tests/unit/forecast-service.test.ts`

**Instructions**:
Same pattern as integration tests - add import and replace patterns.

**Completion Criteria**:
- [ ] All 3 unit test files updated
- [ ] All tests pass

### Subtask 3.3: Update E2E Test File
**File**: `/home/pbrown/SkuInventory/tests/e2e/receipt-lot-capture.spec.ts`
**Line**: 218

**Instructions**:
1. Add import at top
2. Replace the single occurrence

**Note**: Playwright tests may have different import path resolution - verify import works.

**Completion Criteria**:
- [ ] Import added
- [ ] Occurrence replaced
- [ ] E2E test passes (if environment available)

---

## Phase 4: Validation

### Subtask 4.1: Verify No Remaining Occurrences in Source
**Instructions**:
```bash
cd /home/pbrown/SkuInventory && grep -r "\.toISOString()\.split('T')\[0\]" --include="*.ts" --include="*.tsx" src/ | grep -v "IMPORTANT: This replaces"
```

**Expected Result**: No output (0 matches)

**Completion Criteria**:
- [ ] Grep returns no matches

### Subtask 4.2: Run TypeScript Compilation
**Instructions**:
```bash
cd /home/pbrown/SkuInventory && npx tsc --noEmit
```

**Completion Criteria**:
- [ ] No TypeScript errors

### Subtask 4.3: Run Build
**Instructions**:
```bash
cd /home/pbrown/SkuInventory && npm run build
```

**Completion Criteria**:
- [ ] Build succeeds without errors

### Subtask 4.4: Run Lint
**Instructions**:
```bash
cd /home/pbrown/SkuInventory && npm run lint
```

**Completion Criteria**:
- [ ] Lint passes

### Subtask 4.5: Run Date Utility Tests
**Instructions**:
```bash
cd /home/pbrown/SkuInventory && npm test -- --filter="date-utils"
```

**Completion Criteria**:
- [ ] All date-utils tests pass

### Subtask 4.6: Run Full Test Suite
**Instructions**:
```bash
cd /home/pbrown/SkuInventory && npm test
```

**Completion Criteria**:
- [ ] All tests pass

---

## Summary of Deliverables

**Files Created**: 0
**Files Modified**: 15 total

| Category | Count | Files |
|----------|-------|-------|
| Lib Files | 1 | transaction-parser.ts |
| Services | 3 | inventory.ts, chatbot-queries.ts, alert.ts |
| Deferred Code | 1 | order-posting.ts |
| Integration Tests | 5 | transactions, lot-consumption, location-transactions, drafts, auth |
| Unit Tests | 3 | component-trend, analytics-service, forecast-service |
| E2E Tests | 1 | receipt-lot-capture.spec.ts |

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 -> Phase 2 -> Phase 3 -> Phase 4)
2. Each source file needs both: import added AND pattern replacement
3. Test files have multiple occurrences - use `replace_all` where exact strings match
4. After Phase 2, verify source code clean before moving to tests
5. Run validation after all changes complete

---

## Critical Pattern Notes

### Pattern A: Simple Date Object (most common in tests)
```typescript
// BEFORE
date: new Date().toISOString().split('T')[0],

// AFTER
date: toLocalDateString(new Date()),
```

### Pattern B: Database Date Field (Non-nullable)
```typescript
// BEFORE
date: tx.date.toISOString().split('T')[0],

// AFTER
date: toLocalDateString(tx.date),
```

### Pattern C: Database Date Field with Non-null Assertion
```typescript
// BEFORE
expiryDate: lot.expiryDate!.toISOString().split('T')[0],

// AFTER
expiryDate: toLocalDateString(lot.expiryDate!),
```

### Pattern D: Variable Date
```typescript
// BEFORE
const today = new Date().toISOString().split('T')[0]

// AFTER
const today = toLocalDateString(new Date())
```

---

## Performance Metrics

| Phase | Estimated Duration |
|-------|-------------------|
| Phase 1 (Services) | 20m |
| Phase 2 (Deferred) | 5m |
| Phase 3 (Tests) | 30m |
| Phase 4 (Validation) | 10m |
| **Total Build Time** | **~65m** |

---

## Risk Assessment

| Risk | Likelihood | Mitigation |
|------|------------|------------|
| Missing an occurrence | Low | Grep verification in Phase 4 |
| Type errors | Very Low | All patterns are Date -> string |
| Test failures | Low | Tests should still pass with corrected dates |
| Import path issues in tests | Low | Tests use same @/lib/utils alias |

---

## Verification Commands (After All Changes)

```bash
# Verify no remaining instances in source
cd /home/pbrown/SkuInventory && grep -r "\.toISOString()\.split('T')\[0\]" --include="*.ts" --include="*.tsx" src/ | grep -v "IMPORTANT: This replaces"
# Expected: No output

# Verify no remaining instances in tests (optional)
cd /home/pbrown/SkuInventory && grep -r "\.toISOString()\.split('T')\[0\]" --include="*.ts" tests/ | wc -l
# Expected: 0

# Count files using toLocalDateString (should increase)
grep -r "toLocalDateString" --include="*.ts" --include="*.tsx" src/ tests/ | wc -l
# Expected: 50+ occurrences
```
