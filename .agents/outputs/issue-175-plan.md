# Implementation Plan
**Generated**: 2025-12-05T02:30:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: Issue #175 - Comprehensive: XLSX inventory-snapshot import missing required field handling
**Estimated Build Time**: 8-10 hours
**Complexity**: High

## Investigation Summary

### Request Analysis
**Type**: Enhancement
**Source**: GitHub Issue #175
**Priority**: High

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="import|dialog"`

### Issue Validation
**Status**: Valid
**Recent Changes**:
- Issue #174 (closed) added `companyId` to XLSX import
- Issue #169 (closed) added Company/Brand/Location to CSV templates
- Issue #165 (closed) added BrandSelectionDialog for imports
- Issue #153 (closed) improved error messages for "no active brand"

### Current State Assessment
- **Existing components**:
  - `BrandSelectionDialog` at `/home/pbrown/SkuInventory/src/components/features/BrandSelectionDialog.tsx` - pattern to follow
  - `ImportForm` at `/home/pbrown/SkuInventory/src/components/features/ImportForm.tsx` - needs update
  - CSV imports (components, skus) already support Company/Brand/Location columns
- **Database**: No schema changes needed - Company, Brand, Location models exist
- **API Routes**:
  - `/api/import/inventory-snapshot/route.ts` - XLSX, needs Company/Brand/Location support
  - `/api/import/initial-inventory/route.ts` - CSV, needs Company/Brand support
  - `/api/import/components/route.ts` - CSV, already has lookup pattern (use as reference)
- **Types**: `InventorySnapshotRow` interface in `/home/pbrown/SkuInventory/src/services/xlsx-import.ts` needs extension

### Dependencies & Blockers
1. No external dependencies
2. All UI components (shadcn/ui) already available
3. Lookup patterns established in components import route

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: High
**Effort**: 8-10 hours
**Risk**: Medium - touches multiple files, but follows established patterns

### Patterns Identified
**Primary**: `/home/pbrown/SkuInventory/src/components/features/BrandSelectionDialog.tsx` - copy for CompanySelectionDialog and LocationSelectionDialog
**Secondary**: `/home/pbrown/SkuInventory/src/app/api/import/components/route.ts` - lookup pattern for Company/Brand/Location resolution

### Ripple Effect Analysis
**Files Identified**: 9 files total

| File | Change Type | Description |
|------|-------------|-------------|
| `src/components/features/CompanySelectionDialog.tsx` | NEW | Company selection dialog |
| `src/components/features/LocationSelectionDialog.tsx` | NEW | Location selection dialog |
| `src/components/features/ImportForm.tsx` | MODIFY | Add company/location dialog handling |
| `src/services/xlsx-import.ts` | MODIFY | Parse Company/Brand/Location columns, extend types |
| `src/app/api/import/inventory-snapshot/route.ts` | MODIFY | Add lookup logic, validate file values |
| `src/services/import.ts` | MODIFY | Add Company/Brand to initial-inventory schema |
| `src/app/api/import/initial-inventory/route.ts` | MODIFY | Add Company/Brand lookup logic |
| `tests/unit/xlsx-import.test.ts` | MODIFY | Add tests for new column parsing |
| `tests/e2e/inventory-snapshot-import.spec.ts` | MODIFY | Add E2E tests for new dialogs |

---

## Executive Summary
This enhancement adds Company, Brand, and Location column support to XLSX inventory-snapshot imports and Company/Brand support to CSV initial-inventory imports. Users can now specify these values directly in import files, with validation and fallback to session defaults. New dialogs (CompanySelectionDialog, LocationSelectionDialog) prompt users when required fields are missing and cannot be determined from session or file.

## Phase 1: UI Components - Selection Dialogs

### Subtask 1.1: Create CompanySelectionDialog Component
**File**: `/home/pbrown/SkuInventory/src/components/features/CompanySelectionDialog.tsx`
**Pattern**: Copy from `/home/pbrown/SkuInventory/src/components/features/BrandSelectionDialog.tsx`
**Instructions**:
1. Create new file copying BrandSelectionDialog structure
2. Change props interface to `CompanySelectionDialogProps`:
   - `open: boolean`
   - `onOpenChange: (open: boolean) => void`
   - `onCompanySelected: (companyId: string) => void`
   - `title?: string` (default: "Company Required")
   - `description?: string` (default: "Please select a company to continue with the import.")
3. Use `session.user.companies` or fetch companies from `/api/companies`
4. Call `/api/companies/switch` on confirmation to update session
5. Show appropriate "No Companies Available" state
**Validation Commands**:
```bash
npx tsc --noEmit
npm run lint
```
**Completion Criteria**:
- [ ] Component renders with company dropdown
- [ ] Selecting company calls switch API
- [ ] Session updates after selection
- [ ] TypeScript compiles without errors

### Subtask 1.2: Create LocationSelectionDialog Component
**File**: `/home/pbrown/SkuInventory/src/components/features/LocationSelectionDialog.tsx`
**Pattern**: Copy from `/home/pbrown/SkuInventory/src/components/features/BrandSelectionDialog.tsx`
**Instructions**:
1. Create new file copying BrandSelectionDialog structure
2. Change props interface to `LocationSelectionDialogProps`:
   - `open: boolean`
   - `onOpenChange: (open: boolean) => void`
   - `onLocationSelected: (locationId: string) => void`
   - `title?: string` (default: "Location Required")
   - `description?: string` (default: "Please select a location to continue with the import.")
3. Fetch locations from `/api/locations` (filter by selected company)
4. Unlike company/brand, location doesn't need a "switch" API - just return selected ID
5. Show appropriate "No Locations Available" state if none exist
**Validation Commands**:
```bash
npx tsc --noEmit
npm run lint
```
**Completion Criteria**:
- [ ] Component renders with location dropdown
- [ ] Locations filtered by current company
- [ ] Returns selected locationId to parent
- [ ] TypeScript compiles without errors

### Subtask 1.3: Update ImportForm to Handle Company/Location Dialogs
**File**: `/home/pbrown/SkuInventory/src/components/features/ImportForm.tsx`
**Pattern**: Follow existing `BrandSelectionDialog` integration
**Instructions**:
1. Import new dialog components:
   ```typescript
   import { CompanySelectionDialog } from './CompanySelectionDialog'
   import { LocationSelectionDialog } from './LocationSelectionDialog'
   ```
2. Add state for new dialogs:
   ```typescript
   const [showCompanyDialog, setShowCompanyDialog] = useState(false)
   const [showLocationDialog, setShowLocationDialog] = useState(false)
   ```
3. In `handleUpload` catch block, detect company/location errors:
   ```typescript
   if (errorMessage.toLowerCase().includes('no company')) {
     setShowCompanyDialog(true)
     return
   }
   if (errorMessage.toLowerCase().includes('no location') ||
       errorMessage.toLowerCase().includes('location required')) {
     setShowLocationDialog(true)
     return
   }
   ```
4. Add handler callbacks for new dialogs
5. Render dialogs at component bottom
**Validation Commands**:
```bash
npx tsc --noEmit
npm run lint
```
**Completion Criteria**:
- [ ] CompanySelectionDialog shown when company error detected
- [ ] LocationSelectionDialog shown when location error detected
- [ ] Import retries after selection
- [ ] TypeScript compiles without errors

---

## Phase 2: Service Layer - XLSX Parsing Enhancement

### Subtask 2.1: Extend InventorySnapshotRow Interface
**File**: `/home/pbrown/SkuInventory/src/services/xlsx-import.ts`
**Instructions**:
1. Update `InventorySnapshotRow` interface (line 11-14):
   ```typescript
   export interface InventorySnapshotRow {
     itemName: string
     currentBalance: number
     company?: string    // Optional company name from file
     brand?: string      // Optional brand name from file
     location?: string   // Optional location name from file
   }
   ```
**Validation Commands**:
```bash
npx tsc --noEmit
```
**Completion Criteria**:
- [ ] Interface extended with optional fields
- [ ] TypeScript compiles without errors

### Subtask 2.2: Update normalizeSnapshotHeader for New Columns
**File**: `/home/pbrown/SkuInventory/src/services/xlsx-import.ts`
**Instructions**:
1. Update `normalizeSnapshotHeader` function (around line 122-142):
   ```typescript
   export function normalizeSnapshotHeader(header: string): string {
     const normalized = header
       .toLowerCase()
       .replace(/[^a-z0-9]/g, '_')
       .replace(/_+/g, '_')
       .replace(/^_|_$/g, '')

     // Existing mappings
     const itemVariations = ['item', 'item_name', 'name', 'product', 'product_name']
     const balanceVariations = ['current_balance', 'balance', 'quantity', 'qty', 'on_hand', 'onhand', 'count']

     // New mappings
     const companyVariations = ['company', 'company_name']
     const brandVariations = ['brand', 'brand_name']
     const locationVariations = ['location', 'location_name', 'warehouse', 'storage_location']

     if (itemVariations.includes(normalized)) return 'item'
     if (balanceVariations.includes(normalized)) return 'current_balance'
     if (companyVariations.includes(normalized)) return 'company'
     if (brandVariations.includes(normalized)) return 'brand'
     if (locationVariations.includes(normalized)) return 'location'

     return normalized
   }
   ```
**Validation Commands**:
```bash
npx tsc --noEmit
npm test -- --testPathPattern="xlsx-import"
```
**Completion Criteria**:
- [ ] Function recognizes Company/Brand/Location headers
- [ ] Existing tests still pass
- [ ] TypeScript compiles without errors

### Subtask 2.3: Update parseInventorySnapshot to Extract New Columns
**File**: `/home/pbrown/SkuInventory/src/services/xlsx-import.ts`
**Instructions**:
1. In `parseInventorySnapshot` function (line 151+), after getting item/balance indices:
   ```typescript
   const itemIndex = normalizedHeaders.indexOf('item')
   const balanceIndex = normalizedHeaders.indexOf('current_balance')
   const companyIndex = normalizedHeaders.indexOf('company')
   const brandIndex = normalizedHeaders.indexOf('brand')
   const locationIndex = normalizedHeaders.indexOf('location')
   ```
2. Update the row parsing loop to extract optional columns (around line 198-238):
   ```typescript
   const itemName = String(row[itemIndex] ?? '').trim()
   const balanceStr = String(row[balanceIndex] ?? '').trim()
   const company = companyIndex >= 0 ? String(row[companyIndex] ?? '').trim() || undefined : undefined
   const brand = brandIndex >= 0 ? String(row[brandIndex] ?? '').trim() || undefined : undefined
   const location = locationIndex >= 0 ? String(row[locationIndex] ?? '').trim() || undefined : undefined
   ```
3. Update the result push (around line 233):
   ```typescript
   result.rows.push({
     itemName,
     currentBalance,
     company,
     brand,
     location,
   })
   ```
**Validation Commands**:
```bash
npx tsc --noEmit
npm test -- --testPathPattern="xlsx-import"
```
**Completion Criteria**:
- [ ] Optional columns parsed when present
- [ ] Missing columns result in undefined values
- [ ] Existing tests still pass
- [ ] TypeScript compiles without errors

---

## Phase 3: API Route - Inventory Snapshot Enhancement

### Subtask 3.1: Add Lookup Maps to Inventory Snapshot Route
**File**: `/home/pbrown/SkuInventory/src/app/api/import/inventory-snapshot/route.ts`
**Pattern**: Copy from `/home/pbrown/SkuInventory/src/app/api/import/components/route.ts` lines 27-86
**Instructions**:
1. Add `LookupMaps` interface after existing interfaces (around line 22):
   ```typescript
   interface LookupMaps {
     companies: Map<string, string>
     companyNames: Map<string, string>
     brands: Map<string, { id: string; companyId: string }>
     locations: Map<string, { id: string; companyId: string }>
   }
   ```
2. Add `buildLookupMaps` function (copy from components route, simplified):
   ```typescript
   async function buildLookupMaps(
     userId: string,
     selectedCompanyId: string
   ): Promise<LookupMaps> {
     const userCompanies = await prisma.userCompany.findMany({
       where: { userId },
       select: { companyId: true },
     })
     const companyIds = Array.from(new Set([selectedCompanyId, ...userCompanies.map((uc) => uc.companyId)]))

     const [companies, brands, locations] = await Promise.all([
       prisma.company.findMany({
         where: { id: { in: companyIds } },
         select: { id: true, name: true },
       }),
       prisma.brand.findMany({
         where: { companyId: { in: companyIds }, isActive: true },
         select: { id: true, name: true, companyId: true, company: { select: { name: true } } },
       }),
       prisma.location.findMany({
         where: { companyId: { in: companyIds }, isActive: true },
         select: { id: true, name: true, companyId: true, company: { select: { name: true } } },
       }),
     ])

     return {
       companies: new Map(companies.map((c) => [c.name.toLowerCase(), c.id])),
       companyNames: new Map(companies.map((c) => [c.id, c.name])),
       brands: new Map(
         brands.map((b) => [
           `${b.company.name.toLowerCase()}|${b.name.toLowerCase()}`,
           { id: b.id, companyId: b.companyId },
         ])
       ),
       locations: new Map(
         locations.map((l) => [
           `${l.company.name.toLowerCase()}|${l.name.toLowerCase()}`,
           { id: l.id, companyId: l.companyId },
         ])
       ),
     }
   }
   ```
**Validation Commands**:
```bash
npx tsc --noEmit
```
**Completion Criteria**:
- [ ] LookupMaps interface defined
- [ ] buildLookupMaps function added
- [ ] TypeScript compiles without errors

### Subtask 3.2: Update Inventory Snapshot Route to Use File Values
**File**: `/home/pbrown/SkuInventory/src/app/api/import/inventory-snapshot/route.ts`
**Instructions**:
1. After parsing the file (around line 83), build lookup maps:
   ```typescript
   const lookupMaps = await buildLookupMaps(session.user.id, selectedCompanyId)
   ```
2. In the row processing loop (around line 113-215), add resolution logic BEFORE creating component:
   ```typescript
   for (let i = 0; i < parseResult.rows.length; i++) {
     const row = parseResult.rows[i]
     const rowNumber = i + 2

     try {
       // Resolve company from file or use session default
       let resolvedCompanyId = companyId
       if (row.company) {
         const foundCompanyId = lookupMaps.companies.get(row.company.toLowerCase())
         if (!foundCompanyId) {
           result.skipped++
           result.errors.push({
             rowNumber,
             itemName: row.itemName,
             errors: [`Company "${row.company}" not found`],
           })
           continue
         }
         resolvedCompanyId = foundCompanyId
       }

       // Resolve brand from file or use session default
       let resolvedBrandId = brandId
       if (row.brand) {
         const companyName = row.company || lookupMaps.companyNames.get(resolvedCompanyId) || ''
         const brandKey = `${companyName.toLowerCase()}|${row.brand.toLowerCase()}`
         const foundBrand = lookupMaps.brands.get(brandKey)
         if (!foundBrand) {
           result.skipped++
           result.errors.push({
             rowNumber,
             itemName: row.itemName,
             errors: [`Brand "${row.brand}" not found for company`],
           })
           continue
         }
         if (foundBrand.companyId !== resolvedCompanyId) {
           result.skipped++
           result.errors.push({
             rowNumber,
             itemName: row.itemName,
             errors: [`Brand "${row.brand}" does not belong to the specified company`],
           })
           continue
         }
         resolvedBrandId = foundBrand.id
       }

       // Resolve location from file (optional validation)
       let resolvedLocationId: string | undefined
       if (row.location) {
         const companyName = row.company || lookupMaps.companyNames.get(resolvedCompanyId) || ''
         const locationKey = `${companyName.toLowerCase()}|${row.location.toLowerCase()}`
         const foundLocation = lookupMaps.locations.get(locationKey)
         if (!foundLocation) {
           result.skipped++
           result.errors.push({
             rowNumber,
             itemName: row.itemName,
             errors: [`Location "${row.location}" not found for company`],
           })
           continue
         }
         resolvedLocationId = foundLocation.id
       }

       // Use resolvedCompanyId and resolvedBrandId in component creation
       // ... rest of existing logic, replacing companyId with resolvedCompanyId
       // ... and brandId with resolvedBrandId
   ```
3. Update component lookup and creation to use resolved IDs:
   - Line 132-134: Use `resolvedBrandId` instead of `brandId`
   - Line 140-156: Use `resolvedCompanyId` and `resolvedBrandId`
**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```
**Completion Criteria**:
- [ ] Company/Brand/Location resolved from file when provided
- [ ] Falls back to session defaults when not in file
- [ ] Clear error messages for invalid values
- [ ] TypeScript compiles without errors

---

## Phase 4: Initial Inventory CSV Enhancement

### Subtask 4.1: Add Company/Brand to Initial Inventory Schema
**File**: `/home/pbrown/SkuInventory/src/services/import.ts`
**Instructions**:
1. Update `initialInventoryImportSchema` (around line 209-236):
   ```typescript
   const initialInventoryImportSchema = z.object({
     component_sku_code: z.string().min(1, 'Component SKU code is required'),
     quantity: z.string().min(1, 'Quantity is required').transform((v) => {
       const num = parseFloat(v)
       if (isNaN(num) || num <= 0) {
         throw new Error('Quantity must be a positive number')
       }
       return num
     }),
     cost_per_unit: z.string().optional().transform((v) => {
       if (!v || v.trim() === '') return undefined
       const num = parseFloat(v)
       if (isNaN(num) || num < 0) {
         throw new Error('Cost per unit must be a non-negative number')
       }
       return num
     }),
     date: z.string().optional().transform((v) => {
       if (!v || v.trim() === '') return new Date()
       const date = new Date(v)
       if (isNaN(date.getTime())) {
         throw new Error('Invalid date format')
       }
       return date
     }),
     notes: z.string().optional().transform((v) => v || null),
     // NEW: Optional company/brand columns
     company: z.string().optional().transform((v) => v || undefined),
     brand: z.string().optional().transform((v) => v || undefined),
   })
   ```
2. Update `InitialInventoryRowData` interface (around line 349-355):
   ```typescript
   export interface InitialInventoryRowData {
     componentSkuCode: string
     quantity: number
     costPerUnit?: number
     date: Date
     notes: string | null
     company?: string   // NEW
     brand?: string     // NEW
   }
   ```
3. Update `importInitialInventoryRow` function to include new fields (around line 360-397):
   ```typescript
   const rowData: InitialInventoryRowData = {
     componentSkuCode: csvParsed.component_sku_code,
     quantity: csvParsed.quantity,
     costPerUnit: csvParsed.cost_per_unit,
     date: csvParsed.date,
     notes: csvParsed.notes,
     company: csvParsed.company,  // NEW
     brand: csvParsed.brand,      // NEW
   }
   ```
4. Update `generateInitialInventoryTemplate` to include new columns (around line 639-660):
   ```typescript
   export function generateInitialInventoryTemplate(): string {
     const headers = [
       'Component SKU Code',
       'Quantity',
       'Cost Per Unit',
       'Date',
       'Notes',
       'Company',  // NEW
       'Brand',    // NEW
     ]

     const exampleRow = [
       'COMP-001',
       '100',
       '10.50',
       '2025-01-01',
       'Opening balance',
       '',  // Company (optional)
       '',  // Brand (optional)
     ]

     return [headers.join(','), exampleRow.join(',')].join('\n')
   }
   ```
**Validation Commands**:
```bash
npx tsc --noEmit
npm run lint
```
**Completion Criteria**:
- [ ] Schema includes optional company/brand fields
- [ ] Interface updated with new fields
- [ ] Template includes new columns
- [ ] TypeScript compiles without errors

### Subtask 4.2: Update Initial Inventory Route with Lookup Logic
**File**: `/home/pbrown/SkuInventory/src/app/api/import/initial-inventory/route.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/app/api/import/inventory-snapshot/route.ts` after subtask 3.2
**Instructions**:
1. Add `LookupMaps` interface and `buildLookupMaps` function (same as inventory-snapshot)
2. After parsing CSV (around line 73), build lookup maps:
   ```typescript
   const lookupMaps = await buildLookupMaps(session.user.id, selectedCompanyId)
   ```
3. In the row processing loop, resolve company/brand from file if provided:
   ```typescript
   // Resolve company from file or use session default
   let resolvedCompanyId = selectedCompanyId
   if (rowData.company) {
     const foundCompanyId = lookupMaps.companies.get(rowData.company.toLowerCase())
     if (!foundCompanyId) {
       result.skipped++
       result.errors.push({
         rowNumber: row.rowNumber,
         componentSkuCode: rowData.componentSkuCode,
         errors: [`Company "${rowData.company}" not found`],
       })
       continue
     }
     resolvedCompanyId = foundCompanyId
   }

   // Resolve brand from file if provided (for component lookup scoping)
   let resolvedBrandId: string | undefined
   if (rowData.brand) {
     const companyName = rowData.company || lookupMaps.companyNames.get(resolvedCompanyId) || ''
     const brandKey = `${companyName.toLowerCase()}|${rowData.brand.toLowerCase()}`
     const foundBrand = lookupMaps.brands.get(brandKey)
     if (!foundBrand) {
       result.skipped++
       result.errors.push({
         rowNumber: row.rowNumber,
         componentSkuCode: rowData.componentSkuCode,
         errors: [`Brand "${rowData.brand}" not found for company`],
       })
       continue
     }
     resolvedBrandId = foundBrand.id
   }
   ```
4. Update component lookup to optionally filter by brand:
   ```typescript
   const component = await prisma.component.findFirst({
     where: {
       companyId: resolvedCompanyId,
       skuCode: rowData.componentSkuCode,
       ...(resolvedBrandId ? { brandId: resolvedBrandId } : {}),
     },
   })
   ```
5. Update transaction creation to use `resolvedCompanyId`:
   ```typescript
   await createInitialTransaction({
     companyId: resolvedCompanyId,
     // ... rest stays same
   })
   ```
**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```
**Completion Criteria**:
- [ ] Company/Brand resolved from file when provided
- [ ] Falls back to session defaults when not in file
- [ ] Component lookup scoped correctly
- [ ] TypeScript compiles without errors

---

## Phase 5: Tests

### Subtask 5.1: Add Unit Tests for New Header Normalization
**File**: `/home/pbrown/SkuInventory/tests/unit/xlsx-import.test.ts`
**Instructions**:
1. Add new test cases to `normalizeSnapshotHeader` describe block:
   ```typescript
   it('should normalize Company to company', () => {
     expect(normalizeSnapshotHeader('Company')).toBe('company')
   })

   it('should normalize Company Name to company', () => {
     expect(normalizeSnapshotHeader('Company Name')).toBe('company')
   })

   it('should normalize Brand to brand', () => {
     expect(normalizeSnapshotHeader('Brand')).toBe('brand')
   })

   it('should normalize Brand Name to brand', () => {
     expect(normalizeSnapshotHeader('Brand Name')).toBe('brand')
   })

   it('should normalize Location to location', () => {
     expect(normalizeSnapshotHeader('Location')).toBe('location')
   })

   it('should normalize Warehouse to location', () => {
     expect(normalizeSnapshotHeader('Warehouse')).toBe('location')
   })
   ```
**Validation Commands**:
```bash
npm test -- --testPathPattern="xlsx-import"
```
**Completion Criteria**:
- [ ] All new header normalization tests pass
- [ ] Existing tests still pass

### Subtask 5.2: Add E2E Tests for Selection Dialogs
**File**: `/home/pbrown/SkuInventory/tests/e2e/inventory-snapshot-import.spec.ts`
**Instructions**:
1. Add test cases for new dialogs:
   ```typescript
   test.describe('Selection Dialogs', () => {
     test('BrandSelectionDialog appears when no brand is selected', async ({ page }) => {
       // This test may need to deselect brand first
       // Test that brand dialog appears on import error
     })

     test('Inventory Snapshot format info mentions optional Company/Brand/Location columns', async ({ page }) => {
       await page.goto('/import')
       await expect(page.locator('h1')).toContainText('Import Data')
       // Verify format info is updated to mention optional columns
     })
   })
   ```
**Validation Commands**:
```bash
npm run test:e2e -- --grep="inventory-snapshot"
```
**Completion Criteria**:
- [ ] E2E tests pass
- [ ] Dialog behavior verified

---

## Summary of Deliverables

**Files Created**: 2
- `src/components/features/CompanySelectionDialog.tsx`
- `src/components/features/LocationSelectionDialog.tsx`

**Files Modified**: 7
- `src/components/features/ImportForm.tsx`
- `src/services/xlsx-import.ts`
- `src/app/api/import/inventory-snapshot/route.ts`
- `src/services/import.ts`
- `src/app/api/import/initial-inventory/route.ts`
- `tests/unit/xlsx-import.test.ts`
- `tests/e2e/inventory-snapshot-import.spec.ts`

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 -> Phase 2 -> Phase 3 -> Phase 4 -> Phase 5)
2. Complete each subtask fully before moving to next
3. Test completion criteria before advancing
4. Follow reference patterns exactly from `BrandSelectionDialog.tsx` and `components/route.ts`
5. Run `npm run build` and `npx tsc --noEmit` after each phase

## Test Strategy Note
- Use Vitest for unit tests (`npm test`)
- Use Playwright for E2E tests (`npm run test:e2e`)
- Run targeted tests with `--testPathPattern` for faster feedback

## Backward Compatibility
- All changes maintain backward compatibility
- Session defaults still work when file columns not present
- Existing import files without new columns continue to work

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 25m |
| Validation | 10m |
| Planning | 20m |
| **Total** | **55m** |

---

AGENT_RETURN: issue-175-plan.md
