# Implementation Plan
**Generated**: 2025-12-10T17:15:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #250
**Estimated Build Time**: 2-4 hours
**Complexity**: Medium

## Investigation Summary

### Request Analysis
**Type**: Bug
**Source**: GitHub Issue #250 (User feedback submission)
**Priority**: Medium
**Reporter**: Trevor Baek (tbaek@vital-enterprises.com)

### Issue Description
When a user tries to build a SKU to add to the FG (Finished Goods) balance, they see a generic error:
> "Something went wrong. An unexpected error occurred. Please try again or contact support if the problem persists."

Expected behavior: Build transaction completes, FG balance increases, corresponding components are depleted.

**Environment Details**:
- Browser: Safari
- Affects: All SKUs (per user report)
- Reproduction: Navigate to SKU detail page, click Build button

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="build|transaction|sku"`

### Issue Validation
**Status**: Valid - requires investigation and fix
**Recent Changes**: Multiple commits to build functionality over past 30 days (lot management, finished goods output, location filtering)

### Current State Assessment

**Error Location Analysis**:
The error message "Something went wrong. An unexpected error occurred. Please try again or contact support if the problem persists." comes from `/home/pbrown/SkuInventory/src/app/error.tsx` (lines 28-31), which is the Next.js Error Boundary.

This indicates the error is:
1. NOT a handled API error (those show "An error occurred" or specific messages)
2. An unhandled exception bubbling up to the React error boundary
3. Could occur during rendering, not just during the API call

**Potential Root Causes Identified**:

1. **Session Loading State Not Handled** (HIGH PROBABILITY)
   - File: `/home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/page.tsx`
   - Line 32: `const { data: session } = useSession()` - Does NOT destructure `status`
   - Other pages like `forecasts/page.tsx`, `settings/page.tsx` properly check `status === 'loading'`
   - When `router.refresh()` is called after build success, session state may briefly become "loading"
   - If any component tries to access session during this period without proper guards, it could throw

2. **Empty outputLocationId Validation** (MEDIUM PROBABILITY)
   - File: `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx`
   - Line 528: `<SelectItem value="">No finished goods output</SelectItem>`
   - Empty string value could cause issues with UUID validation
   - Line 210: `outputLocationId: formData.outputLocationId || undefined` should handle this, but edge cases may exist

3. **Default Location Missing** (MEDIUM PROBABILITY)
   - File: `/home/pbrown/SkuInventory/src/services/inventory.ts`
   - Lines 993-997: If no default location exists and user doesn't select one, `outputLocationIdToUse` becomes `null`
   - Line 1185: `if (shouldOutputFG && outputLocationIdToUse)` - skips FG creation silently
   - This doesn't cause an error but could explain unexpected behavior

4. **Selected Company ID Issues** (LOW PROBABILITY)
   - Multiple API routes use `selectedCompanyId!` non-null assertion
   - If `selectedCompanyId` is empty string `''` (not undefined), assertions pass but queries fail

### Affected Files

**Primary Files**:
- `/home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/page.tsx` - Missing session status check
- `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx` - Build form submission
- `/home/pbrown/SkuInventory/src/app/api/transactions/build/route.ts` - Build API endpoint

**Secondary Files** (potential similar issues):
- `/home/pbrown/SkuInventory/src/app/(dashboard)/page.tsx` - Dashboard (no status check)
- `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/users/page.tsx` - Users page (no status check)
- `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/companies/page.tsx` - Companies page (no status check)
- `/home/pbrown/SkuInventory/src/app/(dashboard)/components/[id]/page.tsx` - Component detail (no status check)
- `/home/pbrown/SkuInventory/src/app/(dashboard)/transactions/page.tsx` - Transactions (no status check)

### Pattern Detection - Similar Bugs Across Files

**Pattern Identified**: Missing `status` check from `useSession()` hook

**Files with the same pattern bug**:
1. `/home/pbrown/SkuInventory/src/app/(dashboard)/page.tsx` - Line 76
2. `/home/pbrown/SkuInventory/src/app/(dashboard)/layout.tsx` - Line 54
3. `/home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/page.tsx` - Line 32 (REPORTED)
4. `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/users/page.tsx` - Line 20
5. `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/companies/page.tsx` - Line 13
6. `/home/pbrown/SkuInventory/src/app/(dashboard)/components/[id]/page.tsx` - Line 30
7. `/home/pbrown/SkuInventory/src/app/(dashboard)/transactions/page.tsx` - Line 42

**Files with CORRECT pattern** (for reference):
1. `/home/pbrown/SkuInventory/src/app/(dashboard)/forecasts/page.tsx` - Lines 25, 103, 172
2. `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/page.tsx` - Lines 9, 33, 60
3. `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/alerts/page.tsx` - Lines 21, 52, 74
4. `/home/pbrown/SkuInventory/src/app/(dashboard)/import/page.tsx` - Lines 10, 21

**Batch Fix Decision**: >3 files affected, so fix the reported page and create follow-up issue for others

### Patterns Identified
**Primary Reference**: `/home/pbrown/SkuInventory/src/app/(dashboard)/forecasts/page.tsx`
- Properly destructures `{ data: session, status }` from `useSession()`
- Checks `if (status === 'loading') return` before data fetch
- Renders loading state when `status === 'loading'`

**Secondary Reference**: `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/page.tsx`
- Same pattern for settings page

### Ripple Effect Analysis
**Files Identified**: 7+ dashboard pages with same pattern
- Direct fix: 1 file (SKU detail page)
- Indirect (follow-up): 6+ files

### Dependencies & Blockers
1. None - this is a frontend-only fix with established patterns

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Medium
**Effort**: 2-4 hours
**Risk**: Low (established pattern, isolated changes)

---

## Executive Summary

This bug is caused by the SKU detail page not properly handling the NextAuth session loading state. When a user completes a build transaction and the page refreshes, there's a brief period where the session is in a "loading" state. The page doesn't guard against this, potentially causing unhandled errors that bubble up to the Next.js error boundary.

The fix involves:
1. Adding `status` to the `useSession()` destructure
2. Adding loading state guard in `useEffect` for data fetching
3. Adding loading state rendering condition
4. Adding enhanced error handling and logging for debugging

---

## Phase 0: Debugging and Root Cause Verification

### Subtask 0.1: Add Enhanced Error Logging to Build API
**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/build/route.ts`
**Pattern**: Follow existing error handling pattern
**Instructions**:
1. Add more detailed error logging in the catch block at line 214
2. Log the specific error type, message, and stack trace
3. This will help verify/rule out API-side issues

```typescript
// At line 213-215, enhance error logging:
} catch (error) {
  console.error('Error creating build transaction:', {
    error,
    message: error instanceof Error ? error.message : 'Unknown error',
    stack: error instanceof Error ? error.stack : undefined,
    skuId: data?.skuId,
    companyId: selectedCompanyId,
  })
  return serverError()
}
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Enhanced logging added
- [ ] TypeScript compiles without errors
- [ ] Build succeeds

---

## Phase 1: Fix Session Loading State Handling

### Subtask 1.1: Update SKU Detail Page to Handle Session Loading
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/page.tsx`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/app/(dashboard)/forecasts/page.tsx` (lines 25, 103, 172)
**Instructions**:

1. Change line 32 from:
```typescript
const { data: session } = useSession()
```
To:
```typescript
const { data: session, status } = useSession()
```

2. Update the `fetchData` useCallback to check status (add after line 44):
```typescript
const fetchData = useCallback(async () => {
  if (!skuId) return
  // Don't fetch while session is loading
  if (status === 'loading') return

  try {
    // ... rest of function
```

3. Update the useEffect dependency array at line 72 to include status:
```typescript
useEffect(() => {
  fetchData()
}, [fetchData, status])
```

4. Update the loading check at line 78 to include session loading:
```typescript
if (isLoading || status === 'loading') {
  return (
    // ... loading UI
  )
}
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] `status` destructured from `useSession()`
- [ ] Loading state guard added to `fetchData`
- [ ] `status` added to useEffect dependency array
- [ ] Loading render condition includes session loading
- [ ] TypeScript compiles without errors
- [ ] Build succeeds

### Subtask 1.2: Verify Build Dialog Error Handling
**File**: `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx`
**Instructions**:
1. Review and verify the error handling at lines 265-269 is comprehensive
2. Add console.error logging for debugging if not already present
3. Ensure the catch block handles all error types properly

Current code (verify this is correct):
```typescript
} catch (err) {
  console.error('BuildDialog submission error:', err)
  setError(err instanceof Error ? err.message : 'An error occurred')
} finally {
  setIsLoading(false)
}
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Error handling is comprehensive
- [ ] Console logging exists for debugging
- [ ] TypeScript compiles without errors

---

## Phase 2: Enhanced Error Handling

### Subtask 2.1: Add Error Boundary Logging
**File**: `/home/pbrown/SkuInventory/src/app/error.tsx`
**Instructions**:
1. Enhance the error logging at line 17 to include more context:

```typescript
useEffect(() => {
  // Log the error to an error reporting service with more context
  console.error('Application error:', {
    message: error.message,
    digest: error.digest,
    stack: error.stack,
    name: error.name,
    url: typeof window !== 'undefined' ? window.location.href : 'SSR',
  })
}, [error])
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Enhanced error logging added
- [ ] Includes URL context for debugging
- [ ] TypeScript compiles without errors

---

## Phase 3: Testing

### Subtask 3.1: Manual Testing in Test Environment
**Target**: http://172.16.20.50:2345
**Instructions**:
1. Log in to the test environment
2. Navigate to any SKU detail page that has an active BOM
3. Click the "Build" button
4. Fill in required fields (units to build)
5. Submit the build
6. Verify:
   - Build transaction completes successfully
   - No error page appears
   - Page refreshes and shows updated data
   - FG balance increases (if outputting to FG)
   - Components are depleted

**Completion Criteria**:
- [ ] Build transaction succeeds without errors
- [ ] Page refreshes properly after build
- [ ] FG balance reflects the build
- [ ] No "Something went wrong" error page

### Subtask 3.2: Run Existing E2E Tests
**Instructions**:
```bash
cd /home/pbrown/SkuInventory
TEST_BASE_URL=http://172.16.20.50:2345 npm run test:e2e -- --filter="build|transaction"
```

**Completion Criteria**:
- [ ] Existing build-related E2E tests pass
- [ ] No regressions introduced

---

## Phase 4: Create Follow-up Issue

### Subtask 4.1: Create GitHub Issue for Similar Pattern Bugs
**Instructions**:
Create a new GitHub issue to track the same session loading pattern bug in other files:

```bash
gh issue create --title "Fix missing session loading state check in dashboard pages" --body "## Description
During investigation of issue #250, a pattern was identified where multiple dashboard pages don't check for session loading state from \`useSession()\`.

## Affected Files
The following files use \`useSession()\` without checking \`status\`:

1. \`/src/app/(dashboard)/page.tsx\` - Line 76
2. \`/src/app/(dashboard)/layout.tsx\` - Line 54
3. \`/src/app/(dashboard)/settings/users/page.tsx\` - Line 20
4. \`/src/app/(dashboard)/settings/companies/page.tsx\` - Line 13
5. \`/src/app/(dashboard)/components/[id]/page.tsx\` - Line 30
6. \`/src/app/(dashboard)/transactions/page.tsx\` - Line 42

## Pattern to Apply
Follow the pattern from \`/src/app/(dashboard)/forecasts/page.tsx\`:
1. Destructure \`{ data: session, status }\` from \`useSession()\`
2. Add \`if (status === 'loading') return\` guard in data fetching
3. Include \`status\` in useEffect dependency arrays
4. Add loading state render condition

## Related
Fixed in #250 for: \`/src/app/(dashboard)/skus/[id]/page.tsx\`
" --label "bug,enhancement"
```

**Completion Criteria**:
- [ ] Follow-up issue created
- [ ] Issue references this fix
- [ ] All affected files listed

---

## Summary of Deliverables

**Files Modified**: 3
- `/home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/page.tsx` - Session loading fix
- `/home/pbrown/SkuInventory/src/app/api/transactions/build/route.ts` - Enhanced logging
- `/home/pbrown/SkuInventory/src/app/error.tsx` - Enhanced error logging

**Files Created**: 0

## Handoff to Build Agent

1. Execute subtasks in order (Phase 0 -> Phase 1 -> Phase 2 -> Phase 3 -> Phase 4)
2. Verify each completion criteria before moving to next subtask
3. Run TypeScript and build checks after each file modification
4. Manual testing is CRITICAL for this bug fix
5. Create follow-up issue for batch fixes in Phase 4

## Test Strategy Note
- Primary: Manual testing in test environment (http://172.16.20.50:2345)
- Secondary: Existing E2E tests with `--filter="build|transaction"`
- Target test database only (port 2346)

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 25m |
| Validation | 10m |
| Planning | 15m |
| **Total** | **50m** |

---

## Additional Notes

### Why This Bug May Be Intermittent
The user reported the issue happens "on all SKUs", but it may actually be timing-dependent:
1. If `router.refresh()` triggers a session re-validation
2. And the page re-renders before session state is fully loaded
3. The error boundary catches the unhandled state

This explains why the bug might not be 100% reproducible - it depends on timing between session state updates and page re-renders.

### Safari-Specific Considerations
The user mentioned Safari browser. Safari has different timing for async operations which could make this race condition more likely to occur. The fix (proper session status handling) should address this regardless of browser.
