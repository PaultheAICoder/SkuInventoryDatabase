# Implementation Plan

**Generated**: 2026-01-08
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #393
**Estimated Build Time**: 2-3 hours
**Complexity**: Low
**Tier**: 2 (Standard)

## Investigation Summary

### Request Analysis
**Type**: Bug Fix
**Source**: GitHub Issue #393
**Priority**: P2 (Medium)

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="component"` (component-related tests)

### Issue Validation
**Status**: Valid
**Recent Changes**: Issue #342 increased BOMLine.quantityPerUnit precision to Decimal(18,10) - same pattern can be followed

### Current State Assessment
- **Database Schema**: Component.costPerUnit is `Decimal(10, 4)` - supports only 4 decimal places
- **Display Issue (Primary)**: ComponentTable displays with `.toFixed(2)` truncating to 2 decimals
- **Display Issue (Secondary)**: ComponentForm input has `step="0.0001"` limiting to 4 decimals
- **Detail Page**: Already uses `.toFixed(4)` which is better but still limited

### The Problem
1. **Schema limitation**: `Decimal(10, 4)` only stores 4 decimal places - values like 0.011625 are rounded to 0.0116
2. **Display truncation**: ComponentTable uses `.toFixed(2)` showing $0.01 instead of $0.011625
3. **Input limitation**: Form step is "0.0001" preventing entry of more than 4 decimals

### Dependencies & Blockers
None - this is a self-contained fix

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Simple (Tier 2 for multiple coordinated changes)
**Effort**: 2-3 hours
**Risk**: Low - similar migration already done for BOMLine.quantityPerUnit

### Patterns Identified
**Primary**: `/home/pbrown/SkuInventory/prisma/migrations/20251231210614_increase_bom_quantity_precision/migration.sql`
- This migration shows how to increase Decimal precision with ALTER TABLE
**Secondary**: Component detail page already uses `.toFixed(4)` in some places

### Ripple Effect Analysis
**Files Identified**: 5 files to modify

| File | Line | Change Type |
|------|------|-------------|
| `prisma/schema.prisma` | 214 | Schema: Change Decimal(10, 4) to Decimal(12, 6) |
| `src/components/features/ComponentTable.tsx` | 230 | Display: Change toFixed(2) to toFixed(6) with trailing zero trimming |
| `src/components/features/ComponentForm.tsx` | 231 | Input: Change step="0.0001" to step="0.000001" |
| `src/app/(dashboard)/components/[id]/page.tsx` | 201 | Display: Already uses toFixed(4), update to toFixed(6) with trimming |

**Note on Display Format**: To avoid showing excessive zeros (e.g., "$0.010000"), the display should show up to 6 decimal places but trim trailing zeros.

---

## Executive Summary

This bug fix addresses component price display and storage precision. The fix involves:
1. Updating the Prisma schema from Decimal(10,4) to Decimal(12,6) to store 6 decimal places
2. Creating a database migration to alter the column
3. Updating ComponentTable to display full precision instead of truncated 2 decimals
4. Updating ComponentForm input step to allow 6 decimal place entry

---

## Phase 1: Database Schema Update

### Subtask 1.1: Update Prisma Schema
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Line**: 214
**Pattern**: Follow existing Decimal definitions

**Instructions**:
1. Change line 214 from:
   ```prisma
   costPerUnit   Decimal  @default(0) @db.Decimal(10, 4)
   ```
   to:
   ```prisma
   costPerUnit   Decimal  @default(0) @db.Decimal(12, 6)
   ```

**Completion Criteria**:
- [ ] Schema file updated
- [ ] No syntax errors in schema

### Subtask 1.2: Create Database Migration
**File**: New migration file (auto-generated)
**Pattern**: Follow `/home/pbrown/SkuInventory/prisma/migrations/20251231210614_increase_bom_quantity_precision/migration.sql`

**Instructions**:
1. Run: `npx prisma migrate dev --name increase_component_cost_precision`
2. Verify migration SQL is:
   ```sql
   ALTER TABLE "Component" ALTER COLUMN "costPerUnit" TYPE DECIMAL(12,6);
   ```
3. Run: `npx prisma generate`

**Completion Criteria**:
- [ ] Migration created successfully
- [ ] Migration applied to development database
- [ ] Prisma client regenerated

---

## Phase 2: Display Layer Updates

### Subtask 2.1: Update ComponentTable Display
**File**: `/home/pbrown/SkuInventory/src/components/features/ComponentTable.tsx`
**Line**: 230
**Pattern**: Use smart formatting that shows up to 6 decimals but trims trailing zeros

**Instructions**:
1. Add a helper function at the top of the component (before the component function):
   ```typescript
   /**
    * Format price with up to 6 decimal places, trimming trailing zeros
    * but always showing at least 2 decimals for currency consistency
    */
   function formatPrice(value: string | number): string {
     const num = typeof value === 'string' ? parseFloat(value) : value
     // Format to 6 decimals, then trim trailing zeros (keep minimum 2)
     const formatted = num.toFixed(6)
     // Remove trailing zeros but keep at least 2 decimal places
     const trimmed = formatted.replace(/(\.\d{2})0+$/, '$1').replace(/(\.\d{2}\d*?)0+$/, '$1')
     return trimmed
   }
   ```

2. Update line 230 from:
   ```tsx
   ${parseFloat(component.costPerUnit).toFixed(2)}
   ```
   to:
   ```tsx
   ${formatPrice(component.costPerUnit)}
   ```

**Completion Criteria**:
- [ ] Helper function added
- [ ] Display updated to use formatPrice
- [ ] Values like 0.011625 display as "$0.011625"
- [ ] Values like 10.50 display as "$10.50" (not "$10.500000")

### Subtask 2.2: Update Component Detail Page Display
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/components/[id]/page.tsx`
**Line**: 201

**Instructions**:
1. Add the same formatPrice helper function (or import from a shared utility if created)
2. Update line 201 from:
   ```tsx
   ${parseFloat(component.costPerUnit).toFixed(4)}
   ```
   to:
   ```tsx
   ${formatPrice(component.costPerUnit)}
   ```

**Completion Criteria**:
- [ ] Display updated on detail page
- [ ] Consistent formatting with table view

### Subtask 2.3: Update ComponentForm Input Step
**File**: `/home/pbrown/SkuInventory/src/components/features/ComponentForm.tsx`
**Line**: 231

**Instructions**:
1. Update line 231 from:
   ```tsx
   step="0.0001"
   ```
   to:
   ```tsx
   step="0.000001"
   ```

**Completion Criteria**:
- [ ] Form allows entry of 6 decimal places

---

## Phase 3: Validation

### Subtask 3.1: Verify TypeScript and Build
**Instructions**:
1. Run `npx tsc --noEmit` - should pass with no errors
2. Run `npm run build` - should complete successfully
3. Run `npm run lint` - should pass

**Completion Criteria**:
- [ ] TypeScript check passes
- [ ] Build completes without errors
- [ ] Lint passes

### Subtask 3.2: Manual Testing
**Instructions**:
1. Start the test environment: `cd docker && docker compose -f docker-compose.test.yml up -d`
2. Navigate to Components page
3. Edit a component and set price to 0.011625
4. Save the component
5. Verify the table shows "$0.011625" (not "$0.01")
6. Verify the detail page shows "$0.011625"

**Completion Criteria**:
- [ ] 6-decimal prices can be entered
- [ ] 6-decimal prices display correctly in table
- [ ] 6-decimal prices display correctly on detail page
- [ ] Simple prices like $10.50 don't show unnecessary zeros

---

## Summary of Deliverables

**Files Created**: 1
- New Prisma migration file

**Files Modified**: 4
- `prisma/schema.prisma` - Change Decimal precision
- `src/components/features/ComponentTable.tsx` - Add formatPrice, update display
- `src/components/features/ComponentForm.tsx` - Update input step
- `src/app/(dashboard)/components/[id]/page.tsx` - Update display formatting

## Test Strategy Note
- Run targeted tests for component-related functionality
- Manual verification of display formatting is essential

## Design Decision: Decimal(12, 6)
- **12 total digits**: Supports prices up to 999,999.999999 (sufficient for component costs)
- **6 decimal places**: Supports 7-digit precision mentioned by Trevor (e.g., 0.0116254)
- **Alternative considered**: Decimal(18, 10) like BOMLine, but 6 decimals is sufficient for pricing

## Pattern Note
Consider creating a shared utility function for price formatting (`/src/lib/format-price.ts`) if this pattern needs to be reused elsewhere. For this issue, inline functions are acceptable since only 2 files need the helper.

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 10m |
| **Total** | **30m** |
