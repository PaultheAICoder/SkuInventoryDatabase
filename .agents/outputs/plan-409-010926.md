# Implementation Plan

**Issue**: #409 - Change photo storage from AWS S3 to local filesystem
**Tier**: 2 (Standard)
**Type**: Refactor
**Est. Time**: 3-4 hours
**Category**: REFACTORING
**Test Strategy**: TARGETED

---

## Investigation Summary

### Request Analysis
**Type**: Refactor
**Source**: GitHub Issue #409
**Priority**: Medium

### Task Classification
**Category**: REFACTORING
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="photo"`

### Issue Validation
**Status**: Valid
**Recent Changes**: Issue #401 implemented S3-based photo storage (commit 1ec98bf)

### Current State Assessment

**Existing components**:
- `src/services/photo-storage.ts` - S3-based storage service with upload, download, delete, URL generation
- `src/app/api/transactions/[id]/photos/route.ts` - Photo upload (POST) and list (GET) API routes
- `src/app/api/transactions/photos/[photoId]/route.ts` - Photo delete (DELETE) and update (PATCH) API routes
- `src/app/api/transactions/[id]/route.ts` - Transaction detail with photos (uses photo URLs)
- `src/components/features/TransactionPhotoUpload.tsx` - Upload component (client-side)
- `src/components/features/TransactionPhotoGallery.tsx` - Gallery/lightbox component (client-side)
- `tests/unit/photo-storage.test.ts` - Unit tests for photo storage service

**Database**:
- `TransactionPhoto` model exists with `s3Key` and `s3Bucket` columns
- Column names will need to be repurposed: `s3Key` -> local file path, `s3Bucket` -> storage type indicator
- No migration required - columns can be reused with new semantics

**AWS SDK Dependencies**:
- `@aws-sdk/client-s3` (v3.965.0)
- `@aws-sdk/s3-request-presigner` (v3.965.0)

**Environment Variables** (to remove):
- `PHOTO_S3_BUCKET`
- `PHOTO_S3_REGION`
- Note: `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY` are shared with SP-API, DO NOT REMOVE

### Dependencies & Blockers
None - This is a straightforward refactor with no external dependencies.

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Moderate
**Effort**: 3-4 hours
**Risk**: Low - The frontend components and API interfaces remain unchanged; only the storage backend changes.

### Patterns Identified
**Primary**: `src/services/photo-storage.ts` - Current S3 implementation to be replaced
**Secondary**: Next.js static file serving from `public/` directory

### Ripple Effect Analysis
**Files Identified**: 6 files

| File | Why Affected |
|------|--------------|
| `src/services/photo-storage.ts` | Primary change - replace S3 with fs operations |
| `src/app/api/transactions/[id]/photos/route.ts` | Uses `uploadToS3`, `generateS3Key`, `getSignedPhotoUrl`, `isS3Configured` |
| `src/app/api/transactions/photos/[photoId]/route.ts` | Uses `deleteFromS3`, `isS3Configured` |
| `src/app/api/transactions/[id]/route.ts` | Uses `getSignedPhotoUrl`, `isS3Configured` |
| `tests/unit/photo-storage.test.ts` | Tests need updates for local storage functions |
| `package.json` | Remove AWS SDK dependencies |
| `.env.example` | Update env var documentation |

---

## Executive Summary

Replace AWS S3 photo storage with local filesystem storage. Photos will be stored in `public/uploads/photos/{companyId}/{transactionId}/` directory, served directly by Next.js as static files. The `photo-storage.ts` service will be refactored to use Node.js `fs` operations instead of S3 SDK. API routes and frontend components remain unchanged as the interface (upload, URLs, delete) stays the same.

---

## Phase 1: Update Photo Storage Service

### Subtask 1.1: Refactor photo-storage.ts to use local filesystem
**File**: `/home/pbrown/SkuInventory/src/services/photo-storage.ts`
**Pattern**: Node.js fs/promises API
**Instructions**:
1. Remove AWS SDK imports (`S3Client`, `PutObjectCommand`, `GetObjectCommand`, `DeleteObjectCommand`, `getSignedUrl`)
2. Add Node.js fs imports: `import { promises as fs } from 'fs'` and `import path from 'path'`
3. Add constant for storage directory: `const PHOTO_STORAGE_DIR = process.env.PHOTO_STORAGE_PATH || 'public/uploads/photos'`
4. Replace `isS3Configured()` with `isStorageConfigured()` that always returns true (local storage is always available)
5. Replace `uploadToS3()` with `saveToLocal()`:
   - Create directory if not exists using `fs.mkdir(dir, { recursive: true })`
   - Write file using `fs.writeFile()`
6. Replace `getSignedPhotoUrl()` with `getPhotoUrl()` that returns a static URL path:
   - Convert local path to URL: `/uploads/photos/{companyId}/{transactionId}/{filename}`
   - No expiration needed for local files
7. Replace `deleteFromS3()` with `deleteLocal()`:
   - Delete file using `fs.unlink()`
   - Ignore errors if file doesn't exist
8. Update `generateS3Key()` to `generateFilePath()` - returns local path instead of S3 key
9. Update `UploadResult` interface: rename `s3Key` to `filePath`, `s3Bucket` to `storageType` (value: 'local')
10. Keep `validateImageFile()` and `processImage()` unchanged

**Code snippet for new save function**:
```typescript
export async function saveToLocal(
  buffer: Buffer,
  filePath: string
): Promise<void> {
  const fullPath = path.join(process.cwd(), PHOTO_STORAGE_DIR, filePath)
  const dir = path.dirname(fullPath)
  await fs.mkdir(dir, { recursive: true })
  await fs.writeFile(fullPath, buffer)
}
```

**Code snippet for URL generation**:
```typescript
export function getPhotoUrl(filePath: string): string {
  // Remove 'public/' prefix if present since Next.js serves from public
  const urlPath = filePath.replace(/^public\//, '')
  return `/${urlPath}`
}
```

**Completion Criteria**:
- [ ] All S3 imports removed
- [ ] fs/path imports added
- [ ] `saveToLocal()` creates directories and writes files
- [ ] `getPhotoUrl()` returns static URL paths
- [ ] `deleteLocal()` removes files
- [ ] `generateFilePath()` returns local paths
- [ ] `isStorageConfigured()` returns true
- [ ] Existing exports maintain same names for API compatibility (can alias)

### Subtask 1.2: Maintain backward compatibility with exports
**File**: `/home/pbrown/SkuInventory/src/services/photo-storage.ts`
**Instructions**:
To minimize changes in API routes, export the new functions with compatible names:
```typescript
// Backward compatible exports
export { saveToLocal as uploadToS3 }  // API routes call uploadToS3
export { getPhotoUrl as getSignedPhotoUrl }  // API routes call getSignedPhotoUrl
export { deleteLocal as deleteFromS3 }  // API routes call deleteFromS3
export { generateFilePath as generateS3Key }  // API routes call generateS3Key
export { isStorageConfigured as isS3Configured }  // API routes check isS3Configured
```

**Completion Criteria**:
- [ ] All existing function names still exported
- [ ] API routes do not need to change import statements

---

## Phase 2: Update API Routes

### Subtask 2.1: Update photo upload route
**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/[id]/photos/route.ts`
**Pattern**: Follow existing code structure
**Instructions**:
1. Remove the S3 configuration check that returns 503 error (lines 38-44)
2. Update database create to use `storageType: 'local'` instead of `s3Bucket: process.env.PHOTO_S3_BUCKET!`
3. Note: The `s3Key` database column will store the local file path - semantically still "key" to find the file

**Changes needed**:
- Line 39-44: Remove S3 configuration check block (local storage always works)
- Line 108: Change `s3Bucket: process.env.PHOTO_S3_BUCKET!` to `s3Bucket: 'local'`

**Completion Criteria**:
- [ ] S3 configuration check removed
- [ ] Database stores 'local' as s3Bucket value
- [ ] Photo upload works without S3 credentials

### Subtask 2.2: Update photo list route (GET in same file)
**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/[id]/photos/route.ts`
**Instructions**:
1. Simplify GET handler - remove the `if (!isS3Configured())` branch that returns empty URLs
2. The `getSignedPhotoUrl` (now aliased to `getPhotoUrl`) will return static URLs that always work

**Changes needed**:
- Lines 188-205: Remove the S3 check branch, always generate URLs

**Completion Criteria**:
- [ ] GET always returns photo URLs
- [ ] No empty URL fallback needed

### Subtask 2.3: Update photo delete route
**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/photos/[photoId]/route.ts`
**Instructions**:
1. Remove the `if (isS3Configured())` check around delete operations
2. Always attempt to delete local files

**Changes needed**:
- Lines 54-65: Remove the S3 configuration check, always call delete function

**Completion Criteria**:
- [ ] Delete always attempts to remove files
- [ ] Error handling remains for file not found cases

### Subtask 2.4: Update transaction detail route
**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/[id]/route.ts`
**Instructions**:
1. Remove `if (isS3Configured())` checks around URL generation
2. Always generate URLs for photos

**Changes needed**:
- Line 133: Remove S3 configuration condition
- Lines 156-171: Remove the else branch that returns empty URLs

**Completion Criteria**:
- [ ] Photo URLs always generated
- [ ] No empty URL fallback

---

## Phase 3: Update Configuration

### Subtask 3.1: Remove AWS SDK dependencies
**File**: `/home/pbrown/SkuInventory/package.json`
**Instructions**:
1. Remove `"@aws-sdk/client-s3": "^3.965.0"` from dependencies
2. Remove `"@aws-sdk/s3-request-presigner": "^3.965.0"` from dependencies
3. Run `npm install` to update package-lock.json

**Completion Criteria**:
- [ ] AWS SDK packages removed from package.json
- [ ] `npm install` completes successfully
- [ ] `npm run build` passes

### Subtask 3.2: Update environment configuration
**File**: `/home/pbrown/SkuInventory/.env.example`
**Instructions**:
1. Remove the PHOTO STORAGE (AWS S3) section entirely (lines 156-164)
2. Add new LOCAL PHOTO STORAGE section:
```
# ============================================================================
# LOCAL PHOTO STORAGE
# ============================================================================
# Directory for storing uploaded photos (relative to project root)
# Default: public/uploads/photos (served by Next.js)
# PHOTO_STORAGE_PATH=public/uploads/photos
```

**Completion Criteria**:
- [ ] S3-related env vars removed
- [ ] New PHOTO_STORAGE_PATH documented
- [ ] Notes updated to indicate local storage

---

## Phase 4: Setup Upload Directory

### Subtask 4.1: Create uploads directory with .gitkeep
**Instructions**:
1. Create directory: `public/uploads/photos/`
2. Add `.gitkeep` file to track the directory
3. Add `public/uploads/photos/*` to `.gitignore` (but not the .gitkeep)

**Commands**:
```bash
mkdir -p public/uploads/photos
touch public/uploads/photos/.gitkeep
```

**Update .gitignore**:
```
# Uploaded photos (stored locally, not in git)
public/uploads/photos/*
!public/uploads/photos/.gitkeep
```

**Completion Criteria**:
- [ ] Directory exists
- [ ] .gitkeep present
- [ ] .gitignore updated to exclude uploaded files

---

## Phase 5: Update Tests

### Subtask 5.1: Update photo storage unit tests
**File**: `/home/pbrown/SkuInventory/tests/unit/photo-storage.test.ts`
**Instructions**:
1. Update imports - no AWS-related imports
2. Update `generateS3Key` tests to `generateFilePath` (or keep name if aliased)
3. Remove `isS3Configured` tests that check for AWS credentials
4. Add new test for `isStorageConfigured` always returning true
5. Keep `validateImageFile` tests unchanged

**Changes needed**:
- Remove tests at lines 164-202 that check AWS credential presence
- Add simple test that `isS3Configured()` (aliased) returns true

**Completion Criteria**:
- [ ] Tests pass without AWS credentials
- [ ] Coverage maintained for validation and path generation
- [ ] `npm run test` passes

---

## Phase 6: Validation

### Subtask 6.1: Build and type verification
**Instructions**:
Run the following commands and ensure no errors:
```bash
npx tsc --noEmit
npm run build
npm run lint
npm run test
```

**Completion Criteria**:
- [ ] TypeScript compilation passes
- [ ] Next.js build succeeds
- [ ] ESLint passes
- [ ] Tests pass

### Subtask 6.2: Manual verification (optional)
**Instructions**:
1. Start the app in dev mode
2. Navigate to a transaction
3. Upload a photo
4. Verify photo appears in gallery
5. Verify photo can be viewed full-size
6. Verify photo can be deleted
7. Check that file exists in `public/uploads/photos/` directory

**Completion Criteria**:
- [ ] Photo upload works
- [ ] Photos display correctly
- [ ] Photo deletion works
- [ ] Files stored locally in expected location

---

## Summary of Deliverables

**Files Created**: 2
- `public/uploads/photos/.gitkeep`
- (implicit) upload directory structure

**Files Modified**: 7
- `src/services/photo-storage.ts` - Replace S3 with local fs
- `src/app/api/transactions/[id]/photos/route.ts` - Remove S3 checks
- `src/app/api/transactions/photos/[photoId]/route.ts` - Remove S3 checks
- `src/app/api/transactions/[id]/route.ts` - Remove S3 checks
- `package.json` - Remove AWS SDK
- `.env.example` - Update env var documentation
- `tests/unit/photo-storage.test.ts` - Update tests
- `.gitignore` - Exclude uploaded photos

---

## Test Strategy Note

- Unit tests will be updated to remove S3-specific credential checks
- No new integration tests needed - existing flow tests cover the functionality
- Manual verification recommended for first deployment

---

## Technical Notes

### Why public/uploads/photos?
- Next.js automatically serves files from the `public/` directory
- No additional route handler needed for serving images
- Direct URL access: `/uploads/photos/{companyId}/{transactionId}/{filename}.webp`

### Database Column Reuse
- `s3Key` column will store local file path (still acts as "key" to locate file)
- `s3Bucket` column will store 'local' as storage type indicator
- No migration needed - existing photos with S3 keys will be orphaned (acceptable for dev)

### Future Considerations
If S3 support is needed again in the future, the service could be abstracted to support multiple storage backends via a `PHOTO_STORAGE_TYPE` env var (local | s3).

---

## Performance Metrics

| Phase | Estimated Duration |
|-------|-------------------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 20m |
| **Total** | **40m** |
