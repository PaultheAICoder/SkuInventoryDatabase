# Implementation Plan
**Generated**: 2025-12-04T21:00:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #170 - SKU creation "unexpected error" bug
**Estimated Build Time**: 2-3 hours
**Complexity**: Moderate

## Investigation Summary

### Request Analysis
**Type**: Bug Fix
**Source**: GitHub Issue #170
**Priority**: Medium (affects core functionality)

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED
**Suggested Filter**: `--grep="SKU creation"` or run E2E test for SKU creation

### Issue Validation
**Status**: Valid - Bug is reproducible under specific conditions
**Recent Changes**: Issue #167 (unified company/brand selector) and multiple multi-company/multi-brand features added in last 24 hours

### Current State Assessment
- **Existing components**: SKUForm.tsx, api/skus/route.ts - both exist and function
- **Database**: SKU model has correct schema, brands and companies exist
- **API Routes**: POST /api/skus works at the Prisma level (verified with test script)
- **Types**: createSKUSchema validates correctly

### Root Cause Analysis

After extensive investigation, the bug has **multiple potential causes**, all related to the recent multi-company/brand features:

#### Primary Cause: Missing Error Context
The catch block in `/src/app/api/skus/route.ts` (lines 197-200) swallows all errors and returns a generic message:
```typescript
} catch (error) {
  console.error('Error creating SKU:', error)
  return serverError()
}
```

The `console.error` logs to the container but:
1. Production logs may not capture full error details
2. The user sees "An unexpected error occurred" without diagnostic information
3. No way to distinguish between different error types

#### Secondary Cause: Session State Issues
If a user has a stale JWT token (from before multi-company features), the session may have:
- `selectedCompanyId` as undefined (partially fixed by issue #148)
- `selectedBrandId` as undefined (no fallback protection)

When `selectedCompanyId` is undefined:
- Brand lookup query: `prisma.brand.findFirst({ where: { companyId: undefined } })` returns any brand
- SKU create: `companyId: undefined` creates an orphan SKU (companyId is nullable)

#### Tertiary Cause: Brand Mismatch
If `selectedBrandId` points to a brand from a different company than `selectedCompanyId`, the SKU creation succeeds but creates inconsistent data.

### Dependencies & Blockers
1. No blockers - changes are isolated to API route and tests

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Moderate
**Effort**: 2-3 hours
**Risk**: Low - changes are defensive additions, not behavioral changes

### Patterns Identified
**Primary**: `/src/app/api/components/route.ts` - has similar structure and recent validation additions
**Secondary**: `/src/lib/api-response.ts` - error response helpers

### Ripple Effect Analysis
**Files Identified**: 4 files

| File | Reason |
|------|--------|
| `/src/app/api/skus/route.ts` | Main fix location - add validation and error handling |
| `/tests/e2e/sku-creation.spec.ts` | NEW - E2E regression test |
| `/tests/integration/sku-api.test.ts` | NEW - Integration test for API |
| `/scripts/test-sku-creation.ts` | DELETE - temporary test script |

---

## Executive Summary
Fix SKU creation error by adding validation for required session fields, improving error logging, and adding regression tests. The root cause is insufficient validation of session state after recent multi-company/brand features were added.

## Phase 0: Cleanup Temporary Files
### Subtask 0.1: Remove Temporary Test Script
**File**: `/home/pbrown/SkuInventory/scripts/test-sku-creation.ts`
**Instructions**:
1. Delete the temporary test script created during investigation:
```bash
rm /home/pbrown/SkuInventory/scripts/test-sku-creation.ts
```
**Completion Criteria**:
- [ ] File is deleted
- [ ] No references to it in codebase

## Phase 1: API Route Validation & Error Handling
### Subtask 1.1: Add Session Validation in POST Handler
**File**: `/home/pbrown/SkuInventory/src/app/api/skus/route.ts`
**Pattern**: Follow defensive patterns from `/src/app/api/components/route.ts`
**Instructions**:
1. After the session authentication check (line 130), add validation for `selectedCompanyId`:

```typescript
// Validate session has required company context
if (!session.user.selectedCompanyId) {
  console.error('SKU creation failed: No selectedCompanyId in session', {
    userId: session.user.id,
    email: session.user.email,
  })
  return error('Company context is required. Please select a company and try again.', 400, 'BadRequest')
}
```

2. Add the `error` import from `@/lib/api-response` if not already present.

**Completion Criteria**:
- [ ] Validation check added after authentication
- [ ] Error returns 400 BadRequest with helpful message
- [ ] TypeScript compiles without errors

### Subtask 1.2: Improve Error Logging in Catch Block
**File**: `/home/pbrown/SkuInventory/src/app/api/skus/route.ts`
**Instructions**:
1. Enhance the catch block (lines 197-200) to log more diagnostic information:

```typescript
} catch (error) {
  // Log detailed error for debugging
  const errorDetails = {
    message: error instanceof Error ? error.message : 'Unknown error',
    stack: error instanceof Error ? error.stack : undefined,
    name: error instanceof Error ? error.name : undefined,
    userId: session.user.id,
    companyId: selectedCompanyId,
    brandId,
    internalCode: data.internalCode,
  }
  console.error('Error creating SKU:', JSON.stringify(errorDetails, null, 2))

  // Return user-friendly message based on error type
  if (error instanceof Error && error.message.includes('Unique constraint')) {
    return conflict('A SKU with this internal code already exists')
  }

  return serverError('Failed to create SKU. Please try again or contact support.')
}
```

**Completion Criteria**:
- [ ] Catch block logs structured error details
- [ ] User-friendly error message returned
- [ ] Unique constraint errors return 409 Conflict instead of 500

### Subtask 1.3: Add Brand Validation
**File**: `/home/pbrown/SkuInventory/src/app/api/skus/route.ts`
**Instructions**:
1. After the brand lookup/fallback logic (after line 152), add validation that the brand belongs to the selected company:

```typescript
// Validate brand belongs to selected company
const validBrand = await prisma.brand.findFirst({
  where: {
    id: brandId,
    companyId: selectedCompanyId,
    isActive: true
  },
})

if (!validBrand) {
  console.error('SKU creation failed: Brand does not belong to company', {
    brandId,
    companyId: selectedCompanyId,
  })
  return error('Invalid brand selection. Please refresh the page and try again.', 400, 'BadRequest')
}
```

**Completion Criteria**:
- [ ] Brand ownership validation added
- [ ] Error returns 400 with helpful message
- [ ] Prevents cross-company brand assignment

## Phase 2: Regression Tests
### Subtask 2.1: Create E2E Test for SKU Creation
**File**: `/home/pbrown/SkuInventory/tests/e2e/sku-creation.spec.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/tests/e2e/full-workflow.spec.ts`
**Instructions**:
1. Create new E2E test file with the following test cases:

```typescript
import { test, expect } from '@playwright/test'

/**
 * SKU Creation E2E Tests
 * Regression tests for GitHub Issue #170
 */
test.describe('SKU Creation', () => {
  test.beforeEach(async ({ page }) => {
    // Login as admin
    await page.goto('/login')
    await page.waitForSelector('#email', { timeout: 10000 })
    await page.fill('#email', 'admin@tonsil.tech')
    await page.fill('#password', 'changeme123')
    await page.click('button[type="submit"]')
    await page.waitForURL('/', { timeout: 15000 })
  })

  test('can create a new SKU with valid data', async ({ page }) => {
    // Navigate to new SKU form
    await page.goto('/skus/new')
    await page.waitForSelector('form', { timeout: 10000 })

    // Fill out the form
    const uniqueCode = `TEST-${Date.now()}`
    await page.fill('#name', 'Test SKU for Issue #170')
    await page.fill('#internalCode', uniqueCode)

    // Select sales channel
    await page.click('#salesChannel')
    await page.click('text=Amazon')

    // Submit the form
    await page.click('button[type="submit"]')

    // Should redirect to SKU detail page
    await page.waitForURL(/\/skus\/[a-z0-9-]+/, { timeout: 10000 })

    // Verify SKU was created
    await expect(page.locator('h1')).toContainText('Test SKU for Issue #170')
  })

  test('shows validation error for missing required fields', async ({ page }) => {
    await page.goto('/skus/new')
    await page.waitForSelector('form', { timeout: 10000 })

    // Try to submit without filling required fields
    await page.click('button[type="submit"]')

    // Form should not submit due to HTML5 validation
    await expect(page).toHaveURL('/skus/new')
  })

  test('shows error message for duplicate internal code', async ({ page }) => {
    // First create a SKU
    await page.goto('/skus/new')
    await page.waitForSelector('form', { timeout: 10000 })

    const uniqueCode = `DUP-${Date.now()}`
    await page.fill('#name', 'First SKU')
    await page.fill('#internalCode', uniqueCode)
    await page.click('#salesChannel')
    await page.click('text=Amazon')
    await page.click('button[type="submit"]')
    await page.waitForURL(/\/skus\/[a-z0-9-]+/, { timeout: 10000 })

    // Try to create another SKU with same code
    await page.goto('/skus/new')
    await page.waitForSelector('form', { timeout: 10000 })

    await page.fill('#name', 'Second SKU')
    await page.fill('#internalCode', uniqueCode)
    await page.click('#salesChannel')
    await page.click('text=Amazon')
    await page.click('button[type="submit"]')

    // Should see error message
    await expect(page.locator('.bg-destructive\\/10, [role="alert"]')).toBeVisible({ timeout: 5000 })
    await expect(page.locator('.bg-destructive\\/10, [role="alert"]')).toContainText(/already exists/i)
  })
})
```

**Completion Criteria**:
- [ ] E2E test file created
- [ ] Tests pass on test environment (port 2345)
- [ ] Tests cover: success case, validation failure, duplicate code error

### Subtask 2.2: Create Integration Test for SKU API
**File**: `/home/pbrown/SkuInventory/tests/integration/sku-api.test.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/tests/integration/tenant-scoping.test.ts`
**Instructions**:
1. Create integration test for SKU API endpoint:

```typescript
import { describe, it, expect, beforeAll, beforeEach, afterAll } from 'vitest'
import {
  initializeTestSessions,
  setTestSession,
  TEST_SESSIONS,
  getIntegrationPrisma,
  cleanupBeforeTest,
  createTestRequest,
  parseRouteResponse,
} from '../helpers/integration-context'
import { disconnectTestDb } from '../helpers/db'

import { POST as createSKU, GET as listSKUs } from '@/app/api/skus/route'

describe('SKU API', () => {
  beforeAll(async () => {
    const prisma = getIntegrationPrisma()
    await initializeTestSessions(prisma)
  })

  beforeEach(async () => {
    await cleanupBeforeTest()
    setTestSession(TEST_SESSIONS.admin!)
  })

  afterAll(async () => {
    await disconnectTestDb()
  })

  describe('POST /api/skus', () => {
    it('creates SKU with valid data', async () => {
      const request = createTestRequest('/api/skus', {
        method: 'POST',
        body: {
          name: 'Test SKU',
          internalCode: `TEST-${Date.now()}`,
          salesChannel: 'Amazon',
          externalIds: {},
          notes: null,
        },
      })

      const response = await createSKU(request)
      const result = await parseRouteResponse(response)

      expect(result.status).toBe(201)
      expect(result.data).toHaveProperty('id')
      expect(result.data).toHaveProperty('name', 'Test SKU')
    })

    it('returns 400 for invalid sales channel', async () => {
      const request = createTestRequest('/api/skus', {
        method: 'POST',
        body: {
          name: 'Test SKU',
          internalCode: `TEST-${Date.now()}`,
          salesChannel: 'InvalidChannel',
          externalIds: {},
        },
      })

      const response = await createSKU(request)
      const result = await parseRouteResponse(response)

      expect(result.status).toBe(400)
    })

    it('returns 409 for duplicate internal code', async () => {
      const code = `DUP-${Date.now()}`

      // Create first SKU
      const request1 = createTestRequest('/api/skus', {
        method: 'POST',
        body: {
          name: 'First SKU',
          internalCode: code,
          salesChannel: 'Amazon',
          externalIds: {},
        },
      })
      await createSKU(request1)

      // Try to create duplicate
      const request2 = createTestRequest('/api/skus', {
        method: 'POST',
        body: {
          name: 'Second SKU',
          internalCode: code,
          salesChannel: 'Amazon',
          externalIds: {},
        },
      })
      const response = await createSKU(request2)
      const result = await parseRouteResponse(response)

      expect(result.status).toBe(409)
      expect(result.error).toContain('already exists')
    })
  })
})
```

**Completion Criteria**:
- [ ] Integration test file created
- [ ] Tests pass with `npm test`
- [ ] Tests cover: success, validation error, duplicate error

## Phase 3: Verification
### Subtask 3.1: Run All Tests
**Instructions**:
1. Run unit tests: `npm test`
2. Run integration tests: `npm test -- --config=vitest.integration.config.ts`
3. Run E2E tests: `npx playwright test tests/e2e/sku-creation.spec.ts`

**Completion Criteria**:
- [ ] All unit tests pass (550+)
- [ ] All integration tests pass
- [ ] New E2E tests pass

### Subtask 3.2: Manual Verification
**Instructions**:
1. Open http://172.16.20.50:2345 (test environment)
2. Login as admin@tonsil.tech / changeme123
3. Navigate to SKUs page
4. Click "+ New SKU"
5. Fill in: Name="Manual Test", Internal Code="MANUAL-TEST", Sales Channel=Amazon
6. Click "Create SKU"
7. Verify redirect to SKU detail page
8. Verify SKU appears in list

**Completion Criteria**:
- [ ] SKU creation succeeds
- [ ] No "unexpected error" message
- [ ] SKU visible in list

### Subtask 3.3: Build and Type Check
**Instructions**:
```bash
npm run build
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Build succeeds
- [ ] No TypeScript errors

---

## Summary of Deliverables
**Files Created**: 2
- `/home/pbrown/SkuInventory/tests/e2e/sku-creation.spec.ts`
- `/home/pbrown/SkuInventory/tests/integration/sku-api.test.ts`

**Files Modified**: 1
- `/home/pbrown/SkuInventory/src/app/api/skus/route.ts`

**Files Deleted**: 1
- `/home/pbrown/SkuInventory/scripts/test-sku-creation.ts`

## Handoff to Build Agent
1. Execute subtasks in exact order (Phase 0 -> 1 -> 2 -> 3)
2. Run validation commands after each code change
3. All tests must pass before marking complete
4. Follow reference patterns exactly

## Test Strategy Note
- Unit tests: Vitest (`npm test`)
- Integration tests: Vitest with integration config
- E2E tests: Playwright on test environment (port 2345)

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 35m |
| Validation | 10m |
| Planning | 15m |
| **Total** | **60m** |
