# Implementation Plan
**Generated**: 2025-12-04 00:30 UTC
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #82
**Estimated Build Time**: 6-8 hours
**Complexity**: Medium

## Investigation Summary

### Request Analysis
**Type**: Enhancement (Auth/Session Update)
**Source**: GitHub Issue #82 - "[Parent #24] Update session and auth to support multi-company context"
**Priority**: High (blocks sub-issues 3 and 6 of parent #24)

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="auth|session|compan"` or manual verification

### Issue Validation
**Status**: Valid
**Recent Changes**:
- `b060182` (Dec 4): feat(issue #77): add UserCompany join table and companyId to Component/SKU
- Prisma schema now includes `UserCompany` model with `userId`, `companyId`, `role`, `assignedAt`
- Dependency #77 is complete and merged

### Current State Assessment

**Existing Auth Setup (`/home/pbrown/SkuInventory/src/lib/auth.ts`)**:
- NextAuth v4.24.13 with JWT strategy (30-day expiry)
- CredentialsProvider for email/password login
- Current session includes: `id`, `email`, `name`, `role`, `companyId`, `companyName`
- JWT callback populates token from user object on login
- Session callback copies token values to session
- `logSecurityEvent()` helper function exists for audit logging
- `SECURITY_EVENTS` constant defines event types

**Database Schema (`/home/pbrown/SkuInventory/prisma/schema.prisma`)**:
- `UserCompany` model exists (lines 113-125) with:
  - `id`, `userId`, `companyId`, `role` (UserRole enum), `assignedAt`
  - Unique constraint on `[userId, companyId]`
  - Proper indexes on `userId` and `companyId`
- `User` model has `userCompanies` relation (line 108)
- `Company` model has `userCompanies` relation (line 29)

**Current Type Definitions (`/home/pbrown/SkuInventory/src/types/index.ts`)**:
- `SessionUser` interface (lines 68-76) with basic fields
- NextAuth module declarations in `/home/pbrown/SkuInventory/src/lib/auth.ts` (lines 100-125)

**Frontend Session Usage (`/home/pbrown/SkuInventory/src/app/(dashboard)/layout.tsx`)**:
- Uses `useSession()` hook from `next-auth/react`
- Displays `session?.user?.name` and `session?.user?.role`
- SessionProvider wrapper in `/home/pbrown/SkuInventory/src/components/providers.tsx`

**Middleware (`/home/pbrown/SkuInventory/src/middleware.ts`)**:
- Uses `withAuth` from `next-auth/middleware`
- Accesses `token.role` for permission checks
- Will need updating if middleware needs company context

### Dependencies & Blockers
1. **RESOLVED**: Issue #77 (UserCompany schema) is complete
2. **No external dependencies**: No new packages required
3. **API Pattern Reference**: `/home/pbrown/SkuInventory/src/app/api/settings/route.ts` for admin-only routes

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Medium
**Effort**: 6-8 hours
**Risk**: Medium - JWT token updates require careful handling to avoid session invalidation

### Patterns Identified

**Primary Pattern - Auth Options**: `/home/pbrown/SkuInventory/src/lib/auth.ts`
- JWT strategy with callbacks
- Security event logging
- Module declaration extensions

**Secondary Pattern - API Routes**: `/home/pbrown/SkuInventory/src/app/api/settings/route.ts`
- Admin-only route with role check
- Uses `session.user.companyId` for scoping
- Proper error handling pattern

**API Response Pattern**: `/home/pbrown/SkuInventory/src/lib/api-response.ts`
- `success()`, `unauthorized()`, `forbidden()`, `parseBody()` helpers

### Ripple Effect Analysis

**Files Using Session (Direct Impact)**: 24+ files
- All use `session.user.companyId` for data scoping
- No changes needed to these files for this issue (handled by sub-issue 6)
- The `selectedCompanyId` will be added but initially set to current `companyId`

**Files to Modify**:
1. `/home/pbrown/SkuInventory/src/lib/auth.ts` - Core auth changes
2. `/home/pbrown/SkuInventory/src/types/index.ts` - Update SessionUser type
3. NEW: `/home/pbrown/SkuInventory/src/app/api/companies/switch/route.ts` - Switch endpoint

**TOTAL FILES AFFECTED**: 3 (2 modified, 1 new)

---

## Executive Summary

This implementation extends the NextAuth session to support multi-company context. It adds a `companies` array to the session containing all companies the user has access to via the UserCompany join table, tracks a `selectedCompanyId` for the currently active company, and provides a `POST /api/companies/switch` endpoint for switching between companies. The existing `companyId` field becomes an alias for `selectedCompanyId` for backward compatibility.

---

## Phase 1: Type Definitions

### Subtask 1.1: Extend SessionUser Type in Types Index
**File**: `/home/pbrown/SkuInventory/src/types/index.ts`
**Pattern**: Existing type patterns in same file
**Instructions**:

1. Add a new interface for company info in session:
```typescript
// Company info for session
export interface SessionCompany {
  id: string
  name: string
  role?: 'admin' | 'ops' | 'viewer'
}
```

2. Update the `SessionUser` interface to include multi-company fields:
```typescript
// Session user type (matches NextAuth)
export interface SessionUser {
  id: string
  email: string
  name: string
  role: UserRole
  companyId: string  // Selected company ID (for backward compatibility)
  companyName: string  // Selected company name
  companies: SessionCompany[]  // All accessible companies
  selectedCompanyId: string  // Currently selected company
  selectedCompanyName: string  // Currently selected company name
}
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] `SessionCompany` interface defined
- [ ] `SessionUser` interface updated with `companies`, `selectedCompanyId`, `selectedCompanyName`
- [ ] TypeScript compiles without errors

---

## Phase 2: Auth Configuration Updates

### Subtask 2.1: Update NextAuth Module Declarations
**File**: `/home/pbrown/SkuInventory/src/lib/auth.ts`
**Pattern**: Existing declarations at lines 100-125
**Instructions**:

1. Update the `User` interface in `next-auth` module declaration:
```typescript
declare module 'next-auth' {
  interface User {
    id: string
    role: string
    companyId: string
    companyName: string
    companies: Array<{ id: string; name: string; role?: string }>
    selectedCompanyId: string
    selectedCompanyName: string
  }

  interface Session {
    user: User & {
      id: string
      role: string
      companyId: string
      companyName: string
      companies: Array<{ id: string; name: string; role?: string }>
      selectedCompanyId: string
      selectedCompanyName: string
    }
  }
}
```

2. Update the `JWT` interface in `next-auth/jwt` module declaration:
```typescript
declare module 'next-auth/jwt' {
  interface JWT {
    id: string
    role: string
    companyId: string
    companyName: string
    companies: Array<{ id: string; name: string; role?: string }>
    selectedCompanyId: string
    selectedCompanyName: string
  }
}
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] `User` interface includes `companies`, `selectedCompanyId`, `selectedCompanyName`
- [ ] `Session` interface includes same fields
- [ ] `JWT` interface includes same fields
- [ ] TypeScript compiles without errors

### Subtask 2.2: Update Authorize Function to Fetch User Companies
**File**: `/home/pbrown/SkuInventory/src/lib/auth.ts`
**Pattern**: Existing authorize function at lines 22-74
**Instructions**:

1. Modify the user query in `authorize` to include `userCompanies`:
```typescript
const user = await prisma.user.findUnique({
  where: { email: credentials.email },
  include: {
    company: true,
    userCompanies: {
      include: {
        company: {
          select: { id: true, name: true }
        }
      }
    }
  },
})
```

2. Build the companies array from userCompanies (plus primary company if not in list):
```typescript
// Build companies list from userCompanies
const companiesFromJoin = user.userCompanies.map(uc => ({
  id: uc.company.id,
  name: uc.company.name,
  role: uc.role,
}))

// Ensure primary company is included (for backward compatibility)
const primaryCompanyIncluded = companiesFromJoin.some(c => c.id === user.companyId)
const companies = primaryCompanyIncluded
  ? companiesFromJoin
  : [{ id: user.company.id, name: user.company.name, role: user.role }, ...companiesFromJoin]

// Selected company defaults to primary company
const selectedCompanyId = user.companyId
const selectedCompanyName = user.company.name
```

3. Update the return statement to include new fields:
```typescript
return {
  id: user.id,
  email: user.email,
  name: user.name,
  role: user.role,
  companyId: user.companyId,
  companyName: user.company.name,
  companies,
  selectedCompanyId,
  selectedCompanyName,
}
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] User query includes `userCompanies` relation
- [ ] Companies array built from UserCompany join table
- [ ] Primary company included if not in join table
- [ ] Return object includes all new fields
- [ ] Build passes

### Subtask 2.3: Update JWT Callback
**File**: `/home/pbrown/SkuInventory/src/lib/auth.ts`
**Pattern**: Existing jwt callback at lines 78-86
**Instructions**:

1. Update JWT callback to store new fields:
```typescript
async jwt({ token, user, trigger, session }) {
  if (user) {
    token.id = user.id
    token.role = user.role
    token.companyId = user.companyId
    token.companyName = user.companyName
    token.companies = user.companies
    token.selectedCompanyId = user.selectedCompanyId
    token.selectedCompanyName = user.selectedCompanyName
  }

  // Handle session update (for company switching)
  if (trigger === 'update' && session?.selectedCompanyId) {
    // Verify user has access to the requested company
    const hasAccess = (token.companies as Array<{ id: string }>)?.some(
      c => c.id === session.selectedCompanyId
    )
    if (hasAccess) {
      token.selectedCompanyId = session.selectedCompanyId
      token.selectedCompanyName = session.selectedCompanyName
      // Keep companyId in sync for backward compatibility
      token.companyId = session.selectedCompanyId
      token.companyName = session.selectedCompanyName
    }
  }

  return token
}
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] JWT callback stores all new fields from user
- [ ] `trigger === 'update'` handling added for company switching
- [ ] Access validation before allowing company switch
- [ ] `companyId` kept in sync with `selectedCompanyId`
- [ ] TypeScript compiles without errors

### Subtask 2.4: Update Session Callback
**File**: `/home/pbrown/SkuInventory/src/lib/auth.ts`
**Pattern**: Existing session callback at lines 87-95
**Instructions**:

1. Update session callback to copy new fields:
```typescript
async session({ session, token }) {
  if (session.user) {
    session.user.id = token.id as string
    session.user.role = token.role as string
    session.user.companyId = token.companyId as string
    session.user.companyName = token.companyName as string
    session.user.companies = token.companies as Array<{ id: string; name: string; role?: string }>
    session.user.selectedCompanyId = token.selectedCompanyId as string
    session.user.selectedCompanyName = token.selectedCompanyName as string
  }
  return session
}
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Session includes all new fields from token
- [ ] Proper type casting applied
- [ ] Build passes

### Subtask 2.5: Add COMPANY_SWITCH Security Event Type
**File**: `/home/pbrown/SkuInventory/src/lib/auth.ts`
**Pattern**: Existing SECURITY_EVENTS constant at lines 160-170
**Instructions**:

1. Add new security event type:
```typescript
export const SECURITY_EVENTS = {
  LOGIN: 'login',
  LOGIN_FAILED: 'login_failed',
  LOGOUT: 'logout',
  PASSWORD_CHANGED: 'password_changed',
  USER_CREATED: 'user_created',
  USER_UPDATED: 'user_updated',
  USER_DEACTIVATED: 'user_deactivated',
  ROLE_CHANGED: 'role_changed',
  SETTINGS_CHANGED: 'settings_changed',
  COMPANY_SWITCH: 'company_switch',  // NEW
} as const
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] `COMPANY_SWITCH` event type added
- [ ] TypeScript compiles without errors

---

## Phase 3: Switch Company API Endpoint

### Subtask 3.1: Create Switch Company Route
**File**: `/home/pbrown/SkuInventory/src/app/api/companies/switch/route.ts` (NEW)
**Pattern**: `/home/pbrown/SkuInventory/src/app/api/settings/route.ts`
**Instructions**:

1. Create the directory structure and file:
```bash
mkdir -p src/app/api/companies/switch
```

2. Implement the POST endpoint:
```typescript
import { NextRequest } from 'next/server'
import { getServerSession } from 'next-auth'
import { z } from 'zod'
import { authOptions, logSecurityEvent, SECURITY_EVENTS } from '@/lib/auth'
import { prisma } from '@/lib/db'
import {
  success,
  unauthorized,
  forbidden,
  parseBody,
  serverError,
} from '@/lib/api-response'

// Request body schema
const switchCompanySchema = z.object({
  companyId: z.string().uuid('Invalid company ID'),
})

// POST /api/companies/switch - Switch active company
export async function POST(request: NextRequest) {
  try {
    const session = await getServerSession(authOptions)
    if (!session?.user) {
      return unauthorized()
    }

    const bodyResult = await parseBody(request, switchCompanySchema)
    if (bodyResult.error) return bodyResult.error

    const { companyId } = bodyResult.data

    // Verify user has access to the requested company
    const userCompany = await prisma.userCompany.findUnique({
      where: {
        userId_companyId: {
          userId: session.user.id,
          companyId,
        },
      },
      include: {
        company: {
          select: { id: true, name: true },
        },
      },
    })

    // Also check if it's the user's primary company
    const user = await prisma.user.findUnique({
      where: { id: session.user.id },
      include: { company: { select: { id: true, name: true } } },
    })

    const hasAccess = userCompany || user?.companyId === companyId
    const company = userCompany?.company || (user?.companyId === companyId ? user.company : null)

    if (!hasAccess || !company) {
      return forbidden('You do not have access to this company')
    }

    // Log the company switch event
    await logSecurityEvent({
      companyId: session.user.selectedCompanyId, // Log from the OLD company
      userId: session.user.id,
      eventType: SECURITY_EVENTS.COMPANY_SWITCH,
      details: {
        fromCompanyId: session.user.selectedCompanyId,
        fromCompanyName: session.user.selectedCompanyName,
        toCompanyId: company.id,
        toCompanyName: company.name,
      },
    })

    // Return the new company info for client-side session update
    return success({
      selectedCompanyId: company.id,
      selectedCompanyName: company.name,
      message: `Switched to ${company.name}`,
    })
  } catch (error) {
    console.error('Error switching company:', error)
    return serverError()
  }
}
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] POST endpoint created at `/api/companies/switch`
- [ ] Request body validated with Zod schema
- [ ] User access to company verified via UserCompany OR primary companyId
- [ ] Security event logged with from/to company details
- [ ] Proper error handling (401, 403, 500)
- [ ] Build passes

### Subtask 3.2: Create Types for Switch Endpoint (Optional)
**File**: `/home/pbrown/SkuInventory/src/types/company.ts` (NEW - if needed)
**Instructions**:

If additional type exports are needed for the switch endpoint or future company features, create a company types file:

```typescript
import { z } from 'zod'

// Switch company request schema
export const switchCompanySchema = z.object({
  companyId: z.string().uuid('Invalid company ID'),
})

export type SwitchCompanyInput = z.infer<typeof switchCompanySchema>

// Switch company response
export interface SwitchCompanyResponse {
  selectedCompanyId: string
  selectedCompanyName: string
  message: string
}
```

**Note**: This subtask is optional if the schema is kept inline in the route file.

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Types file created (if needed)
- [ ] TypeScript compiles without errors

---

## Phase 4: Middleware Update (If Needed)

### Subtask 4.1: Review Middleware for Company Context
**File**: `/home/pbrown/SkuInventory/src/middleware.ts`
**Pattern**: Existing middleware patterns
**Instructions**:

1. Review the middleware to ensure it works with the updated token structure.
2. The current middleware only uses `token.role` for permission checks, which remains unchanged.
3. No modifications should be needed for this issue, but verify by inspection.

**Verification**: Check that `token.role` is still accessible and the middleware doesn't break.

**Validation**:
```bash
npm run build
```

**Completion Criteria**:
- [ ] Middleware reviewed - no changes needed
- [ ] Build passes

---

## Phase 5: Verification & Testing

### Subtask 5.1: Manual Verification Steps
**Instructions**:

1. Start the development server:
```bash
npm run dev
```

2. Login with a test user

3. Check browser developer tools > Application > Cookies for the session JWT

4. Verify the session contains:
   - `companies` array with accessible companies
   - `selectedCompanyId` matching the primary company
   - `selectedCompanyName` with company name

5. Test the switch endpoint via curl or API client:
```bash
# Replace with actual auth cookie
curl -X POST http://localhost:4545/api/companies/switch \
  -H "Content-Type: application/json" \
  -d '{"companyId": "uuid-of-company-user-has-access-to"}' \
  --cookie "next-auth.session-token=..."
```

6. Verify security event logged in database:
```sql
SELECT * FROM "SecurityEvent" WHERE "eventType" = 'company_switch' ORDER BY "createdAt" DESC LIMIT 5;
```

**Completion Criteria**:
- [ ] Session contains `companies` array
- [ ] Session contains `selectedCompanyId` and `selectedCompanyName`
- [ ] Switch endpoint returns 200 with new company info (valid company)
- [ ] Switch endpoint returns 403 for unauthorized company
- [ ] Security event logged on company switch
- [ ] `npm run build` passes
- [ ] `npx tsc --noEmit` passes

---

## Summary of Deliverables

**Files Created**: 1
- `/home/pbrown/SkuInventory/src/app/api/companies/switch/route.ts`

**Files Modified**: 2
- `/home/pbrown/SkuInventory/src/lib/auth.ts`
- `/home/pbrown/SkuInventory/src/types/index.ts`

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 -> Phase 2 -> Phase 3 -> Phase 4 -> Phase 5)
2. Run `npx tsc --noEmit` after each phase to catch type errors early
3. The key complexity is in the JWT callback update (Subtask 2.3) - handle the `trigger === 'update'` case carefully
4. Ensure backward compatibility: `companyId` should always equal `selectedCompanyId`
5. Test with actual database data to verify UserCompany queries work

---

## Test Strategy Note

- **Unit Tests**: Not required for this issue (auth changes are difficult to unit test)
- **Integration Testing**: Manual verification with browser and curl
- **Future E2E**: Company selector UI (sub-issue 3) will provide better E2E coverage

---

## Technical Notes for Implementation

### JWT Update Mechanism
NextAuth v4 supports updating the JWT via `session.update()` on the client side. When the client calls `session.update({ selectedCompanyId, selectedCompanyName })`, the JWT callback receives:
- `trigger: 'update'`
- `session: { selectedCompanyId, selectedCompanyName }` (the update payload)

The JWT callback must validate and apply the update.

### Client-Side Usage (For Sub-Issue 3)
After calling `/api/companies/switch`, the frontend will need to:
```typescript
import { useSession } from 'next-auth/react'

const { update } = useSession()

// After successful switch API call:
await update({
  selectedCompanyId: response.selectedCompanyId,
  selectedCompanyName: response.selectedCompanyName
})
```

This triggers the JWT callback with `trigger === 'update'`.

### LocalStorage Persistence
The issue mentions localStorage persistence. This should be handled in sub-issue 3 (Company Selector UI), NOT in this auth issue. The auth layer should be stateless - the selected company is stored in the JWT/session.

---

## Performance Metrics
| Phase | Estimated Duration |
|-------|-------------------|
| Investigation | 25m |
| Validation | 10m |
| Planning | 20m |
| **Total** | **55m** |

---

## Acceptance Criteria Checklist (from Issue)
- [ ] Session includes `companies` array with all accessible companies
- [ ] Session includes `selectedCompanyId` for current company context
- [ ] `POST /api/companies/switch` endpoint validates access and updates session
- [ ] Users with one company have that company auto-selected
- [ ] Company selection persists across page refreshes (localStorage + session) - **NOTE**: localStorage handled by sub-issue 3
- [ ] Security event logged when user switches companies
- [ ] `npm run build` passes
- [ ] `npx tsc --noEmit` passes
