# Implementation Plan
**Generated**: 2026-01-04T10:30:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: Issue #361
**Estimated Build Time**: 6-8 hours
**Complexity**: Medium

## Investigation Summary

### Request Analysis
**Type**: Feature Enhancement
**Source**: GitHub Issue #361
**Priority**: P3 (as per spec User Story 7)

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="watched"` or None

### Issue Validation
**Status**: Valid - Partially implemented
**Recent Changes**:
- 83e86f6 (Jan 2): feat(issue #360): add budget and bid strategy recommendations
- c27efa9 (Dec): feat(issue #354): add Recommendation Engine database schema and types

The WatchedKeyword database model, TypeScript types, API routes, and ACOS calculation service are ALREADY implemented. This issue focuses on the remaining **frontend components and UI integration**.

### Current State Assessment

**Already Implemented:**
- Database: `WatchedKeyword` model in Prisma schema (lines 1152-1164)
- Types: `WatchedKeyword` and `WatchedKeywordAlert` interfaces in `src/types/recommendations.ts`
- API Routes:
  - `GET/POST /api/watched-keywords` - Full CRUD operations
  - `DELETE /api/watched-keywords/[id]` - Delete watched keyword
  - `GET /api/watched-keywords/alerts` - Fetch ACOS change alerts
- Service: `calculateWatchedKeywordAlerts()` in `src/services/watched-keywords.ts`

**Not Yet Implemented (Scope of This Issue):**
1. `WatchedKeywordBadge` component - Visual indicator for watched keywords
2. "Watch" button integration in `KeywordMetricsTable.tsx`
3. Watched keyword alerts panel on Monday Dashboard (`recommendations/page.tsx`)
4. Visual highlighting of watched keywords in tables

### Dependencies & Blockers
1. Existing API routes work correctly - No blockers
2. shadcn/ui Badge component exists at `src/components/ui/badge.tsx`
3. Star icon available from lucide-react

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Medium
**Effort**: 6-8 hours
**Risk**: Low - Well-defined scope, existing patterns to follow

### Patterns Identified
**Primary**: `src/components/features/RecommendationCard.tsx` - Card component with badge styling
**Secondary**: `src/components/analytics/KeywordMetricsTable.tsx` - Table with actions column pattern

### Ripple Effect Analysis
**Files Identified**: 5 files to create/modify
- `src/components/features/WatchedKeywordBadge.tsx` (NEW)
- `src/components/features/WatchedKeywordAlerts.tsx` (NEW)
- `src/components/analytics/KeywordMetricsTable.tsx` (MODIFY)
- `src/app/(dashboard)/recommendations/page.tsx` (MODIFY)
- `src/components/features/index.ts` (MODIFY if exists, or add exports)

---

## Executive Summary

This implementation adds the frontend UI components for the Watched Keywords feature:
1. A badge component to visually indicate watched keywords with a star icon
2. A "Watch" button in keyword performance tables
3. An alerts panel on the Monday Dashboard showing keywords with significant (>20%) ACOS changes

The backend (API routes, database schema, alert calculation service) is already complete.

---

## Phase 1: Create WatchedKeywordBadge Component

### Subtask 1.1: Create WatchedKeywordBadge Component
**File**: `/home/pbrown/SkuInventory/src/components/features/WatchedKeywordBadge.tsx` (NEW)
**Pattern**: Follow `src/components/features/RecommendationCard.tsx` badge styling

**Instructions**:
1. Create a new component that renders a small star icon for watched keywords
2. Include optional tooltip showing "Watched" state
3. Accept props: `keyword: string`, `brandId: string`, `isWatched: boolean`, `onToggle: () => void`

**Component Structure**:
```tsx
'use client'

import { Star } from 'lucide-react'
import { Button } from '@/components/ui/button'
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip'

interface WatchedKeywordBadgeProps {
  isWatched: boolean
  onToggle: () => void
  disabled?: boolean
  size?: 'sm' | 'md'
}

export function WatchedKeywordBadge({
  isWatched,
  onToggle,
  disabled = false,
  size = 'sm',
}: WatchedKeywordBadgeProps) {
  // Render star button with filled/outline state
  // Use yellow-500 color when watched
}
```

**Completion Criteria**:
- [ ] Component renders correctly
- [ ] Star is filled (solid) when `isWatched=true`, outline when `isWatched=false`
- [ ] Tooltip shows "Watch keyword" or "Unwatch keyword"
- [ ] `npx tsc --noEmit` passes

---

## Phase 2: Create WatchedKeywordAlerts Component

### Subtask 2.1: Create WatchedKeywordAlerts Panel Component
**File**: `/home/pbrown/SkuInventory/src/components/features/WatchedKeywordAlerts.tsx` (NEW)
**Pattern**: Follow `src/components/features/RecommendationCard.tsx` Card patterns

**Instructions**:
1. Create a component that displays alerts for watched keywords with significant ACOS changes
2. Fetch alerts from `/api/watched-keywords/alerts` endpoint
3. Display each alert with:
   - Keyword name
   - Current vs Previous ACOS values
   - Percentage change with color coding (green for improvement, red for worsening)
   - Severity badge (warning/critical)
4. Show empty state when no alerts

**Component Structure**:
```tsx
'use client'

import { useState, useEffect } from 'react'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Bell, TrendingUp, TrendingDown, AlertTriangle } from 'lucide-react'
import type { WatchedKeywordAlert } from '@/types/recommendations'

interface WatchedKeywordAlertsProps {
  brandId?: string
}

export function WatchedKeywordAlerts({ brandId }: WatchedKeywordAlertsProps) {
  // Fetch alerts from /api/watched-keywords/alerts
  // Display alerts with proper styling
  // Show empty state if no alerts
}
```

**Display Requirements**:
- Use `AlertTriangle` icon with yellow-500 for warnings
- Use `AlertTriangle` icon with red-500 for critical alerts
- Show ACOS values formatted as percentages (e.g., "25.5%")
- Show change percentage with +/- prefix and color (green = decrease/good, red = increase/bad)

**Completion Criteria**:
- [ ] Component fetches alerts successfully
- [ ] Alerts display correctly with proper formatting
- [ ] Empty state shows appropriate message
- [ ] Loading state shows skeleton
- [ ] `npx tsc --noEmit` passes

---

## Phase 3: Integrate Watch Button into KeywordMetricsTable

### Subtask 3.1: Add Watch Button Column to KeywordMetricsTable
**File**: `/home/pbrown/SkuInventory/src/components/analytics/KeywordMetricsTable.tsx` (MODIFY)
**Pattern**: Existing table column structure in same file

**Instructions**:
1. Add new prop `watchedKeywords?: Set<string>` to track which keywords are watched
2. Add new prop `onToggleWatch?: (keyword: string) => void` callback
3. Add new prop `brandId?: string` for API calls
4. Add a new column as the first column with the WatchedKeywordBadge
5. Make the watch functionality optional (backward compatible)

**Changes Required**:

1. Update interface:
```tsx
interface KeywordMetricsTableProps {
  data: KeywordPerformanceData[]
  isLoading?: boolean
  // NEW props for watch functionality
  watchedKeywords?: Set<string>
  onToggleWatch?: (keyword: string) => void
  brandId?: string
  isWatchLoading?: boolean
}
```

2. Import WatchedKeywordBadge:
```tsx
import { WatchedKeywordBadge } from '@/components/features/WatchedKeywordBadge'
```

3. Add column in TableHeader before "Keyword":
```tsx
{onToggleWatch && (
  <TableHead className="w-[50px]">Watch</TableHead>
)}
```

4. Add cell in TableBody before keyword cell:
```tsx
{onToggleWatch && (
  <TableCell className="text-center">
    <WatchedKeywordBadge
      isWatched={watchedKeywords?.has(row.keyword) ?? false}
      onToggle={() => onToggleWatch(row.keyword)}
      disabled={isWatchLoading}
    />
  </TableCell>
)}
```

5. Update colSpan in empty state from 10 to 11 when watch is enabled

**Completion Criteria**:
- [ ] Watch column appears when `onToggleWatch` prop is provided
- [ ] Star icons show correct state based on `watchedKeywords` Set
- [ ] Clicking star triggers `onToggleWatch` callback
- [ ] Works without watch props (backward compatible)
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds

---

## Phase 4: Integrate into Amazon Analytics Page

### Subtask 4.1: Add Watch Functionality to Amazon Analytics Page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/amazon/page.tsx` (MODIFY)
**Pattern**: Follow existing data fetch patterns in the same file

**Instructions**:
1. Add state for watched keywords:
```tsx
const [watchedKeywords, setWatchedKeywords] = useState<Set<string>>(new Set())
const [isWatchLoading, setIsWatchLoading] = useState(false)
```

2. Add fetch function for watched keywords:
```tsx
const fetchWatchedKeywords = useCallback(async () => {
  if (!selectedBrandId) return
  try {
    const res = await fetch(`/api/watched-keywords?brandId=${selectedBrandId}`)
    if (res.ok) {
      const data = await res.json()
      setWatchedKeywords(new Set(data.watchedKeywords.map((wk: { keyword: string }) => wk.keyword)))
    }
  } catch (err) {
    console.error('Failed to fetch watched keywords:', err)
  }
}, [selectedBrandId])
```

3. Add toggle function:
```tsx
const handleToggleWatch = async (keyword: string) => {
  if (!selectedBrandId) return
  setIsWatchLoading(true)
  try {
    if (watchedKeywords.has(keyword)) {
      // Find the watched keyword ID and delete
      const findRes = await fetch(`/api/watched-keywords?brandId=${selectedBrandId}`)
      if (findRes.ok) {
        const data = await findRes.json()
        const wk = data.watchedKeywords.find((w: { keyword: string }) => w.keyword === keyword)
        if (wk) {
          await fetch(`/api/watched-keywords/${wk.id}`, { method: 'DELETE' })
        }
      }
      setWatchedKeywords(prev => {
        const next = new Set(prev)
        next.delete(keyword)
        return next
      })
    } else {
      // Add new watched keyword
      await fetch('/api/watched-keywords', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ keyword, brandId: selectedBrandId }),
      })
      setWatchedKeywords(prev => new Set(prev).add(keyword))
    }
  } catch (err) {
    console.error('Failed to toggle watch:', err)
  } finally {
    setIsWatchLoading(false)
  }
}
```

4. Call fetchWatchedKeywords in useEffect when brand changes

5. Pass props to KeywordMetricsTable:
```tsx
<KeywordMetricsTable
  data={fullKeywordData}
  isLoading={isLoadingFullKeywords}
  watchedKeywords={watchedKeywords}
  onToggleWatch={handleToggleWatch}
  brandId={selectedBrandId}
  isWatchLoading={isWatchLoading}
/>
```

**Completion Criteria**:
- [ ] Watched keywords load when page loads
- [ ] Clicking star adds/removes keyword from watch list
- [ ] Watch state persists (refetching shows correct state)
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds

---

## Phase 5: Add Alerts to Monday Dashboard

### Subtask 5.1: Add WatchedKeywordAlerts to Recommendations Page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/recommendations/page.tsx` (MODIFY)
**Pattern**: Follow existing card layout in same file

**Instructions**:
1. Import the WatchedKeywordAlerts component:
```tsx
import { WatchedKeywordAlerts } from '@/components/features/WatchedKeywordAlerts'
```

2. Add alerts section between the Stats Cards and Filters:
```tsx
{/* Watched Keyword Alerts */}
{session?.user?.selectedBrandId && (
  <WatchedKeywordAlerts brandId={session.user.selectedBrandId} />
)}
```

**Completion Criteria**:
- [ ] Alerts panel appears on Monday Dashboard when brand selected
- [ ] Alerts load and display correctly
- [ ] Shows empty state when no watched keyword alerts
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds

---

## Phase 6: Final Verification

### Subtask 6.1: Full Build and Type Check
**Instructions**:
1. Run TypeScript check: `npx tsc --noEmit`
2. Run build: `npm run build`
3. Run lint: `npm run lint`

**Completion Criteria**:
- [ ] No TypeScript errors
- [ ] Build succeeds
- [ ] No lint errors

### Subtask 6.2: Manual Verification
**Instructions**:
1. Navigate to Amazon Analytics page (`/amazon`)
2. Verify star icons appear in keyword table
3. Click star to add keyword to watch list
4. Verify star becomes filled/solid
5. Navigate to Recommendations page (`/recommendations`)
6. Verify watched keyword alerts panel appears (if any alerts exist)

**Completion Criteria**:
- [ ] Watch functionality works in keyword table
- [ ] Alerts display on Monday Dashboard

---

## Summary of Deliverables

**Files Created**: 2
- `/home/pbrown/SkuInventory/src/components/features/WatchedKeywordBadge.tsx`
- `/home/pbrown/SkuInventory/src/components/features/WatchedKeywordAlerts.tsx`

**Files Modified**: 2
- `/home/pbrown/SkuInventory/src/components/analytics/KeywordMetricsTable.tsx`
- `/home/pbrown/SkuInventory/src/app/(dashboard)/recommendations/page.tsx`
- `/home/pbrown/SkuInventory/src/app/(dashboard)/amazon/page.tsx`

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 -> Phase 6)
2. Create component files before modifying existing files
3. Test completion criteria before moving to next subtask
4. Follow existing patterns from RecommendationCard.tsx for styling
5. Use shadcn/ui components (Badge, Card, Button) for consistency

## Test Strategy Note

- Run `npx tsc --noEmit` after each file change
- Run `npm run build` after completing each phase
- Use test environment (port 2345) for any manual testing

## Acceptance Criteria (from Issue #361)

- [x] Users can add/remove keywords from watch list (API routes exist)
- [ ] Watched keywords highlighted in tables (Phase 3: Star icon column)
- [ ] >20% ACOS change triggers alert (Service exists, Phase 5: Display on dashboard)

## Performance Metrics
| Phase | Estimated Duration |
|-------|--------------------|
| Investigation | 30m |
| Validation | 10m |
| Planning | 20m |
| **Total** | **60m** |
