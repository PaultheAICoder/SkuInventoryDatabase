# Implementation Plan
**Generated**: 2025-12-04T08:15:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: Issue #89
**Estimated Build Time**: 1-2 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Enhancement
**Source**: GitHub Issue #89
**Priority**: Medium

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: FAST_PATH
**Suggested Filter**: None (minimal changes)

### Issue Validation
**Status**: Valid
**Recent Changes**: Issue #75 added FinishedGoodsLine model, Issue #86 added UI for FG inventory

### Current State Assessment
- **Existing components**:
  - `SKUExportData` interface in `src/services/export.ts` - needs `finishedGoodsOnHand` field
  - `skuExportColumns` array in `src/services/export.ts` - needs new column definition
  - `/api/export/skus` route already fetches SKUs with BOM data
- **Database**: `FinishedGoodsLine` model exists (no schema changes needed)
- **API Routes**: `/api/export/skus/route.ts` needs to query FG balances
- **Types**: Only `SKUExportData` interface needs update (in export.ts)

### Dependencies & Blockers
1. Depends on Issue #75 (schema) - COMPLETE
2. Depends on Issue #86 (UI) - COMPLETE (verified FG lines flow correctly)

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Simple
**Effort**: 1-2 hours
**Risk**: Low

### Patterns Identified
**Primary**: `/home/pbrown/SkuInventory/src/services/finished-goods.ts` - `getSkuQuantities()` function for batch FG balance retrieval
**Secondary**: `/home/pbrown/SkuInventory/src/app/api/export/skus/route.ts` - existing pattern for `maxBuildableUnits` calculation with locationId support

### Ripple Effect Analysis
**Files Identified**: 2
- `/home/pbrown/SkuInventory/src/services/export.ts` - Add field to interface and column to array
- `/home/pbrown/SkuInventory/src/app/api/export/skus/route.ts` - Add FG balance fetch and mapping

---

## Executive Summary
Add a "Finished Goods On Hand" column to the SKU CSV export. This involves adding a field to the `SKUExportData` interface, adding a column definition to `skuExportColumns`, and updating the export route to fetch FG balances using the existing `getSkuQuantities()` service function.

---

## Phase 1: Update Export Service Types and Columns

### Subtask 1.1: Add finishedGoodsOnHand to SKUExportData interface
**File**: `/home/pbrown/SkuInventory/src/services/export.ts`
**Pattern**: Follow existing interface fields on lines 92-103
**Instructions**:
1. Add `finishedGoodsOnHand: number` field to the `SKUExportData` interface
2. Place it after `maxBuildableUnits: number | null` (line 100) to maintain logical grouping

**Code Change**:
```typescript
// In SKUExportData interface (around line 92-103)
export interface SKUExportData {
  id: string
  name: string
  internalCode: string
  salesChannel: string
  notes: string | null
  isActive: boolean
  bomCost: string | null
  maxBuildableUnits: number | null
  finishedGoodsOnHand: number  // NEW - add after maxBuildableUnits
  createdAt: string
  updatedAt: string
}
```

**Completion Criteria**:
- [ ] `finishedGoodsOnHand: number` field added to `SKUExportData` interface
- [ ] Field positioned after `maxBuildableUnits`

### Subtask 1.2: Add Finished Goods On Hand column to skuExportColumns
**File**: `/home/pbrown/SkuInventory/src/services/export.ts`
**Pattern**: Follow existing column definitions on lines 105-116
**Instructions**:
1. Add a new column definition for "Finished Goods On Hand"
2. Place it after the "Max Buildable Units" column (line 111) as specified in acceptance criteria

**Code Change**:
```typescript
// In skuExportColumns array (around line 105-116)
export const skuExportColumns: CSVColumn<SKUExportData>[] = [
  { header: 'ID', accessor: (s) => s.id },
  { header: 'Name', accessor: (s) => s.name },
  { header: 'Internal Code', accessor: (s) => s.internalCode },
  { header: 'Sales Channel', accessor: (s) => s.salesChannel },
  { header: 'BOM Cost', accessor: (s) => s.bomCost },
  { header: 'Max Buildable Units', accessor: (s) => s.maxBuildableUnits },
  { header: 'Finished Goods On Hand', accessor: (s) => s.finishedGoodsOnHand },  // NEW
  { header: 'Notes', accessor: (s) => s.notes },
  { header: 'Active', accessor: (s) => (s.isActive ? 'Yes' : 'No') },
  { header: 'Created At', accessor: (s) => s.createdAt },
  { header: 'Updated At', accessor: (s) => s.updatedAt },
]
```

**Completion Criteria**:
- [ ] New column `{ header: 'Finished Goods On Hand', accessor: (s) => s.finishedGoodsOnHand }` added
- [ ] Column placed after "Max Buildable Units" column

---

## Phase 2: Update SKU Export API Route

### Subtask 2.1: Import getSkuQuantities function
**File**: `/home/pbrown/SkuInventory/src/app/api/export/skus/route.ts`
**Pattern**: Follow existing import statements on lines 1-7
**Instructions**:
1. Add import for `getSkuQuantities` from `@/services/finished-goods`

**Code Change**:
```typescript
// Add to imports at top of file
import { getSkuQuantities } from '@/services/finished-goods'
```

**Completion Criteria**:
- [ ] `getSkuQuantities` imported from `@/services/finished-goods`

### Subtask 2.2: Fetch FG balances for all SKUs and add to export data
**File**: `/home/pbrown/SkuInventory/src/app/api/export/skus/route.ts`
**Pattern**: Follow existing pattern for `calculateMaxBuildableUnits` which also supports locationId
**Instructions**:
1. After fetching SKUs (line 47), extract all SKU IDs
2. Call `getSkuQuantities(skuIds, locationId)` to batch-fetch FG balances
3. In the `Promise.all` map callback, retrieve the FG balance from the Map and add to return object
4. Use `fgQuantities.get(sku.id) ?? 0` to handle SKUs with no FG balance (returns 0)

**Code Change**:
```typescript
// After the SKU query (around line 47):
const skus = await prisma.sKU.findMany({
  // ... existing query
})

// ADD: Get all SKU IDs and fetch FG quantities
const skuIds = skus.map((sku) => sku.id)
const fgQuantities = await getSkuQuantities(skuIds, locationId)

// In the exportData map (around line 50-74):
const exportData: SKUExportData[] = await Promise.all(
  skus.map(async (sku) => {
    const activeBom = sku.bomVersions[0]
    let bomCost: string | null = null
    let maxBuildableUnits: number | null = null

    if (activeBom) {
      bomCost = await calculateBOMUnitCost(activeBom.id).then((c) => c?.toString() ?? null)
      maxBuildableUnits = await calculateMaxBuildableUnits(sku.id, locationId)
    }

    // ADD: Get FG balance (0 if none)
    const finishedGoodsOnHand = fgQuantities.get(sku.id) ?? 0

    return {
      id: sku.id,
      name: sku.name,
      internalCode: sku.internalCode,
      salesChannel: sku.salesChannel,
      notes: sku.notes,
      isActive: sku.isActive,
      bomCost,
      maxBuildableUnits,
      finishedGoodsOnHand,  // ADD this field
      createdAt: sku.createdAt.toISOString(),
      updatedAt: sku.updatedAt.toISOString(),
    }
  })
)
```

**Completion Criteria**:
- [ ] SKU IDs extracted after query
- [ ] `getSkuQuantities(skuIds, locationId)` called to fetch FG balances
- [ ] `finishedGoodsOnHand` field added to each export record
- [ ] SKUs without FG balance export as 0 (via `?? 0` fallback)
- [ ] locationId parameter passed to respect location-specific FG filtering

---

## Phase 3: Validation

### Subtask 3.1: Verify TypeScript compilation
**Instructions**:
1. Run `npx tsc --noEmit`
2. Verify no TypeScript errors

**Validation Commands**:
```bash
cd /home/pbrown/SkuInventory && npx tsc --noEmit
```

**Completion Criteria**:
- [ ] TypeScript compilation passes with no errors

### Subtask 3.2: Verify build
**Instructions**:
1. Run `npm run build`
2. Verify build completes successfully

**Validation Commands**:
```bash
cd /home/pbrown/SkuInventory && npm run build
```

**Completion Criteria**:
- [ ] Build completes with no errors
- [ ] No warnings related to export functionality

### Subtask 3.3: Verify lint
**Instructions**:
1. Run `npm run lint`
2. Verify no lint errors

**Validation Commands**:
```bash
cd /home/pbrown/SkuInventory && npm run lint
```

**Completion Criteria**:
- [ ] Lint passes with no errors

---

## Summary of Deliverables
**Files Created**: 0
**Files Modified**: 2
- `/home/pbrown/SkuInventory/src/services/export.ts` - Add field to interface, add column to array
- `/home/pbrown/SkuInventory/src/app/api/export/skus/route.ts` - Add import, fetch FG balances, add to export data

---

## Handoff to Build Agent
1. Execute subtasks in exact order (1.1 -> 1.2 -> 2.1 -> 2.2 -> 3.1 -> 3.2 -> 3.3)
2. Phase 1 updates export service types/columns
3. Phase 2 updates API route to fetch and include FG data
4. Phase 3 validates all changes
5. Follow reference patterns exactly - use `getSkuQuantities` batch function for efficiency

---

## Test Strategy Note
- Manual E2E test: Export SKUs from UI, verify CSV contains "Finished Goods On Hand" column
- Verify SKUs with FG inventory show correct quantities
- Verify SKUs without FG inventory show 0
- Test with locationId parameter if applicable

---

## Acceptance Criteria Checklist
- [ ] SKU export CSV includes "Finished Goods On Hand" column
- [ ] SKUs without FG balance rows export as 0
- [ ] Column appears after "Max Buildable Units" column
- [ ] Export functionality works end-to-end
- [ ] `npm run build` passes
- [ ] `npx tsc --noEmit` passes

---

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 5m |
| Validation | 2m |
| Planning | 8m |
| **Total** | **15m** |
