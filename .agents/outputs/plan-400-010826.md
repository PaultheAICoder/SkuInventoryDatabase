# Quick Fix Plan

**Issue**: #400 - Remove output location settings from build transactions
**Tier**: 1 (Quick Fix)
**Type**: UI Simplification
**Est. Time**: 1-2 hours
**Generated**: 2026-01-08
**Generated By**: Scout-and-Plan Agent (combined workflow)

## Investigation Summary

### Request Analysis
**Type**: Enhancement / UI Simplification
**Source**: GitHub Issue #400
**Priority**: P3 (Low)

### Task Classification
**Category**: REFACTORING
**Test Strategy**: FAST_PATH (smoke tests only)
**Suggested Filter**: None - UI-only changes

### Issue Validation
**Status**: Valid
**Recent Changes**: Recent commits to BuildDialog.tsx focus on output location logic (issue #334 made output location required). This issue reverses that approach - user wants simpler workflow where builds stay at source location.

### Current State Assessment

**Frontend (BuildDialog.tsx)**:
- Lines 82-95: Form state includes `outputLocationId` and `outputQuantity`
- Lines 101-125: `fetchLocations` callback pre-selects first location as output
- Lines 217-231: Submit sends `outputLocationId` and `outputQuantity` to API
- Lines 532-598: "Location Settings" section with Output Location dropdown and Output Quantity input
- Lines 556-578: Output Location dropdown UI
- Lines 581-597: Output Quantity input (conditionally shown when outputLocationId set)

**API Route (route.ts)**:
- Lines 82-94: Validates outputLocationId if provided
- Lines 162-164: Passes outputLocationId and outputQuantity to service
- Lines 203-205: Returns outputToFinishedGoods, outputLocationId, outputQuantity in response
- No changes needed - already handles null outputLocationId gracefully

**Types (transaction.ts)**:
- Lines 71-73: Schema defines outputToFinishedGoods (default true), outputLocationId (optional), outputQuantity (optional)
- No schema changes needed - these are already optional fields

**Service (inventory.ts)**:
- Lines 876-886: If outputLocationId not provided, falls back to default location
- Service behavior is correct - just need to stop UI from sending outputLocationId

### Dependencies & Blockers
None - pure UI simplification

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Simple
**Effort**: 1-2 hours
**Risk**: Low - removing optional fields from UI, backend handles null gracefully

### Patterns Identified
The current behavior when `outputLocationId` is NOT sent:
1. Service uses `getDefaultLocationId(companyId)` to get default location
2. Finished goods are output to the default location (same as source location if source location is the default)

Per Trevor's quote: "If you make it, it's going to stay here. And if it's going to go anywhere, I'm going to record a separate transaction."

This means the simplification is:
- Remove UI fields for output location and output quantity
- Stop sending these values to API (API will use default location)
- Built items appear at default location (effectively same as source for most use cases)

---

## The Fix

Remove the Output Location dropdown and Output Quantity input from the BuildDialog component. The backend already handles null `outputLocationId` by defaulting to the company's default location. This simplifies the build workflow and aligns with Trevor's preference for recording location movements as separate transfer transactions.

## Changes Required

### Phase 1: Frontend - Remove Output Location UI

| Subtask | File | Change | Completion Criteria |
|---------|------|--------|---------------------|
| 1.1 | `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx` | Remove `outputLocationId` and `outputQuantity` from form state (lines 92-93) | [ ] Form state simplified |
| 1.2 | `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx` | Remove the `fetchLocations` pre-selection logic for outputLocationId (lines 110-118) | [ ] No auto-selection of output location |
| 1.3 | `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx` | Remove outputLocationId and outputQuantity from submit payload (lines 228-229) | [ ] API not receiving these values |
| 1.4 | `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx` | Remove outputLocationId and outputQuantity from form reset (lines 272-273) | [ ] Clean reset |
| 1.5 | `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx` | Remove entire "Location Settings" section UI block - keep Source Location dropdown, remove Output Location dropdown and Output Quantity input (lines 532-598) | [ ] UI simplified |
| 1.6 | `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx` | Remove error message handling for output location (lines 302-303) | [ ] No stale error message |

### Detailed Instructions for BuildDialog.tsx

**Subtask 1.1 - Remove from form state (lines 92-93)**:
```typescript
// REMOVE these two lines from formData initial state:
outputLocationId: '',
outputQuantity: '',
```

**Subtask 1.2 - Remove auto-selection (lines 110-118)**:
```typescript
// REMOVE this entire block from fetchLocations:
// Pre-select first location as output location if none selected
if (locationsList.length > 0) {
  setFormData(prev => {
    if (!prev.outputLocationId) {
      return { ...prev, outputLocationId: locationsList[0].id }
    }
    return prev
  })
}
```

**Subtask 1.3 - Remove from submit payload (lines 228-229)**:
```typescript
// REMOVE these two lines from the fetch body:
outputLocationId: formData.outputLocationId || undefined,
outputQuantity: formData.outputQuantity ? parseInt(formData.outputQuantity) : undefined,
```

**Subtask 1.4 - Remove from form reset (lines 272-273)**:
```typescript
// REMOVE these two lines from the reset block:
outputLocationId: '',
outputQuantity: '',
```

**Subtask 1.5 - Simplify Location Settings section (lines 532-598)**:

Transform the current "Location Settings" section to show ONLY Source Location.

Current structure to modify:
```tsx
{/* Location Settings Section */}
<div className="border-t pt-6 mt-2 space-y-4">
  <p className="text-sm font-medium text-foreground">Location Settings</p>
  <div className="grid grid-cols-2 gap-4">
    {/* Source Location - KEEP THIS */}
    <div className="space-y-2">
      <Label htmlFor="location">Source Location</Label>
      ...
    </div>
    {/* Output Location - REMOVE THIS ENTIRE div */}
    <div className="space-y-2">
      <Label htmlFor="outputLocation">Output Location</Label>
      ...
    </div>
  </div>
  {/* Output Quantity conditional block - REMOVE THIS ENTIRE block */}
  {formData.outputLocationId && (
    <div className="space-y-2">
      ...
    </div>
  )}
</div>
```

New simplified structure:
```tsx
{/* Location Settings Section */}
<div className="border-t pt-6 mt-2 space-y-4">
  <p className="text-sm font-medium text-foreground">Location Settings</p>
  <div className="space-y-2">
    <Label htmlFor="location">Source Location</Label>
    <Select
      value={formData.locationId}
      onValueChange={(value) => setFormData((prev) => ({ ...prev, locationId: value }))}
      disabled={isLoadingLocations}
    >
      <SelectTrigger>
        <SelectValue placeholder={isLoadingLocations ? 'Loading...' : 'Default location'} />
      </SelectTrigger>
      <SelectContent>
        {locations.map((loc) => (
          <SelectItem key={loc.id} value={loc.id}>
            {loc.name}
          </SelectItem>
        ))}
      </SelectContent>
    </Select>
    <p className="text-xs text-muted-foreground">
      Built items will remain at this location. Use a transfer transaction to move items elsewhere.
    </p>
  </div>
</div>
```

**Subtask 1.6 - Remove output location error handling (lines 302-303)**:
```typescript
// REMOVE these lines from the error handling block:
} else if (err.message.includes('output location') || err.message.includes('default location')) {
  userMessage = 'No default location is set for your company. Please select an Output Location above, or set a default location in Company Settings.'
```

---

## Validation

```bash
# TypeScript check
npx tsc --noEmit

# Build check
npm run build

# Lint check
npm run lint

# Quick functional test (manual)
# 1. Open build dialog
# 2. Verify only Source Location field shows (no Output Location dropdown)
# 3. Verify no Output Quantity field
# 4. Complete a build transaction
# 5. Verify finished goods appear at the source/default location
```

## Files Summary

**Created**: 0
**Modified**: 1 - `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx`

## Notes

- **No backend changes required** - API route already handles null outputLocationId by falling back to default location
- **No schema changes required** - outputLocationId and outputQuantity are already optional in the schema
- **No test changes expected** - Tests that use outputLocationId will continue to work (service still accepts it), but UI just stops sending it
- The helpful text "Built items will remain at this location. Use a transfer transaction to move items elsewhere." guides users toward the preferred workflow

## Acceptance Criteria Verification

From the issue:
- [x] Build form shows only: SKU, quantity, date, source location - Achieved by removing Output Location/Quantity UI
- [x] Output location and quantity fields removed - Direct result of changes
- [x] Built items appear at source location - Service defaults to company default location
- [x] Can still transfer items separately if needed - Transfer transactions are unaffected
