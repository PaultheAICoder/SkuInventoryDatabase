# Implementation Plan: Add Recent Transactions Section to SKU Detail

**Generated**: 2025-12-02T14:30:00Z
**Task ID**: Issue #22
**Estimated Build Time**: 2-3 hours
**Complexity**: Low

## Executive Summary

Add a "Recent Transactions" section to the SKU detail page (`/skus/[id]`) displaying the last 10 build/shipment transactions for the SKU. This enhancement follows the exact pattern already implemented on the component detail page (lines 302-344). The database relationship `SKU.transactions` already exists in Prisma schema (line 190), making this a straightforward additive change requiring modifications to 3 files: type definition, API route, and UI page.

## Schema Verification (Completed)

**Verified via schema inspection**:
- `SKU.transactions` relation exists at `/home/pbrown/SkuInventory/prisma/schema.prisma:190`
- Transaction model has `skuId` field at line 134 (optional, references SKU)
- Transaction fields: `id`, `type`, `date`, `skuId`, `unitsBuild`, `createdAt`
- No database migration required - relationship already exists

**Naming confirmed**:
- `skuId` (not `sku_id`) - Prisma uses camelCase
- `createdAt`, `unitsBuild` - consistent with existing codebase

## Ripple Effect Verification (Completed)

**API Route `/api/skus/[id]` callers verified**:
```bash
grep -r "/api/skus/" src/ --include="*.tsx" --include="*.ts" | grep -v "route.ts" | wc -l
# Result: 6 files reference this endpoint
```

**Files that consume SKUDetailResponse**:
1. `/home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/page.tsx` - WILL USE new field (primary target)
2. `/home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/edit/page.tsx` - NO CHANGE (doesn't use recentTransactions)
3. `/home/pbrown/SkuInventory/src/components/features/BOMVersionForm.tsx` - NO CHANGE
4. `/home/pbrown/SkuInventory/src/components/features/SKUForm.tsx` - NO CHANGE
5. `/home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/bom/new/page.tsx` - NO CHANGE

**Backward Compatibility**: YES - Adding optional field to response, existing consumers unaffected.

---

## Phase 1: Backend Types

### Subtask 1.1: Update SKUDetailResponse Type

**File**: `/home/pbrown/SkuInventory/src/types/sku.ts`
**Line Range**: 62-65
**Pattern Reference**: `/home/pbrown/SkuInventory/src/types/component.ts:78-84`

**Current Code** (lines 62-65):
```typescript
// SKU detail response (includes related data)
export interface SKUDetailResponse extends SKUResponse {
  bomVersions: BOMVersionSummary[]
}
```

**Instructions**:
1. Add `recentTransactions` array property to `SKUDetailResponse` interface
2. Use same type structure as `ComponentDetailResponse.recentTransactions`

**Target Code**:
```typescript
// SKU detail response (includes related data)
export interface SKUDetailResponse extends SKUResponse {
  bomVersions: BOMVersionSummary[]
  recentTransactions: Array<{
    id: string
    type: string
    date: string
    unitsBuild: number | null
    createdAt: string
  }>
}
```

**Note**: For SKU transactions, we use `unitsBuild` instead of `quantityChange` since SKU transactions are primarily build transactions that track units built, not component-level quantity changes.

**Validation Commands**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] `recentTransactions` property added to `SKUDetailResponse` interface
- [ ] Type structure matches the specification above
- [ ] TypeScript compilation succeeds with no errors

---

## Phase 2: Backend API

### Subtask 2.1: Modify GET /api/skus/[id] Route

**File**: `/home/pbrown/SkuInventory/src/app/api/skus/[id]/route.ts`
**Line Range**: 29-41 (Prisma query), 59-89 (response mapping)
**Pattern Reference**: `/home/pbrown/SkuInventory/src/app/api/components/[id]/route.ts:49-62`

**Current Prisma Query** (lines 29-41):
```typescript
const sku = await prisma.sKU.findUnique({
  where: { id },
  include: {
    createdBy: { select: { id: true, name: true } },
    updatedBy: { select: { id: true, name: true } },
    bomVersions: {
      orderBy: { createdAt: 'desc' },
      include: {
        lines: true,
        createdBy: { select: { id: true, name: true } },
      },
    },
  },
})
```

**Instructions**:

1. **Add transactions include to Prisma query** (after line 40, inside the include block):

```typescript
const sku = await prisma.sKU.findUnique({
  where: { id },
  include: {
    createdBy: { select: { id: true, name: true } },
    updatedBy: { select: { id: true, name: true } },
    bomVersions: {
      orderBy: { createdAt: 'desc' },
      include: {
        lines: true,
        createdBy: { select: { id: true, name: true } },
      },
    },
    transactions: {
      take: 10,
      orderBy: { createdAt: 'desc' },
      select: {
        id: true,
        type: true,
        date: true,
        unitsBuild: true,
        createdAt: true,
      },
    },
  },
})
```

2. **Add recentTransactions to response object** (after line 88, before the closing brace of success):

**Current Response** ends at line 88:
```typescript
      createdAt: v.createdAt.toISOString(),
    })),
  })
```

**Add before closing `})`**:
```typescript
      recentTransactions: sku.transactions.map((tx) => ({
        id: tx.id,
        type: tx.type,
        date: tx.date.toISOString(),
        unitsBuild: tx.unitsBuild,
        createdAt: tx.createdAt.toISOString(),
      })),
```

**Complete Target Response** (lines 59-91):
```typescript
return success({
  id: sku.id,
  name: sku.name,
  internalCode: sku.internalCode,
  salesChannel: sku.salesChannel,
  externalIds: sku.externalIds as Record<string, string>,
  notes: sku.notes,
  isActive: sku.isActive,
  createdAt: sku.createdAt.toISOString(),
  updatedAt: sku.updatedAt.toISOString(),
  createdBy: sku.createdBy,
  updatedBy: sku.updatedBy,
  activeBom: activeBom
    ? {
        id: activeBom.id,
        versionName: activeBom.versionName,
        unitCost: activeBomCost?.toFixed(4) ?? '0.0000',
      }
    : null,
  maxBuildableUnits,
  bomVersions: sku.bomVersions.map((v) => ({
    id: v.id,
    versionName: v.versionName,
    effectiveStartDate: v.effectiveStartDate.toISOString().split('T')[0],
    effectiveEndDate: v.effectiveEndDate?.toISOString().split('T')[0] ?? null,
    isActive: v.isActive,
    unitCost: (bomCosts.get(v.id) ?? 0).toFixed(4),
    lineCount: v.lines.length,
    createdAt: v.createdAt.toISOString(),
  })),
  recentTransactions: sku.transactions.map((tx) => ({
    id: tx.id,
    type: tx.type,
    date: tx.date.toISOString(),
    unitsBuild: tx.unitsBuild,
    createdAt: tx.createdAt.toISOString(),
  })),
})
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Prisma query includes `transactions` with `take: 10`, `orderBy: { createdAt: 'desc' }`
- [ ] Response object includes `recentTransactions` array
- [ ] Each transaction includes: id, type, date, unitsBuild, createdAt
- [ ] TypeScript compilation succeeds
- [ ] Build completes without errors

---

## Phase 3: Frontend UI

### Subtask 3.1: Add Recent Transactions Card to SKU Detail Page

**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/page.tsx`
**Line Range**: Multiple locations (imports, JSX)
**Pattern Reference**: `/home/pbrown/SkuInventory/src/app/(dashboard)/components/[id]/page.tsx:302-344`

**Instructions**:

**Step 1: Add missing imports** (around line 8)

**Current imports**:
```typescript
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
```

**Add to Card import**:
```typescript
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
```

**Add Table imports** (after line 12 or after existing imports from @/components/ui):
```typescript
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
```

**Step 2: Add Recent Transactions Card section** (after line 209, before the Build Dialog comment)

**Current code** (lines 208-212):
```tsx
        </div>
      </div>

      {/* Build Dialog */}
      {skuId && (
```

**Insert between `</div>` (line 210) and `{/* Build Dialog */}` (line 212)**:

```tsx
      {/* Recent Transactions */}
      {sku.recentTransactions && sku.recentTransactions.length > 0 && (
        <Card>
          <CardHeader>
            <CardTitle>Recent Transactions</CardTitle>
            <CardDescription>Last 10 build transactions for this SKU</CardDescription>
          </CardHeader>
          <CardContent>
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>Date</TableHead>
                  <TableHead>Type</TableHead>
                  <TableHead className="text-right">Units Built</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {sku.recentTransactions.map((tx) => (
                  <TableRow key={tx.id}>
                    <TableCell>{new Date(tx.date).toLocaleDateString()}</TableCell>
                    <TableCell>
                      <Badge variant="outline" className="capitalize">
                        {tx.type}
                      </Badge>
                    </TableCell>
                    <TableCell className="text-right font-mono text-green-600">
                      {tx.unitsBuild !== null ? `+${tx.unitsBuild.toLocaleString()}` : '-'}
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
            <div className="mt-4">
              <Link href={`/transactions?skuId=${sku.id}`}>
                <Button variant="outline" size="sm">
                  View All Transactions
                </Button>
              </Link>
            </div>
          </CardContent>
        </Card>
      )}
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
npm run lint
```

**Completion Criteria**:
- [ ] `CardDescription` added to Card imports
- [ ] Table component imports added
- [ ] Recent Transactions Card section added after BOM versions grid
- [ ] Card displays: Date, Type (badge), Units Built columns
- [ ] "View All Transactions" link navigates to `/transactions?skuId={id}`
- [ ] Section only renders when `recentTransactions.length > 0`
- [ ] TypeScript compilation succeeds
- [ ] Build completes without errors
- [ ] Lint passes without warnings

---

## Phase 4: Verification

### Subtask 4.1: Full Build and Lint Check

**Instructions**:
1. Run full TypeScript type check
2. Run production build
3. Run linter

**Commands**:
```bash
npx tsc --noEmit
npm run build
npm run lint
```

**Completion Criteria**:
- [ ] `npx tsc --noEmit` exits with code 0
- [ ] `npm run build` exits with code 0
- [ ] `npm run lint` exits with code 0
- [ ] No warnings in any output

### Subtask 4.2: Manual Testing

**Instructions**:
1. Start development server
2. Navigate to a SKU detail page that has build transactions
3. Verify "Recent Transactions" card appears
4. Verify table shows up to 10 transactions with Date, Type, Units Built
5. Click "View All Transactions" and verify navigation to `/transactions?skuId={id}`
6. Test with SKU that has no transactions - verify card does not appear

**Test Commands**:
```bash
npm run dev
# Navigate to https://172.16.20.50:4543/skus/{id} in browser
```

**Completion Criteria**:
- [ ] Recent Transactions card displays correctly on SKU detail page
- [ ] Transactions are sorted by date (newest first)
- [ ] "View All Transactions" link works correctly
- [ ] Card hidden when no transactions exist

---

## Summary of Deliverables

**Files Modified**: 3

| File | Change Type | Lines Changed |
|------|-------------|---------------|
| `/home/pbrown/SkuInventory/src/types/sku.ts` | Interface extension | ~8 lines added |
| `/home/pbrown/SkuInventory/src/app/api/skus/[id]/route.ts` | Query + response | ~20 lines added |
| `/home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/page.tsx` | Imports + UI section | ~50 lines added |

**Files Created**: 0

**Database Changes**: None (relationship already exists)

---

## Handoff to Build Agent

1. Execute subtasks in exact order: 1.1 -> 2.1 -> 3.1 -> 4.1 -> 4.2
2. After each subtask, run the validation commands before proceeding
3. Follow the pattern references exactly - do not deviate
4. If any validation fails, fix issues before continuing to next subtask
5. The component detail page (`/home/pbrown/SkuInventory/src/app/(dashboard)/components/[id]/page.tsx` lines 302-344) is the authoritative pattern reference

**Key Differences from Component Pattern**:
- SKU uses `unitsBuild` (integer) instead of `quantityChange` (Decimal from transaction lines)
- SKU has direct `transactions` relation, Component uses `transactionLines` join table
- Card description says "build transactions" since SKU transactions are primarily builds

---

## Performance Metrics

| Phase | Duration |
|-------|----------|
| Scout Review | 5m |
| Pattern Research | 8m |
| Schema Verification | 3m |
| Ripple Effect Verification | 4m |
| Plan Writing | 15m |
| **Total** | **35m** |
