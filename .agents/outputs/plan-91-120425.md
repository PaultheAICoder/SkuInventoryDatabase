# Implementation Plan
**Generated**: 2025-12-04T09:00:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: Issue #91 - Expiry enforcement and warnings
**Estimated Build Time**: 8-10 hours
**Complexity**: Medium

---

## Investigation Summary

### Request Analysis
**Type**: Feature
**Source**: GitHub Issue #91 (Parent #12)
**Priority**: Medium

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: None

### Issue Validation
**Status**: Valid
**Recent Changes**: Lot management features recently implemented (lot-selection.ts, lot.ts)

### Current State Assessment

**Existing Components:**
- `src/services/lot.ts` - Has `calculateExpiryStatus()` with hardcoded 30-day "expiring_soon" logic
- `src/services/lot-selection.ts` - FEFO algorithm, NO expiry filtering currently
- `src/services/inventory.ts` - Build transaction with FEFO, NO expiry checks
- `src/types/settings.ts` - Company settings schema (needs expiry fields added)
- `src/types/lot.ts` - Has `ExpiryStatus` type: `'ok' | 'expiring_soon' | 'expired'`

**Database:**
- `Lot` model has `expiryDate` field (Date, nullable)
- `LotBalance` model tracks current quantity
- `Company.settings` JSON field stores configurable settings

**API Routes:**
- `src/app/api/lots/route.ts` - Lists lots with expiry status
- `src/app/api/settings/route.ts` - GET/PATCH company settings

**UI Components:**
- Dashboard at `src/app/(dashboard)/page.tsx` - Can add expiry warnings
- Component detail at `src/app/(dashboard)/components/[id]/page.tsx` - Can show lot expiry info
- `src/components/features/InsufficientInventoryWarning.tsx` - Pattern for warning banners
- `src/components/features/SettingsForm.tsx` - Pattern for settings UI

### Dependencies & Blockers
1. No blockers - all dependencies exist
2. FEFO algorithm in `lot-selection.ts` needs modification
3. Build transaction in `inventory.ts` needs expiry checks

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Medium
**Effort**: 8-10 hours
**Risk**: Low (well-defined patterns exist)

### Patterns Identified

**Primary**:
- `src/types/settings.ts` - Settings schema pattern with Zod and defaults
- `src/services/lot.ts:10-21` - `calculateExpiryStatus()` logic
- `src/services/lot-selection.ts:31-69` - `getAvailableLotsForComponent()` FEFO query

**Secondary**:
- `src/components/features/InsufficientInventoryWarning.tsx` - Warning banner pattern
- `src/components/features/DefectAlertsList.tsx` - Alert list with severity badges
- `src/components/features/CriticalComponentsList.tsx` - Dashboard warning card pattern
- `src/components/features/BuildDialog.tsx:269-309` - Override warning pattern in dialog

### Ripple Effect Analysis
**Files Identified**: 12

**Direct Changes:**
- `src/types/settings.ts` - Add expiry settings
- `src/services/expiry.ts` - NEW: Expiry checking service
- `src/services/lot-selection.ts` - Add expiry filtering to FEFO
- `src/services/inventory.ts` - Add expiry checks to build
- `src/app/api/lots/expiring/route.ts` - NEW: Expiring lots API
- `src/components/features/ExpiryWarningBanner.tsx` - NEW: Dashboard banner
- `src/components/features/SettingsForm.tsx` - Add expiry settings UI
- `src/app/(dashboard)/page.tsx` - Add expiry banner
- `src/app/(dashboard)/components/[id]/page.tsx` - Show lot expiry warnings

**Indirect Effects:**
- `src/app/api/transactions/build/route.ts` - May need override handling
- `src/components/features/BuildDialog.tsx` - Add expired lot override option
- `src/app/api/dashboard/route.ts` - Add expiring lots data

---

## Executive Summary

Implement configurable expiry enforcement that prevents use of expired lots during build transactions (with override option) and provides proactive dashboard warnings for lots approaching expiration. This involves:
1. Adding expiry settings to company configuration
2. Creating an expiry service with checking/warning logic
3. Modifying FEFO algorithm to exclude expired lots by default
4. Adding dashboard and component-level expiry warnings
5. Providing override capability in build dialog

---

## Phase 0: Settings Schema Update

### Subtask 0.1: Add Expiry Settings to Settings Schema
**File**: `/home/pbrown/SkuInventory/src/types/settings.ts`
**Pattern**: Follow existing settings pattern (lines 4-19)
**Instructions**:
1. Add expiry-related fields to `companySettingsSchema`:
   ```typescript
   // After line 17 (enableDefectAlerts), add:

   // Expiry enforcement settings
   expiryEnforcementEnabled: z.boolean().default(false),
   expiryWarningDays: z.coerce.number().int().nonnegative().default(30),
   allowExpiredOverride: z.boolean().default(true),
   ```
2. Add corresponding defaults to `DEFAULT_SETTINGS`:
   ```typescript
   // After enableDefectAlerts: true, add:
   expiryEnforcementEnabled: false,
   expiryWarningDays: 30,
   allowExpiredOverride: true,
   ```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Schema compiles without errors
- [ ] `CompanySettings` type includes new fields
- [ ] DEFAULT_SETTINGS has all new fields

---

## Phase 1: Expiry Service

### Subtask 1.1: Create Expiry Service
**File**: `/home/pbrown/SkuInventory/src/services/expiry.ts` (NEW)
**Pattern**: Follow `src/services/lot.ts` pattern
**Instructions**:
1. Create new service file with functions:

```typescript
import { prisma } from '@/lib/db'
import type { ExpiryStatus } from '@/types/lot'

/**
 * Check if a lot is expired based on expiry date
 * Returns true if expiryDate is in the past (or today)
 */
export function isLotExpired(expiryDate: Date | null): boolean {
  if (!expiryDate) return false

  const today = new Date()
  today.setHours(0, 0, 0, 0)

  return expiryDate < today
}

/**
 * Check if a lot is expiring soon based on expiry date and warning days
 */
export function isLotExpiringSoon(expiryDate: Date | null, warningDays: number): boolean {
  if (!expiryDate) return false

  const today = new Date()
  today.setHours(0, 0, 0, 0)

  const warningDate = new Date(today.getTime() + warningDays * 24 * 60 * 60 * 1000)

  return expiryDate <= warningDate && expiryDate >= today
}

/**
 * Calculate expiry status with configurable warning days
 */
export function calculateExpiryStatusWithConfig(
  expiryDate: Date | null,
  warningDays: number
): ExpiryStatus {
  if (!expiryDate) return 'ok'
  if (isLotExpired(expiryDate)) return 'expired'
  if (isLotExpiringSoon(expiryDate, warningDays)) return 'expiring_soon'
  return 'ok'
}

/**
 * Get lots expiring within specified days for a company
 * Returns lots with positive balance that expire within the warning period
 */
export async function getExpiringLots(
  companyId: string,
  warningDays: number
): Promise<Array<{
  id: string
  lotNumber: string
  componentId: string
  componentName: string
  componentSkuCode: string
  expiryDate: Date
  balance: number
  daysUntilExpiry: number
}>> {
  const today = new Date()
  today.setHours(0, 0, 0, 0)

  const warningDate = new Date(today.getTime() + warningDays * 24 * 60 * 60 * 1000)

  const lots = await prisma.lot.findMany({
    where: {
      component: {
        companyId,
      },
      expiryDate: {
        gte: today,
        lte: warningDate,
      },
      balance: {
        quantity: { gt: 0 },
      },
    },
    include: {
      component: {
        select: { id: true, name: true, skuCode: true },
      },
      balance: {
        select: { quantity: true },
      },
    },
    orderBy: {
      expiryDate: 'asc',
    },
  })

  return lots.map((lot) => ({
    id: lot.id,
    lotNumber: lot.lotNumber,
    componentId: lot.componentId,
    componentName: lot.component.name,
    componentSkuCode: lot.component.skuCode,
    expiryDate: lot.expiryDate!,
    balance: lot.balance?.quantity.toNumber() ?? 0,
    daysUntilExpiry: Math.ceil(
      (lot.expiryDate!.getTime() - today.getTime()) / (24 * 60 * 60 * 1000)
    ),
  }))
}

/**
 * Get count of expired lots with positive balance for a company
 */
export async function getExpiredLotCount(companyId: string): Promise<number> {
  const today = new Date()
  today.setHours(0, 0, 0, 0)

  return prisma.lot.count({
    where: {
      component: {
        companyId,
      },
      expiryDate: {
        lt: today,
      },
      balance: {
        quantity: { gt: 0 },
      },
    },
  })
}
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] All functions compile without errors
- [ ] Functions handle null expiryDate correctly
- [ ] Date comparisons use start of day for consistency

---

## Phase 2: FEFO Algorithm Update

### Subtask 2.1: Update Lot Selection Service
**File**: `/home/pbrown/SkuInventory/src/services/lot-selection.ts`
**Pattern**: Extend existing FEFO logic
**Instructions**:
1. Add import at top:
   ```typescript
   import { isLotExpired } from './expiry'
   ```

2. Add new parameter type after `LotAvailabilityResult` interface (around line 26):
   ```typescript
   /**
    * Options for lot selection
    */
   export interface LotSelectionOptions {
     excludeExpired?: boolean  // Default: true when enforcement enabled
     allowExpiredOverride?: boolean  // Allow selecting expired lots with explicit override
   }
   ```

3. Modify `getAvailableLotsForComponent` function (starting line 31) to add optional expiry filtering:
   ```typescript
   export async function getAvailableLotsForComponent(
     componentId: string,
     options?: LotSelectionOptions
   ): Promise<Array<{
     lotId: string
     lotNumber: string
     availableQuantity: number
     expiryDate: Date | null
     isExpired: boolean
   }>> {
     const { excludeExpired = false } = options ?? {}

     // Query Lot joined with LotBalance, only lots with positive balance
     const lots = await prisma.lot.findMany({
       where: {
         componentId,
         balance: {
           quantity: { gt: 0 },
         },
       },
       include: {
         balance: true,
       },
       orderBy: [
         { expiryDate: 'asc' }, // FEFO: earliest expiry first
         { createdAt: 'asc' }, // Tie-breaker: oldest lot first
       ],
     })

     // Sort nulls to end (Prisma puts nulls first by default in asc)
     const sortedLots = lots.sort((a, b) => {
       if (a.expiryDate === null && b.expiryDate === null) return 0
       if (a.expiryDate === null) return 1 // nulls to end
       if (b.expiryDate === null) return -1
       return a.expiryDate.getTime() - b.expiryDate.getTime()
     })

     // Map and optionally filter expired lots
     const result = sortedLots.map((lot) => ({
       lotId: lot.id,
       lotNumber: lot.lotNumber,
       availableQuantity: lot.balance?.quantity.toNumber() ?? 0,
       expiryDate: lot.expiryDate,
       isExpired: isLotExpired(lot.expiryDate),
     }))

     if (excludeExpired) {
       return result.filter((lot) => !lot.isExpired)
     }

     return result
   }
   ```

4. Update `selectLotsForConsumption` function to accept options parameter:
   - Add `options?: LotSelectionOptions` parameter
   - Pass options to `getAvailableLotsForComponent`

5. Update `checkLotAvailabilityForBuild` function to accept and pass options

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Existing FEFO behavior unchanged when excludeExpired=false
- [ ] Expired lots filtered when excludeExpired=true
- [ ] All existing callers still work without changes

---

## Phase 3: Build Transaction Integration

### Subtask 3.1: Add Expiry Checking to Build Transaction
**File**: `/home/pbrown/SkuInventory/src/services/inventory.ts`
**Pattern**: Follow existing `checkInsufficientInventory` pattern
**Instructions**:
1. Add import at top:
   ```typescript
   import { isLotExpired } from './expiry'
   ```

2. Add new result type after `InsufficientInventoryItem` interface (around line 614):
   ```typescript
   /**
    * Result type for expired lot check
    */
   export interface ExpiredLotItem {
     componentId: string
     componentName: string
     skuCode: string
     lotId: string
     lotNumber: string
     expiryDate: string
     quantity: number
   }
   ```

3. Add new function to check for expired lots in a build:
   ```typescript
   /**
    * Check if build would use expired lots
    * Returns list of expired lots that would be consumed, or empty array if none
    */
   export async function checkExpiredLotsForBuild(params: {
     bomVersionId: string
     unitsToBuild: number
   }): Promise<ExpiredLotItem[]> {
     const { bomVersionId, unitsToBuild } = params

     // Get BOM lines with components
     const bomLines = await prisma.bOMLine.findMany({
       where: { bomVersionId },
       include: {
         component: {
           select: {
             id: true,
             name: true,
             skuCode: true,
           },
         },
       },
     })

     const expiredLots: ExpiredLotItem[] = []

     for (const line of bomLines) {
       const requiredQty = line.quantityPerUnit.toNumber() * unitsToBuild

       // Get lots for this component using FEFO (including expired)
       const lots = await prisma.lot.findMany({
         where: {
           componentId: line.componentId,
           balance: { quantity: { gt: 0 } },
         },
         include: { balance: true },
         orderBy: [{ expiryDate: 'asc' }, { createdAt: 'asc' }],
       })

       // Sort nulls to end
       const sortedLots = lots.sort((a, b) => {
         if (a.expiryDate === null && b.expiryDate === null) return 0
         if (a.expiryDate === null) return 1
         if (b.expiryDate === null) return -1
         return a.expiryDate.getTime() - b.expiryDate.getTime()
       })

       let remaining = requiredQty
       for (const lot of sortedLots) {
         if (remaining <= 0) break
         const available = lot.balance?.quantity.toNumber() ?? 0
         const toConsume = Math.min(available, remaining)

         if (toConsume > 0 && isLotExpired(lot.expiryDate)) {
           expiredLots.push({
             componentId: line.componentId,
             componentName: line.component.name,
             skuCode: line.component.skuCode,
             lotId: lot.id,
             lotNumber: lot.lotNumber,
             expiryDate: lot.expiryDate!.toISOString().split('T')[0],
             quantity: toConsume,
           })
         }
         remaining -= toConsume
       }
     }

     return expiredLots
   }
   ```

4. Update `createBuildTransaction` function params interface (around line 712) to add:
   ```typescript
   allowExpiredLots?: boolean  // Allow consuming expired lots (override enforcement)
   ```

5. In `createBuildTransaction`, inside the `prisma.$transaction` block, modify the FEFO lot selection logic (around line 857-891):
   - Add check for expired lots before consumption
   - Skip expired lots by default when expiry enforcement is enabled
   - Throw error if only expired lots available and override not set

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] `checkExpiredLotsForBuild` returns expired lots correctly
- [ ] Build transaction skips expired lots when enforcement enabled
- [ ] Build transaction allows expired lots when override set
- [ ] Error thrown when insufficient non-expired lots and no override

---

### Subtask 3.2: Update Build API Route
**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/build/route.ts`
**Pattern**: Follow `checkInsufficientInventory` pattern
**Instructions**:
1. Add import:
   ```typescript
   import { checkExpiredLotsForBuild } from '@/services/inventory'
   ```

2. Update API to check expiry enforcement from settings:
   ```typescript
   // After getting settings (line 91), add:
   const enforceExpiry = settings.expiryEnforcementEnabled
   const allowExpiredOverride = settings.allowExpiredOverride
   ```

3. Add expired lot check before build (before `try` block at line 97):
   ```typescript
   // Check for expired lots if enforcement is enabled
   if (enforceExpiry && !data.allowExpiredLots) {
     const expiredLots = await checkExpiredLotsForBuild({
       bomVersionId: selectedBomVersionId,
       unitsToBuild: data.unitsToBuild,
     })

     if (expiredLots.length > 0 && !allowExpiredOverride) {
       return NextResponse.json(
         {
           error: 'Build would use expired lots and override is not allowed',
           expiredLots,
         },
         { status: 400 }
       )
     }

     if (expiredLots.length > 0) {
       return NextResponse.json(
         {
           error: 'Build would use expired lots',
           expiredLots,
           canOverride: true,
         },
         { status: 400 }
       )
     }
   }
   ```

4. Pass `allowExpiredLots` to `createBuildTransaction` call

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] API checks expiry enforcement from settings
- [ ] Returns expired lots list when enforcement blocks build
- [ ] Allows override when settings permit

---

## Phase 4: Expiring Lots API

### Subtask 4.1: Create Expiring Lots API Route
**File**: `/home/pbrown/SkuInventory/src/app/api/lots/expiring/route.ts` (NEW)
**Pattern**: Follow `src/app/api/lots/route.ts`
**Instructions**:
1. Create new API route:

```typescript
import { NextRequest } from 'next/server'
import { getServerSession } from 'next-auth'
import { authOptions } from '@/lib/auth'
import { success, unauthorized, serverError } from '@/lib/api-response'
import { getExpiringLots, getExpiredLotCount } from '@/services/expiry'
import { getCompanySettings } from '@/services/inventory'

// GET /api/lots/expiring - Get lots expiring soon
export async function GET(request: NextRequest) {
  try {
    const session = await getServerSession(authOptions)
    if (!session?.user) {
      return unauthorized()
    }

    const selectedCompanyId = session.user.selectedCompanyId

    // Get warning days from settings
    const settings = await getCompanySettings(selectedCompanyId)
    const warningDays = settings.expiryWarningDays ?? 30

    // Get expiring and expired lot counts
    const [expiringLots, expiredCount] = await Promise.all([
      getExpiringLots(selectedCompanyId, warningDays),
      getExpiredLotCount(selectedCompanyId),
    ])

    return success({
      expiringLots: expiringLots.map((lot) => ({
        id: lot.id,
        lotNumber: lot.lotNumber,
        componentId: lot.componentId,
        componentName: lot.componentName,
        componentSkuCode: lot.componentSkuCode,
        expiryDate: lot.expiryDate.toISOString().split('T')[0],
        balance: lot.balance,
        daysUntilExpiry: lot.daysUntilExpiry,
      })),
      expiringCount: expiringLots.length,
      expiredCount,
      warningDays,
    })
  } catch (error) {
    console.error('Error fetching expiring lots:', error)
    return serverError()
  }
}
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] API returns expiring lots with days until expiry
- [ ] Uses company settings for warning days
- [ ] Includes expired lot count

---

## Phase 5: UI Components

### Subtask 5.1: Create Expiry Warning Banner Component
**File**: `/home/pbrown/SkuInventory/src/components/features/ExpiryWarningBanner.tsx` (NEW)
**Pattern**: Follow `InsufficientInventoryWarning.tsx` and `CriticalComponentsList.tsx`
**Instructions**:
1. Create new component:

```typescript
'use client'

import Link from 'next/link'
import { AlertTriangle, Clock } from 'lucide-react'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'

interface ExpiringLot {
  id: string
  lotNumber: string
  componentId: string
  componentName: string
  componentSkuCode: string
  expiryDate: string
  balance: number
  daysUntilExpiry: number
}

interface ExpiryWarningBannerProps {
  expiringLots: ExpiringLot[]
  expiringCount: number
  expiredCount: number
  warningDays: number
  compact?: boolean
}

export function ExpiryWarningBanner({
  expiringLots,
  expiringCount,
  expiredCount,
  warningDays,
  compact = false,
}: ExpiryWarningBannerProps) {
  const hasWarnings = expiringCount > 0 || expiredCount > 0

  if (!hasWarnings) return null

  if (compact) {
    return (
      <div className="rounded-md bg-orange-50 border border-orange-200 p-3">
        <div className="flex items-start gap-2">
          <Clock className="h-5 w-5 text-orange-600 flex-shrink-0 mt-0.5" />
          <div>
            <p className="font-medium text-orange-800">
              Lot Expiry Warnings
            </p>
            <p className="text-sm text-orange-700 mt-1">
              {expiredCount > 0 && (
                <span className="font-medium text-red-600">
                  {expiredCount} expired lot{expiredCount !== 1 ? 's' : ''}
                </span>
              )}
              {expiredCount > 0 && expiringCount > 0 && ', '}
              {expiringCount > 0 && (
                <span>
                  {expiringCount} lot{expiringCount !== 1 ? 's' : ''} expiring within {warningDays} days
                </span>
              )}
            </p>
            <Link href="/lots?status=expiring_soon" className="text-sm text-orange-600 hover:underline mt-1 inline-block">
              View lots
            </Link>
          </div>
        </div>
      </div>
    )
  }

  return (
    <Card className="border-orange-200 bg-orange-50/50">
      <CardHeader>
        <CardTitle className="flex items-center gap-2 text-orange-800">
          <Clock className="h-5 w-5" />
          Lot Expiry Warnings
        </CardTitle>
        <CardDescription>
          {expiredCount > 0 && (
            <span className="text-red-600 font-medium">
              {expiredCount} expired
              {expiringCount > 0 && ', '}
            </span>
          )}
          {expiringCount > 0 && (
            <span className="text-orange-600 font-medium">
              {expiringCount} expiring soon
            </span>
          )}
          {' '}requiring attention
        </CardDescription>
      </CardHeader>
      <CardContent>
        {expiringLots.length > 0 && (
          <div className="space-y-2">
            {expiringLots.slice(0, 5).map((lot) => (
              <div key={lot.id} className="flex items-center justify-between text-sm">
                <div>
                  <Link
                    href={`/lots/${lot.id}`}
                    className="font-medium hover:underline"
                  >
                    {lot.lotNumber}
                  </Link>
                  <span className="text-muted-foreground ml-2">
                    ({lot.componentName})
                  </span>
                </div>
                <div className="flex items-center gap-2">
                  <span className="font-mono" suppressHydrationWarning>
                    {lot.balance.toLocaleString()} units
                  </span>
                  <span className={`text-sm ${lot.daysUntilExpiry <= 7 ? 'text-red-600 font-medium' : 'text-orange-600'}`}>
                    {lot.daysUntilExpiry} days
                  </span>
                </div>
              </div>
            ))}
            {expiringLots.length > 5 && (
              <p className="text-sm text-muted-foreground">
                +{expiringLots.length - 5} more lots
              </p>
            )}
          </div>
        )}
        <div className="mt-4 flex gap-2">
          {expiredCount > 0 && (
            <Link href="/lots?status=expired">
              <Button variant="outline" size="sm" className="text-red-600 border-red-200">
                View {expiredCount} Expired
              </Button>
            </Link>
          )}
          <Link href="/lots?status=expiring_soon">
            <Button variant="outline" size="sm">
              View All Expiring
            </Button>
          </Link>
        </div>
      </CardContent>
    </Card>
  )
}
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Component renders expiring and expired lot warnings
- [ ] Compact mode for inline display
- [ ] Links to filtered lots page

---

### Subtask 5.2: Add Expiry Settings to SettingsForm
**File**: `/home/pbrown/SkuInventory/src/components/features/SettingsForm.tsx`
**Pattern**: Follow existing Quality Alerts section (lines 210-288)
**Instructions**:
1. Add new Card section after Quality Alerts (before the Save button, around line 290):

```typescript
{/* Expiry Enforcement Settings */}
<Card>
  <CardHeader>
    <CardTitle>Lot Expiry Enforcement</CardTitle>
    <CardDescription>Configure expiry date enforcement for lot consumption</CardDescription>
  </CardHeader>
  <CardContent className="space-y-4">
    <div className="flex items-center space-x-2">
      <input
        id="expiryEnforcementEnabled"
        type="checkbox"
        className="h-4 w-4 rounded border-gray-300"
        checked={formData.expiryEnforcementEnabled}
        onChange={(e) =>
          setFormData((prev) => ({ ...prev, expiryEnforcementEnabled: e.target.checked }))
        }
      />
      <div>
        <Label htmlFor="expiryEnforcementEnabled" className="font-normal">
          Enable Expiry Enforcement
        </Label>
        <p className="text-xs text-muted-foreground">
          Prevent use of expired lots in build transactions
        </p>
      </div>
    </div>

    <div className="flex items-center space-x-2">
      <input
        id="allowExpiredOverride"
        type="checkbox"
        className="h-4 w-4 rounded border-gray-300"
        checked={formData.allowExpiredOverride}
        onChange={(e) =>
          setFormData((prev) => ({ ...prev, allowExpiredOverride: e.target.checked }))
        }
        disabled={!formData.expiryEnforcementEnabled}
      />
      <div>
        <Label htmlFor="allowExpiredOverride" className="font-normal">
          Allow Override
        </Label>
        <p className="text-xs text-muted-foreground">
          Allow users to override and use expired lots with confirmation
        </p>
      </div>
    </div>

    <div className="space-y-2 max-w-xs">
      <Label htmlFor="expiryWarningDays">Warning Period (days)</Label>
      <Input
        id="expiryWarningDays"
        type="number"
        min="1"
        max="365"
        value={formData.expiryWarningDays}
        onChange={(e) =>
          setFormData((prev) => ({
            ...prev,
            expiryWarningDays: parseInt(e.target.value) || 30,
          }))
        }
      />
      <p className="text-xs text-muted-foreground">
        Show warnings for lots expiring within this many days
      </p>
    </div>
  </CardContent>
</Card>
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Settings UI displays expiry configuration
- [ ] Override toggle disabled when enforcement disabled
- [ ] Warning days input validates properly

---

### Subtask 5.3: Add Expiry Warnings to Dashboard
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/page.tsx`
**Pattern**: Follow existing dashboard widget pattern
**Instructions**:
1. Add import at top:
   ```typescript
   import { ExpiryWarningBanner } from '@/components/features/ExpiryWarningBanner'
   ```

2. Add state for expiry data (after existing state declarations, around line 61):
   ```typescript
   const [expiryData, setExpiryData] = useState<{
     expiringLots: Array<{
       id: string
       lotNumber: string
       componentId: string
       componentName: string
       componentSkuCode: string
       expiryDate: string
       balance: number
       daysUntilExpiry: number
     }>
     expiringCount: number
     expiredCount: number
     warningDays: number
   } | null>(null)
   ```

3. Add fetch for expiry data in the useEffect (around line 75, after dashboard fetch):
   ```typescript
   // Fetch expiry data
   try {
     const expiryRes = await fetch('/api/lots/expiring')
     if (expiryRes.ok) {
       const expiryResult = await expiryRes.json()
       setExpiryData(expiryResult.data)
     }
   } catch {
     // Silently fail - expiry warning is non-critical
   }
   ```

4. Add ExpiryWarningBanner after DashboardStats (around line 127):
   ```typescript
   {expiryData && (expiryData.expiringCount > 0 || expiryData.expiredCount > 0) && (
     <ExpiryWarningBanner
       expiringLots={expiryData.expiringLots}
       expiringCount={expiryData.expiringCount}
       expiredCount={expiryData.expiredCount}
       warningDays={expiryData.warningDays}
     />
   )}
   ```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Dashboard fetches expiry data
- [ ] Banner displays when lots are expiring/expired
- [ ] Non-blocking if API fails

---

### Subtask 5.4: Update Build Dialog with Expired Lot Override
**File**: `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx`
**Pattern**: Follow existing insufficient inventory warning pattern (lines 269-309)
**Instructions**:
1. Add state for expired lots (after insufficientItems state, around line 63):
   ```typescript
   const [expiredLots, setExpiredLots] = useState<Array<{
     componentId: string
     componentName: string
     lotNumber: string
     expiryDate: string
     quantity: number
   }>>([])
   const [showExpiredWarning, setShowExpiredWarning] = useState(false)
   const [canOverrideExpired, setCanOverrideExpired] = useState(false)
   ```

2. Add formData field for override (in formData state, around line 77):
   ```typescript
   allowExpiredLots: false,
   ```

3. In handleSubmit, handle expired lot response (around line 206):
   ```typescript
   // Handle expired lots error
   if (data?.expiredLots && data.expiredLots.length > 0) {
     setExpiredLots(data.expiredLots)
     setShowExpiredWarning(true)
     setCanOverrideExpired(data.canOverride === true)
     return
   }
   ```

4. Add expired lots warning UI after insufficient inventory warning (around line 309):
   ```typescript
   {showExpiredWarning && expiredLots.length > 0 && (
     <div className="rounded-md bg-orange-50 border border-orange-200 p-3">
       <div className="flex items-start gap-2">
         <AlertTriangle className="h-5 w-5 text-orange-600 mt-0.5" />
         <div>
           <p className="font-medium text-orange-800">Expired Lots Would Be Used</p>
           <p className="text-sm text-orange-700 mt-1">
             This build would consume inventory from expired lots:
           </p>
           <ul className="mt-2 text-sm text-orange-700 space-y-1">
             {expiredLots.map((lot, idx) => (
               <li key={idx} suppressHydrationWarning>
                 <span className="font-medium">{lot.lotNumber}</span>{' '}
                 ({lot.componentName}): {lot.quantity.toLocaleString()} units, expired {lot.expiryDate}
               </li>
             ))}
           </ul>
           <div className="mt-3 flex gap-2">
             <Button
               type="button"
               size="sm"
               variant="outline"
               onClick={() => {
                 setShowExpiredWarning(false)
                 setExpiredLots([])
               }}
             >
               Cancel
             </Button>
             {canOverrideExpired && (
               <Button
                 type="button"
                 size="sm"
                 variant="destructive"
                 onClick={(e) => {
                   setFormData((prev) => ({ ...prev, allowExpiredLots: true }))
                   setShowExpiredWarning(false)
                   handleSubmit(e, true)
                 }}
                 disabled={isLoading}
               >
                 {isLoading ? 'Building...' : 'Use Expired Lots'}
               </Button>
             )}
           </div>
           {!canOverrideExpired && (
             <p className="mt-2 text-sm text-red-600">
               Override is not allowed. Contact an admin to enable expired lot override.
             </p>
           )}
         </div>
       </div>
     </div>
   )}
   ```

5. Include `allowExpiredLots` in request body (around line 186):
   ```typescript
   allowExpiredLots: forceSubmit ? formData.allowExpiredLots : false,
   ```

6. Reset expired lot state on success (around line 238):
   ```typescript
   setExpiredLots([])
   setShowExpiredWarning(false)
   setCanOverrideExpired(false)
   ```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Dialog shows expired lot warning when API returns error
- [ ] Override button shown only when allowed
- [ ] Clear message when override not allowed
- [ ] State reset on cancel and success

---

### Subtask 5.5: Add Types for Build Transaction Schema
**File**: `/home/pbrown/SkuInventory/src/types/transaction.ts`
**Pattern**: Follow existing schema patterns
**Instructions**:
1. Find `createBuildSchema` and add new field:
   ```typescript
   allowExpiredLots: z.boolean().optional(),
   ```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Schema includes allowExpiredLots field
- [ ] Type inference works correctly

---

## Phase 6: Component Detail Page Update

### Subtask 6.1: Add Lot Expiry Warnings to Component Detail
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/components/[id]/page.tsx`
**Pattern**: Follow existing Cards pattern
**Instructions**:
1. Add import at top:
   ```typescript
   import { Clock, AlertTriangle } from 'lucide-react'
   ```

2. Update `ComponentDetailResponse` type or add local interface for lot expiry data
3. Add a "Lot Expiry Status" card after the Details card (around line 236):
   ```typescript
   {/* Lot Expiry Status - only show if component has lots with expiry dates */}
   {component.lotExpiryInfo && component.lotExpiryInfo.hasExpiringLots && (
     <Card className="border-orange-200 bg-orange-50/50">
       <CardHeader>
         <CardTitle className="flex items-center gap-2 text-orange-800">
           <Clock className="h-5 w-5" />
           Lot Expiry Warnings
         </CardTitle>
       </CardHeader>
       <CardContent>
         <div className="space-y-2">
           {component.lotExpiryInfo.expiredCount > 0 && (
             <p className="text-red-600 font-medium">
               {component.lotExpiryInfo.expiredCount} expired lot{component.lotExpiryInfo.expiredCount !== 1 ? 's' : ''} with inventory
             </p>
           )}
           {component.lotExpiryInfo.expiringCount > 0 && (
             <p className="text-orange-600">
               {component.lotExpiryInfo.expiringCount} lot{component.lotExpiryInfo.expiringCount !== 1 ? 's' : ''} expiring within {component.lotExpiryInfo.warningDays} days
             </p>
           )}
         </div>
       </CardContent>
     </Card>
   )}
   ```

Note: This requires updating the component API to return lot expiry info. Consider deferring if time-constrained.

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Component page shows expiry warnings when applicable
- [ ] Expired lots highlighted in red
- [ ] Expiring lots shown in orange

---

## Summary of Deliverables

**Files Created**: 3
- `src/services/expiry.ts` - Expiry checking logic
- `src/app/api/lots/expiring/route.ts` - API for expiring lots
- `src/components/features/ExpiryWarningBanner.tsx` - Dashboard banner

**Files Modified**: 8
- `src/types/settings.ts` - Add expiry settings to schema
- `src/types/transaction.ts` - Add allowExpiredLots to build schema
- `src/services/lot-selection.ts` - Add expiry filtering to FEFO
- `src/services/inventory.ts` - Add expiry checks to build
- `src/app/api/transactions/build/route.ts` - Add expiry validation
- `src/components/features/SettingsForm.tsx` - Add expiry settings UI
- `src/components/features/BuildDialog.tsx` - Add expired lot override
- `src/app/(dashboard)/page.tsx` - Add expiry banner to dashboard

**Optional/Deferred**:
- `src/app/(dashboard)/components/[id]/page.tsx` - Component detail expiry display
- `src/app/api/components/[id]/route.ts` - Add lot expiry info to response

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 0 through Phase 6)
2. Complete each subtask's completion criteria before proceeding
3. Test validation commands after each subtask
4. Phase 5.4 (BuildDialog) depends on Phase 3.2 (Build API) for error response format
5. Use existing patterns exactly as referenced

---

## Test Strategy Note

- Manual testing recommended for UI components
- Focus on:
  1. Settings toggle enabling/disabling enforcement
  2. Build blocking when expired lots would be used
  3. Override flow when allowed
  4. Dashboard banner appearing with expiring lots

---

## Performance Metrics

| Phase | Duration |
|-------|----------|
| Investigation | 25m |
| Validation | 10m |
| Planning | 30m |
| **Total** | **65m** |

---

AGENT_RETURN: plan-91-120425
