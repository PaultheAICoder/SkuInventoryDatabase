# Implementation Plan
**Generated**: 2025-12-17T16:00:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #287
**Estimated Build Time**: 2-3 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Bug (Security - Authorization/tenant scoping)
**Source**: GitHub Issue #287
**Priority**: Critical (data exposure vulnerability)

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED
**Suggested Filter**: `--testPathPattern="drafts"`

### Issue Validation
**Status**: Valid - confirmed by code review
**Recent Changes**:
- Issue #286 (just fixed) - same vulnerability pattern in forecast endpoints

### Current State Assessment

**The Bug**: Draft transactions API routes use `session.user.selectedCompanyId` directly without validating that it is present. If `selectedCompanyId` is `undefined` or `null` (due to stale session, tampered token, or edge case), Prisma queries run without a company filter, potentially exposing draft transactions from all companies.

**Affected Files (6 total)**:
1. `/home/pbrown/SkuInventory/src/app/api/transactions/drafts/route.ts` - GET (list drafts) and POST (create draft) endpoints
2. `/home/pbrown/SkuInventory/src/app/api/transactions/drafts/[id]/route.ts` - GET, PUT, DELETE single draft
3. `/home/pbrown/SkuInventory/src/app/api/transactions/drafts/[id]/approve/route.ts` - POST approve draft
4. `/home/pbrown/SkuInventory/src/app/api/transactions/drafts/[id]/reject/route.ts` - POST reject draft
5. `/home/pbrown/SkuInventory/src/app/api/transactions/drafts/count/route.ts` - GET draft count
6. `/home/pbrown/SkuInventory/src/app/api/transactions/drafts/batch-approve/route.ts` - POST batch approve

**How the bug manifests**:
```typescript
// Current code (drafts/route.ts lines 26-36):
const selectedCompanyId = session.user.selectedCompanyId
// No validation! Passes undefined to service...

const result = await getDraftTransactions({
  companyId: selectedCompanyId,  // If undefined, Prisma query has no company filter
  ...
})
```

**Service layer analysis** (`/home/pbrown/SkuInventory/src/services/draft-transaction.ts`):
- Line 205-209: `getDraftTransactions` builds a where clause with `companyId` - if undefined, no filter is applied
- Line 237: `getDraftTransaction` same issue
- Line 255-261: `getDraftCount` same issue
- Line 323-346: `deleteDraftTransaction` same issue
- Line 356-520: `approveDraftTransaction` same issue
- Line 529-562: `rejectDraftTransaction` same issue
- Line 571-600: `batchApproveDrafts` same issue

The service functions assume `companyId` is provided. When it is `undefined`, Prisma includes it in the where clause but it matches nothing OR all records depending on how Prisma handles undefined in where clauses.

### Dependencies & Blockers
None - all required utilities exist. Same pattern as issue #286 fix.

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Simple
**Effort**: 2-3 hours
**Risk**: Low (straightforward validation pattern exists in codebase, exact same fix as #286)

### Patterns Identified
**Primary Reference**: `/home/pbrown/SkuInventory/src/app/api/forecasts/route.ts` (lines 50-53) - just fixed in issue #286
```typescript
const selectedCompanyId = session.user.selectedCompanyId
if (!selectedCompanyId) {
  return error('No company selected. Please select a company from the sidebar.', 400)
}
```

**Secondary Reference**: `/home/pbrown/SkuInventory/src/app/api/skus/[id]/route.ts` (lines 36-39)
```typescript
const selectedCompanyId = session.user.selectedCompanyId
if (!selectedCompanyId) {
  return error('No company selected. Please select a company from the sidebar.', 400)
}
```

**Preferred Pattern**: Use the `error()` helper from `@/lib/api-response` for consistency.

### Ripple Effect Analysis
**Files Identified**: 6 API route files + 1 new test file

| File | Modification Type | Handlers Affected |
|------|-------------------|-------------------|
| `src/app/api/transactions/drafts/route.ts` | Add selectedCompanyId validation | GET, POST |
| `src/app/api/transactions/drafts/[id]/route.ts` | Add selectedCompanyId validation | GET, PUT, DELETE |
| `src/app/api/transactions/drafts/[id]/approve/route.ts` | Add selectedCompanyId validation | POST |
| `src/app/api/transactions/drafts/[id]/reject/route.ts` | Add selectedCompanyId validation | POST |
| `src/app/api/transactions/drafts/count/route.ts` | Add selectedCompanyId validation | GET |
| `src/app/api/transactions/drafts/batch-approve/route.ts` | Add selectedCompanyId validation | POST |
| `tests/integration/drafts.test.ts` | Create new test file with regression tests | N/A |

---

## Executive Summary

This is a critical security bug where draft transactions API endpoints accept requests without validating that `selectedCompanyId` is present in the session. The fix adds validation checks to 6 API route files (10 handler functions total) following the exact pattern used in the recent issue #286 fix for forecast endpoints. Returns 400 error when `selectedCompanyId` is missing. Includes a new test file with regression tests to prevent future occurrences.

---

## Phase 1: API Route Fixes

### Subtask 1.1: Add selectedCompanyId Validation to GET/POST /api/transactions/drafts
**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/drafts/route.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/app/api/forecasts/route.ts` lines 50-53

**Instructions**:
1. Import `error` from `@/lib/api-response` (add to existing import on line 4):
   Change: `import { parseQuery, unauthorized, forbidden, serverError, validationError } from '@/lib/api-response'`
   To: `import { parseQuery, unauthorized, forbidden, serverError, validationError, error } from '@/lib/api-response'`

2. In GET handler, after line 26 (`const selectedCompanyId = session.user.selectedCompanyId`), add validation check:
```typescript
if (!selectedCompanyId) {
  return error('No company selected. Please select a company from the sidebar.', 400)
}
```

3. In POST handler, after line 77 (`const selectedCompanyId = session.user.selectedCompanyId`), add validation check:
```typescript
if (!selectedCompanyId) {
  return error('No company selected. Please select a company from the sidebar.', 400)
}
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] `error` helper imported
- [ ] GET handler validates selectedCompanyId (after line 26)
- [ ] POST handler validates selectedCompanyId (after line 77)
- [ ] Returns 400 error with appropriate message when missing
- [ ] TypeScript compiles without errors
- [ ] Build succeeds

### Subtask 1.2: Add selectedCompanyId Validation to GET/PUT/DELETE /api/transactions/drafts/[id]
**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/drafts/[id]/route.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/app/api/forecasts/route.ts` lines 50-53

**Instructions**:
1. Import `error` from `@/lib/api-response` (add to existing import on line 4):
   Change: `import { unauthorized, forbidden, notFound, serverError } from '@/lib/api-response'`
   To: `import { unauthorized, forbidden, notFound, serverError, error } from '@/lib/api-response'`

2. In GET handler, after line 31 (`const selectedCompanyId = session.user.selectedCompanyId`), add validation check:
```typescript
if (!selectedCompanyId) {
  return error('No company selected. Please select a company from the sidebar.', 400)
}
```

3. In PUT handler, after line 70 (`const selectedCompanyId = session.user.selectedCompanyId`), add validation check:
```typescript
if (!selectedCompanyId) {
  return error('No company selected. Please select a company from the sidebar.', 400)
}
```

4. In DELETE handler, after line 122 (`const selectedCompanyId = session.user.selectedCompanyId`), add validation check:
```typescript
if (!selectedCompanyId) {
  return error('No company selected. Please select a company from the sidebar.', 400)
}
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] `error` helper imported
- [ ] GET handler validates selectedCompanyId (after line 31)
- [ ] PUT handler validates selectedCompanyId (after line 70)
- [ ] DELETE handler validates selectedCompanyId (after line 122)
- [ ] Returns 400 error with appropriate message when missing
- [ ] TypeScript compiles without errors
- [ ] Build succeeds

### Subtask 1.3: Add selectedCompanyId Validation to POST /api/transactions/drafts/[id]/approve
**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/drafts/[id]/approve/route.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/app/api/forecasts/route.ts` lines 50-53

**Instructions**:
1. Import `error` from `@/lib/api-response` (add to existing import on line 4):
   Change: `import { unauthorized, forbidden, serverError } from '@/lib/api-response'`
   To: `import { unauthorized, forbidden, serverError, error } from '@/lib/api-response'`

2. In POST handler, after line 31 (`const selectedCompanyId = session.user.selectedCompanyId`), add validation check:
```typescript
if (!selectedCompanyId) {
  return error('No company selected. Please select a company from the sidebar.', 400)
}
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] `error` helper imported
- [ ] POST handler validates selectedCompanyId (after line 31)
- [ ] Returns 400 error with appropriate message when missing
- [ ] TypeScript compiles without errors
- [ ] Build succeeds

### Subtask 1.4: Add selectedCompanyId Validation to POST /api/transactions/drafts/[id]/reject
**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/drafts/[id]/reject/route.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/app/api/forecasts/route.ts` lines 50-53

**Instructions**:
1. Import `error` from `@/lib/api-response` (add to existing import on line 4):
   Change: `import { unauthorized, forbidden, serverError } from '@/lib/api-response'`
   To: `import { unauthorized, forbidden, serverError, error } from '@/lib/api-response'`

2. In POST handler, after line 29 (`const selectedCompanyId = session.user.selectedCompanyId`), add validation check:
```typescript
if (!selectedCompanyId) {
  return error('No company selected. Please select a company from the sidebar.', 400)
}
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] `error` helper imported
- [ ] POST handler validates selectedCompanyId (after line 29)
- [ ] Returns 400 error with appropriate message when missing
- [ ] TypeScript compiles without errors
- [ ] Build succeeds

### Subtask 1.5: Add selectedCompanyId Validation to GET /api/transactions/drafts/count
**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/drafts/count/route.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/app/api/forecasts/route.ts` lines 50-53

**Instructions**:
1. Import `error` from `@/lib/api-response` (add to existing import on line 4):
   Change: `import { unauthorized, serverError } from '@/lib/api-response'`
   To: `import { unauthorized, serverError, error } from '@/lib/api-response'`

2. In GET handler, after line 22 (`const selectedCompanyId = session.user.selectedCompanyId`), add validation check:
```typescript
if (!selectedCompanyId) {
  return error('No company selected. Please select a company from the sidebar.', 400)
}
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] `error` helper imported
- [ ] GET handler validates selectedCompanyId (after line 22)
- [ ] Returns 400 error with appropriate message when missing
- [ ] TypeScript compiles without errors
- [ ] Build succeeds

### Subtask 1.6: Add selectedCompanyId Validation to POST /api/transactions/drafts/batch-approve
**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/drafts/batch-approve/route.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/app/api/forecasts/route.ts` lines 50-53

**Instructions**:
1. Import `error` from `@/lib/api-response` (add to existing import on line 4):
   Change: `import { unauthorized, forbidden, serverError, validationError } from '@/lib/api-response'`
   To: `import { unauthorized, forbidden, serverError, validationError, error } from '@/lib/api-response'`

2. In POST handler, after line 32 (`const selectedCompanyId = session.user.selectedCompanyId`), add validation check:
```typescript
if (!selectedCompanyId) {
  return error('No company selected. Please select a company from the sidebar.', 400)
}
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] `error` helper imported
- [ ] POST handler validates selectedCompanyId (after line 32)
- [ ] Returns 400 error with appropriate message when missing
- [ ] TypeScript compiles without errors
- [ ] Build succeeds

---

## Phase 2: Regression Tests

### Subtask 2.1: Create New Integration Test File for Drafts API
**File**: `/home/pbrown/SkuInventory/tests/integration/drafts.test.ts` (NEW FILE)
**Pattern**: Follow `/home/pbrown/SkuInventory/tests/integration/forecasts.test.ts`

**Instructions**:
Create a new test file with the following content:

```typescript
/**
 * Integration tests for Draft Transactions API
 * Tests GET/POST /api/transactions/drafts and related endpoints
 * Focus on selectedCompanyId validation (issue #287)
 */
import { describe, it, expect, beforeAll, beforeEach, afterAll } from 'vitest'
import {
  setTestSession,
  clearTestSession,
  TEST_SESSIONS,
  initializeTestSessions,
  type TestUserSession,
} from '../helpers/auth-mock'
import {
  getIntegrationPrisma,
  cleanupBeforeTest,
  createTestRequest,
  createTestComponentInDb,
} from '../helpers/integration-context'
import { disconnectTestDb } from '../helpers/db'

// Import route handlers directly
import { GET as getDrafts, POST as createDraft } from '@/app/api/transactions/drafts/route'
import { GET as getDraft, PUT as updateDraft, DELETE as deleteDraft } from '@/app/api/transactions/drafts/[id]/route'
import { POST as approveDraft } from '@/app/api/transactions/drafts/[id]/approve/route'
import { POST as rejectDraft } from '@/app/api/transactions/drafts/[id]/reject/route'
import { GET as getDraftCount } from '@/app/api/transactions/drafts/count/route'
import { POST as batchApproveDrafts } from '@/app/api/transactions/drafts/batch-approve/route'

/**
 * Create a test session with missing selectedCompanyId for security testing
 */
function createSessionWithoutCompany(): TestUserSession {
  return {
    user: {
      id: TEST_SESSIONS.admin!.user.id,
      email: TEST_SESSIONS.admin!.user.email,
      name: TEST_SESSIONS.admin!.user.name,
      role: TEST_SESSIONS.admin!.user.role,
      companyId: TEST_SESSIONS.admin!.user.companyId,
      companyName: TEST_SESSIONS.admin!.user.companyName,
      selectedCompanyId: undefined as unknown as string, // Simulate missing company
    },
  }
}

describe('Draft Transactions API - selectedCompanyId Validation (Issue #287)', () => {
  beforeAll(async () => {
    const prisma = getIntegrationPrisma()
    await initializeTestSessions(prisma)
  })

  beforeEach(async () => {
    await cleanupBeforeTest()
    clearTestSession()
  })

  afterAll(async () => {
    await disconnectTestDb()
  })

  describe('GET /api/transactions/drafts', () => {
    it('returns 400 when selectedCompanyId is missing', async () => {
      setTestSession(createSessionWithoutCompany())

      const response = await getDrafts(createTestRequest('/api/transactions/drafts'))

      expect(response.status).toBe(400)
      const json = await response.json()
      expect(json.message).toContain('No company selected')
    })

    it('returns 401 for unauthenticated request', async () => {
      clearTestSession()

      const response = await getDrafts(createTestRequest('/api/transactions/drafts'))

      expect(response.status).toBe(401)
    })

    it('returns paginated drafts for authenticated user with company', async () => {
      setTestSession(TEST_SESSIONS.admin!)

      const response = await getDrafts(createTestRequest('/api/transactions/drafts'))
      const json = await response.json()

      expect(response.status).toBe(200)
      expect(json.data).toBeDefined()
      expect(Array.isArray(json.data)).toBe(true)
      expect(json.pagination).toBeDefined()
    })
  })

  describe('POST /api/transactions/drafts', () => {
    it('returns 400 when selectedCompanyId is missing', async () => {
      setTestSession(createSessionWithoutCompany())
      const component = await createTestComponentInDb(TEST_SESSIONS.admin!.user.companyId)

      const request = new Request('http://localhost/api/transactions/drafts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          type: 'receipt',
          date: new Date().toISOString().split('T')[0],
          componentId: component.id,
          quantity: 100,
          supplier: 'Test Supplier',
        }),
      })

      const response = await createDraft(request as never)

      expect(response.status).toBe(400)
      const json = await response.json()
      expect(json.message).toContain('No company selected')
    })

    it('returns 401 for unauthenticated request', async () => {
      clearTestSession()

      const request = new Request('http://localhost/api/transactions/drafts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          type: 'receipt',
          date: new Date().toISOString().split('T')[0],
          quantity: 100,
        }),
      })

      const response = await createDraft(request as never)

      expect(response.status).toBe(401)
    })
  })

  describe('GET /api/transactions/drafts/[id]', () => {
    it('returns 400 when selectedCompanyId is missing', async () => {
      setTestSession(createSessionWithoutCompany())

      const request = createTestRequest('/api/transactions/drafts/fake-id')
      const params = { params: Promise.resolve({ id: 'fake-id' }) }

      const response = await getDraft(request, params)

      expect(response.status).toBe(400)
      const json = await response.json()
      expect(json.message).toContain('No company selected')
    })
  })

  describe('PUT /api/transactions/drafts/[id]', () => {
    it('returns 400 when selectedCompanyId is missing', async () => {
      setTestSession(createSessionWithoutCompany())

      const request = new Request('http://localhost/api/transactions/drafts/fake-id', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ notes: 'Updated notes' }),
      })
      const params = { params: Promise.resolve({ id: 'fake-id' }) }

      const response = await updateDraft(request as never, params)

      expect(response.status).toBe(400)
      const json = await response.json()
      expect(json.message).toContain('No company selected')
    })
  })

  describe('DELETE /api/transactions/drafts/[id]', () => {
    it('returns 400 when selectedCompanyId is missing', async () => {
      setTestSession(createSessionWithoutCompany())

      const request = createTestRequest('/api/transactions/drafts/fake-id')
      const params = { params: Promise.resolve({ id: 'fake-id' }) }

      const response = await deleteDraft(request, params)

      expect(response.status).toBe(400)
      const json = await response.json()
      expect(json.message).toContain('No company selected')
    })
  })

  describe('POST /api/transactions/drafts/[id]/approve', () => {
    it('returns 400 when selectedCompanyId is missing', async () => {
      setTestSession(createSessionWithoutCompany())

      const request = createTestRequest('/api/transactions/drafts/fake-id/approve')
      const params = { params: Promise.resolve({ id: 'fake-id' }) }

      const response = await approveDraft(request, params)

      expect(response.status).toBe(400)
      const json = await response.json()
      expect(json.message).toContain('No company selected')
    })
  })

  describe('POST /api/transactions/drafts/[id]/reject', () => {
    it('returns 400 when selectedCompanyId is missing', async () => {
      setTestSession(createSessionWithoutCompany())

      const request = new Request('http://localhost/api/transactions/drafts/fake-id/reject', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reason: 'Test rejection' }),
      })
      const params = { params: Promise.resolve({ id: 'fake-id' }) }

      const response = await rejectDraft(request as never, params)

      expect(response.status).toBe(400)
      const json = await response.json()
      expect(json.message).toContain('No company selected')
    })
  })

  describe('GET /api/transactions/drafts/count', () => {
    it('returns 400 when selectedCompanyId is missing', async () => {
      setTestSession(createSessionWithoutCompany())

      const response = await getDraftCount(createTestRequest('/api/transactions/drafts/count'))

      expect(response.status).toBe(400)
      const json = await response.json()
      expect(json.message).toContain('No company selected')
    })

    it('returns count for authenticated user with company', async () => {
      setTestSession(TEST_SESSIONS.admin!)

      const response = await getDraftCount(createTestRequest('/api/transactions/drafts/count'))
      const json = await response.json()

      expect(response.status).toBe(200)
      expect(typeof json.count).toBe('number')
    })
  })

  describe('POST /api/transactions/drafts/batch-approve', () => {
    it('returns 400 when selectedCompanyId is missing', async () => {
      setTestSession(createSessionWithoutCompany())

      const request = new Request('http://localhost/api/transactions/drafts/batch-approve', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ draftIds: ['fake-id-1', 'fake-id-2'] }),
      })

      const response = await batchApproveDrafts(request as never)

      expect(response.status).toBe(400)
      const json = await response.json()
      expect(json.message).toContain('No company selected')
    })
  })
})
```

**Validation Commands**:
```bash
npm test -- --testPathPattern="drafts"
```

**Completion Criteria**:
- [ ] New test file created at `/home/pbrown/SkuInventory/tests/integration/drafts.test.ts`
- [ ] Helper function created for sessions without selectedCompanyId
- [ ] Test for GET /api/transactions/drafts (missing company)
- [ ] Test for POST /api/transactions/drafts (missing company)
- [ ] Test for GET /api/transactions/drafts/[id] (missing company)
- [ ] Test for PUT /api/transactions/drafts/[id] (missing company)
- [ ] Test for DELETE /api/transactions/drafts/[id] (missing company)
- [ ] Test for POST /api/transactions/drafts/[id]/approve (missing company)
- [ ] Test for POST /api/transactions/drafts/[id]/reject (missing company)
- [ ] Test for GET /api/transactions/drafts/count (missing company)
- [ ] Test for POST /api/transactions/drafts/batch-approve (missing company)
- [ ] All tests pass

---

## Phase 3: Final Validation

### Subtask 3.1: Run Full Test Suite and Build Verification
**Instructions**:
1. Run TypeScript type checking:
```bash
npx tsc --noEmit
```

2. Run the build:
```bash
npm run build
```

3. Run all drafts tests:
```bash
npm test -- --testPathPattern="drafts"
```

4. Run lint check:
```bash
npm run lint
```

**Completion Criteria**:
- [ ] TypeScript compiles without errors
- [ ] Build succeeds
- [ ] All drafts tests pass (including new regression tests)
- [ ] Lint passes

---

## Summary of Deliverables

**Files Created**: 1
| File | Description |
|------|-------------|
| `tests/integration/drafts.test.ts` | New integration tests for drafts API with selectedCompanyId validation |

**Files Modified**: 6
| File | Changes |
|------|---------|
| `src/app/api/transactions/drafts/route.ts` | Add selectedCompanyId validation (GET + POST) + import error helper |
| `src/app/api/transactions/drafts/[id]/route.ts` | Add selectedCompanyId validation (GET + PUT + DELETE) + import error helper |
| `src/app/api/transactions/drafts/[id]/approve/route.ts` | Add selectedCompanyId validation + import error helper |
| `src/app/api/transactions/drafts/[id]/reject/route.ts` | Add selectedCompanyId validation + import error helper |
| `src/app/api/transactions/drafts/count/route.ts` | Add selectedCompanyId validation + import error helper |
| `src/app/api/transactions/drafts/batch-approve/route.ts` | Add selectedCompanyId validation + import error helper |

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 -> Phase 2 -> Phase 3)
2. After each file modification, run `npx tsc --noEmit` to verify types
3. Follow reference patterns exactly from `/home/pbrown/SkuInventory/src/app/api/forecasts/route.ts` (lines 50-53)
4. Use the `error()` helper consistently (not `NextResponse.json()` directly)
5. Ensure all new tests pass before marking Phase 2 complete

## Test Strategy Note
- Use Vitest for integration tests
- Run with: `npm test -- --testPathPattern="drafts"`
- Expected runtime: ~30-60 seconds for drafts test file

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 10m |
| Validation | 3m |
| Planning | 7m |
| **Total** | **20m** |

---

## Related Files Quick Reference

**Pattern Files**:
- `/home/pbrown/SkuInventory/src/app/api/forecasts/route.ts` (lines 50-53) - preferred pattern (just fixed in #286)
- `/home/pbrown/SkuInventory/src/app/api/skus/[id]/route.ts` (lines 36-39) - alternate pattern
- `/home/pbrown/SkuInventory/src/lib/api-response.ts` (lines 32-46) - error helper definition

**Service Files** (for reference, no changes needed):
- `/home/pbrown/SkuInventory/src/services/draft-transaction.ts` - service layer (queries are correctly scoped if companyId is provided)

**Test Helpers**:
- `/home/pbrown/SkuInventory/tests/helpers/auth-mock.ts` - session mocking utilities
- `/home/pbrown/SkuInventory/tests/helpers/integration-context.ts` - test utilities
- `/home/pbrown/SkuInventory/tests/helpers/db.ts` - database utilities

**Reference Test File**:
- `/home/pbrown/SkuInventory/tests/integration/forecasts.test.ts` - similar tests from issue #286

---

## Security Impact Note

This fix addresses a critical security vulnerability where an attacker with a valid session but missing/tampered `selectedCompanyId` could access draft transactions from ALL companies in the system. The fix ensures all draft endpoints validate company selection before processing requests, consistent with the multi-tenant architecture of the application.
