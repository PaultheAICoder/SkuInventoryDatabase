# Implementation Plan
**Generated**: 2025-12-16T17:00:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #279
**Estimated Build Time**: 2-3 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Bug Fix
**Source**: GitHub Issue #279
**Priority**: Medium

**Issue Title**: E2E Test Failures: sync-logs and asin-mapping APIs returning 500

**Symptom**: E2E tests for `/api/sync-logs` and `/api/asin-mapping` endpoints are returning HTTP 500 errors instead of expected 200 for authenticated admin/ops users.

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="integrations-access"` or run full E2E after fix

### Issue Validation
**Status**: Valid - Root cause identified
**Recent Changes**: Migration `20251212150826_add_ads_data_ingestion_models` was committed in `b9c811a` but never deployed

### Root Cause Analysis

**The problem is NOT in the code - it's a database schema migration gap.**

The test database (and production database) are missing the V2 ads data ingestion tables because migration `20251212150826_add_ads_data_ingestion_models` has not been applied to either environment.

**Evidence**:
1. Test database tables (28 tables) - missing: `SyncLog`, `AsinSkuMapping`, `IntegrationCredential`, `AdPortfolio`, `AdCampaign`, `AdGroup`, `KeywordMetric`, `SalesDaily`, `Notification`
2. Production database tables (28 tables) - same missing tables
3. Last applied migration in both databases: `20251209202711_add_feedback_tracking`
4. Required migration exists at: `prisma/migrations/20251212150826_add_ads_data_ingestion_models/migration.sql`

**API Error Chain**:
1. `/api/sync-logs` route queries `prisma.syncLog.count()` and `prisma.syncLog.findMany()`
2. `/api/asin-mapping` route queries `prisma.userCompany.findFirst()` (works) then `prisma.asinSkuMapping.findMany()` (fails)
3. Both fail with 500 because the tables don't exist in the database
4. Error is caught and returns generic 500 response

### Current State Assessment
- **Database Migration**: Migration file exists but not applied
- **API Routes**: Code is correct, references missing tables
- **Test Environment**: Reseeded from production backup which also lacks tables
- **Prisma Schema**: Correctly defines all required models

### Files Affected
These 17 files use the missing tables but will work once migration is applied:
1. `src/app/api/sync-logs/route.ts` - Uses `prisma.syncLog`
2. `src/app/api/asin-mapping/route.ts` - Uses `prisma.asinSkuMapping`
3. `src/app/api/csv/upload/route.ts` - Uses `prisma.syncLog`, `prisma.notification`
4. `src/services/retention.ts` - Uses `prisma.syncLog`
5. `src/services/sales-daily/calculator.ts` - Uses `prisma.salesDaily`
6. `src/app/api/sales-daily/route.ts` - Uses `prisma.salesDaily`
7. `src/services/notifications.ts` - Uses `prisma.notification`
8. `src/app/api/asin-mapping/[id]/route.ts` - Uses `prisma.asinSkuMapping`
9. `src/services/shopify/sync.ts` - Uses `prisma.syncLog`
10. `src/services/csv/parser.ts` - Uses `prisma.syncLog`
11. `src/services/amazon-ads/sync.ts` - Uses `prisma.syncLog`, `prisma.integrationCredential`
12. `src/app/api/csv/upload/[uploadId]/status/route.ts` - Uses `prisma.syncLog`
13. `src/app/api/integrations/amazon-ads/sync/route.ts` - Uses `prisma.integrationCredential`
14. `src/app/api/integrations/amazon-ads/callback/route.ts` - Uses `prisma.integrationCredential`
15. `src/app/api/integrations/amazon-ads/status/route.ts` - Uses `prisma.integrationCredential`
16. `src/app/api/integrations/amazon-ads/disconnect/route.ts` - Uses `prisma.integrationCredential`
17. `src/services/amazon-ads/client.ts` - Uses `prisma.integrationCredential`

### Dependencies & Blockers
1. **No code changes required** - Tables just need to be created via migration
2. **Migration script exists** - Just needs to be deployed

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Simple
**Effort**: 2-3 hours (mostly verification and testing)
**Risk**: Low - Migration is straightforward, additive only (no destructive changes)

### Patterns Identified
**Primary**: Prisma migration deployment process
**Secondary**: Test environment reseed workflow

### Ripple Effect Analysis
**Files Identified**: 0 (no code changes needed)
- All 17 files above will automatically work once the migration is applied
- No code modifications required

---

## Executive Summary

The E2E test failures for `/api/sync-logs` and `/api/asin-mapping` are caused by missing database tables. Migration `20251212150826_add_ads_data_ingestion_models` was committed but never deployed to either production or test databases. The fix is to run `prisma migrate deploy` on both environments. No code changes are needed.

## Phase 1: Apply Migration to Test Database

### Subtask 1.1: Verify Test Database Current State
**Instructions**:
1. Connect to test database and list applied migrations
2. Confirm the ads data ingestion migration is missing

**Validation Commands**:
```bash
# Verify test database connection
docker exec inventory-db-test psql -U inventory_test -d inventory_test -c "SELECT current_database();"

# Check last applied migration
docker exec inventory-db-test psql -U inventory_test -d inventory_test -c \
  "SELECT migration_name FROM _prisma_migrations ORDER BY finished_at DESC LIMIT 3;"

# Confirm SyncLog table doesn't exist
docker exec inventory-db-test psql -U inventory_test -d inventory_test -c \
  "SELECT COUNT(*) FROM \"SyncLog\";" 2>&1 | grep -q "does not exist" && echo "CONFIRMED: SyncLog table missing"
```

**Completion Criteria**:
- [ ] Test database connection verified
- [ ] Confirmed migration `20251212150826_add_ads_data_ingestion_models` is NOT in _prisma_migrations
- [ ] Confirmed `SyncLog` and `AsinSkuMapping` tables don't exist

### Subtask 1.2: Apply Migration to Test Database
**Instructions**:
1. Run Prisma migrate deploy targeting test database
2. Verify all 9 new tables are created

**Commands**:
```bash
# Apply migration to test database
DATABASE_URL="postgresql://inventory_test:inventory_test_2025@localhost:2346/inventory_test" npx prisma migrate deploy
```

**Validation Commands**:
```bash
# Verify new tables exist
docker exec inventory-db-test psql -U inventory_test -d inventory_test -c \
  "SELECT table_name FROM information_schema.tables WHERE table_schema='public' AND table_name IN ('SyncLog', 'AsinSkuMapping', 'IntegrationCredential', 'Notification', 'SalesDaily', 'AdPortfolio', 'AdCampaign', 'AdGroup', 'KeywordMetric') ORDER BY table_name;"

# Verify migration recorded
docker exec inventory-db-test psql -U inventory_test -d inventory_test -c \
  "SELECT migration_name FROM _prisma_migrations WHERE migration_name LIKE '%ads_data_ingestion%';"
```

**Completion Criteria**:
- [ ] `prisma migrate deploy` completes successfully
- [ ] 9 new tables created: `SyncLog`, `AsinSkuMapping`, `IntegrationCredential`, `Notification`, `SalesDaily`, `AdPortfolio`, `AdCampaign`, `AdGroup`, `KeywordMetric`
- [ ] Migration recorded in `_prisma_migrations` table

### Subtask 1.3: Rebuild Test App Container
**Instructions**:
1. After migration, the test app container should recognize the new schema
2. Rebuild container to regenerate Prisma client

**Commands**:
```bash
# Rebuild test app container with fresh Prisma client
cd /home/pbrown/SkuInventory/docker && docker compose -f docker-compose.test.yml build app-test --no-cache

# Restart test app container
cd /home/pbrown/SkuInventory/docker && docker compose -f docker-compose.test.yml up -d app-test

# Wait for container to be healthy
sleep 30
docker ps | grep inventory-app-test
```

**Completion Criteria**:
- [ ] Test app container rebuilt successfully
- [ ] Container is running and healthy

## Phase 2: Verify Fix - Run E2E Tests

### Subtask 2.1: Run Targeted E2E Tests
**Instructions**:
1. Run the specific failing tests to verify the fix
2. All 3 previously failing tests should now pass

**Commands**:
```bash
# Run targeted test
TEST_BASE_URL=http://172.16.20.50:2345 npx playwright test tests/e2e/integrations-access.spec.ts --reporter=list
```

**Expected Results**:
- `Sync logs API returns 200 for admin user` - PASS
- `Sync logs API returns 200 for ops user` - PASS
- `ASIN mapping GET returns 200 for any authenticated user` - PASS

**Completion Criteria**:
- [ ] All 3 previously failing tests now pass
- [ ] No new test failures introduced

### Subtask 2.2: Run Full E2E Suite (Verification)
**Instructions**:
1. Run complete E2E test suite to ensure no regressions
2. All tests should pass

**Commands**:
```bash
# Run full E2E suite
TEST_BASE_URL=http://172.16.20.50:2345 npx playwright test --reporter=list
```

**Completion Criteria**:
- [ ] All E2E tests pass (237/237 expected)
- [ ] No regressions from migration

## Phase 3: Apply Migration to Production Database (OPTIONAL - Requires Human Approval)

**IMPORTANT**: This phase modifies production. Only proceed with explicit approval.

### Subtask 3.1: Backup Production Database
**Instructions**:
1. Create backup before any production changes
2. Verify backup integrity

**Commands**:
```bash
./scripts/backup-production.sh
```

**Completion Criteria**:
- [ ] New backup file created in `.backups/`
- [ ] Backup file size reasonable (>90KB)

### Subtask 3.2: Apply Migration to Production Database
**Instructions**:
1. Run Prisma migrate deploy targeting production database
2. This is ADDITIVE only - creates new tables, doesn't modify existing data

**Commands**:
```bash
# Apply migration to production database
# REQUIRES: Production DATABASE_URL from .env or environment
DATABASE_URL="postgresql://postgres:${POSTGRES_PASSWORD}@localhost:4546/inventory" npx prisma migrate deploy
```

**Completion Criteria**:
- [ ] Migration applied successfully to production
- [ ] 9 new tables created
- [ ] Existing data unchanged

### Subtask 3.3: Update Production Backup
**Instructions**:
1. After successful migration, create new backup that includes the new schema
2. This ensures future test reseeds will have the V2 tables

**Commands**:
```bash
./scripts/backup-production.sh
```

**Completion Criteria**:
- [ ] New backup includes V2 ads tables
- [ ] Future test reseeds will have complete schema

---

## Summary of Deliverables
**Files Created**: 0
**Files Modified**: 0 (database schema only)
**Database Changes**:
- Test Database: 9 new tables added via migration
- Production Database: 9 new tables added via migration (Phase 3, optional)

## Handoff to Build Agent
1. Execute Phase 1 and Phase 2 in exact order
2. Phase 3 (Production) requires explicit human approval
3. No code changes needed - this is purely a migration deployment task
4. Test completion criteria before declaring success

## Test Strategy Note
- Use Playwright E2E tests to verify fix
- Primary test file: `tests/e2e/integrations-access.spec.ts`
- Target: http://172.16.20.50:2345 (test environment)

## Important Notes

1. **Why This Happened**: The migration was committed in `b9c811a` as part of the V2 ads data ingestion feature implementation, but the `prisma migrate deploy` step was never run on any environment.

2. **The reseed script** (`scripts/reseed-test-database.sh`) restores from production backup - since production also lacks these tables, test environment will always be missing them until production is migrated.

3. **Order of Operations**: Apply to test first, verify tests pass, then (with approval) apply to production. After production migration, the next test reseed will automatically include the new tables.

4. **No Risk to Existing Data**: This migration only adds new tables. It does not modify any existing tables or data.

## Performance Metrics
| Phase | Estimated Duration |
|-------|----------|
| Phase 1 (Test Migration) | 15m |
| Phase 2 (E2E Verification) | 15m |
| Phase 3 (Production - Optional) | 15m |
| **Total** | **30-45m** |
