# Implementation Plan
**Generated**: 2025-12-03T16:30:00Z
**Task ID**: Issue #17 - Add inventory snapshot import from Excel (XLSX) files
**Estimated Build Time**: 8-10 hours
**Complexity**: Medium

## Executive Summary

Add Excel (XLSX) file import capability for inventory snapshots from TonsilTech's format. This feature will parse XLSX files with "Item" and "Current Balance" columns, auto-generate SKU codes from item names, create components if they do not exist, and create initial inventory transactions. The implementation builds directly on the existing robust CSV import infrastructure established in Issue #8.

## Prerequisites

### Subtask 0.1: Install xlsx Package
**Purpose**: Add SheetJS library for XLSX parsing
**Instructions**:
1. Run: `npm install xlsx`
2. Verify installation: `npm list xlsx`
3. Note: The `xlsx` package includes TypeScript types, no separate `@types/xlsx` needed

**Validation**:
```bash
npm list xlsx
# Should show xlsx version in output
```
**Completion Criteria**:
- [ ] `xlsx` appears in package.json dependencies
- [ ] `npm install` completes without errors

---

## Phase 1: XLSX Parsing Service

### Subtask 1.1: Create XLSX Import Service
**File**: `/home/pbrown/SkuInventory/src/services/xlsx-import.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/services/import.ts` structure
**Purpose**: New service for parsing XLSX files and utility functions

**Instructions**:
1. Create new file at `/home/pbrown/SkuInventory/src/services/xlsx-import.ts`
2. Import xlsx library: `import * as XLSX from 'xlsx'`
3. Implement the following functions:

**Function 1: `parseXLSX(buffer: ArrayBuffer): string[][]`**
- Read workbook from buffer using `XLSX.read(buffer, { type: 'array' })`
- Get first sheet: `workbook.Sheets[workbook.SheetNames[0]]`
- Convert to array of arrays: `XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' })`
- Return rows array (same format as CSV `parseCSV` returns)

**Function 2: `generateSkuCode(itemName: string): string`**
- Algorithm per issue specification:
```typescript
export function generateSkuCode(itemName: string): string {
  return itemName
    .toUpperCase()
    .replace(/[^A-Z0-9\s]/g, '')  // Remove special chars
    .trim()
    .split(/\s+/)
    .map(word => word.slice(0, 4))  // First 4 chars of each word
    .join('-')
    .slice(0, 20);  // Max 20 chars
}
```
- Examples: "3pk IFU" -> "3PK-IFU", "Bubble Mailers" -> "BUBB-MAIL"

**Function 3: `extractDateFromFilename(filename: string): Date | null`**
- Match pattern `YYYY-MM-DD` at start of filename
- Return parsed Date or null if not found
```typescript
export function extractDateFromFilename(filename: string): Date | null {
  const match = filename.match(/(\d{4})-(\d{2})-(\d{2})/);
  if (match) {
    const date = new Date(match[0]);
    if (!isNaN(date.getTime())) {
      return date;
    }
  }
  return null;
}
```

**Function 4: `normalizeSnapshotHeader(header: string): string`**
- Map common variations to standard keys:
  - "item", "item name", "name", "product" -> "item"
  - "current balance", "balance", "quantity", "qty", "on hand" -> "current_balance"
- Use lowercase and remove special chars like in `normalizeHeader` from import.ts

**Type Definitions**:
```typescript
export interface InventorySnapshotRow {
  itemName: string;
  currentBalance: number;
}

export interface SnapshotParseResult {
  rows: InventorySnapshotRow[];
  dateFromFilename: Date | null;
  errors: Array<{ rowNumber: number; errors: string[] }>;
}
```

**Function 5: `parseInventorySnapshot(buffer: ArrayBuffer, filename: string): SnapshotParseResult`**
- Call `parseXLSX(buffer)`
- Call `extractDateFromFilename(filename)`
- Map headers using `normalizeSnapshotHeader`
- Validate each row: require non-empty item name and numeric current_balance >= 0
- Return structured result with valid rows and error list

**Validation**:
```bash
npx tsc --noEmit
```
**Completion Criteria**:
- [ ] File compiles without errors
- [ ] All 5 functions exported
- [ ] Types properly defined

---

## Phase 2: API Route Implementation

### Subtask 2.1: Create Inventory Snapshot API Route
**File**: `/home/pbrown/SkuInventory/src/app/api/import/inventory-snapshot/route.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/app/api/import/initial-inventory/route.ts` (lines 1-187)
**Purpose**: Handle XLSX upload, create components and initial transactions

**Instructions**:
1. Create new file at `/home/pbrown/SkuInventory/src/app/api/import/inventory-snapshot/route.ts`
2. Copy imports pattern from initial-inventory route (lines 1-11):
```typescript
import { NextRequest } from 'next/server'
import { getServerSession } from 'next-auth'
import { authOptions } from '@/lib/auth'
import { prisma } from '@/lib/db'
import { Prisma } from '@prisma/client'
import { success, unauthorized, serverError, error } from '@/lib/api-response'
import { parseInventorySnapshot, generateSkuCode } from '@/services/xlsx-import'
import { createInitialTransaction } from '@/services/inventory'
import { getCompanySettings } from '@/services/inventory'
```

3. Define result interface:
```typescript
interface InventorySnapshotImportResult {
  total: number
  componentsCreated: number
  transactionsCreated: number
  skipped: number
  errors: Array<{
    rowNumber: number
    itemName: string
    errors: string[]
  }>
}
```

4. Implement POST handler following initial-inventory pattern:
   - Check session (line 28-31)
   - Check role not viewer (line 33-36)
   - Get user's brand (lines 38-48)
   - Parse multipart form data (lines 51-68)
   - Get the file from formData
   - Get allowOverwrite parameter (for re-importing with overwrite)
   - Convert file to ArrayBuffer: `await file.arrayBuffer()`
   - Call `parseInventorySnapshot(buffer, file.name)`

5. For each valid row in parse result:
   a. Generate SKU code: `generateSkuCode(row.itemName)`
   b. Check if component exists by SKU code:
   ```typescript
   const existingComponent = await prisma.component.findFirst({
     where: { brandId, skuCode: generatedSkuCode }
   })
   ```
   c. If component does not exist, create it:
   ```typescript
   const component = await prisma.component.create({
     data: {
       brandId,
       name: row.itemName,
       skuCode: generatedSkuCode,
       unitOfMeasure: 'each',
       costPerUnit: new Prisma.Decimal(0),
       reorderPoint: 0,
       leadTimeDays: settings.defaultLeadTimeDays || 0,
       createdById: session.user.id,
       updatedById: session.user.id,
     }
   })
   ```
   d. Check for existing initial transaction (like initial-inventory route lines 126-157)
   e. If exists and allowOverwrite, delete existing transaction
   f. If exists and not allowOverwrite, skip with error
   g. Create initial transaction using `createInitialTransaction()` (lines 159-169)
   h. Track counts: componentsCreated, transactionsCreated, skipped

6. Return structured result

**Important**: Use the date from filename if available, otherwise use current date for transactions

**Validation**:
```bash
npx tsc --noEmit
npm run lint
```
**Completion Criteria**:
- [ ] Route compiles without errors
- [ ] Authentication check implemented
- [ ] Role check implemented (viewers cannot import)
- [ ] Brand scoping implemented
- [ ] Component auto-creation works
- [ ] Initial transaction creation works
- [ ] Duplicate handling (skip or overwrite) implemented

---

## Phase 3: UI Updates

### Subtask 3.1: Update ImportForm to Accept XLSX Files
**File**: `/home/pbrown/SkuInventory/src/components/features/ImportForm.tsx`
**Purpose**: Allow XLSX file uploads for inventory-snapshot type

**Instructions**:
1. Update the `ImportFormProps` interface (line 27) to add new type:
```typescript
importType: 'components' | 'skus' | 'initial-inventory' | 'inventory-snapshot'
```

2. Update file validation in `handleUpload` function (lines 92-95):
```typescript
// Before:
if (!file.name.toLowerCase().endsWith('.csv')) {
  setUploadError('Please select a CSV file')
  return
}

// After:
const isCSV = file.name.toLowerCase().endsWith('.csv')
const isXLSX = file.name.toLowerCase().endsWith('.xlsx')

if (importType === 'inventory-snapshot') {
  if (!isXLSX) {
    setUploadError('Please select an Excel (.xlsx) file')
    return
  }
} else {
  if (!isCSV) {
    setUploadError('Please select a CSV file')
    return
  }
}
```

3. Update the file input accept attribute (line 191):
```typescript
// Before:
accept=".csv"

// After: Make it conditional
accept={importType === 'inventory-snapshot' ? '.xlsx' : '.csv'}
```

4. Update the Label text (line 185):
```typescript
// Before:
<Label htmlFor={`file-${importType}`}>Upload CSV File</Label>

// After: Make it conditional
<Label htmlFor={`file-${importType}`}>
  Upload {importType === 'inventory-snapshot' ? 'Excel (.xlsx)' : 'CSV'} File
</Label>
```

5. Add allowOverwrite option for inventory-snapshot (replicate pattern from lines 203-223 for initial-inventory):
```typescript
{(importType === 'initial-inventory' || importType === 'inventory-snapshot') && (
  <div className="flex items-center space-x-2">
    {/* existing checkbox code */}
  </div>
)}
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```
**Completion Criteria**:
- [ ] ImportForm accepts new `inventory-snapshot` type
- [ ] XLSX files accepted for inventory-snapshot
- [ ] CSV files still work for other types
- [ ] Allow Overwrite checkbox shows for inventory-snapshot

### Subtask 3.2: Update ImportResultDialog for Snapshot Type
**File**: `/home/pbrown/SkuInventory/src/components/features/ImportResultDialog.tsx`
**Purpose**: Display correct labels for snapshot imports

**Instructions**:
1. Update the `ImportResultDialogProps` interface importType (line 43):
```typescript
importType: 'components' | 'skus' | 'initial-inventory' | 'inventory-snapshot'
```

2. Add case in `getTypeLabels` function (lines 70-79):
```typescript
const getTypeLabels = () => {
  switch (importType) {
    case 'components':
      return { singular: 'component', plural: 'components' }
    case 'skus':
      return { singular: 'SKU', plural: 'SKUs' }
    case 'initial-inventory':
      return { singular: 'inventory record', plural: 'inventory records' }
    case 'inventory-snapshot':
      return { singular: 'snapshot item', plural: 'snapshot items' }
  }
}
```

**Validation**:
```bash
npx tsc --noEmit
```
**Completion Criteria**:
- [ ] New type accepted
- [ ] Correct labels display

### Subtask 3.3: Add Inventory Snapshot Section to Import Page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/import/page.tsx`
**Purpose**: Expose new import type in UI

**Instructions**:
1. Add new state variable (after line 13):
```typescript
const [snapshotResult, setSnapshotResult] = useState<ImportResult | null>(null)
const [showSnapshotResult, setShowSnapshotResult] = useState(false)
```

2. Add handler function (after line 58):
```typescript
const handleSnapshotImport = (result: ImportResult) => {
  setSnapshotResult(result)
  setShowSnapshotResult(true)
}
```

3. Update page description (line 64-65):
```typescript
<p className="text-muted-foreground">
  Import components, SKUs, initial inventory from CSV files, or inventory snapshots from Excel files
</p>
```

4. Add new ImportForm in the grid (after line 97):
```typescript
<ImportForm
  importType="inventory-snapshot"
  title="Inventory Snapshot (Excel)"
  description="Import inventory snapshot from Excel file with auto-component creation and opening balances"
  onImportComplete={handleSnapshotImport}
/>
```

5. Add result dialog (after line 118):
```typescript
<ImportResultDialog
  open={showSnapshotResult}
  onClose={() => setShowSnapshotResult(false)}
  result={snapshotResult}
  importType="inventory-snapshot"
/>
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```
**Completion Criteria**:
- [ ] New import form appears on page
- [ ] Snapshot result dialog works
- [ ] No TypeScript errors

---

## Phase 4: Testing

### Subtask 4.1: Create XLSX Import Service Unit Tests
**File**: `/home/pbrown/SkuInventory/tests/services/xlsx-import.test.ts`
**Purpose**: Unit tests for SKU generation, date extraction, parsing

**Instructions**:
1. Create new test file at `/home/pbrown/SkuInventory/tests/services/xlsx-import.test.ts`
2. Import test utilities and the service functions:
```typescript
import { describe, it, expect } from 'vitest'
import {
  generateSkuCode,
  extractDateFromFilename,
  normalizeSnapshotHeader,
} from '@/services/xlsx-import'
```

3. Write test cases:

**generateSkuCode tests**:
```typescript
describe('generateSkuCode', () => {
  it('should convert item name to uppercase with dashes', () => {
    expect(generateSkuCode('3pk IFU')).toBe('3PK-IFU')
  })

  it('should truncate long words to 4 chars', () => {
    expect(generateSkuCode('Bubble Mailers')).toBe('BUBB-MAIL')
  })

  it('should remove special characters', () => {
    expect(generateSkuCode('Item (special)')).toBe('ITEM-SPEC')
  })

  it('should handle single word', () => {
    expect(generateSkuCode('Labels')).toBe('LABE')
  })

  it('should limit total length to 20 chars', () => {
    const longName = 'very long item name with many words here'
    expect(generateSkuCode(longName).length).toBeLessThanOrEqual(20)
  })

  it('should handle empty string', () => {
    expect(generateSkuCode('')).toBe('')
  })
})
```

**extractDateFromFilename tests**:
```typescript
describe('extractDateFromFilename', () => {
  it('should extract date from filename with YYYY-MM-DD prefix', () => {
    const result = extractDateFromFilename('2025-11-13_TonsilTech_Inventory.xlsx')
    expect(result).toBeInstanceOf(Date)
    expect(result?.toISOString().slice(0, 10)).toBe('2025-11-13')
  })

  it('should return null for filename without date', () => {
    expect(extractDateFromFilename('inventory.xlsx')).toBeNull()
  })

  it('should handle date in middle of filename', () => {
    const result = extractDateFromFilename('inventory_2025-11-20_final.xlsx')
    expect(result).toBeInstanceOf(Date)
  })
})
```

**normalizeSnapshotHeader tests**:
```typescript
describe('normalizeSnapshotHeader', () => {
  it('should normalize Item to item', () => {
    expect(normalizeSnapshotHeader('Item')).toBe('item')
  })

  it('should normalize Current Balance to current_balance', () => {
    expect(normalizeSnapshotHeader('Current Balance')).toBe('current_balance')
  })

  it('should handle variations', () => {
    expect(normalizeSnapshotHeader('Quantity')).toBe('current_balance')
    expect(normalizeSnapshotHeader('On Hand')).toBe('current_balance')
  })
})
```

**Validation**:
```bash
npm test -- --testPathPattern="xlsx-import"
```
**Completion Criteria**:
- [ ] All unit tests pass
- [ ] SKU generation edge cases covered
- [ ] Date extraction tested

### Subtask 4.2: Manual Integration Testing
**Purpose**: Verify end-to-end functionality with sample files

**Instructions**:
1. Start the development server
2. Navigate to Import page
3. Test with sample files in project root:
   - `/home/pbrown/SkuInventory/2025-11-13_TonsilTech_Inventory.xlsx`
   - `/home/pbrown/SkuInventory/2025-11-20_TonsilTech_Inventory.xlsx`

**Test Cases**:
1. Upload first XLSX file (2025-11-13):
   - Should create components with auto-generated SKU codes
   - Should create initial transactions with date 2025-11-13
   - Should show success count

2. Upload second XLSX file (2025-11-20) without overwrite:
   - Should skip existing components
   - Should skip existing initial transactions
   - Should show skip count with explanation

3. Upload second XLSX file with Allow Overwrite:
   - Should replace initial transactions
   - Should show overwritten count

4. Verify in database:
   - Check Components table has new entries
   - Check Transactions table has initial type entries
   - Check dates match filename dates

**Validation**:
```bash
npm run build
npm run dev
# Then test in browser at http://172.16.20.50:4545/import
```
**Completion Criteria**:
- [ ] First import creates components and transactions
- [ ] Second import without overwrite skips correctly
- [ ] Second import with overwrite replaces correctly
- [ ] Dates extracted from filenames correctly
- [ ] UI shows correct success/skip/error counts

### Subtask 4.3: Regression Testing
**Purpose**: Ensure existing CSV imports still work

**Instructions**:
1. Test component CSV import still works
2. Test SKU CSV import still works
3. Test initial-inventory CSV import still works

**Validation**:
```bash
npm test
npm run build
```
**Completion Criteria**:
- [ ] All existing tests pass
- [ ] Build succeeds without warnings
- [ ] No TypeScript errors

---

## Summary of Deliverables

### Files Created (3):
| File | Type | Purpose |
|------|------|---------|
| `/home/pbrown/SkuInventory/src/services/xlsx-import.ts` | Service | XLSX parsing and utilities |
| `/home/pbrown/SkuInventory/src/app/api/import/inventory-snapshot/route.ts` | API Route | Handle XLSX upload and import |
| `/home/pbrown/SkuInventory/tests/services/xlsx-import.test.ts` | Test | Unit tests for service |

### Files Modified (4):
| File | Changes |
|------|---------|
| `/home/pbrown/SkuInventory/package.json` | Add xlsx dependency |
| `/home/pbrown/SkuInventory/src/components/features/ImportForm.tsx` | Add inventory-snapshot type, XLSX support |
| `/home/pbrown/SkuInventory/src/components/features/ImportResultDialog.tsx` | Add inventory-snapshot type label |
| `/home/pbrown/SkuInventory/src/app/(dashboard)/import/page.tsx` | Add snapshot import section |

### Reference Files (No changes, patterns only):
| File | Used For |
|------|----------|
| `/home/pbrown/SkuInventory/src/services/import.ts` | Import service patterns |
| `/home/pbrown/SkuInventory/src/app/api/import/initial-inventory/route.ts` | API route pattern |
| `/home/pbrown/SkuInventory/src/services/inventory.ts` | createInitialTransaction function |
| `/home/pbrown/SkuInventory/src/app/api/components/route.ts` | Component creation pattern |
| `/home/pbrown/SkuInventory/src/types/component.ts` | Component types and validation |

---

## Acceptance Criteria Mapping

| Acceptance Criteria | Implementation |
|---------------------|----------------|
| Can upload XLSX file via UI | Subtask 3.1 - ImportForm accepts .xlsx |
| Components created with auto-generated SKU codes | Subtask 2.1 - generateSkuCode() + component creation |
| `initial` transactions created with correct quantities | Subtask 2.1 - createInitialTransaction() call |
| Date extracted from filename when available | Subtask 1.1 - extractDateFromFilename() |
| Handles duplicate item names (configurable: skip/update/error) | Subtask 2.1 - allowOverwrite parameter |
| Import summary shows success/failure counts | Subtask 2.1 - InventorySnapshotImportResult structure |
| Existing component import still works (no regression) | Subtask 4.3 - Regression testing |
| All tests passing, build succeeds without warnings | Subtask 4.1-4.3 - Testing phase |

**Note on Preview Feature**: The issue mentions preview before committing. For MVP, this is deferred - the import happens immediately. Preview can be added in a future iteration if needed.

---

## Handoff to Build Agent

1. Execute subtasks in exact order: 0.1 -> 1.1 -> 2.1 -> 3.1 -> 3.2 -> 3.3 -> 4.1 -> 4.2 -> 4.3
2. Complete prerequisite (0.1) before any coding
3. Run validation commands after each subtask
4. Test completion criteria before moving to next subtask
5. Follow reference patterns exactly from the listed files
6. Sample XLSX files for testing are at:
   - `/home/pbrown/SkuInventory/2025-11-13_TonsilTech_Inventory.xlsx`
   - `/home/pbrown/SkuInventory/2025-11-20_TonsilTech_Inventory.xlsx`

**Critical Pattern References**:
- Component creation: `/home/pbrown/SkuInventory/src/app/api/components/route.ts` (lines 164-247)
- Initial transaction creation: `/home/pbrown/SkuInventory/src/services/inventory.ts` (lines 229-305)
- Import service types: `/home/pbrown/SkuInventory/src/services/import.ts` (lines 10-22)
- API authentication pattern: `/home/pbrown/SkuInventory/src/app/api/import/initial-inventory/route.ts` (lines 26-48)

---

## Performance Metrics

| Phase | Duration |
|-------|----------|
| Scout Review | 5m |
| Pattern Research | 12m |
| Schema Verification | 3m |
| Plan Writing | 15m |
| **Total** | **35m** |

---

AGENT_RETURN: plan-17-120325
