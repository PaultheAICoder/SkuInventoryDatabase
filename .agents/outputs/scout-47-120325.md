# Scout Report: Bug #47 - TypeError: t.then is not a function

## Request Analysis
**Type**: Bug
**Source**: GitHub Issue #47
**Priority**: High - Core feature broken, user cannot complete primary task
**Verified**: 2025-12-03 (reproduction confirmed)

## Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="bom"` or run full suite since it's a quick fix

## Issue Validation
**Status**: Valid - Confirmed root cause identified
**Recent Changes**: Issue #15 (defect tracking) added to BOM forms, but didn't cause this bug
**Root Cause**: Client component incorrectly using async `params` prop instead of `useParams()` hook

## Current State

### Error Details
- **Error Type**: TypeError
- **Error Message**: `t.then is not a function`
- **Location**: Minified production build, likely SKU detail page
- **Trigger**: Clicking "Create first BOM version" button on SKU detail page

### Reproduction Steps
1. Navigate to SKUs page
2. Create a new SKU (fill required fields, save)
3. On the new SKU detail page, click "Create first BOM version" button
4. Result: "Something went wrong" error appears, console shows TypeError

### Root Cause Analysis

The bug is in `/home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/bom/new/page.tsx`:

**Current (BROKEN) Implementation:**
```typescript
interface NewBOMPageProps {
  params: Promise<{ id: string }>  // WRONG for client components
}

export default function NewBOMPage({ params }: NewBOMPageProps) {
  // ...
  useEffect(() => {
    params.then((p) => setSkuId(p.id))  // ERROR: params is NOT a Promise in client components
  }, [params])
```

**Why This Fails:**
- The page has `'use client'` directive (line 1)
- In Next.js 14 App Router:
  - **Server components**: `params` is a `Promise<{ id: string }>`
  - **Client components**: `params` is a plain object `{ id: string }`, accessed via `useParams()` hook
- When the code tries to call `.then()` on a non-Promise object, JavaScript throws `TypeError: t.then is not a function`

**Correct Pattern (used everywhere else in codebase):**
```typescript
export default function EditSKUPage() {
  const params = useParams()           // Use hook for client components
  const id = params.id as string       // Direct access, not a Promise
  // ...
}
```

## Dependencies & Blockers

**Can Proceed?**: YES - No blockers, clear fix identified

**Dependencies**: None - isolated fix in single file

## Complexity Assessment
**Complexity**: Simple
**Effort**: < 30 minutes
**Risk**: Low - Pattern used successfully in 6+ other client component pages

## Patterns to Follow

**Primary Reference**: `/home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/edit/page.tsx`
- Lines 12-13: Uses `useParams()` hook correctly
- Line 5: Imports `useParams` from `'next/navigation'`

**Secondary References** (all use same pattern):
- `/home/pbrown/SkuInventory/src/app/(dashboard)/components/[id]/edit/page.tsx`
- `/home/pbrown/SkuInventory/src/app/(dashboard)/components/[id]/page.tsx`
- `/home/pbrown/SkuInventory/src/app/(dashboard)/transactions/[id]/page.tsx`
- `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/users/[id]/edit/page.tsx`

**Counter-examples (API routes - correctly use Promise pattern):**
- `/home/pbrown/SkuInventory/src/app/api/skus/[id]/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/skus/[id]/bom-versions/route.ts`
- All API routes correctly await `params` because they are server-side

## Files to Create/Modify

### Modify
1. `/home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/bom/new/page.tsx`
   - **Change interface**: Remove `NewBOMPageProps` interface (or change to not receive params)
   - **Add import**: `useParams` from `'next/navigation'` (already imports `useRouter`)
   - **Change component signature**: Remove `{ params }` prop
   - **Add hook call**: `const params = useParams()`
   - **Change state init**: Remove `useState<string | null>(null)`, use direct access
   - **Remove effect**: Remove the first `useEffect` that calls `params.then()`
   - **Simplify logic**: Access `params.id` directly as string

### Expected changes:
```diff
- interface NewBOMPageProps {
-   params: Promise<{ id: string }>
- }
-
- export default function NewBOMPage({ params }: NewBOMPageProps) {
+ export default function NewBOMPage() {
    const router = useRouter()
+   const params = useParams()
+   const skuId = params.id as string
-   const [skuId, setSkuId] = useState<string | null>(null)
    const [skuName, setSkuName] = useState<string>('')
    const [isLoading, setIsLoading] = useState(true)
    const [error, setError] = useState<string | null>(null)

-   useEffect(() => {
-     params.then((p) => setSkuId(p.id))
-   }, [params])
-
    useEffect(() => {
-     if (!skuId) return
-
      async function fetchSKU() {
        try {
          const res = await fetch(`/api/skus/${skuId}`)
          // ... rest of effect
        }
      }

      fetchSKU()
    }, [skuId])
```

## Final Sweep Results

**Services Search**: No service changes needed
**API Routes**: No API changes needed
**Type Definitions**: No type changes needed
**Components**: 1 component affected (the broken page)
**Test Files**: No test files currently test this specific page navigation

**All Affected Files** (comprehensive list):
- `/home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/bom/new/page.tsx` - Fix params handling

**Related Files (not affected, just context):**
- `/home/pbrown/SkuInventory/src/components/features/BOMVersionList.tsx` - Button that triggers navigation (line 103)
- `/home/pbrown/SkuInventory/src/components/features/BOMVersionForm.tsx` - Form displayed on the page
- `/home/pbrown/SkuInventory/src/app/api/skus/[id]/bom-versions/route.ts` - API endpoint (works correctly)
- `/home/pbrown/SkuInventory/src/services/bom.ts` - Service layer (works correctly)

## Acceptance Criteria
- [ ] User can click "Create first BOM version" button without error
- [ ] Page loads successfully at `/skus/[id]/bom/new`
- [ ] SKU name displays correctly in the form header
- [ ] Form is fully functional and can create BOM versions
- [ ] No console errors when navigating to the page
- [ ] Pattern matches other client component pages in codebase
- [ ] TypeScript compilation succeeds with no errors
- [ ] Build succeeds with no errors

## Handoff to Plan Agent

**Summary**: The bug is a simple but critical mistake in the new BOM version page. The client component incorrectly uses async `params` prop (server component pattern) instead of the `useParams()` hook (client component pattern). When JavaScript tries to call `.then()` on a non-Promise object, it throws TypeError. The fix is straightforward: replace the async params pattern with the `useParams()` hook, matching the pattern used in 6+ other client component pages in the codebase.

**Key Points**:
1. Root cause confirmed: Client component using server component params pattern
2. Single file affected: `/home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/bom/new/page.tsx`
3. Clear pattern to follow: 6+ existing pages use `useParams()` hook correctly
4. No service layer, API, or type changes needed - pure UI fix
5. Low risk: Simple refactor following established codebase pattern
6. Quick fix: Should take < 30 minutes to implement and test

**Suggested Phases**:
1. **Phase 1**: Update page to use `useParams()` hook
   - Remove `NewBOMPageProps` interface
   - Add `useParams()` hook call
   - Remove async params handling
   - Simplify state management
2. **Phase 2**: Manual testing
   - Test button click from SKU detail page
   - Verify page loads without errors
   - Verify form displays correctly
   - Test creating a BOM version end-to-end
3. **Phase 3**: Add regression test (optional but recommended)
   - E2E test for "Create first BOM version" flow
   - Prevents similar bugs in future

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Issue Parsing | 2m |
| Codebase Exploration | 8m |
| Pattern Identification | 5m |
| Root Cause Analysis | 10m |
| Report Writing | 8m |
| **Total** | **33m** |

---

AGENT_RETURN: scout-47-120325
