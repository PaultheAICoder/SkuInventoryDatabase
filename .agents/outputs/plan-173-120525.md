# Implementation Plan
**Generated**: 2025-12-05T00:55:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #173 - SKU creation fails with "Failed to create SKU. Please try again or contact support"
**Estimated Build Time**: 2-3 hours
**Complexity**: Medium

## Investigation Summary

### Request Analysis
**Type**: Bug Fix
**Source**: GitHub Issue #173
**Priority**: Medium (blocks core SKU creation functionality)

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED
**Suggested Filter**: Run integration tests for SKU API

### Issue Validation
**Status**: Valid - Bug confirmed via production container logs
**Recent Changes**: Issue #170 (commit `5535573`) added improved error logging which exposed the root cause

### Current State Assessment
- **Existing components**: SKUForm.tsx, api/skus/route.ts - both exist and function correctly
- **Database**: SKU model has correct schema, FK constraints enforced
- **API Routes**: POST /api/skus fails with FK violation on `createdById`
- **Types**: createSKUSchema validates correctly

### Root Cause Analysis (CONFIRMED)

**ROOT CAUSE**: Foreign key constraint violation on `SKU_createdById_fkey`

The production container logs show:
```
Foreign key constraint violated on the constraint: `SKU_createdById_fkey`
...
"userId": "982c5d81-8981-4eb9-babf-5f8ee35983e5",
"companyId": "df0f3e0b-09a4-47ea-8b05-e88ecf59d0b7",
"internalCode": "AMZ_3pk"
```

The user ID `982c5d81-8981-4eb9-babf-5f8ee35983e5` does NOT exist in the database. This is a **stale JWT token** - the user was created in a previous database state, the database was reseeded/reset, but their browser still has the old JWT token with the now-invalid user ID.

**Why this happens:**
1. User logs in, JWT token is created with their user ID
2. Database is reseeded/reset (common in development/staging)
3. User's new record gets a NEW UUID
4. Old JWT token still has the OLD UUID
5. API routes use `session.user.id` directly in `createdById` without validation
6. Prisma throws FK violation when trying to insert with non-existent user ID

**Evidence:**
- Production database users verified - none match the ID in error logs
- Query `SELECT id FROM "User" WHERE id = '982c5d81-8981-4eb9-babf-5f8ee35983e5'` returns 0 rows
- Error logging added in Issue #170 exposed the exact user ID being used

### Dependencies & Blockers
1. No blockers - fix is isolated to API route with optional middleware addition
2. User must log out and log back in as immediate workaround

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Medium
**Effort**: 2-3 hours
**Risk**: Low - defensive validation addition, no schema changes

### Patterns Identified
**Primary**: `/src/app/api/skus/route.ts:148-155` - existing session validation pattern for `selectedCompanyId`
**Secondary**: `/src/lib/auth.ts:322-327` - `validateCompanyAccess` function pattern

### Ripple Effect Analysis
**Files Identified**: 30 files potentially affected (all routes using `session.user.id`)

However, for this fix we will:
1. Fix the SKU route specifically (immediate fix)
2. Create a reusable validation helper (pattern establishment)
3. Document the pattern for future fixes to other routes

| File | Reason | Priority |
|------|--------|----------|
| `/src/app/api/skus/route.ts` | Main fix location - add user validation | P0 |
| `/src/lib/auth.ts` | Add reusable user validation helper | P0 |
| `/tests/integration/sku-api.test.ts` | Add regression test | P0 |
| Other routes (30 files) | Future cleanup - same pattern | P1 (out of scope) |

---

## Executive Summary
Fix SKU creation error by validating that `session.user.id` exists in the database before using it as a foreign key reference. The root cause is stale JWT tokens containing user IDs that no longer exist after database reseed. Add a reusable validation helper and regression test.

## Phase 1: Add User Validation Helper

### Subtask 1.1: Add validateUserExists helper to auth.ts
**File**: `/home/pbrown/SkuInventory/src/lib/auth.ts`
**Pattern**: Follow existing `validateCompanyAccess` helper pattern at lines 322-327
**Instructions**:
1. Add a new helper function after `validateCompanyAccess`:

```typescript
/**
 * Validate that a user ID exists in the database
 * Used to catch stale JWT tokens after database reseed
 * Returns the user record if found, null otherwise
 */
export async function validateUserExists(userId: string): Promise<{ id: string; email: string; isActive: boolean } | null> {
  try {
    const user = await prisma.user.findUnique({
      where: { id: userId },
      select: { id: true, email: true, isActive: true }
    })
    return user
  } catch {
    return null
  }
}
```

2. Import `prisma` at the top if not already imported

**Validation Commands**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Helper function added
- [ ] TypeScript compiles without errors
- [ ] Function is exported

### Subtask 1.2: Update SKU POST handler to validate user exists
**File**: `/home/pbrown/SkuInventory/src/app/api/skus/route.ts`
**Pattern**: Follow existing `selectedCompanyId` validation pattern at lines 148-155
**Instructions**:
1. Add import for `validateUserExists` at the top:
```typescript
import { authOptions, validateUserExists } from '@/lib/auth'
```

2. After the existing session validation (around line 155), add user validation:
```typescript
    // Validate session has required company context
    if (!session.user.selectedCompanyId) {
      console.error('SKU creation failed: No selectedCompanyId in session', {
        userId: session.user.id,
        email: session.user.email,
      })
      return error('Company context is required. Please select a company and try again.', 400, 'BadRequest')
    }

    // Validate user still exists in database (catches stale JWT tokens after DB reseed)
    const validUser = await validateUserExists(session.user.id)
    if (!validUser) {
      console.error('SKU creation failed: User ID not found in database (stale JWT token)', {
        userId: session.user.id,
        email: session.user.email,
      })
      return error('Your session has expired. Please log out and log back in.', 401, 'Unauthorized')
    }
    if (!validUser.isActive) {
      console.error('SKU creation failed: User is inactive', {
        userId: session.user.id,
        email: session.user.email,
      })
      return error('Your account is inactive. Please contact an administrator.', 403, 'Forbidden')
    }
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Import added
- [ ] User validation added after selectedCompanyId check
- [ ] Appropriate error messages for different failure cases
- [ ] Build succeeds

## Phase 2: Update Error Handling

### Subtask 2.1: Add specific error handling for FK violations
**File**: `/home/pbrown/SkuInventory/src/app/api/skus/route.ts`
**Pattern**: Follow existing unique constraint error handling at lines 251-253
**Instructions**:
1. Update the catch block (around line 240) to handle FK violations:

```typescript
  } catch (err) {
    // Log detailed error for debugging
    const errorDetails = {
      message: err instanceof Error ? err.message : 'Unknown error',
      stack: err instanceof Error ? err.stack : undefined,
      name: err instanceof Error ? err.name : undefined,
      ...errorContext,
    }
    console.error('Error creating SKU:', JSON.stringify(errorDetails, null, 2))

    // Return user-friendly message based on error type
    if (err instanceof Error && err.message.includes('Unique constraint')) {
      return conflict('A SKU with this internal code already exists')
    }

    // Handle FK constraint violations (e.g., stale user ID in JWT)
    if (err instanceof Error && err.message.includes('Foreign key constraint')) {
      if (err.message.includes('createdById') || err.message.includes('updatedById')) {
        return error('Your session has expired. Please log out and log back in.', 401, 'Unauthorized')
      }
      if (err.message.includes('brandId')) {
        return error('Invalid brand selection. Please refresh the page and try again.', 400, 'BadRequest')
      }
      if (err.message.includes('companyId')) {
        return error('Company context is invalid. Please log out and log back in.', 400, 'BadRequest')
      }
    }

    return serverError('Failed to create SKU. Please try again or contact support.')
  }
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] FK violation handling added
- [ ] Specific error messages for different FK types
- [ ] Build succeeds

## Phase 3: Add Regression Tests

### Subtask 3.1: Add test for stale user session
**File**: `/home/pbrown/SkuInventory/tests/integration/sku-api.test.ts`
**Pattern**: Follow existing test patterns in the file
**Instructions**:
1. Add a new test case for invalid user ID:

```typescript
    it('returns 401 for stale user session (user ID not in database)', async () => {
      // Create a session with a non-existent user ID
      const staleSession = {
        user: {
          id: '00000000-0000-0000-0000-000000000000', // Non-existent user
          email: 'deleted@example.com',
          name: 'Deleted User',
          role: 'admin' as const,
          companyId: TEST_SESSIONS.admin!.user.companyId,
          companyName: 'Tonsil Tech',
          selectedCompanyId: TEST_SESSIONS.admin!.user.selectedCompanyId,
        },
      }
      setTestSession(staleSession)

      const request = createTestRequest('/api/skus', {
        method: 'POST',
        body: {
          name: 'Test SKU',
          internalCode: `TEST-STALE-${Date.now()}`,
          salesChannel: 'Amazon',
          externalIds: {},
        },
      })

      const response = await createSKU(request)
      const result = await parseRouteResponse(response)

      expect(result.status).toBe(401)
      expect(result.message).toContain('session has expired')
    })
```

2. Update the test interface if needed to support optional fields

**Validation Commands**:
```bash
npm run test:integration
```

**Completion Criteria**:
- [ ] Test added
- [ ] Test passes
- [ ] Test fails if validation is removed (regression protection)

### Subtask 3.2: Update TestUserSession interface
**File**: `/home/pbrown/SkuInventory/tests/helpers/auth-mock.ts`
**Instructions**:
1. The TestUserSession interface may need optional fields. Check if needed:

```typescript
export interface TestUserSession {
  user: {
    id: string
    email: string
    name: string
    role: 'admin' | 'ops' | 'viewer'
    companyId: string
    companyName: string
    selectedCompanyId: string
    selectedBrandId?: string | null  // Optional - for testing brand scenarios
  }
}
```

**Validation Commands**:
```bash
npm run test:integration
```

**Completion Criteria**:
- [ ] Interface updated if needed
- [ ] Existing tests still pass
- [ ] New test passes

## Phase 4: Verify Fix

### Subtask 4.1: Run all validations
**Instructions**:
1. Run full build and test suite:
```bash
npx tsc --noEmit
npm run build
npm run test:integration
```

2. Manual verification:
   - If production environment accessible, test SKU creation with valid session
   - Verify error message is user-friendly for invalid sessions

**Completion Criteria**:
- [ ] TypeScript compiles without errors
- [ ] Build succeeds
- [ ] All integration tests pass
- [ ] SKU creation works with valid session

---

## Summary of Deliverables
**Files Modified**: 3
- `/src/lib/auth.ts` - Add `validateUserExists` helper
- `/src/app/api/skus/route.ts` - Add user validation and improved FK error handling
- `/tests/integration/sku-api.test.ts` - Add regression test

**Files Potentially Modified**: 1
- `/tests/helpers/auth-mock.ts` - Update interface if needed

## Handoff to Build Agent
1. Execute subtasks in exact order (Phase 1 -> Phase 2 -> Phase 3 -> Phase 4)
2. User validation MUST happen BEFORE any database operations
3. Test completion criteria before next subtask
4. All validation commands must pass before proceeding

## Test Strategy Note
- Use Vitest for integration tests
- Run `npm run test:integration` to execute all integration tests
- New test should specifically catch stale JWT token scenarios

## Immediate Workaround for Users
Until the fix is deployed, affected users should:
1. Log out of the application
2. Clear browser cookies for the domain (optional but recommended)
3. Log back in

This will refresh their JWT token with the current user ID.

## Future Work (Out of Scope)
The same stale JWT token issue affects 30+ other API routes that use `session.user.id`. These should be addressed in a follow-up issue:
- `/src/app/api/components/route.ts`
- `/src/app/api/transactions/route.ts`
- All other routes using `createdById: session.user.id`

Recommendation: Create middleware or wrapper that validates user exists on all authenticated routes.

## Performance Metrics
| Phase | Estimated Duration |
|-------|----------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 10m |
| **Total** | **30m** |
