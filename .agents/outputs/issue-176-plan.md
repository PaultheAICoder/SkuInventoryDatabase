# Implementation Plan
**Generated**: 2025-12-05T03:00:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #176
**Estimated Build Time**: 4-6 hours
**Complexity**: Moderate

## Investigation Summary

### Request Analysis
**Type**: Feature/Enhancement
**Source**: GitHub Issue #176
**Priority**: Medium

### Issue Description
The user wants to express `qty/unit` (quantityPerUnit) as a fraction (e.g., "1/45") when building out the BOM section under SKU. The use case is: when shipping 45 units per casepack, the cost allocation per unit should be exactly 1/45. Currently, the input only accepts decimal numbers.

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="BOM|bom|fraction"` or None

### Issue Validation
**Status**: Valid
**Recent Changes**: No recent changes to core BOM input functionality
- The BOM system has been stable; recent changes were related to location-aware queries, JSON parsing, and defect tracking

### Current State Assessment

#### Existing Components (Affected Files):

1. **BOMVersionForm.tsx** (`/home/pbrown/SkuInventory/src/components/features/BOMVersionForm.tsx`)
   - Line 308-318: Input field for `quantityPerUnit` uses `type="number"` with step="0.0001"
   - Currently parses value using `parseFloat()` on form submission (line 143)
   - UI displays numeric input only

2. **BOM Types** (`/home/pbrown/SkuInventory/src/types/bom.ts`)
   - Line 6: `bomLineSchema` uses `z.coerce.number().positive()` for validation
   - This coerces input to number, does not support fraction strings

3. **BOM Service** (`/home/pbrown/SkuInventory/src/services/bom.ts`)
   - Lines 217-220: Creates BOM lines with `Prisma.Decimal` from numeric quantityPerUnit
   - Already supports high precision decimals (10,4)

4. **API Routes**:
   - `/home/pbrown/SkuInventory/src/app/api/skus/[id]/bom-versions/route.ts` - POST endpoint
   - `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/route.ts` - GET endpoint
   - Both handle quantityPerUnit as numeric values

5. **Import Service** (`/home/pbrown/SkuInventory/src/services/import.ts`)
   - Line 183: BOM qty columns use `parseFloat()` for parsing
   - Does not support fraction syntax in imports

6. **BOMVersionList.tsx** (`/home/pbrown/SkuInventory/src/components/features/BOMVersionList.tsx`)
   - Line 212: Displays quantityPerUnit using `parseFloat().toLocaleString()`
   - May need update to show fraction format as alternate display

#### Database:
- `BOMLine.quantityPerUnit` is `Decimal(10, 4)` - already supports fractional values
- No schema changes required - just need to parse fractions before storing

### Dependencies & Blockers
1. No external dependencies required
2. No blockers identified

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Moderate
**Effort**: 4-6 hours
**Risk**: Low - isolated change to input parsing, database already supports decimals

### Patterns Identified
**Primary**: `/home/pbrown/SkuInventory/src/components/features/BOMVersionForm.tsx` - existing input handling
**Secondary**: `/home/pbrown/SkuInventory/src/lib/utils.ts` - utility functions location

### Ripple Effect Analysis
**Files Identified**: 7 files need changes

1. `/home/pbrown/SkuInventory/src/lib/utils.ts` - Add fraction parsing utility
2. `/home/pbrown/SkuInventory/src/types/bom.ts` - Update schema to accept fraction strings
3. `/home/pbrown/SkuInventory/src/components/features/BOMVersionForm.tsx` - Update input type and parsing
4. `/home/pbrown/SkuInventory/src/components/features/BOMVersionList.tsx` - Optional: display fraction format
5. `/home/pbrown/SkuInventory/src/services/import.ts` - Support fraction parsing in imports
6. `/home/pbrown/SkuInventory/src/app/api/skus/[id]/bom-versions/route.ts` - No changes needed (validation handled by schema)
7. `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/route.ts` - No changes needed

---

## Executive Summary
Implement fraction input support (e.g., "1/45") for BOM quantityPerUnit field. Create a utility function to parse fraction strings to decimal values, update the Zod validation schema to accept fraction format, modify the BOM form input to allow text entry, and optionally enhance the display to show original fraction notation.

## Phase 0: Code Understanding (if needed)
No complex untangling required - the BOM form and validation are straightforward.

## Phase 1: Utility Functions

### Subtask 1.1: Create Fraction Parsing Utility
**File**: `/home/pbrown/SkuInventory/src/lib/utils.ts`
**Pattern**: Follow existing utility structure in utils.ts
**Instructions**:
1. Add a new function `parseFractionOrNumber(input: string): number | null`
2. The function should:
   - Accept input like "1/45", "0.5", "1", "2.5", "3/4"
   - Parse fractions: split by "/" and divide numerator by denominator
   - Parse regular numbers: use parseFloat
   - Return null for invalid input
   - Handle edge cases: division by zero, empty string, non-numeric characters

```typescript
/**
 * Parse a fraction string (e.g., "1/45") or decimal number to a numeric value.
 * Returns null if the input is invalid.
 */
export function parseFractionOrNumber(input: string): number | null {
  if (!input || typeof input !== 'string') {
    return null
  }

  const trimmed = input.trim()
  if (!trimmed) {
    return null
  }

  // Check if it's a fraction (contains /)
  if (trimmed.includes('/')) {
    const parts = trimmed.split('/')
    if (parts.length !== 2) {
      return null
    }

    const numerator = parseFloat(parts[0].trim())
    const denominator = parseFloat(parts[1].trim())

    if (isNaN(numerator) || isNaN(denominator) || denominator === 0) {
      return null
    }

    return numerator / denominator
  }

  // Otherwise, parse as a regular number
  const num = parseFloat(trimmed)
  return isNaN(num) ? null : num
}
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run lint
```

**Completion Criteria**:
- [ ] Function added to utils.ts
- [ ] TypeScript compiles without errors
- [ ] Function handles fractions correctly (1/45 = 0.0222...)
- [ ] Function handles decimals correctly (0.5 = 0.5)
- [ ] Function returns null for invalid inputs

### Subtask 1.2: Create Fraction Validation for Zod Schema
**File**: `/home/pbrown/SkuInventory/src/types/bom.ts`
**Pattern**: Follow existing Zod schema patterns in the file
**Instructions**:
1. Import the parseFractionOrNumber utility
2. Create a custom Zod transformer that accepts string input and parses fractions
3. Update `bomLineSchema.quantityPerUnit` to use the new transformer

```typescript
import { parseFractionOrNumber } from '@/lib/utils'

// Update the quantityPerUnit field in bomLineSchema
export const bomLineSchema = z.object({
  componentId: z.string().uuid('Invalid component ID'),
  quantityPerUnit: z.string()
    .min(1, 'Quantity is required')
    .transform((val, ctx) => {
      const parsed = parseFractionOrNumber(val)
      if (parsed === null || parsed <= 0) {
        ctx.addIssue({
          code: z.ZodIssueCode.custom,
          message: 'Quantity must be a positive number or fraction (e.g., "1", "0.5", "1/45")',
        })
        return z.NEVER
      }
      return parsed
    }),
  notes: z.string().optional().nullable(),
})
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Schema updated to accept fraction strings
- [ ] Schema validates positive values only
- [ ] Schema provides helpful error messages
- [ ] TypeScript compiles without errors

## Phase 2: Frontend Components

### Subtask 2.1: Update BOMVersionForm Input Field
**File**: `/home/pbrown/SkuInventory/src/components/features/BOMVersionForm.tsx`
**Pattern**: Follow existing input patterns in the file
**Instructions**:
1. Change the quantityPerUnit input from `type="number"` to `type="text"`
2. Update the input placeholder to indicate fraction support
3. Import and use parseFractionOrNumber for local validation and line cost calculation
4. Keep the form submission logic unchanged (API handles validation)

Changes at line 308-318:
```typescript
<TableCell>
  <Input
    type="text"
    value={line.quantityPerUnit}
    onChange={(e) =>
      updateLine(index, 'quantityPerUnit', e.target.value)
    }
    placeholder="e.g., 1, 0.5, 1/45"
    className="w-full"
  />
</TableCell>
```

Update calculateTotalCost function (around line 106) and line cost display (around line 281) to use parseFractionOrNumber:

```typescript
import { parseFractionOrNumber } from '@/lib/utils'

const calculateTotalCost = () => {
  return lines.reduce((total, line) => {
    const qty = parseFractionOrNumber(line.quantityPerUnit) ?? 0
    const cost = parseFloat(line.costPerUnit) || 0
    return total + qty * cost
  }, 0)
}

// In the table row rendering:
const lineCost =
  (parseFractionOrNumber(line.quantityPerUnit) ?? 0) *
  (parseFloat(line.costPerUnit) || 0)
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
npm run lint
```

**Completion Criteria**:
- [ ] Input type changed to text
- [ ] Placeholder shows fraction example
- [ ] Line cost calculation uses parseFractionOrNumber
- [ ] Total cost calculation uses parseFractionOrNumber
- [ ] TypeScript compiles without errors
- [ ] Build succeeds

### Subtask 2.2: Update BOMVersionList Display (Optional Enhancement)
**File**: `/home/pbrown/SkuInventory/src/components/features/BOMVersionList.tsx`
**Pattern**: Follow existing display patterns
**Instructions**:
1. This is optional - can keep displaying as decimal
2. If implementing: for values like 0.0222..., optionally show as "1/45" with tooltip
3. For MVP, just ensure the decimal display works correctly

Current display (line 211-213) is fine - no changes strictly required:
```typescript
<TableCell className="text-right font-mono" suppressHydrationWarning>
  {parseFloat(line.quantityPerUnit).toLocaleString()}
</TableCell>
```

**Completion Criteria**:
- [ ] Display still works correctly
- [ ] No TypeScript errors
- [ ] Consider adding tooltip showing original fraction in future iteration

## Phase 3: Import Service Update

### Subtask 3.1: Update SKU Import BOM Quantity Parsing
**File**: `/home/pbrown/SkuInventory/src/services/import.ts`
**Pattern**: Follow existing parsing patterns in the file
**Instructions**:
1. Import parseFractionOrNumber from utils
2. Update the `createBomColumnSchemas` function (line 179-186) to use fraction parsing
3. This allows CSV imports with fraction values like "1/45"

Update line 183:
```typescript
import { parseFractionOrNumber } from '@/lib/utils'

// Helper to create BOM column schemas (5 component pairs)
function createBomColumnSchemas(): Record<string, z.ZodTypeAny> {
  const schemas: Record<string, z.ZodTypeAny> = {}
  for (let i = 1; i <= 5; i++) {
    schemas[`bom_component_${i}`] = z.string().optional().transform((v) => v || undefined)
    schemas[`bom_qty_${i}`] = z.string().optional().transform((v) => {
      if (!v) return undefined
      const parsed = parseFractionOrNumber(v)
      return parsed !== null && parsed > 0 ? parsed : undefined
    })
  }
  return schemas
}
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Import service uses parseFractionOrNumber
- [ ] CSV imports can contain fraction values
- [ ] TypeScript compiles without errors

## Phase 4: Testing

### Subtask 4.1: Manual Testing Checklist
**Instructions**: After implementation, manually verify:
1. Create a new BOM version with fraction quantity (1/45)
2. Verify line cost calculates correctly
3. Verify total unit cost calculates correctly
4. Verify BOM version saves successfully to database
5. Verify BOM version displays correctly in list
6. Test edge cases:
   - "1/0" should show error
   - "abc" should show error
   - Empty string should show error
   - "0.5" should work
   - "1" should work
   - "1/45" should work (stores as ~0.0222)

**Completion Criteria**:
- [ ] All manual tests pass
- [ ] Error messages are user-friendly
- [ ] No console errors

### Subtask 4.2: Verify Build and Lint
**File**: N/A (project-wide)
**Instructions**:
```bash
npm run build
npm run lint
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Build completes without errors
- [ ] Lint passes without errors
- [ ] TypeScript compiles without errors

---

## Summary of Deliverables
**Files Created**: 0
**Files Modified**: 4
1. `/home/pbrown/SkuInventory/src/lib/utils.ts` - Add parseFractionOrNumber utility
2. `/home/pbrown/SkuInventory/src/types/bom.ts` - Update validation schema
3. `/home/pbrown/SkuInventory/src/components/features/BOMVersionForm.tsx` - Update input and calculations
4. `/home/pbrown/SkuInventory/src/services/import.ts` - Support fractions in imports

## Handoff to Build Agent
1. Execute subtasks in exact order (1.1 -> 1.2 -> 2.1 -> 3.1 -> 4.1 -> 4.2)
2. Complete each phase fully before moving to next
3. Test completion criteria before proceeding to next subtask
4. Follow reference patterns exactly
5. Run validation commands after each subtask

## Test Strategy Note
- Use manual testing for this feature
- No unit test files exist for the BOM form component currently
- Focus on TypeScript compilation and build success as primary indicators

## Design Decisions

### Why Text Input Instead of Number?
- HTML number inputs cannot accept "/" character
- Text input with validation provides better UX for fraction entry
- Server-side validation ensures data integrity

### Why Parse to Decimal for Storage?
- Database already uses Decimal(10,4) - no schema change needed
- Calculations (cost, buildable units) work with decimals
- Consistent with existing data model

### Future Enhancements (Out of Scope)
1. Display stored decimals as original fraction notation
2. Add unit tests for parseFractionOrNumber utility
3. Support mixed fractions like "1 1/2"

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 8m |
| Validation | 3m |
| Planning | 7m |
| **Total** | **18m** |
