# Implementation Plan
**Generated**: 2025-12-17T21:15:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #313
**Estimated Build Time**: 2-3 hours
**Complexity**: Low

---

## Investigation Summary

### Request Analysis
**Type**: Bug
**Source**: GitHub Issue #313
**Priority**: High - Multi-tenant data scoping bug

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: FAST_PATH (smoke tests only - pattern is well-established)
**Suggested Filter**: None

### Issue Validation
**Status**: Valid
**Recent Changes**: No changes to Shopify routes in last 60 days (last change was initial implementation in commit b9c811a)

### Current State Assessment

**4 Affected Files (all confirmed)**:
1. `/home/pbrown/SkuInventory/src/app/api/integrations/shopify/status/route.ts` - Line 25-31: Uses `isPrimary: true`
2. `/home/pbrown/SkuInventory/src/app/api/integrations/shopify/connect/route.ts` - Line 27-33: Uses `isPrimary: true`
3. `/home/pbrown/SkuInventory/src/app/api/integrations/shopify/sync/route.ts` - Line 25-31: Uses `isPrimary: true`
4. `/home/pbrown/SkuInventory/src/app/api/integrations/shopify/disconnect/route.ts` - Line 25-31: Uses `isPrimary: true`

**Existing Pattern (Already Fixed)**:
The Amazon Ads integration routes have already been fixed using the correct pattern:
- `/home/pbrown/SkuInventory/src/app/api/integrations/amazon-ads/connect/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/integrations/amazon-ads/disconnect/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/integrations/amazon-ads/sync/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/integrations/amazon-ads/status/route.ts`

### Dependencies & Blockers
None identified. All required functions already exist:
- `getSelectedCompanyRole` from `@/lib/auth` - already available
- `session.user.selectedCompanyId` - available in session

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Simple
**Effort**: 2-3 hours
**Risk**: Low - Identical pattern to fixes already applied in Amazon Ads routes and CSV upload

### Patterns Identified
**Primary Reference**: `/home/pbrown/SkuInventory/src/app/api/integrations/amazon-ads/connect/route.ts`
- Uses `getSelectedCompanyRole(session)` for role check
- Uses `session.user.selectedCompanyId` directly
- No Prisma query needed to resolve company

**Secondary Reference**: `/home/pbrown/SkuInventory/src/app/api/integrations/amazon-ads/disconnect/route.ts`
- Validates credential belongs to selected company: `credential.companyId !== session.user.selectedCompanyId`

### Ripple Effect Analysis
**Files Identified**: 4 (all Shopify integration routes)
- No downstream callers - these are API endpoints
- No type changes needed
- No test files require updates (no existing Shopify route tests)

### Pattern Scan Results
**Pattern**: `isPrimary: true` in Prisma query for company resolution
**Files with bug**: Only the 4 Shopify routes (all reported in issue)
**User routes have intentional `isPrimary` usage** - these are for user management, not data scoping

---

## Executive Summary

Fix multi-tenant data scoping bug in 4 Shopify integration routes by replacing the `isPrimary: true` Prisma query pattern with direct use of `session.user.selectedCompanyId` and `getSelectedCompanyRole()`. This ensures Shopify operations respect the user's selected company rather than always targeting their primary company.

---

## Phase 1: Fix Status Route

### Subtask 1.1: Update Shopify Status Route
**File**: `/home/pbrown/SkuInventory/src/app/api/integrations/shopify/status/route.ts`
**Pattern Reference**: `/home/pbrown/SkuInventory/src/app/api/integrations/amazon-ads/status/route.ts` (lines 13-25)

**Instructions**:
1. Remove the `import { prisma } from '@/lib/db'` import (no longer needed for company resolution)
2. Remove the userCompany Prisma query (lines 25-31)
3. Remove the "User must belong to a company" check (lines 33-38)
4. Use `session.user.selectedCompanyId` directly for the `getConnectionStatus` call
5. Keep `prisma` import if it's used by `getConnectionStatus` (check dependency)

**Current Code (lines 14-42)**:
```typescript
export async function GET() {
  try {
    const session = await getServerSession(authOptions)
    if (!session?.user?.id) {
      return NextResponse.json(
        { error: 'Unauthorized' },
        { status: 401 }
      )
    }

    // Get user's primary company
    const userCompany = await prisma.userCompany.findFirst({
      where: {
        userId: session.user.id,
        isPrimary: true,
      },
      select: { companyId: true },
    })

    if (!userCompany) {
      return NextResponse.json(
        { error: 'User must belong to a company' },
        { status: 400 }
      )
    }

    const status = await getConnectionStatus(userCompany.companyId)
```

**Replace with**:
```typescript
export async function GET() {
  try {
    const session = await getServerSession(authOptions)
    if (!session?.user?.id) {
      return NextResponse.json(
        { error: 'Unauthorized' },
        { status: 401 }
      )
    }

    // Use selected company from session (not primary company)
    const companyId = session.user.selectedCompanyId

    const status = await getConnectionStatus(companyId)
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] `prisma` import removed if no longer used
- [ ] `isPrimary` query removed
- [ ] Uses `session.user.selectedCompanyId` directly
- [ ] TypeScript compiles without errors
- [ ] Build completes successfully

---

## Phase 2: Fix Connect Route

### Subtask 2.1: Update Shopify Connect Route
**File**: `/home/pbrown/SkuInventory/src/app/api/integrations/shopify/connect/route.ts`
**Pattern Reference**: `/home/pbrown/SkuInventory/src/app/api/integrations/amazon-ads/connect/route.ts` (lines 15-47)

**Instructions**:
1. Add `getSelectedCompanyRole` to the import from `@/lib/auth`
2. Remove the userCompany Prisma query (lines 27-33)
3. Remove the "User must belong to a company" check (lines 35-40)
4. Use `getSelectedCompanyRole(session)` for the admin check
5. Use `session.user.selectedCompanyId` for `companyId`
6. Update the existing connection check to use `session.user.selectedCompanyId`
7. Update `storeOAuthState` call to use `session.user.selectedCompanyId`

**Current Code (lines 16-84)**:
```typescript
export async function POST(request: NextRequest) {
  try {
    const session = await getServerSession(authOptions)
    if (!session?.user?.id) {
      return NextResponse.json(
        { error: 'Unauthorized' },
        { status: 401 }
      )
    }

    // Get user's primary company
    const userCompany = await prisma.userCompany.findFirst({
      where: {
        userId: session.user.id,
        isPrimary: true,
      },
      select: { companyId: true, role: true },
    })

    if (!userCompany) {
      return NextResponse.json(
        { error: 'User must belong to a company' },
        { status: 400 }
      )
    }

    // Only admin can connect integrations
    if (userCompany.role !== 'admin') {
      return NextResponse.json(
        { error: 'Only admins can connect integrations' },
        { status: 403 }
      )
    }

    // Check if already connected
    const existing = await prisma.shopifyConnection.findFirst({
      where: {
        companyId: userCompany.companyId,
        isActive: true,
      },
    })
    ...
    storeOAuthState(state, {
      shop,
      companyId: userCompany.companyId,
      userId: session.user.id,
    })
```

**Replace with**:
```typescript
export async function POST(request: NextRequest) {
  try {
    const session = await getServerSession(authOptions)
    if (!session?.user?.id) {
      return NextResponse.json(
        { error: 'Unauthorized' },
        { status: 401 }
      )
    }

    // Admin only (using company-specific role)
    const companyRole = getSelectedCompanyRole(session)
    if (companyRole !== 'admin') {
      return NextResponse.json(
        { error: 'Only admins can connect integrations' },
        { status: 403 }
      )
    }

    const companyId = session.user.selectedCompanyId

    // Check if already connected
    const existing = await prisma.shopifyConnection.findFirst({
      where: {
        companyId,
        isActive: true,
      },
    })
    ...
    storeOAuthState(state, {
      shop,
      companyId,
      userId: session.user.id,
    })
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] `getSelectedCompanyRole` imported from `@/lib/auth`
- [ ] `isPrimary` query removed
- [ ] Role check uses `getSelectedCompanyRole(session)`
- [ ] Uses `session.user.selectedCompanyId` for all company references
- [ ] TypeScript compiles without errors
- [ ] Build completes successfully

---

## Phase 3: Fix Sync Route

### Subtask 3.1: Update Shopify Sync Route
**File**: `/home/pbrown/SkuInventory/src/app/api/integrations/shopify/sync/route.ts`
**Pattern Reference**: `/home/pbrown/SkuInventory/src/app/api/integrations/amazon-ads/sync/route.ts` (lines 15-30)

**Instructions**:
1. Add `getSelectedCompanyRole` to the import from `@/lib/auth`
2. Remove the userCompany Prisma query (lines 25-31)
3. Remove the "User must belong to a company" check (lines 33-38)
4. Use `getSelectedCompanyRole(session)` for the admin/ops check
5. Use `session.user.selectedCompanyId` for the connection query

**Current Code (lines 14-69)**:
```typescript
export async function POST(request: NextRequest) {
  try {
    const session = await getServerSession(authOptions)
    if (!session?.user?.id) {
      return NextResponse.json(
        { error: 'Unauthorized' },
        { status: 401 }
      )
    }

    // Get user's primary company
    const userCompany = await prisma.userCompany.findFirst({
      where: {
        userId: session.user.id,
        isPrimary: true,
      },
      select: { companyId: true, role: true },
    })

    if (!userCompany) {
      return NextResponse.json(
        { error: 'User must belong to a company' },
        { status: 400 }
      )
    }

    // Admin or Ops only (sync can be triggered by ops team)
    if (userCompany.role !== 'admin' && userCompany.role !== 'ops') {
      return NextResponse.json(
        { error: 'Admin or Ops permission required' },
        { status: 403 }
      )
    }

    // Get connection
    const connection = await prisma.shopifyConnection.findFirst({
      where: {
        companyId: userCompany.companyId,
        isActive: true,
      },
    })
```

**Replace with**:
```typescript
export async function POST(request: NextRequest) {
  try {
    const session = await getServerSession(authOptions)
    if (!session?.user?.id) {
      return NextResponse.json(
        { error: 'Unauthorized' },
        { status: 401 }
      )
    }

    // Admin or Ops only (using company-specific role)
    const companyRole = getSelectedCompanyRole(session)
    if (companyRole !== 'admin' && companyRole !== 'ops') {
      return NextResponse.json(
        { error: 'Admin or Ops permission required' },
        { status: 403 }
      )
    }

    const companyId = session.user.selectedCompanyId

    // Get connection
    const connection = await prisma.shopifyConnection.findFirst({
      where: {
        companyId,
        isActive: true,
      },
    })
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] `getSelectedCompanyRole` imported from `@/lib/auth`
- [ ] `isPrimary` query removed
- [ ] Role check uses `getSelectedCompanyRole(session)`
- [ ] Uses `session.user.selectedCompanyId` for connection query
- [ ] TypeScript compiles without errors
- [ ] Build completes successfully

---

## Phase 4: Fix Disconnect Route

### Subtask 4.1: Update Shopify Disconnect Route
**File**: `/home/pbrown/SkuInventory/src/app/api/integrations/shopify/disconnect/route.ts`
**Pattern Reference**: `/home/pbrown/SkuInventory/src/app/api/integrations/amazon-ads/disconnect/route.ts` (lines 15-29)

**Instructions**:
1. Add `getSelectedCompanyRole` to the import from `@/lib/auth`
2. Remove the userCompany Prisma query (lines 25-31)
3. Remove the "User must belong to a company" check (lines 33-38)
4. Use `getSelectedCompanyRole(session)` for the admin check
5. Use `session.user.selectedCompanyId` for the connection query
6. Update the `logCredentialAudit` call to use `session.user.selectedCompanyId`

**Current Code (lines 14-84)**:
```typescript
export async function POST() {
  try {
    const session = await getServerSession(authOptions)
    if (!session?.user?.id) {
      return NextResponse.json(
        { error: 'Unauthorized' },
        { status: 401 }
      )
    }

    // Get user's primary company and verify admin role
    const userCompany = await prisma.userCompany.findFirst({
      where: {
        userId: session.user.id,
        isPrimary: true,
      },
      select: { companyId: true, role: true },
    })

    if (!userCompany) {
      return NextResponse.json(
        { error: 'User must belong to a company' },
        { status: 400 }
      )
    }

    // Only admin can disconnect
    if (userCompany.role !== 'admin') {
      return NextResponse.json(
        { error: 'Only admins can disconnect integrations' },
        { status: 403 }
      )
    }

    // Find and deactivate connection
    const connection = await prisma.shopifyConnection.findFirst({
      where: {
        companyId: userCompany.companyId,
        isActive: true,
      },
    })
    ...
    logCredentialAudit({
      ...
      metadata: {
        shopName: connection.shopName,
        companyId: userCompany.companyId,
      },
    })
```

**Replace with**:
```typescript
export async function POST() {
  try {
    const session = await getServerSession(authOptions)
    if (!session?.user?.id) {
      return NextResponse.json(
        { error: 'Unauthorized' },
        { status: 401 }
      )
    }

    // Admin only (using company-specific role)
    const companyRole = getSelectedCompanyRole(session)
    if (companyRole !== 'admin') {
      return NextResponse.json(
        { error: 'Only admins can disconnect integrations' },
        { status: 403 }
      )
    }

    const companyId = session.user.selectedCompanyId

    // Find and deactivate connection
    const connection = await prisma.shopifyConnection.findFirst({
      where: {
        companyId,
        isActive: true,
      },
    })
    ...
    logCredentialAudit({
      ...
      metadata: {
        shopName: connection.shopName,
        companyId,
      },
    })
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] `getSelectedCompanyRole` imported from `@/lib/auth`
- [ ] `isPrimary` query removed
- [ ] Role check uses `getSelectedCompanyRole(session)`
- [ ] Uses `session.user.selectedCompanyId` for all company references
- [ ] `logCredentialAudit` uses correct companyId
- [ ] TypeScript compiles without errors
- [ ] Build completes successfully

---

## Phase 5: Final Validation

### Subtask 5.1: Verify No Remaining isPrimary Bugs
**Instructions**:
1. Run `grep -r "isPrimary: true" src/app/api/integrations/` to confirm no remaining bugs in integration routes
2. Expected result: No matches in Shopify routes

**Validation Command**:
```bash
grep -r "isPrimary: true" /home/pbrown/SkuInventory/src/app/api/integrations/
# Expected: No output (no matches)
```

### Subtask 5.2: Full Build Verification
**Instructions**:
1. Run full build to ensure all changes compile correctly
2. Run TypeScript check

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] No `isPrimary: true` in any integration route
- [ ] TypeScript compiles without errors
- [ ] Build completes successfully

---

## Summary of Deliverables

**Files Created**: 0
**Files Modified**: 4
1. `/home/pbrown/SkuInventory/src/app/api/integrations/shopify/status/route.ts`
2. `/home/pbrown/SkuInventory/src/app/api/integrations/shopify/connect/route.ts`
3. `/home/pbrown/SkuInventory/src/app/api/integrations/shopify/sync/route.ts`
4. `/home/pbrown/SkuInventory/src/app/api/integrations/shopify/disconnect/route.ts`

---

## Handoff to Build Agent

1. Execute subtasks in exact order (1.1, 2.1, 3.1, 4.1, 5.1, 5.2)
2. Each file follows the same transformation pattern
3. Use Amazon Ads routes as reference for exact import and code structure
4. Test completion criteria before moving to next subtask
5. After all subtasks complete, verify no `isPrimary: true` remains in integration routes

---

## Test Strategy Note

- No existing unit tests for Shopify integration routes
- Build verification is sufficient for this refactor
- Manual testing optional: Sign in as multi-company user, switch companies, verify Shopify status returns correct company's connection

---

## Performance Metrics

| Phase | Duration |
|-------|----------|
| Investigation | 8m |
| Validation | 3m |
| Planning | 5m |
| **Total** | **16m** |
