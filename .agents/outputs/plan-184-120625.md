# Implementation Plan
**Generated**: 2025-12-06T15:30:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #184
**Estimated Build Time**: 16-24 hours (RECOMMEND PHASING)
**Complexity**: High

## Investigation Summary

### Request Analysis
**Type**: Feature
**Source**: GitHub Issue #184
**Priority**: Medium

**Feature Summary**: Add an embedded chatbot to the inventory tracker that:
1. Is an expert on how the inventory tracker works
2. Answers questions like "why is my max buildable units for AMZ_3pk 234?"
3. Has access to the system architecture and can explain calculations
4. Helps users decide if they need to submit feature requests/bug fixes
5. Admin-only access

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED (affected modules ~5-15 min)
**Suggested Filter**: `--filter="chatbot|assistant"` or None

### Issue Validation
**Status**: Valid - No duplicate or conflicting issues found
**Recent Changes**: Claude AI integration exists (`src/lib/claude.ts`) for feedback system

### Current State Assessment

**Existing AI Integration**:
- `src/lib/claude.ts` - Anthropic SDK already integrated for feedback clarification
- `@anthropic-ai/sdk` (v0.71.0) already installed
- `ANTHROPIC_API_KEY` already in `.env.example`

**Key Services for Chatbot Context**:
- `src/services/bom.ts` - BOM calculations, max buildable units, limiting factors
- `src/services/inventory.ts` - Component quantities, reorder status, transactions
- `src/services/forecast.ts` - Consumption forecasts
- `src/services/finished-goods.ts` - SKU inventory tracking

**Authentication Pattern**:
- NextAuth with JWT strategy
- `session.user.role === 'admin'` check pattern (see `src/app/api/users/route.ts`)
- Admin-only UI items filtered in `src/app/(dashboard)/layout.tsx`

**UI Patterns**:
- `FeedbackDialog.tsx` - Multi-step dialog pattern with AI integration
- `FeedbackButton.tsx` - Header button that opens dialog
- shadcn/ui components: Dialog, Button, ScrollArea, Input, Popover

**Database Schema**:
- No new tables needed for MVP (stateless chat)
- Future: Could add `ChatSession` and `ChatMessage` models for history

### Dependencies & Blockers
1. **ANTHROPIC_API_KEY** - Required for AI features (already documented in .env.example)
2. **Claude SDK** - Already installed (@anthropic-ai/sdk v0.71.0)

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: High
**Effort**: 16-24 hours
**Risk**: Medium (new feature, but builds on existing AI integration)

**Why High Complexity**:
1. Requires rich system context injection for AI to understand inventory tracker
2. Needs real-time data queries (SKUs, components, BOMs) to answer questions
3. Streaming responses for better UX
4. Tool use pattern for Claude to query actual data
5. Admin-only access control

### Patterns Identified
**Primary**: `src/lib/claude.ts` - Claude API integration pattern
**Secondary**: `src/components/features/FeedbackDialog.tsx` - Multi-step dialog with AI
**Tertiary**: `src/app/api/users/route.ts` - Admin-only API route pattern

### Ripple Effect Analysis
**Files Identified**: ~12-15 new/modified files

**New Files**:
- `src/lib/chatbot.ts` - Chatbot service layer
- `src/types/chatbot.ts` - Type definitions
- `src/app/api/chatbot/route.ts` - Chat API endpoint
- `src/components/features/ChatbotButton.tsx` - Header trigger button
- `src/components/features/ChatbotPanel.tsx` - Sliding panel UI
- `src/components/features/ChatMessage.tsx` - Message component

**Modified Files**:
- `src/app/(dashboard)/layout.tsx` - Add ChatbotButton to header
- `src/lib/claude.ts` - Add chatbot functions (or keep separate)

---

## RECOMMENDATION: PHASED IMPLEMENTATION

This feature exceeds 8 hours. Recommend splitting into 3 phases:

### Phase 1: Core Chatbot Infrastructure (8-10 hours)
- Basic chat UI (panel/dialog)
- Static system context (architecture docs)
- Simple Q&A without live data queries
- Admin-only access

### Phase 2: Live Data Integration (6-8 hours)
- Tool use pattern for Claude to query real data
- "Why is my max buildable units X?" answerable
- Component/SKU/BOM lookups

### Phase 3: Enhanced Features (4-6 hours)
- Chat history persistence
- Streaming responses
- Suggested questions
- Feedback submission integration

---

## Executive Summary
This plan covers Phase 1: Building the core chatbot infrastructure with a sliding panel UI, static system context for architecture understanding, and admin-only access control. The chatbot will use Claude API with a rich system prompt describing how the inventory tracker works.

---

## Phase 0: Environment Pre-flight

### Subtask 0.1: Verify Environment Dependencies
**File**: N/A (verification only)
**Instructions**:
1. Verify `ANTHROPIC_API_KEY` is set in environment
2. Verify Claude SDK is available: `npm list @anthropic-ai/sdk`
3. Document fallback behavior (graceful degradation message)

**Completion Criteria**:
- [ ] ANTHROPIC_API_KEY verified
- [ ] Claude SDK version confirmed (^0.71.0)

---

## Phase 1: Type Definitions

### Subtask 1.1: Create Chatbot Types
**File**: `/home/pbrown/SkuInventory/src/types/chatbot.ts`
**Pattern**: Follow `src/types/feedback.ts` structure
**Instructions**:
1. Create new file with:
```typescript
import { z } from 'zod'

// Chat message role
export type ChatRole = 'user' | 'assistant'

// Chat message interface
export interface ChatMessage {
  id: string
  role: ChatRole
  content: string
  timestamp: Date
}

// Chat request schema
export const chatRequestSchema = z.object({
  message: z.string().min(1, 'Message is required').max(2000),
  conversationId: z.string().uuid().optional(), // For future history
})

export type ChatRequestInput = z.infer<typeof chatRequestSchema>

// Chat response interface
export interface ChatResponse {
  message: ChatMessage
  conversationId: string
}
```

**Validation Commands**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] File created at correct path
- [ ] Types compile without errors
- [ ] Follows existing type patterns

---

## Phase 2: Chatbot Service Layer

### Subtask 2.1: Create Chatbot Service
**File**: `/home/pbrown/SkuInventory/src/lib/chatbot.ts`
**Pattern**: Follow `src/lib/claude.ts` structure
**Instructions**:
1. Create new file with chatbot service functions
2. Include rich system prompt describing:
   - How max buildable units are calculated (BOM lines, component quantities)
   - Transaction types (receipt, build, adjustment, transfer, outbound)
   - Component vs SKU relationship
   - Location-based inventory
   - Lot tracking with FEFO
3. Key functions:
   - `getChatbotSystemPrompt()` - Returns rich context about system
   - `sendChatMessage(message: string)` - Sends to Claude, returns response

**Example System Prompt Structure**:
```typescript
const SYSTEM_PROMPT = `You are an expert assistant for the Trevor Inventory Tracker system.

## System Architecture Overview
This is a Next.js 14 inventory management system with:
- Components: Raw materials with quantities tracked via transactions
- SKUs: Finished products with Bills of Materials (BOMs)
- BOMs: Define which components and quantities make up each SKU
- Transactions: Track inventory changes (receipts, builds, adjustments, transfers)
- Locations: Where inventory is stored (warehouse, 3PL, FBA)
- Lots: Batch tracking with expiry dates using FEFO (First Expiry First Out)

## How Max Buildable Units Work
1. Each SKU has an active BOM with component lines
2. Each line specifies componentId and quantityPerUnit
3. For each component: maxBuildable = floor(quantityOnHand / quantityPerUnit)
4. The SKU's maxBuildable = minimum across all components
5. The "limiting component" is whichever has the lowest maxBuildable

## Transaction Types
- receipt: Add inventory from supplier
- build: Consume components to create SKUs (decrements components)
- adjustment: Manual corrections (+/-)
- transfer: Move between locations
- outbound: Ship finished goods

## Common Questions Users Ask
- "Why is my max buildable units X?" -> Explain limiting components
- "How does the build calculation work?" -> Explain BOM consumption
- "Where is my inventory?" -> Explain location tracking

## Your Role
- Answer questions about how the system works
- Explain calculations and business logic
- Help users understand if behavior is correct or a bug
- Guide users on whether to submit feature requests or bug reports
- Be concise but thorough

If you don't know something specific about this user's data, acknowledge that you don't have access to live data in this MVP version.
`
```

**Validation Commands**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Service file created
- [ ] System prompt comprehensive
- [ ] Claude API integration working
- [ ] Error handling for missing API key

---

## Phase 3: API Route

### Subtask 3.1: Create Chatbot API Route
**File**: `/home/pbrown/SkuInventory/src/app/api/chatbot/route.ts`
**Pattern**: Follow `src/app/api/users/route.ts` for admin-only pattern
**Instructions**:
1. Create POST handler for chat messages
2. Admin-only access check
3. Rate limiting (optional for MVP)
4. Call chatbot service

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { getServerSession } from 'next-auth'
import { authOptions } from '@/lib/auth'
import { chatRequestSchema } from '@/types/chatbot'
import { sendChatMessage } from '@/lib/chatbot'

// POST /api/chatbot - Send chat message (admin only)
export async function POST(request: NextRequest) {
  try {
    const session = await getServerSession(authOptions)

    if (!session?.user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    // Admin-only access
    if (session.user.role !== 'admin') {
      return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
    }

    const body = await request.json()
    const validation = chatRequestSchema.safeParse(body)

    if (!validation.success) {
      return NextResponse.json(
        { error: 'Validation failed', details: validation.error.flatten() },
        { status: 400 }
      )
    }

    const { message } = validation.data
    const response = await sendChatMessage(message)

    return NextResponse.json({ data: response })
  } catch (error) {
    console.error('Chatbot error:', error)
    return NextResponse.json(
      { error: 'Failed to process message' },
      { status: 500 }
    )
  }
}
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Route created at correct path
- [ ] Admin-only check working
- [ ] Returns proper response format
- [ ] Error handling complete

---

## Phase 4: UI Components

### Subtask 4.1: Create ChatbotButton Component
**File**: `/home/pbrown/SkuInventory/src/components/features/ChatbotButton.tsx`
**Pattern**: Follow `src/components/features/FeedbackButton.tsx`
**Instructions**:
1. Create button component with MessageCircle icon
2. Admin-only visibility (check session.user.role)
3. onClick handler to open panel

```typescript
'use client'

import { useSession } from 'next-auth/react'
import { Button } from '@/components/ui/button'
import { MessageCircle } from 'lucide-react'

interface ChatbotButtonProps {
  onClick: () => void
}

export function ChatbotButton({ onClick }: ChatbotButtonProps) {
  const { data: session } = useSession()

  // Only show for admins
  if (session?.user?.role !== 'admin') {
    return null
  }

  return (
    <Button
      variant="ghost"
      size="icon"
      onClick={onClick}
      title="Ask the Assistant"
    >
      <MessageCircle className="h-5 w-5" />
    </Button>
  )
}
```

**Completion Criteria**:
- [ ] Component renders only for admins
- [ ] Button styling matches existing UI
- [ ] Click handler works

### Subtask 4.2: Create ChatMessage Component
**File**: `/home/pbrown/SkuInventory/src/components/features/ChatMessage.tsx`
**Pattern**: Simple message bubble component
**Instructions**:
1. Create component for displaying chat messages
2. Different styling for user vs assistant
3. Markdown rendering for assistant messages (optional for MVP)

**Completion Criteria**:
- [ ] Component renders messages correctly
- [ ] Visual distinction between roles
- [ ] Timestamps displayed

### Subtask 4.3: Create ChatbotPanel Component
**File**: `/home/pbrown/SkuInventory/src/components/features/ChatbotPanel.tsx`
**Pattern**: Follow `src/components/features/FeedbackDialog.tsx` but as sliding panel
**Instructions**:
1. Create sliding panel (from right side)
2. Use Dialog or Sheet component from shadcn/ui
3. Include:
   - Header with title and close button
   - Message list with ScrollArea
   - Input field at bottom
   - Send button
4. State management:
   - messages array
   - isLoading state
   - error state

**Key Implementation Notes**:
```typescript
'use client'

import { useState, useRef, useEffect } from 'react'
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { ScrollArea } from '@/components/ui/scroll-area'
import { Loader2, Send } from 'lucide-react'
import { ChatMessage } from './ChatMessage'
import type { ChatMessage as ChatMessageType } from '@/types/chatbot'

interface ChatbotPanelProps {
  open: boolean
  onOpenChange: (open: boolean) => void
}

export function ChatbotPanel({ open, onOpenChange }: ChatbotPanelProps) {
  const [messages, setMessages] = useState<ChatMessageType[]>([])
  const [input, setInput] = useState('')
  const [isLoading, setIsLoading] = useState(false)
  // ... implementation
}
```

**Completion Criteria**:
- [ ] Panel opens/closes smoothly
- [ ] Messages display correctly
- [ ] Input field works
- [ ] Loading states shown
- [ ] Error handling visible

---

## Phase 5: Layout Integration

### Subtask 5.1: Add ChatbotButton and Panel to Dashboard Layout
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/layout.tsx`
**Pattern**: Follow FeedbackButton/FeedbackDialog pattern
**Instructions**:
1. Import ChatbotButton and ChatbotPanel
2. Add state for chatbot panel open/close
3. Add ChatbotButton to header (next to FeedbackButton)
4. Add ChatbotPanel at component tree root

**Changes Required**:
```typescript
// Add imports
import { ChatbotButton } from '@/components/features/ChatbotButton'
import { ChatbotPanel } from '@/components/features/ChatbotPanel'

// Add state
const [chatbotOpen, setChatbotOpen] = useState(false)

// In header, add button (admin-only, component handles visibility)
<ChatbotButton onClick={() => setChatbotOpen(true)} />

// At end of component, add panel
<ChatbotPanel open={chatbotOpen} onOpenChange={setChatbotOpen} />
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
npm run lint
```

**Completion Criteria**:
- [ ] Button appears in header for admin users
- [ ] Button does NOT appear for non-admin users
- [ ] Panel opens when button clicked
- [ ] Panel closes properly
- [ ] No TypeScript errors
- [ ] Build succeeds

---

## Phase 6: Testing & Verification

### Subtask 6.1: Manual Testing Checklist
**Instructions**:
1. Login as admin user
2. Verify ChatbotButton visible in header
3. Click button, verify panel opens
4. Send a test message: "How does max buildable units work?"
5. Verify response received
6. Close panel, verify state resets
7. Login as non-admin user
8. Verify ChatbotButton NOT visible

### Subtask 6.2: Build Verification
**Instructions**:
```bash
npm run build
npx tsc --noEmit
npm run lint
```

**Completion Criteria**:
- [ ] All tests pass
- [ ] Build succeeds
- [ ] No lint errors
- [ ] No TypeScript errors

---

## Summary of Deliverables

**Files Created**: 6
- `/home/pbrown/SkuInventory/src/types/chatbot.ts`
- `/home/pbrown/SkuInventory/src/lib/chatbot.ts`
- `/home/pbrown/SkuInventory/src/app/api/chatbot/route.ts`
- `/home/pbrown/SkuInventory/src/components/features/ChatbotButton.tsx`
- `/home/pbrown/SkuInventory/src/components/features/ChatMessage.tsx`
- `/home/pbrown/SkuInventory/src/components/features/ChatbotPanel.tsx`

**Files Modified**: 1
- `/home/pbrown/SkuInventory/src/app/(dashboard)/layout.tsx`

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 0 -> 1 -> 2 -> 3 -> 4 -> 5 -> 6)
2. Complete each phase fully before moving to next
3. Test completion criteria after each subtask
4. Follow reference patterns exactly
5. Run validation commands after each file change

---

## Future Phases (Not Included in This Plan)

### Phase 2: Live Data Integration
- Add tool use pattern for Claude to query:
  - `get_sku_buildable(skuCode)` - Get max buildable for specific SKU
  - `get_component_quantity(componentCode)` - Get component inventory
  - `get_limiting_factors(skuCode)` - Get limiting components
- Requires new API endpoints or service functions

### Phase 3: Enhanced Features
- Chat history persistence (new database models)
- Streaming responses (SSE or WebSocket)
- Suggested questions based on context
- Direct bug/feature submission from chat

---

## Test Strategy Note
- Use Vitest for unit tests (if added)
- Manual testing sufficient for MVP
- E2E tests with Playwright for Phase 2+

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 25m |
| Validation | 10m |
| Planning | 20m |
| **Total** | **55m** |
