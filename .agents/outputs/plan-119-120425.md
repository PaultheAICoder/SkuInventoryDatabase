# Implementation Plan
**Generated**: 2025-12-04T14:00:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #119
**Estimated Build Time**: 6-8 hours
**Complexity**: Medium

## Investigation Summary

### Request Analysis
**Type**: Feature
**Source**: GitHub Issue #119
**Priority**: High (completes Parent #13 feature set)

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED (affected modules - export routes, forecast service)
**Suggested Filter**: `--filter="forecast|export"` for unit tests

### Issue Validation
**Status**: Valid
**Recent Changes**: Issues #115, #116, #117 have been completed (forecast service, API, page exist)

### Current State Assessment
- **Existing Components**:
  - `src/services/forecast.ts` - Forecast service with consumption rate calculation, runout dates, reorder recommendations (COMPLETE)
  - `src/services/export.ts` - CSV export service with `toCSV()` utility and column definitions for components, SKUs, transactions, lots
  - `src/app/api/forecasts/route.ts` - GET /api/forecasts endpoint with pagination, sorting, filtering
  - `src/app/api/forecasts/config/route.ts` - GET/PUT /api/forecasts/config endpoints
  - `src/app/(dashboard)/forecasts/page.tsx` - Forecast dashboard page with stats cards and ForecastTable
  - `src/components/features/ForecastTable.tsx` - Forecast data table with sorting, filtering, pagination
  - `src/components/features/ForecastQuickSettings.tsx` - Settings bar with lookback selector and settings button
  - `tests/unit/forecast-service.test.ts` - Unit tests for forecast service functions (ALREADY EXISTS - 504 lines)

- **Missing Components**:
  - Export route for forecasts (`src/app/api/export/forecasts/route.ts`)
  - Export button on forecast page
  - Forecast export columns in export service
  - API integration tests for forecast endpoints
  - E2E tests for forecast page

- **Database**: ForecastConfig model exists in schema; no additional migrations needed

- **API Routes**: Export routes follow consistent pattern in `src/app/api/export/*/route.ts`

- **Types**: `ComponentForecastResponse` in `src/types/forecast.ts` contains all needed fields

### Dependencies & Blockers
1. **Dependencies Complete**: Issues #115, #116, #117 are complete
2. **No Blockers**: All prerequisite functionality exists

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Medium
**Effort**: 6-8 hours
**Risk**: Low (follows established patterns)

### Patterns Identified
**Primary**: `src/app/api/export/components/route.ts` - Export route pattern with:
  - Session authentication check
  - Company scoping via `session.user.selectedCompanyId`
  - Transform data to export format
  - CSV generation with `toCSV()`
  - Content-Disposition header for download

**Secondary**: `tests/integration/import-export.test.ts` - Integration test pattern for export APIs

### Ripple Effect Analysis
**Files Identified**: 5 files to create, 2 files to modify

**Files to Create**:
1. `src/app/api/export/forecasts/route.ts` - Export endpoint
2. `tests/integration/forecasts.test.ts` - API integration tests
3. `tests/e2e/forecasts.spec.ts` - E2E tests

**Files to Modify**:
1. `src/services/export.ts` - Add forecast export columns and types
2. `src/components/features/ForecastQuickSettings.tsx` - Add export button

---

## Executive Summary

This issue adds CSV export functionality for the forecast dashboard and comprehensive test coverage for all forecast-related functionality. The implementation creates an export endpoint at `/api/export/forecasts`, adds an export button to the forecast page UI, and creates integration and E2E tests to ensure production readiness.

## Phase 1: Export Service Extension

### Subtask 1.1: Add Forecast Export Types and Columns
**File**: `/home/pbrown/SkuInventory/src/services/export.ts`
**Pattern**: Follow existing `ComponentExportData` and `componentExportColumns` structure (lines 55-87)
**Instructions**:
1. Add `ForecastExportData` interface after line 206:
```typescript
/**
 * Forecast export columns definition
 */
export interface ForecastExportData {
  componentName: string
  skuCode: string
  category: string | null
  quantityOnHand: number
  dailyConsumption: string
  daysUntilRunout: number | null
  runoutDate: string | null
  recommendedReorderQty: number
  reorderByDate: string | null
  leadTimeDays: number
  status: string  // 'critical' | 'warning' | 'ok' | 'na'
  lookbackDays: number
  safetyDays: number
}

export const forecastExportColumns: CSVColumn<ForecastExportData>[] = [
  { header: 'Component Name', accessor: (f) => f.componentName },
  { header: 'SKU Code', accessor: (f) => f.skuCode },
  { header: 'Category', accessor: (f) => f.category },
  { header: 'On-Hand Qty', accessor: (f) => f.quantityOnHand },
  { header: 'Daily Consumption', accessor: (f) => f.dailyConsumption },
  { header: 'Days Until Runout', accessor: (f) => f.daysUntilRunout },
  { header: 'Runout Date', accessor: (f) => f.runoutDate },
  { header: 'Recommended Reorder Qty', accessor: (f) => f.recommendedReorderQty },
  { header: 'Reorder By Date', accessor: (f) => f.reorderByDate },
  { header: 'Lead Time (Days)', accessor: (f) => f.leadTimeDays },
  { header: 'Status', accessor: (f) => f.status },
  { header: 'Lookback Days', accessor: (f) => f.lookbackDays },
  { header: 'Safety Days', accessor: (f) => f.safetyDays },
]
```

2. Update `generateExportFilename` function to include 'forecasts' type:
```typescript
export function generateExportFilename(
  type: 'components' | 'skus' | 'transactions' | 'lots' | 'forecasts'
): string {
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] `ForecastExportData` interface defined
- [ ] `forecastExportColumns` array defined with all 13 columns
- [ ] `generateExportFilename` accepts 'forecasts' type
- [ ] TypeScript compiles without errors

## Phase 2: API Route

### Subtask 2.1: Create Forecast Export Route
**File**: `/home/pbrown/SkuInventory/src/app/api/export/forecasts/route.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/app/api/export/components/route.ts`
**Instructions**:
1. Create new file with structure:
```typescript
import { NextRequest, NextResponse } from 'next/server'
import { getServerSession } from 'next-auth'
import { authOptions } from '@/lib/auth'
import { prisma } from '@/lib/db'
import { unauthorized, serverError } from '@/lib/api-response'
import { getComponentForecasts, getForecastConfig } from '@/services/forecast'
import {
  toCSV,
  forecastExportColumns,
  generateExportFilename,
  type ForecastExportData,
} from '@/services/export'

/**
 * Determine forecast status from consumption and reorder date
 */
function getForecastStatusString(
  dailyConsumption: number,
  recommendedReorderDate: Date | null
): string {
  if (dailyConsumption <= 0) return 'na'
  if (!recommendedReorderDate) return 'ok'

  const now = new Date()
  const reorderDate = new Date(recommendedReorderDate)
  const daysUntilReorder = Math.floor(
    (reorderDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24)
  )

  if (daysUntilReorder <= 0) return 'critical'
  if (daysUntilReorder <= 7) return 'warning'
  return 'ok'
}

// GET /api/export/forecasts - Export all forecasts to CSV
export async function GET(request: NextRequest) {
  try {
    const session = await getServerSession(authOptions)
    if (!session?.user) {
      return unauthorized()
    }

    const selectedCompanyId = session.user.selectedCompanyId

    // Parse optional query params for config override
    const { searchParams } = new URL(request.url)
    const lookbackDays = searchParams.get('lookbackDays')
      ? parseInt(searchParams.get('lookbackDays')!, 10)
      : undefined
    const safetyDays = searchParams.get('safetyDays')
      ? parseInt(searchParams.get('safetyDays')!, 10)
      : undefined

    // Build config override if query params provided
    const configOverride: { lookbackDays?: number; safetyDays?: number } = {}
    if (lookbackDays !== undefined) configOverride.lookbackDays = lookbackDays
    if (safetyDays !== undefined) configOverride.safetyDays = safetyDays

    // Get forecasts with optional config override
    const forecasts = await getComponentForecasts(
      selectedCompanyId,
      Object.keys(configOverride).length > 0 ? configOverride : undefined
    )

    // Get component categories for export
    const componentIds = forecasts.map((f) => f.componentId)
    const components = await prisma.component.findMany({
      where: { id: { in: componentIds } },
      select: { id: true, category: true },
    })
    const categoryMap = new Map(components.map((c) => [c.id, c.category]))

    // Transform to export format
    const exportData: ForecastExportData[] = forecasts.map((forecast) => ({
      componentName: forecast.componentName,
      skuCode: forecast.skuCode,
      category: categoryMap.get(forecast.componentId) ?? null,
      quantityOnHand: forecast.quantityOnHand,
      dailyConsumption: forecast.averageDailyConsumption.toFixed(4),
      daysUntilRunout: forecast.daysUntilRunout,
      runoutDate: forecast.runoutDate?.toISOString().split('T')[0] ?? null,
      recommendedReorderQty: forecast.recommendedReorderQty,
      reorderByDate: forecast.recommendedReorderDate?.toISOString().split('T')[0] ?? null,
      leadTimeDays: forecast.leadTimeDays,
      status: getForecastStatusString(
        forecast.averageDailyConsumption,
        forecast.recommendedReorderDate
      ),
      lookbackDays: forecast.assumptions.lookbackDays,
      safetyDays: forecast.assumptions.safetyDays,
    }))

    // Generate CSV
    const csv = toCSV(exportData, forecastExportColumns)

    return new NextResponse(csv, {
      headers: {
        'Content-Type': 'text/csv',
        'Content-Disposition': `attachment; filename="${generateExportFilename('forecasts')}"`,
      },
    })
  } catch (error) {
    console.error('Error exporting forecasts:', error)
    return serverError()
  }
}
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Route file created at correct path
- [ ] Authentication check implemented
- [ ] Forecasts fetched using `getComponentForecasts()`
- [ ] Component categories included in export
- [ ] CSV generated with correct columns
- [ ] Content-Disposition header includes correct filename format
- [ ] Query params for lookbackDays/safetyDays supported
- [ ] TypeScript compiles without errors
- [ ] Build passes

## Phase 3: Frontend UI

### Subtask 3.1: Add Export Button to Forecast Quick Settings
**File**: `/home/pbrown/SkuInventory/src/components/features/ForecastQuickSettings.tsx`
**Pattern**: Follow existing button structure in the component
**Instructions**:
1. Add Download icon import:
```typescript
import { Settings2, Download } from 'lucide-react'
```

2. Add `onExport` prop to interface:
```typescript
interface ForecastQuickSettingsProps {
  config: ForecastConfigResponse | null
  onLookbackChange: (days: number) => void
  onOpenSettings: () => void
  onExport: () => void  // NEW
  disabled?: boolean
  canEdit?: boolean
}
```

3. Destructure new prop:
```typescript
export function ForecastQuickSettings({
  config,
  onLookbackChange,
  onOpenSettings,
  onExport,  // NEW
  disabled = false,
  canEdit = false,
}: ForecastQuickSettingsProps) {
```

4. Add Export button before Settings button (inside the same div, before the Settings button):
```typescript
      {/* Export Button - always visible */}
      <Button
        variant="outline"
        size="sm"
        onClick={onExport}
        disabled={disabled}
        className={canEdit ? '' : 'ml-auto'}
      >
        <Download className="mr-2 h-4 w-4" />
        Export
      </Button>

      {/* Settings Button (Admin only) */}
      {canEdit && (
        <Button
```

5. Remove `ml-auto` from Settings button since Export button now handles positioning conditionally

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Download icon imported
- [ ] onExport prop added to interface
- [ ] Export button visible for all users
- [ ] Export button triggers onExport callback
- [ ] Settings button still only shows for admins
- [ ] TypeScript compiles without errors

### Subtask 3.2: Wire Export Functionality in Forecast Page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/forecasts/page.tsx`
**Pattern**: Follow existing handler patterns in the file
**Instructions**:
1. Add handleExport function after handleConfigSaved (around line 119):
```typescript
  // Handle export button click
  const handleExport = () => {
    // Build export URL with current lookback if overridden
    const params = new URLSearchParams()
    const lookbackDays = searchParams.get('lookbackDays')
    if (lookbackDays) {
      params.set('lookbackDays', lookbackDays)
    }
    const queryString = params.toString()
    const exportUrl = `/api/export/forecasts${queryString ? `?${queryString}` : ''}`

    // Trigger download
    window.location.href = exportUrl
  }
```

2. Pass handleExport to ForecastQuickSettings component (around line 184):
```typescript
        <ForecastQuickSettings
          config={config}
          onLookbackChange={handleLookbackChange}
          onOpenSettings={() => setSettingsOpen(true)}
          onExport={handleExport}  // NEW
          disabled={isLoading}
          canEdit={canEdit}
        />
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] handleExport function implemented
- [ ] Export URL includes current lookbackDays override if set
- [ ] onExport passed to ForecastQuickSettings
- [ ] TypeScript compiles without errors
- [ ] Build passes

## Phase 4: Integration Tests

### Subtask 4.1: Create Forecast API Integration Tests
**File**: `/home/pbrown/SkuInventory/tests/integration/forecasts.test.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/tests/integration/import-export.test.ts`
**Instructions**:
Create integration tests for all forecast API endpoints:

```typescript
/**
 * Integration tests for Forecast API
 * Tests GET /api/forecasts, GET /api/forecasts/config, PUT /api/forecasts/config,
 * and GET /api/export/forecasts
 */
import { describe, it, expect, beforeAll, beforeEach, afterAll } from 'vitest'
import { setTestSession, clearTestSession, TEST_SESSIONS, initializeTestSessions } from '../helpers/auth-mock'
import {
  getIntegrationPrisma,
  cleanupBeforeTest,
  createTestRequest,
  createTestComponentInDb,
} from '../helpers/integration-context'
import { disconnectTestDb } from '../helpers/db'

// Import route handlers directly
import { GET as getForecasts } from '@/app/api/forecasts/route'
import { GET as getConfig, PUT as putConfig } from '@/app/api/forecasts/config/route'
import { GET as exportForecasts } from '@/app/api/export/forecasts/route'

describe('Forecast API', () => {
  beforeAll(async () => {
    const prisma = getIntegrationPrisma()
    await initializeTestSessions(prisma)
  })

  beforeEach(async () => {
    await cleanupBeforeTest()
    clearTestSession()
  })

  afterAll(async () => {
    await disconnectTestDb()
  })

  describe('GET /api/forecasts', () => {
    it('returns paginated forecast list for authenticated user', async () => {
      setTestSession(TEST_SESSIONS.admin!)
      await createTestComponentInDb(TEST_SESSIONS.admin!.user.companyId)

      const response = await getForecasts(createTestRequest('/api/forecasts'))
      const json = await response.json()

      expect(response.status).toBe(200)
      expect(json.data).toBeDefined()
      expect(Array.isArray(json.data)).toBe(true)
      expect(json.meta).toBeDefined()
      expect(json.meta.total).toBeGreaterThanOrEqual(0)
      expect(json.meta.page).toBe(1)
    })

    it('returns 401 for unauthenticated request', async () => {
      clearTestSession()

      const response = await getForecasts(createTestRequest('/api/forecasts'))

      expect(response.status).toBe(401)
    })

    it('applies sorting by runoutDate', async () => {
      setTestSession(TEST_SESSIONS.admin!)

      const response = await getForecasts(
        createTestRequest('/api/forecasts', {
          searchParams: { sortBy: 'runoutDate', sortOrder: 'asc' },
        })
      )

      expect(response.status).toBe(200)
    })

    it('filters by showOnlyAtRisk when enabled', async () => {
      setTestSession(TEST_SESSIONS.admin!)

      const response = await getForecasts(
        createTestRequest('/api/forecasts', {
          searchParams: { showOnlyAtRisk: 'true' },
        })
      )
      const json = await response.json()

      expect(response.status).toBe(200)
      expect(Array.isArray(json.data)).toBe(true)
    })

    it('respects lookbackDays override', async () => {
      setTestSession(TEST_SESSIONS.admin!)

      const response = await getForecasts(
        createTestRequest('/api/forecasts', {
          searchParams: { lookbackDays: '60' },
        })
      )
      const json = await response.json()

      expect(response.status).toBe(200)
      // If data exists, check assumptions
      if (json.data.length > 0) {
        expect(json.data[0].assumptions.lookbackDays).toBe(60)
      }
    })
  })

  describe('GET /api/forecasts/config', () => {
    it('returns config for authenticated user', async () => {
      setTestSession(TEST_SESSIONS.admin!)

      const response = await getConfig()
      const json = await response.json()

      expect(response.status).toBe(200)
      expect(json.data).toBeDefined()
      expect(json.data.lookbackDays).toBeDefined()
      expect(json.data.safetyDays).toBeDefined()
    })

    it('returns default values when no config exists', async () => {
      setTestSession(TEST_SESSIONS.admin!)

      const response = await getConfig()
      const json = await response.json()

      expect(response.status).toBe(200)
      // Default values from DEFAULT_FORECAST_CONFIG
      expect(json.data.lookbackDays).toBe(30)
      expect(json.data.safetyDays).toBe(7)
    })

    it('returns 401 for unauthenticated request', async () => {
      clearTestSession()

      const response = await getConfig()

      expect(response.status).toBe(401)
    })
  })

  describe('PUT /api/forecasts/config', () => {
    it('updates config for admin user', async () => {
      setTestSession(TEST_SESSIONS.admin!)

      const request = createTestRequest('/api/forecasts/config', {
        method: 'PATCH', // Note: createTestRequest uses method prop
        body: { lookbackDays: 45, safetyDays: 10 },
      })
      // Override method to PUT
      const putRequest = new Request(request.url, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ lookbackDays: 45, safetyDays: 10 }),
      })

      const response = await putConfig(putRequest as never)
      const json = await response.json()

      expect(response.status).toBe(200)
      expect(json.data.config.lookbackDays).toBe(45)
      expect(json.data.config.safetyDays).toBe(10)
    })

    it('returns 403 for non-admin user', async () => {
      setTestSession(TEST_SESSIONS.viewer!)

      const putRequest = new Request('http://localhost/api/forecasts/config', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ lookbackDays: 45 }),
      })

      const response = await putConfig(putRequest as never)

      expect(response.status).toBe(403)
    })

    it('validates input values', async () => {
      setTestSession(TEST_SESSIONS.admin!)

      const putRequest = new Request('http://localhost/api/forecasts/config', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ lookbackDays: 5 }), // Below minimum of 7
      })

      const response = await putConfig(putRequest as never)

      expect(response.status).toBe(400)
    })
  })

  describe('GET /api/export/forecasts', () => {
    it('returns CSV file for authenticated user', async () => {
      setTestSession(TEST_SESSIONS.admin!)

      const response = await exportForecasts(createTestRequest('/api/export/forecasts'))

      expect(response.status).toBe(200)
      expect(response.headers.get('content-type')).toBe('text/csv')
      expect(response.headers.get('content-disposition')).toContain('forecasts-export')
    })

    it('returns 401 for unauthenticated request', async () => {
      clearTestSession()

      const response = await exportForecasts(createTestRequest('/api/export/forecasts'))

      expect(response.status).toBe(401)
    })

    it('CSV contains expected headers', async () => {
      setTestSession(TEST_SESSIONS.admin!)
      await createTestComponentInDb(TEST_SESSIONS.admin!.user.companyId)

      const response = await exportForecasts(createTestRequest('/api/export/forecasts'))
      const csv = await response.text()

      expect(csv).toContain('Component Name')
      expect(csv).toContain('SKU Code')
      expect(csv).toContain('Daily Consumption')
      expect(csv).toContain('Runout Date')
      expect(csv).toContain('Recommended Reorder Qty')
      expect(csv).toContain('Status')
      expect(csv).toContain('Lookback Days')
      expect(csv).toContain('Safety Days')
    })

    it('respects lookbackDays query parameter', async () => {
      setTestSession(TEST_SESSIONS.admin!)
      await createTestComponentInDb(TEST_SESSIONS.admin!.user.companyId)

      const response = await exportForecasts(
        createTestRequest('/api/export/forecasts', {
          searchParams: { lookbackDays: '60' },
        })
      )
      const csv = await response.text()

      expect(response.status).toBe(200)
      // Check CSV contains lookback value in data
      expect(csv).toContain('60')
    })

    it('viewer can export forecasts', async () => {
      setTestSession(TEST_SESSIONS.viewer!)

      const response = await exportForecasts(createTestRequest('/api/export/forecasts'))

      expect(response.status).toBe(200)
      expect(response.headers.get('content-type')).toBe('text/csv')
    })
  })
})
```

**Validation**:
```bash
npm run test:integration -- --filter="forecasts"
```

**Completion Criteria**:
- [ ] Tests for GET /api/forecasts (list, pagination, sorting, filtering)
- [ ] Tests for GET /api/forecasts/config (authenticated, defaults)
- [ ] Tests for PUT /api/forecasts/config (admin only, validation)
- [ ] Tests for GET /api/export/forecasts (CSV, headers, auth)
- [ ] All integration tests pass

## Phase 5: E2E Tests

### Subtask 5.1: Create Forecast Page E2E Tests
**File**: `/home/pbrown/SkuInventory/tests/e2e/forecasts.spec.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/tests/e2e/full-workflow.spec.ts`
**Instructions**:
Create E2E tests for forecast page functionality:

```typescript
import { test, expect } from '@playwright/test'

/**
 * Forecast Page E2E Tests
 * Tests the forecast dashboard UI, sorting, filtering, and export functionality
 */
test.describe('Forecast Page', () => {
  test.beforeEach(async ({ page }) => {
    // Login as admin
    await page.goto('/login')
    await page.waitForSelector('#email', { timeout: 10000 })
    await page.fill('#email', 'admin@tonsil.tech')
    await page.fill('#password', 'changeme123')
    await page.click('button[type="submit"]')
    await page.waitForURL('/', { timeout: 15000 })
  })

  test('Forecast page loads and displays data', async ({ page }) => {
    await page.goto('/forecasts')
    await page.waitForLoadState('networkidle')

    // Verify page header
    await expect(page.locator('h1')).toContainText('Forecasts')

    // Verify stats cards are visible
    await expect(page.locator('text=Total Components')).toBeVisible()
    await expect(page.locator('text=Critical')).toBeVisible()
    await expect(page.locator('text=Warning')).toBeVisible()

    // Verify table is rendered
    await expect(page.locator('table')).toBeVisible()
  })

  test('Forecast table displays correct columns', async ({ page }) => {
    await page.goto('/forecasts')
    await page.waitForSelector('table', { timeout: 10000 })

    // Verify column headers
    const headers = page.locator('table thead th')
    await expect(headers.filter({ hasText: 'Component Name' })).toBeVisible()
    await expect(headers.filter({ hasText: 'SKU Code' })).toBeVisible()
    await expect(headers.filter({ hasText: 'On-Hand Qty' })).toBeVisible()
    await expect(headers.filter({ hasText: 'Daily Consumption' })).toBeVisible()
  })

  test('Sorting by columns works', async ({ page }) => {
    await page.goto('/forecasts')
    await page.waitForSelector('table', { timeout: 10000 })

    // Click on Component Name header to sort
    await page.click('button:has-text("Component Name")')
    await page.waitForLoadState('networkidle')

    // URL should include sortBy parameter
    expect(page.url()).toContain('sortBy=name')

    // Click again to reverse sort order
    await page.click('button:has-text("Component Name")')
    await page.waitForLoadState('networkidle')

    expect(page.url()).toContain('sortOrder=desc')
  })

  test('Show only at-risk filter works', async ({ page }) => {
    await page.goto('/forecasts')
    await page.waitForSelector('table', { timeout: 10000 })

    // Find and click the checkbox
    const checkbox = page.locator('#showOnlyAtRisk')
    await checkbox.click()
    await page.waitForLoadState('networkidle')

    // URL should include filter
    expect(page.url()).toContain('showOnlyAtRisk=true')

    // Uncheck
    await checkbox.click()
    await page.waitForLoadState('networkidle')

    expect(page.url()).not.toContain('showOnlyAtRisk=true')
  })

  test('Lookback selector changes forecast data', async ({ page }) => {
    await page.goto('/forecasts')
    await page.waitForLoadState('networkidle')

    // Find lookback selector and change value
    await page.click('button:has-text("30 days")')
    await page.click('text=60 days')
    await page.waitForLoadState('networkidle')

    // URL should include lookbackDays
    expect(page.url()).toContain('lookbackDays=60')
  })

  test('Export button downloads CSV file', async ({ page }) => {
    await page.goto('/forecasts')
    await page.waitForLoadState('networkidle')

    // Set up download listener
    const [download] = await Promise.all([
      page.waitForEvent('download'),
      page.click('button:has-text("Export")'),
    ])

    // Verify download
    const filename = download.suggestedFilename()
    expect(filename).toMatch(/forecasts-export-\d{4}-\d{2}-\d{2}\.csv/)
  })

  test('Settings dialog opens for admin', async ({ page }) => {
    await page.goto('/forecasts')
    await page.waitForLoadState('networkidle')

    // Click Settings button
    await page.click('button:has-text("Settings")')

    // Dialog should appear
    await expect(page.locator('role=dialog')).toBeVisible()
    await expect(page.locator('text=Forecast Settings')).toBeVisible()
  })

  test('Settings dialog saves configuration', async ({ page }) => {
    await page.goto('/forecasts')
    await page.waitForLoadState('networkidle')

    // Open settings
    await page.click('button:has-text("Settings")')
    await expect(page.locator('role=dialog')).toBeVisible()

    // Find safety days input and change it
    const safetyInput = page.locator('input[name="safetyDays"]')
    if (await safetyInput.isVisible()) {
      await safetyInput.clear()
      await safetyInput.fill('14')

      // Save
      await page.click('button:has-text("Save")')

      // Dialog should close
      await expect(page.locator('role=dialog')).not.toBeVisible()
    }
  })
})

test.describe('Forecast Export API', () => {
  test.beforeEach(async ({ page }) => {
    // Login as admin
    await page.goto('/login')
    await page.waitForSelector('#email', { timeout: 10000 })
    await page.fill('#email', 'admin@tonsil.tech')
    await page.fill('#password', 'changeme123')
    await page.click('button[type="submit"]')
    await page.waitForURL('/', { timeout: 15000 })
  })

  test('Export forecasts returns CSV', async ({ page }) => {
    const response = await page.request.get('/api/export/forecasts')
    expect(response.status()).toBe(200)
    expect(response.headers()['content-type']).toContain('text/csv')
  })

  test('Export forecasts respects lookback parameter', async ({ page }) => {
    const response = await page.request.get('/api/export/forecasts?lookbackDays=60')
    expect(response.status()).toBe(200)

    const csv = await response.text()
    expect(csv).toContain('60') // Lookback days column value
  })
})
```

**Validation**:
```bash
npm run test:e2e -- tests/e2e/forecasts.spec.ts
```

**Completion Criteria**:
- [ ] Test: Forecast page loads and displays data
- [ ] Test: Forecast table displays correct columns
- [ ] Test: Sorting by columns works
- [ ] Test: Show only at-risk filter works
- [ ] Test: Lookback selector changes forecast data
- [ ] Test: Export button downloads CSV file
- [ ] Test: Settings dialog opens for admin
- [ ] Test: Settings dialog saves configuration
- [ ] Test: Export API returns CSV
- [ ] All E2E tests pass

## Phase 6: Verification

### Subtask 6.1: Run All Tests and Build
**Instructions**:
1. Run unit tests:
```bash
npm test -- --filter="forecast|export"
```

2. Run integration tests:
```bash
npm run test:integration -- --filter="forecast"
```

3. Run E2E tests:
```bash
npm run test:e2e -- tests/e2e/forecasts.spec.ts
```

4. Run full test suite:
```bash
npm run test:all
```

5. Verify build:
```bash
npm run build
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] All unit tests pass
- [ ] All integration tests pass
- [ ] All E2E tests pass
- [ ] Build completes without errors
- [ ] TypeScript type checking passes

---

## Summary of Deliverables
**Files Created**: 3
- `/home/pbrown/SkuInventory/src/app/api/export/forecasts/route.ts`
- `/home/pbrown/SkuInventory/tests/integration/forecasts.test.ts`
- `/home/pbrown/SkuInventory/tests/e2e/forecasts.spec.ts`

**Files Modified**: 3
- `/home/pbrown/SkuInventory/src/services/export.ts` - Add ForecastExportData and forecastExportColumns
- `/home/pbrown/SkuInventory/src/components/features/ForecastQuickSettings.tsx` - Add Export button
- `/home/pbrown/SkuInventory/src/app/(dashboard)/forecasts/page.tsx` - Wire export functionality

## Handoff to Build Agent
1. Execute subtasks in exact order (Phase 1 -> Phase 2 -> Phase 3 -> Phase 4 -> Phase 5 -> Phase 6)
2. Run TypeScript check (`npx tsc --noEmit`) after each file modification
3. Test completion criteria before moving to next subtask
4. Follow reference patterns exactly

## Test Strategy Note
- Use Vitest for unit tests and integration tests
- Use Playwright for E2E tests
- Existing forecast service tests in `tests/unit/forecast-service.test.ts` already cover unit test requirements (504 lines)
- Focus new testing on integration (API routes) and E2E (UI workflows)

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 20m |
| **Total** | **40m** |
