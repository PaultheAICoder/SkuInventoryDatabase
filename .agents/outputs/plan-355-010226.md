# Implementation Plan
**Generated**: 2026-01-02T10:30:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #355
**Estimated Build Time**: 6-8 hours
**Complexity**: Moderate

## Investigation Summary

### Request Analysis
**Type**: Feature
**Source**: GitHub Issue #355 - [Rec Engine] Keyword graduation algorithm and recommendations
**Priority**: P1-MVP

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="keyword-graduation"` or `--filter="recommendations"`

### Issue Validation
**Status**: Valid
**Recent Changes**: Issue #354 completed - database schema and types setup
**Dependencies Met**: Prisma models (Recommendation, ChangeLogEntry, WatchedKeyword), TypeScript types (`src/types/recommendations.ts`), and utilities (`src/lib/recommendation-utils.ts`) are already in place.

### Current State Assessment
- **Existing components**:
  - Prisma schema: `Recommendation`, `ChangeLogEntry`, `WatchedKeyword` models exist
  - Types: `src/types/recommendations.ts` fully defined
  - Utilities: `src/lib/recommendation-utils.ts` with threshold merging, snooze calculations
  - KeywordMetric model with performance data (ACOS, spend, orders, etc.)
  - AdCampaign model with campaign names and types
- **Database**: Models exist, no migration needed
- **API Routes**: No recommendation API routes exist yet
- **Types**: Complete recommendation types defined

### Dependencies & Blockers
1. None - all dependencies from Issue #354 are complete

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Moderate
**Effort**: 6-8 hours
**Risk**: Low

### Patterns Identified
**Primary**: `src/services/attribution/amazon-attribution.ts` - Service pattern with pure calculation functions
**Secondary**: `tests/unit/attribution-service.test.ts` - Unit test pattern for calculation functions

### Ripple Effect Analysis
**Files Identified**: 0 (new feature, no existing code affected)
- New files only - no ripple effects

### Campaign Classification Notes
The spec mentions "Discovery" and "Accelerate" campaigns. Based on investigation:
- No dedicated `campaignCategory` field exists in AdCampaign
- Classification will be based on campaign name patterns (common convention)
- Examples: "Discovery - [keyword]", "[Brand] Accelerate", etc.
- The `keyword-graduation.ts` helper will implement name-based classification

---

## Executive Summary
Implement the core keyword graduation algorithm that analyzes KeywordMetric data to identify high-performing keywords in Discovery campaigns ready for graduation to Accelerate campaigns. This includes campaign classification helpers, graduation threshold checking, recommendation generation with rationale, and confidence scoring based on data volume. The service follows the existing pattern in `amazon-attribution.ts` with pure calculation functions for easy testing.

## Phase 1: Campaign Classification Helper
### Subtask 1.1: Create keyword-graduation.ts with campaign classification
**File**: `src/services/recommendations/keyword-graduation.ts`
**Pattern**: Follow `src/services/attribution/amazon-attribution.ts` structure
**Instructions**:
1. Create new directory: `src/services/recommendations/`
2. Create `keyword-graduation.ts` with the following exports:

```typescript
/**
 * Campaign type classification based on name patterns
 */
export type CampaignCategory = 'discovery' | 'accelerate' | 'unknown'

/**
 * Classify campaign by name pattern
 * Discovery: contains "discovery", "research", "auto" (targeting type)
 * Accelerate: contains "accelerate", "exact", "scale"
 */
export function classifyCampaign(campaignName: string, targetingType?: string): CampaignCategory

/**
 * Check if a campaign is a Discovery campaign
 */
export function isDiscoveryCampaign(campaignName: string, targetingType?: string): boolean

/**
 * Check if a campaign is an Accelerate campaign
 */
export function isAccelerateCampaign(campaignName: string, targetingType?: string): boolean
```

3. Implement case-insensitive pattern matching
4. Consider `targetingType: 'auto'` as Discovery indicator

**Completion Criteria**:
- [ ] File created at `src/services/recommendations/keyword-graduation.ts`
- [ ] Three exported functions: `classifyCampaign`, `isDiscoveryCampaign`, `isAccelerateCampaign`
- [ ] `npx tsc --noEmit` passes
- [ ] Functions are pure (no side effects, no database calls)

## Phase 2: Graduation Threshold Check
### Subtask 2.1: Add graduation threshold check functions
**File**: `src/services/recommendations/keyword-graduation.ts` (append)
**Pattern**: Follow threshold constants from `src/lib/recommendation-utils.ts`
**Instructions**:
1. Add interface for aggregated keyword metrics:

```typescript
/**
 * Aggregated keyword metrics for graduation analysis
 */
export interface KeywordMetricsAggregate {
  keyword: string
  campaignId: string
  campaignName: string
  matchType: string
  totalSpend: number      // Sum of spend over period
  totalOrders: number     // Sum of orders (conversions) over period
  totalSales: number      // Sum of sales over period
  totalImpressions: number
  totalClicks: number
  acos: number            // Calculated: spend / sales
  dataPoints: number      // Number of days with data (for confidence)
}
```

2. Add graduation check function:

```typescript
import type { RequiredThresholds } from '@/lib/recommendation-utils'

/**
 * Check if a keyword meets graduation thresholds
 * Thresholds: ACOS < 25%, conversions >= 5, spend >= $50
 */
export function meetsGraduationThresholds(
  metrics: KeywordMetricsAggregate,
  thresholds: RequiredThresholds
): boolean

/**
 * Get detailed graduation eligibility with which criteria pass/fail
 */
export interface GraduationEligibility {
  eligible: boolean
  acosBelowThreshold: boolean
  meetsConversionMin: boolean
  meetsSpendMin: boolean
  metrics: {
    currentAcos: number
    currentConversions: number
    currentSpend: number
  }
  thresholds: {
    maxAcos: number
    minConversions: number
    minSpend: number
  }
}

export function getGraduationEligibility(
  metrics: KeywordMetricsAggregate,
  thresholds: RequiredThresholds
): GraduationEligibility
```

**Completion Criteria**:
- [ ] `KeywordMetricsAggregate` interface defined
- [ ] `meetsGraduationThresholds` function implemented
- [ ] `GraduationEligibility` interface and `getGraduationEligibility` function implemented
- [ ] Uses thresholds from `RequiredThresholds` type
- [ ] `npx tsc --noEmit` passes

## Phase 3: Confidence Scoring
### Subtask 3.1: Create confidence-scoring.ts
**File**: `src/services/recommendations/confidence-scoring.ts`
**Pattern**: Follow pure function pattern from attribution service
**Instructions**:
1. Create confidence scoring module:

```typescript
import type { ConfidenceLevel } from '@/types/recommendations'

/**
 * Data quality metrics for confidence calculation
 */
export interface DataQualityMetrics {
  dataPoints: number          // Number of days with data
  impressions: number         // Total impressions (sample size)
  conversionVariance?: number // Optional: variance in daily conversions
  daysSpan: number           // Days between first and last data point
}

/**
 * Calculate confidence level based on data volume and consistency
 *
 * HIGH: 30+ days of data, 1000+ impressions
 * MEDIUM: 14-29 days of data, 500+ impressions
 * LOW: <14 days or <500 impressions
 */
export function calculateConfidence(metrics: DataQualityMetrics): ConfidenceLevel

/**
 * Get confidence thresholds for documentation
 */
export const CONFIDENCE_THRESHOLDS = {
  HIGH: { minDays: 30, minImpressions: 1000 },
  MEDIUM: { minDays: 14, minImpressions: 500 },
  LOW: { minDays: 0, minImpressions: 0 },
}

/**
 * Calculate data quality score (0-100) for more granular assessment
 */
export function calculateDataQualityScore(metrics: DataQualityMetrics): number
```

**Completion Criteria**:
- [ ] File created at `src/services/recommendations/confidence-scoring.ts`
- [ ] `calculateConfidence` returns 'HIGH', 'MEDIUM', or 'LOW'
- [ ] `CONFIDENCE_THRESHOLDS` constants exported
- [ ] `calculateDataQualityScore` provides numeric score
- [ ] `npx tsc --noEmit` passes

## Phase 4: Recommendation Generator
### Subtask 4.1: Add graduation recommendation generator to keyword-graduation.ts
**File**: `src/services/recommendations/keyword-graduation.ts` (append)
**Pattern**: Follow recommendation types from `src/types/recommendations.ts`
**Instructions**:
1. Add recommendation generation types and function:

```typescript
import type { ExpectedImpact, ConfidenceLevel } from '@/types/recommendations'
import { calculateConfidence } from './confidence-scoring'

/**
 * Generated graduation recommendation (before DB insert)
 */
export interface GraduationRecommendation {
  type: 'KEYWORD_GRADUATION'
  keyword: string
  keywordMetricId: string | null  // Reference to most recent KeywordMetric
  campaignId: string              // Source Discovery campaign
  confidence: ConfidenceLevel
  rationale: string
  expectedImpact: ExpectedImpact
  metadata: {
    sourceCampaign: string        // Campaign name
    sourceCampaignType: string    // e.g., 'discovery'
    metrics: KeywordMetricsAggregate
    eligibility: GraduationEligibility
  }
}

/**
 * Generate graduation recommendation for an eligible keyword
 */
export function generateGraduationRecommendation(
  metrics: KeywordMetricsAggregate,
  keywordMetricId: string | null,
  campaignId: string,
  campaignName: string
): GraduationRecommendation

/**
 * Build human-readable rationale for graduation recommendation
 */
export function buildGraduationRationale(
  keyword: string,
  metrics: KeywordMetricsAggregate,
  eligibility: GraduationEligibility
): string

/**
 * Calculate expected impact of graduating a keyword
 * Projects ACOS improvement and potential sales increase
 */
export function calculateGraduationImpact(
  metrics: KeywordMetricsAggregate
): ExpectedImpact
```

2. Implement rationale builder with clear, actionable text like:
   - "Keyword 'product keyword' has achieved 18.5% ACOS with 12 conversions and $85.50 spend over 30 days in Discovery campaign. Ready to graduate to Accelerate for scaling."

**Completion Criteria**:
- [ ] `GraduationRecommendation` interface defined
- [ ] `generateGraduationRecommendation` function implemented
- [ ] `buildGraduationRationale` creates readable explanations
- [ ] `calculateGraduationImpact` returns proper `ExpectedImpact` structure
- [ ] `npx tsc --noEmit` passes

## Phase 5: Main Generator Orchestrator
### Subtask 5.1: Create generator.ts orchestrator
**File**: `src/services/recommendations/generator.ts`
**Pattern**: Follow `src/services/amazon-ads/sync.ts` for database interaction patterns
**Instructions**:
1. Create main orchestrator that coordinates recommendation generation:

```typescript
import { prisma } from '@/lib/db'
import { mergeThresholds } from '@/lib/recommendation-utils'
import type { RecommendationThresholds } from '@/types/recommendations'
import {
  isDiscoveryCampaign,
  meetsGraduationThresholds,
  generateGraduationRecommendation,
  type KeywordMetricsAggregate
} from './keyword-graduation'

export interface GenerateRecommendationsOptions {
  brandId: string
  lookbackDays?: number  // Default: 30
  dryRun?: boolean       // If true, don't save to DB, just return recommendations
}

export interface GenerateRecommendationsResult {
  generated: number
  skipped: number
  errors: string[]
  recommendations: Array<{
    type: string
    keyword: string
    confidence: string
  }>
}

/**
 * Generate all recommendations for a brand
 * Currently implements: KEYWORD_GRADUATION
 * Future: DUPLICATE_KEYWORD, NEGATIVE_KEYWORD, BUDGET_INCREASE, BID_DECREASE
 */
export async function generateRecommendations(
  options: GenerateRecommendationsOptions
): Promise<GenerateRecommendationsResult>

/**
 * Find keywords eligible for graduation
 * Queries KeywordMetric aggregated over lookback period
 */
export async function findGraduationCandidates(
  brandId: string,
  thresholds: RequiredThresholds,
  lookbackDays: number
): Promise<KeywordMetricsAggregate[]>

/**
 * Save generated recommendations to database
 * Avoids duplicates by checking for existing PENDING recommendations
 */
async function saveRecommendations(
  brandId: string,
  recommendations: GraduationRecommendation[]
): Promise<number>
```

2. The `findGraduationCandidates` function should:
   - Query KeywordMetric with date filter (last N days)
   - Group by keyword + campaignId
   - Join with AdCampaign to get campaign name and type
   - Filter to only Discovery campaigns
   - Calculate aggregates (sum spend, orders, sales, etc.)
   - Return candidates meeting thresholds

3. The `generateRecommendations` function should:
   - Get brand settings for custom thresholds
   - Merge with defaults using `mergeThresholds`
   - Call `findGraduationCandidates`
   - Generate recommendations for each candidate
   - Save to database (unless dryRun)
   - Return summary

**Completion Criteria**:
- [ ] File created at `src/services/recommendations/generator.ts`
- [ ] `generateRecommendations` fully implemented with database interaction
- [ ] `findGraduationCandidates` aggregates KeywordMetric data correctly
- [ ] Avoids duplicate recommendations for same keyword
- [ ] Uses proper Prisma queries with company/brand scoping
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` passes

### Subtask 5.2: Create index.ts barrel export
**File**: `src/services/recommendations/index.ts`
**Instructions**:
1. Create barrel file exporting all public functions:

```typescript
export {
  classifyCampaign,
  isDiscoveryCampaign,
  isAccelerateCampaign,
  meetsGraduationThresholds,
  getGraduationEligibility,
  generateGraduationRecommendation,
  buildGraduationRationale,
  calculateGraduationImpact,
  type CampaignCategory,
  type KeywordMetricsAggregate,
  type GraduationEligibility,
  type GraduationRecommendation,
} from './keyword-graduation'

export {
  calculateConfidence,
  calculateDataQualityScore,
  CONFIDENCE_THRESHOLDS,
  type DataQualityMetrics,
} from './confidence-scoring'

export {
  generateRecommendations,
  findGraduationCandidates,
  type GenerateRecommendationsOptions,
  type GenerateRecommendationsResult,
} from './generator'
```

**Completion Criteria**:
- [ ] File created at `src/services/recommendations/index.ts`
- [ ] All public functions and types exported
- [ ] `npx tsc --noEmit` passes

## Phase 6: Unit Tests
### Subtask 6.1: Create keyword-graduation tests
**File**: `tests/unit/keyword-graduation.test.ts`
**Pattern**: Follow `tests/unit/attribution-service.test.ts`
**Instructions**:
1. Create comprehensive unit tests for pure functions:

```typescript
import { describe, it, expect } from 'vitest'
import {
  classifyCampaign,
  isDiscoveryCampaign,
  isAccelerateCampaign,
  meetsGraduationThresholds,
  getGraduationEligibility,
  buildGraduationRationale,
} from '@/services/recommendations/keyword-graduation'
import { DEFAULT_THRESHOLDS } from '@/lib/recommendation-utils'

describe('Campaign Classification', () => {
  describe('classifyCampaign', () => {
    it('should classify discovery campaigns by name')
    it('should classify accelerate campaigns by name')
    it('should return unknown for unrecognized patterns')
    it('should be case-insensitive')
    it('should consider targetingType for auto campaigns')
  })
})

describe('Graduation Thresholds', () => {
  describe('meetsGraduationThresholds', () => {
    it('should return true when all thresholds met')
    it('should return false when ACOS above threshold')
    it('should return false when conversions below threshold')
    it('should return false when spend below threshold')
  })

  describe('getGraduationEligibility', () => {
    it('should return detailed eligibility breakdown')
    it('should show which criteria pass and fail')
  })
})

describe('Rationale Generation', () => {
  describe('buildGraduationRationale', () => {
    it('should include keyword name')
    it('should include ACOS percentage')
    it('should include conversion count')
    it('should include spend amount')
  })
})
```

**Completion Criteria**:
- [ ] File created at `tests/unit/keyword-graduation.test.ts`
- [ ] Tests cover all pure functions
- [ ] `npm test -- --filter="keyword-graduation"` passes
- [ ] Edge cases covered (zero values, boundary conditions)

### Subtask 6.2: Create confidence-scoring tests
**File**: `tests/unit/confidence-scoring.test.ts`
**Pattern**: Follow `tests/unit/attribution-service.test.ts`
**Instructions**:
1. Create unit tests for confidence calculation:

```typescript
import { describe, it, expect } from 'vitest'
import {
  calculateConfidence,
  calculateDataQualityScore,
  CONFIDENCE_THRESHOLDS,
} from '@/services/recommendations/confidence-scoring'

describe('Confidence Scoring', () => {
  describe('calculateConfidence', () => {
    it('should return HIGH for 30+ days and 1000+ impressions')
    it('should return MEDIUM for 14-29 days and 500+ impressions')
    it('should return LOW for <14 days')
    it('should return LOW for <500 impressions')
    it('should prioritize days over impressions')
  })

  describe('calculateDataQualityScore', () => {
    it('should return 100 for ideal data')
    it('should return 0 for no data')
    it('should scale proportionally')
  })
})
```

**Completion Criteria**:
- [ ] File created at `tests/unit/confidence-scoring.test.ts`
- [ ] All confidence levels tested
- [ ] `npm test -- --filter="confidence-scoring"` passes

---

## Summary of Deliverables
**Files Created**: 5
- `src/services/recommendations/keyword-graduation.ts`
- `src/services/recommendations/confidence-scoring.ts`
- `src/services/recommendations/generator.ts`
- `src/services/recommendations/index.ts`
- `tests/unit/keyword-graduation.test.ts`
- `tests/unit/confidence-scoring.test.ts`

**Files Modified**: 0

## Handoff to Build Agent
1. Execute subtasks in exact order (Phase 1 through Phase 6)
2. Ensure each phase compiles (`npx tsc --noEmit`) before moving to next
3. Phase 5 requires database interaction - use test database for verification
4. Run full test suite after Phase 6: `npm test`
5. Final validation: `npm run build`

## Test Strategy Note
- Use Vitest for unit tests
- Pure functions (Phase 1-4) can be tested without mocking
- Generator (Phase 5) requires mocking `prisma` for unit tests OR integration test with test database
- Priority: Unit tests for pure functions, integration test optional for Phase 5

## Acceptance Criteria Verification
From Issue #355:
- [x] Keywords meeting thresholds identified: `meetsGraduationThresholds()` + `findGraduationCandidates()`
- [x] Confidence scores calculated: `calculateConfidence()` with HIGH/MEDIUM/LOW
- [x] Recommendations generated with rationale: `generateGraduationRecommendation()` + `buildGraduationRationale()`
- [x] Expected impact included: `calculateGraduationImpact()`

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 25m |
| Validation | 10m |
| Planning | 20m |
| **Total** | **55m** |
