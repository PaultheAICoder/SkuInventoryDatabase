# Implementation Plan
**Generated**: 2025-12-04T18:00:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #158
**Estimated Build Time**: 2-3 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Bug Fix
**Source**: GitHub Issue #158
**Priority**: High - Core admin functionality broken (cannot create new users)

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="user"` or `--filter="auth"`

### Issue Validation
**Status**: Valid
**Recent Changes**:
- `5bec8ca` feat(issue #94): add user-company assignment UI and API
- `dbdc5e0` feat(issue #96): update data queries to scope by selected company
- `c69c1e9` feat(US6): complete Phase 8 - user authentication and roles

### Current State Assessment

**Root Cause Identified**: The `POST /api/users` route at `/home/pbrown/SkuInventory/src/app/api/users/route.ts` does not validate that `session.user.selectedCompanyId` is defined before passing it to `prisma.user.create()`.

**Error Flow**:
1. User submits create user form via `POST /api/users`
2. Route extracts `selectedCompanyId` from session at line 159
3. Route passes `companyId: selectedCompanyId` to Prisma create at line 164
4. If `selectedCompanyId` is `undefined` (edge case), Prisma throws error:
   ```
   Argument `companyId`: Invalid value provided. Expected String, provided Null.
   ```
5. Generic catch block returns 500: `{ error: 'Failed to create user' }`

**Why this happens**:
- The User model in Prisma schema has `companyId String` (required, not nullable)
- While the auth callback has a fallback for `selectedCompanyId` (line 136), it only works if `token.companyId` exists
- Edge case: if both are undefined/null, `selectedCompanyId` remains undefined

**Existing components**:
- API Route: `/home/pbrown/SkuInventory/src/app/api/users/route.ts` - Missing validation
- Schema: `prisma/schema.prisma` - User model requires companyId (line 91)
- Types: `/home/pbrown/SkuInventory/src/types/user.ts` - createUserSchema exists
- Frontend: `/home/pbrown/SkuInventory/src/components/features/UserForm.tsx` - Working correctly

### Dependencies & Blockers
1. None identified - fix is straightforward validation addition

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Simple
**Effort**: 2-3 hours
**Risk**: Low - surgical fix with clear pattern to follow

### Patterns Identified
**Primary**: `/home/pbrown/SkuInventory/src/app/api/companies/switch/route.ts` - Uses standardized API response helpers
**Secondary**: `/home/pbrown/SkuInventory/src/lib/api-response.ts` - Helper functions for consistent error responses

### Ripple Effect Analysis
**Files Identified**: 1 primary, potentially 5-10 other routes as improvement
- `/home/pbrown/SkuInventory/src/app/api/users/route.ts` - PRIMARY FIX
- Other routes using `selectedCompanyId` without validation (optional hardening)

---

## Executive Summary

The bug occurs because the user creation API route (`POST /api/users`) does not validate that `session.user.selectedCompanyId` exists before attempting to create a user record. When `selectedCompanyId` is undefined (an edge case in session state), Prisma throws an error due to the required `companyId` field, which gets caught and returned as a generic 500 error. The fix involves adding explicit validation for `selectedCompanyId` before the Prisma operation and returning a descriptive 400 error if missing.

---

## Phase 1: Primary Bug Fix

### Subtask 1.1: Add selectedCompanyId Validation to User Creation Route

**File**: `/home/pbrown/SkuInventory/src/app/api/users/route.ts`
**Pattern**: Follow existing auth validation pattern (lines 124-132)
**Lines to modify**: After line 159, before line 162

**Instructions**:
1. After extracting `selectedCompanyId` at line 159, add validation check
2. If `selectedCompanyId` is falsy, return a 400 Bad Request error
3. Use the existing `NextResponse.json()` pattern consistent with other validation errors in the file

**Code to add** (insert after line 159):
```typescript
    if (!selectedCompanyId) {
      return NextResponse.json(
        { error: 'No company selected. Please refresh the page and try again.' },
        { status: 400 }
      )
    }
```

**Validation commands**:
```bash
npx tsc --noEmit
npm run build
npm run lint
```

**Completion Criteria**:
- [ ] TypeScript compiles without errors
- [ ] Build succeeds
- [ ] Lint passes
- [ ] New validation returns 400 instead of 500 when selectedCompanyId is missing

### Subtask 1.2: Add Improved Error Logging

**File**: `/home/pbrown/SkuInventory/src/app/api/users/route.ts`
**Pattern**: Follow existing error logging at line 195
**Lines to modify**: Line 195 (catch block)

**Instructions**:
1. Enhance the error logging to include more context for debugging
2. Log the actual error details, not just a generic message

**Current code** (line 195):
```typescript
    console.error('Error creating user:', error)
```

**Updated code**:
```typescript
    console.error('Error creating user:', {
      error: error instanceof Error ? error.message : error,
      stack: error instanceof Error ? error.stack : undefined,
    })
```

**Validation commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] TypeScript compiles without errors
- [ ] Build succeeds
- [ ] Error logs now include stack trace for debugging

---

## Phase 2: GET Route Hardening (Optional but Recommended)

### Subtask 2.1: Add selectedCompanyId Validation to User List Route

**File**: `/home/pbrown/SkuInventory/src/app/api/users/route.ts`
**Pattern**: Same as Subtask 1.1
**Lines to modify**: After line 35, before line 38

**Instructions**:
1. Add same validation check to GET handler
2. Return 400 if selectedCompanyId is missing

**Code to add** (insert after line 35):
```typescript
    if (!selectedCompanyId) {
      return NextResponse.json(
        { error: 'No company selected. Please refresh the page and try again.' },
        { status: 400 }
      )
    }
```

**Validation commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] TypeScript compiles without errors
- [ ] Build succeeds
- [ ] GET /api/users returns 400 instead of 500 when selectedCompanyId is missing

---

## Phase 3: Integration Test

### Subtask 3.1: Add Test Case for Missing selectedCompanyId

**File**: `/home/pbrown/SkuInventory/tests/integration/auth.test.ts`
**Pattern**: Follow existing test patterns in file

**Instructions**:
1. Add a new test case that verifies the 400 response when selectedCompanyId is missing
2. Create a mock session without selectedCompanyId
3. Verify the API returns 400 with appropriate error message

**Test code to add**:
```typescript
describe('Session Validation', () => {
  it('POST /api/users returns 400 when selectedCompanyId is missing', async () => {
    // Create a session missing selectedCompanyId
    const incompleteSession: TestUserSession = {
      user: {
        id: TEST_SESSIONS.admin!.user.id,
        email: TEST_SESSIONS.admin!.user.email,
        name: TEST_SESSIONS.admin!.user.name,
        role: 'admin',
        companyId: TEST_SESSIONS.admin!.user.companyId,
        companyName: TEST_SESSIONS.admin!.user.companyName,
        selectedCompanyId: '', // Empty string simulates missing
      },
    }
    setTestSession(incompleteSession)

    const request = createTestRequest('/api/users', {
      method: 'POST',
      body: {
        email: 'test@example.com',
        password: 'password123',
        name: 'Test User',
        role: 'ops',
      },
    })

    // Need to import the route handler
    const { POST: createUser } = await import('@/app/api/users/route')
    const response = await createUser(request)
    const result = await parseRouteResponse(response)

    expect(result.status).toBe(400)
    expect(result.error).toContain('company')
  })
})
```

**Note**: This test may need adjustment based on how the test helpers handle the session. The Build agent should verify the exact import paths and test helper usage.

**Validation commands**:
```bash
npm test -- --testPathPattern="auth.test"
```

**Completion Criteria**:
- [ ] Test file compiles
- [ ] New test passes
- [ ] Existing tests still pass

---

## Summary of Deliverables

**Files Created**: 0
**Files Modified**:
1. `/home/pbrown/SkuInventory/src/app/api/users/route.ts` - Add validation (2 locations) + improved logging
2. `/home/pbrown/SkuInventory/tests/integration/auth.test.ts` - Add regression test

## Handoff to Build Agent

1. Execute subtasks in exact order (1.1 -> 1.2 -> 2.1 -> 3.1)
2. Phase 3 (test) depends on Phase 1 completion
3. Test completion criteria before next subtask
4. Follow reference patterns exactly
5. Run validation commands after each subtask

## Test Strategy Note

- Use existing Vitest integration test infrastructure
- Run `npm test -- --testPathPattern="auth"` for targeted testing
- Full test suite not required (BUG_FIX category)

## Performance Metrics

| Phase | Duration |
|-------|----------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 10m |
| **Total** | **30m** |

---

## Additional Context

### Files Reviewed During Investigation

1. `/home/pbrown/SkuInventory/src/app/api/users/route.ts` - Main bug location
2. `/home/pbrown/SkuInventory/prisma/schema.prisma` - User model definition
3. `/home/pbrown/SkuInventory/src/types/user.ts` - User type definitions
4. `/home/pbrown/SkuInventory/src/lib/auth.ts` - Session/token handling
5. `/home/pbrown/SkuInventory/src/lib/api-response.ts` - API response helpers
6. `/home/pbrown/SkuInventory/src/components/features/UserForm.tsx` - Frontend form
7. `/home/pbrown/SkuInventory/tests/integration/auth.test.ts` - Existing auth tests
8. `/home/pbrown/SkuInventory/tests/helpers/auth-mock.ts` - Test session mocking

### Key Code Locations

**Bug Location** (`/home/pbrown/SkuInventory/src/app/api/users/route.ts`):
```typescript
// Lines 158-170
    // Use selected company for scoping
    const selectedCompanyId = session.user.selectedCompanyId  // <-- Can be undefined

    // Create user in the selected company
    const user = await prisma.user.create({
      data: {
        companyId: selectedCompanyId,  // <-- Throws if undefined
        email,
        passwordHash,
        name,
        role,
      },
```

**Schema Constraint** (`/home/pbrown/SkuInventory/prisma/schema.prisma`):
```prisma
model User {
  id           String    @id @default(uuid())
  companyId    String    // <-- Required, not nullable
  company      Company   @relation(fields: [companyId], references: [id])
  // ...
}
```

**Session Fallback** (`/home/pbrown/SkuInventory/src/lib/auth.ts`):
```typescript
// Lines 134-139
      // Ensure selectedCompanyId has a fallback value for backward compatibility
      // This handles tokens created before multi-company support was added
      if (!token.selectedCompanyId && token.companyId) {
        token.selectedCompanyId = token.companyId
        token.selectedCompanyName = token.companyName
      }
```
