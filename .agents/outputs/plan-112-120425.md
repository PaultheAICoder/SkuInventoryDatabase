# Implementation Plan
**Generated**: 2025-12-04T12:45:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #112
**Estimated Build Time**: 4-5 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Feature (Foundation/Types)
**Source**: GitHub Issue #112 - [Parent #13] Define forecast types, Prisma schema, and configuration model
**Priority**: High (foundational for forecasting feature)
**Parent Issue**: #13 - Consumption-based forecasting & reorder recommendations

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: FAST_PATH (types-only, no business logic)
**Suggested Filter**: None (foundational types, must complete fully)

### Issue Validation
**Status**: Valid
**Recent Changes**: No forecasting-related files exist in the codebase
**Downstream Dependencies**: Issues #115, #116, #117, #118, #119 depend on this

### Current State Assessment
- **Existing Components**: None - this is a greenfield feature
- **Database**: AlertConfig model exists as pattern reference (lines 431-450 of schema.prisma)
- **Types Directory**: 21 type files exist following consistent Zod + interface patterns
- **No forecast files exist**: Confirmed via grep search

### Dependencies & Blockers
1. None - this is the foundational issue

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Simple
**Effort**: 4-5 hours
**Risk**: Low (no existing code to modify, clear patterns to follow)

### Patterns Identified
**Primary**: `/home/pbrown/SkuInventory/src/types/settings.ts` - Zod schema with defaults + TypeScript type inference
**Secondary**: `/home/pbrown/SkuInventory/src/types/lowstock-alert.ts` - Alert config with response types
**Prisma Pattern**: `AlertConfig` model in `prisma/schema.prisma` (lines 431-450) - per-company config with one-to-one relation

### Ripple Effect Analysis
**Files Identified**: 3 new files + 1 modified
- `/home/pbrown/SkuInventory/src/types/forecast.ts` - NEW
- `/home/pbrown/SkuInventory/prisma/schema.prisma` - MODIFIED (add ForecastConfig model)
- `/home/pbrown/SkuInventory/prisma/migrations/[timestamp]_add_forecast_config/` - NEW (auto-generated)
- Company model in schema.prisma will get new relation (minor modification)

---

## Executive Summary

Create the foundational type definitions and database schema for the forecasting feature. This includes TypeScript interfaces for ComponentForecast, ForecastConfig, and API response types, plus Zod validation schemas. The Prisma schema will be extended with a ForecastConfig model that stores per-company settings (lookback window, safety days, excluded transaction types). This establishes the type-safe foundation for issues #115-119.

## Phase 1: TypeScript Types and Zod Schemas

### Subtask 1.1: Create Forecast Types File
**File**: `/home/pbrown/SkuInventory/src/types/forecast.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/types/settings.ts` (Zod schemas with defaults and TypeScript inference)
**Instructions**:

1. Create new file at `src/types/forecast.ts`
2. Import zod: `import { z } from 'zod'`
3. Define the following schemas and types:

```typescript
import { z } from 'zod'

// Transaction types that can be excluded from consumption calculations
export const excludableTransactionTypes = ['initial', 'adjustment', 'receipt', 'transfer'] as const
export type ExcludableTransactionType = (typeof excludableTransactionTypes)[number]

// Forecast configuration Zod schema
export const forecastConfigSchema = z.object({
  lookbackDays: z.coerce.number().int().min(7).max(365).default(30),
  safetyDays: z.coerce.number().int().min(0).max(90).default(7),
  excludedTransactionTypes: z.array(z.enum(excludableTransactionTypes)).default(['initial', 'adjustment']),
})

export type ForecastConfigInput = z.infer<typeof forecastConfigSchema>

// Partial update schema
export const updateForecastConfigSchema = forecastConfigSchema.partial()
export type UpdateForecastConfigInput = z.infer<typeof updateForecastConfigSchema>

// Default configuration values
export const DEFAULT_FORECAST_CONFIG: ForecastConfigInput = {
  lookbackDays: 30,
  safetyDays: 7,
  excludedTransactionTypes: ['initial', 'adjustment'],
}

// Forecast assumptions included in each forecast result
export interface ForecastAssumptions {
  lookbackDays: number
  safetyDays: number
  excludedTransactionTypes: string[]
}

// Single component forecast result
export interface ComponentForecast {
  componentId: string
  componentName: string
  skuCode: string
  quantityOnHand: number
  averageDailyConsumption: number
  daysUntilRunout: number | null  // null if zero consumption
  runoutDate: Date | null
  recommendedReorderQty: number
  recommendedReorderDate: Date | null
  leadTimeDays: number
  assumptions: ForecastAssumptions
}

// API response for forecast configuration
export interface ForecastConfigResponse {
  id: string
  companyId: string
  lookbackDays: number
  safetyDays: number
  excludedTransactionTypes: string[]
  createdAt: string
  updatedAt: string
}

// API response for forecast list
export interface ForecastListResponse {
  data: ComponentForecastResponse[]
  meta: {
    total: number
    page: number
    pageSize: number
    totalPages: number
  }
  config: ForecastConfigResponse
}

// Serialized forecast for API responses (dates as strings)
export interface ComponentForecastResponse {
  componentId: string
  componentName: string
  skuCode: string
  quantityOnHand: number
  averageDailyConsumption: string  // Decimal as string
  daysUntilRunout: number | null
  runoutDate: string | null  // ISO date string
  recommendedReorderQty: number
  recommendedReorderDate: string | null  // ISO date string
  leadTimeDays: number
  assumptions: ForecastAssumptions
}

// Query params for forecast list endpoint
export const forecastListQuerySchema = z.object({
  page: z.coerce.number().int().positive().default(1),
  pageSize: z.coerce.number().int().positive().max(100).default(50),
  lookbackDays: z.coerce.number().int().min(7).max(365).optional(),
  safetyDays: z.coerce.number().int().min(0).max(90).optional(),
  sortBy: z.enum(['runoutDate', 'consumption', 'name', 'reorderQty']).default('runoutDate'),
  sortOrder: z.enum(['asc', 'desc']).default('asc'),
  showOnlyAtRisk: z.coerce.boolean().optional(),
})

export type ForecastListQuery = z.infer<typeof forecastListQuerySchema>
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run lint
```

**Completion Criteria**:
- [ ] File exists at `src/types/forecast.ts`
- [ ] All Zod schemas validate correctly
- [ ] TypeScript inference works (`ForecastConfigInput` type is correct)
- [ ] No TypeScript errors
- [ ] No lint errors

---

## Phase 2: Prisma Schema Update

### Subtask 2.1: Add ForecastConfig Model to Prisma Schema
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Pattern**: Follow `AlertConfig` model (lines 431-450)
**Instructions**:

1. Add the ForecastConfig model after the `ComponentAlertState` model (around line 461)
2. Add the relation to the Company model

**Add this model after `ComponentAlertState`**:
```prisma
// ============================================
// Forecast Configuration
// ============================================

model ForecastConfig {
  id        String  @id @default(uuid())
  companyId String  @unique
  company   Company @relation(fields: [companyId], references: [id])

  // Forecast parameters
  lookbackDays              Int      @default(30)
  safetyDays                Int      @default(7)
  excludedTransactionTypes  String[] @default(["initial", "adjustment"])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
```

**Update the Company model** - Add the `forecastConfig` relation to the Company model (around line 26, after `alertConfig`):
```prisma
  forecastConfig   ForecastConfig?
```

**Validation Commands**:
```bash
npx prisma validate
npx prisma format
```

**Completion Criteria**:
- [ ] ForecastConfig model added to schema
- [ ] Company model has forecastConfig relation
- [ ] `npx prisma validate` passes
- [ ] `npx prisma format` runs without changes

### Subtask 2.2: Generate and Apply Migration
**File**: `/home/pbrown/SkuInventory/prisma/migrations/`
**Pattern**: Standard Prisma migration workflow
**Instructions**:

1. Generate migration:
```bash
npx prisma migrate dev --name add_forecast_config
```

2. Verify migration was created successfully
3. Verify Prisma client was regenerated:
```bash
npx prisma generate
```

**Validation Commands**:
```bash
npx prisma migrate status
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Migration file created in `prisma/migrations/`
- [ ] Migration applied successfully
- [ ] `npx prisma migrate status` shows no pending migrations
- [ ] Prisma client regenerated with ForecastConfig type

---

## Phase 3: Final Validation

### Subtask 3.1: Full Build Verification
**File**: N/A (project-wide check)
**Instructions**:

1. Run full TypeScript check:
```bash
npx tsc --noEmit
```

2. Run build:
```bash
npm run build
```

3. Run lint:
```bash
npm run lint
```

4. Verify types are importable:
```typescript
// This should work without errors
import {
  ComponentForecast,
  ForecastConfigInput,
  forecastConfigSchema,
  DEFAULT_FORECAST_CONFIG
} from '@/types/forecast'
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
npm run lint
```

**Completion Criteria**:
- [ ] TypeScript check passes with no errors
- [ ] Build completes successfully
- [ ] Lint passes with no errors
- [ ] All exported types are accessible via `@/types/forecast`

---

## Summary of Deliverables

**Files Created**: 2
- `/home/pbrown/SkuInventory/src/types/forecast.ts` (TypeScript types + Zod schemas)
- `/home/pbrown/SkuInventory/prisma/migrations/[timestamp]_add_forecast_config/migration.sql` (auto-generated)

**Files Modified**: 1
- `/home/pbrown/SkuInventory/prisma/schema.prisma` (add ForecastConfig model + Company relation)

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 -> Phase 2 -> Phase 3)
2. Create types file BEFORE modifying Prisma schema
3. Run validation commands after each subtask
4. Verify all completion criteria before proceeding to next subtask
5. Follow reference patterns exactly (settings.ts for types, AlertConfig for Prisma model)

## Test Strategy Note

- No unit tests required for this issue (types-only)
- Type correctness verified by TypeScript compiler
- Prisma schema validated by Prisma CLI
- Downstream issues (#115) will add service-level tests

## Key Implementation Notes

### Transaction Type Exclusions
The `excludedTransactionTypes` array defaults to `['initial', 'adjustment']` because:
- `initial` transactions represent opening balances, not actual consumption
- `adjustment` transactions are corrections, not consumption patterns
- Only `build` transactions represent actual consumption (negative quantity changes)
- `receipt` and `transfer` are included in excludable options but not excluded by default

### Decimal Precision
- `averageDailyConsumption` is returned as a string in API responses to preserve decimal precision
- Internally, calculations should use JavaScript numbers or Prisma Decimal type
- The forecast service (issue #115) will handle the actual calculations

### Date Handling
- `runoutDate` and `recommendedReorderDate` can be null when consumption is zero
- API responses serialize dates as ISO strings
- Internal types use JavaScript Date objects

### Company Scoping
- ForecastConfig has a one-to-one relationship with Company (via unique companyId)
- Each company can have its own forecast configuration
- If no config exists, downstream services should use DEFAULT_FORECAST_CONFIG

---

## Performance Metrics
| Phase | Estimated Duration |
|-------|----------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 10m |
| **Total Scout-and-Plan** | **30m** |
| **Estimated Build Time** | **4-5h** |
