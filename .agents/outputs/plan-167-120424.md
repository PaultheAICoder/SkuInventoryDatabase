# Implementation Plan
**Generated**: 2025-12-04T20:00:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #167
**Estimated Build Time**: 6-8 hours
**Complexity**: Medium

## Investigation Summary

### Request Analysis
**Type**: Enhancement
**Source**: GitHub Issue #167
**Priority**: Medium

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: `--testPathPattern="selector"` or None (manual testing recommended for UI)

### Issue Validation
**Status**: Valid
**Recent Changes**:
- `04a7dce` feat(issue #20): add multi-brand UI support with brand selector and scoping
- `d68c193` feat(issue #87): add company selector component to sidebar
- `4225b43` feat(issue #82): update session and auth to support multi-company context

### Current State Assessment

**Existing Components**:
- `CompanySelector` (`src/components/features/CompanySelector.tsx`) - Working, uses shadcn Select
- `BrandSelector` (`src/components/features/BrandSelector.tsx`) - Working, uses shadcn Select
- Both selectors are rendered in `src/app/(dashboard)/layout.tsx` lines 92-93

**Database**:
- Company model has `isActive` field: NO (not present)
- Brand model has `isActive` field: YES (`isActive Boolean @default(true)`)
- Company-Brand relationship: Company hasMany Brands (existing)

**Session Data Structure** (from `/src/lib/auth.ts`):
```typescript
interface User {
  companies: Array<{ id: string; name: string; role?: string }>
  selectedCompanyId: string
  selectedCompanyName: string
  brands: Array<{ id: string; name: string }>
  selectedBrandId: string | null
  selectedBrandName: string | null
}
```

**API Routes**:
- `POST /api/companies/switch` - Switches company and auto-selects first brand
- `POST /api/brands/switch` - Switches brand within current company
- Both already filter by `isActive: true` for brands

**UI Components Available**:
- `src/components/ui/dropdown-menu.tsx` - Has `DropdownMenuSub`, `DropdownMenuSubTrigger`, `DropdownMenuSubContent` for nested menus
- `src/components/ui/select.tsx` - Standard select (currently used)

### Dependencies & Blockers

1. **Company `isActive` field**: The Prisma schema does NOT have an `isActive` field on the Company model. The issue mentions filtering by `isActive: true` for companies, but this field doesn't exist.
   - **Decision needed**: Add `isActive` to Company model OR only filter brands by `isActive` (companies are implicitly active if user has access)
   - **Recommendation**: Skip Company `isActive` filter since user access is already controlled via `UserCompany` table. All companies a user can access are implicitly "active" for that user.

2. **Session data already has nested structure**: The session already contains `companies` array and `brands` array, but brands are only for the currently selected company. The new selector needs to show brands for ALL companies the user has access to.

**Can Proceed?**: YES (with clarification on Company isActive - recommend skipping it)

### Complexity Assessment
**Complexity**: Medium
**Effort**: 6-8 hours
**Risk**: Low - UI-only change, existing API endpoints can be reused with minor modifications

### Patterns Identified
**Primary**: `src/components/ui/dropdown-menu.tsx` - Use DropdownMenuSub for cascading menus
**Secondary**: `src/components/features/CompanySelector.tsx` and `BrandSelector.tsx` - Existing selection logic and session update patterns

### Ripple Effect Analysis
**Files Identified**: 5

| File | Impact |
|------|--------|
| `src/components/features/CompanySelector.tsx` | DELETE - Replace with new component |
| `src/components/features/BrandSelector.tsx` | DELETE - Replace with new component |
| `src/app/(dashboard)/layout.tsx` | MODIFY - Import new selector, remove two old ones |
| `src/lib/auth.ts` | POTENTIAL MODIFY - May need to fetch all brands for all companies at login |
| `src/types/index.ts` | POTENTIAL ADD - New type for nested company/brand structure |

---

## Executive Summary

Replace the two separate `CompanySelector` and `BrandSelector` components with a single unified `CompanyBrandSelector` component. The new component will use shadcn/ui's `DropdownMenu` with sub-menus (`DropdownMenuSub`) to show a cascading hierarchy: clicking the trigger opens company list, hovering/clicking a company reveals its brands as a nested menu. Selecting a brand will update both the selected company and brand in the session. The "All Brands" option will be available under each company.

---

## Phase 1: Backend/Session Modifications

### Subtask 1.1: Extend Session Type to Include Brands per Company
**File**: `src/types/index.ts`
**Pattern**: Follow existing `SessionCompany` and `SessionBrand` interfaces
**Instructions**:
1. Create a new interface `CompanyWithBrands` that extends `SessionCompany` with a `brands` array
2. This will be used for the nested selector data

```typescript
// Add this interface
export interface CompanyWithBrands extends SessionCompany {
  brands: SessionBrand[]
}
```

**Completion Criteria**:
- [ ] TypeScript compiles: `npx tsc --noEmit`

### Subtask 1.2: Update Auth to Fetch All Brands for All Companies
**File**: `src/lib/auth.ts`
**Pattern**: Follow existing authorize() function pattern
**Instructions**:
1. In the `authorize` function, after fetching user's companies, also fetch brands for each company
2. Modify the return object to include a `companiesWithBrands` array
3. Update JWT and session callbacks to pass through this new field

Current flow (lines 41-49):
```typescript
const brands = user ? await prisma.brand.findMany({
  where: {
    companyId: user.companyId,
    isActive: true,
  },
  ...
}) : []
```

New flow should fetch brands for ALL user's accessible companies:
```typescript
// Fetch brands for all accessible companies
const companyIds = companies.map(c => c.id)
const allBrands = await prisma.brand.findMany({
  where: {
    companyId: { in: companyIds },
    isActive: true,
  },
  select: { id: true, name: true, companyId: true },
  orderBy: { name: 'asc' },
})

// Build companiesWithBrands structure
const companiesWithBrands = companies.map(company => ({
  ...company,
  brands: allBrands.filter(b => b.companyId === company.id).map(b => ({ id: b.id, name: b.name }))
}))
```

Update NextAuth module declaration to add:
```typescript
companiesWithBrands: Array<{ id: string; name: string; role?: string; brands: Array<{ id: string; name: string }> }>
```

**Completion Criteria**:
- [ ] TypeScript compiles: `npx tsc --noEmit`
- [ ] Build passes: `npm run build`
- [ ] Session contains `companiesWithBrands` after login (manual test)

---

## Phase 2: Create New Unified Selector Component

### Subtask 2.1: Create CompanyBrandSelector Component
**File**: `src/components/features/CompanyBrandSelector.tsx` (NEW)
**Pattern**: Follow `dropdown-menu.tsx` for DropdownMenu usage, `CompanySelector.tsx` for session handling
**Instructions**:
1. Create new component using shadcn DropdownMenu with sub-menus
2. Import necessary components:
   - `DropdownMenu`, `DropdownMenuTrigger`, `DropdownMenuContent`, `DropdownMenuSub`, `DropdownMenuSubTrigger`, `DropdownMenuSubContent`, `DropdownMenuItem`, `DropdownMenuLabel`, `DropdownMenuSeparator`
3. Use `useSession` to get `companiesWithBrands`
4. Structure:
   - Trigger shows current company/brand: "Company > Brand" or icon
   - Content shows list of companies
   - Each company is a SubTrigger that reveals its brands
   - Include "All Brands" option under each company
   - Include visual indicator for current selection (checkmark)
5. Handle selection:
   - If selecting brand under SAME company: call `/api/brands/switch`
   - If selecting brand under DIFFERENT company: call `/api/companies/switch` (which auto-updates brands)
   - Update session after successful API call
6. Show loading state during switch
7. Handle errors with toast

**Key implementation details**:
```tsx
'use client'

import { useSession } from 'next-auth/react'
import { useState } from 'react'
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSub,
  DropdownMenuSubContent,
  DropdownMenuSubTrigger,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu'
import { Button } from '@/components/ui/button'
import { Building2, Tag, Check, ChevronDown } from 'lucide-react'
import { toast } from 'sonner'

export function CompanyBrandSelector() {
  const { data: session, update: updateSession } = useSession()
  const [isLoading, setIsLoading] = useState(false)

  // Don't render if user has only one company with one brand
  if (!session?.user?.companiesWithBrands || session.user.companiesWithBrands.length <= 1) {
    // Check if single company has only 0-1 brands
    const singleCompany = session?.user?.companiesWithBrands?.[0]
    if (!singleCompany || singleCompany.brands.length <= 1) {
      return null
    }
  }

  const handleBrandSelect = async (companyId: string, brandId: string | null) => {
    // ... implementation
  }

  return (
    <div className="px-4 py-2 border-b">
      <DropdownMenu>
        <DropdownMenuTrigger asChild>
          <Button variant="outline" className="w-full justify-between" disabled={isLoading}>
            <span className="flex items-center gap-2 truncate">
              <Building2 className="h-4 w-4 shrink-0" />
              <span className="truncate">
                {session.user.selectedCompanyName}
                {session.user.selectedBrandName && (
                  <> / {session.user.selectedBrandName}</>
                )}
              </span>
            </span>
            <ChevronDown className="h-4 w-4 shrink-0 opacity-50" />
          </Button>
        </DropdownMenuTrigger>
        <DropdownMenuContent className="w-56">
          {session.user.companiesWithBrands.map((company) => (
            <DropdownMenuSub key={company.id}>
              <DropdownMenuSubTrigger>
                <Building2 className="mr-2 h-4 w-4" />
                {company.name}
                {company.id === session.user.selectedCompanyId && (
                  <Check className="ml-auto h-4 w-4" />
                )}
              </DropdownMenuSubTrigger>
              <DropdownMenuSubContent>
                <DropdownMenuItem
                  onClick={() => handleBrandSelect(company.id, null)}
                >
                  <Tag className="mr-2 h-4 w-4" />
                  All Brands
                  {company.id === session.user.selectedCompanyId &&
                   session.user.selectedBrandId === null && (
                    <Check className="ml-auto h-4 w-4" />
                  )}
                </DropdownMenuItem>
                {company.brands.map((brand) => (
                  <DropdownMenuItem
                    key={brand.id}
                    onClick={() => handleBrandSelect(company.id, brand.id)}
                  >
                    <Tag className="mr-2 h-4 w-4" />
                    {brand.name}
                    {brand.id === session.user.selectedBrandId && (
                      <Check className="ml-auto h-4 w-4" />
                    )}
                  </DropdownMenuItem>
                ))}
              </DropdownMenuSubContent>
            </DropdownMenuSub>
          ))}
        </DropdownMenuContent>
      </DropdownMenu>
    </div>
  )
}
```

**Completion Criteria**:
- [ ] Component created and exports `CompanyBrandSelector`
- [ ] TypeScript compiles: `npx tsc --noEmit`
- [ ] Build passes: `npm run build`

---

## Phase 3: Update Layout and Remove Old Components

### Subtask 3.1: Update Dashboard Layout
**File**: `src/app/(dashboard)/layout.tsx`
**Pattern**: Follow existing import patterns
**Instructions**:
1. Remove imports for `CompanySelector` and `BrandSelector` (lines 31-32)
2. Add import for `CompanyBrandSelector`
3. Replace the two selector components (lines 92-93) with single `<CompanyBrandSelector />`

**Before** (lines 31-32, 92-93):
```tsx
import { CompanySelector } from '@/components/features/CompanySelector'
import { BrandSelector } from '@/components/features/BrandSelector'
...
<CompanySelector />
<BrandSelector />
```

**After**:
```tsx
import { CompanyBrandSelector } from '@/components/features/CompanyBrandSelector'
...
<CompanyBrandSelector />
```

**Completion Criteria**:
- [ ] Layout imports new component
- [ ] Old selector imports removed
- [ ] Single selector renders in sidebar
- [ ] Build passes: `npm run build`

### Subtask 3.2: Remove Old Selector Components (Optional - can keep for rollback)
**Files**:
- `src/components/features/CompanySelector.tsx`
- `src/components/features/BrandSelector.tsx`
**Instructions**:
1. Delete both files OR rename with `.bak` extension for rollback capability
2. Verify no other imports exist

**Completion Criteria**:
- [ ] Old files removed or backed up
- [ ] No import errors: `npx tsc --noEmit`
- [ ] Build passes: `npm run build`

---

## Phase 4: Testing and Refinement

### Subtask 4.1: Manual Testing Checklist
**Instructions**: Perform these manual tests:

**Visibility Tests**:
- [ ] Selector visible on desktop (1024px+)
- [ ] Selector visible on tablet (768px-1023px)
- [ ] Selector visible on mobile (<768px)

**Functionality Tests**:
- [ ] Click trigger opens dropdown with companies
- [ ] Hover/click company shows nested brands submenu
- [ ] "All Brands" option exists under each company
- [ ] Selecting brand under SAME company updates brand only
- [ ] Selecting brand under DIFFERENT company updates both company and brand
- [ ] Current selection shows checkmark indicator
- [ ] Loading state shows during API call
- [ ] Error toast shows on API failure

**Data Tests**:
- [ ] Only active brands shown (inactive brands hidden)
- [ ] All user's accessible companies shown
- [ ] Brands correctly grouped under their companies

**Completion Criteria**:
- [ ] All manual tests pass

### Subtask 4.2: Accessibility Testing
**Instructions**:
1. Test keyboard navigation:
   - Tab to trigger button
   - Enter/Space to open
   - Arrow keys to navigate companies
   - Arrow right to open submenu
   - Enter to select brand
   - Escape to close
2. Verify screen reader announces selections

**Completion Criteria**:
- [ ] Keyboard navigation works
- [ ] Focus management correct

---

## Summary of Deliverables

**Files Created**: 2
- `src/components/features/CompanyBrandSelector.tsx` (NEW)
- Type additions to `src/types/index.ts`

**Files Modified**: 2
- `src/lib/auth.ts` (session data structure)
- `src/app/(dashboard)/layout.tsx` (import swap)

**Files Deleted/Archived**: 2 (optional)
- `src/components/features/CompanySelector.tsx`
- `src/components/features/BrandSelector.tsx`

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 -> 2 -> 3 -> 4)
2. Type changes (1.1) must complete before auth changes (1.2)
3. Auth changes must complete before new component (2.1)
4. New component must work before layout update (3.1)
5. Test completion criteria before each next subtask
6. Follow shadcn/ui DropdownMenu patterns exactly
7. Preserve existing session update patterns from old selectors

## Test Strategy Note

- Use manual testing for UI behavior verification
- Vitest can be used for any utility functions extracted
- Consider E2E test later if behavior needs regression testing

## Design Decision Notes

1. **Company isActive filter**: SKIPPED - The Company model lacks `isActive` field, and user company access is already controlled via UserCompany table. All companies a user can access are implicitly active for that user.

2. **UI Pattern**: Cascading dropdown (DropdownMenuSub) chosen over accordion because:
   - More similar to OS context menus (as mentioned in issue)
   - Less vertical space usage
   - Already available in shadcn/ui
   - Works well with hover on desktop

3. **Session structure**: Adding `companiesWithBrands` to avoid extra API call on every dropdown open. Data is fetched once at login and cached in JWT.

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 10m |
| **Total** | **30m** |
