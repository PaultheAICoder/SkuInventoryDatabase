# Implementation Plan
**Generated**: 2025-12-03T21:00:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #68 - [Parent #9] Phase 1: Location model, schema, and management UI
**Estimated Build Time**: 8-10 hours
**Complexity**: Moderate

## Investigation Summary

### Request Analysis
**Type**: Feature (New Entity)
**Source**: GitHub Issue #68 (child of parent issue #9 for multi-location inventory)
**Priority**: High (foundational feature for multi-location support)

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED (affects new files primarily, verify integration with Company model)
**Suggested Filter**: None (new feature with no existing tests)

### Issue Validation
**Status**: Valid
**Recent Changes**: No Location-related code exists currently. Schema has no Location model yet.
**No Overlap**: No closed issues related to Location found.

### Current State Assessment
- **Existing components**: None for Location - all files must be created
- **Database**: Company model exists and will be referenced by Location. No Location model exists.
- **API Routes**: No location routes exist. Pattern available in `src/app/api/users/` and `src/app/api/users/[id]/`
- **Types**: No location types exist. Pattern available in `src/types/user.ts` and `src/types/component.ts`
- **UI Components**: No LocationForm or LocationTable exist. Pattern available in `UserForm.tsx` and `UserTable.tsx`
- **Navigation**: Settings accessible via sidebar. New "Locations" link needed.

### Dependencies & Blockers
1. **Company model dependency**: Verified - Company model exists at line 13 of schema.prisma with `id` field for relation
2. **No blockers identified**: All pattern files exist and are readable

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Moderate
**Effort**: 8-10 hours
**Risk**: Low - well-established patterns, isolated new feature

### Patterns Identified
**Primary API Route**: `/home/pbrown/SkuInventory/src/app/api/users/route.ts` - List/Create pattern with Zod validation, pagination, auth checks
**Primary API Route [id]**: `/home/pbrown/SkuInventory/src/app/api/users/[id]/route.ts` - GET/PATCH/DELETE pattern
**Primary Form Component**: `/home/pbrown/SkuInventory/src/components/features/UserForm.tsx` - Form with Card layout, error handling, isEditing mode
**Primary Table Component**: `/home/pbrown/SkuInventory/src/components/features/UserTable.tsx` - Table with actions dropdown, delete confirmation dialog
**Primary Types**: `/home/pbrown/SkuInventory/src/types/user.ts` - Zod schemas for create/update/query + response interface
**Primary Page**: `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/users/page.tsx` - List page with filters and table

### Ripple Effect Analysis
**Files Identified**: 9 new files + 2 modifications
- `prisma/schema.prisma` - Add Location model and enum (MODIFY)
- `src/app/(dashboard)/layout.tsx` - Add Locations nav item (MODIFY - optional, may defer)
- `src/types/location.ts` - New Zod schemas and types (CREATE)
- `src/services/location.ts` - CRUD operations (CREATE)
- `src/app/api/locations/route.ts` - List/Create endpoints (CREATE)
- `src/app/api/locations/[id]/route.ts` - GET/PATCH/DELETE endpoints (CREATE)
- `src/components/features/LocationForm.tsx` - Create/Edit form (CREATE)
- `src/components/features/LocationTable.tsx` - List table with actions (CREATE)
- `src/app/(dashboard)/settings/locations/page.tsx` - Management page (CREATE)

---

## Executive Summary
Create the foundational Location entity for multi-location inventory tracking. This involves adding the Location model to Prisma schema with LocationType enum, creating TypeScript types with Zod validation, implementing CRUD service functions, building API routes for list/create/update/delete operations, and developing React components for the management UI at `/settings/locations`. A migration will auto-create "Main Warehouse" default locations for existing companies.

## Phase 1: Database/Types Layer

### Subtask 1.1: Add LocationType Enum and Location Model to Prisma Schema
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Pattern**: Follow existing `UserRole` enum and `Brand` model structure (lines 28-42)
**Instructions**:
1. Add `LocationType` enum after the existing `UserRole` enum (after line 48):
```prisma
enum LocationType {
  warehouse
  threepl
  fba
  finished_goods
}
```
2. Add `Location` model after the `Company` model (after line 26), before Brand:
```prisma
model Location {
  id        String       @id @default(uuid())
  companyId String
  company   Company      @relation(fields: [companyId], references: [id])
  name      String       @db.VarChar(100)
  type      LocationType @default(warehouse)
  isDefault Boolean      @default(false)
  isActive  Boolean      @default(true)
  notes     String?      @db.Text
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@unique([companyId, name])
  @@index([companyId, isActive])
}
```
3. Add `locations` relation to Company model (after line 25):
```prisma
  locations        Location[]
```
4. Validate schema: `npx prisma validate`

**Completion Criteria**:
- [ ] LocationType enum added
- [ ] Location model added with all fields
- [ ] Company model has locations relation
- [ ] `npx prisma validate` passes

### Subtask 1.2: Create Migration with Default Location for Existing Companies
**File**: Migration file (auto-generated)
**Instructions**:
1. Create migration: `npx prisma migrate dev --name add_location_model`
2. After migration runs, check if it creates default locations for existing companies
3. If not automated by Prisma, manually add SQL to the migration before applying to production:
```sql
-- Insert default "Main Warehouse" for each existing company
INSERT INTO "Location" (id, "companyId", name, type, "isDefault", "isActive", notes, "createdAt", "updatedAt")
SELECT
  gen_random_uuid(),
  id,
  'Main Warehouse',
  'warehouse',
  true,
  true,
  'Default location created during migration',
  NOW(),
  NOW()
FROM "Company"
WHERE NOT EXISTS (
  SELECT 1 FROM "Location" WHERE "Location"."companyId" = "Company".id
);
```
4. Generate Prisma client: `npx prisma generate`

**Completion Criteria**:
- [ ] Migration file created
- [ ] Migration applies without errors
- [ ] Default locations created for existing companies
- [ ] `npx prisma generate` completes

### Subtask 1.3: Create Location Type Definitions
**File**: `/home/pbrown/SkuInventory/src/types/location.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/types/user.ts` (lines 1-59)
**Instructions**:
Create the file with:
```typescript
import { z } from 'zod'

// Location type enum values
export const LOCATION_TYPES = ['warehouse', 'threepl', 'fba', 'finished_goods'] as const
export type LocationType = (typeof LOCATION_TYPES)[number]

export const LOCATION_TYPE_DISPLAY_NAMES: Record<LocationType, string> = {
  warehouse: 'Warehouse',
  threepl: '3PL',
  fba: 'FBA',
  finished_goods: 'Finished Goods',
}

// Location create schema (admin only)
export const createLocationSchema = z.object({
  name: z.string().min(1, 'Name is required').max(100),
  type: z.enum(LOCATION_TYPES).default('warehouse'),
  isDefault: z.boolean().default(false),
  notes: z.string().optional().nullable(),
})

export type CreateLocationInput = z.infer<typeof createLocationSchema>

// Location update schema (admin only)
export const updateLocationSchema = z.object({
  name: z.string().min(1, 'Name is required').max(100).optional(),
  type: z.enum(LOCATION_TYPES).optional(),
  isDefault: z.boolean().optional(),
  isActive: z.boolean().optional(),
  notes: z.string().optional().nullable(),
})

export type UpdateLocationInput = z.infer<typeof updateLocationSchema>

// Location list query schema
export const locationListQuerySchema = z.object({
  page: z.coerce.number().int().positive().default(1),
  pageSize: z.coerce.number().int().positive().max(100).default(50),
  search: z.string().optional(),
  type: z.enum(LOCATION_TYPES).optional(),
  isActive: z
    .string()
    .transform((val) => val === 'true')
    .optional(),
  sortBy: z.enum(['name', 'type', 'createdAt']).default('name'),
  sortOrder: z.enum(['asc', 'desc']).default('asc'),
})

export type LocationListQuery = z.infer<typeof locationListQuerySchema>

// Location response type (what API returns)
export interface LocationResponse {
  id: string
  name: string
  type: LocationType
  isDefault: boolean
  isActive: boolean
  notes: string | null
  createdAt: string
  updatedAt: string
}
```

**Completion Criteria**:
- [ ] File created with all schemas and types
- [ ] `npx tsc --noEmit` passes
- [ ] All type exports available

## Phase 2: Service Layer

### Subtask 2.1: Create Location Service Functions
**File**: `/home/pbrown/SkuInventory/src/services/location.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/services/inventory.ts` structure (Prisma usage patterns)
**Instructions**:
Create the file with:
```typescript
import { prisma } from '@/lib/db'

/**
 * Ensure a company has at least one default location.
 * If no locations exist, create "Main Warehouse" as default.
 * If locations exist but none is default, make the first one default.
 */
export async function ensureDefaultLocation(companyId: string): Promise<void> {
  const existingLocations = await prisma.location.findMany({
    where: { companyId },
    orderBy: { createdAt: 'asc' },
  })

  if (existingLocations.length === 0) {
    // Create default warehouse
    await prisma.location.create({
      data: {
        companyId,
        name: 'Main Warehouse',
        type: 'warehouse',
        isDefault: true,
        isActive: true,
      },
    })
  } else {
    // Check if any location is default
    const hasDefault = existingLocations.some((loc) => loc.isDefault)
    if (!hasDefault) {
      // Make the first location the default
      await prisma.location.update({
        where: { id: existingLocations[0].id },
        data: { isDefault: true },
      })
    }
  }
}

/**
 * When setting a location as default, unset any other defaults for the company
 */
export async function setDefaultLocation(
  companyId: string,
  locationId: string
): Promise<void> {
  await prisma.$transaction([
    // Unset all defaults for this company
    prisma.location.updateMany({
      where: { companyId, isDefault: true },
      data: { isDefault: false },
    }),
    // Set the new default
    prisma.location.update({
      where: { id: locationId },
      data: { isDefault: true },
    }),
  ])
}

/**
 * Check if a location can be deactivated
 * (cannot deactivate if it's the only active location)
 */
export async function canDeactivateLocation(
  companyId: string,
  locationId: string
): Promise<{ canDeactivate: boolean; reason?: string }> {
  const activeCount = await prisma.location.count({
    where: {
      companyId,
      isActive: true,
      id: { not: locationId },
    },
  })

  if (activeCount === 0) {
    return {
      canDeactivate: false,
      reason: 'Cannot deactivate the only active location',
    }
  }

  return { canDeactivate: true }
}

/**
 * Check if a location can be deleted
 * Future: will check for inventory at this location
 */
export async function canDeleteLocation(
  locationId: string
): Promise<{ canDelete: boolean; reason?: string }> {
  // For Phase 1, locations can always be deleted (soft delete via isActive)
  // Future phases will check for inventory at this location
  return { canDelete: true }
}

/**
 * Get the default location for a company
 */
export async function getDefaultLocation(companyId: string) {
  return prisma.location.findFirst({
    where: {
      companyId,
      isDefault: true,
      isActive: true,
    },
  })
}
```

**Completion Criteria**:
- [ ] File created with all service functions
- [ ] `npx tsc --noEmit` passes
- [ ] Functions properly typed

## Phase 3: API Routes

### Subtask 3.1: Create Locations List/Create API Route
**File**: `/home/pbrown/SkuInventory/src/app/api/locations/route.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/app/api/users/route.ts` (lines 1-171)
**Instructions**:
Create the file with GET (list) and POST (create) handlers:
1. Import dependencies: NextRequest, NextResponse, getServerSession, authOptions, prisma, Prisma, Zod schemas
2. GET handler:
   - Authenticate user (session check)
   - Require admin role for access
   - Parse query params with `locationListQuerySchema`
   - Build Prisma where clause with companyId filter
   - Support search (name contains), type filter, isActive filter
   - Return paginated results with meta
3. POST handler:
   - Authenticate user (session check)
   - Require admin role
   - Parse body with `createLocationSchema`
   - Check for duplicate name within company
   - If isDefault=true, unset other defaults
   - Create location
   - Return created location

**Code structure** (follow user route exactly):
```typescript
import { NextRequest, NextResponse } from 'next/server'
import { getServerSession } from 'next-auth'
import { authOptions } from '@/lib/auth'
import { prisma } from '@/lib/db'
import { Prisma } from '@prisma/client'
import { createLocationSchema, locationListQuerySchema } from '@/types/location'
import { setDefaultLocation } from '@/services/location'

// GET /api/locations - List locations (admin only)
export async function GET(request: NextRequest) {
  // ... follow users/route.ts GET pattern
}

// POST /api/locations - Create location (admin only)
export async function POST(request: NextRequest) {
  // ... follow users/route.ts POST pattern
}
```

**Completion Criteria**:
- [ ] GET returns paginated locations for company
- [ ] POST creates location with validation
- [ ] Duplicate name returns 409 Conflict
- [ ] Non-admin returns 403 Forbidden
- [ ] `npx tsc --noEmit` passes

### Subtask 3.2: Create Location Detail API Route
**File**: `/home/pbrown/SkuInventory/src/app/api/locations/[id]/route.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/app/api/users/[id]/route.ts` (lines 1-223)
**Instructions**:
Create the file with GET, PATCH, DELETE handlers:
1. GET handler: Fetch location by id (must belong to user's company)
2. PATCH handler:
   - Validate with `updateLocationSchema`
   - Check duplicate name if name is being changed
   - If setting isDefault=true, call `setDefaultLocation`
   - If setting isActive=false, call `canDeactivateLocation` first
   - Cannot unset isDefault if it's the only default
3. DELETE handler:
   - Soft delete by setting isActive=false
   - Cannot delete if only active location
   - If deleted location was default, make another location default

**Completion Criteria**:
- [ ] GET returns location details
- [ ] PATCH updates location with validation
- [ ] DELETE soft-deletes location
- [ ] Proper error handling for edge cases
- [ ] `npx tsc --noEmit` passes

## Phase 4: Frontend Components

### Subtask 4.1: Create LocationForm Component
**File**: `/home/pbrown/SkuInventory/src/components/features/LocationForm.tsx`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/components/features/UserForm.tsx` (lines 1-206)
**Instructions**:
Create the form component with:
1. Props: `location?: LocationResponse`, `onSuccess?: () => void`
2. State: formData with name, type, isDefault, notes, isActive
3. Form fields:
   - Name (required text input)
   - Type (Select dropdown with LOCATION_TYPE_DISPLAY_NAMES)
   - Is Default (checkbox - note: shown only in edit mode if there are other locations)
   - Notes (optional textarea)
   - Is Active (checkbox - only in edit mode)
4. Submit handler:
   - POST to `/api/locations` for create
   - PATCH to `/api/locations/${id}` for edit
5. Error display and loading state

**UI Layout** (follow UserForm pattern):
```tsx
<form onSubmit={handleSubmit}>
  <Card>
    <CardHeader>
      <CardTitle>{isEditing ? 'Edit Location' : 'Create Location'}</CardTitle>
      <CardDescription>...</CardDescription>
    </CardHeader>
    <CardContent className="space-y-4">
      {/* Name input */}
      {/* Type select */}
      {/* Is Default checkbox (edit mode only) */}
      {/* Notes textarea */}
      {/* Is Active checkbox (edit mode only) */}
      {/* Submit/Cancel buttons */}
    </CardContent>
  </Card>
</form>
```

**Completion Criteria**:
- [ ] Form renders correctly for create/edit modes
- [ ] All fields work properly
- [ ] Validation errors display
- [ ] Submit calls correct API endpoint
- [ ] `npx tsc --noEmit` passes

### Subtask 4.2: Create LocationTable Component
**File**: `/home/pbrown/SkuInventory/src/components/features/LocationTable.tsx`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/components/features/UserTable.tsx` (lines 1-212)
**Instructions**:
Create the table component with:
1. Props: `locations: LocationResponse[]`, `onRefresh: () => void`
2. Columns: Name, Type (with display name), Status (Active/Inactive badge), Default (badge), Actions
3. Actions dropdown:
   - Edit (link to edit page or inline)
   - Set as Default (if not already default)
   - Deactivate/Activate toggle
   - Delete (with confirmation dialog)
4. Delete confirmation dialog

**Table structure**:
```tsx
<Table>
  <TableHeader>
    <TableRow>
      <TableHead>Name</TableHead>
      <TableHead>Type</TableHead>
      <TableHead>Status</TableHead>
      <TableHead>Default</TableHead>
      <TableHead className="w-[70px]" />
    </TableRow>
  </TableHeader>
  <TableBody>
    {/* Location rows with actions */}
  </TableBody>
</Table>
```

**Completion Criteria**:
- [ ] Table renders all location data
- [ ] Type displays human-readable name
- [ ] Status shows Active/Inactive badge
- [ ] Default shows badge for default location
- [ ] Actions work (edit, set default, toggle active, delete)
- [ ] Delete confirmation dialog works
- [ ] `npx tsc --noEmit` passes

### Subtask 4.3: Create Location Management Page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/locations/page.tsx`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/users/page.tsx` (lines 1-133)
**Instructions**:
Create the page with:
1. 'use client' directive
2. State: locations, isLoading, error, filters (search, type, isActive)
3. useEffect to fetch locations on mount and when filters change
4. Header with title and "Add Location" button
5. Filter bar with search, type dropdown, status dropdown
6. LocationTable component
7. Empty state when no locations

**Page structure**:
```tsx
'use client'

export default function LocationsPage() {
  // State and effects

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold">Location Management</h1>
          <p className="text-muted-foreground">Manage inventory locations</p>
        </div>
        <Button asChild>
          <Link href="/settings/locations/new">
            <MapPin className="mr-2 h-4 w-4" />
            Add Location
          </Link>
        </Button>
      </div>

      {/* Filters */}
      {/* Error state */}
      {/* Loading state */}
      {/* LocationTable */}
    </div>
  )
}
```

**Completion Criteria**:
- [ ] Page loads and fetches locations
- [ ] Filters work correctly
- [ ] Add Location button links to create page
- [ ] LocationTable displays
- [ ] Error and loading states work
- [ ] `npx tsc --noEmit` passes

### Subtask 4.4: Create Location New Page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/locations/new/page.tsx`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/users/new/page.tsx`
**Instructions**:
Create a simple page that renders LocationForm:
```tsx
'use client'

import { LocationForm } from '@/components/features/LocationForm'

export default function NewLocationPage() {
  return (
    <div className="max-w-2xl">
      <LocationForm />
    </div>
  )
}
```

**Completion Criteria**:
- [ ] Page renders LocationForm
- [ ] `npx tsc --noEmit` passes

### Subtask 4.5: Create Location Edit Page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/locations/[id]/edit/page.tsx`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/users/[id]/edit/page.tsx`
**Instructions**:
Create a page that:
1. Fetches location by ID from API
2. Shows loading state while fetching
3. Shows error if location not found
4. Renders LocationForm with location data

**Completion Criteria**:
- [ ] Page fetches location data
- [ ] LocationForm receives location prop
- [ ] Error handling works
- [ ] `npx tsc --noEmit` passes

## Phase 5: Navigation (Optional - May Defer)

### Subtask 5.1: Add Locations to Settings Navigation
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/layout.tsx`
**Instructions**:
Add a "Locations" navigation item after "Users" in the navigation array (around line 33):
```typescript
{ name: 'Locations', href: '/settings/locations', icon: MapPin, adminOnly: true },
```
Also import MapPin from lucide-react.

**Note**: This subtask may be deferred to a separate issue if the preference is to access Locations only through the Settings page.

**Completion Criteria**:
- [ ] MapPin icon imported
- [ ] Locations nav item added (admin only)
- [ ] Navigation works correctly

## Phase 6: Final Validation

### Subtask 6.1: Build and Type Check
**Instructions**:
1. Run `npx tsc --noEmit` - must pass with no errors
2. Run `npm run build` - must complete successfully
3. Run `npm run lint` - must pass

**Completion Criteria**:
- [ ] TypeScript check passes
- [ ] Build completes
- [ ] Lint passes

### Subtask 6.2: Manual Testing Checklist
**Instructions**:
1. Navigate to /settings/locations
2. Create a new location with all fields
3. Verify it appears in the list
4. Edit the location
5. Set it as default
6. Create another location
7. Toggle active status
8. Delete a location
9. Verify default location cannot be the only one

**Completion Criteria**:
- [ ] All CRUD operations work
- [ ] Default location logic works
- [ ] Validation errors display properly

---

## Summary of Deliverables

**Files Created**: 8
- `src/types/location.ts` - Zod schemas and TypeScript types
- `src/services/location.ts` - Business logic and utilities
- `src/app/api/locations/route.ts` - List/Create API
- `src/app/api/locations/[id]/route.ts` - GET/PATCH/DELETE API
- `src/components/features/LocationForm.tsx` - Create/Edit form
- `src/components/features/LocationTable.tsx` - List table
- `src/app/(dashboard)/settings/locations/page.tsx` - Management page
- `src/app/(dashboard)/settings/locations/new/page.tsx` - Create page

**Files Modified**: 2
- `prisma/schema.prisma` - Add Location model and enum
- `src/app/(dashboard)/layout.tsx` - Add nav item (optional)

**Directories to Create**:
- `src/app/(dashboard)/settings/locations/`
- `src/app/(dashboard)/settings/locations/new/`
- `src/app/(dashboard)/settings/locations/[id]/`
- `src/app/(dashboard)/settings/locations/[id]/edit/`
- `src/app/api/locations/`
- `src/app/api/locations/[id]/`

## Handoff to Build Agent
1. Execute subtasks in exact order (Phase 1 -> Phase 2 -> Phase 3 -> Phase 4 -> Phase 5 -> Phase 6)
2. Complete each subtask fully before moving to next
3. Run validation commands after each file creation/modification
4. Test completion criteria before marking complete
5. Follow reference patterns exactly - especially auth checks and error handling

## Test Strategy Note
- Unit tests not required for Phase 1 (foundational feature)
- Manual testing via checklist in Subtask 6.2
- E2E tests may be added in future iteration

## Performance Metrics
| Phase | Expected Duration |
|-------|-------------------|
| Investigation | 25m |
| Validation | 10m |
| Planning | 30m |
| **Total Scout-Plan** | **65m** |
| **Build Estimate** | **8-10h** |
