# Implementation Plan
**Generated**: 2025-12-06T12:06:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: Issue #191
**Estimated Build Time**: 4-6 hours
**Complexity**: High (security-critical, many call sites)

## Investigation Summary

### Request Analysis
**Type**: Bug (Critical Security Vulnerability)
**Source**: GitHub Issue #191
**Priority**: Critical

### Task Classification
**Category**: BUG_FIX (Security)
**Test Strategy**: TARGETED - Must test affected modules and cross-tenant isolation
**Suggested Filter**: `--filter="inventory|quantity"`

### Issue Validation
**Status**: Valid - code review confirms vulnerability exists
**Recent Changes**: Last 60 days has multiple commits to `src/services/inventory.ts` but none addressed this companyId filtering gap

### Current State Assessment

**Vulnerability Confirmed**: The functions `getComponentQuantity` and `getComponentQuantities` in `src/services/inventory.ts` do NOT filter by `companyId`. They aggregate `TransactionLine` data joined via `Transaction` but only filter by `componentId` (and optionally `locationId`).

**Root Cause**: When `getComponentQuantity(componentId, locationId?)` is called:
1. It queries `TransactionLine` where `componentId` matches
2. It joins to `Transaction` to check `status: 'approved'` and location
3. It does NOT filter by `Transaction.companyId`

**Attack Vector**: A malicious user from Company A could:
1. Guess or enumerate a `componentId` belonging to Company B
2. Call any endpoint using these functions (e.g., `/api/components/[id]`)
3. The endpoint validates component ownership via `companyId` filter on Component
4. BUT `getComponentQuantity` returns quantities from ALL companies' transactions

**Secondary Concern**: `getComponentQuantitiesByLocation` already receives `companyId` and uses it to filter locations, but it calls `getComponentQuantity` without passing the companyId for the quantity calculation.

### Dependencies & Blockers
1. No external dependencies or blockers
2. All callers already have access to `companyId` from session or context

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: High (security-critical with many call sites)
**Effort**: 4-6 hours
**Risk**: Medium (breaking change to function signatures, but all callers need updating)

### Patterns Identified
**Primary**: Transaction queries already use `companyId` filter - e.g., `createReceiptTransaction`, `createBuildTransaction`
**Secondary**: The existing `getComponentQuantitiesByLocation` shows the pattern - it accepts `companyId` and uses it for location filtering

### Ripple Effect Analysis

**Files Identified**: 15 files total

**Direct Callers of `getComponentQuantity`**:
1. `src/services/inventory.ts:251` - `getComponentQuantitiesByLocation` (internal call)
2. `src/services/transfer.ts:101` - `createTransferTransaction`
3. `src/services/chatbot-queries.ts:66,119` - `getSkuBuildableDetails`, `getComponentInventoryDetails`
4. `src/app/api/components/[id]/route.ts:181,331` - GET and PATCH handlers

**Direct Callers of `getComponentQuantities`**:
1. `src/services/inventory.ts:680` - `checkInsufficientInventory` (internal call)
2. `src/services/bom.ts:89,144,208` - `calculateMaxBuildableUnits`, `calculateMaxBuildableUnitsForSKUs`, `calculateLimitingFactors`
3. `src/services/forecast.ts:238,324` - `getComponentForecasts`, `getComponentForecastById`
4. `src/services/lowstock-alert.ts:217,324` - `evaluateLowStockAlerts`, `getComponentsInAlertStatus`
5. `src/app/api/dashboard/route.ts:107` - GET handler
6. `src/app/(dashboard)/components/page.tsx:73,128` - getComponents function
7. `src/app/api/components/route.ts:74,125` - GET handler
8. `src/app/api/export/components/route.ts:46` - GET handler
9. `src/app/api/bom-versions/[id]/route.ts:73,178` - GET and PATCH handlers
10. `src/app/api/bom-versions/[id]/activate/route.ts:54` - POST handler
11. `src/app/api/bom-versions/[id]/clone/route.ts:65` - POST handler
12. `src/app/api/skus/[id]/bom-versions/route.ts:83,193` - GET and POST handlers

**TOTAL FILES AFFECTED**: 15 files need updates

---

## Executive Summary

Fix a critical security vulnerability where `getComponentQuantity` and `getComponentQuantities` leak inventory data across company boundaries. The fix requires adding a `companyId` parameter to these functions and updating all 15 caller sites to pass the authenticated user's company ID. This ensures transactions are only aggregated for the requesting company.

## Phase 0: Pre-flight Verification

### Subtask 0.1: Verify Prisma Schema Understanding
**File**: `prisma/schema.prisma`
**Instructions**:
1. Confirm `Transaction` model has `companyId` field
2. Confirm `TransactionLine` relates to `Transaction` via `transactionId`
3. Understand that companyId filtering must be at the `Transaction` level

**Completion Criteria**:
- [ ] Transaction.companyId field verified
- [ ] Relationship chain documented

---

## Phase 1: Core Service Layer Fix

### Subtask 1.1: Update `getComponentQuantity` Function Signature
**File**: `/home/pbrown/SkuInventory/src/services/inventory.ts`
**Pattern**: Follow existing functions like `createReceiptTransaction` that require `companyId`
**Instructions**:

1. Update function signature at line 46:
```typescript
export async function getComponentQuantity(
  componentId: string,
  companyId: string,
  locationId?: string
): Promise<number> {
```

2. Update global total query (lines 52-59) to add companyId filter:
```typescript
const result = await prisma.transactionLine.aggregate({
  where: {
    componentId,
    transaction: {
      companyId,
      status: 'approved',
    },
  },
  _sum: { quantityChange: true },
})
```

3. Update regular (non-transfer) query (lines 69-79) to add companyId:
```typescript
const regularResult = await prisma.transactionLine.aggregate({
  where: {
    componentId,
    transaction: {
      companyId,
      locationId,
      type: { not: 'transfer' },
      status: 'approved',
    },
  },
  _sum: { quantityChange: true },
})
```

4. Update transferFromResult query (lines 82-93) to add companyId:
```typescript
const transferFromResult = await prisma.transactionLine.aggregate({
  where: {
    componentId,
    quantityChange: { lt: 0 },
    transaction: {
      companyId,
      type: 'transfer',
      fromLocationId: locationId,
      status: 'approved',
    },
  },
  _sum: { quantityChange: true },
})
```

5. Update transferToResult query (lines 96-107) to add companyId:
```typescript
const transferToResult = await prisma.transactionLine.aggregate({
  where: {
    componentId,
    quantityChange: { gt: 0 },
    transaction: {
      companyId,
      type: 'transfer',
      toLocationId: locationId,
      status: 'approved',
    },
  },
  _sum: { quantityChange: true },
})
```

**Completion Criteria**:
- [ ] Function signature updated to require `companyId`
- [ ] All 4 aggregate queries include `companyId` filter
- [ ] TypeScript compiles without errors

### Subtask 1.2: Update `getComponentQuantities` Function Signature
**File**: `/home/pbrown/SkuInventory/src/services/inventory.ts`
**Instructions**:

1. Update function signature at line 126:
```typescript
export async function getComponentQuantities(
  componentIds: string[],
  companyId: string,
  locationId?: string
): Promise<Map<string, number>> {
```

2. Update global totals groupBy query (lines 132-139) to add companyId:
```typescript
const results = await prisma.transactionLine.groupBy({
  by: ['componentId'],
  where: {
    componentId: { in: componentIds },
    transaction: {
      companyId,
      status: 'approved',
    },
  },
  _sum: { quantityChange: true },
})
```

3. Update regularResults groupBy query (lines 165-176) to add companyId:
```typescript
const regularResults = await prisma.transactionLine.groupBy({
  by: ['componentId'],
  where: {
    componentId: { in: componentIds },
    transaction: {
      companyId,
      locationId,
      type: { not: 'transfer' },
      status: 'approved',
    },
  },
  _sum: { quantityChange: true },
})
```

4. Update transferFromResults groupBy query (lines 184-196) to add companyId:
```typescript
const transferFromResults = await prisma.transactionLine.groupBy({
  by: ['componentId'],
  where: {
    componentId: { in: componentIds },
    quantityChange: { lt: 0 },
    transaction: {
      companyId,
      type: 'transfer',
      fromLocationId: locationId,
      status: 'approved',
    },
  },
  _sum: { quantityChange: true },
})
```

5. Update transferToResults groupBy query (lines 204-216) to add companyId:
```typescript
const transferToResults = await prisma.transactionLine.groupBy({
  by: ['componentId'],
  where: {
    componentId: { in: componentIds },
    quantityChange: { gt: 0 },
    transaction: {
      companyId,
      type: 'transfer',
      toLocationId: locationId,
      status: 'approved',
    },
  },
  _sum: { quantityChange: true },
})
```

**Completion Criteria**:
- [ ] Function signature updated to require `companyId`
- [ ] All 4 groupBy queries include `companyId` filter
- [ ] TypeScript compiles without errors

### Subtask 1.3: Update `getComponentQuantitiesByLocation` Internal Call
**File**: `/home/pbrown/SkuInventory/src/services/inventory.ts`
**Instructions**:

1. Update line 251 to pass companyId:
```typescript
const quantity = await getComponentQuantity(componentId, companyId, location.id)
```

**Completion Criteria**:
- [ ] Internal call updated to pass companyId
- [ ] Function continues to work correctly

### Subtask 1.4: Update `checkInsufficientInventory` Internal Call
**File**: `/home/pbrown/SkuInventory/src/services/inventory.ts`
**Instructions**:

1. Update function signature at line 653 to include companyId:
```typescript
export async function checkInsufficientInventory(params: {
  bomVersionId: string
  companyId: string
  unitsToBuild: number
  locationId?: string
}): Promise<InsufficientInventoryItem[]> {
  const { bomVersionId, companyId, unitsToBuild, locationId } = params
```

2. Update line 680 to pass companyId:
```typescript
const quantities = await getComponentQuantities(componentIds, companyId, locationId)
```

**Completion Criteria**:
- [ ] Function signature updated
- [ ] Internal call passes companyId
- [ ] TypeScript compiles without errors

### Subtask 1.5: Update `createBuildTransaction` Call to `checkInsufficientInventory`
**File**: `/home/pbrown/SkuInventory/src/services/inventory.ts`
**Instructions**:

1. Update the call at lines 862-866:
```typescript
const insufficientItems = await checkInsufficientInventory({
  bomVersionId,
  companyId,
  unitsToBuild,
  locationId: locationIdToUse ?? undefined,
})
```

**Completion Criteria**:
- [ ] Call updated to include companyId
- [ ] Build transaction flow works correctly

---

## Phase 2: Update Service Layer Callers

### Subtask 2.1: Update `transfer.ts` Caller
**File**: `/home/pbrown/SkuInventory/src/services/transfer.ts`
**Instructions**:

1. Update line 101:
```typescript
const availableQuantity = await getComponentQuantity(componentId, companyId, fromLocationId)
```

**Completion Criteria**:
- [ ] Call updated to pass companyId
- [ ] Transfer functionality still works

### Subtask 2.2: Update `bom.ts` Callers
**File**: `/home/pbrown/SkuInventory/src/services/bom.ts`
**Instructions**:

1. Update `calculateMaxBuildableUnits` function signature (line 62) to add companyId:
```typescript
export async function calculateMaxBuildableUnits(
  skuId: string,
  companyId: string,
  locationId?: string
): Promise<number | null> {
```

2. Update line 89:
```typescript
const quantities = await getComponentQuantities(componentIds, companyId, locationId)
```

3. Update `calculateMaxBuildableUnitsForSKUs` function signature (line 108) to add companyId:
```typescript
export async function calculateMaxBuildableUnitsForSKUs(
  skuIds: string[],
  companyId: string,
  locationId?: string
): Promise<Map<string, number | null>> {
```

4. Update line 144:
```typescript
const quantities = await getComponentQuantities(Array.from(allComponentIds), companyId, locationId)
```

5. Update `calculateLimitingFactors` function signature (line 176) to add companyId:
```typescript
export async function calculateLimitingFactors(
  skuId: string,
  companyId: string,
  locationId?: string,
  limit: number = 3
): Promise<LimitingComponent[] | null> {
```

6. Update line 208:
```typescript
const quantities = await getComponentQuantities(componentIds, companyId, locationId)
```

**Completion Criteria**:
- [ ] All 3 function signatures updated
- [ ] All 3 internal calls updated
- [ ] TypeScript compiles without errors

### Subtask 2.3: Update `forecast.ts` Callers
**File**: `/home/pbrown/SkuInventory/src/services/forecast.ts`
**Instructions**:

1. Update line 238 in `getComponentForecasts`:
```typescript
getComponentQuantities(componentIds, companyId),
```

2. Update line 324 in `getComponentForecastById`:
```typescript
const quantities = await getComponentQuantities([componentId], component.companyId)
```

**Completion Criteria**:
- [ ] Both calls updated
- [ ] Forecast functionality still works

### Subtask 2.4: Update `lowstock-alert.ts` Callers
**File**: `/home/pbrown/SkuInventory/src/services/lowstock-alert.ts`
**Instructions**:

1. Update line 217 in `evaluateLowStockAlerts`:
```typescript
const quantities = await getComponentQuantities(componentIds, companyId)
```

2. Update line 324 in `getComponentsInAlertStatus`:
```typescript
const quantities = await getComponentQuantities(componentIds, companyId)
```

**Completion Criteria**:
- [ ] Both calls updated
- [ ] Alert functionality still works

### Subtask 2.5: Update `chatbot-queries.ts` Callers
**File**: `/home/pbrown/SkuInventory/src/services/chatbot-queries.ts`
**Instructions**:

1. Update line 66 in `getSkuBuildableDetails`:
```typescript
const qty = await getComponentQuantity(line.componentId, companyId)
```

2. Update line 57-58 to pass companyId to `calculateMaxBuildableUnits` and `calculateLimitingFactors`:
```typescript
const maxBuildable = await calculateMaxBuildableUnits(sku.id, companyId)
const limitingFactors = await calculateLimitingFactors(sku.id, companyId, undefined, 10)
```

3. Update line 119 in `getComponentInventoryDetails`:
```typescript
const totalQuantity = await getComponentQuantity(component.id, companyId)
```

**Completion Criteria**:
- [ ] All calls updated
- [ ] Chatbot queries still work

---

## Phase 3: Update API Route Callers

### Subtask 3.1: Update `/api/components/[id]/route.ts`
**File**: `/home/pbrown/SkuInventory/src/app/api/components/[id]/route.ts`
**Instructions**:

1. Update line 181 (GET handler):
```typescript
const quantityOnHand = await getComponentQuantity(id, selectedCompanyId, locationId)
```

2. Update line 187-189 to pass companyId to `calculateMaxBuildableUnitsForSKUs`:
```typescript
const buildableUnits = skuIds.length > 0
  ? await calculateMaxBuildableUnitsForSKUs(skuIds, selectedCompanyId, locationId)
  : new Map<string, number | null>()
```

3. Update line 331 (PATCH handler):
```typescript
const quantityOnHand = await getComponentQuantity(id, selectedCompanyId)
```

**Completion Criteria**:
- [ ] GET handler updated (2 calls)
- [ ] PATCH handler updated (1 call)
- [ ] Component API still works

### Subtask 3.2: Update `/api/dashboard/route.ts`
**File**: `/home/pbrown/SkuInventory/src/app/api/dashboard/route.ts`
**Instructions**:

1. Update line 107:
```typescript
const quantities = await getComponentQuantities(componentIds, selectedCompanyId, locationId)
```

2. Update line 168-170 to pass companyId to `calculateMaxBuildableUnitsForSKUs`:
```typescript
const [buildableUnits, bomCosts] = await Promise.all([
  skuIds.length > 0 ? calculateMaxBuildableUnitsForSKUs(skuIds, selectedCompanyId, locationId) : new Map<string, number | null>(),
  activeBomIds.length > 0 ? calculateBOMUnitCosts(activeBomIds) : new Map<string, number>(),
])
```

**Completion Criteria**:
- [ ] Both calls updated
- [ ] Dashboard API still works

### Subtask 3.3: Update `/api/components/route.ts`
**File**: `/home/pbrown/SkuInventory/src/app/api/components/route.ts`
**Instructions**:

1. Update line 74:
```typescript
const quantities = await getComponentQuantities(componentIds, selectedCompanyId, locationId)
```

2. Update line 125:
```typescript
const quantities = await getComponentQuantities(componentIds, selectedCompanyId, locationId)
```

**Completion Criteria**:
- [ ] Both calls updated
- [ ] Components list API still works

### Subtask 3.4: Update `/api/export/components/route.ts`
**File**: `/home/pbrown/SkuInventory/src/app/api/export/components/route.ts`
**Instructions**:

1. Update line 46:
```typescript
const quantities = await getComponentQuantities(componentIds, selectedCompanyId, locationId)
```

**Completion Criteria**:
- [ ] Call updated
- [ ] Export functionality still works

### Subtask 3.5: Update `/api/bom-versions/[id]/route.ts`
**File**: `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/route.ts`
**Instructions**:

1. Update line 73 (GET handler):
```typescript
const quantities = await getComponentQuantities(componentIds, selectedCompanyId, locationId)
```

2. Update line 178 (PATCH handler):
```typescript
const quantities = await getComponentQuantities(componentIds, selectedCompanyId, locationId)
```

**Completion Criteria**:
- [ ] Both calls updated
- [ ] BOM version API still works

### Subtask 3.6: Update `/api/bom-versions/[id]/activate/route.ts`
**File**: `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/activate/route.ts`
**Instructions**:

1. Update line 54:
```typescript
const quantities = await getComponentQuantities(componentIds, selectedCompanyId, locationId)
```

**Completion Criteria**:
- [ ] Call updated
- [ ] BOM activation still works

### Subtask 3.7: Update `/api/bom-versions/[id]/clone/route.ts`
**File**: `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/clone/route.ts`
**Instructions**:

1. Update line 65:
```typescript
const quantities = await getComponentQuantities(componentIds, selectedCompanyId, locationId)
```

**Completion Criteria**:
- [ ] Call updated
- [ ] BOM cloning still works

### Subtask 3.8: Update `/api/skus/[id]/bom-versions/route.ts`
**File**: `/home/pbrown/SkuInventory/src/app/api/skus/[id]/bom-versions/route.ts`
**Instructions**:

1. Update line 83 (GET handler):
```typescript
const quantities = await getComponentQuantities(Array.from(allComponentIds), selectedCompanyId, locationId)
```

2. Update line 193 (POST handler):
```typescript
const quantities = await getComponentQuantities(componentIds, selectedCompanyId, locationId)
```

**Completion Criteria**:
- [ ] Both calls updated
- [ ] SKU BOM versions API still works

---

## Phase 4: Update Page Components

### Subtask 4.1: Update `/app/(dashboard)/components/page.tsx`
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/components/page.tsx`
**Instructions**:

1. Update line 73:
```typescript
const quantities = await getComponentQuantities(componentIds, selectedCompanyId, params.locationId)
```

2. Update line 128:
```typescript
const quantities = await getComponentQuantities(componentIds, selectedCompanyId, params.locationId)
```

Note: The `getComponents` function receives `selectedCompanyId` as its first parameter, so it's available.

**Completion Criteria**:
- [ ] Both calls updated
- [ ] Components page still renders

---

## Phase 5: Verification and Testing

### Subtask 5.1: TypeScript Compilation Check
**Instructions**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] No TypeScript errors
- [ ] All imports resolved

### Subtask 5.2: Build Verification
**Instructions**:
```bash
npm run build
```

**Completion Criteria**:
- [ ] Build completes successfully
- [ ] No new warnings related to inventory functions

### Subtask 5.3: Lint Check
**Instructions**:
```bash
npm run lint
```

**Completion Criteria**:
- [ ] No linting errors
- [ ] No unused imports

---

## Summary of Deliverables

**Files Modified**: 15 files

| File | Changes |
|------|---------|
| `src/services/inventory.ts` | Update 4 functions: `getComponentQuantity`, `getComponentQuantities`, `getComponentQuantitiesByLocation` (caller), `checkInsufficientInventory` |
| `src/services/transfer.ts` | Update 1 call |
| `src/services/bom.ts` | Update 3 function signatures + 3 calls |
| `src/services/forecast.ts` | Update 2 calls |
| `src/services/lowstock-alert.ts` | Update 2 calls |
| `src/services/chatbot-queries.ts` | Update 4 calls |
| `src/app/api/components/[id]/route.ts` | Update 3 calls |
| `src/app/api/dashboard/route.ts` | Update 2 calls |
| `src/app/api/components/route.ts` | Update 2 calls |
| `src/app/api/export/components/route.ts` | Update 1 call |
| `src/app/api/bom-versions/[id]/route.ts` | Update 2 calls |
| `src/app/api/bom-versions/[id]/activate/route.ts` | Update 1 call |
| `src/app/api/bom-versions/[id]/clone/route.ts` | Update 1 call |
| `src/app/api/skus/[id]/bom-versions/route.ts` | Update 2 calls |
| `src/app/(dashboard)/components/page.tsx` | Update 2 calls |

**Total Call Sites Updated**: ~30

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 0 through Phase 5)
2. Complete each Phase fully before moving to next
3. Test completion criteria before next subtask
4. Follow reference patterns exactly
5. Run `npx tsc --noEmit` after each major phase to catch errors early

## Test Strategy Note

- After implementation, manually test:
  1. Login as user from Company A
  2. View component inventory quantities
  3. Verify quantities are only from Company A's transactions
  4. (If possible) Create test transactions in Company B and verify they do not appear in Company A's quantities

## Security Notes

- This fix ensures multi-tenant data isolation
- All inventory calculations now require explicit company context
- No default behavior that could leak data

## Performance Metrics

| Phase | Estimated Duration |
|-------|-------------------|
| Phase 0 | 5m |
| Phase 1 | 45m |
| Phase 2 | 45m |
| Phase 3 | 60m |
| Phase 4 | 15m |
| Phase 5 | 15m |
| **Total** | **~3 hours** |
