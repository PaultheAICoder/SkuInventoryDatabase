# Implementation Plan
**Generated**: 2025-12-04T08:30:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: Issue #90
**Estimated Build Time**: 6-8 hours
**Complexity**: Medium

## Investigation Summary

### Request Analysis
**Type**: Feature
**Source**: GitHub Issue #90 (Parent #10 - Shopify Integration)
**Priority**: Medium

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="shopify|connection"` or None

### Issue Validation
**Status**: Valid
**Recent Changes**: None - new feature building on existing ShopifyConnection model and ShopifyClient service

### Current State Assessment

**Database (Prisma Schema)**:
- `ShopifyConnection` model exists with fields: `id`, `companyId`, `shopName`, `accessToken`, `isActive`, `lastSyncAt`, `syncStatus`, `createdAt`, `updatedAt`
- One-to-one relationship with Company via `@@unique([companyId])`
- Related to `ShopifyOrder[]`

**Existing Services**:
- `src/services/shopify.ts` - `ShopifyClient` class with `testConnection()` method that calls `fetchShopInfo()`
- `src/lib/crypto.ts` - `encryptToken()`, `decryptToken()`, `isEncryptionAvailable()` functions for AES-256-GCM encryption

**Existing Types**:
- `src/types/shopify.ts` - Shopify API types including `ShopifyShopResponse` for shop info

**Existing API Routes**:
- `src/app/api/shopify/mappings/route.ts` - Pattern for Shopify-related API routes
- No existing `/api/shopify/connection` routes

**Existing UI**:
- `src/app/(dashboard)/settings/page.tsx` - Main settings page (client component)
- `src/app/(dashboard)/settings/integrations/mappings/page.tsx` - Channel mappings page
- `src/components/features/SettingsForm.tsx` - Example settings form component
- `src/components/features/SkuMappingForm.tsx` - Dialog-based form with state management

### Dependencies & Blockers
1. **ShopifyConnection model** - EXISTS in schema
2. **ShopifyClient.testConnection()** - EXISTS in service
3. **Crypto utilities** - EXISTS in lib
4. **AlertDialog component** - EXISTS in UI components (for disconnect confirmation)

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Medium
**Effort**: 6-8 hours
**Risk**: Low - follows existing patterns, well-defined scope

### Patterns Identified

**Primary Pattern - API Routes**: `src/app/api/shopify/mappings/route.ts`
- Uses `getServerSession(authOptions)` for auth
- Checks `session.user.role` for authorization
- Uses `session.user.selectedCompanyId` for company scoping
- Returns `{ data: ... }` or `{ error: ... }` structure

**Secondary Pattern - Settings Form**: `src/components/features/SettingsForm.tsx`
- Uses Card components for sections
- Manages form state with useState
- Shows loading, success, and error states
- Uses shadcn/ui Input, Label, Button components

**Tertiary Pattern - Dialog Form**: `src/components/features/SkuMappingForm.tsx`
- Dialog-based form for create/edit
- API calls within form component
- Loading states for async operations

### Ripple Effect Analysis
**Files Identified**: 1 modification + 5 new files

Files to Create:
- `src/app/api/shopify/connection/route.ts` - Connection CRUD
- `src/app/api/shopify/connection/test/route.ts` - Test connection
- `src/app/(dashboard)/settings/integrations/page.tsx` - Integrations hub
- `src/app/(dashboard)/settings/integrations/shopify/page.tsx` - Shopify settings
- `src/components/features/ShopifyConnectionForm.tsx` - Connection form
- `src/types/shopify-connection.ts` - Types and Zod schemas

Files to Modify:
- `src/app/(dashboard)/settings/page.tsx` - Add link to integrations (optional)

---

## Executive Summary

This issue implements the Shopify connection settings UI and API. The implementation creates API endpoints for managing Shopify store connections (GET, POST, DELETE, and test) with proper token encryption. A new integrations hub page will provide navigation to various integration settings, with a dedicated Shopify settings page featuring a form component for configuring, testing, and disconnecting store connections. Role-based access ensures admins can configure connections while ops users have read-only access.

---

## Phase 1: Types and Validation Schemas

### Subtask 1.1: Create Shopify Connection Types

**File**: `src/types/shopify-connection.ts` (CREATE)

**Pattern**: Follow `src/types/settings.ts` structure

**Instructions**:
1. Create Zod schemas for connection input validation
2. Define TypeScript interfaces for API responses
3. Export all types

**Code**:
```typescript
import { z } from 'zod'

// Connection input schema for POST
export const createConnectionSchema = z.object({
  shopName: z.string()
    .min(1, 'Shop name is required')
    .max(100)
    .regex(/^[a-zA-Z0-9-]+$/, 'Shop name must be alphanumeric with hyphens only'),
  accessToken: z.string()
    .min(1, 'Access token is required')
    .max(255),
})

export type CreateConnectionInput = z.infer<typeof createConnectionSchema>

// Test connection input schema (optional fields for testing with stored credentials)
export const testConnectionSchema = z.object({
  shopName: z.string().min(1).max(100).optional(),
  accessToken: z.string().min(1).max(255).optional(),
})

export type TestConnectionInput = z.infer<typeof testConnectionSchema>

// Connection response (without exposing full token)
export interface ConnectionResponse {
  id: string
  shopName: string
  isActive: boolean
  lastSyncAt: string | null
  syncStatus: string | null
  hasToken: boolean
  createdAt: string
  updatedAt: string
}

// Test connection response
export interface TestConnectionResponse {
  success: boolean
  error?: string
  shopInfo?: {
    name: string
    email: string
    domain: string
    currency: string
    plan: string
  }
}

// API response wrappers
export interface GetConnectionApiResponse {
  data: ConnectionResponse | null
}

export interface CreateConnectionApiResponse {
  data: ConnectionResponse
  message: string
}

export interface TestConnectionApiResponse {
  data: TestConnectionResponse
}
```

**Completion Criteria**:
- [ ] File created with all types
- [ ] Zod schemas validate correctly
- [ ] Types exported properly

---

## Phase 2: API Routes

### Subtask 2.1: Create Connection CRUD Route

**File**: `src/app/api/shopify/connection/route.ts` (CREATE)

**Pattern**: Follow `src/app/api/shopify/mappings/route.ts` and `src/app/api/settings/route.ts`

**Instructions**:
1. Implement GET - return current connection (masked token)
2. Implement POST - create or update connection with encrypted token
3. Implement DELETE - soft delete (set isActive = false)
4. Use proper authorization (admin only for POST/DELETE, ops can read)

**Code Snippets**:

GET handler (all authenticated except viewer):
```typescript
export async function GET() {
  const session = await getServerSession(authOptions)
  if (!session?.user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }
  if (session.user.role === 'viewer') {
    return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
  }

  const connection = await prisma.shopifyConnection.findUnique({
    where: { companyId: session.user.selectedCompanyId },
  })

  if (!connection) {
    return NextResponse.json({ data: null })
  }

  return NextResponse.json({
    data: {
      id: connection.id,
      shopName: connection.shopName,
      isActive: connection.isActive,
      lastSyncAt: connection.lastSyncAt?.toISOString() || null,
      syncStatus: connection.syncStatus,
      hasToken: !!connection.accessToken,
      createdAt: connection.createdAt.toISOString(),
      updatedAt: connection.updatedAt.toISOString(),
    }
  })
}
```

POST handler (admin only):
```typescript
export async function POST(request: NextRequest) {
  // Auth check - admin only
  // Validate body with createConnectionSchema
  // Encrypt token with encryptToken()
  // Upsert connection (prisma.shopifyConnection.upsert)
  // Return masked connection data
}
```

DELETE handler (admin only):
```typescript
export async function DELETE() {
  // Auth check - admin only
  // Update connection with isActive = false
  // Return success message
}
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run lint
```

**Completion Criteria**:
- [ ] GET returns connection without exposing token
- [ ] POST creates/updates connection with encrypted token
- [ ] DELETE soft-deletes connection
- [ ] Admin role required for POST/DELETE
- [ ] Viewer role blocked from all endpoints
- [ ] Ops role can only read

---

### Subtask 2.2: Create Test Connection Route

**File**: `src/app/api/shopify/connection/test/route.ts` (CREATE)

**Pattern**: Follow `src/services/shopify.ts` ShopifyClient.testConnection()

**Instructions**:
1. Accept optional shopName and accessToken in body
2. If not provided, use stored credentials (decrypt token)
3. Create ShopifyClient instance and call testConnection()
4. Return success with shop info or error message

**Code Snippets**:
```typescript
export async function POST(request: NextRequest) {
  const session = await getServerSession(authOptions)
  if (!session?.user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }
  if (session.user.role !== 'admin') {
    return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
  }

  const body = await request.json()
  const validation = testConnectionSchema.safeParse(body)

  // If body has credentials, use them
  // Otherwise, fetch stored connection and decrypt token

  let shopName: string
  let accessToken: string

  if (validation.data?.shopName && validation.data?.accessToken) {
    shopName = validation.data.shopName
    accessToken = validation.data.accessToken
  } else {
    // Fetch stored connection
    const connection = await prisma.shopifyConnection.findUnique({
      where: { companyId: session.user.selectedCompanyId },
    })
    if (!connection) {
      return NextResponse.json({
        data: { success: false, error: 'No connection configured' }
      })
    }
    shopName = connection.shopName
    accessToken = decryptToken(connection.accessToken)
  }

  try {
    const client = new ShopifyClient(shopName, accessToken)
    const shopInfo = await client.fetchShopInfo()
    return NextResponse.json({
      data: {
        success: true,
        shopInfo: {
          name: shopInfo.name,
          email: shopInfo.email,
          domain: shopInfo.domain,
          currency: shopInfo.currency,
          plan: shopInfo.plan_name,
        }
      }
    })
  } catch (error) {
    return NextResponse.json({
      data: {
        success: false,
        error: error instanceof ShopifyAuthError
          ? 'Invalid credentials'
          : 'Connection failed'
      }
    })
  }
}
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run lint
```

**Completion Criteria**:
- [ ] Tests with provided credentials
- [ ] Tests with stored credentials (decrypted)
- [ ] Returns shop info on success
- [ ] Returns error message on failure
- [ ] Admin only access

---

## Phase 3: UI Pages

### Subtask 3.1: Create Integrations Hub Page

**File**: `src/app/(dashboard)/settings/integrations/page.tsx` (CREATE)

**Pattern**: Follow `src/app/(dashboard)/settings/page.tsx` structure

**Instructions**:
1. Create simple hub page with links to integration settings
2. Use Card components for each integration option
3. Display connection status for each integration

**Code Snippets**:
```typescript
'use client'

import Link from 'next/link'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { ShoppingBag, ExternalLink } from 'lucide-react'
import { useEffect, useState } from 'react'

export default function IntegrationsPage() {
  const [shopifyStatus, setShopifyStatus] = useState<'loading' | 'connected' | 'disconnected'>('loading')

  useEffect(() => {
    fetch('/api/shopify/connection')
      .then(res => res.json())
      .then(data => {
        setShopifyStatus(data.data?.isActive ? 'connected' : 'disconnected')
      })
      .catch(() => setShopifyStatus('disconnected'))
  }, [])

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-3xl font-bold">Integrations</h1>
        <p className="text-muted-foreground">Connect external platforms to sync inventory and orders</p>
      </div>

      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
        <Link href="/settings/integrations/shopify">
          <Card className="hover:border-primary transition-colors cursor-pointer">
            <CardHeader>
              <div className="flex items-center justify-between">
                <ShoppingBag className="h-8 w-8 text-green-600" />
                <Badge variant={shopifyStatus === 'connected' ? 'default' : 'secondary'}>
                  {shopifyStatus === 'loading' ? '...' : shopifyStatus === 'connected' ? 'Connected' : 'Not Connected'}
                </Badge>
              </div>
              <CardTitle className="flex items-center gap-2">
                Shopify
                <ExternalLink className="h-4 w-4 text-muted-foreground" />
              </CardTitle>
              <CardDescription>
                Sync orders and products from your Shopify store
              </CardDescription>
            </CardHeader>
          </Card>
        </Link>

        {/* Placeholder for future integrations */}
        <Card className="opacity-50">
          <CardHeader>
            <CardTitle className="text-muted-foreground">Amazon</CardTitle>
            <CardDescription>Coming soon</CardDescription>
          </CardHeader>
        </Card>
      </div>
    </div>
  )
}
```

**Completion Criteria**:
- [ ] Page renders with integration cards
- [ ] Shopify card shows connection status
- [ ] Card links to Shopify settings page
- [ ] Visible on all device sizes

---

### Subtask 3.2: Create Shopify Settings Page

**File**: `src/app/(dashboard)/settings/integrations/shopify/page.tsx` (CREATE)

**Pattern**: Follow `src/app/(dashboard)/settings/page.tsx`

**Instructions**:
1. Fetch current connection status on load
2. Render ShopifyConnectionForm component
3. Handle success/error states

**Code Snippets**:
```typescript
'use client'

import { useState, useEffect, useCallback } from 'react'
import { useSession } from 'next-auth/react'
import { ShopifyConnectionForm } from '@/components/features/ShopifyConnectionForm'
import type { ConnectionResponse } from '@/types/shopify-connection'

export default function ShopifySettingsPage() {
  const { data: session } = useSession()
  const [connection, setConnection] = useState<ConnectionResponse | null>(null)
  const [isLoading, setIsLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  const fetchConnection = useCallback(async () => {
    setIsLoading(true)
    setError(null)
    try {
      const res = await fetch('/api/shopify/connection')
      if (res.status === 403) {
        setError('You do not have permission to view Shopify settings')
        return
      }
      if (!res.ok) throw new Error('Failed to load connection')
      const data = await res.json()
      setConnection(data.data)
    } catch (err) {
      setError(err instanceof Error ? err.message : 'An error occurred')
    } finally {
      setIsLoading(false)
    }
  }, [])

  useEffect(() => {
    if (session?.user?.selectedCompanyId) {
      fetchConnection()
    }
  }, [session?.user?.selectedCompanyId, fetchConnection])

  const isAdmin = session?.user?.role === 'admin'

  // Render loading/error/form states...
}
```

**Completion Criteria**:
- [ ] Page fetches connection status
- [ ] Shows loading state while fetching
- [ ] Renders ShopifyConnectionForm
- [ ] Handles permission errors for viewer role
- [ ] Refetches on company change

---

## Phase 4: Form Component

### Subtask 4.1: Create ShopifyConnectionForm Component

**File**: `src/components/features/ShopifyConnectionForm.tsx` (CREATE)

**Pattern**: Follow `src/components/features/SettingsForm.tsx`

**Instructions**:
1. Create form with shop name and access token inputs
2. Add Test Connection button with status feedback
3. Add Save button (admin only)
4. Add Disconnect button with AlertDialog confirmation (admin only)
5. Show connection status indicators
6. Display read-only view for ops role

**Code Structure**:
```typescript
'use client'

import { useState } from 'react'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from '@/components/ui/alert-dialog'
import { CheckCircle, XCircle, Loader2, Wifi, WifiOff } from 'lucide-react'
import { toast } from 'sonner'
import type { ConnectionResponse, TestConnectionResponse } from '@/types/shopify-connection'

interface ShopifyConnectionFormProps {
  connection: ConnectionResponse | null
  isAdmin: boolean
  onRefresh: () => void
}

export function ShopifyConnectionForm({ connection, isAdmin, onRefresh }: ShopifyConnectionFormProps) {
  const [shopName, setShopName] = useState(connection?.shopName || '')
  const [accessToken, setAccessToken] = useState('')
  const [isSaving, setIsSaving] = useState(false)
  const [isTesting, setIsTesting] = useState(false)
  const [isDisconnecting, setIsDisconnecting] = useState(false)
  const [testResult, setTestResult] = useState<TestConnectionResponse | null>(null)

  const handleTestConnection = async () => {
    setIsTesting(true)
    setTestResult(null)
    try {
      const body = accessToken
        ? { shopName, accessToken }
        : {} // Use stored credentials
      const res = await fetch('/api/shopify/connection/test', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      })
      const data = await res.json()
      setTestResult(data.data)
      if (data.data?.success) {
        toast.success('Connection successful!')
      } else {
        toast.error(data.data?.error || 'Connection failed')
      }
    } catch {
      toast.error('Failed to test connection')
    } finally {
      setIsTesting(false)
    }
  }

  const handleSave = async () => {
    if (!shopName || !accessToken) {
      toast.error('Shop name and access token are required')
      return
    }
    setIsSaving(true)
    try {
      const res = await fetch('/api/shopify/connection', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ shopName, accessToken }),
      })
      if (!res.ok) {
        const data = await res.json()
        throw new Error(data.error || 'Failed to save')
      }
      toast.success('Connection saved successfully')
      setAccessToken('') // Clear token from form
      onRefresh()
    } catch (err) {
      toast.error(err instanceof Error ? err.message : 'Failed to save connection')
    } finally {
      setIsSaving(false)
    }
  }

  const handleDisconnect = async () => {
    setIsDisconnecting(true)
    try {
      const res = await fetch('/api/shopify/connection', { method: 'DELETE' })
      if (!res.ok) throw new Error('Failed to disconnect')
      toast.success('Shopify connection removed')
      onRefresh()
    } catch {
      toast.error('Failed to disconnect')
    } finally {
      setIsDisconnecting(false)
    }
  }

  // Render form with connection status, inputs, and action buttons
  // Show read-only view if not admin
}
```

**UI Elements**:
- Connection Status Badge (Connected/Disconnected)
- Last Sync indicator (if connected)
- Shop name input (text, e.g., "mystore" for mystore.myshopify.com)
- Access token input (password type, masked)
- Test Connection button with loading spinner
- Test result feedback (success with shop info, or error message)
- Save/Update button (disabled if no changes or testing)
- Disconnect button with confirmation dialog
- Read-only view for non-admin users

**Completion Criteria**:
- [ ] Form displays correctly
- [ ] Shop name input works
- [ ] Access token is masked (password type)
- [ ] Test Connection button shows loading state
- [ ] Test result shows success or error
- [ ] Save button creates/updates connection
- [ ] Disconnect shows confirmation dialog
- [ ] Non-admin users see read-only view
- [ ] All buttons disabled during loading states

---

## Phase 5: Integration and Polish

### Subtask 5.1: Add Navigation Link (Optional)

**File**: `src/app/(dashboard)/settings/page.tsx` (MODIFY - OPTIONAL)

**Pattern**: Existing page structure

**Instructions**:
1. Add a link or card to the main settings page pointing to integrations
2. This is optional if there's already a sidebar link

**Note**: Check if sidebar already has Settings > Integrations navigation. If so, skip this subtask.

**Completion Criteria**:
- [ ] Navigation to integrations is accessible from settings

---

## Summary of Deliverables

**Files Created**: 6
- `src/types/shopify-connection.ts` - Types and Zod schemas
- `src/app/api/shopify/connection/route.ts` - Connection CRUD API
- `src/app/api/shopify/connection/test/route.ts` - Test connection API
- `src/app/(dashboard)/settings/integrations/page.tsx` - Integrations hub
- `src/app/(dashboard)/settings/integrations/shopify/page.tsx` - Shopify settings page
- `src/components/features/ShopifyConnectionForm.tsx` - Connection form component

**Files Modified**: 0-1
- `src/app/(dashboard)/settings/page.tsx` - (Optional) Add integrations link

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 through Phase 5)
2. Complete each subtask's completion criteria before moving to next
3. Use these validation commands after each phase:
   ```bash
   npx tsc --noEmit
   npm run lint
   npm run build
   ```
4. Follow reference patterns exactly as specified
5. Test endpoints manually with curl or browser if needed

## Test Strategy Note

- Manual testing via browser is primary method
- Test all role combinations: admin (full access), ops (read-only), viewer (blocked)
- Test connection lifecycle: create -> test -> update -> disconnect
- Test with valid and invalid Shopify credentials

## Authorization Summary

| Endpoint/Action | Admin | Ops | Viewer |
|-----------------|-------|-----|--------|
| GET /api/shopify/connection | Yes | Yes (read-only) | No |
| POST /api/shopify/connection | Yes | No | No |
| DELETE /api/shopify/connection | Yes | No | No |
| POST /api/shopify/connection/test | Yes | No | No |
| View Shopify settings page | Yes | Yes (read-only) | No |
| Configure/Save connection | Yes | No | No |
| Test connection | Yes | No | No |
| Disconnect | Yes | No | No |

## Performance Metrics

| Phase | Duration |
|-------|----------|
| Investigation | 8m |
| Validation | 3m |
| Planning | 12m |
| **Total** | **23m** |
