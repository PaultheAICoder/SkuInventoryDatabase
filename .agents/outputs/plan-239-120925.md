# Implementation Plan
**Generated**: 2025-12-09T21:45:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #239
**Estimated Build Time**: 3-4 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Enhancement/Infrastructure
**Source**: GitHub Issue #239
**Priority**: Medium (completes the feedback system integration)

### Task Classification
**Category**: CHORE (infrastructure/operations task)
**Test Strategy**: FAST_PATH (smoke tests only - this is operations configuration, not code changes)
**Suggested Filter**: None - minimal/no code changes to the application

### Issue Validation
**Status**: Valid
**Recent Changes**: Phases 1-4 (#235, #236, #237, #238) completed as of 2025-12-09

### Current State Assessment

**Existing Infrastructure:**
- Email monitor endpoint: `/api/cron/email-monitor` - FUNCTIONAL (tested successfully on production)
- CRON_SECRET: Configured in `.env` and `docker-compose.prod.yml` - VERIFIED
- Feedback database models: `Feedback` and `EmailMonitorState` - DEPLOYED
- Feedback service: `src/services/feedback.ts` - IMPLEMENTED
- Webhook integration: Creates feedback records on issue creation - VERIFIED
- Email monitor: Uses database for state persistence and deduplication - VERIFIED

**Missing Infrastructure:**
- No systemd timer or cron job to call the endpoint periodically
- No log directory for cron execution logs
- No documentation for scheduler setup

**System Capabilities:**
- systemd version 255 is available
- User `pbrown` has sudo access via the `sudo` group
- Docker containers running: `inventory-app`, `inventory-app-test`, `inventory-db-prod`, `inventory-db-test`

### Dependencies & Blockers

1. **CRON_SECRET** - Already configured in `/home/pbrown/SkuInventory/docker/.env`
2. **Endpoint** - Already exists at `/api/cron/email-monitor` and returns proper response
3. **Production app** - Running and healthy at port 4545
4. **curl** - Available on the system for HTTP requests

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Simple (infrastructure configuration only)
**Effort**: 3-4 hours
**Risk**: Low (no code changes to the application)

### Patterns Identified
**Primary**: Standard systemd timer pattern for scheduled tasks
**Secondary**: Docker service pattern for containerized cron jobs

### Ripple Effect Analysis
**Files Identified**: 0 application code files affected
**New Files**:
- `/etc/systemd/system/inventory-email-monitor.service` (new)
- `/etc/systemd/system/inventory-email-monitor.timer` (new)
- `/home/pbrown/SkuInventory/docs/operations/EMAIL-MONITOR-CRON.md` (new documentation)

---

## Executive Summary

This issue completes Phase 5 of the feedback system by setting up a systemd timer to call the email monitor endpoint every 5 minutes. The endpoint already exists and works correctly. The implementation involves creating systemd service/timer files, configuring logging, and documenting the setup. No application code changes are required.

---

## Phase 1: Create Systemd Service and Timer

### Subtask 1.1: Create Log Directory for Cron Jobs
**Location**: `/var/log/inventory/`
**Instructions**:
1. Create the log directory with proper permissions
2. Set ownership to allow the service to write logs

**Commands**:
```bash
# Create log directory
sudo mkdir -p /var/log/inventory

# Set permissions (readable by everyone, writable by root/adm)
sudo chmod 755 /var/log/inventory

# Optionally set group to adm for log access
sudo chown root:adm /var/log/inventory
```

**Completion Criteria**:
- [ ] Directory `/var/log/inventory/` exists
- [ ] Directory has appropriate permissions

### Subtask 1.2: Create Systemd Service File
**File**: `/etc/systemd/system/inventory-email-monitor.service`
**Instructions**:
1. Create the service file with proper configuration
2. Use the CRON_SECRET from the environment

**Content**:
```ini
[Unit]
Description=Inventory Email Monitor - Poll for email replies
After=network-online.target docker.service
Wants=network-online.target
Requires=docker.service

[Service]
Type=oneshot
Environment="CRON_SECRET=tHhCDDrFWf+5WREIQsSYp75++qjjd0V26qetRtcQvp8="
ExecStart=/usr/bin/curl -s -X GET "http://172.16.20.50:4545/api/cron/email-monitor" \
    -H "Authorization: Bearer ${CRON_SECRET}" \
    -H "Content-Type: application/json" \
    -o /var/log/inventory/email-monitor-last.json \
    -w "\\nHTTP_CODE:%%{http_code}\\n"
TimeoutSec=120

# Log output
StandardOutput=append:/var/log/inventory/email-monitor.log
StandardError=append:/var/log/inventory/email-monitor.log

[Install]
WantedBy=multi-user.target
```

**Commands**:
```bash
# Create the service file
sudo tee /etc/systemd/system/inventory-email-monitor.service > /dev/null << 'EOF'
[Unit]
Description=Inventory Email Monitor - Poll for email replies
After=network-online.target docker.service
Wants=network-online.target
Requires=docker.service

[Service]
Type=oneshot
Environment="CRON_SECRET=tHhCDDrFWf+5WREIQsSYp75++qjjd0V26qetRtcQvp8="
ExecStart=/usr/bin/curl -s -X GET "http://172.16.20.50:4545/api/cron/email-monitor" \
    -H "Authorization: Bearer ${CRON_SECRET}" \
    -H "Content-Type: application/json" \
    -o /var/log/inventory/email-monitor-last.json \
    -w "\nHTTP_CODE:%{http_code}\n"
TimeoutSec=120

StandardOutput=append:/var/log/inventory/email-monitor.log
StandardError=append:/var/log/inventory/email-monitor.log

[Install]
WantedBy=multi-user.target
EOF
```

**Completion Criteria**:
- [ ] Service file exists at `/etc/systemd/system/inventory-email-monitor.service`
- [ ] File has correct syntax (verified by `systemd-analyze verify`)

### Subtask 1.3: Create Systemd Timer File
**File**: `/etc/systemd/system/inventory-email-monitor.timer`
**Instructions**:
1. Create the timer file to run every 5 minutes
2. Configure persistence across reboots

**Content**:
```ini
[Unit]
Description=Run Inventory Email Monitor every 5 minutes

[Timer]
OnBootSec=1min
OnUnitActiveSec=5min
AccuracySec=1min
Persistent=true

[Install]
WantedBy=timers.target
```

**Commands**:
```bash
# Create the timer file
sudo tee /etc/systemd/system/inventory-email-monitor.timer > /dev/null << 'EOF'
[Unit]
Description=Run Inventory Email Monitor every 5 minutes

[Timer]
OnBootSec=1min
OnUnitActiveSec=5min
AccuracySec=1min
Persistent=true

[Install]
WantedBy=timers.target
EOF
```

**Completion Criteria**:
- [ ] Timer file exists at `/etc/systemd/system/inventory-email-monitor.timer`
- [ ] File has correct syntax

---

## Phase 2: Enable and Test Scheduler

### Subtask 2.1: Reload Systemd and Enable Timer
**Instructions**:
1. Reload systemd daemon to pick up new files
2. Enable the timer to start on boot
3. Start the timer immediately

**Commands**:
```bash
# Reload systemd daemon
sudo systemctl daemon-reload

# Enable the timer to start on boot
sudo systemctl enable inventory-email-monitor.timer

# Start the timer now
sudo systemctl start inventory-email-monitor.timer

# Verify timer is running
sudo systemctl status inventory-email-monitor.timer
```

**Completion Criteria**:
- [ ] `systemctl daemon-reload` succeeds
- [ ] Timer is enabled (`systemctl is-enabled inventory-email-monitor.timer` returns "enabled")
- [ ] Timer is active (`systemctl is-active inventory-email-monitor.timer` returns "active")

### Subtask 2.2: Test Manual Service Execution
**Instructions**:
1. Run the service manually to verify it works
2. Check the log output

**Commands**:
```bash
# Run the service manually
sudo systemctl start inventory-email-monitor.service

# Check the service status
sudo systemctl status inventory-email-monitor.service

# Check the log output
cat /var/log/inventory/email-monitor.log

# Check the last response
cat /var/log/inventory/email-monitor-last.json
```

**Expected Output** (from `/var/log/inventory/email-monitor-last.json`):
```json
{
  "status": "success",
  "emailsChecked": 0,
  "processed": 0,
  "verified": 0,
  "changesRequested": 0,
  "skipped": 0,
  "skippedReasons": [],
  "errors": [],
  "lastCheckTimeUpdated": true,
  "timestamp": "2025-12-09T...",
  "checkWindow": { "from": "...", "to": "..." }
}
```

**Completion Criteria**:
- [ ] Service executes successfully (exit code 0)
- [ ] Log file contains execution output
- [ ] Last response JSON shows `"status": "success"`

### Subtask 2.3: Verify Timer Schedule
**Instructions**:
1. List all timers to confirm scheduling
2. Verify next execution time is approximately 5 minutes out

**Commands**:
```bash
# List all timers and their next trigger times
sudo systemctl list-timers --all | grep inventory

# Should show something like:
# NEXT                        LEFT        LAST                        PASSED    UNIT                          ACTIVATES
# Mon 2025-12-09 16:50:00 EST 4min left   Mon 2025-12-09 16:45:00 EST 32s ago   inventory-email-monitor.timer inventory-email-monitor.service
```

**Completion Criteria**:
- [ ] Timer appears in `systemctl list-timers` output
- [ ] NEXT shows a time approximately 5 minutes in the future

---

## Phase 3: Configure Log Rotation

### Subtask 3.1: Create Logrotate Configuration
**File**: `/etc/logrotate.d/inventory-email-monitor`
**Instructions**:
1. Create logrotate configuration to prevent unbounded log growth
2. Keep 7 days of logs, rotate daily

**Commands**:
```bash
# Create logrotate configuration
sudo tee /etc/logrotate.d/inventory-email-monitor > /dev/null << 'EOF'
/var/log/inventory/email-monitor.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 644 root adm
}
EOF
```

**Completion Criteria**:
- [ ] Logrotate config exists at `/etc/logrotate.d/inventory-email-monitor`
- [ ] Configuration is valid (`logrotate -d /etc/logrotate.d/inventory-email-monitor` shows no errors)

---

## Phase 4: Documentation

### Subtask 4.1: Create Operations Documentation
**File**: `/home/pbrown/SkuInventory/docs/operations/EMAIL-MONITOR-CRON.md`
**Instructions**:
1. Create the operations directory if it doesn't exist
2. Create comprehensive documentation for the email monitor cron job

**Commands**:
```bash
mkdir -p /home/pbrown/SkuInventory/docs/operations
```

**Content for EMAIL-MONITOR-CRON.md**:
```markdown
# Email Monitor Cron Job

## Overview
The email monitor cron job polls the feedback email inbox every 5 minutes to check for replies to issue resolution notifications. It processes user responses to determine if they verified a fix or requested additional changes.

## Architecture

### Components
1. **Systemd Timer**: `/etc/systemd/system/inventory-email-monitor.timer`
   - Triggers every 5 minutes
   - Survives reboots (Persistent=true)
   - Starts 1 minute after boot

2. **Systemd Service**: `/etc/systemd/system/inventory-email-monitor.service`
   - Executes curl request to the email monitor API
   - Logs output to `/var/log/inventory/email-monitor.log`
   - Saves last response to `/var/log/inventory/email-monitor-last.json`

3. **API Endpoint**: `GET /api/cron/email-monitor`
   - Protected by CRON_SECRET bearer token
   - Polls email inbox via Microsoft Graph API
   - Updates Feedback database records

## Configuration

### CRON_SECRET
The secret is stored in:
- `/home/pbrown/SkuInventory/docker/.env` (used by Docker)
- `/etc/systemd/system/inventory-email-monitor.service` (used by systemd)

**IMPORTANT**: If you regenerate the CRON_SECRET, update BOTH locations.

### Changing the Poll Interval
Edit `/etc/systemd/system/inventory-email-monitor.timer`:
```ini
[Timer]
OnUnitActiveSec=5min  # Change this value
```
Then reload:
```bash
sudo systemctl daemon-reload
sudo systemctl restart inventory-email-monitor.timer
```

## Operations

### Check Timer Status
```bash
# View timer status
sudo systemctl status inventory-email-monitor.timer

# List all timers with next run time
sudo systemctl list-timers | grep inventory
```

### Check Service Status
```bash
# View last execution status
sudo systemctl status inventory-email-monitor.service

# View logs
cat /var/log/inventory/email-monitor.log
tail -f /var/log/inventory/email-monitor.log  # Live follow

# View last response
cat /var/log/inventory/email-monitor-last.json | jq .
```

### Manual Trigger
```bash
# Run immediately
sudo systemctl start inventory-email-monitor.service

# Or use curl directly
curl -X GET "http://172.16.20.50:4545/api/cron/email-monitor" \
  -H "Authorization: Bearer $(grep CRON_SECRET /home/pbrown/SkuInventory/docker/.env | cut -d= -f2)"
```

### Stop/Disable
```bash
# Stop timer (until next reboot)
sudo systemctl stop inventory-email-monitor.timer

# Disable timer (survives reboot)
sudo systemctl disable inventory-email-monitor.timer
```

### Restart After Changes
```bash
sudo systemctl daemon-reload
sudo systemctl restart inventory-email-monitor.timer
```

## Troubleshooting

### Timer Not Running
```bash
# Check if timer is enabled
sudo systemctl is-enabled inventory-email-monitor.timer

# Check for errors
sudo journalctl -u inventory-email-monitor.timer -n 50

# Verify service file syntax
sudo systemd-analyze verify inventory-email-monitor.service
```

### Service Failing
```bash
# Check service status and exit code
sudo systemctl status inventory-email-monitor.service

# Check full logs
sudo journalctl -u inventory-email-monitor.service -n 100

# Check network connectivity
curl -v "http://172.16.20.50:4545/api/health"
```

### Common Issues

| Issue | Cause | Solution |
|-------|-------|----------|
| 401 Unauthorized | CRON_SECRET mismatch | Verify secret in service matches docker/.env |
| Connection refused | App not running | Check `docker ps | grep inventory-app` |
| Timeout | Network/App slow | Check app health, increase TimeoutSec |

## Log Files

| File | Description |
|------|-------------|
| `/var/log/inventory/email-monitor.log` | All execution logs |
| `/var/log/inventory/email-monitor-last.json` | Most recent API response |
| `journalctl -u inventory-email-monitor.service` | Systemd service logs |
| `journalctl -u inventory-email-monitor.timer` | Timer trigger logs |

## Related Documentation
- Feedback System: See GitHub issues #235-#238
- Email Configuration: Azure AD app registration for Microsoft Graph API
- Webhook Integration: `/api/webhooks/github` creates Feedback records
```

**Completion Criteria**:
- [ ] Documentation file created at `/home/pbrown/SkuInventory/docs/operations/EMAIL-MONITOR-CRON.md`
- [ ] Documentation covers all operational aspects

---

## Phase 5: End-to-End Verification

### Subtask 5.1: Verify Complete Flow
**Instructions**:
1. Wait for the timer to trigger (or trigger manually)
2. Verify logs are being written
3. Confirm the endpoint is called successfully

**Verification Commands**:
```bash
# 1. Check timer is active
sudo systemctl list-timers | grep inventory

# 2. Wait for next execution or trigger manually
sudo systemctl start inventory-email-monitor.service

# 3. Check logs
cat /var/log/inventory/email-monitor.log

# 4. Check last response
cat /var/log/inventory/email-monitor-last.json | jq .

# 5. Verify the response shows success
grep '"status":"success"' /var/log/inventory/email-monitor-last.json && echo "SUCCESS"
```

**Completion Criteria**:
- [ ] Timer is running and scheduled for next execution
- [ ] Service executes successfully
- [ ] Logs are written to `/var/log/inventory/`
- [ ] API response shows `"status": "success"`

### Subtask 5.2: Verify Survival Across Reboot (Optional)
**Instructions**:
This is an optional verification step. Only perform if the machine can be safely rebooted.

**Commands**:
```bash
# Simulate reboot check
sudo systemctl is-enabled inventory-email-monitor.timer
# Should output: enabled

# If reboot is safe:
# sudo reboot
# After reboot, verify:
# sudo systemctl list-timers | grep inventory
```

**Completion Criteria**:
- [ ] Timer is enabled (`systemctl is-enabled` returns "enabled")
- [ ] (Optional) Timer runs after reboot

---

## Summary of Deliverables

**Files Created**:
- `/etc/systemd/system/inventory-email-monitor.service` (systemd service)
- `/etc/systemd/system/inventory-email-monitor.timer` (systemd timer)
- `/etc/logrotate.d/inventory-email-monitor` (log rotation config)
- `/var/log/inventory/` (log directory)
- `/home/pbrown/SkuInventory/docs/operations/EMAIL-MONITOR-CRON.md` (documentation)

**Files Modified**: None (no application code changes)

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 -> Phase 2 -> Phase 3 -> Phase 4 -> Phase 5)
2. Use `sudo` for all systemd and /etc operations
3. Verify each completion criterion before moving to next subtask
4. The CRON_SECRET is already known and verified: `tHhCDDrFWf+5WREIQsSYp75++qjjd0V26qetRtcQvp8=`
5. All commands should be run on the host machine, not inside Docker containers

---

## Test Strategy Note

- **No code tests required** - this is infrastructure configuration
- Verification is through systemd status commands and log inspection
- End-to-end test: Manual trigger + log verification

---

## Security Considerations

1. **CRON_SECRET** is stored in plaintext in the systemd service file
   - This is acceptable for a private server
   - Alternative: Use systemd credentials or environment file with restricted permissions

2. **Log files** may contain sensitive information
   - Log rotation is configured to limit exposure
   - Consider `/var/log/inventory/` permissions if multi-user

---

## Performance Metrics

| Phase | Estimated Duration |
|-------|-------------------|
| Investigation | 8m |
| Validation | 2m |
| Planning | 12m |
| **Total** | **22m** |

---

## Rollback Plan

If issues arise, disable the timer:
```bash
sudo systemctl stop inventory-email-monitor.timer
sudo systemctl disable inventory-email-monitor.timer
sudo rm /etc/systemd/system/inventory-email-monitor.service
sudo rm /etc/systemd/system/inventory-email-monitor.timer
sudo systemctl daemon-reload
```

This does not affect the application - the email monitor endpoint remains available for manual triggering.
