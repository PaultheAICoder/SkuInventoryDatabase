# Implementation Plan
**Generated**: 2025-12-04T01:00:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #96
**Estimated Build Time**: 6-8 hours
**Complexity**: High

## Investigation Summary

### Request Analysis
**Type**: Enhancement (Final sub-issue of multi-company feature)
**Source**: GitHub Issue #96 (Part of Parent #24)
**Priority**: High

### Task Classification
**Category**: NEW_FEATURE (with significant refactoring)
**Test Strategy**: TARGETED (affected modules - API routes and pages)
**Suggested Filter**: None (manual testing recommended due to session-based changes)

### Issue Validation
**Status**: Valid
**Prerequisites Complete**: Issues #77 (companyId fields), #82 (session with selectedCompanyId), #87 (CompanySelector UI) are all merged
**Recent Changes**:
- Session already has `selectedCompanyId`, `selectedCompanyName`, and `companies` array
- `CompanySelector` component exists in sidebar and calls `/api/companies/switch`
- Component and SKU models have `companyId` field (optional, nullable)
- `UserCompany` join table exists for multi-company assignments

### Current State Assessment

**API Routes Using `session.user.companyId` (need update to `selectedCompanyId`):**

| Route | Current Pattern | Status |
|-------|-----------------|--------|
| `/api/components/route.ts` | Uses `brandId` lookup via company | **NEEDS UPDATE** |
| `/api/components/[id]/route.ts` | Uses `session.user.companyId` | OK (but needs selectedCompanyId) |
| `/api/skus/route.ts` | Uses `brandId` lookup via company | **NEEDS UPDATE** |
| `/api/skus/[id]/route.ts` | Uses `session.user.companyId` | OK (but needs selectedCompanyId) |
| `/api/transactions/route.ts` | Uses `session.user.companyId` | OK (but needs selectedCompanyId) |
| `/api/transactions/[id]/route.ts` | Uses `session.user.companyId` | OK (but needs selectedCompanyId) |
| `/api/transactions/build/route.ts` | Uses `session.user.companyId` | OK (but needs selectedCompanyId) |
| `/api/transactions/receipt/route.ts` | Uses `session.user.companyId` | OK (but needs selectedCompanyId) |
| `/api/transactions/adjustment/route.ts` | Uses `session.user.companyId` | OK (but needs selectedCompanyId) |
| `/api/transactions/initial/route.ts` | Uses `session.user.companyId` | OK (but needs selectedCompanyId) |
| `/api/dashboard/route.ts` | Uses `brandId` lookup | **NEEDS UPDATE** |
| `/api/settings/route.ts` | Uses `session.user.companyId` | OK (but needs selectedCompanyId) |
| `/api/analytics/defects/route.ts` | Uses `session.user.companyId` | OK |
| `/api/users/route.ts` | Uses `session.user.companyId` | OK |
| `/api/users/[id]/route.ts` | Uses `session.user.companyId` | OK |
| `/api/locations/route.ts` | Uses `session.user.companyId` | OK |
| `/api/locations/[id]/route.ts` | Uses `session.user.companyId` | OK |
| `/api/export/components/route.ts` | Uses `brandId` lookup | **NEEDS UPDATE** |
| `/api/export/skus/route.ts` | Uses `brandId` lookup | **NEEDS UPDATE** |
| `/api/export/transactions/route.ts` | Uses `user.companyId` | OK |
| `/api/import/components/route.ts` | Uses `brandId` lookup | **NEEDS UPDATE** |
| `/api/import/skus/route.ts` | Uses `brandId` lookup | **NEEDS UPDATE** |
| `/api/import/initial-inventory/route.ts` | Uses `brandId` lookup | **NEEDS UPDATE** |
| `/api/skus/[id]/bom-versions/route.ts` | Uses `session.user.companyId` | OK |
| `/api/bom-versions/[id]/route.ts` | Uses `session.user.companyId` | OK |
| `/api/bom-versions/[id]/activate/route.ts` | Uses `session.user.companyId` | OK |
| `/api/alerts/defects/route.ts` | Uses `session.user.companyId` | OK |

**Note**: The auth.ts callback already keeps `companyId` in sync with `selectedCompanyId` (line 128-129), so routes using `session.user.companyId` will automatically use the selected company. However, we should standardize to use `selectedCompanyId` for clarity.

**Frontend Pages:**
- `/src/app/(dashboard)/page.tsx` - Dashboard, client-side fetch to `/api/dashboard`
- `/src/app/(dashboard)/components/page.tsx` - Server-side, uses `session.user.companyId`
- `/src/app/(dashboard)/skus/page.tsx` - Server-side, fetches via user lookup
- `/src/app/(dashboard)/transactions/page.tsx` - Client-side, fetches `/api/transactions`
- `/src/app/(dashboard)/settings/page.tsx` - Client-side, fetches `/api/settings`
- `/src/app/(dashboard)/analytics/defects/page.tsx` - Server-side, passes session to component

### Dependencies & Blockers

1. **Session Already Updated**: The session already includes `selectedCompanyId` and `companies` array from issue #82
2. **CompanySelector Working**: From issue #87, component calls `/api/companies/switch` and updates session
3. **Missing Company Change Hook**: Need to create `useCompanyChange` hook to trigger refetches
4. **Server Components**: Some pages are server-side rendered - they'll automatically use new session on next load
5. **Client Components**: Need to listen for session changes and refetch

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: High (20+ files affected, new patterns)
**Effort**: 6-8 hours
**Risk**: Medium (touching many API routes, but patterns are consistent)

### Patterns Identified

**Primary**: `/src/app/api/transactions/route.ts:25-26`
```typescript
// Current pattern - already using session.user.companyId correctly
const where: Prisma.TransactionWhereInput = {
  companyId: session.user.companyId,
  // ...
}
```

**Secondary**: `/src/app/api/components/route.ts:34-44` (to be changed)
```typescript
// OLD pattern using brand lookup - TO BE REPLACED
const user = await prisma.user.findUnique({
  where: { id: session.user.id },
  include: { company: { include: { brands: { where: { isActive: true }, take: 1 } } } },
})
const brandId = user.company.brands[0].id
```

### Ripple Effect Analysis

**Phase 1 - Helper Functions (1 file)**
- `src/lib/auth.ts` - Add `validateCompanyAccess` helper

**Phase 2 - API Routes to Update (17 files)**
- `/src/app/api/components/route.ts` - Change from brandId to direct companyId
- `/src/app/api/components/[id]/route.ts` - Standardize to selectedCompanyId
- `/src/app/api/skus/route.ts` - Change from brandId to direct companyId
- `/src/app/api/skus/[id]/route.ts` - Standardize to selectedCompanyId
- `/src/app/api/dashboard/route.ts` - Change from brandId to direct companyId
- `/src/app/api/settings/route.ts` - Standardize to selectedCompanyId
- `/src/app/api/transactions/route.ts` - Already correct, add selectedCompanyId for clarity
- `/src/app/api/transactions/[id]/route.ts` - Already correct
- `/src/app/api/transactions/build/route.ts` - Already correct
- `/src/app/api/transactions/receipt/route.ts` - Already correct
- `/src/app/api/transactions/adjustment/route.ts` - Already correct
- `/src/app/api/transactions/initial/route.ts` - Already correct
- `/src/app/api/export/components/route.ts` - Change from brandId to direct companyId
- `/src/app/api/export/skus/route.ts` - Change from brandId to direct companyId
- `/src/app/api/import/components/route.ts` - Change from brandId, add companyId on create
- `/src/app/api/import/skus/route.ts` - Change from brandId, add companyId on create
- `/src/app/api/import/initial-inventory/route.ts` - Change from brandId

**Phase 3 - New Hook (1 file)**
- `/src/hooks/useCompanyChange.ts` - Create new hook for company change detection

**Phase 4 - Frontend Pages (5 files)**
- `/src/app/(dashboard)/page.tsx` - Add company change refetch
- `/src/app/(dashboard)/components/page.tsx` - Server component, add key for refresh
- `/src/app/(dashboard)/skus/page.tsx` - Server component, add key for refresh
- `/src/app/(dashboard)/transactions/page.tsx` - Add company change refetch
- `/src/app/(dashboard)/settings/page.tsx` - Add company change refetch

**Phase 5 - Component Updates (1 file)**
- `/src/components/features/CompanySelector.tsx` - Already handles company switch, verify refetch

**TOTAL FILES AFFECTED**: 25+

---

## Executive Summary

This implementation will:
1. Add a `validateCompanyAccess` helper to `src/lib/auth.ts` for consistent authorization
2. Update all Component/SKU queries to use direct `companyId` filter instead of Brand join
3. Create a `useCompanyChange` hook for frontend refetch on company switch
4. Update API routes to use `session.user.selectedCompanyId` consistently
5. Add companyId when creating new Components/SKUs via import
6. Add frontend refetch mechanisms when company changes

---

## Phase 1: Auth Helper Functions

### Subtask 1.1: Add validateCompanyAccess Helper
**File**: `/home/pbrown/SkuInventory/src/lib/auth.ts`
**Pattern**: Follow existing helper function patterns in file
**Instructions**:
1. Add helper function after `logSecurityEvent` function (around line 215):
```typescript
/**
 * Validate that a user has access to a specific company
 * Checks both UserCompany assignments and primary company
 */
export function validateCompanyAccess(
  session: { user: { companies: Array<{ id: string }> } },
  companyId: string
): boolean {
  return session.user.companies.some((c) => c.id === companyId)
}
```
2. This helper will be used by API routes to verify access before data operations

**Completion Criteria**:
- [ ] Function added to auth.ts
- [ ] `npx tsc --noEmit` passes
- [ ] Function is exported

---

## Phase 2: API Routes - Component Queries

### Subtask 2.1: Update GET /api/components
**File**: `/home/pbrown/SkuInventory/src/app/api/components/route.ts`
**Pattern**: Follow `/api/transactions/route.ts` pattern for company scoping
**Instructions**:
1. Remove the user/brand lookup (lines 34-44)
2. Replace `brandId` filter with direct `companyId` filter using `session.user.selectedCompanyId`
3. Update where clause from `{ brandId, ... }` to `{ companyId: session.user.selectedCompanyId, ... }`
4. Update `getCompanySettings` call to use `session.user.selectedCompanyId`

**Before**:
```typescript
const user = await prisma.user.findUnique({
  where: { id: session.user.id },
  include: { company: { include: { brands: { where: { isActive: true }, take: 1 } } } },
})
if (!user?.company.brands[0]) {
  return success([])
}
const brandId = user.company.brands[0].id
const where: Prisma.ComponentWhereInput = {
  brandId,
  ...
}
```

**After**:
```typescript
const selectedCompanyId = session.user.selectedCompanyId
const settings = await getCompanySettings(selectedCompanyId)
const where: Prisma.ComponentWhereInput = {
  companyId: selectedCompanyId,
  ...
}
```

5. Similarly update POST to set `companyId` on create and remove `brandId` dependency

**Completion Criteria**:
- [ ] GET uses `companyId: session.user.selectedCompanyId`
- [ ] POST sets `companyId` on new components
- [ ] No more `user.company.brands` lookup
- [ ] `npm run build` passes

### Subtask 2.2: Update GET/PATCH/DELETE /api/components/[id]
**File**: `/home/pbrown/SkuInventory/src/app/api/components/[id]/route.ts`
**Pattern**: Already uses `brand.companyId: session.user.companyId` - update to direct filter
**Instructions**:
1. In GET (line 133), change from:
```typescript
where: {
  id,
  brand: {
    companyId: session.user.companyId,
  },
}
```
To:
```typescript
where: {
  id,
  companyId: session.user.selectedCompanyId,
}
```
2. Apply same change to PATCH (line 264) and DELETE (line 355)
3. Update `getCompanySettings` calls to use `selectedCompanyId`

**Completion Criteria**:
- [ ] All methods use direct `companyId` filter
- [ ] Uses `selectedCompanyId` instead of `companyId`
- [ ] `npm run build` passes

---

## Phase 3: API Routes - SKU Queries

### Subtask 3.1: Update GET /api/skus
**File**: `/home/pbrown/SkuInventory/src/app/api/skus/route.ts`
**Pattern**: Same as components - replace brandId with direct companyId
**Instructions**:
1. Remove user/brand lookup (lines 32-43)
2. Replace `brandId` filter with `companyId: session.user.selectedCompanyId`
3. Update POST to set `companyId` on new SKUs

**Completion Criteria**:
- [ ] GET uses `companyId: selectedCompanyId`
- [ ] POST sets `companyId` on new SKUs
- [ ] No more `user.company.brands` lookup
- [ ] `npm run build` passes

### Subtask 3.2: Update GET/PATCH/DELETE /api/skus/[id]
**File**: `/home/pbrown/SkuInventory/src/app/api/skus/[id]/route.ts`
**Pattern**: Same change from brand lookup to direct companyId
**Instructions**:
1. Change all `brand: { companyId: session.user.companyId }` to `companyId: session.user.selectedCompanyId`
2. Apply to GET (line 29), PATCH (line 135), DELETE (line 230)

**Completion Criteria**:
- [ ] All methods use direct `companyId` filter
- [ ] Uses `selectedCompanyId`
- [ ] `npm run build` passes

---

## Phase 4: API Routes - Dashboard and Settings

### Subtask 4.1: Update GET /api/dashboard
**File**: `/home/pbrown/SkuInventory/src/app/api/dashboard/route.ts`
**Pattern**: Same as components
**Instructions**:
1. Remove user/brand lookup (lines 79-94)
2. Replace `brandId` filter with `companyId: session.user.selectedCompanyId` for:
   - Components query (line 100)
   - SKUs query (line 154)
3. Update `getCompanySettings` call to use `selectedCompanyId`
4. Transactions query (line 197) already uses `companyId` - update to `selectedCompanyId`

**Completion Criteria**:
- [ ] All queries use direct `companyId` filter
- [ ] Uses `selectedCompanyId`
- [ ] `npm run build` passes

### Subtask 4.2: Update /api/settings
**File**: `/home/pbrown/SkuInventory/src/app/api/settings/route.ts`
**Pattern**: Already uses `session.user.companyId`
**Instructions**:
1. Change all `session.user.companyId` to `session.user.selectedCompanyId`
2. Lines: 25, 87, 104

**Completion Criteria**:
- [ ] Uses `selectedCompanyId`
- [ ] `npm run build` passes

---

## Phase 5: API Routes - Export/Import

### Subtask 5.1: Update GET /api/export/components
**File**: `/home/pbrown/SkuInventory/src/app/api/export/components/route.ts`
**Pattern**: Same as components API
**Instructions**:
1. Remove user/brand lookup (lines 23-39)
2. Replace `brandId` filter with `companyId: session.user.selectedCompanyId`
3. Update `getCompanySettings` call

**Completion Criteria**:
- [ ] Uses direct `companyId` filter
- [ ] Uses `selectedCompanyId`
- [ ] `npm run build` passes

### Subtask 5.2: Update GET /api/export/skus
**File**: `/home/pbrown/SkuInventory/src/app/api/export/skus/route.ts`
**Pattern**: Same as SKUs API
**Instructions**:
1. Remove user/brand lookup (lines 18-34)
2. Replace `brandId` filter with `companyId: session.user.selectedCompanyId`

**Completion Criteria**:
- [ ] Uses direct `companyId` filter
- [ ] `npm run build` passes

### Subtask 5.3: Update POST /api/import/components
**File**: `/home/pbrown/SkuInventory/src/app/api/import/components/route.ts`
**Pattern**: Same update, plus add companyId on create
**Instructions**:
1. Remove user/brand lookup (lines 35-44)
2. Use `session.user.selectedCompanyId` for queries and settings
3. **IMPORTANT**: Add `companyId` to component create (line 116):
```typescript
await prisma.component.create({
  data: {
    brandId,  // Keep for now - still need brand relation
    companyId: session.user.selectedCompanyId, // ADD THIS
    name: componentData.name,
    // ...
  },
})
```
4. Need to get brandId differently - lookup active brand for selected company:
```typescript
const brand = await prisma.brand.findFirst({
  where: { companyId: session.user.selectedCompanyId, isActive: true },
})
if (!brand) {
  return error('No active brand found for selected company', 400)
}
const brandId = brand.id
```

**Completion Criteria**:
- [ ] Uses `selectedCompanyId` for company scoping
- [ ] Sets `companyId` on new components
- [ ] Still sets `brandId` for backward compatibility
- [ ] `npm run build` passes

### Subtask 5.4: Update POST /api/import/skus
**File**: `/home/pbrown/SkuInventory/src/app/api/import/skus/route.ts`
**Pattern**: Same as import/components
**Instructions**:
1. Remove user/brand lookup, use selectedCompanyId-based brand lookup
2. Add `companyId` to SKU create

**Completion Criteria**:
- [ ] Uses `selectedCompanyId`
- [ ] Sets `companyId` on new SKUs
- [ ] `npm run build` passes

### Subtask 5.5: Update POST /api/import/initial-inventory
**File**: `/home/pbrown/SkuInventory/src/app/api/import/initial-inventory/route.ts`
**Pattern**: Same as import/components
**Instructions**:
1. Replace user/brand lookup (lines 39-48) with brand lookup by selectedCompanyId
2. Use `selectedCompanyId` for component lookups and transaction creation

**Completion Criteria**:
- [ ] Uses `selectedCompanyId`
- [ ] `npm run build` passes

---

## Phase 6: Create Company Change Hook

### Subtask 6.1: Create useCompanyChange Hook
**File**: `/home/pbrown/SkuInventory/src/hooks/useCompanyChange.ts` (NEW FILE)
**Pattern**: Based on issue description
**Instructions**:
1. Create directory if needed: `mkdir -p /home/pbrown/SkuInventory/src/hooks`
2. Create new file with content:
```typescript
'use client'

import { useSession } from 'next-auth/react'
import { useEffect, useRef, useCallback } from 'react'

/**
 * Hook to detect company changes and trigger a callback
 * Use this in client components that need to refetch data when company changes
 */
export function useCompanyChange(onCompanyChange: () => void) {
  const { data: session } = useSession()
  const prevCompanyId = useRef<string | undefined>(undefined)
  const stableCallback = useCallback(onCompanyChange, [onCompanyChange])

  useEffect(() => {
    const currentCompanyId = session?.user?.selectedCompanyId

    // Skip on initial mount
    if (prevCompanyId.current === undefined) {
      prevCompanyId.current = currentCompanyId
      return
    }

    // Detect change
    if (currentCompanyId !== prevCompanyId.current) {
      prevCompanyId.current = currentCompanyId
      stableCallback()
    }
  }, [session?.user?.selectedCompanyId, stableCallback])
}

/**
 * Hook to get the current selected company ID
 * Returns undefined if session is not loaded yet
 */
export function useSelectedCompanyId(): string | undefined {
  const { data: session } = useSession()
  return session?.user?.selectedCompanyId
}
```

**Completion Criteria**:
- [ ] File created at `/home/pbrown/SkuInventory/src/hooks/useCompanyChange.ts`
- [ ] `npx tsc --noEmit` passes
- [ ] Hook exports `useCompanyChange` and `useSelectedCompanyId`

---

## Phase 7: Frontend - Client Component Updates

### Subtask 7.1: Update Dashboard Page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/page.tsx`
**Pattern**: Add `useCompanyChange` hook to trigger refetch
**Instructions**:
1. Import the hook:
```typescript
import { useCompanyChange } from '@/hooks/useCompanyChange'
```
2. Add hook usage inside component, after existing state:
```typescript
// Add refetch on company change
useCompanyChange(() => {
  setIsLoading(true)
  // fetchDashboard will be called by the useEffect due to dependency
})
```
3. Actually, better approach - add `session?.user?.selectedCompanyId` to the useEffect dependency array:
```typescript
const { data: session } = useSession()

useEffect(() => {
  async function fetchDashboard() {
    // ...existing code...
  }
  if (session?.user?.selectedCompanyId) {
    fetchDashboard()
  }
}, [timeFilter, session?.user?.selectedCompanyId])  // ADD selectedCompanyId
```

**Completion Criteria**:
- [ ] Dashboard refetches when company changes
- [ ] `npm run build` passes

### Subtask 7.2: Update Transactions Page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/transactions/page.tsx`
**Pattern**: Same as dashboard
**Instructions**:
1. Import useSession if not already
2. Add `session?.user?.selectedCompanyId` to fetchTransactions useCallback dependencies
3. This will trigger refetch when company changes

```typescript
const { data: session } = useSession()

const fetchTransactions = useCallback(async () => {
  // ...existing code...
}, [page, pageSize, filters, session?.user?.selectedCompanyId])
```

**Completion Criteria**:
- [ ] Transactions refetch when company changes
- [ ] `npm run build` passes

### Subtask 7.3: Update Settings Page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/page.tsx`
**Pattern**: Same as dashboard
**Instructions**:
1. Import `useSession` from 'next-auth/react'
2. Add dependency on selectedCompanyId:
```typescript
const { data: session } = useSession()

useEffect(() => {
  fetchSettings()
}, [session?.user?.selectedCompanyId])  // Re-fetch when company changes
```

**Completion Criteria**:
- [ ] Settings refetch when company changes
- [ ] `npm run build` passes

---

## Phase 8: Frontend - Server Component Updates

### Subtask 8.1: Update Components Page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/components/page.tsx`
**Pattern**: Server components automatically use new session on page load
**Instructions**:
1. Remove the user/brand lookup (lines 167-181)
2. Update `getComponents` function to use `session.user.selectedCompanyId` directly
3. Query components by `companyId` instead of `brandId`:

```typescript
// Replace the brand lookup with:
const selectedCompanyId = session.user.selectedCompanyId

// In getComponents function, change:
const where = {
  companyId: selectedCompanyId,
  isActive: true,
  // ...
}
```

4. The CompanySelector in the layout already handles session update
5. Server components will refresh on next navigation

**Completion Criteria**:
- [ ] Uses `companyId: selectedCompanyId` instead of `brandId`
- [ ] No more user/brand lookup
- [ ] `npm run build` passes

### Subtask 8.2: Update SKUs Page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/skus/page.tsx`
**Pattern**: Same as components page
**Instructions**:
1. In `getSKUs` function (line 23), remove user/brand lookup
2. Use `session.user.selectedCompanyId` for company-scoped queries:
```typescript
const where: Prisma.SKUWhereInput = {
  companyId: session.user.selectedCompanyId,
  // ...
}
```
3. Need to pass session to getSKUs or restructure to get selectedCompanyId

**Completion Criteria**:
- [ ] Uses `companyId: selectedCompanyId`
- [ ] `npm run build` passes

---

## Phase 9: Remaining API Route Updates

### Subtask 9.1: Update BOM-related Routes
**Files**:
- `/home/pbrown/SkuInventory/src/app/api/skus/[id]/bom-versions/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/activate/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/clone/route.ts`

**Pattern**: These already use `brand.companyId: session.user.companyId` - update to selectedCompanyId and direct filter
**Instructions**:
For each file:
1. Change `session.user.companyId` to `session.user.selectedCompanyId`
2. If filtering through `sku.brand.companyId`, change to direct `sku.companyId`

**Completion Criteria**:
- [ ] All BOM routes use `selectedCompanyId`
- [ ] `npm run build` passes

### Subtask 9.2: Update Remaining Transaction Routes
**Files**:
- `/home/pbrown/SkuInventory/src/app/api/transactions/build/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/transactions/receipt/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/transactions/adjustment/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/transactions/initial/route.ts`

**Pattern**: These use `session.user.companyId` which is kept in sync - optionally update for clarity
**Instructions**:
1. Change `session.user.companyId` to `session.user.selectedCompanyId` for consistency
2. Update component/SKU lookups to use `companyId` instead of `brand.company.id`

**Completion Criteria**:
- [ ] All transaction routes use `selectedCompanyId`
- [ ] Component lookups use direct `companyId`
- [ ] `npm run build` passes

### Subtask 9.3: Update User and Location Routes
**Files**:
- `/home/pbrown/SkuInventory/src/app/api/users/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/users/[id]/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/locations/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/locations/[id]/route.ts`

**Pattern**: These use `session.user.companyId` - update to `selectedCompanyId`
**Instructions**:
1. Replace all `session.user.companyId` with `session.user.selectedCompanyId`

**Note**: User and location management should still be tied to the selected company context

**Completion Criteria**:
- [ ] All routes use `selectedCompanyId`
- [ ] `npm run build` passes

### Subtask 9.4: Update Alert Routes
**File**: `/home/pbrown/SkuInventory/src/app/api/alerts/defects/route.ts`
**Pattern**: Already uses `session.user.companyId`
**Instructions**:
1. Replace `session.user.companyId` with `session.user.selectedCompanyId`

**Completion Criteria**:
- [ ] Uses `selectedCompanyId`
- [ ] `npm run build` passes

---

## Phase 10: Final Validation

### Subtask 10.1: Build and Type Check
**Instructions**:
```bash
npm run build
npx tsc --noEmit
npm run lint
```

**Completion Criteria**:
- [ ] `npm run build` passes without errors
- [ ] `npx tsc --noEmit` passes without errors
- [ ] `npm run lint` passes without errors

### Subtask 10.2: Manual Testing Checklist
**Instructions**:
1. Log in with a user that has access to multiple companies
2. Verify CompanySelector appears in sidebar
3. Load Dashboard - verify data is for current company
4. Switch companies via selector
5. Verify Dashboard refetches and shows new company data
6. Navigate to Components - verify correct company data
7. Navigate to SKUs - verify correct company data
8. Navigate to Transactions - verify correct company data
9. Navigate to Settings - verify settings for selected company
10. Create a new Component - verify it's assigned to selected company
11. Create a new SKU - verify it's assigned to selected company
12. Export components - verify export is for selected company

**Completion Criteria**:
- [ ] All pages show data for selected company
- [ ] Company switch triggers data refresh
- [ ] New entities are created with correct companyId
- [ ] No cross-company data leaks

---

## Summary of Deliverables

**Files Created**: 1
- `/home/pbrown/SkuInventory/src/hooks/useCompanyChange.ts`

**Files Modified**: 24+
- `/home/pbrown/SkuInventory/src/lib/auth.ts`
- `/home/pbrown/SkuInventory/src/app/api/components/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/components/[id]/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/skus/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/skus/[id]/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/dashboard/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/settings/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/export/components/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/export/skus/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/import/components/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/import/skus/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/import/initial-inventory/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/skus/[id]/bom-versions/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/activate/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/transactions/build/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/transactions/receipt/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/transactions/adjustment/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/transactions/initial/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/users/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/users/[id]/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/locations/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/locations/[id]/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/alerts/defects/route.ts`
- `/home/pbrown/SkuInventory/src/app/(dashboard)/page.tsx`
- `/home/pbrown/SkuInventory/src/app/(dashboard)/components/page.tsx`
- `/home/pbrown/SkuInventory/src/app/(dashboard)/skus/page.tsx`
- `/home/pbrown/SkuInventory/src/app/(dashboard)/transactions/page.tsx`
- `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/page.tsx`

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 -> Phase 10)
2. Phase 1 must complete before Phase 2 (auth helper needed)
3. Phase 6 (hook creation) can be done in parallel with API route updates
4. Phase 7-8 require Phase 6 to be complete
5. Test completion criteria before moving to next subtask
6. Follow reference patterns exactly - consistent use of `selectedCompanyId`

## Key Implementation Notes

1. **Auth Callback Already Syncs**: `src/lib/auth.ts` lines 128-129 keep `companyId` in sync with `selectedCompanyId`, so existing routes using `companyId` will work. However, update to `selectedCompanyId` for clarity.

2. **brandId Still Needed**: Component and SKU models still have a required `brandId` relation. When creating new records, look up the active brand for the selected company.

3. **companyId is Optional**: The Prisma schema has `companyId` as optional (`String?`) on Component and SKU. This is for backward compatibility - existing records may not have it set.

4. **Server vs Client Components**: Server components (components/page.tsx, skus/page.tsx) will automatically use new session on navigation. Client components need explicit refetch logic.

5. **No 403 Implementation**: The issue mentions 403 for unauthorized company access, but since session already validates company access in the switch API, direct database queries with selectedCompanyId are sufficient. Add explicit 403 checks if accessing via URL params.

## Test Strategy Note
- Use manual testing for this feature (session-based changes are hard to unit test)
- Focus on verifying data isolation between companies
- Test the company switch flow end-to-end

## Performance Metrics
| Phase | Estimated Duration |
|-------|-------------------|
| Phase 1 (Auth Helper) | 15m |
| Phase 2-5 (API Routes) | 2.5h |
| Phase 6 (Hook) | 20m |
| Phase 7-8 (Frontend) | 1h |
| Phase 9 (Remaining APIs) | 1.5h |
| Phase 10 (Validation) | 30m |
| **Total** | **~6h** |
