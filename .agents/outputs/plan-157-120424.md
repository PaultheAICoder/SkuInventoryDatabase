# Implementation Plan
**Generated**: 2025-12-04 18:30 UTC
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #157
**Estimated Build Time**: 1-2 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Bug
**Source**: GitHub Issue #157
**Priority**: Medium

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED
**Suggested Filter**: `--testPathPattern="forecasts"` or None (no existing test)

### Issue Validation
**Status**: Valid
**Recent Changes**: No recent changes to forecasts page. This is the same bug pattern identified in issue #150 (orders page) - noted in that issue's plan as a "Related Issue for Future Consideration".

### Root Cause Analysis

The `/forecasts` page hangs on "Loading..." indefinitely when there are no components or no forecast data because of a **missing session loading state check**.

**Current Code Flow** (`src/app/(dashboard)/forecasts/page.tsx`):
1. Line 29: `isLoading` is initialized to `true`
2. Lines 84-105: `useEffect` only calls `fetchForecasts()` when `session?.user?.selectedCompanyId` is truthy
3. Lines 165-173: If `isLoading` is `true`, show "Loading..." message

**The Bug**: When the session is still loading (during initial page load), `session?.user?.selectedCompanyId` is `undefined`. The `useEffect` condition on line 102 (`if (session?.user?.selectedCompanyId)`) never becomes true while session is loading, so `fetchForecasts()` is never called, and `isLoading` remains `true` forever.

**Evidence**:
- Line 25: Only `data: session` is destructured from `useSession()` - `status` is NOT extracted
- Lines 102-104: The fetch only triggers when company is selected, but there's no `else` branch to stop loading
- The `ForecastTable` component (lines 142-147) correctly handles empty forecasts with "No forecasts found." message
- The API route correctly returns `{ data: [], meta: {...} }` when no components exist

**Comparison with working pages (fix already applied)**:
- `src/app/(dashboard)/orders/page.tsx` (line 10): Uses `const { data: session, status } = useSession()`
- `src/app/(dashboard)/orders/page.tsx` (lines 59-70): Checks `if (status === 'loading') return` and has `else { setIsLoading(false) }`
- `src/app/(dashboard)/orders/page.tsx` (line 72): Checks `if (status === 'loading' || isLoading)`

### Current State Assessment
- **Existing components**: `ForecastTable` handles empty state correctly (line 142-147: "No forecasts found.")
- **API Routes**: `/api/forecasts` returns proper empty response when no components exist
- **Types**: No changes needed
- **Database**: No changes needed

### Dependencies & Blockers
None - this is a simple frontend fix following the same pattern as issue #150.

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Simple
**Effort**: 1-2 hours
**Risk**: Low - surgical fix to loading state logic, identical pattern to #150

### Patterns Identified
**Primary**: `src/app/(dashboard)/orders/page.tsx` - the exact fix we need, already implemented for issue #150
**Secondary**: `src/app/(dashboard)/settings/alerts/page.tsx` - original reference pattern

### Ripple Effect Analysis
**Files Identified**: 1
- `/home/pbrown/SkuInventory/src/app/(dashboard)/forecasts/page.tsx` - primary fix location

**No additional files affected** - this is an isolated fix.

---

## Executive Summary

Fix the forecasts page loading state by destructuring `status` from `useSession()` and properly handling the session loading state. This is an identical fix to issue #150 for the orders page. When session is loading, show the loading indicator. When session is loaded but `selectedCompanyId` is missing or no forecasts exist, properly transition to the loaded state so the ForecastTable can display its empty state message.

---

## Phase 1: Fix Loading State Logic

### Subtask 1.1: Add session status to useSession destructuring

**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/forecasts/page.tsx`
**Pattern**: Follow `src/app/(dashboard)/orders/page.tsx` line 10
**Line**: 25

**Current Code**:
```typescript
const { data: session } = useSession()
```

**New Code**:
```typescript
const { data: session, status } = useSession()
```

**Instructions**:
1. Destructure `status` from `useSession()` hook on line 25
2. This provides access to the session loading state ('loading', 'authenticated', 'unauthenticated')

**Completion Criteria**:
- [ ] `status` is destructured from `useSession()`
- [ ] No TypeScript errors

---

### Subtask 1.2: Update useEffect to handle session loading properly

**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/forecasts/page.tsx`
**Pattern**: Follow `src/app/(dashboard)/orders/page.tsx` lines 59-70
**Lines**: 84-105 (specifically the fetch triggering useEffect)

**Current Code** (lines 84-105):
```typescript
  useEffect(() => {
    async function fetchForecasts() {
      try {
        setIsLoading(true)
        setError(null)
        const res = await fetch(`/api/forecasts?${queryString}`)
        if (!res.ok) {
          throw new Error('Failed to load forecasts')
        }
        const result = await res.json()
        setResponse(result)
      } catch (err) {
        setError(err instanceof Error ? err.message : 'An error occurred')
      } finally {
        setIsLoading(false)
      }
    }

    if (session?.user?.selectedCompanyId) {
      fetchForecasts()
    }
  }, [queryString, session?.user?.selectedCompanyId, refreshKey])
```

**New Code**:
```typescript
  useEffect(() => {
    async function fetchForecasts() {
      try {
        setIsLoading(true)
        setError(null)
        const res = await fetch(`/api/forecasts?${queryString}`)
        if (!res.ok) {
          throw new Error('Failed to load forecasts')
        }
        const result = await res.json()
        setResponse(result)
      } catch (err) {
        setError(err instanceof Error ? err.message : 'An error occurred')
      } finally {
        setIsLoading(false)
      }
    }

    // Don't fetch while session is loading
    if (status === 'loading') return

    // If authenticated with a company selected, fetch forecasts
    if (session?.user?.selectedCompanyId) {
      fetchForecasts()
    } else {
      // Session loaded but no company - stop loading
      setIsLoading(false)
    }
  }, [status, queryString, session?.user?.selectedCompanyId, refreshKey])
```

**Instructions**:
1. Add early return when `status === 'loading'` to wait for session (insert before the existing `if` on line 102)
2. Add `else` branch to set `setIsLoading(false)` when session is loaded but no company is selected
3. Add `status` to the dependency array (first position for consistency with orders page)

**Completion Criteria**:
- [ ] Early return added for `status === 'loading'`
- [ ] `else` branch added with `setIsLoading(false)`
- [ ] `status` is in the dependency array
- [ ] Loading state properly handles session loading

---

### Subtask 1.3: Update the loading state render condition

**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/forecasts/page.tsx`
**Pattern**: Follow `src/app/(dashboard)/orders/page.tsx` line 72
**Lines**: 165-174

**Current Code**:
```typescript
  if (isLoading) {
    return (
      <div className="space-y-6">
        <div>
          <h1 className="text-3xl font-bold tracking-tight">Forecasts</h1>
          <p className="text-muted-foreground">Loading...</p>
        </div>
      </div>
    )
  }
```

**New Code**:
```typescript
  if (status === 'loading' || isLoading) {
    return (
      <div className="space-y-6">
        <div>
          <h1 className="text-3xl font-bold tracking-tight">Forecasts</h1>
          <p className="text-muted-foreground">Loading...</p>
        </div>
      </div>
    )
  }
```

**Instructions**:
1. Update condition to check both `status === 'loading'` and `isLoading`
2. This ensures we show loading while session is being determined AND while fetching forecasts

**Completion Criteria**:
- [ ] Loading UI shows during session loading
- [ ] Loading UI shows during forecasts fetch
- [ ] Loading UI disappears when both are done

---

## Phase 2: Add E2E Test

### Subtask 2.1: Create E2E test for forecasts page loading

**File**: `/home/pbrown/SkuInventory/tests/e2e/forecasts-loading.spec.ts` (NEW FILE)
**Pattern**: Follow `tests/e2e/orders-loading.spec.ts`

**Instructions**:
Create a new file with the following content:

```typescript
import { test, expect } from '@playwright/test'
import { loginAsAdmin } from './helpers/login'

test.describe('Forecasts Page Loading State', () => {
  test.beforeEach(async ({ page }) => {
    await loginAsAdmin(page)
  })

  test('Forecasts page does not hang on loading state', async ({ page }) => {
    // Navigate to forecasts page
    await page.goto('/forecasts')

    // Wait for page to load - should NOT stay in loading state forever
    // The fix ensures the page transitions from loading to either:
    // 1. Showing forecasts (if components exist)
    // 2. Showing "No forecasts found" empty state
    await page.waitForSelector('h1:has-text("Forecasts")', { timeout: 10000 })

    // Wait for loading to complete - page should NOT show "Loading..." for more than 5 seconds
    // Use a race condition: either we see the table or we see "Loading..." disappear
    const loadingComplete = await Promise.race([
      // Option 1: Table component appears (with or without data)
      page.waitForSelector('table, .text-muted-foreground:has-text("No forecasts found")', { timeout: 10000 }),
      // Option 2: Loading text disappears
      page.waitForFunction(() => {
        const loadingText = document.body.textContent
        return loadingText && !loadingText.includes('Loading...')
      }, { timeout: 10000 })
    ]).then(() => true).catch(() => false)

    // If loadingComplete is false and loading text is still visible, fail the test
    const pageContent = await page.textContent('body')

    // The key assertion: if we see "Loading..." after 10 seconds, the bug is NOT fixed
    // Otherwise, we should see either:
    // - "No forecasts found" (empty state)
    // - Forecast data (if components exist)
    expect(loadingComplete || !pageContent?.includes('Loading...')).toBeTruthy()
  })

  test('Forecasts page shows proper empty state when no forecasts exist', async ({ page }) => {
    // Navigate to forecasts page
    await page.goto('/forecasts')

    // Wait for page to finish loading (max 10 seconds)
    await page.waitForSelector('h1:has-text("Forecasts")', { timeout: 10000 })

    // Wait for loading to complete
    await page.waitForFunction(() => {
      const body = document.body.textContent || ''
      return !body.includes('Loading...')
    }, { timeout: 10000 })

    // Page should now show either:
    // 1. Table with forecasts
    // 2. "No forecasts found" message
    // 3. Some other completed state (not loading)
    const pageText = await page.textContent('body')
    expect(pageText).not.toContain('Loading...')
  })
})
```

**Completion Criteria**:
- [ ] Test file created at correct path
- [ ] Test follows orders-loading.spec.ts pattern
- [ ] Tests verify loading state does not hang

---

## Phase 3: Validation

### Subtask 3.1: Run TypeScript check

**Command**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] No TypeScript errors

---

### Subtask 3.2: Run build

**Command**:
```bash
npm run build
```

**Completion Criteria**:
- [ ] Build completes successfully
- [ ] No warnings related to forecasts page

---

### Subtask 3.3: Run lint

**Command**:
```bash
npm run lint
```

**Completion Criteria**:
- [ ] Lint passes
- [ ] No ESLint warnings on modified file

---

### Subtask 3.4: Run E2E tests

**Command**:
```bash
npx playwright test tests/e2e/forecasts-loading.spec.ts
```

**Completion Criteria**:
- [ ] Both tests pass
- [ ] No regressions in existing tests

---

### Subtask 3.5: Manual verification (via test environment)

**Test URL**: http://172.16.20.50:2345/forecasts

**Test Steps**:
1. Ensure test database has no components (or clear existing components)
2. Navigate to /forecasts page
3. Observe that page shows "Loading..." briefly then shows the ForecastTable with "No forecasts found."
4. Verify no perpetual loading state

**Completion Criteria**:
- [ ] Page does not hang on "Loading..."
- [ ] Empty state message "No forecasts found." is displayed
- [ ] Stats cards show 0 values (Total Components: 0, Critical: 0, etc.)
- [ ] Page is functional and responsive

---

## Summary of Deliverables

**Files Created**: 1
- `/home/pbrown/SkuInventory/tests/e2e/forecasts-loading.spec.ts`

**Files Modified**: 1
- `/home/pbrown/SkuInventory/src/app/(dashboard)/forecasts/page.tsx`

**Changes Summary**:
1. Destructure `status` from `useSession()` (line 25)
2. Update useEffect to handle session loading state (lines 84-105)
3. Update loading condition to include session status (line 165)
4. Add E2E test for regression prevention

---

## Handoff to Build Agent

1. Execute subtasks in exact order (1.1 -> 1.2 -> 1.3 -> 2.1 -> 3.1 -> 3.2 -> 3.3 -> 3.4)
2. Each subtask has specific code changes - follow exactly
3. Test completion criteria before moving to next subtask
4. Follow reference patterns from `orders/page.tsx` (already fixed for #150)

---

## Test Strategy Note

- **Unit tests**: No existing unit tests for forecasts page - component is primarily rendering
- **E2E tests**: New test created following orders-loading.spec.ts pattern
- **Regression**: The fix is surgical and follows established patterns from issue #150

---

## Code Diff Preview

Here's what the final diff should look like:

```diff
diff --git a/src/app/(dashboard)/forecasts/page.tsx b/src/app/(dashboard)/forecasts/page.tsx
--- a/src/app/(dashboard)/forecasts/page.tsx
+++ b/src/app/(dashboard)/forecasts/page.tsx
@@ -22,7 +22,7 @@ interface ForecastListResponse {
 }

 export default function ForecastsPage() {
-  const { data: session } = useSession()
+  const { data: session, status } = useSession()
   const searchParams = useSearchParams()
   const router = useRouter()
   const [response, setResponse] = useState<ForecastListResponse | null>(null)
@@ -99,9 +99,17 @@ export default function ForecastsPage() {
       }
     }

+    // Don't fetch while session is loading
+    if (status === 'loading') return
+
+    // If authenticated with a company selected, fetch forecasts
     if (session?.user?.selectedCompanyId) {
       fetchForecasts()
+    } else {
+      // Session loaded but no company - stop loading
+      setIsLoading(false)
     }
-  }, [queryString, session?.user?.selectedCompanyId, refreshKey])
+  }, [status, queryString, session?.user?.selectedCompanyId, refreshKey])

   // Handle lookback change from quick settings
   const handleLookbackChange = (days: number) => {
@@ -162,7 +170,7 @@ export default function ForecastsPage() {
     }
   }, [response])

-  if (isLoading) {
+  if (status === 'loading' || isLoading) {
     return (
       <div className="space-y-6">
         <div>
```

---

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 10m |
| Validation | 2m |
| Planning | 5m |
| **Total** | **17m** |
