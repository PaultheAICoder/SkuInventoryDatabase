# Implementation Plan
**Generated**: 2025-12-08T22:00:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #217
**Estimated Build Time**: 2-3 hours
**Complexity**: Low-Medium

## Investigation Summary

### Request Analysis
**Type**: Bug Fix
**Source**: GitHub Issue #217 - User feedback
**Priority**: Medium

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="transaction-parser"` or None (no existing tests for parser)

### Issue Validation
**Status**: Valid
**Recent Changes**:
- `39cf6df feat(issue #183): update quick entry to inbound/outbound/adjustment`
- `6e9a6ba feat(issue #113): add conversational AI transaction parser`

### Root Cause Analysis

**The Bug**: When a user in Pacific Time (PT, UTC-8) says "we received an item on 11/17/2025", the system records it as 11/16/2025 (one day earlier).

**The Root Cause**: There are TWO timezone-related issues in `/home/pbrown/SkuInventory/src/lib/transaction-parser.ts`:

1. **Line 340**: The "today" date sent to Claude is calculated using `new Date().toISOString().split('T')[0]`. This uses UTC time, so at 1:36 PM Pacific (which is 9:36 PM UTC), the server would report the correct date (Dec 8). However, this affects relative date handling.

2. **Line 374**: When converting Claude's YYYY-MM-DD string response back to a JavaScript Date object:
   ```typescript
   parsedDate = new Date(rawParsed.date)  // e.g., new Date("2025-11-17")
   ```

   **This is the critical bug!** When JavaScript parses a date string in `YYYY-MM-DD` format (ISO format without time), it interprets it as **midnight UTC**, not local time. So `new Date("2025-11-17")` creates:
   - UTC: `2025-11-17T00:00:00.000Z`
   - Pacific Time (UTC-8): `2025-11-16T16:00:00` (the PREVIOUS day!)

   When this Date object is later displayed using `toLocaleDateString()` on the client (which uses local time), it shows November 16th, not November 17th.

**Reproduction**:
```javascript
// In browser console (Pacific timezone):
const d = new Date("2025-11-17")
console.log(d.toLocaleDateString())  // Shows "11/16/2025" - BUG!
```

### Current State Assessment
- **Affected File**: `src/lib/transaction-parser.ts`
- **Key Lines**: 340, 374, 98 (fallback)
- **Pattern**: Using `new Date(YYYY-MM-DD)` which parses as UTC midnight
- **No existing tests**: No unit tests for `transaction-parser.ts`

### Dependencies & Blockers
None. This is an isolated fix in one file.

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Low-Medium
**Effort**: 2-3 hours
**Risk**: Low (isolated change, well-understood bug)

### Patterns Identified
**Primary**: Date handling in `src/services/xlsx-import.ts` (line 267-281) - uses timezone-aware parsing
**Secondary**: Similar date string parsing in various display components (but those are read-only display, not the source of truth)

### Ripple Effect Analysis
**Files Identified**: 1 (direct fix)
- `/home/pbrown/SkuInventory/src/lib/transaction-parser.ts` - Fix date parsing logic

**Display files using dates** (no changes needed - they correctly display whatever Date they receive):
- `src/components/features/ParsedTransactionPreview.tsx` (line 60-61)
- Various dashboard pages displaying transaction dates

---

## Executive Summary

Fix the timezone bug in the natural language transaction parser that causes dates to be off by one day for users west of UTC. The issue is that `new Date("YYYY-MM-DD")` interprets the date as UTC midnight, which when displayed in local time shows the previous day. The fix involves adding time component to the date string to force local time parsing OR using explicit timezone handling.

## Phase 1: Fix Date Parsing in Transaction Parser

### Subtask 1.1: Fix Date String Parsing (Line 374)
**File**: `/home/pbrown/SkuInventory/src/lib/transaction-parser.ts`
**Pattern**: Append time to force local parsing
**Instructions**:

The current problematic code (lines 371-380):
```typescript
// Parse the date
let parsedDate: Date
try {
  parsedDate = new Date(rawParsed.date)
  if (isNaN(parsedDate.getTime())) {
    parsedDate = new Date()
  }
} catch {
  parsedDate = new Date()
}
```

Replace with:
```typescript
// Parse the date - IMPORTANT: Append time to prevent UTC midnight interpretation
// Without time component, "2025-11-17" is parsed as midnight UTC, which displays
// as 11/16 in Pacific Time. By appending T00:00:00, the date is parsed as local time.
let parsedDate: Date
try {
  // Append time component if date is in YYYY-MM-DD format
  const dateString = rawParsed.date.includes('T')
    ? rawParsed.date
    : `${rawParsed.date}T00:00:00`
  parsedDate = new Date(dateString)
  if (isNaN(parsedDate.getTime())) {
    parsedDate = new Date()
  }
} catch {
  parsedDate = new Date()
}
```

**Rationale**:
- `new Date("2025-11-17")` = UTC midnight = wrong in local TZ
- `new Date("2025-11-17T00:00:00")` = local midnight = correct

**Completion Criteria**:
- [ ] Code compiles without errors
- [ ] Date parsing adds time component for YYYY-MM-DD format
- [ ] Dates with time component (ISO format) still work correctly

### Subtask 1.2: Fix Fallback Date String Parsing (Line 98)
**File**: `/home/pbrown/SkuInventory/src/lib/transaction-parser.ts`
**Pattern**: Same fix for parseClaudeResponse fallback
**Instructions**:

The current code (line 98):
```typescript
date: parsed.date || new Date().toISOString().split('T')[0],
```

This returns a YYYY-MM-DD string which will have the same UTC issue when later converted to Date. However, this is a string being returned, not a Date, so the fix in 1.1 handles this case.

**No change needed here** - the fix in 1.1 handles any YYYY-MM-DD string input.

**Completion Criteria**:
- [ ] Verified that line 98 output is processed by line 374 fix

### Subtask 1.3: Fix Fallback Parser Date (Line 316)
**File**: `/home/pbrown/SkuInventory/src/lib/transaction-parser.ts`
**Pattern**: Use local date for fallback
**Instructions**:

The current code (line 314-318 in createFallbackParse):
```typescript
date: {
  value: new Date(),
  confidence: 'medium',
},
```

This is actually correct - `new Date()` creates a Date object with the current local time, which displays correctly. **No change needed.**

**Completion Criteria**:
- [ ] Verified fallback uses `new Date()` which is timezone-correct

### Subtask 1.4: Consider "Today" Reference Date (Line 340)
**File**: `/home/pbrown/SkuInventory/src/lib/transaction-parser.ts`
**Instructions**:

The current code (line 340):
```typescript
const today = new Date().toISOString().split('T')[0]
```

This sends "today's date" to Claude in YYYY-MM-DD format. At 1:36 PM Pacific on Dec 8:
- Server time (if UTC): Could report Dec 8 or Dec 9 depending on server timezone
- User's local "today": Dec 8

For better accuracy, we could consider the user's timezone, but:
1. We don't have user timezone info available in this context
2. The server is likely in the same timezone as most users
3. Claude correctly interprets explicit dates like "11/17/2025"

**Recommendation**: Leave as-is for now. The main bug is in how we PARSE Claude's response, not in what we tell Claude. If users say "today" and the server is in a different timezone, that's a separate edge case.

**Completion Criteria**:
- [ ] Documented decision to leave "today" reference as-is

## Phase 2: Add Unit Tests

### Subtask 2.1: Create Transaction Parser Date Tests
**File**: `/home/pbrown/SkuInventory/tests/unit/transaction-parser-date.test.ts`
**Pattern**: Follow `tests/unit/analytics-service.test.ts`
**Instructions**:

Create a new test file to verify date parsing works correctly:

```typescript
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest'

describe('Transaction Parser Date Handling', () => {
  // We need to test the parseClaudeResponse function behavior
  // Since it's not exported, we'll test via parseTransactionText with mocked Anthropic

  describe('Date string parsing', () => {
    it('should parse YYYY-MM-DD as local date, not UTC', () => {
      // The fix: new Date("2025-11-17T00:00:00") should give local midnight
      const dateString = "2025-11-17"
      const dateWithTime = dateString.includes('T') ? dateString : `${dateString}T00:00:00`
      const parsed = new Date(dateWithTime)

      // The date should be Nov 17 in local time, regardless of timezone
      expect(parsed.getDate()).toBe(17)
      expect(parsed.getMonth()).toBe(10) // 0-indexed, November = 10
      expect(parsed.getFullYear()).toBe(2025)
    })

    it('should handle ISO datetime strings correctly', () => {
      const isoString = "2025-11-17T14:30:00Z"
      const dateWithTime = isoString.includes('T') ? isoString : `${isoString}T00:00:00`
      const parsed = new Date(dateWithTime)

      expect(parsed.getTime()).not.toBeNaN()
    })

    it('should demonstrate the bug being fixed', () => {
      // This test documents the bug we're fixing
      const buggyDate = new Date("2025-11-17") // UTC midnight
      const fixedDate = new Date("2025-11-17T00:00:00") // Local midnight

      // In Pacific Time, buggyDate.getDate() would return 16!
      // fixedDate.getDate() should always return 17
      expect(fixedDate.getDate()).toBe(17)
    })
  })
})
```

**Completion Criteria**:
- [ ] Test file created
- [ ] Tests pass with `npm test -- --filter="transaction-parser"`
- [ ] Tests document the bug being fixed

## Phase 3: Verification

### Subtask 3.1: Build Verification
**Instructions**:
```bash
npx tsc --noEmit
npm run build
npm run lint
```

**Completion Criteria**:
- [ ] TypeScript compiles without errors
- [ ] Build completes without errors
- [ ] Lint passes

### Subtask 3.2: Manual Testing
**Instructions**:
1. Start the test environment: `cd docker && docker compose -f docker-compose.test.yml up -d`
2. Navigate to Transactions > New
3. Use conversational input: "We received 300 Advil from Amazon on 11/17/2025"
4. Verify the parsed date shows November 17, 2025 (not November 16)

**Test URL**: http://172.16.20.50:2345/transactions/new

**Completion Criteria**:
- [ ] Date displays correctly as entered (no off-by-one)
- [ ] Works for dates in past, present, and future
- [ ] No regression in other date handling

---

## Summary of Deliverables
**Files Created**: 1 (test file)
**Files Modified**: 1 (`src/lib/transaction-parser.ts`)

## Handoff to Build Agent
1. Execute subtasks in exact order
2. The main fix is in Subtask 1.1 - append time component to YYYY-MM-DD date strings
3. Test the fix manually in test environment before committing
4. Create unit tests to prevent regression

## Test Strategy Note
- Use Vitest for unit tests
- Manual testing required in test environment
- No E2E tests needed for this bug fix

## Technical Notes

### Why This Works
JavaScript's `Date` constructor behavior:
- `new Date("2025-11-17")` - Parsed as **UTC midnight**, which in Pacific Time is 4 PM on Nov 16
- `new Date("2025-11-17T00:00:00")` - Parsed as **local midnight**, which is midnight Nov 17 local time

By appending `T00:00:00` (without timezone suffix), we force local time interpretation, which matches user intent.

### Alternative Approaches Considered
1. **Use date-fns or dayjs**: Would require adding a dependency. Overkill for this fix.
2. **Store dates as strings throughout**: Would require refactoring many display components.
3. **Use UTC everywhere**: Would affect existing date displays and require coordinated changes.

The chosen approach (append time component) is minimal, surgical, and backwards-compatible.

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 10m |
| **Total** | **30m** |
