# Implementation Plan
**Generated**: 2026-01-02T10:15:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #357
**Estimated Build Time**: 6-8 hours
**Complexity**: Moderate

## Investigation Summary

### Request Analysis
**Type**: Feature
**Source**: GitHub Issue #357
**Priority**: P1-MVP (per spec User Story 6)

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED (affected modules ~5-15 min)
**Suggested Filter**: `--filter="change-log"` or None (new feature)

### Issue Validation
**Status**: Valid
**Recent Changes**: Issue #356 (closed 2026-01-02) added Monday Dashboard UI. Issue #354 added database schema including ChangeLogEntry model which this feature builds upon.

### Current State Assessment
- **Existing Database Schema**: `ChangeLogEntry` model exists in `prisma/schema.prisma` with all required fields:
  - `id`, `recommendationId`, `action`, `reason`, `notes`, `beforeValues`, `afterValues`, `userId`, `createdAt`
  - Indexes on `createdAt`, `action`, `recommendationId`, `userId`
- **Existing Types**: `ChangeLogEntry` interface in `src/types/recommendations.ts` + `changeLogQuerySchema` Zod validation
- **Existing API**: ChangeLogEntries are created in `src/app/api/recommendations/[id]/route.ts` when recommendations are actioned
- **Missing**: Dedicated `/api/change-log` endpoint for listing/filtering entries
- **Missing**: Change Log page at `/change-log`
- **Missing**: ChangeLogTable and ChangeLogFilters components
- **Missing**: Sidebar navigation link

### Dependencies & Blockers
1. Prisma schema already has `ChangeLogEntry` model - no migration needed
2. Types already defined in `src/types/recommendations.ts`
3. No external dependencies required

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Moderate
**Effort**: 6-8 hours
**Risk**: Low - follows established patterns, uses existing schema

### Patterns Identified
**Primary**: `/src/app/(dashboard)/transactions/page.tsx` - Client-side page with filtering, pagination, URL state
**Secondary**: `/src/app/api/transactions/route.ts` - GET route with Prisma filtering, pagination
**Secondary**: `/src/app/api/sync-logs/route.ts` - Simple list API with filters
**Secondary**: `/src/components/features/ComponentTable.tsx` - Table component pattern

### Ripple Effect Analysis
**Files Identified**: 5 new files, 2 modifications

| File | Action | Purpose |
|------|--------|---------|
| `src/app/api/change-log/route.ts` | CREATE | New GET endpoint with filters/pagination |
| `src/components/features/ChangeLogTable.tsx` | CREATE | Table display component |
| `src/components/features/ChangeLogFilters.tsx` | CREATE | Filter controls component |
| `src/app/(dashboard)/change-log/page.tsx` | CREATE | Main page component |
| `src/types/recommendations.ts` | MODIFY | Add response interface for Change Log entries |
| `src/app/(dashboard)/layout.tsx` | MODIFY | Add sidebar navigation link |

---

## Executive Summary
This implementation adds a Change Log feature for the Recommendation Engine. It provides a searchable timeline of all accepted/rejected recommendation actions with before/after values, replacing the Apple Notes workflow. The feature includes a new API endpoint with date/type/keyword filtering, a filterable table UI, and sidebar navigation integration.

## Phase 1: Types Layer

### Subtask 1.1: Extend Types for ChangeLog API Response
**File**: `/home/pbrown/SkuInventory/src/types/recommendations.ts`
**Pattern**: Follow existing `RecommendationListResponse` structure at line ~287
**Instructions**:
1. Add new interface `ChangeLogEntryWithRelations` extending `ChangeLogEntry`:
   - Include `recommendation` relation with: `{ id, type, keyword, campaign?: { name } }`
   - Include `user` relation with: `{ id, name }`
2. Add new interface `ChangeLogListResponse`:
   ```typescript
   export interface ChangeLogListResponse {
     data: ChangeLogEntryWithRelations[]
     meta: {
       total: number
       page: number
       pageSize: number
       totalPages: number
     }
   }
   ```
3. Extend `changeLogQuerySchema` to add keyword search:
   ```typescript
   export const changeLogQuerySchema = z.object({
     recommendationId: z.string().uuid().optional(),
     action: changeLogActionSchema.optional(),
     type: recommendationTypeSchema.optional(), // NEW: filter by recommendation type
     keyword: z.string().optional(), // NEW: text search
     startDate: z.string().regex(/^\d{4}-\d{2}-\d{2}$/).optional(),
     endDate: z.string().regex(/^\d{4}-\d{2}-\d{2}$/).optional(),
     page: z.coerce.number().int().positive().default(1),
     pageSize: z.coerce.number().int().positive().max(100).default(50),
   })
   ```

**Completion Criteria**:
- [ ] `ChangeLogEntryWithRelations` interface added
- [ ] `ChangeLogListResponse` interface added
- [ ] `changeLogQuerySchema` extended with `type` and `keyword` fields
- [ ] `npx tsc --noEmit` passes

---

## Phase 2: API Layer

### Subtask 2.1: Create Change Log GET Endpoint
**File**: `/home/pbrown/SkuInventory/src/app/api/change-log/route.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/app/api/transactions/route.ts` (lines 11-155)
**Instructions**:
1. Create new file at `src/app/api/change-log/route.ts`
2. Import dependencies:
   ```typescript
   import { NextRequest } from 'next/server'
   import { getServerSession } from 'next-auth'
   import { authOptions, getSelectedCompanyRole } from '@/lib/auth'
   import { prisma } from '@/lib/db'
   import { Prisma } from '@prisma/client'
   import { paginated, unauthorized, serverError, parseQuery, error } from '@/lib/api-response'
   import { changeLogQuerySchema, type ChangeLogEntryWithRelations } from '@/types/recommendations'
   ```
3. Implement GET handler with:
   - Session check (require authenticated user)
   - Brand selection check (`session.user.selectedBrandId` required)
   - Build Prisma where clause:
     - Filter by brand via recommendation relation
     - Optional date range filter on `createdAt`
     - Optional action filter
     - Optional type filter (via recommendation.type)
     - Optional keyword search (on recommendation.keyword using `contains` with `mode: 'insensitive'`)
   - Get total count
   - Fetch entries with pagination, ordered by `createdAt desc`
   - Include relations: `recommendation`, `user`
   - Transform to `ChangeLogEntryWithRelations[]`
   - Return paginated response
4. Performance: Use indexed fields (`createdAt`, `action`) for filtering

**Completion Criteria**:
- [ ] File created at `src/app/api/change-log/route.ts`
- [ ] GET handler implemented with auth check
- [ ] All filters working: dateFrom, dateTo, action, type, keyword
- [ ] Pagination working (page, pageSize)
- [ ] Response matches `ChangeLogListResponse` structure
- [ ] `npm run build` passes

---

## Phase 3: Frontend Components

### Subtask 3.1: Create ChangeLogFilters Component
**File**: `/home/pbrown/SkuInventory/src/components/features/ChangeLogFilters.tsx`
**Pattern**: Follow filter section in `/home/pbrown/SkuInventory/src/app/(dashboard)/transactions/page.tsx` (lines 229-315)
**Instructions**:
1. Create client component with props:
   ```typescript
   interface ChangeLogFiltersProps {
     filters: {
       action: string
       type: string
       keyword: string
       startDate: string
       endDate: string
     }
     onFiltersChange: (filters: ChangeLogFiltersProps['filters']) => void
     onApply: () => void
     onClear: () => void
   }
   ```
2. Include filter controls:
   - Action dropdown: All, Accepted, Rejected, Snoozed
   - Type dropdown: All, Keyword Graduation, Negative Keyword, Duplicate Keyword, Budget Increase, Bid Decrease
   - Keyword text input (for search)
   - Date From input (type="date")
   - Date To input (type="date")
   - Apply/Clear buttons
3. Use shadcn/ui components: Card, CardContent, Select, Input, Button
4. Import icons from lucide-react: Filter

**Completion Criteria**:
- [ ] File created at `src/components/features/ChangeLogFilters.tsx`
- [ ] All 5 filter controls rendered
- [ ] Apply and Clear buttons functional
- [ ] Component exports properly
- [ ] `npx tsc --noEmit` passes

### Subtask 3.2: Create ChangeLogTable Component
**File**: `/home/pbrown/SkuInventory/src/components/features/ChangeLogTable.tsx`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/components/features/ComponentTable.tsx`
**Instructions**:
1. Create client component with props:
   ```typescript
   interface ChangeLogTableProps {
     entries: ChangeLogEntryWithRelations[]
     isLoading: boolean
   }
   ```
2. Implement table with columns:
   - Date/Time (formatted, with suppressHydrationWarning)
   - Action (Badge: green=Accepted, red=Rejected, blue=Snoozed)
   - Type (Badge showing recommendation type in human-readable form)
   - Keyword (from recommendation.keyword or "-")
   - Campaign (from recommendation.campaign?.name or "-")
   - Actioned By (user.name)
   - Before/After (expandable or summary showing key values)
   - Notes/Reason (truncated with tooltip)
3. Use shadcn/ui Table components
4. Add empty state using EmptyState component with History icon
5. Add loading skeleton state

**Completion Criteria**:
- [ ] File created at `src/components/features/ChangeLogTable.tsx`
- [ ] All columns rendered correctly
- [ ] Action badges color-coded
- [ ] Before/After values visible
- [ ] Empty state shown when no entries
- [ ] Loading state shown during fetch
- [ ] `npx tsc --noEmit` passes

---

## Phase 4: Page Component

### Subtask 4.1: Create Change Log Page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/change-log/page.tsx`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/app/(dashboard)/transactions/page.tsx` (full file)
**Instructions**:
1. Create client component with 'use client' directive
2. Wrap in Suspense boundary for useSearchParams
3. Implement state management:
   - `entries: ChangeLogEntryWithRelations[]`
   - `total: number`
   - `isLoading: boolean`
   - `error: string | null`
   - `filters` object matching ChangeLogFiltersProps
4. URL state management for filters/pagination (useSearchParams, useRouter)
5. Session check using `useSession()` with loading state handling
6. Brand selection check - show message if no brand selected
7. Fetch function using `/api/change-log?...params`
8. Re-fetch on filter change, brand change, or pagination
9. Page structure:
   - Header: "Change Log" title with description
   - Stats cards (optional): Total entries, by action type
   - ChangeLogFilters component
   - ChangeLogTable component
   - Pagination controls

**Completion Criteria**:
- [ ] Directory created at `src/app/(dashboard)/change-log/`
- [ ] File created at `src/app/(dashboard)/change-log/page.tsx`
- [ ] Page loads at `/change-log` route
- [ ] Filters update URL params
- [ ] Pagination working
- [ ] Brand selection enforced
- [ ] Session loading state handled
- [ ] Error states displayed
- [ ] `npm run build` passes

---

## Phase 5: Navigation Integration

### Subtask 5.1: Add Sidebar Navigation Link
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/layout.tsx`
**Pattern**: Follow existing mainNavigation array structure at line 45-57
**Instructions**:
1. Import History icon from lucide-react:
   ```typescript
   import { History } from 'lucide-react'
   ```
2. Add navigation item to `mainNavigation` array after "Recommendations":
   ```typescript
   { name: 'Change Log', href: '/change-log', icon: History },
   ```
3. Place after the Recommendations entry (approximately line 56)

**Completion Criteria**:
- [ ] History icon imported
- [ ] "Change Log" nav item added to mainNavigation
- [ ] Link appears in sidebar after "Recommendations"
- [ ] Link navigates to `/change-log`
- [ ] Active state works correctly
- [ ] `npm run build` passes

---

## Phase 6: Validation

### Subtask 6.1: End-to-End Verification
**Instructions**:
1. Run TypeScript check:
   ```bash
   npx tsc --noEmit
   ```
2. Run build:
   ```bash
   npm run build
   ```
3. Run lint:
   ```bash
   npm run lint
   ```
4. Manual verification (document for tester):
   - Navigate to `/recommendations`
   - Accept/reject a recommendation
   - Navigate to `/change-log`
   - Verify entry appears with correct data
   - Test all filters
   - Test pagination
   - Verify search returns results in < 1 second

**Completion Criteria**:
- [ ] TypeScript check passes
- [ ] Build succeeds
- [ ] Lint passes
- [ ] Manual test steps documented

---

## Summary of Deliverables

**Files Created**: 4
- `src/app/api/change-log/route.ts`
- `src/components/features/ChangeLogFilters.tsx`
- `src/components/features/ChangeLogTable.tsx`
- `src/app/(dashboard)/change-log/page.tsx`

**Files Modified**: 2
- `src/types/recommendations.ts` (add interfaces and extend schema)
- `src/app/(dashboard)/layout.tsx` (add nav link)

## Handoff to Build Agent
1. Execute subtasks in exact order (Phase 1 through Phase 6)
2. Each phase builds on the previous - complete fully before proceeding
3. Test completion criteria before moving to next subtask
4. Follow reference patterns exactly (file paths provided)
5. Use `npx tsc --noEmit` after each TypeScript file change
6. Use `npm run build` after each phase to catch issues early

## Test Strategy Note
- No new unit tests required for this feature (follows TARGETED strategy)
- Manual E2E testing sufficient for MVP
- Performance requirement: Search returns results in < 1 second for 10k entries
  - Achieved via indexed `createdAt` field and efficient Prisma queries

## Acceptance Criteria Reference (from Spec)
- [x] Database model exists (Subtask N/A - already exists)
- [ ] All recommendation actions appear in timeline (Subtask 2.1)
- [ ] Search by date range works (Subtask 2.1, 3.1)
- [ ] Search by type works (Subtask 2.1, 3.1)
- [ ] Search by keyword works (Subtask 2.1, 3.1)
- [ ] Search by status/action works (Subtask 2.1, 3.1)
- [ ] Before/after values visible (Subtask 3.2)
- [ ] Search returns results in < 1 second (Subtask 2.1 - use indexes)

## Performance Metrics
| Phase | Estimated Duration |
|-------|-------------------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 20m |
| **Total** | **40m** |
