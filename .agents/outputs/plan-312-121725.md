# Implementation Plan
**Generated**: 2025-12-17T04:30:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: Issue #312
**Estimated Build Time**: 1-2 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Bug
**Source**: GitHub Issue #312
**Priority**: High (user-facing functionality broken)

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED
**Suggested Filter**: `--testPathPattern="build"` or None (manual testing recommended)

### Issue Validation
**Status**: Valid
**Recent Changes**: Multiple recent fixes to BuildDialog.tsx (issue #275, #264, #250, #274)

### Root Cause Analysis

The user reports getting a "BadRequest" error when trying to record a build transaction with a past date (e.g., 12/1/25), but builds work correctly with today's date.

**Two Issues Identified:**

1. **Primary Issue - Generic Error Display**: The BuildDialog.tsx component at line 239 displays `data?.error` (the error code "BadRequest") instead of `data?.message` (the actual error message like "No BOM version effective on 2025-12-01 for this SKU").

2. **Underlying Business Logic**: The BOM version for the "1pk" SKU has `effectiveStartDate = 2025-12-08`. When the user tries to build with a date of 12/1/2025, no BOM version is found because:
   - The query at line 44-53 in route.ts looks for: `effectiveStartDate <= data.date`
   - Since `2025-12-08 <= 2025-12-01` is false, no BOM matches
   - The API correctly returns: "No BOM version effective on 2025-12-01 for this SKU"
   - But the UI shows the generic error code "BadRequest" instead of the helpful message

**Code Flow:**
```
User enters date: 2025-12-01
  → BuildDialog sends POST to /api/transactions/build
    → route.ts queries BOM with effectiveStartDate <= 2025-12-01
      → No BOM found (effectiveStartDate is 2025-12-08)
        → API returns: { error: "BadRequest", message: "No BOM version effective on 2025-12-01 for this SKU" }
          → BuildDialog reads: data?.error → "BadRequest"
            → User sees: "BadRequest" (not helpful!)
```

### Current State Assessment
- Existing components: BuildDialog.tsx exists and functions
- Database: Schema is correct, BOM versions have effectiveStartDate
- API Routes: /api/transactions/build correctly returns detailed error messages
- Types: API response type includes both `error` and `message` fields

### Dependencies & Blockers
None - straightforward fix

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Simple
**Effort**: 1-2 hours
**Risk**: Low

### Patterns Identified
**Primary**: `/home/pbrown/SkuInventory/src/components/features/QuickEntryForm.tsx:297` - Best practice pattern:
```typescript
throw new Error(data?.message || data?.error || 'Failed to record transaction')
```

**Secondary**: `/home/pbrown/SkuInventory/src/components/features/ReceiptDialog.tsx:104` - Alternative correct pattern:
```typescript
throw new Error(data?.message || 'Failed to record receipt')
```

### Ripple Effect Analysis

**Files Using Incorrect Pattern (`data?.error`)**: 15 files
- BuildDialog.tsx:239 (**FIX THIS** - main issue)
- BrandForm.tsx:56
- BrandTable.tsx:55, 76
- CompanyForm.tsx:70
- CategoryTable.tsx:55, 76
- CompanyTable.tsx:57
- BrandSelectionDialog.tsx:70
- CategoryForm.tsx:54
- CompanyBrandSelector.tsx:66, 91, 123
- CompanySelectionDialog.tsx:70
- UserForm.tsx:75
- LocationForm.tsx:73
- LocationTable.tsx:44, 64
- TransactionDetail.tsx:139

**Decision**: Fix BuildDialog.tsx (the reported issue), recommend follow-up issue for remaining files.

**TOTAL FILES AFFECTED FOR THIS FIX**: 1

---

## Executive Summary

Fix the BuildDialog.tsx component to display the actual API error message (`data?.message`) instead of the generic error code (`data?.error`). This will allow users to see helpful messages like "No BOM version effective on 2025-12-01 for this SKU" instead of the unhelpful "BadRequest". The underlying business logic is correct - the API already returns helpful error messages, they just aren't being displayed.

---

## Phase 1: Fix BuildDialog Error Message Display

### Subtask 1.1: Update BuildDialog Error Handling
**File**: `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx`
**Pattern**: Follow `QuickEntryForm.tsx:297` - use `data?.message || data?.error || 'fallback'`
**Line**: 239

**Instructions**:
1. Locate line 239 in BuildDialog.tsx
2. Change from:
   ```typescript
   throw new Error(data?.error || 'Failed to record build')
   ```
3. Change to:
   ```typescript
   throw new Error(data?.message || data?.error || 'Failed to record build')
   ```

**Rationale**: The API response structure is `{ error: "ErrorCode", message: "Detailed message" }`. We need to prioritize `message` for user-friendly display, falling back to `error` code if message is absent.

**Completion Criteria**:
- [ ] Line 239 updated to use `data?.message || data?.error`
- [ ] TypeScript compiles without errors: `npx tsc --noEmit`
- [ ] Build succeeds: `npm run build`

---

## Phase 2: Verification

### Subtask 2.1: Manual Testing
**Instructions**:
1. Start the test environment (http://172.16.20.50:2345)
2. Navigate to SKU page and click "Record Build"
3. Select "1pk" SKU
4. Enter units to build: 239
5. Change date to 12/1/2025 (a date before BOM effectiveStartDate)
6. Click "Record Build"
7. **Expected Result**: Error message should display "No BOM version effective on 2025-12-01 for this SKU" (or similar helpful message)
8. **Previous Behavior**: "BadRequest"

**Completion Criteria**:
- [ ] Error message displays the specific API error message, not "BadRequest"
- [ ] Builds with valid dates (today) still work correctly
- [ ] No console errors introduced

### Subtask 2.2: Run TypeScript and Build Checks
**Commands**:
```bash
# TypeScript check
npx tsc --noEmit

# Build check
npm run build

# Lint check
npm run lint
```

**Completion Criteria**:
- [ ] No TypeScript errors
- [ ] Build succeeds
- [ ] No new lint warnings

---

## Summary of Deliverables
**Files Created**: 0
**Files Modified**: 1
  - `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx` (line 239)

## Handoff to Build Agent
1. Execute subtasks in exact order
2. The fix is a single-line change
3. Test completion criteria before next subtask
4. Follow reference pattern from QuickEntryForm.tsx

## Follow-up Recommendation

Create a follow-up GitHub issue to standardize error handling across all components using `data?.error`:
- 14 other files have the same pattern issue
- Batch fix would improve consistency across the codebase
- Not blocking for this issue since user specifically reported BuildDialog

**Suggested follow-up issue title**: "Standardize API error message display across UI components"

## Test Strategy Note
- Manual testing is primary verification method
- Automated unit tests for this UI component are not present
- Build/typecheck validation is critical

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 10m |
| **Total** | **30m** |
