# Quick Fix Plan

**Issue**: #387 - [Bug] Fix skipped integration test for settings partial updates
**Tier**: 1 (Quick Fix)
**Type**: Bug Fix
**Est. Time**: 1-2 hours

## The Fix

The integration test at `tests/integration/settings.test.ts:355-357` is skipped because sequential PATCH calls to the settings API overwrite previously set values. The root cause is NOT Prisma caching as originally suspected.

**Root Cause**: When `updateSettingsSchema.safeParse(body)` is called, zod applies default values to ALL fields in the schema, not just the ones provided in the request body. This means a PATCH request with `{ defaultLeadTimeDays: 21 }` gets parsed as a full object with all fields set to their defaults (including `allowNegativeInventory: false`), which then overwrites any previously saved settings.

**Example of the bug**:
```typescript
// User sends: { defaultLeadTimeDays: 21 }
// Schema parses to: { allowNegativeInventory: false, defaultLeadTimeDays: 21, ... all other defaults }
// This overwrites allowNegativeInventory even if it was previously set to true
```

**The fix**: In the API route's PATCH handler, only merge the fields that were actually provided in the request body, not the entire parsed result. This requires comparing the original body against the parsed result to identify which fields were user-provided vs default-applied.

## Changes Required

| File | Line | Change |
|------|------|--------|
| `src/app/api/settings/route.ts` | 94-120 | Modify PATCH handler to only merge user-provided fields |
| `tests/integration/settings.test.ts` | 356 | Remove `.skip` from the test |

## Implementation Details

### Subtask 1: Fix the PATCH handler in settings route

**File**: `/home/pbrown/SkuInventory/src/app/api/settings/route.ts`

**Current code (lines 94-120)**:
```typescript
const body = await request.json()
const validation = updateSettingsSchema.safeParse(body)

if (!validation.success) {
  return NextResponse.json(
    { error: 'Validation failed', details: validation.error.flatten() },
    { status: 400 }
  )
}

// Get current company settings
const company = await prisma.company.findUnique({
  where: { id: selectedCompanyId },
  select: {
    id: true,
    name: true,
    settings: true,
  },
})

if (!company) {
  return NextResponse.json({ error: 'Company not found' }, { status: 404 })
}

// Merge new settings with existing
const currentSettings = (company.settings as Record<string, unknown>) || {}
const newSettings = { ...DEFAULT_SETTINGS, ...currentSettings, ...validation.data }
```

**Fixed code**:
```typescript
const body = await request.json()
const validation = updateSettingsSchema.safeParse(body)

if (!validation.success) {
  return NextResponse.json(
    { error: 'Validation failed', details: validation.error.flatten() },
    { status: 400 }
  )
}

// Get current company settings
const company = await prisma.company.findUnique({
  where: { id: selectedCompanyId },
  select: {
    id: true,
    name: true,
    settings: true,
  },
})

if (!company) {
  return NextResponse.json({ error: 'Company not found' }, { status: 404 })
}

// Only merge fields that were actually provided in the request body
// (not the defaults applied by zod schema parsing)
const providedFields: Record<string, unknown> = {}
for (const key of Object.keys(body)) {
  if (key in validation.data) {
    providedFields[key] = validation.data[key as keyof typeof validation.data]
  }
}

// Merge new settings with existing - only override fields that were provided
const currentSettings = (company.settings as Record<string, unknown>) || {}
const newSettings = { ...DEFAULT_SETTINGS, ...currentSettings, ...providedFields }
```

**Why this works**: By iterating over the original request `body` keys and only taking those values from the validated result, we ensure that only user-provided fields are merged. Fields not in the original request won't be included in `providedFields`, so they won't overwrite existing settings.

### Subtask 2: Re-enable the skipped test

**File**: `/home/pbrown/SkuInventory/tests/integration/settings.test.ts`

**Current code (lines 355-357)**:
```typescript
// TODO: Investigate potential Prisma caching issue in sequential PATCH calls
it.skip('partial updates preserve other settings', async () => {
```

**Fixed code**:
```typescript
it('partial updates preserve other settings', async () => {
```

Remove the TODO comment and the `.skip` from the test.

## Validation

After making the changes:

```bash
# Run TypeScript check
npx tsc --noEmit

# Run build
npm run build

# Run the specific integration test to verify the fix
npm run test:integration -- tests/integration/settings.test.ts

# Run all integration tests to ensure no regressions
npm run test:integration
```

## Completion Criteria

- [ ] `npm run build` passes without errors
- [ ] `npx tsc --noEmit` passes without errors
- [ ] The previously skipped test `'partial updates preserve other settings'` now passes
- [ ] All other settings tests continue to pass (20 tests total)
- [ ] Settings partial updates work correctly (verified by test)
- [ ] No `.skip()` remains on the test

## Files Summary

**Created**: 0
**Modified**: 2
- `src/app/api/settings/route.ts` - Fix PATCH handler to only merge user-provided fields
- `tests/integration/settings.test.ts` - Remove `.skip` from test

## Performance Metrics

| Phase | Duration |
|-------|----------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 5m |
| **Total** | **25m** |

---

AGENT_RETURN: plan-387-010826
