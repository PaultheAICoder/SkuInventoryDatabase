# Implementation Plan
**Generated**: 2025-12-06T16:30:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: Issue #198
**Estimated Build Time**: 6-8 hours
**Complexity**: Medium

## Investigation Summary

### Request Analysis
**Type**: Enhancement (Multi-tenancy enforcement)
**Source**: GitHub Issue #198
**Priority**: High (data integrity / security)
**Parent Issue**: #195 (Architectural Audit: Technical Debt and Design Issues)

### Task Classification
**Category**: REFACTORING
**Test Strategy**: TARGETED (affected BOM service and routes, ~10-15 min)
**Suggested Filter**: `--filter="bom"` for unit tests

### Issue Validation
**Status**: Valid
**Recent Changes**: None affecting BOM service multi-tenancy directly

### Current State Assessment

**BOM Service Functions (src/services/bom.ts):**

| Function | Current Signature | companyId Status | Needs Update |
|----------|-------------------|------------------|--------------|
| `calculateBOMUnitCost` | `(bomVersionId)` | Missing | YES |
| `calculateBOMUnitCosts` | `(bomVersionIds)` | Missing | YES |
| `calculateMaxBuildableUnits` | `(skuId, companyId, locationId?)` | Already has companyId | NO - but needs query enforcement |
| `calculateMaxBuildableUnitsForSKUs` | `(skuIds, companyId, locationId?)` | Already has companyId | NO - but needs query enforcement |
| `calculateLimitingFactors` | `(skuId, companyId, locationId?, limit?)` | Already has companyId | NO - but needs query enforcement |
| `createBOMVersion` | `(params)` | Missing in params | YES |
| `cloneBOMVersion` | `(params)` | Missing in params | YES |
| `activateBOMVersion` | `(bomVersionId)` | Missing | YES |
| `updateBOMVersion` | `(params)` | Missing in params | YES |
| `isComponentInActiveBOM` | `(componentId)` | Missing | YES |
| `calculateLineCosts` | `(lines)` | N/A (pure function) | NO |

**Database Schema Note:**
- BOMVersion does NOT have a direct `companyId` field
- Tenant verification must go through the SKU relationship: `sku: { companyId: companyId }`

### Dependencies & Blockers
1. No schema changes required (use existing SKU->Company relationship)
2. All API routes already have `session.user.selectedCompanyId` available

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Medium
**Effort**: 6-8 hours
**Risk**: Low-Medium (signature changes affect callers, but changes are straightforward)

### Patterns Identified
**Primary**: `src/services/inventory.ts:getComponentQuantity` - Example of proper companyId enforcement
**Secondary**: Existing `calculateMaxBuildableUnits` function - Already has companyId in signature

### Ripple Effect Analysis

**Files Identified**: 12 files total

**BOM Service (1 file):**
- `/home/pbrown/SkuInventory/src/services/bom.ts` - Primary target

**API Routes calling BOM functions (9 files):**
1. `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/route.ts` - Uses `calculateBOMUnitCost`, `updateBOMVersion`
2. `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/activate/route.ts` - Uses `activateBOMVersion`, `calculateBOMUnitCost`
3. `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/clone/route.ts` - Uses `cloneBOMVersion`, `calculateBOMUnitCost`
4. `/home/pbrown/SkuInventory/src/app/api/skus/[id]/bom-versions/route.ts` - Uses `createBOMVersion`, `calculateBOMUnitCost`
5. `/home/pbrown/SkuInventory/src/app/api/skus/route.ts` - Uses `calculateBOMUnitCosts`, `calculateMaxBuildableUnitsForSKUs`
6. `/home/pbrown/SkuInventory/src/app/api/skus/[id]/route.ts` - Uses `calculateBOMUnitCosts`, `calculateMaxBuildableUnits`
7. `/home/pbrown/SkuInventory/src/app/api/export/skus/route.ts` - Uses `calculateBOMUnitCost`, `calculateMaxBuildableUnits`
8. `/home/pbrown/SkuInventory/src/app/api/components/[id]/route.ts` - Uses `calculateMaxBuildableUnitsForSKUs`
9. `/home/pbrown/SkuInventory/src/app/api/dashboard/route.ts` - Uses `calculateMaxBuildableUnitsForSKUs`, `calculateBOMUnitCosts`
10. `/home/pbrown/SkuInventory/src/app/api/import/skus/route.ts` - Uses `createBOMVersion`

**Service files (1 file):**
- `/home/pbrown/SkuInventory/src/services/chatbot-queries.ts` - Uses `calculateMaxBuildableUnits`, `calculateLimitingFactors`

**Test files (1 file):**
- `/home/pbrown/SkuInventory/tests/unit/bom-calculations.test.ts` - Needs signature updates

---

## Executive Summary

This implementation adds explicit `companyId` parameter requirements to BOM service functions that currently lack them, and enforces tenant isolation by adding company verification via the SKU relationship in database queries. Functions that already accept `companyId` will have their queries enhanced to actually enforce it. The change provides "defense in depth" so tenant isolation doesn't rely solely on API layer checks.

---

## Phase 1: Update BOM Service Functions with companyId Enforcement

### Subtask 1.1: Update calculateBOMUnitCost Function
**File**: `/home/pbrown/SkuInventory/src/services/bom.ts`
**Pattern**: Follow existing `calculateMaxBuildableUnits` signature pattern
**Lines**: 9-23
**Instructions**:
1. Add `companyId: string` as second parameter
2. Add `bomVersion` include to query for SKU relationship
3. Add where clause filter: `bomVersion: { sku: { companyId } }`

**Before**:
```typescript
export async function calculateBOMUnitCost(bomVersionId: string): Promise<number> {
  const lines = await prisma.bOMLine.findMany({
    where: { bomVersionId },
```

**After**:
```typescript
export async function calculateBOMUnitCost(bomVersionId: string, companyId: string): Promise<number> {
  const lines = await prisma.bOMLine.findMany({
    where: {
      bomVersionId,
      bomVersion: { sku: { companyId } },
    },
```

**Validation**: `npx tsc --noEmit`
**Completion Criteria**:
- [ ] Function signature includes companyId
- [ ] Query filters by company via SKU relationship
- [ ] TypeScript compiles without errors

### Subtask 1.2: Update calculateBOMUnitCosts Function
**File**: `/home/pbrown/SkuInventory/src/services/bom.ts`
**Lines**: 28-55
**Instructions**:
1. Add `companyId: string` as second parameter
2. Add company filter to where clause via SKU relationship

**Before**:
```typescript
export async function calculateBOMUnitCosts(
  bomVersionIds: string[]
): Promise<Map<string, number>> {
  const lines = await prisma.bOMLine.findMany({
    where: { bomVersionId: { in: bomVersionIds } },
```

**After**:
```typescript
export async function calculateBOMUnitCosts(
  bomVersionIds: string[],
  companyId: string
): Promise<Map<string, number>> {
  const lines = await prisma.bOMLine.findMany({
    where: {
      bomVersionId: { in: bomVersionIds },
      bomVersion: { sku: { companyId } },
    },
```

**Validation**: `npx tsc --noEmit`
**Completion Criteria**:
- [ ] Function signature includes companyId
- [ ] Query filters by company via SKU relationship

### Subtask 1.3: Enhance calculateMaxBuildableUnits Query Enforcement
**File**: `/home/pbrown/SkuInventory/src/services/bom.ts`
**Lines**: 62-103
**Instructions**:
1. Already has companyId parameter
2. Add SKU company verification in the BOMVersion query where clause

**Before** (lines 68-72):
```typescript
  const activeBom = await prisma.bOMVersion.findFirst({
    where: {
      skuId,
      isActive: true,
    },
```

**After**:
```typescript
  const activeBom = await prisma.bOMVersion.findFirst({
    where: {
      skuId,
      isActive: true,
      sku: { companyId },
    },
```

**Validation**: `npx tsc --noEmit`
**Completion Criteria**:
- [ ] Query enforces company ownership via SKU relationship

### Subtask 1.4: Enhance calculateMaxBuildableUnitsForSKUs Query Enforcement
**File**: `/home/pbrown/SkuInventory/src/services/bom.ts`
**Lines**: 109-171
**Instructions**:
1. Already has companyId parameter
2. Add SKU company verification in the BOMVersion query where clause

**Before** (lines 115-119):
```typescript
  const activeBoms = await prisma.bOMVersion.findMany({
    where: {
      skuId: { in: skuIds },
      isActive: true,
    },
```

**After**:
```typescript
  const activeBoms = await prisma.bOMVersion.findMany({
    where: {
      skuId: { in: skuIds },
      isActive: true,
      sku: { companyId },
    },
```

**Validation**: `npx tsc --noEmit`
**Completion Criteria**:
- [ ] Query enforces company ownership via SKU relationship

### Subtask 1.5: Enhance calculateLimitingFactors Query Enforcement
**File**: `/home/pbrown/SkuInventory/src/services/bom.ts`
**Lines**: 178-242
**Instructions**:
1. Already has companyId parameter
2. Add SKU company verification in the BOMVersion query where clause

**Before** (lines 185-190):
```typescript
  const activeBom = await prisma.bOMVersion.findFirst({
    where: {
      skuId,
      isActive: true,
    },
```

**After**:
```typescript
  const activeBom = await prisma.bOMVersion.findFirst({
    where: {
      skuId,
      isActive: true,
      sku: { companyId },
    },
```

**Validation**: `npx tsc --noEmit`
**Completion Criteria**:
- [ ] Query enforces company ownership via SKU relationship

### Subtask 1.6: Update createBOMVersion Function
**File**: `/home/pbrown/SkuInventory/src/services/bom.ts`
**Lines**: 247-320
**Instructions**:
1. Add `companyId: string` to params type
2. Verify SKU belongs to company before creating BOM

**Before** (lines 247-261):
```typescript
export async function createBOMVersion(params: {
  skuId: string
  versionName: string
  effectiveStartDate: Date
  isActive: boolean
  notes?: string | null
  defectNotes?: string | null
  qualityMetadata?: Record<string, unknown>
  lines: Array<{
    componentId: string
    quantityPerUnit: number
    notes?: string | null
  }>
  createdById: string
}) {
```

**After**:
```typescript
export async function createBOMVersion(params: {
  skuId: string
  companyId: string
  versionName: string
  effectiveStartDate: Date
  isActive: boolean
  notes?: string | null
  defectNotes?: string | null
  qualityMetadata?: Record<string, unknown>
  lines: Array<{
    componentId: string
    quantityPerUnit: number
    notes?: string | null
  }>
  createdById: string
}) {
```

3. Add validation inside function before transaction (after destructuring):
```typescript
  // Verify SKU belongs to company
  const sku = await prisma.sKU.findFirst({
    where: { id: skuId, companyId },
  })
  if (!sku) {
    throw new Error('SKU not found or does not belong to company')
  }
```

**Validation**: `npx tsc --noEmit`
**Completion Criteria**:
- [ ] Function params include companyId
- [ ] SKU ownership verified before creation

### Subtask 1.7: Update cloneBOMVersion Function
**File**: `/home/pbrown/SkuInventory/src/services/bom.ts`
**Lines**: 325-382
**Instructions**:
1. Add `companyId: string` to params type
2. Update source BOM query to verify company ownership

**Before** (lines 325-329):
```typescript
export async function cloneBOMVersion(params: {
  bomVersionId: string
  newVersionName: string
  createdById: string
}) {
```

**After**:
```typescript
export async function cloneBOMVersion(params: {
  bomVersionId: string
  companyId: string
  newVersionName: string
  createdById: string
}) {
```

3. Update source BOM query (lines 333-338):
**Before**:
```typescript
  const sourceBom = await prisma.bOMVersion.findUnique({
    where: { id: bomVersionId },
```

**After**:
```typescript
  const sourceBom = await prisma.bOMVersion.findFirst({
    where: {
      id: bomVersionId,
      sku: { companyId },
    },
```

**Validation**: `npx tsc --noEmit`
**Completion Criteria**:
- [ ] Function params include companyId
- [ ] Source BOM ownership verified via SKU

### Subtask 1.8: Update activateBOMVersion Function
**File**: `/home/pbrown/SkuInventory/src/services/bom.ts`
**Lines**: 387-440
**Instructions**:
1. Add `companyId: string` as second parameter
2. Update BOM query to verify company ownership

**Before** (line 387):
```typescript
export async function activateBOMVersion(bomVersionId: string) {
```

**After**:
```typescript
export async function activateBOMVersion(bomVersionId: string, companyId: string) {
```

3. Update BOM version query inside transaction (lines 390-393):
**Before**:
```typescript
    const bomVersion = await tx.bOMVersion.findUnique({
      where: { id: bomVersionId },
    })
```

**After**:
```typescript
    const bomVersion = await tx.bOMVersion.findFirst({
      where: {
        id: bomVersionId,
        sku: { companyId },
      },
    })
```

**Validation**: `npx tsc --noEmit`
**Completion Criteria**:
- [ ] Function signature includes companyId
- [ ] BOM ownership verified via SKU

### Subtask 1.9: Update updateBOMVersion Function
**File**: `/home/pbrown/SkuInventory/src/services/bom.ts`
**Lines**: 445-520
**Instructions**:
1. Add `companyId: string` to params type
2. Update existing BOM query to verify company ownership

**Before** (lines 445-457):
```typescript
export async function updateBOMVersion(params: {
  bomVersionId: string
  versionName?: string
  effectiveStartDate?: Date
  notes?: string | null
  defectNotes?: string | null
  qualityMetadata?: Record<string, unknown>
  lines?: Array<{
    componentId: string
    quantityPerUnit: number
    notes?: string | null
  }>
}) {
```

**After**:
```typescript
export async function updateBOMVersion(params: {
  bomVersionId: string
  companyId: string
  versionName?: string
  effectiveStartDate?: Date
  notes?: string | null
  defectNotes?: string | null
  qualityMetadata?: Record<string, unknown>
  lines?: Array<{
    componentId: string
    quantityPerUnit: number
    notes?: string | null
  }>
}) {
```

3. Update existing BOM query inside transaction (lines 462-465):
**Before**:
```typescript
    const existing = await tx.bOMVersion.findUnique({
      where: { id: bomVersionId },
    })
```

**After**:
```typescript
    const existing = await tx.bOMVersion.findFirst({
      where: {
        id: bomVersionId,
        sku: { companyId },
      },
    })
```

**Validation**: `npx tsc --noEmit`
**Completion Criteria**:
- [ ] Function params include companyId
- [ ] BOM ownership verified via SKU

### Subtask 1.10: Update isComponentInActiveBOM Function
**File**: `/home/pbrown/SkuInventory/src/services/bom.ts`
**Lines**: 539-549
**Instructions**:
1. Add `companyId: string` as second parameter
2. Add company filter via bomVersion->sku relationship

**Before**:
```typescript
export async function isComponentInActiveBOM(componentId: string): Promise<boolean> {
  const count = await prisma.bOMLine.count({
    where: {
      componentId,
      bomVersion: {
        isActive: true,
      },
    },
  })
```

**After**:
```typescript
export async function isComponentInActiveBOM(componentId: string, companyId: string): Promise<boolean> {
  const count = await prisma.bOMLine.count({
    where: {
      componentId,
      bomVersion: {
        isActive: true,
        sku: { companyId },
      },
    },
  })
```

**Validation**: `npx tsc --noEmit`
**Completion Criteria**:
- [ ] Function signature includes companyId
- [ ] Query filters by company via SKU

---

## Phase 2: Update API Routes to Pass companyId

### Subtask 2.1: Update /api/bom-versions/[id]/route.ts
**File**: `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/route.ts`
**Instructions**:
1. Update calls to `calculateBOMUnitCost` to pass `selectedCompanyId`
2. Update call to `updateBOMVersion` to include `companyId` in params

**Line 174** (PATCH handler):
**Before**:
```typescript
    const unitCost = await calculateBOMUnitCost(bomVersion.id)
```
**After**:
```typescript
    const unitCost = await calculateBOMUnitCost(bomVersion.id, selectedCompanyId!)
```

**Lines 168-171**:
**Before**:
```typescript
    const bomVersion = await updateBOMVersion({
      bomVersionId: id,
      ...data,
    })
```
**After**:
```typescript
    const bomVersion = await updateBOMVersion({
      bomVersionId: id,
      companyId: selectedCompanyId!,
      ...data,
    })
```

**Validation**: `npx tsc --noEmit`
**Completion Criteria**:
- [ ] calculateBOMUnitCost called with companyId
- [ ] updateBOMVersion called with companyId

### Subtask 2.2: Update /api/bom-versions/[id]/activate/route.ts
**File**: `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/activate/route.ts`
**Instructions**:
1. Update call to `activateBOMVersion` to pass `selectedCompanyId`
2. Update call to `calculateBOMUnitCost` to pass `selectedCompanyId`

**Line 47**:
**Before**:
```typescript
    const bomVersion = await activateBOMVersion(id)
```
**After**:
```typescript
    const bomVersion = await activateBOMVersion(id, selectedCompanyId!)
```

**Line 50**:
**Before**:
```typescript
    const unitCost = await calculateBOMUnitCost(bomVersion.id)
```
**After**:
```typescript
    const unitCost = await calculateBOMUnitCost(bomVersion.id, selectedCompanyId!)
```

**Validation**: `npx tsc --noEmit`
**Completion Criteria**:
- [ ] activateBOMVersion called with companyId
- [ ] calculateBOMUnitCost called with companyId

### Subtask 2.3: Update /api/bom-versions/[id]/clone/route.ts
**File**: `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/clone/route.ts`
**Instructions**:
1. Update call to `cloneBOMVersion` to include `companyId` in params
2. Update call to `calculateBOMUnitCost` to pass `selectedCompanyId`

**Lines 54-58**:
**Before**:
```typescript
    const newBomVersion = await cloneBOMVersion({
      bomVersionId: id,
      newVersionName: versionName,
      createdById: session.user.id,
    })
```
**After**:
```typescript
    const newBomVersion = await cloneBOMVersion({
      bomVersionId: id,
      companyId: selectedCompanyId!,
      newVersionName: versionName,
      createdById: session.user.id,
    })
```

**Line 61**:
**Before**:
```typescript
    const unitCost = await calculateBOMUnitCost(newBomVersion.id)
```
**After**:
```typescript
    const unitCost = await calculateBOMUnitCost(newBomVersion.id, selectedCompanyId!)
```

**Validation**: `npx tsc --noEmit`
**Completion Criteria**:
- [ ] cloneBOMVersion called with companyId
- [ ] calculateBOMUnitCost called with companyId

### Subtask 2.4: Update /api/skus/[id]/bom-versions/route.ts
**File**: `/home/pbrown/SkuInventory/src/app/api/skus/[id]/bom-versions/route.ts`
**Instructions**:
1. Update call to `createBOMVersion` to include `companyId` in params
2. Update call to `calculateBOMUnitCost` to pass `selectedCompanyId`

**Lines 177-187** (POST handler):
**Before**:
```typescript
    const bomVersion = await createBOMVersion({
      skuId,
      versionName: data.versionName,
      effectiveStartDate: data.effectiveStartDate,
      isActive: data.isActive,
      notes: data.notes,
      defectNotes: data.defectNotes,
      qualityMetadata: data.qualityMetadata,
      lines: data.lines,
      createdById: session.user.id,
    })
```
**After**:
```typescript
    const bomVersion = await createBOMVersion({
      skuId,
      companyId: selectedCompanyId!,
      versionName: data.versionName,
      effectiveStartDate: data.effectiveStartDate,
      isActive: data.isActive,
      notes: data.notes,
      defectNotes: data.defectNotes,
      qualityMetadata: data.qualityMetadata,
      lines: data.lines,
      createdById: session.user.id,
    })
```

**Line 190**:
**Before**:
```typescript
    const unitCost = await calculateBOMUnitCost(bomVersion.id)
```
**After**:
```typescript
    const unitCost = await calculateBOMUnitCost(bomVersion.id, selectedCompanyId!)
```

**Validation**: `npx tsc --noEmit`
**Completion Criteria**:
- [ ] createBOMVersion called with companyId
- [ ] calculateBOMUnitCost called with companyId

### Subtask 2.5: Update /api/skus/route.ts
**File**: `/home/pbrown/SkuInventory/src/app/api/skus/route.ts`
**Instructions**:
1. Update call to `calculateBOMUnitCosts` to pass `selectedCompanyId`

**Line 86**:
**Before**:
```typescript
      activeBomIds.length > 0 ? calculateBOMUnitCosts(activeBomIds) : new Map<string, number>(),
```
**After**:
```typescript
      activeBomIds.length > 0 ? calculateBOMUnitCosts(activeBomIds, selectedCompanyId!) : new Map<string, number>(),
```

**Validation**: `npx tsc --noEmit`
**Completion Criteria**:
- [ ] calculateBOMUnitCosts called with companyId

### Subtask 2.6: Update /api/skus/[id]/route.ts
**File**: `/home/pbrown/SkuInventory/src/app/api/skus/[id]/route.ts`
**Instructions**:
1. Update call to `calculateBOMUnitCosts` to pass `selectedCompanyId`
2. Update call to `calculateBOMUnitCosts` in PATCH handler

**Line 76** (GET handler):
**Before**:
```typescript
    const bomCosts = await calculateBOMUnitCosts(bomVersionIds)
```
**After**:
```typescript
    const bomCosts = await calculateBOMUnitCosts(bomVersionIds, selectedCompanyId!)
```

**Line 202-203** (PATCH handler):
**Before**:
```typescript
      const costs = await calculateBOMUnitCosts([activeBom.id])
```
**After**:
```typescript
      const costs = await calculateBOMUnitCosts([activeBom.id], selectedCompanyId!)
```

**Validation**: `npx tsc --noEmit`
**Completion Criteria**:
- [ ] Both calculateBOMUnitCosts calls include companyId

### Subtask 2.7: Update /api/export/skus/route.ts
**File**: `/home/pbrown/SkuInventory/src/app/api/export/skus/route.ts`
**Instructions**:
1. Update call to `calculateBOMUnitCost` to pass `selectedCompanyId`

**Line 62**:
**Before**:
```typescript
          bomCost = await calculateBOMUnitCost(activeBom.id).then((c) => c?.toString() ?? null)
```
**After**:
```typescript
          bomCost = await calculateBOMUnitCost(activeBom.id, selectedCompanyId!).then((c) => c?.toString() ?? null)
```

**Validation**: `npx tsc --noEmit`
**Completion Criteria**:
- [ ] calculateBOMUnitCost called with companyId

### Subtask 2.8: Update /api/dashboard/route.ts
**File**: `/home/pbrown/SkuInventory/src/app/api/dashboard/route.ts`
**Instructions**:
1. Update call to `calculateBOMUnitCosts` to pass `selectedCompanyId`

**Line 170**:
**Before**:
```typescript
      activeBomIds.length > 0 ? calculateBOMUnitCosts(activeBomIds) : new Map<string, number>(),
```
**After**:
```typescript
      activeBomIds.length > 0 ? calculateBOMUnitCosts(activeBomIds, selectedCompanyId!) : new Map<string, number>(),
```

**Validation**: `npx tsc --noEmit`
**Completion Criteria**:
- [ ] calculateBOMUnitCosts called with companyId

### Subtask 2.9: Update /api/import/skus/route.ts
**File**: `/home/pbrown/SkuInventory/src/app/api/import/skus/route.ts`
**Instructions**:
1. Update call to `createBOMVersion` to include `companyId` in params

**Lines 267-275**:
**Before**:
```typescript
              await createBOMVersion({
                skuId: newSku.id,
                versionName: 'v1-import',
                effectiveStartDate: new Date(),
                isActive: true,
                notes: 'Created via CSV import',
                lines: bomLines,
                createdById: session.user.id,
              })
```
**After**:
```typescript
              await createBOMVersion({
                skuId: newSku.id,
                companyId,
                versionName: 'v1-import',
                effectiveStartDate: new Date(),
                isActive: true,
                notes: 'Created via CSV import',
                lines: bomLines,
                createdById: session.user.id,
              })
```

**Note**: `companyId` is already in scope from the SKU creation logic above.

**Validation**: `npx tsc --noEmit`
**Completion Criteria**:
- [ ] createBOMVersion called with companyId

---

## Phase 3: Update Unit Tests

### Subtask 3.1: Update bom-calculations.test.ts
**File**: `/home/pbrown/SkuInventory/tests/unit/bom-calculations.test.ts`
**Instructions**:
1. Update all test calls to use new signatures with companyId

**Add mock companyId constant**:
```typescript
const TEST_COMPANY_ID = 'company-1'
```

**Update calculateBOMUnitCost tests** (line 56):
**Before**:
```typescript
    const result = await calculateBOMUnitCost('bom-1')
```
**After**:
```typescript
    const result = await calculateBOMUnitCost('bom-1', TEST_COMPANY_ID)
```

Apply similar changes to all other test calls:
- Line 65: `calculateBOMUnitCost('empty-bom', TEST_COMPANY_ID)`
- Line 81: `calculateBOMUnitCost('bom-1', TEST_COMPANY_ID)`
- Line 99: `calculateBOMUnitCost('bom-1', TEST_COMPANY_ID)`
- Line 115: `calculateBOMUnitCost('bom-1', TEST_COMPANY_ID)`

**Update calculateBOMUnitCosts tests** (line 145):
**Before**:
```typescript
    const result = await calculateBOMUnitCosts(['bom-1', 'bom-2', 'bom-3'])
```
**After**:
```typescript
    const result = await calculateBOMUnitCosts(['bom-1', 'bom-2', 'bom-3'], TEST_COMPANY_ID)
```

Apply similar changes to remaining calculateBOMUnitCosts test calls.

**Validation**: `npm test -- --filter="bom"`
**Completion Criteria**:
- [ ] All test signatures updated
- [ ] Tests pass with new signatures

---

## Phase 4: Final Verification

### Subtask 4.1: Build Verification
**Instructions**:
```bash
npm run build
npx tsc --noEmit
npm run lint
```

**Completion Criteria**:
- [ ] Build completes without errors
- [ ] TypeScript compiles without errors
- [ ] No lint warnings

### Subtask 4.2: Test Suite
**Instructions**:
```bash
npm test -- --filter="bom"
npm test -- --filter="tenant"
```

**Completion Criteria**:
- [ ] BOM unit tests pass
- [ ] Tenant scoping tests pass (if any affected)

---

## Summary of Deliverables

**Files Modified**: 12 total
- `/home/pbrown/SkuInventory/src/services/bom.ts` (10 function updates)
- `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/activate/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/clone/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/skus/[id]/bom-versions/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/skus/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/skus/[id]/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/export/skus/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/dashboard/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/import/skus/route.ts`
- `/home/pbrown/SkuInventory/tests/unit/bom-calculations.test.ts`

**Files NOT Modified** (already properly enforced or not applicable):
- `chatbot-queries.ts` - Already passes companyId correctly to functions that have it

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 -> Phase 2 -> Phase 3 -> Phase 4)
2. Run `npx tsc --noEmit` after each subtask to catch errors early
3. The BOM service file should be updated completely before moving to API routes
4. Use the non-null assertion (`!`) on `selectedCompanyId` since API routes already validate session

---

## Test Strategy Note

- Use Vitest for unit tests: `npm test -- --filter="bom"`
- The existing `calculateMaxBuildableUnits` tests already mock companyId, so those should continue to work
- No E2E tests should be affected as the API contract (request/response) remains the same

---

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 10m |
| **Total** | **30m** |
