# Scout Report: Use Claude Code Headless Mode for User Submitted Bugs and Features

## Request Analysis
**Type**: Enhancement
**Source**: GitHub Issue #34
**Priority**: Medium

## Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="feedback|claude"` for affected modules

## Issue Validation
**Status**: Valid
**Recent Changes**:
- d5b4a5d (Dec 2): Fix feedback button and agent improvements
- cc9ceff (Dec 2): Initial feedback system with AI-powered clarification
- Security fix #26: Replaced shell exec with Octokit REST API

**Issue Context**: The feedback system was just implemented in issue #1. Issue #26 addressed a shell injection vulnerability by switching from `gh` CLI to Octokit REST API. Now issue #34 requests using Claude Code headless mode to improve issue quality before GitHub submission.

## Current State

### Existing Components

**API Routes**: (2 files)
- /home/pbrown/SkuInventory/src/app/api/feedback/route.ts - POST endpoint for feedback submission
- /home/pbrown/SkuInventory/src/app/api/feedback/clarify/route.ts - POST endpoint for AI clarification

**Frontend Components**: (2 files)
- /home/pbrown/SkuInventory/src/components/features/FeedbackButton.tsx - Button to open dialog
- /home/pbrown/SkuInventory/src/components/features/FeedbackDialog.tsx - Multi-step dialog UI

**Backend Services**: (1 file)
- /home/pbrown/SkuInventory/src/lib/claude.ts - Anthropic API integration for question generation

**Types**: (1 file)
- /home/pbrown/SkuInventory/src/types/feedback.ts - Zod schemas and TypeScript types

**Database**: No Prisma models (feedback is not persisted, goes directly to GitHub)

**Current Flow**:
1. User clicks feedback button in header/sidebar
2. Selects bug or feature type
3. Provides description (10-2000 chars)
4. AI generates 3 clarifying questions via Anthropic API
5. User answers questions
6. System formats issue body using static templates (formatBugBody/formatFeatureBody)
7. Creates GitHub issue via Octokit REST API
8. Returns issue URL and number to user

**Template Formats**:
- Bug: formatBugBody() in route.ts lines 34-74 - includes error details, reproduction steps, verification checkpoint
- Feature: formatFeatureBody() in route.ts lines 76-145 - includes user stories, requirements, technical context

**Dependencies Installed**:
- @octokit/rest@22.0.1 - GitHub API client
- @anthropic-ai/sdk@0.71.0 - Claude API client

**Environment Variables Required**:
- GITHUB_TOKEN - Already configured and working
- ANTHROPIC_API_KEY - Already configured and working
- CLAUDECODE=1 - Environment variable exists

**Claude Code CLI**:
- Path: /home/pbrown/.local/bin/claude
- Version: 2.0.56
- Type: Native binary (ELF 64-bit)
- Slash commands available: /bug and /feature in .claude/commands/

## Dependencies & Blockers

### Technical Dependencies
1. **Node.js child_process** - Available (Node v20.19.5 installed)
2. **Claude Code CLI** - Available and verified (claude 2.0.56)
3. **Slash commands** - Already exist (/bug and /feature)
4. **Environment variables** - GITHUB_TOKEN and ANTHROPIC_API_KEY already configured

### Security Concerns (CRITICAL)
1. **Shell Injection Risk** - Issue #26 was JUST fixed to prevent command injection
   - Current implementation uses Octokit REST API (safe)
   - Proposed implementation would use child_process.spawn() to execute Claude Code CLI
   - MUST use spawn() with array arguments, NOT exec() with string commands
   - User input MUST be passed as arguments, not interpolated into command strings

2. **Permission Model** - Issue suggests `--dangerously-skip-permissions` flag
   - This flag bypasses ALL permission checks
   - Creates security risk if user input can influence file operations
   - Better alternative: Use --allowed-tools with specific restrictions

3. **Server-Side Process Execution** - Running Claude Code in Next.js API route
   - Claude Code is designed for interactive use, not server automation
   - Each execution spawns a new Claude session (API costs)
   - No process pooling or reuse
   - Potential for resource exhaustion under load
   - Timeout handling required (Claude Code can run indefinitely)

4. **API Key Exposure** - Claude Code needs ANTHROPIC_API_KEY
   - Already available in environment (used by current clarification API)
   - But each headless execution creates separate API session
   - Cost implications: 2x API usage (clarification + headless processing)

### Architectural Concerns
1. **Next.js Route Handlers** - API routes have execution time limits
   - Vercel: 10 second timeout (hobby), 60 seconds (pro)
   - Self-hosted: Configurable, but long-running requests are anti-pattern
   - Claude Code execution time unknown for this use case
   - Would need streaming response or async processing

2. **Rate Limiting** - Current implementation has simple in-memory rate limiting
   - 5 submissions per user per hour
   - No protection against Claude Code execution abuse
   - Need separate rate limit for headless processing

3. **Error Handling** - Claude Code can fail in many ways
   - CLI errors (binary issues)
   - API errors (quota, network)
   - Tool errors (file access, git operations)
   - Timeout errors (long-running execution)
   - Need comprehensive error handling with fallback to current format

4. **Testing** - Headless mode integration difficult to test
   - Would need mocked Claude Code CLI for unit tests
   - Integration tests would consume API quota
   - E2E tests would be expensive and slow

**Can Proceed?**: YES WITH FIXES - Major security and architectural concerns must be addressed

## Complexity Assessment
**Complexity**: Moderate to Complex
**Effort**: 8-12 hours
**Risk**: High (Security + Architecture + Cost)

**Breakdown**:
- Security implementation: 2-3 hours (spawn() setup, input sanitization, permission model)
- Process management: 2-3 hours (timeout, error handling, streaming)
- Integration: 2-3 hours (wire into existing feedback flow)
- Testing: 2-3 hours (unit, integration, E2E mocking)

**Risk Factors**:
1. **Security**: Shell injection vulnerability if not implemented correctly (High)
2. **Performance**: Claude Code execution time may exceed route timeout (Medium)
3. **Cost**: Double API usage for every feedback submission (Medium)
4. **Reliability**: Multiple failure points (CLI, API, network) (Medium)
5. **Testing**: Difficult to test without consuming API quota (Low)

## Patterns to Follow

**Primary Reference**: /home/pbrown/SkuInventory/src/app/api/feedback/route.ts (lines 147-221)
- Pattern: Next.js API route with error handling
- Use: Structure for new headless processing endpoint
- Key elements: Session auth, rate limiting, try/catch, Octokit integration

**Secondary Reference**: /home/pbrown/SkuInventory/src/lib/claude.ts
- Pattern: Anthropic API client initialization and error handling
- Use: Lazy client initialization, fallback on error
- Key elements: Environment variable check, graceful degradation

**Process Execution Pattern**: MUST use Node.js child_process.spawn()
```typescript
import { spawn } from 'child_process'

// SAFE - arguments as array
const claude = spawn('claude', [
  '-p',
  `/bug ${userDescription}`, // Still needs validation but safer
  '--dangerously-skip-permissions'
])

// UNSAFE - DO NOT USE
const { exec } = require('child_process')
exec(`claude -p "/bug ${userDescription}"`) // VULNERABLE
```

**Security Pattern**: Input sanitization before passing to spawn()
```typescript
// Validate and sanitize user input
const sanitizedInput = userInput
  .replace(/[\$`]/g, '') // Remove shell metacharacters
  .slice(0, 2000) // Enforce length limit
```

**Slash Command Reference**: Already exist in .claude/commands/
- /home/pbrown/SkuInventory/.claude/commands/bug.md (lines 132-174)
- /home/pbrown/SkuInventory/.claude/commands/feature.md (lines 175-247)
- These commands use `gh issue create` internally
- Would need modification to return issue data instead of creating directly

## Files to Create/Modify

### Files to Create (2-3 files)
1. **/home/pbrown/SkuInventory/src/lib/claude-headless.ts**
   - Purpose: Wrapper for executing Claude Code CLI in headless mode
   - Functions: executeClaudeHeadless(), parseClaudeOutput(), sanitizeInput()
   - Responsibilities: Process management, timeout handling, error handling

2. **/home/pbrown/SkuInventory/src/app/api/feedback/process/route.ts** (Optional)
   - Purpose: Separate endpoint for headless processing
   - Use case: Longer timeout, different rate limit
   - Returns: Processed issue body instead of creating issue

3. **/home/pbrown/SkuInventory/tests/integration/feedback-headless.test.ts**
   - Purpose: Integration tests with mocked CLI
   - Tests: Process execution, timeout, error handling, fallback

### Files to Modify (4 files)
1. **/home/pbrown/SkuInventory/src/app/api/feedback/route.ts**
   - Changes: Replace formatBugBody/formatFeatureBody with headless processing
   - Add: Timeout handling, fallback to current format on error
   - Lines affected: 34-145 (template functions), 165-195 (issue creation)

2. **/home/pbrown/SkuInventory/src/types/feedback.ts**
   - Changes: Add types for headless processing
   - New types: ClaudeHeadlessInput, ClaudeHeadlessOutput, ProcessingStrategy

3. **/home/pbrown/SkuInventory/package.json** (Maybe)
   - Changes: Add @types/node if not already present for child_process types

4. **/home/pbrown/SkuInventory/.env.example**
   - Changes: Document CLAUDE_CODE_PATH if CLI path needs to be configurable

## Final Sweep Results

**Services Search**: No existing child_process usage in src/services/
**API Routes**: 30 route.ts files total, 1 using Octokit (feedback)
**Type Definitions**: 1 feedback.ts type file
**Components**: 2 components using feedback types
**Test Files**: No existing tests for feedback (E2E only via Playwright)

**All Affected Files** (comprehensive list):
- /home/pbrown/SkuInventory/src/app/api/feedback/route.ts - Main integration point
- /home/pbrown/SkuInventory/src/lib/claude.ts - May need extension or reference
- /home/pbrown/SkuInventory/src/types/feedback.ts - Type additions
- /home/pbrown/SkuInventory/.claude/commands/bug.md - May need output format changes
- /home/pbrown/SkuInventory/.claude/commands/feature.md - May need output format changes
- /home/pbrown/SkuInventory/package.json - Possible @types/node addition
- /home/pbrown/SkuInventory/.env.example - Documentation of CLAUDE_CODE_PATH

**No services affected** - Feedback doesn't use service layer
**No Prisma models affected** - Feedback goes directly to GitHub
**No UI components need changes** - FeedbackDialog.tsx remains unchanged

## Ripple Effect Analysis

**Function Chain**: POST /api/feedback
1. Direct callers: FeedbackDialog.tsx (line 103)
2. No wrapper functions - single call site
3. Changes are contained to API route

**Type Changes**: SubmitFeedbackResponse remains unchanged
- No ripple effect to frontend
- UI continues to receive issueUrl and issueNumber

**Slash Command Integration**: /bug and /feature commands
- Currently use: `gh issue create` to create issues directly
- Proposed: Use same commands but capture output instead of creating
- Problem: Commands expect to create issues themselves
- Solution options:
  a. Modify slash commands to return formatted body only
  b. Let slash commands create issue, parse the output for URL
  c. Create new slash commands: /bug-format and /feature-format

**TOTAL FILES AFFECTED**: 4-7 files (depending on approach)

## Acceptance Criteria

- [ ] User feedback triggers Claude Code headless processing
- [ ] Claude Code executes /bug or /feature slash command
- [ ] Generated issue body is higher quality than current templates
- [ ] Process completes within Next.js route timeout (< 30 seconds)
- [ ] Falls back to current format if headless processing fails
- [ ] No shell injection vulnerabilities introduced
- [ ] Input sanitization prevents command injection
- [ ] Rate limiting prevents abuse of headless processing
- [ ] Error handling covers all failure modes (CLI, API, timeout)
- [ ] Tests verify security and functionality
- [ ] API costs are acceptable (discussed with user)
- [ ] Build completes without errors
- [ ] All existing tests still pass

## Handoff to Plan Agent

**Summary**:
Issue #34 requests integrating Claude Code headless mode to improve the quality of GitHub issues created from user feedback. The current implementation uses static templates (formatBugBody/formatFeatureBody) to format issue bodies. The proposed enhancement would execute Claude Code CLI with /bug or /feature slash commands to generate more comprehensive and context-aware issue bodies.

This is moderately complex with HIGH security risk because we are re-introducing process execution that was JUST removed in issue #26 to fix a shell injection vulnerability. Implementation must use child_process.spawn() with array arguments and strict input sanitization.

**Key Points**:
1. **Security First**: Issue #26 was closed 2 days ago fixing shell injection. DO NOT reintroduce vulnerability.
2. **Use spawn(), not exec()**: Pass arguments as array, never interpolate user input into command strings.
3. **Permission Model**: Avoid --dangerously-skip-permissions if possible; use --allowed-tools with restrictions.
4. **Timeout Handling**: Claude Code can run indefinitely; must have timeout < route timeout.
5. **Fallback Required**: Must gracefully degrade to current templates if headless processing fails.
6. **Cost Implications**: Currently 1 API call per feedback (clarification). This adds 1 more (headless processing).
7. **Slash Command Integration**: /bug and /feature commands exist but expect to create issues themselves.
8. **Rate Limiting**: Needs separate/stricter limit for headless processing to prevent abuse.

**Suggested Phases**:

**Phase 1: Security & Infrastructure** (3-4 hours)
- Create /home/pbrown/SkuInventory/src/lib/claude-headless.ts
- Implement spawn() wrapper with input sanitization
- Add timeout handling (30 second max)
- Add comprehensive error handling
- Write unit tests with mocked spawn()

**Phase 2: Integration** (2-3 hours)
- Modify /home/pbrown/SkuInventory/src/app/api/feedback/route.ts
- Replace formatBugBody/formatFeatureBody with headless processing
- Implement fallback to current templates on error
- Add types to /home/pbrown/SkuInventory/src/types/feedback.ts

**Phase 3: Slash Command Adaptation** (2-3 hours)
- Decide: Modify existing /bug and /feature OR create new variants
- Ensure commands return formatted body without creating issue
- Update command templates if needed

**Phase 4: Testing & Validation** (2-3 hours)
- Integration tests with mocked Claude Code CLI
- Security tests: verify injection prevention
- E2E tests (may skip to avoid API costs)
- Manual testing with real Claude Code execution

**Alternative Approach (Lower Risk)**:
Instead of executing Claude Code CLI, consider:
- Using Anthropic API directly with better prompts
- Building issue template generator as TypeScript function
- Avoiding child process execution entirely

This would eliminate security risks, timeout issues, and CLI dependencies while achieving similar quality improvements.

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Issue Parsing | 2m |
| Codebase Exploration | 8m |
| Pattern Identification | 5m |
| Security Analysis | 7m |
| Report Writing | 12m |
| **Total** | **34m** |
