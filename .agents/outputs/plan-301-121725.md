# Implementation Plan
**Generated**: 2025-12-17T16:00:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: Issue #301 - Enforce Mandatory Component CompanyId in Schema
**Estimated Build Time**: 2-3 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Enhancement
**Source**: GitHub Issue #301
**Priority**: Medium

### Task Classification
**Category**: REFACTORING
**Test Strategy**: TARGETED
**Suggested Filter**: `--testPathPattern="component|forecast|inventory"`

### Issue Validation
**Status**: Valid
**Recent Changes**: None affecting this schema field

### Current State Assessment

#### Database State
- **Total Components**: 25
- **Components with companyId**: 25
- **Components with NULL companyId**: 0 (SAFE TO PROCEED)

#### Current Schema (prisma/schema.prisma lines 188-220)
```prisma
model Component {
  id            String   @id @default(uuid())
  brandId       String
  brand         Brand    @relation(fields: [brandId], references: [id])
  companyId     String?                                    // <-- ISSUE: Optional
  company       Company? @relation("CompanyComponents", fields: [companyId], references: [id])
  // ... other fields

  @@index([companyId, isActive])
}
```

#### Database Foreign Key Constraint
```sql
"Component_companyId_fkey" FOREIGN KEY ("companyId")
  REFERENCES "Company"(id)
  ON UPDATE CASCADE
  ON DELETE SET NULL     -- <-- Will need to change to RESTRICT
```

#### Files with Optional companyId Handling
1. `src/services/forecast.ts:419` - `!component.companyId` null check
2. `scripts/populate-inventory-balances.ts:59` - `!component.companyId` skip logic
3. `scripts/populate-inventory-balances.ts:245` - `!balance.component.companyId` skip logic

### Dependencies & Blockers
1. No blockers - all existing Components have companyId set
2. SKU model has same pattern (optional companyId) - out of scope for this issue

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Simple
**Effort**: 2-3 hours
**Risk**: Low (no data migration needed, no nulls exist)

### Patterns Identified
**Primary**: Other mandatory relations in schema (e.g., `brandId` on Component)
**Secondary**: Location model companyId (mandatory) at schema line 52

### Ripple Effect Analysis
**Files Identified**: 4 files need changes

| File | Change Type | Reason |
|------|-------------|--------|
| `prisma/schema.prisma` | Schema | Make companyId mandatory |
| `src/services/forecast.ts` | Code cleanup | Remove unnecessary null check |
| `scripts/populate-inventory-balances.ts` | Code cleanup | Remove 2 unnecessary null checks |
| Migration file | New | Alter column to NOT NULL |

---

## Executive Summary

This task makes `Component.companyId` mandatory in the Prisma schema, enforcing database-level tenant scoping. Since all existing components already have companyId populated (0 nulls), this is a safe schema tightening. The migration will alter the column to NOT NULL and change the FK constraint from `ON DELETE SET NULL` to `ON DELETE RESTRICT`. Application code with unnecessary null checks will be cleaned up.

---

## Phase 1: Database Schema Change

### Subtask 1.1: Update Prisma Schema
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Pattern**: Follow `brandId` field pattern (line 190) which is mandatory
**Lines**: 192-193

**Instructions**:
1. Change `companyId` from optional (`String?`) to required (`String`)
2. Change `company` relation from optional (`Company?`) to required (`Company`)

**Current Code (lines 192-193)**:
```prisma
  companyId     String?
  company       Company? @relation("CompanyComponents", fields: [companyId], references: [id])
```

**New Code**:
```prisma
  companyId     String
  company       Company  @relation("CompanyComponents", fields: [companyId], references: [id])
```

**Completion Criteria**:
- [ ] Schema syntax is valid
- [ ] TypeScript types will be regenerated after migration

### Subtask 1.2: Generate and Apply Migration
**Command**: Run in `/home/pbrown/SkuInventory`

**Instructions**:
1. Create migration:
   ```bash
   npx prisma migrate dev --name enforce_component_company_id
   ```
2. This will:
   - Alter `companyId` column to NOT NULL
   - Update FK constraint to `ON DELETE RESTRICT` (Prisma default for required relations)
3. Verify migration SQL contains:
   - `ALTER TABLE "Component" ALTER COLUMN "companyId" SET NOT NULL`
   - FK constraint recreation with `ON DELETE RESTRICT`

**Completion Criteria**:
- [ ] Migration file created in `prisma/migrations/`
- [ ] Migration applies successfully to test database
- [ ] `npx prisma generate` regenerates client

### Subtask 1.3: Verify Database State
**Command**: Run against test database

```bash
docker exec inventory-db-test psql -U inventory_test -d inventory_test -c "\d+ \"Component\"" | grep companyId
```

**Expected Output**:
```
 companyId     | text                           |           | not null |
```

**Also verify FK constraint**:
```bash
docker exec inventory-db-test psql -U inventory_test -d inventory_test -c "SELECT conname, confdeltype FROM pg_constraint WHERE conname = 'Component_companyId_fkey';"
```

**Expected**: `confdeltype = 'r'` (RESTRICT) instead of `'n'` (SET NULL)

**Completion Criteria**:
- [ ] Column shows `not null`
- [ ] FK constraint uses RESTRICT delete action

---

## Phase 2: Code Cleanup - Remove Null Checks

### Subtask 2.1: Clean Up Forecast Service
**File**: `/home/pbrown/SkuInventory/src/services/forecast.ts`
**Line**: 419

**Current Code**:
```typescript
if (!component || !component.isActive || !component.companyId) {
  return null
}
```

**New Code**:
```typescript
if (!component || !component.isActive) {
  return null
}
```

**Rationale**: With companyId now mandatory, TypeScript will infer it's always a string, making the null check unnecessary and potentially misleading.

**Completion Criteria**:
- [ ] Null check removed
- [ ] TypeScript compiles without errors (`npx tsc --noEmit`)

### Subtask 2.2: Clean Up Populate Inventory Balances Script
**File**: `/home/pbrown/SkuInventory/scripts/populate-inventory-balances.ts`
**Lines**: 59, 245

**Current Code (line 59)**:
```typescript
if (!component.companyId) continue
```

**Action**: Remove this line entirely (the loop will naturally process all components now)

**Current Code (line 245)**:
```typescript
if (!balance.component.companyId) continue
```

**Action**: Remove this line entirely

**Completion Criteria**:
- [ ] Both null checks removed
- [ ] Script still compiles (`npx tsc --noEmit scripts/populate-inventory-balances.ts`)

---

## Phase 3: Validation

### Subtask 3.1: TypeScript Compilation Check
**Command**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] No TypeScript errors
- [ ] No warnings about potentially undefined companyId

### Subtask 3.2: Build Check
**Command**:
```bash
npm run build
```

**Completion Criteria**:
- [ ] Build succeeds without errors

### Subtask 3.3: Run Targeted Tests
**Command**:
```bash
npm test -- --testPathPattern="component|forecast|inventory" --passWithNoTests
```

**Completion Criteria**:
- [ ] All tests pass
- [ ] No regressions in component/forecast functionality

### Subtask 3.4: Lint Check
**Command**:
```bash
npm run lint
```

**Completion Criteria**:
- [ ] No lint errors

---

## Summary of Deliverables

**Files Created**: 1
- `prisma/migrations/[timestamp]_enforce_component_company_id/migration.sql`

**Files Modified**: 3
- `prisma/schema.prisma` - Make companyId mandatory (2 line changes)
- `src/services/forecast.ts` - Remove null check (1 line change)
- `scripts/populate-inventory-balances.ts` - Remove null checks (2 line deletions)

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 before Phase 2)
2. Phase 1 (database) must complete before Phase 2 (code cleanup) because TypeScript types depend on regenerated Prisma client
3. Test completion criteria before moving to next subtask
4. Follow reference patterns exactly

## Test Strategy Note
- Use `npm test` with pattern filter for targeted testing
- Full test suite not required (TARGETED strategy)
- Focus on component and forecast related tests

## Risk Assessment
| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| Migration fails | Very Low | High | Verified 0 nulls exist |
| Breaking tests | Low | Medium | Targeted test run will catch |
| Type errors | Low | Low | TypeScript strict mode will catch |

## Related Issues
- SKU model has same pattern (optional companyId) - consider follow-up issue
- No existing tests specifically verify companyId nullability

## Performance Metrics
| Phase | Estimated Duration |
|-------|----------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 10m |
| **Total** | **30m** |

---

## Appendix: Database Verification Queries

**Pre-migration check** (already run):
```sql
SELECT COUNT(*) as total,
       COUNT("companyId") as with_company,
       COUNT(*) - COUNT("companyId") as null_company
FROM "Component";
-- Result: 25, 25, 0
```

**Post-migration verification**:
```sql
-- Verify NOT NULL constraint
SELECT column_name, is_nullable
FROM information_schema.columns
WHERE table_name = 'Component' AND column_name = 'companyId';
-- Expected: is_nullable = 'NO'
```
