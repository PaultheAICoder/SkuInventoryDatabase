# Implementation Plan
**Generated**: 2025-12-03T10:45:00Z
**Task ID**: Issue #47 - TypeError: t.then is not a function
**Estimated Build Time**: 30 minutes
**Complexity**: Low

## Executive Summary
Fix a critical bug in the "Create first BOM version" button that throws `TypeError: t.then is not a function`. The root cause is a client component (`'use client'`) incorrectly using the async `params` prop pattern (server component pattern) instead of the `useParams()` hook (client component pattern). This is a single-file fix following an established codebase pattern used in 6+ other pages.

## Ripple Effect Verification

**Scout's Analysis Confirmed**: Single file affected
- Searched for `params.then` pattern: Only 1 file uses it (`/skus/[id]/bom/new/page.tsx`)
- Searched for `params: Promise` in dashboard: Only 1 file has it (`/skus/[id]/bom/new/page.tsx`)
- All other client components with dynamic params correctly use `useParams()` hook
- No service, API, or type changes needed - pure UI fix

**Files referencing the affected page (read-only context)**:
- `/home/pbrown/SkuInventory/src/components/features/BOMVersionList.tsx` (lines 103, 121) - Triggers navigation via `router.push(`/skus/${skuId}/bom/new`)`

## Phase 0: Code Untangling
**Not Required** - The bug is straightforward with clear root cause identified.

## Phase 1: Fix Client Component Params Pattern

### Subtask 1.1: Update New BOM Page to Use useParams() Hook

**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/bom/new/page.tsx`

**Pattern Reference**: `/home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/edit/page.tsx` (lines 5, 11-13)

**Root Cause**:
```typescript
// CURRENT (BROKEN) - Line 9-11, 20-22
interface NewBOMPageProps {
  params: Promise<{ id: string }>  // Server component pattern - WRONG
}
export default function NewBOMPage({ params }: NewBOMPageProps) {
  // ...
  useEffect(() => {
    params.then((p) => setSkuId(p.id))  // ERROR: params is NOT a Promise in client components
  }, [params])
```

**Why It Fails**: In Next.js 14 App Router:
- Server components: `params` is `Promise<{ id: string }>` (awaited)
- Client components: `params` is accessed via `useParams()` hook (synchronous)

**Instructions**:

1. **Add `useParams` import** (line 4):
   ```typescript
   // BEFORE
   import { useRouter } from 'next/navigation'

   // AFTER
   import { useRouter, useParams } from 'next/navigation'
   ```

2. **Remove the interface** (lines 9-11):
   ```typescript
   // DELETE THESE LINES
   interface NewBOMPageProps {
     params: Promise<{ id: string }>
   }
   ```

3. **Change function signature** (line 13):
   ```typescript
   // BEFORE
   export default function NewBOMPage({ params }: NewBOMPageProps) {

   // AFTER
   export default function NewBOMPage() {
   ```

4. **Add useParams hook and get skuId directly** (after line 14):
   ```typescript
   // ADD AFTER: const router = useRouter()
   const params = useParams()
   const skuId = params.id as string
   ```

5. **Remove the nullable skuId state** (line 15):
   ```typescript
   // DELETE THIS LINE
   const [skuId, setSkuId] = useState<string | null>(null)
   ```

6. **Remove the first useEffect that awaits params** (lines 20-22):
   ```typescript
   // DELETE THIS ENTIRE BLOCK
   useEffect(() => {
     params.then((p) => setSkuId(p.id))
   }, [params])
   ```

7. **Update the second useEffect** - remove the `if (!skuId) return` guard (line 25):
   ```typescript
   // BEFORE
   useEffect(() => {
     if (!skuId) return

     async function fetchSKU() {

   // AFTER
   useEffect(() => {
     async function fetchSKU() {
   ```

8. **Update the error condition** (line 59):
   ```typescript
   // BEFORE
   if (error || !skuId) {

   // AFTER
   if (error) {
   ```

**Expected Final Code** (key sections):
```typescript
'use client'

import { useState, useEffect } from 'react'
import { useRouter, useParams } from 'next/navigation'
import { Button } from '@/components/ui/button'
import { ArrowLeft } from 'lucide-react'
import { BOMVersionForm } from '@/components/features/BOMVersionForm'

export default function NewBOMPage() {
  const router = useRouter()
  const params = useParams()
  const skuId = params.id as string
  const [skuName, setSkuName] = useState<string>('')
  const [isLoading, setIsLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  useEffect(() => {
    async function fetchSKU() {
      try {
        const res = await fetch(`/api/skus/${skuId}`)
        if (!res.ok) {
          throw new Error('SKU not found')
        }
        const data = await res.json()
        setSkuName(data.data.name)
      } catch (err) {
        setError(err instanceof Error ? err.message : 'Failed to load SKU')
      } finally {
        setIsLoading(false)
      }
    }

    fetchSKU()
  }, [skuId])

  // ... loading state unchanged ...

  if (error) {  // Removed: || !skuId
    // ... error state unchanged ...
  }

  // ... return JSX unchanged ...
}
```

**Validation Commands**:
```bash
# TypeScript compilation check
npx tsc --noEmit

# Lint check
npm run lint

# Build check (required per CLAUDE.md)
npm run build
```

**Completion Criteria**:
- [ ] `useParams` imported from `'next/navigation'`
- [ ] `NewBOMPageProps` interface removed
- [ ] Function signature has no params prop
- [ ] `useParams()` hook called at top of component
- [ ] `skuId` obtained directly from `params.id as string`
- [ ] `useState<string | null>(null)` for skuId removed
- [ ] First `useEffect` with `params.then()` removed
- [ ] Second `useEffect` no longer has `if (!skuId) return` guard
- [ ] Error condition simplified to `if (error)`
- [ ] `npx tsc --noEmit` passes with no errors
- [ ] `npm run lint` passes with no errors/warnings
- [ ] `npm run build` completes successfully

## Phase 2: Manual Verification

### Subtask 2.1: Test the Fix End-to-End

**Instructions**:
1. Ensure dev server is running (`npm run dev` on port 4545)
2. Navigate to SKUs page: `http://172.16.20.50:4545/skus`
3. Create a new SKU (if none exist without BOM):
   - Click "New SKU"
   - Fill required fields: Name, SKU Code
   - Save
4. On the SKU detail page, click "Create first BOM version" button
5. Verify:
   - Page loads at `/skus/[id]/bom/new` without errors
   - SKU name displays in the header ("Define bill of materials for [SKU Name]")
   - Form renders correctly
   - No console errors in browser DevTools
6. (Optional) Complete the form to create a BOM version and verify it saves

**Completion Criteria**:
- [ ] Button click does not throw TypeError
- [ ] Page navigates to `/skus/[id]/bom/new` successfully
- [ ] SKU name displays correctly in form header
- [ ] BOMVersionForm component renders
- [ ] No console errors in browser DevTools
- [ ] Form can be submitted to create BOM version (end-to-end)

## Phase 3: Run Automated Tests

### Subtask 3.1: Execute Test Suite

**Instructions**:
```bash
# Run existing test suite to ensure no regressions
npm test
```

**Note**: No specific tests exist for this page navigation flow. Consider adding E2E test in future (see Phase 4).

**Completion Criteria**:
- [ ] All existing tests pass
- [ ] No regressions introduced

## Phase 4: (Optional) Add E2E Test for BOM Creation Flow

**Priority**: Low - Recommended for preventing future regressions but not blocking for this fix.

### Subtask 4.1: Create E2E Test

**File**: `/home/pbrown/SkuInventory/tests/e2e/bom-creation.spec.ts` (new file)

**Pattern Reference**: `/home/pbrown/SkuInventory/tests/e2e/full-workflow.spec.ts`

**Instructions**:
If time permits, create a Playwright E2E test that:
1. Creates a new SKU
2. Clicks "Create first BOM version" button
3. Verifies navigation succeeds (no error page)
4. Verifies form loads with SKU name

**Completion Criteria**:
- [ ] Test file created
- [ ] Test passes locally
- [ ] Prevents regression of issue #47

---

## Summary of Deliverables

**Files Modified**: 1
- `/home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/bom/new/page.tsx`

**Files Created**: 0 (optional E2E test in Phase 4)

**Lines Changed**: ~15 lines (removed ~10, modified ~5)

## Handoff to Build Agent

1. **Execute subtasks in exact order** (Phase 1 -> Phase 2 -> Phase 3)
2. **Phase 1 is the only code change** - all other phases are verification
3. **Follow reference patterns exactly** - especially `edit/page.tsx` lines 5, 11-13
4. **Test completion criteria before marking complete**
5. **Do not skip validation commands** - per CLAUDE.md, no errors or warnings allowed

## Acceptance Criteria Summary

From Scout report + plan validation:
- [ ] User can click "Create first BOM version" button without error
- [ ] Page loads successfully at `/skus/[id]/bom/new`
- [ ] SKU name displays correctly in the form header
- [ ] Form is fully functional and can create BOM versions
- [ ] No console errors when navigating to the page
- [ ] Pattern matches other client component pages in codebase
- [ ] TypeScript compilation succeeds with no errors
- [ ] Build succeeds with no errors

## Performance Metrics

| Phase | Duration |
|-------|----------|
| Scout Review | 5m |
| Pattern Research | 3m |
| Ripple Effect Verification | 3m |
| Plan Writing | 10m |
| **Total** | **21m** |

---

AGENT_RETURN: plan-47-120325
