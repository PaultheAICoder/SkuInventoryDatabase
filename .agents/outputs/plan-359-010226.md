# Implementation Plan
**Generated**: 2026-01-02
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #359 - [Rec Engine] Negative keyword suggestions
**Estimated Build Time**: 4-6 hours
**Complexity**: Moderate

## Investigation Summary

### Request Analysis
**Type**: Feature (new recommendation type)
**Source**: GitHub Issue #359
**Priority**: P2 (per issue labels and spec)

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED (affects recommendation modules only)
**Suggested Filter**: `--filter="recommendation"` or None (no existing tests)

### Issue Validation
**Status**: Valid
**Recent Changes**:
- `aa89891` feat(issue #358): add duplicate keyword detection (latest pattern)
- `8b91c67` feat(issue #356): add Monday Dashboard UI
- `41dd25d` feat(issue #355): implement keyword graduation algorithm

### Current State Assessment
- **Existing components**:
  - `src/services/recommendations/generator.ts` - Main orchestrator, explicitly mentions NEGATIVE_KEYWORD as "Future"
  - `src/services/recommendations/keyword-graduation.ts` - Pattern to follow for threshold checking
  - `src/services/recommendations/duplicate-detection.ts` - Pattern to follow for new service file
  - `src/services/recommendations/index.ts` - Barrel file needs export updates
  - `src/components/features/RecommendationCard.tsx` - Already has NEGATIVE_KEYWORD in typeConfig (icon/colors)
  - `src/types/recommendations.ts` - NEGATIVE_KEYWORD already defined in RecommendationType enum
  - `src/lib/recommendation-utils.ts` - DEFAULT_THRESHOLDS already has negative thresholds

- **Database**: Prisma schema already supports NEGATIVE_KEYWORD via RecommendationType enum (Issue #354)
- **API Routes**: `/api/recommendations` already handles all recommendation types generically
- **Types**: NEGATIVE_KEYWORD already defined in types, just needs metadata interface

### Dependencies & Blockers
1. KeywordMetric model exists with required fields: spend, orders, clicks, impressions
2. Thresholds already defined: minSpend: 25, maxOrders: 0, minClicks: 50
3. No migration needed - using existing Prisma enum values

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Moderate
**Effort**: 4-6 hours
**Risk**: Low - follows established patterns, infrastructure already exists

### Patterns Identified
**Primary**: `src/services/recommendations/duplicate-detection.ts` - Follow this structure for:
- Type definitions (NegativeKeywordGroup, NegativeRecommendation)
- Finder function (findNegativeKeywords)
- Rationale builder (buildNegativeRationale)
- Impact calculator (calculateNegativeImpact)
- Recommendation generator (generateNegativeRecommendation)

**Secondary**: `src/services/recommendations/keyword-graduation.ts` - Use for:
- Threshold checking pattern (meetsNegativeThresholds)
- KeywordMetricsAggregate reuse

### Ripple Effect Analysis
**Files Identified**: 5 files require modification

| File | Why Affected |
|------|--------------|
| `src/services/recommendations/negative-suggestions.ts` | NEW - Main implementation |
| `src/services/recommendations/generator.ts` | Add negative keyword finder call |
| `src/services/recommendations/index.ts` | Export new functions/types |
| `src/components/features/RecommendationCard.tsx` | Add NEGATIVE_KEYWORD metadata display |
| (Optional) Test file | Add unit tests if time permits |

---

## Executive Summary

Implement negative keyword suggestion capability for the recommendation engine. This feature identifies keywords with high ad spend ($25+), zero conversions, and significant clicks (50+) that should be added as negative keywords to stop wasting budget. The implementation follows the established duplicate-detection pattern and integrates into the existing recommendation generator. The RecommendationCard already has icon/color config for NEGATIVE_KEYWORD; only metadata display needs to be added.

## Phase 1: Service Layer - Negative Suggestions Service

### Subtask 1.1: Create negative-suggestions.ts Service File
**File**: `src/services/recommendations/negative-suggestions.ts`
**Pattern**: Follow `src/services/recommendations/duplicate-detection.ts` (lines 1-315)

**Instructions**:
1. Create new file with the following structure:
   - Import statements (prisma, types, confidence-scoring)
   - Type definitions:
     - `NegativeKeywordCandidate` interface (keyword, campaignId, campaignName, matchType, totalSpend, totalOrders, totalClicks, totalImpressions, totalSales, dataPoints)
     - `NegativeRecommendation` interface (matching recommendation DB structure)
   - `findNegativeKeywords(brandId: string, lookbackDays: number, thresholds: RequiredThresholds)` function
   - `meetsNegativeThresholds(metrics, thresholds)` function
   - `buildNegativeRationale(keyword, metrics)` function
   - `calculateNegativeImpact(metrics)` function - returns spend savings estimate
   - `generateNegativeRecommendation(metrics, keywordMetricId, campaignId, campaignName)` function

2. Implement `findNegativeKeywords`:
   - Query IntegrationCredential -> AdPortfolios -> Campaigns (like duplicate-detection)
   - Group KeywordMetric by keyword, campaignId, matchType over lookback period
   - Filter where: spend >= minSpend, orders <= maxOrders (0), clicks >= minClicks
   - Return array of NegativeKeywordCandidate

3. Threshold check logic:
   ```typescript
   function meetsNegativeThresholds(
     metrics: NegativeKeywordCandidate,
     thresholds: RequiredThresholds
   ): boolean {
     const { negative } = thresholds
     return (
       metrics.totalSpend >= negative.minSpend &&
       metrics.totalOrders <= negative.maxOrders &&
       metrics.totalClicks >= negative.minClicks
     )
   }
   ```

4. Expected impact calculation:
   - Metric: 'spend'
   - Current: totalSpend
   - Projected: 0 (all spend saved by negating)

5. Metadata structure:
   ```typescript
   metadata: {
     campaigns: string[], // Campaign names where keyword appears
     campaignIds: string[], // Campaign IDs for manual negation
     totalSpend: number,
     totalClicks: number,
     totalImpressions: number,
   }
   ```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] File created with all type definitions
- [ ] findNegativeKeywords function implemented
- [ ] meetsNegativeThresholds function implemented
- [ ] generateNegativeRecommendation function implemented
- [ ] TypeScript compiles without errors

---

## Phase 2: Generator Integration

### Subtask 2.1: Update generator.ts to Include Negative Keywords
**File**: `src/services/recommendations/generator.ts`

**Instructions**:
1. Add imports at top (around line 19-23):
   ```typescript
   import {
     findNegativeKeywords,
     generateNegativeRecommendation,
     type NegativeRecommendation,
   } from './negative-suggestions'
   ```

2. Update `AnyRecommendation` union type (around line 26):
   ```typescript
   type AnyRecommendation = GraduationRecommendation | DuplicateRecommendation | NegativeRecommendation
   ```

3. Update docstrings (lines 5-6, 55-56): Remove "Future: NEGATIVE_KEYWORD" comment, add to implemented list

4. Add negative keyword finding after duplicate detection (around line 129):
   ```typescript
   // Find negative keyword candidates
   const negativeCandidates = await findNegativeKeywords(brandId, lookbackDays, thresholds)

   // Generate recommendations for each negative keyword candidate
   for (const candidate of negativeCandidates) {
     try {
       const latestMetric = await findLatestKeywordMetricId(
         candidate.keyword,
         candidate.campaignId
       )
       const recommendation = generateNegativeRecommendation(
         candidate,
         latestMetric,
         candidate.campaignId,
         candidate.campaignName
       )
       recommendations.push(recommendation)
     } catch (error) {
       const errMsg = error instanceof Error ? error.message : 'Unknown error'
       errors.push(`Error generating negative recommendation for "${candidate.keyword}": ${errMsg}`)
     }
   }
   ```

5. Update `saveRecommendations` function (around line 320-335) to handle NEGATIVE_KEYWORD dedupe:
   - Use keyword + campaignId check (same as KEYWORD_GRADUATION)

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Imports added
- [ ] AnyRecommendation type updated
- [ ] Negative keyword finding loop added
- [ ] saveRecommendations handles NEGATIVE_KEYWORD
- [ ] Build succeeds

---

## Phase 3: Export Updates

### Subtask 3.1: Update index.ts Barrel File
**File**: `src/services/recommendations/index.ts`

**Instructions**:
Add export block for negative-suggestions (after duplicate-detection exports, around line 32):
```typescript
// Negative Keyword Suggestions
export {
  findNegativeKeywords,
  meetsNegativeThresholds,
  generateNegativeRecommendation,
  buildNegativeRationale,
  calculateNegativeImpact,
  type NegativeKeywordCandidate,
  type NegativeRecommendation,
} from './negative-suggestions'
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] All exports added
- [ ] TypeScript compiles

---

## Phase 4: UI Enhancement

### Subtask 4.1: Add NEGATIVE_KEYWORD Metadata Display in RecommendationCard
**File**: `src/components/features/RecommendationCard.tsx`

**Pattern**: Follow DUPLICATE_KEYWORD display (lines 199-219)

**Instructions**:
1. Add helper function to extract negative keyword metadata (around line 40):
   ```typescript
   interface NegativeKeywordMetadata {
     campaigns: string[]
     campaignIds: string[]
     totalSpend: number
     totalClicks: number
     totalImpressions: number
   }

   function getNegativeKeywordMetadata(metadata: Record<string, unknown> | null): NegativeKeywordMetadata | null {
     if (!metadata || !metadata.campaigns) return null
     return metadata as unknown as NegativeKeywordMetadata
   }
   ```

2. Add display block for NEGATIVE_KEYWORD after DUPLICATE_KEYWORD block (around line 219):
   ```tsx
   {/* Negative Keyword: Show spend, clicks, impressions, target campaigns */}
   {recommendation.type === 'NEGATIVE_KEYWORD' && (() => {
     const negMeta = getNegativeKeywordMetadata(recommendation.metadata)
     if (!negMeta) return null
     return (
       <div className="bg-muted/50 p-3 rounded-md">
         <p className="text-sm font-medium mb-2">Keyword Performance:</p>
         <div className="grid grid-cols-3 gap-2 text-sm mb-3">
           <div>
             <span className="text-muted-foreground">Spend:</span>
             <span className="font-medium ml-1">${negMeta.totalSpend.toFixed(2)}</span>
           </div>
           <div>
             <span className="text-muted-foreground">Clicks:</span>
             <span className="font-medium ml-1">{negMeta.totalClicks}</span>
           </div>
           <div>
             <span className="text-muted-foreground">Impressions:</span>
             <span className="font-medium ml-1">{negMeta.totalImpressions.toLocaleString()}</span>
           </div>
         </div>
         <p className="text-sm text-muted-foreground mb-1">
           Add as negative in {negMeta.campaigns.length} campaign{negMeta.campaigns.length !== 1 ? 's' : ''}:
         </p>
         <ul className="text-sm list-disc list-inside text-muted-foreground">
           {negMeta.campaigns.map((name, i) => (
             <li key={negMeta.campaignIds[i]}>{name}</li>
           ))}
         </ul>
       </div>
     )
   })()}
   ```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Helper function added
- [ ] NEGATIVE_KEYWORD display block added
- [ ] Shows spend, clicks, impressions
- [ ] Lists target campaigns for manual negation
- [ ] Build succeeds

---

## Summary of Deliverables

**Files Created**: 1
- `src/services/recommendations/negative-suggestions.ts` (NEW)

**Files Modified**: 3
- `src/services/recommendations/generator.ts`
- `src/services/recommendations/index.ts`
- `src/components/features/RecommendationCard.tsx`

## Handoff to Build Agent
1. Execute subtasks in exact order (1.1 -> 2.1 -> 3.1 -> 4.1)
2. Phase 1 must complete before Phase 2 (dependency)
3. Test completion criteria before next subtask
4. Follow reference patterns exactly (duplicate-detection.ts is the primary pattern)
5. Run `npx tsc --noEmit` after each phase
6. Run `npm run build` after final phase

## Test Strategy Note
- No existing recommendation tests found
- Manual verification via API:
  1. POST `/api/recommendations` to trigger generation
  2. GET `/api/recommendations?type=NEGATIVE_KEYWORD` to view results
  3. Verify RecommendationCard displays correctly in dashboard

## Acceptance Criteria from Issue
- [ ] Keywords meeting negative thresholds flagged (spend >= $25, orders = 0, clicks >= 50)
- [ ] Shows spend, clicks, impressions data
- [ ] Accept logs target campaign(s) for manual negation

## Performance Metrics
| Phase | Estimated Duration |
|-------|-------------------|
| Investigation | 25m |
| Validation | 10m |
| Planning | 15m |
| **Total** | **50m** |
