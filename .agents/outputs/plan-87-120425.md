# Implementation Plan
**Generated**: 2025-12-04T00:45:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #87 - [Parent #24] Add company selector component to sidebar
**Estimated Build Time**: 2-3 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Feature (UI Component)
**Source**: GitHub Issue #87
**Priority**: Medium
**Parent Issue**: #24 - Multi-company user assignments with company selector

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: FAST_PATH
**Suggested Filter**: None required (small isolated component)

### Issue Validation
**Status**: Valid
**Prerequisites Complete**:
- Issue #77: UserCompany join table - COMPLETE
- Issue #82: Session now includes `companies` array and `selectedCompanyId` - COMPLETE (commit 4225b43)

**Recent Changes to Affected Files**:
```
4225b43 feat(issue #82): update session and auth to support multi-company context
```
This confirms the session infrastructure is in place.

### Current State Assessment

**Existing Components**:
- `/home/pbrown/SkuInventory/src/app/(dashboard)/layout.tsx` - Dashboard layout with sidebar (139 lines)
  - Uses `useSession()` hook from next-auth/react
  - Sidebar has header section (lines 66-78) followed by navigation (lines 80-100)
  - Bottom section has user info and sign out button (lines 102-115)
  - Mobile-responsive with hamburger menu toggle

- `/home/pbrown/SkuInventory/src/components/ui/select.tsx` - shadcn/ui Select component (153 lines)
  - Standard Radix UI based Select with all required primitives
  - Exports: Select, SelectGroup, SelectValue, SelectTrigger, SelectContent, SelectItem, etc.

**Session Structure** (from `/home/pbrown/SkuInventory/src/lib/auth.ts`):
```typescript
session.user = {
  id: string
  name: string
  email: string
  role: string
  companyId: string
  companyName: string
  companies: Array<{ id: string; name: string; role?: string }>
  selectedCompanyId: string
  selectedCompanyName: string
}
```

**API Endpoint** (from `/home/pbrown/SkuInventory/src/app/api/companies/switch/route.ts`):
- `POST /api/companies/switch` - Accepts `{ companyId: string }`
- Returns `{ selectedCompanyId, selectedCompanyName, message }`
- Validates user has access to the company
- Logs security event

**Dependencies Verified**:
- `lucide-react@0.555.0` - Building2 icon exists (verified)
- `sonner` - Toast notifications configured in app layout
- `next-auth@4.24.13` - Session update via `useSession().update` supported

### Dependencies & Blockers
None - All prerequisites are complete.

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Simple
**Effort**: 2-3 hours
**Risk**: Low

### Patterns Identified

**Primary Reference**: `/home/pbrown/SkuInventory/src/components/features/DashboardTimeFilter.tsx`
- Simple Select component with `onValueChange` handler
- Shows pattern for Select with value prop and change handler

**Secondary Reference**: `/home/pbrown/SkuInventory/src/components/features/ExportButton.tsx`
- Shows loading state pattern with `useState(false)`
- Shows toast notification pattern with `toast.success()` and `toast.error()`
- Shows async operation handling with try/catch/finally

**Layout Reference**: `/home/pbrown/SkuInventory/src/app/(dashboard)/layout.tsx`
- Lines 66-78: Header section structure to insert after
- Uses existing patterns for sidebar styling

### Ripple Effect Analysis
**Files Identified**: 2

| File | Action | Reason |
|------|--------|--------|
| `/home/pbrown/SkuInventory/src/components/features/CompanySelector.tsx` | CREATE | New component |
| `/home/pbrown/SkuInventory/src/app/(dashboard)/layout.tsx` | MODIFY | Import and render CompanySelector |

**TOTAL FILES AFFECTED**: 2

---

## Executive Summary

Create a `CompanySelector` component that displays a dropdown in the sidebar allowing users with multiple company assignments to switch between them. The component will use the existing shadcn/ui Select component, call the existing `/api/companies/switch` endpoint, update the session via next-auth, and show toast notifications for feedback. Users with only one company will not see the selector.

---

## Phase 1: Create CompanySelector Component

### Subtask 1.1: Create CompanySelector.tsx

**File**: `/home/pbrown/SkuInventory/src/components/features/CompanySelector.tsx` (NEW)

**Pattern References**:
- Select usage: `/home/pbrown/SkuInventory/src/components/features/DashboardTimeFilter.tsx` (lines 34-48)
- Async operations with toast: `/home/pbrown/SkuInventory/src/components/features/ExportButton.tsx` (lines 45-95)

**Instructions**:

1. Create a new file at `/home/pbrown/SkuInventory/src/components/features/CompanySelector.tsx`

2. Implement the component with the following structure:
```tsx
'use client'

import { useSession } from 'next-auth/react'
import { useState } from 'react'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import { Building2 } from 'lucide-react'
import { toast } from 'sonner'

export function CompanySelector() {
  const { data: session, update: updateSession } = useSession()
  const [isLoading, setIsLoading] = useState(false)

  // Don't render if user has 0-1 companies
  if (!session?.user?.companies || session.user.companies.length <= 1) {
    return null
  }

  const handleCompanyChange = async (companyId: string) => {
    // Skip if selecting the same company
    if (companyId === session.user.selectedCompanyId) return

    setIsLoading(true)
    try {
      const res = await fetch('/api/companies/switch', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ companyId }),
      })

      if (!res.ok) {
        const data = await res.json().catch(() => ({}))
        throw new Error(data?.error || 'Failed to switch company')
      }

      const data = await res.json()

      // Update session with new company info
      await updateSession({
        selectedCompanyId: data.data.selectedCompanyId,
        selectedCompanyName: data.data.selectedCompanyName,
      })

      toast.success('Company switched', {
        description: `Switched to ${data.data.selectedCompanyName}`,
      })

      // Note: Data refetching after company switch is handled by sub-issue 6
    } catch (error) {
      console.error('Error switching company:', error)
      toast.error('Failed to switch company', {
        description: error instanceof Error ? error.message : 'Please try again.',
      })
    } finally {
      setIsLoading(false)
    }
  }

  return (
    <div className="px-4 py-2 border-b">
      <Select
        value={session.user.selectedCompanyId}
        onValueChange={handleCompanyChange}
        disabled={isLoading}
      >
        <SelectTrigger className="w-full">
          <Building2 className="h-4 w-4 mr-2 shrink-0" />
          <SelectValue placeholder="Select company" />
        </SelectTrigger>
        <SelectContent>
          {session.user.companies.map((company) => (
            <SelectItem key={company.id} value={company.id}>
              {company.name}
            </SelectItem>
          ))}
        </SelectContent>
      </Select>
    </div>
  )
}
```

3. Key implementation notes:
   - Component returns `null` when user has 0-1 companies (conditional rendering)
   - Uses `useSession()` with destructured `update` function for session refresh
   - Follows existing toast pattern from `ExportButton.tsx`
   - API response structure is `{ data: { selectedCompanyId, selectedCompanyName, message } }` based on the `success()` helper

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] File created at correct path
- [ ] Component exports correctly
- [ ] TypeScript compiles without errors
- [ ] Uses correct session properties (`companies`, `selectedCompanyId`)
- [ ] Calls `/api/companies/switch` endpoint correctly
- [ ] Shows loading state during switch
- [ ] Shows toast notifications for success/error

---

## Phase 2: Integrate CompanySelector into Layout

### Subtask 2.1: Add CompanySelector to Dashboard Layout

**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/layout.tsx`

**Pattern Reference**: Layout already imports `FeedbackButton` from features directory (line 24)

**Instructions**:

1. Add import for CompanySelector after the existing feature imports (around line 24):
```tsx
import { CompanySelector } from '@/components/features/CompanySelector'
```

2. Add CompanySelector to the sidebar, immediately after the header div (after line 78, before the `<nav>` element):
```tsx
        </div>

        <CompanySelector />

        <nav className="flex flex-col gap-1 p-4">
```

The insertion point is:
- After: `</div>` closing tag of the header section (line 78)
- Before: `<nav className="flex flex-col gap-1 p-4">` (line 80)

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Import statement added
- [ ] CompanySelector rendered in correct location (between header and nav)
- [ ] TypeScript compiles without errors
- [ ] Build passes without errors

---

## Phase 3: Verification

### Subtask 3.1: Final Verification

**Instructions**:

1. Run full build verification:
```bash
npm run build
```

2. Run TypeScript check:
```bash
npx tsc --noEmit
```

3. Run linter:
```bash
npm run lint
```

**Completion Criteria**:
- [ ] `npm run build` completes without errors
- [ ] `npx tsc --noEmit` completes without errors
- [ ] `npm run lint` completes without errors/warnings
- [ ] All acceptance criteria from issue met

---

## Summary of Deliverables

**Files Created**: 1
- `/home/pbrown/SkuInventory/src/components/features/CompanySelector.tsx`

**Files Modified**: 1
- `/home/pbrown/SkuInventory/src/app/(dashboard)/layout.tsx` (2 lines added: import + component)

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 -> Phase 2 -> Phase 3)
2. CompanySelector component must compile before integrating into layout
3. Test completion criteria before moving to next subtask
4. Follow reference patterns exactly - especially the toast notification pattern from ExportButton.tsx

---

## Test Strategy Note

- Manual testing required after implementation:
  1. User with 1 company: Selector should NOT appear in sidebar
  2. User with 2+ companies: Selector should appear below "Inventory Tracker" title
  3. Switching company: Should show loading state, call API, update session, show toast
  4. Error handling: Network failure should show error toast

---

## Acceptance Criteria Checklist

From Issue #87:
- [ ] Company selector appears in sidebar when user has 2+ companies
- [ ] Company selector is hidden when user has 0-1 companies
- [ ] Selecting a different company calls the switch API
- [ ] Current company is clearly indicated in the selector
- [ ] Loading state shown during company switch
- [ ] Toast notification on successful switch
- [ ] Error handling for failed switch attempts
- [ ] `npm run build` passes
- [ ] `npx tsc --noEmit` passes

---

## Performance Metrics

| Phase | Estimated Duration |
|-------|-------------------|
| Investigation | 8m |
| Validation | 3m |
| Planning | 4m |
| **Total** | **15m** |
