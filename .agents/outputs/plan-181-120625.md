# Implementation Plan
**Generated**: 2025-12-06T12:06:25Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #181
**Estimated Build Time**: 6-8 hours
**Complexity**: Moderate

## Investigation Summary

### Request Analysis
**Type**: Enhancement (UI Redesign)
**Source**: GitHub Issue #181
**Priority**: Medium

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED (Affected UI components, ~5-15 min)
**Suggested Filter**: None (new component, no existing tests)

### Issue Validation
**Status**: Valid
**Recent Changes**:
- `0f24c8e` fix(issue #30): add safe JSON parsing to prevent dialog crashes on non-JSON API responses
- `3fad556` feat(US3): complete Phase 5 - SKU and BOM management (older SKUForm work)

### Current State Assessment

**Current SKUForm.tsx Layout:**
- Uses horizontal grid layout (`grid gap-4 sm:grid-cols-2`) for fields
- Fields: Name, Internal Code, Sales Channel, ASIN, Shopify Handle, Notes
- Does NOT include: Company, Brand, or BOM component selection
- Location: `/home/pbrown/SkuInventory/src/components/features/SKUForm.tsx`

**Missing from Current Form (per user request):**
1. Company field - currently uses session's `selectedCompanyId` automatically
2. Brand field - currently uses session's `selectedBrandId` automatically
3. BOM component dropdowns (15 total) - currently done AFTER SKU creation via separate BOMVersionForm

**Database Schema (SKU model):**
```prisma
model SKU {
  id           String   @id @default(uuid())
  brandId      String
  brand        Brand    @relation(...)
  companyId    String?
  company      Company? @relation(...)
  name         String   @db.VarChar(100)
  internalCode String   @db.VarChar(50)
  salesChannel String   @db.VarChar(50)
  ...
}

model BOMVersion {
  id         String  @id @default(uuid())
  skuId      String
  sku        SKU     @relation(...)
  ...
  lines      BOMLine[]
}

model BOMLine {
  bomVersionId String
  componentId  String
  quantityPerUnit Decimal
}
```

**API Routes:**
- `POST /api/skus` - Creates SKU (uses session company/brand)
- `POST /api/skus/[id]/bom-versions` - Creates BOM version with component lines
- `GET /api/components?isActive=true` - Returns components filtered by session company/brand

### Dependencies & Blockers
1. Components are filtered by company/brand in session - OK, we'll use the session's selected company/brand
2. BOM version creation requires existing SKU - Need to create SKU first, then BOM

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Moderate
**Effort**: 6-8 hours
**Risk**: Medium (significant UI redesign, new workflow)

### Patterns Identified

**Primary Pattern - BOMVersionForm.tsx (lines 43-367):**
- Shows how to fetch components via `/api/components?isActive=true&pageSize=100`
- Has dropdown selection for components
- Uses `Select` component from shadcn/ui
- Handles adding/removing lines dynamically

**Secondary Pattern - ComponentForm.tsx:**
- Shows vertical form layout with `space-y-4`
- Shows how to use session-based company/brand

### Ripple Effect Analysis
**Files to Modify**: 3 files
- `/home/pbrown/SkuInventory/src/components/features/SKUForm.tsx` - Major rewrite (new layout + BOM components)
- `/home/pbrown/SkuInventory/src/types/sku.ts` - May need update if we add BOM lines to create schema
- `/home/pbrown/SkuInventory/src/app/api/skus/route.ts` - May need to handle BOM creation in same request

**Files Unchanged**:
- `/home/pbrown/SkuInventory/src/app/(dashboard)/skus/new/page.tsx` - Just imports SKUForm
- `/home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/edit/page.tsx` - Focus on creation only per user request

---

## Executive Summary

This implementation will redesign the SKU creation form to use a vertical column layout instead of the current horizontal grid. The form will display fields (Name, Internal Code, Company, Brand, Sales Channel) in a single column, followed by 15 dropdown menus for selecting BOM components. Components shown in dropdowns will be filtered by the selected company/brand from the user's session. The BOM version will be created automatically along with the SKU in a single transaction.

## Architecture Decision

**Option A (Recommended)**: Create SKU and BOM Version in single API call
- Modify POST /api/skus to accept optional `bomLines` array
- Create SKU and BOM version in database transaction
- Simpler UX - one submit button creates everything

**Option B**: Two-step process (current pattern)
- Create SKU first, redirect to BOM version creation
- More complex UX but matches existing pattern

**Decision**: Option A - Single API call for better UX

---

## Phase 1: Types Layer

### Subtask 1.1: Update SKU Types to Support BOM Lines
**File**: `/home/pbrown/SkuInventory/src/types/sku.ts`
**Pattern**: Follow existing type definitions
**Instructions**:
1. Add optional `bomLines` to `createSKUSchema`:
```typescript
export const createSKUSchema = z.object({
  name: z.string().min(1, 'Name is required').max(100),
  internalCode: z
    .string()
    .min(1, 'Internal code is required')
    .max(50)
    .regex(/^[a-zA-Z0-9\-_]+$/, 'Internal code can only contain letters, numbers, hyphens, and underscores'),
  salesChannel: salesChannelSchema,
  externalIds: z.record(z.string(), z.string()).default({}),
  notes: z.string().optional().nullable(),
  // NEW: Optional BOM lines for inline BOM creation
  bomLines: z.array(z.object({
    componentId: z.string().uuid(),
    quantityPerUnit: z.string().min(1), // Supports fractions like "1/45"
  })).optional(),
})
```
2. Run `npx tsc --noEmit` to verify no type errors
**Completion Criteria**:
- [ ] Schema updated with optional bomLines
- [ ] TypeScript compiles without errors

---

## Phase 2: API Layer

### Subtask 2.1: Update SKU API to Create BOM Version
**File**: `/home/pbrown/SkuInventory/src/app/api/skus/route.ts`
**Pattern**: Follow existing transaction patterns in codebase
**Instructions**:
1. Import `parseFractionOrNumber` from `@/lib/utils` for handling fraction quantities
2. Update POST handler to:
   - Check if `bomLines` array is provided and non-empty
   - Create SKU and BOM version in a Prisma transaction
   - Generate default version name (e.g., "v1")
   - Create BOMLines for each provided component
3. Example code structure:
```typescript
// After existing SKU creation code, wrap in transaction if bomLines provided
if (data.bomLines && data.bomLines.length > 0) {
  const result = await prisma.$transaction(async (tx) => {
    // Create SKU
    const sku = await tx.sKU.create({ ... })

    // Create BOM version
    const bomVersion = await tx.bOMVersion.create({
      data: {
        skuId: sku.id,
        versionName: 'v1',
        effectiveStartDate: new Date(),
        isActive: true,
        createdById: session.user.id,
        lines: {
          create: data.bomLines.map(line => ({
            componentId: line.componentId,
            quantityPerUnit: parseFractionOrNumber(line.quantityPerUnit) ?? 1,
          }))
        }
      }
    })

    return { sku, bomVersion }
  })
}
```
4. Return BOM info in response if created
**Validation**: `npx tsc --noEmit && npm run build`
**Completion Criteria**:
- [ ] API accepts optional bomLines array
- [ ] Creates SKU and BOM in transaction when bomLines provided
- [ ] Falls back to existing behavior when no bomLines
- [ ] Build passes

---

## Phase 3: UI Layer

### Subtask 3.1: Redesign SKUForm Component - Layout
**File**: `/home/pbrown/SkuInventory/src/components/features/SKUForm.tsx`
**Pattern**: Follow vertical layout from `ComponentForm.tsx` and dropdown from `BOMVersionForm.tsx`
**Instructions**:
1. Change layout from horizontal grid to vertical column:
   - Remove `grid gap-4 sm:grid-cols-2` classes
   - Use `space-y-4` for vertical stacking
2. Reorder fields vertically:
   - Name (required)
   - Internal Code (required)
   - Company (display only - from session)
   - Brand (display only - from session)
   - Sales Channel (required dropdown)
3. Keep optional fields:
   - ASIN
   - Shopify Handle
   - Notes
4. Update Card styling for narrower single-column form:
```tsx
<Card className="max-w-md">
  <CardContent className="space-y-4">
    {/* All fields stacked vertically */}
  </CardContent>
</Card>
```
**Completion Criteria**:
- [ ] Fields displayed in single vertical column
- [ ] Company and Brand shown as read-only from session
- [ ] Form renders correctly

### Subtask 3.2: Add Component Dropdown Section
**File**: `/home/pbrown/SkuInventory/src/components/features/SKUForm.tsx`
**Pattern**: Follow `BOMVersionForm.tsx` lines 61-76 for component fetching
**Instructions**:
1. Add state for components and loading:
```typescript
const [components, setComponents] = useState<ComponentResponse[]>([])
const [loadingComponents, setLoadingComponents] = useState(true)
```
2. Add useEffect to fetch components on mount:
```typescript
useEffect(() => {
  async function fetchComponents() {
    try {
      const res = await fetch('/api/components?isActive=true&pageSize=100')
      if (res.ok) {
        const data = await res.json().catch(() => ({}))
        setComponents(data?.data || [])
      }
    } catch (err) {
      console.error('Failed to fetch components:', err)
    } finally {
      setLoadingComponents(false)
    }
  }
  fetchComponents()
}, [])
```
3. Add state for 15 BOM line selections:
```typescript
const [bomLines, setBomLines] = useState<Array<{
  componentId: string
  quantityPerUnit: string
}>>([
  // Initialize 15 empty slots
  ...Array(15).fill({ componentId: '', quantityPerUnit: '1' })
])
```
4. Add import for `ComponentResponse` type
**Completion Criteria**:
- [ ] Components fetched on mount
- [ ] State initialized for 15 BOM slots
- [ ] Loading state handled

### Subtask 3.3: Add 15 BOM Component Dropdowns UI
**File**: `/home/pbrown/SkuInventory/src/components/features/SKUForm.tsx`
**Pattern**: Follow `BOMVersionForm.tsx` lines 280-340 for dropdown rendering
**Instructions**:
1. Add section header "BOM Components (Optional)" below Sales Channel
2. Render 15 dropdown rows, each with:
   - Label "Component 1", "Component 2", etc.
   - Select dropdown for component selection (can be empty)
   - Input for quantity (default "1", supports fractions)
3. Example JSX structure:
```tsx
<div className="space-y-4">
  <Label className="text-base font-medium">BOM Components (Optional)</Label>
  <p className="text-sm text-muted-foreground">
    Select components to create a BOM version with this SKU.
    Components are filtered by your selected company/brand.
  </p>
  {bomLines.map((line, index) => (
    <div key={index} className="flex gap-2 items-center">
      <div className="flex-1">
        <Select
          value={line.componentId}
          onValueChange={(value) => updateBomLine(index, 'componentId', value)}
        >
          <SelectTrigger>
            <SelectValue placeholder={`Component ${index + 1}`} />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="">-- None --</SelectItem>
            {components.map((c) => (
              <SelectItem key={c.id} value={c.id}>
                {c.name} ({c.skuCode})
              </SelectItem>
            ))}
          </SelectContent>
        </Select>
      </div>
      <div className="w-24">
        <Input
          type="text"
          value={line.quantityPerUnit}
          onChange={(e) => updateBomLine(index, 'quantityPerUnit', e.target.value)}
          placeholder="Qty"
          disabled={!line.componentId}
        />
      </div>
    </div>
  ))}
</div>
```
4. Add helper function to update BOM lines:
```typescript
const updateBomLine = (index: number, field: 'componentId' | 'quantityPerUnit', value: string) => {
  setBomLines(prev => prev.map((line, i) =>
    i === index ? { ...line, [field]: value } : line
  ))
}
```
**Completion Criteria**:
- [ ] 15 dropdown slots rendered
- [ ] Each dropdown shows components from API
- [ ] Quantity input next to each dropdown
- [ ] Can select and clear components

### Subtask 3.4: Update Form Submission to Include BOM Lines
**File**: `/home/pbrown/SkuInventory/src/components/features/SKUForm.tsx`
**Pattern**: Follow existing handleSubmit pattern
**Instructions**:
1. Modify handleSubmit to include non-empty BOM lines:
```typescript
const handleSubmit = async (e: React.FormEvent) => {
  e.preventDefault()
  setIsLoading(true)
  setError(null)

  try {
    // Filter BOM lines to only those with a component selected
    const selectedBomLines = bomLines
      .filter(line => line.componentId)
      .map(line => ({
        componentId: line.componentId,
        quantityPerUnit: line.quantityPerUnit || '1',
      }))

    const res = await fetch('/api/skus', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name: formData.name,
        internalCode: formData.internalCode,
        salesChannel: formData.salesChannel,
        externalIds,
        notes: formData.notes || null,
        // Include BOM lines if any selected
        ...(selectedBomLines.length > 0 && { bomLines: selectedBomLines }),
      }),
    })
    // ... rest of handler
  }
}
```
2. Ensure empty BOM lines are not sent (only send if at least one component selected)
**Completion Criteria**:
- [ ] Form sends bomLines when components selected
- [ ] Empty slots are filtered out
- [ ] Submission still works for SKU-only creation (no BOM)

### Subtask 3.5: Add Session Display for Company/Brand
**File**: `/home/pbrown/SkuInventory/src/components/features/SKUForm.tsx`
**Pattern**: Use `useSession` hook from next-auth/react
**Instructions**:
1. Add `useSession` import and hook:
```typescript
import { useSession } from 'next-auth/react'

export function SKUForm({ sku, onSuccess }: SKUFormProps) {
  const { data: session } = useSession()
  // ...
}
```
2. Add read-only display fields for Company and Brand after Name/Internal Code:
```tsx
<div className="space-y-2">
  <Label>Company</Label>
  <Input
    value={session?.user?.selectedCompanyName || 'Loading...'}
    disabled
    className="bg-muted"
  />
</div>

<div className="space-y-2">
  <Label>Brand</Label>
  <Input
    value={session?.user?.selectedBrandName || 'All Brands'}
    disabled
    className="bg-muted"
  />
</div>
```
3. Add helpful text explaining these come from session
**Completion Criteria**:
- [ ] Company name displayed from session
- [ ] Brand name displayed from session
- [ ] Fields are visually disabled/read-only

---

## Phase 4: Validation & Polish

### Subtask 4.1: Add Form Validation
**File**: `/home/pbrown/SkuInventory/src/components/features/SKUForm.tsx`
**Instructions**:
1. Validate that if any BOM lines have a component, they should have a valid quantity
2. Show warning if more than 15 components needed (should not happen but good guard)
3. Handle case where components API returns empty list
**Completion Criteria**:
- [ ] Quantity validation for BOM lines
- [ ] Graceful handling of no components

### Subtask 4.2: Visual Polish
**File**: `/home/pbrown/SkuInventory/src/components/features/SKUForm.tsx`
**Instructions**:
1. Add divider between basic SKU fields and BOM section:
```tsx
<hr className="my-6" />
```
2. Use subtle styling for empty BOM dropdowns
3. Show count of selected components: "3 of 15 components selected"
4. Ensure form is scrollable if content exceeds viewport
**Completion Criteria**:
- [ ] Clear visual separation between sections
- [ ] Component count displayed
- [ ] Form scrolls properly

---

## Phase 5: Testing & Verification

### Subtask 5.1: Manual Testing Checklist
**Instructions**: Verify the following scenarios work:
1. Create SKU without any BOM components - should work as before
2. Create SKU with 1 BOM component - should create SKU + BOM version
3. Create SKU with 15 BOM components - should create all
4. Create SKU with partial components (e.g., slots 1, 5, 10 filled) - should only create 3 BOM lines
5. Verify components in dropdowns are filtered by session's company/brand
6. Test fraction input for quantity (e.g., "1/45")
7. Verify form layout is single column
8. Verify Company and Brand are read-only
**Completion Criteria**:
- [ ] All scenarios pass
- [ ] No console errors
- [ ] Build passes: `npm run build`
- [ ] TypeScript passes: `npx tsc --noEmit`

---

## Summary of Deliverables

**Files Created**: 0
**Files Modified**: 3
1. `/home/pbrown/SkuInventory/src/types/sku.ts` - Add optional bomLines to create schema
2. `/home/pbrown/SkuInventory/src/app/api/skus/route.ts` - Handle BOM creation in SKU POST
3. `/home/pbrown/SkuInventory/src/components/features/SKUForm.tsx` - Complete redesign

## Handoff to Build Agent
1. Execute subtasks in exact order (Phase 1 -> 5)
2. Complete each phase fully before starting next
3. Test completion criteria before proceeding
4. Follow reference patterns exactly
5. Run build and type checks after each phase

## Test Strategy Note
- Manual testing recommended for UI changes
- Use Vitest for unit tests if time permits
- Focus on happy path scenarios for initial implementation

## UI Acceptance Criteria
- [ ] Form displays all fields in single vertical column
- [ ] Form visible on desktop, tablet, and mobile
- [ ] Company and Brand fields are read-only
- [ ] 15 BOM component dropdowns visible below form fields
- [ ] Each dropdown shows components filtered by company/brand
- [ ] Quantity input next to each component dropdown
- [ ] Submit button creates SKU (and BOM if components selected)

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 10m |
| **Total** | **30m** |
