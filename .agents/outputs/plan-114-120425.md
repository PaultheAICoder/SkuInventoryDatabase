# Implementation Plan: Transaction Review and Approval Workflow
**Generated**: 2025-12-04T18:30:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: Issue #114
**Estimated Build Time**: 10-14 hours
**Complexity**: Moderate

---

## Investigation Summary

### Request Analysis
**Type**: Feature
**Source**: GitHub Issue #114 (Parent: #98)
**Priority**: High (final issue in parent #98 sequence)

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: `--testPathPattern="draft|transaction"` or None

### Issue Validation
**Status**: Valid
**Recent Changes**: Issue #113 (Conversational AI Parser) closed recently - may create drafts for review

### Current State Assessment
- **Database**: Transaction model exists without status field - draft status NOT implemented
- **Types**: `src/types/transaction.ts` has schemas but no draft-related types
- **API Routes**: Existing transaction routes create transactions immediately (no draft state)
- **Services**: `src/services/inventory.ts` handles transaction creation but always applies to inventory
- **UI**: Quick Entry form submits directly, ParsedTransactionPreview submits immediately on confirm

### Dependencies and Blockers
1. **Issue #111** (Quick Entry UI) - CLOSED - provides the form for creating drafts
2. **Issue #113** (AI Parser) - CLOSED - can create drafts for review
3. No blockers identified

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Moderate
**Effort**: 10-14 hours
**Risk**: Medium
- Schema changes require migration
- Inventory calculation must exclude drafts
- Multiple UI components need updates

### Patterns Identified
**Primary Reference**: Shopify Order Review Workflow
- `src/app/api/shopify/orders/[id]/approve/route.ts` - Approval endpoint pattern
- `src/types/order-review.ts` - Status configuration pattern
- `ShopifyOrderStatus` enum in Prisma schema - Similar status enum pattern

**Secondary Reference**: Existing Transaction Routes
- `src/app/api/transactions/receipt/route.ts` - API route pattern
- `src/services/inventory.ts` - Transaction creation functions
- `src/components/features/QuickEntryWrapper.tsx` - Form submission flow

### Ripple Effect Analysis
**Files Identified**: 18+ files

**Database/Schema Layer**:
- `prisma/schema.prisma` - Add TransactionStatus enum and status field

**Types Layer**:
- `src/types/transaction.ts` - Add draft-related types and schemas
- NEW: `src/types/draft.ts` - Draft-specific types

**Services Layer**:
- `src/services/inventory.ts` - Update to handle draft flag, add approval logic

**API Routes Layer**:
- NEW: `src/app/api/transactions/drafts/route.ts` - List drafts, create draft
- NEW: `src/app/api/transactions/drafts/[id]/route.ts` - Get/update/delete draft
- NEW: `src/app/api/transactions/drafts/[id]/approve/route.ts` - Approve draft
- NEW: `src/app/api/transactions/drafts/[id]/reject/route.ts` - Reject draft
- NEW: `src/app/api/transactions/drafts/batch-approve/route.ts` - Batch approve
- `src/app/api/transactions/route.ts` - Exclude drafts by default

**UI Components Layer**:
- NEW: `src/components/features/DraftTransactionCard.tsx` - Preview card
- NEW: `src/components/features/DraftTransactionList.tsx` - List of pending
- `src/components/features/QuickEntryForm.tsx` - Add "Save as Draft" option
- `src/components/features/QuickEntryWrapper.tsx` - Add draft submission flow
- `src/components/features/ParsedTransactionPreview.tsx` - Add draft option

**Pages Layer**:
- NEW: `src/app/(dashboard)/transactions/drafts/page.tsx` - Draft review queue
- `src/app/(dashboard)/layout.tsx` - Add draft count badge to nav

**Settings/Config**:
- `src/types/settings.ts` - Add draftAutoRejectDays setting

---

## Executive Summary
Implement a draft transaction system allowing users to create transactions in "pending review" status that don't affect inventory until approved. This includes database schema changes (new TransactionStatus enum), API endpoints for CRUD and approval operations, UI components for draft preview and management, and a dedicated review queue page. The system follows the existing Shopify order approval workflow pattern.

---

## Phase 0: Schema and Types Foundation

### Subtask 0.1: Add TransactionStatus Enum to Prisma Schema
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Pattern**: Follow existing `ShopifyOrderStatus` enum (line 226-232)
**Instructions**:
1. Add new enum after `TransactionType` enum (around line 224):
```prisma
enum TransactionStatus {
  draft
  approved
  rejected
}
```
2. Add status field and reviewer fields to Transaction model (after createdById):
```prisma
  status       TransactionStatus @default(approved)
  reviewedAt   DateTime?
  reviewedById String?
  reviewedBy   User?  @relation("TransactionReviewedBy", fields: [reviewedById], references: [id])
  rejectReason String?          @db.VarChar(500)
```
3. Update the User model to add the reviewer relation (after existing relations):
```prisma
  transactionsReviewed Transaction[] @relation("TransactionReviewedBy")
```
4. Add index for status queries:
```prisma
  @@index([companyId, status])
```

**Validation**:
```bash
npx prisma validate
```

**Completion Criteria**:
- [ ] Enum created
- [ ] Status field added to Transaction
- [ ] Reviewer fields added
- [ ] User relation added
- [ ] Index added
- [ ] `npx prisma validate` passes

### Subtask 0.2: Create and Run Database Migration
**Instructions**:
1. Create migration:
```bash
npx prisma migrate dev --name add_transaction_status
```
2. Generate client:
```bash
npx prisma generate
```

**Validation**:
```bash
npx prisma migrate status
```

**Completion Criteria**:
- [ ] Migration created in `prisma/migrations/`
- [ ] Migration applied successfully
- [ ] Prisma client regenerated
- [ ] Existing transactions default to 'approved' status

### Subtask 0.3: Add Draft Transaction Types
**File**: `/home/pbrown/SkuInventory/src/types/draft.ts` (NEW FILE)
**Pattern**: Follow `src/types/order-review.ts` structure
**Instructions**:
Create new file with:
```typescript
import { z } from 'zod'

// Transaction status types
export type TransactionStatus = 'draft' | 'approved' | 'rejected'

// Schema for creating a draft transaction
export const createDraftSchema = z.object({
  type: z.enum(['receipt', 'build', 'adjustment', 'initial', 'transfer']),
  data: z.record(z.unknown()), // Type-specific data
})

export type CreateDraftInput = z.infer<typeof createDraftSchema>

// Schema for rejecting a draft
export const rejectDraftSchema = z.object({
  reason: z.string().max(500).optional(),
})

export type RejectDraftInput = z.infer<typeof rejectDraftSchema>

// Schema for batch approve
export const batchApproveDraftsSchema = z.object({
  draftIds: z.array(z.string().uuid()).min(1).max(50),
})

export type BatchApproveDraftsInput = z.infer<typeof batchApproveDraftsSchema>

// Status badge configuration
export const DRAFT_STATUS_CONFIG = {
  draft: { label: 'Pending Review', variant: 'warning' as const },
  approved: { label: 'Approved', variant: 'success' as const },
  rejected: { label: 'Rejected', variant: 'destructive' as const },
} as const

// Draft list query schema
export const draftListQuerySchema = z.object({
  page: z.coerce.number().int().positive().default(1),
  pageSize: z.coerce.number().int().positive().max(100).default(20),
  type: z.enum(['receipt', 'build', 'adjustment', 'initial', 'transfer']).optional(),
  sortBy: z.enum(['date', 'createdAt', 'type']).default('createdAt'),
  sortOrder: z.enum(['asc', 'desc']).default('desc'),
})

export type DraftListQuery = z.infer<typeof draftListQuerySchema>

// Draft response type (extends TransactionResponse)
export interface DraftTransactionResponse {
  id: string
  type: 'receipt' | 'build' | 'adjustment' | 'initial' | 'transfer'
  status: TransactionStatus
  date: string
  // Type-specific fields from Transaction
  sku?: { id: string; name: string } | null
  bomVersion?: { id: string; versionName: string } | null
  locationId: string | null
  location?: { id: string; name: string } | null
  fromLocationId?: string | null
  fromLocation?: { id: string; name: string } | null
  toLocationId?: string | null
  toLocation?: { id: string; name: string } | null
  salesChannel: string | null
  unitsBuild: number | null
  supplier: string | null
  reason: string | null
  notes: string | null
  rejectReason: string | null
  createdAt: string
  createdBy: { id: string; name: string }
  reviewedAt: string | null
  reviewedBy: { id: string; name: string } | null
  lines: Array<{
    id: string
    component: { id: string; name: string; skuCode: string }
    quantityChange: string
    costPerUnit: string | null
    lotId: string | null
    lot: { id: string; lotNumber: string; expiryDate: string | null } | null
  }>
}
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] File created with all types
- [ ] No TypeScript errors

### Subtask 0.4: Update Company Settings for Draft Auto-Reject
**File**: `/home/pbrown/SkuInventory/src/types/settings.ts`
**Pattern**: Follow existing settings schema structure
**Instructions**:
Add to `companySettingsSchema` (around line 23, before closing parenthesis):
```typescript
  // Draft transaction settings
  draftAutoRejectDays: z.coerce.number().int().nonnegative().default(7),
  enableDraftWorkflow: z.boolean().default(true),
```

Add to `DEFAULT_SETTINGS` (around line 45):
```typescript
  draftAutoRejectDays: 7,
  enableDraftWorkflow: true,
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Settings schema updated
- [ ] Defaults added
- [ ] TypeScript compiles

---

## Phase 1: Service Layer

### Subtask 1.1: Add Draft Transaction Service Functions
**File**: `/home/pbrown/SkuInventory/src/services/inventory.ts`
**Pattern**: Follow existing `createReceiptTransaction` pattern
**Instructions**:
Add new functions at the end of the file:

1. `createDraftTransaction` - Creates transaction with status='draft'
2. `approveDraftTransaction` - Changes status to 'approved' and applies inventory
3. `rejectDraftTransaction` - Changes status to 'rejected' with reason
4. `getDraftTransactions` - List drafts for company
5. `getDraftCount` - Get count of pending drafts (for badge)

Key implementation notes:
- Draft creation should NOT call inventory update functions
- On approval, must call the appropriate transaction creation function based on type
- Rejection just updates status, no inventory changes
- Must validate inventory availability on approval (re-validate)

Example function signature for `createDraftTransaction`:
```typescript
export async function createDraftTransaction(params: {
  companyId: string
  type: 'receipt' | 'build' | 'adjustment' | 'initial' | 'transfer'
  date: Date
  createdById: string
  // Type-specific optional fields
  componentId?: string
  skuId?: string
  bomVersionId?: string
  quantity?: number
  unitsToBuild?: number
  supplier?: string
  reason?: string
  salesChannel?: string
  locationId?: string
  fromLocationId?: string
  toLocationId?: string
  notes?: string | null
  costPerUnit?: number
  updateComponentCost?: boolean
  lotNumber?: string
  expiryDate?: string
  defectCount?: number | null
  defectNotes?: string | null
  affectedUnits?: number | null
}) {
  // Create transaction with status: 'draft'
  // Do NOT create transaction lines yet OR create with 0 quantity impact
  // Store all params for later approval
}
```

**Validation**:
```bash
npx tsc --noEmit
npm run lint
```

**Completion Criteria**:
- [ ] All 5 functions implemented
- [ ] Draft transactions don't affect inventory
- [ ] Approval triggers inventory update
- [ ] TypeScript compiles

### Subtask 1.2: Update getComponentQuantity to Exclude Drafts
**File**: `/home/pbrown/SkuInventory/src/services/inventory.ts`
**Pattern**: Update existing functions
**Instructions**:
Update `getComponentQuantity` (lines 40-102) and `getComponentQuantities` (lines 114-206) to filter by status:

In both functions, add to the `where` clause for transaction filtering:
```typescript
transaction: {
  // existing conditions...
  status: 'approved', // Only count approved transactions
}
```

Note: This is CRITICAL - draft and rejected transactions must NOT affect inventory calculations.

**Validation**:
```bash
npm test -- --testPathPattern="inventory"
```

**Completion Criteria**:
- [ ] getComponentQuantity excludes drafts
- [ ] getComponentQuantities excludes drafts
- [ ] Existing tests pass
- [ ] Draft transactions don't appear in inventory totals

---

## Phase 2: API Routes

### Subtask 2.1: Create Draft List Endpoint
**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/drafts/route.ts` (NEW FILE)
**Pattern**: Follow `src/app/api/transactions/route.ts`
**Instructions**:
Create GET endpoint to list draft transactions:
- Auth required (admin/ops only for approval, viewer can see list)
- Filter by companyId
- Filter by status='draft' (for pending queue)
- Support pagination
- Support type filter

Create POST endpoint to create draft:
- Auth required (admin/ops only)
- Accept transaction data
- Create with status='draft'

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] GET returns paginated drafts
- [ ] POST creates new draft
- [ ] Auth enforced
- [ ] Company scoping works

### Subtask 2.2: Create Draft Detail/Update/Delete Endpoint
**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/drafts/[id]/route.ts` (NEW FILE)
**Pattern**: Follow `src/app/api/transactions/[id]/route.ts`
**Instructions**:
Create endpoints:
- GET - Get single draft by ID
- PUT - Update draft (only if status='draft')
- DELETE - Delete draft (only if status='draft')

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] All endpoints work
- [ ] Cannot update/delete non-draft status
- [ ] Auth enforced

### Subtask 2.3: Create Approve Endpoint
**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/drafts/[id]/approve/route.ts` (NEW FILE)
**Pattern**: Follow `src/app/api/shopify/orders/[id]/approve/route.ts`
**Instructions**:
Create POST endpoint:
- Auth required (admin/ops only)
- Validate draft exists and is pending
- Re-validate inventory availability (for builds)
- Call approval service function
- Return updated transaction

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Approval changes status
- [ ] Inventory is updated on approval
- [ ] Insufficient inventory handled
- [ ] Auth enforced

### Subtask 2.4: Create Reject Endpoint
**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/drafts/[id]/reject/route.ts` (NEW FILE)
**Pattern**: Follow approve endpoint
**Instructions**:
Create POST endpoint:
- Auth required (admin/ops only)
- Accept optional reason
- Update status to 'rejected'
- Set reviewedAt and reviewedById

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Rejection updates status
- [ ] Reason stored
- [ ] Reviewer tracked
- [ ] Auth enforced

### Subtask 2.5: Create Batch Approve Endpoint
**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/drafts/batch-approve/route.ts` (NEW FILE)
**Pattern**: Follow `src/app/api/shopify/orders/post-batch/route.ts`
**Instructions**:
Create POST endpoint:
- Auth required (admin/ops only)
- Accept array of draft IDs
- Process each approval
- Return success/failure counts

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Batch processing works
- [ ] Individual failures don't stop batch
- [ ] Results returned

### Subtask 2.6: Create Draft Count Endpoint
**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/drafts/count/route.ts` (NEW FILE)
**Pattern**: Simple count endpoint
**Instructions**:
Create GET endpoint:
- Auth required
- Return count of pending drafts for company
- Used for nav badge

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Returns accurate count
- [ ] Fast performance

### Subtask 2.7: Update Transaction List to Exclude Drafts
**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/route.ts`
**Pattern**: Modify existing GET
**Instructions**:
Update the `where` clause (around line 28) to exclude drafts by default:
```typescript
const where: Prisma.TransactionWhereInput = {
  companyId: selectedCompanyId,
  status: 'approved', // Exclude drafts and rejected
  // ... rest of existing filters
}
```

Optionally support a `includeAll` query param for viewing all statuses.

**Validation**:
```bash
npm test
```

**Completion Criteria**:
- [ ] Drafts excluded by default
- [ ] Existing functionality preserved

---

## Phase 3: UI Components

### Subtask 3.1: Create Draft Transaction Card Component
**File**: `/home/pbrown/SkuInventory/src/components/features/DraftTransactionCard.tsx` (NEW FILE)
**Pattern**: Follow `src/components/features/ParsedTransactionPreview.tsx`
**Instructions**:
Create component showing:
- Transaction type badge
- Date
- Summary (item, quantity, location)
- Created by and timestamp
- Approve/Reject/Edit buttons
- Status badge if rejected

Props:
```typescript
interface DraftTransactionCardProps {
  draft: DraftTransactionResponse
  onApprove: (id: string) => Promise<void>
  onReject: (id: string, reason?: string) => Promise<void>
  onEdit: (id: string) => void
  isProcessing?: boolean
}
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Card displays all draft info
- [ ] Action buttons work
- [ ] Loading states shown

### Subtask 3.2: Create Draft Transaction List Component
**File**: `/home/pbrown/SkuInventory/src/components/features/DraftTransactionList.tsx` (NEW FILE)
**Pattern**: Follow table pattern from transactions page
**Instructions**:
Create component with:
- Table of pending drafts
- Checkbox selection for batch approve
- Filter by type
- Approve/Reject all selected
- Empty state when no drafts

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] List renders correctly
- [ ] Selection works
- [ ] Batch actions work

### Subtask 3.3: Update Quick Entry Form for Draft Option
**File**: `/home/pbrown/SkuInventory/src/components/features/QuickEntryForm.tsx`
**Pattern**: Modify existing form
**Instructions**:
Add checkbox or toggle at bottom of form:
```tsx
<div className="flex items-center space-x-2">
  <Checkbox
    id="saveAsDraft"
    checked={saveAsDraft}
    onCheckedChange={setSaveAsDraft}
  />
  <label htmlFor="saveAsDraft" className="text-sm">
    Save as draft (requires review before applying to inventory)
  </label>
</div>
```

Update submit handler to call draft endpoint when checked.

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Checkbox visible
- [ ] Draft creation works
- [ ] Success message indicates draft status

### Subtask 3.4: Update Quick Entry Wrapper for Draft Flow
**File**: `/home/pbrown/SkuInventory/src/components/features/QuickEntryWrapper.tsx`
**Pattern**: Modify existing component
**Instructions**:
Update `submitParsedTransaction` function to accept optional `asDraft` parameter.
Add "Save as Draft" button to ParsedTransactionPreview alongside "Confirm & Submit".

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Draft option available in conversational flow
- [ ] Both submit paths work

### Subtask 3.5: Update Parsed Transaction Preview
**File**: `/home/pbrown/SkuInventory/src/components/features/ParsedTransactionPreview.tsx`
**Pattern**: Modify existing component
**Instructions**:
Add new "Save as Draft" button in CardFooter:
```tsx
<Button variant="outline" onClick={onSaveAsDraft} disabled={isSubmitting || !parsed.itemId.value}>
  <Save className="mr-2 h-4 w-4" />
  Save as Draft
</Button>
```

Add `onSaveAsDraft` to props.

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Draft button visible
- [ ] Callback prop added

---

## Phase 4: Pages and Navigation

### Subtask 4.1: Create Draft Review Queue Page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/transactions/drafts/page.tsx` (NEW FILE)
**Pattern**: Follow `src/app/(dashboard)/transactions/page.tsx`
**Instructions**:
Create page with:
- Header: "Draft Transactions" with subtitle
- DraftTransactionList component
- Batch approve button
- Link back to transactions

Include server-side auth check.

**Validation**:
```bash
npm run build
```

**Completion Criteria**:
- [ ] Page renders
- [ ] Draft list loads
- [ ] Navigation works

### Subtask 4.2: Update Navigation for Draft Badge
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/layout.tsx`
**Pattern**: Modify existing navigation
**Instructions**:
1. Add "Drafts" sub-item under Transactions or as a separate nav item
2. Fetch draft count and display badge:
```tsx
// Add to navigation array or as sub-item
{ name: 'Drafts', href: '/transactions/drafts', icon: FileEdit, badge: draftCount }
```

3. Create client-side hook to fetch draft count periodically or use SWR
4. Display badge next to nav item when count > 0

Note: May need to convert navigation section to client component for badge updates.

**Validation**:
```bash
npm run build
```

**Completion Criteria**:
- [ ] Drafts link in navigation
- [ ] Badge shows when drafts exist
- [ ] Badge updates appropriately

---

## Phase 5: Integration and Testing

### Subtask 5.1: Integration Testing
**Instructions**:
Manually test the complete workflow:
1. Create draft via Quick Entry form
2. Verify draft appears in queue
3. Verify inventory NOT updated
4. Approve draft
5. Verify inventory IS updated
6. Create another draft
7. Reject with reason
8. Verify inventory NOT updated
9. Test batch approve
10. Test edit draft before approval

**Completion Criteria**:
- [ ] End-to-end workflow works
- [ ] Inventory calculations correct
- [ ] All UI components functional

### Subtask 5.2: Build and TypeScript Verification
**Instructions**:
```bash
npx tsc --noEmit
npm run lint
npm run build
```

**Completion Criteria**:
- [ ] No TypeScript errors
- [ ] No lint errors
- [ ] Build succeeds

---

## Summary of Deliverables

**Files Created**: 11
- `prisma/migrations/[timestamp]_add_transaction_status/` - Migration
- `src/types/draft.ts` - Draft types
- `src/app/api/transactions/drafts/route.ts` - List/create drafts
- `src/app/api/transactions/drafts/[id]/route.ts` - CRUD single draft
- `src/app/api/transactions/drafts/[id]/approve/route.ts` - Approve
- `src/app/api/transactions/drafts/[id]/reject/route.ts` - Reject
- `src/app/api/transactions/drafts/batch-approve/route.ts` - Batch approve
- `src/app/api/transactions/drafts/count/route.ts` - Draft count
- `src/components/features/DraftTransactionCard.tsx` - Draft card
- `src/components/features/DraftTransactionList.tsx` - Draft list
- `src/app/(dashboard)/transactions/drafts/page.tsx` - Queue page

**Files Modified**: 7
- `prisma/schema.prisma` - Add enum and fields
- `src/types/settings.ts` - Add draft settings
- `src/services/inventory.ts` - Add draft functions, exclude drafts from quantities
- `src/app/api/transactions/route.ts` - Exclude drafts
- `src/components/features/QuickEntryForm.tsx` - Add draft option
- `src/components/features/QuickEntryWrapper.tsx` - Handle draft flow
- `src/components/features/ParsedTransactionPreview.tsx` - Add draft button
- `src/app/(dashboard)/layout.tsx` - Add nav badge

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 0 -> 1 -> 2 -> 3 -> 4 -> 5)
2. Complete each subtask fully before moving to next
3. Run validation commands after each subtask
4. Follow reference patterns exactly
5. Pay special attention to:
   - Inventory exclusion logic in Phase 1.2 (critical)
   - Migration must handle existing transactions (default to 'approved')
   - Approval must re-validate inventory before applying

## Test Strategy Note
- **Unit Tests**: Add tests for draft service functions
- **Integration**: Manual testing of workflow
- No E2E tests required for this feature initially

## Performance Metrics
| Phase | Estimated Duration |
|-------|----------|
| Phase 0 (Schema/Types) | 2h |
| Phase 1 (Services) | 3h |
| Phase 2 (API Routes) | 3h |
| Phase 3 (UI Components) | 2.5h |
| Phase 4 (Pages/Nav) | 1.5h |
| Phase 5 (Testing) | 2h |
| **Total** | **14h** |

---

## Risk Mitigation

1. **Inventory Calculation Risk**: Ensure ALL inventory calculation paths filter by status. Search for all uses of `getComponentQuantity` and `getComponentQuantities`.

2. **Migration Risk**: Migration adds default value 'approved', so existing transactions continue to work.

3. **Performance Risk**: Add index on `[companyId, status]` for efficient draft queries.

4. **Data Integrity Risk**: Draft approval uses Prisma transaction to ensure atomic status change + inventory update.
