# Scout Report: Allow re-import of initial inventory with overwrite flag

## Request Analysis
**Type**: Enhancement
**Source**: GitHub Issue #44
**Priority**: Low (nice to have, not blocking any workflows)

## Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="initial.*inventory|import.*overwrite"` or run full test suite for data integrity

## Issue Validation
**Status**: ✅ Valid
**Recent Changes**:
- Issue #8 (parent issue) was completed on 2025-12-02
- No subsequent changes to initial inventory import logic
- Code mentioned in issue matches current implementation exactly (lines 115-135)

## Current State

### Existing Components

**API Routes**:
- ✅ `/home/pbrown/SkuInventory/src/app/api/import/initial-inventory/route.ts` - Bulk CSV import endpoint (165 lines)
- ✅ `/home/pbrown/SkuInventory/src/app/api/transactions/initial/route.ts` - Single transaction endpoint

**Services**:
- ✅ `/home/pbrown/SkuInventory/src/services/inventory.ts` - Contains `createInitialTransaction` (lines 229-305)
- ✅ `/home/pbrown/SkuInventory/src/services/import.ts` - CSV processing functions

**UI Components**:
- ✅ `/home/pbrown/SkuInventory/src/app/(dashboard)/import/page.tsx` - Import page with three import forms
- ✅ `/home/pbrown/SkuInventory/src/components/features/ImportForm.tsx` - Reusable form component (224 lines)
- ✅ `/home/pbrown/SkuInventory/src/components/features/ImportResultDialog.tsx` - Result display dialog
- ✅ `/home/pbrown/SkuInventory/src/components/ui/checkbox.tsx` - shadcn/ui checkbox component

**Types**:
- ✅ `/home/pbrown/SkuInventory/src/types/transaction.ts` - Transaction type definitions
- ✅ `/home/pbrown/SkuInventory/src/types/index.ts` - TransactionType = 'receipt' | 'build' | 'adjustment' | 'initial'

### Database

**Schema** (Prisma):
- ✅ `Transaction` model with type field (TransactionType enum)
- ✅ `TransactionLine` model with `onDelete: Cascade` (deleting transaction auto-deletes lines)
- ✅ Both models indexed appropriately

**Current Idempotency Check** (lines 115-135 in route.ts):
```typescript
const existingInitial = await prisma.transaction.findFirst({
  where: {
    type: 'initial',
    lines: {
      some: { componentId: component.id },
    },
  },
})

if (existingInitial) {
  result.skipped++
  result.errors.push({
    rowNumber: row.rowNumber,
    componentSkuCode: rowData.componentSkuCode,
    errors: [`Component "${rowData.componentSkuCode}" already has an initial inventory transaction`],
  })
  continue
}
```

### API Routes

**Current Flow**:
1. Parse CSV or multipart form data
2. Process each row through CSV parser
3. For each valid row:
   - Look up component by SKU code
   - Check for existing initial transaction (IDEMPOTENCY CHECK)
   - Create initial transaction if none exists
   - Track imported/skipped counts

**Missing**: No mechanism to delete and replace existing initial transactions

## Dependencies & Blockers

**Dependencies**:
1. ✅ Prisma ORM - installed and working
2. ✅ shadcn/ui checkbox component - exists at `src/components/ui/checkbox.tsx`
3. ✅ React Hook Form pattern - already used in codebase (see BuildDialog.tsx)
4. ✅ Transaction cascade delete - configured in Prisma schema

**Blockers**: None

**Can Proceed?**: YES

## Complexity Assessment

**Complexity**: Simple
**Effort**: 3-4 hours (as estimated in issue)
**Risk**: Low

### Breakdown:
1. **Backend (1.5 hours)**:
   - Add query parameter handling in route handler
   - Implement delete + create logic (replace transaction)
   - Update error messages to differentiate "duplicate prevented" vs "overwrite in progress"

2. **Frontend (1 hour)**:
   - Add checkbox state to ImportForm component
   - Pass allowOverwrite flag in FormData
   - Update UI to show checkbox for initial-inventory type only

3. **Tests (0.5-1 hour)**:
   - Add unit tests for overwrite scenarios
   - Update E2E tests to cover checkbox interaction
   - Add test for audit trail (transaction ID changes)

## Patterns to Follow

**Primary Pattern**: `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx` and `/home/pbrown/SkuInventory/src/app/api/transactions/build/route.ts`
- Shows how `allowInsufficientInventory` flag is implemented
- Frontend passes flag in request body (line 125)
- Backend uses flag to conditionally allow risky operation
- Warning UI shown before proceeding with risky action

**Secondary Pattern**: Form state management in ImportForm.tsx
- Line 47: `const [file, setFile] = useState<File | null>(null)`
- Line 100: `formData.append('file', file)` - multipart form submission
- Shows how to add additional form fields to FormData

**Database Transaction Pattern**: `createInitialTransaction` in inventory.ts (lines 229-305)
- Uses `prisma.$transaction()` for atomic operations
- Shows proper error handling

## Files to Create/Modify

### Files to Modify (5 files):

1. **`/home/pbrown/SkuInventory/src/app/api/import/initial-inventory/route.ts`** (PRIMARY)
   - Purpose: Handle `allowOverwrite` parameter from form data or query string
   - Changes:
     - Extract `allowOverwrite` boolean from formData or query params
     - Before creating transaction, check if overwrite is allowed
     - If allowed and existing transaction found, delete it first
     - Update error messages to indicate when duplicate is prevented vs overwrite
   - Lines affected: 50-66 (param extraction), 115-135 (idempotency check)

2. **`/home/pbrown/SkuInventory/src/components/features/ImportForm.tsx`**
   - Purpose: Add checkbox for "Allow Overwrite" option
   - Changes:
     - Add `allowOverwrite` state: `useState<boolean>(false)`
     - Conditionally render checkbox for `importType === 'initial-inventory'`
     - Append `allowOverwrite` to FormData when uploading
   - Pattern: Similar to file input handling (lines 47-51)
   - New UI section: Add after file upload section (after line 195)

3. **`/home/pbrown/SkuInventory/src/app/(dashboard)/import/page.tsx`** (OPTIONAL)
   - Purpose: May need to update props if we want to show overwrite warnings
   - Changes: Minimal or none - existing state management should handle it

4. **`/home/pbrown/SkuInventory/tests/unit/csv-import.test.ts`**
   - Purpose: Add unit tests for overwrite scenarios
   - New tests:
     - "should skip component with existing initial transaction when allowOverwrite=false"
     - "should replace component initial transaction when allowOverwrite=true"
     - "should maintain idempotency for new components regardless of flag"

5. **`/home/pbrown/SkuInventory/tests/e2e/initial-inventory-import.spec.ts`**
   - Purpose: Add E2E test for checkbox interaction
   - New tests:
     - "Initial Inventory form displays 'Allow Overwrite' checkbox"
     - "Checkbox is unchecked by default"
     - "Can check and uncheck the checkbox"

### Files to Reference (not modify):

- `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx` - allowInsufficientInventory pattern
- `/home/pbrown/SkuInventory/src/services/inventory.ts` - createInitialTransaction implementation
- `/home/pbrown/SkuInventory/src/components/ui/checkbox.tsx` - UI component to use

## Final Sweep Results

**Services Search**: 1 file found in src/services/
- `src/services/inventory.ts` - Contains `createInitialTransaction`, no changes needed

**API Routes**: 2 usages in src/app/api/
- `src/app/api/import/initial-inventory/route.ts` - WILL BE MODIFIED
- `src/app/api/transactions/initial/route.ts` - No changes needed (single transaction endpoint)

**Type Definitions**: 2 types affected
- `src/types/index.ts` - TransactionType includes 'initial'
- `src/types/transaction.ts` - No new types needed for this enhancement

**Components**: 3 components using 'initial-inventory' import type
- `src/app/(dashboard)/import/page.tsx` - WILL BE MODIFIED (minimal)
- `src/components/features/ImportForm.tsx` - WILL BE MODIFIED (add checkbox)
- `src/components/features/ImportResultDialog.tsx` - No changes needed

**Test Files**: 2 test files referencing initial inventory
- `tests/e2e/initial-inventory-import.spec.ts` - WILL BE MODIFIED (add checkbox tests)
- `tests/unit/csv-import.test.ts` - WILL BE MODIFIED (add overwrite tests)

**All Affected Files** (comprehensive list):
- `/home/pbrown/SkuInventory/src/app/api/import/initial-inventory/route.ts` - ADD: parameter handling, DELETE: old transaction
- `/home/pbrown/SkuInventory/src/components/features/ImportForm.tsx` - ADD: checkbox UI and state
- `/home/pbrown/SkuInventory/src/app/(dashboard)/import/page.tsx` - REVIEW: may need prop updates
- `/home/pbrown/SkuInventory/tests/unit/csv-import.test.ts` - ADD: overwrite test cases
- `/home/pbrown/SkuInventory/tests/e2e/initial-inventory-import.spec.ts` - ADD: checkbox interaction tests

## UI Visibility Requirements

**Element**: "Allow Overwrite" checkbox
**Location**: Initial Inventory import form card (third card on /import page)
**Visibility**: ALL devices (desktop and mobile)
**CSS classes to avoid**: `lg:hidden` (hides on desktop), `hidden lg:block` (hides on mobile)
**Placement**: Between file upload section and Import button

## Ripple Effect Analysis

**Function Being Changed**: None - we're adding conditional logic, not changing signatures

**API Endpoint Being Changed**: `/api/import/initial-inventory` (POST)
- Current callers: 1 (ImportForm.tsx line 102)
- New parameter: `allowOverwrite` (optional, defaults to false for backward compatibility)
- Breaking change?: NO - optional parameter maintains backward compatibility
- Direct impact: Only ImportForm.tsx needs update to pass the new flag

**Database Operations**:
- Current: `prisma.transaction.findFirst` (check) + `createInitialTransaction` (insert)
- New: Add `prisma.transaction.delete` when `allowOverwrite=true` and existing transaction found
- Cascade: TransactionLine records will auto-delete (configured in schema)

**Ripple Effect Report**:
```
API Endpoint: POST /api/import/initial-inventory
Direct Callers: 1 file
  - src/components/features/ImportForm.tsx (line 102)
Indirect Callers: 0 files
  - None (ImportForm is called by import page, but doesn't pass this data up)
TOTAL FILES AFFECTED: 5
  - 1 API route
  - 2 UI components
  - 2 test files
```

**Scope Confidence**: HIGH - This is a self-contained feature addition with minimal ripple effects

## Acceptance Criteria

From issue #44:

- [ ] Bulk import API accepts `allowOverwrite` query parameter or form field
- [ ] When `allowOverwrite=true`, existing initial transactions are replaced (deleted + recreated)
- [ ] Clear error messages differentiate between "duplicate prevented" and "overwrite in progress"
- [ ] Audit trail includes both old and new transaction IDs (logged in result messages)
- [ ] UI provides checkbox or toggle for "Allow overwrite" on import form
- [ ] Tests cover overwrite scenarios (unit + E2E)

Additional technical criteria:
- [ ] Default behavior (`allowOverwrite=false`) maintains current idempotency checks (backward compatible)
- [ ] Only affects `initial` transaction type, not receipt/adjustment/build
- [ ] Deletion uses Prisma transaction for atomicity
- [ ] No TypeScript errors
- [ ] No build warnings
- [ ] All existing tests continue to pass

## Handoff to Plan Agent

### Summary

This is a straightforward enhancement to add overwrite functionality to the initial inventory import feature. The work follows an existing pattern (`allowInsufficientInventory` in build transactions) and requires minimal changes across 5 files. The main technical challenge is ensuring atomic delete+create operations and maintaining backward compatibility. Risk is low because:

1. It's an additive feature (opt-in via checkbox)
2. Database cascade delete is already configured
3. Clear reference implementation exists (BuildDialog pattern)
4. Comprehensive test coverage can be added easily

### Key Points

1. **Pattern Exists**: The `allowInsufficientInventory` pattern in BuildDialog/build route is nearly identical - frontend checkbox, backend flag, conditional risky operation
2. **Backward Compatible**: New parameter is optional and defaults to `false`, preserving current behavior
3. **Atomic Operations**: Use Prisma transaction to wrap delete+create for data integrity
4. **UI Component Ready**: shadcn/ui checkbox already exists and used elsewhere in codebase
5. **Low Risk**: Affects only initial inventory import, isolated from other transaction types
6. **Well-Scoped**: Issue #44 came from Plan agent during issue #8, so requirements are clear and realistic

### Suggested Phases

**Phase 1: Backend Logic** (1.5 hours)
- Extract `allowOverwrite` parameter from form data
- Add delete logic before create when flag is true
- Update error messages for clarity
- Add logging for audit trail

**Phase 2: Frontend UI** (1 hour)
- Add checkbox state to ImportForm
- Conditionally render checkbox for initial-inventory type
- Append flag to FormData on submit
- Ensure checkbox is visible on all device sizes

**Phase 3: Testing** (1 hour)
- Unit tests: overwrite scenarios, idempotency preservation
- E2E tests: checkbox interaction, visual verification
- Integration test: verify old transaction deleted, new created
- Verify no impact on other import types

**Phase 4: Validation** (0.5 hours)
- Run full test suite
- Manual testing: import same data twice with/without checkbox
- Verify transaction IDs change when overwrite is used
- Check error messages are clear

## Performance Metrics

| Phase | Duration |
|-------|----------|
| Issue Parsing | 2m |
| Codebase Exploration | 15m |
| Pattern Identification | 8m |
| Report Writing | 10m |
| **Total** | **35m** |

---

**AGENT_RETURN**: scout-44-120325
