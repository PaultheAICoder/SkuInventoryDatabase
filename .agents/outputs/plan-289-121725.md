# Implementation Plan
**Generated**: 2025-12-17 04:22:06 UTC
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #289
**Estimated Build Time**: 3-4 hours
**Complexity**: Moderate

## Investigation Summary

### Request Analysis
**Type**: Bug
**Source**: GitHub Issue #289
**Priority**: High

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="csv|asin|sales"` or run full suite

### Issue Validation
**Status**: Valid
**Recent Changes**: No recent fixes to affected files (last modified in `b9c811a` - initial feature implementation)

### Current State Assessment

**Primary Bug Location**: `src/app/api/csv/upload/route.ts`
- Lines 26-33 and 229-235: Uses `prisma.userCompany.findFirst({ where: { userId, isPrimary: true }})` to get company
- This retrieves user's PRIMARY company, NOT the currently SELECTED company from session
- Result: CSV uploads always write to user's default/primary company, ignoring the company they've selected in the UI

**Affected Files with Same Bug Pattern** (all use `isPrimary: true` instead of `session.user.selectedCompanyId`):

| File | Lines | Risk Level |
|------|-------|------------|
| `src/app/api/csv/upload/route.ts` | 26-50, 229-243 | **HIGH** - Data written to wrong company |
| `src/app/api/csv/upload/[uploadId]/status/route.ts` | 28-44 | Medium - Queries wrong company's uploads |
| `src/app/api/asin-mapping/route.ts` | 55-58, 217-221 | **HIGH** - Mappings scoped to wrong company |
| `src/app/api/asin-mapping/[id]/route.ts` | 29-32 | Medium - Delete checks wrong company |
| `src/app/api/sales-daily/route.ts` | 31-34 | **HIGH** - Sales data for wrong company |

**Files NOT affected** (already use `session.user.selectedCompanyId`):
- `src/app/api/import/skus/route.ts` - correctly uses `selectedCompanyId`
- `src/app/api/import/components/route.ts` - correctly uses `selectedCompanyId`
- `src/app/api/import/initial-inventory/route.ts` - correctly uses `selectedCompanyId`
- `src/app/api/import/inventory-snapshot/route.ts` - correctly uses `selectedCompanyId`

**Files with LEGITIMATE `isPrimary` usage** (not bugs - used for user management):
- `src/app/api/users/route.ts` - Creating new users, setting primary company
- `src/app/api/users/[id]/route.ts` - User profile queries
- `src/app/api/users/[id]/companies/route.ts` - Managing user-company assignments

**Shopify integration files** - May need fixing but are in separate feature branch scope:
- `src/app/api/integrations/shopify/*.ts` - 4 files with same pattern

### Dependencies & Blockers
1. Session type includes `selectedCompanyId: string` and `selectedBrandId: string | null` (confirmed in `src/types/index.ts`)
2. Pattern for validation established in issues #287, #288 - use `error()` helper from `@/lib/api-response`
3. No database changes required
4. No new dependencies needed

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Moderate
**Effort**: 3-4 hours
**Risk**: Medium - data scoping bugs can cause cross-tenant data leakage

### Patterns Identified
**Primary Reference**: `src/app/api/transactions/drafts/route.ts` (fixed in #287)
```typescript
const selectedCompanyId = session.user.selectedCompanyId
if (!selectedCompanyId) {
  return error('No company selected. Please select a company from the sidebar.', 400)
}
```

**Secondary Reference**: `src/app/api/import/skus/route.ts` (already correct)
```typescript
// Use selected company for scoping
const selectedCompanyId = session.user.selectedCompanyId
```

### Ripple Effect Analysis
**Files Identified**: 5 files need modification
- `src/app/api/csv/upload/route.ts` - 2 handlers (GET, POST)
- `src/app/api/csv/upload/[uploadId]/status/route.ts` - 1 handler (GET)
- `src/app/api/asin-mapping/route.ts` - 2 handlers (GET, POST)
- `src/app/api/asin-mapping/[id]/route.ts` - 1 handler (DELETE)
- `src/app/api/sales-daily/route.ts` - 1 handler (GET)

**TOTAL HANDLERS AFFECTED**: 7

---

## Executive Summary

This issue fixes a tenant-scoping bug where the CSV upload and related API routes use the user's PRIMARY company (from UserCompany.isPrimary) instead of their SELECTED company from the session. This causes data to be written to and read from the wrong company when a multi-company user switches companies in the UI. The fix replaces `isPrimary` queries with `session.user.selectedCompanyId` and adds validation to reject requests when no company is selected.

---

## Phase 1: CSV Upload Routes (Primary Bug)

### Subtask 1.1: Fix POST /api/csv/upload route
**File**: `/home/pbrown/SkuInventory/src/app/api/csv/upload/route.ts`
**Pattern Reference**: `src/app/api/transactions/drafts/route.ts:26-29`
**Instructions**:

1. Add import for `error` helper at the top of the file:
```typescript
import { error } from '@/lib/api-response'
```

2. Replace lines 26-50 (the `isPrimary` company lookup and role check) with:
```typescript
    // Use selected company from session (not primary company)
    const selectedCompanyId = session.user.selectedCompanyId
    if (!selectedCompanyId) {
      return error('No company selected. Please select a company from the sidebar.', 400)
    }

    // Use selected brand from session if available
    const selectedBrandId = session.user.selectedBrandId

    // Admin or Ops only for file uploads (check via session role)
    if (session.user.role !== 'admin' && session.user.role !== 'ops') {
      return NextResponse.json(
        { error: 'Admin or Ops permission required' },
        { status: 403 }
      )
    }

    const companyId = selectedCompanyId
```

3. Update the brand validation section (around line 84-98) to prefer `selectedBrandId`:
```typescript
    // Validate brand: use form brandId, fall back to session selectedBrandId
    const effectiveBrandId = brandId || selectedBrandId
    if (effectiveBrandId) {
      const brand = await prisma.brand.findFirst({
        where: {
          id: effectiveBrandId,
          companyId,
        },
      })

      if (!brand) {
        return NextResponse.json(
          { error: 'Brand not found or does not belong to your company' },
          { status: 400 }
        )
      }
    }
```

4. Update the SyncLog creation (around line 137) to use `effectiveBrandId`:
```typescript
        metadata: {
          source,
          brandId: effectiveBrandId || brandId,
          fileType,
          dateRange: startDate && endDate ? { startDate, endDate } : undefined,
        },
```

5. Update the parseFile call (around line 157) to use `effectiveBrandId`:
```typescript
    const result = await parseFile(
      fileContent,
      {
        source: source as CsvSource,
        brandId: effectiveBrandId || brandId || undefined,
        fileType: fileType as FileType,
        ...
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] `isPrimary` query removed from POST handler
- [ ] Uses `session.user.selectedCompanyId` instead
- [ ] Uses `session.user.selectedBrandId` as fallback for brand
- [ ] Returns 400 error when no company selected
- [ ] TypeScript compiles without errors

### Subtask 1.2: Fix GET /api/csv/upload route
**File**: `/home/pbrown/SkuInventory/src/app/api/csv/upload/route.ts`
**Pattern Reference**: `src/app/api/transactions/drafts/route.ts:26-29`
**Instructions**:

1. Replace lines 229-243 (the `isPrimary` company lookup in GET handler) with:
```typescript
    // Use selected company from session
    const selectedCompanyId = session.user.selectedCompanyId
    if (!selectedCompanyId) {
      return error('No company selected. Please select a company from the sidebar.', 400)
    }

    // Admin or Ops only for file upload info (check via session role)
    if (session.user.role !== 'admin' && session.user.role !== 'ops') {
      return NextResponse.json(
        { error: 'Admin or Ops permission required' },
        { status: 403 }
      )
    }
```

**Validation Commands**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] `isPrimary` query removed from GET handler
- [ ] Uses `session.user.selectedCompanyId` instead
- [ ] Returns 400 error when no company selected
- [ ] TypeScript compiles without errors

### Subtask 1.3: Fix GET /api/csv/upload/[uploadId]/status route
**File**: `/home/pbrown/SkuInventory/src/app/api/csv/upload/[uploadId]/status/route.ts`
**Pattern Reference**: `src/app/api/transactions/drafts/route.ts:26-29`
**Instructions**:

1. Add import for `error` helper at the top:
```typescript
import { error } from '@/lib/api-response'
```

2. Replace lines 28-44 (the `isPrimary` company lookup) with:
```typescript
    // Use selected company from session
    const selectedCompanyId = session.user.selectedCompanyId
    if (!selectedCompanyId) {
      return error('No company selected. Please select a company from the sidebar.', 400)
    }

    const companyId = selectedCompanyId
```

**Validation Commands**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] `isPrimary` query removed
- [ ] Uses `session.user.selectedCompanyId` instead
- [ ] Returns 400 error when no company selected
- [ ] TypeScript compiles without errors

---

## Phase 2: ASIN Mapping Routes

### Subtask 2.1: Fix GET /api/asin-mapping route
**File**: `/home/pbrown/SkuInventory/src/app/api/asin-mapping/route.ts`
**Pattern Reference**: `src/app/api/transactions/drafts/route.ts:26-29`
**Instructions**:

1. Add import for `error` helper at the top:
```typescript
import { error } from '@/lib/api-response'
```

2. Replace lines 54-61 (the `isPrimary` company lookup in GET handler) with:
```typescript
    // Use selected company from session
    const selectedCompanyId = session.user.selectedCompanyId
    if (!selectedCompanyId) {
      return error('No company selected. Please select a company from the sidebar.', 400)
    }
```

3. Update line 65 to use `selectedCompanyId`:
```typescript
    const brands = await prisma.brand.findMany({
      where: { companyId: selectedCompanyId },
      select: { id: true, name: true },
    })
```

4. Update lines 139-142 to use `selectedCompanyId`:
```typescript
      const skus = await prisma.sKU.findMany({
        where: { companyId: selectedCompanyId },
        select: { id: true, internalCode: true, name: true },
      })
```

**Validation Commands**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] `isPrimary` query removed from GET handler
- [ ] Uses `session.user.selectedCompanyId` instead
- [ ] Brand queries scoped to selected company
- [ ] SKU queries scoped to selected company
- [ ] Returns 400 error when no company selected

### Subtask 2.2: Fix POST /api/asin-mapping route
**File**: `/home/pbrown/SkuInventory/src/app/api/asin-mapping/route.ts`
**Pattern Reference**: `src/app/api/transactions/drafts/route.ts:26-29`
**Instructions**:

1. Replace lines 217-225 (the `isPrimary` company lookup in POST handler) with:
```typescript
    // Use selected company from session
    const selectedCompanyId = session.user.selectedCompanyId
    if (!selectedCompanyId) {
      return error('No company selected. Please select a company from the sidebar.', 400)
    }

    // Only admin can create ASIN mappings (check via session role)
    if (session.user.role !== 'admin') {
      return NextResponse.json(
        { error: 'Only admins can create ASIN mappings' },
        { status: 403 }
      )
    }
```

2. Update line 236 to use `selectedCompanyId`:
```typescript
    const brand = await prisma.brand.findFirst({
      where: { id: brandId, companyId: selectedCompanyId },
    })
```

3. Update line 245 to use `selectedCompanyId`:
```typescript
    const sku = await prisma.sKU.findFirst({
      where: { id: skuId, companyId: selectedCompanyId },
    })
```

**Validation Commands**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] `isPrimary` query removed from POST handler
- [ ] Uses `session.user.selectedCompanyId` instead
- [ ] Brand and SKU validation scoped to selected company
- [ ] Returns 400 error when no company selected

### Subtask 2.3: Fix DELETE /api/asin-mapping/[id] route
**File**: `/home/pbrown/SkuInventory/src/app/api/asin-mapping/[id]/route.ts`
**Pattern Reference**: `src/app/api/transactions/drafts/route.ts:26-29`
**Instructions**:

1. Add import for `error` helper at the top:
```typescript
import { error } from '@/lib/api-response'
```

2. Replace lines 28-44 (the `isPrimary` company lookup) with:
```typescript
    // Use selected company from session
    const selectedCompanyId = session.user.selectedCompanyId
    if (!selectedCompanyId) {
      return error('No company selected. Please select a company from the sidebar.', 400)
    }

    // Only admin can delete mappings (check via session role)
    if (session.user.role !== 'admin') {
      return NextResponse.json(
        { error: 'Only admins can delete ASIN mappings' },
        { status: 403 }
      )
    }
```

3. Update line 59 to use `selectedCompanyId`:
```typescript
    if (mapping.brand.companyId !== selectedCompanyId) {
```

**Validation Commands**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] `isPrimary` query removed
- [ ] Uses `session.user.selectedCompanyId` instead
- [ ] Company validation uses selected company
- [ ] Returns 400 error when no company selected

---

## Phase 3: Sales Daily Route

### Subtask 3.1: Fix GET /api/sales-daily route
**File**: `/home/pbrown/SkuInventory/src/app/api/sales-daily/route.ts`
**Pattern Reference**: `src/app/api/transactions/drafts/route.ts:26-29`
**Instructions**:

1. Add import for `error` helper at the top:
```typescript
import { error } from '@/lib/api-response'
```

2. Replace lines 30-38 (the `isPrimary` company lookup) with:
```typescript
    // Use selected company from session
    const selectedCompanyId = session.user.selectedCompanyId
    if (!selectedCompanyId) {
      return error('No company selected. Please select a company from the sidebar.', 400)
    }
```

3. Update line 41 to use `selectedCompanyId`:
```typescript
    const brands = await prisma.brand.findMany({
      where: { companyId: selectedCompanyId },
      select: { id: true, name: true },
    })
```

**Validation Commands**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] `isPrimary` query removed
- [ ] Uses `session.user.selectedCompanyId` instead
- [ ] Brand queries scoped to selected company
- [ ] Returns 400 error when no company selected

---

## Phase 4: Build Verification

### Subtask 4.1: Full Build and Type Check
**Instructions**:
```bash
cd /home/pbrown/SkuInventory
npx tsc --noEmit
npm run build
npm run lint
```

**Completion Criteria**:
- [ ] TypeScript compiles without errors
- [ ] Build completes successfully
- [ ] No lint errors

---

## Phase 5: Testing (TARGETED)

### Subtask 5.1: Manual API Testing (Optional)
**Instructions**:
Create a simple test script or use curl to verify the fixes:

1. Test CSV upload without selected company (should return 400)
2. Test CSV upload with selected company (should work)
3. Test ASIN mapping endpoints
4. Test sales-daily endpoint

**Note**: Integration tests should be created if time permits, following the pattern in `tests/integration/drafts.test.ts` from issue #287.

**Completion Criteria**:
- [ ] Endpoints return 400 when selectedCompanyId missing
- [ ] Endpoints function correctly with valid session

---

## Summary of Deliverables

**Files Modified**: 5
| File | Changes |
|------|---------|
| `src/app/api/csv/upload/route.ts` | Replace isPrimary with selectedCompanyId in POST and GET |
| `src/app/api/csv/upload/[uploadId]/status/route.ts` | Replace isPrimary with selectedCompanyId |
| `src/app/api/asin-mapping/route.ts` | Replace isPrimary with selectedCompanyId in GET and POST |
| `src/app/api/asin-mapping/[id]/route.ts` | Replace isPrimary with selectedCompanyId in DELETE |
| `src/app/api/sales-daily/route.ts` | Replace isPrimary with selectedCompanyId |

**Files NOT Modified** (out of scope - Shopify integration):
- `src/app/api/integrations/shopify/status/route.ts`
- `src/app/api/integrations/shopify/connect/route.ts`
- `src/app/api/integrations/shopify/sync/route.ts`
- `src/app/api/integrations/shopify/disconnect/route.ts`

*Note: Shopify routes have the same bug pattern but are part of a separate feature. A follow-up issue should be created for those.*

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 through Phase 5)
2. Each file requires importing `error` from `@/lib/api-response` if not already imported
3. The pattern is consistent: replace `isPrimary` query with `session.user.selectedCompanyId`
4. Add validation check: if `!selectedCompanyId`, return `error('No company selected...', 400)`
5. Role checks can use `session.user.role` instead of querying UserCompany
6. Run `npx tsc --noEmit` after each file modification
7. Run full build after all modifications

---

## Test Strategy Note

- Use Vitest for unit tests
- Integration tests pattern available in `tests/integration/drafts.test.ts`
- Test both happy path (valid session) and error path (missing selectedCompanyId)

---

## Follow-up Issues to Create

**Issue: Fix Shopify integration routes using isPrimary instead of selectedCompanyId**
- Files affected:
  - `src/app/api/integrations/shopify/status/route.ts`
  - `src/app/api/integrations/shopify/connect/route.ts`
  - `src/app/api/integrations/shopify/sync/route.ts`
  - `src/app/api/integrations/shopify/disconnect/route.ts`
- Same fix pattern as this issue

---

## Performance Metrics

| Phase | Duration |
|-------|----------|
| Investigation | 10m |
| Validation | 3m |
| Planning | 7m |
| **Total** | **20m** |
