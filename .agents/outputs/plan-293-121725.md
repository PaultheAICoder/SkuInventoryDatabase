# Implementation Plan
**Generated**: 2025-12-17T10:30:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #293
**Estimated Build Time**: 3-4 hours
**Complexity**: Low-Medium

## Investigation Summary

### Request Analysis
**Type**: Enhancement
**Source**: GitHub Issue #293
**Priority**: Medium

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="dashboard"` or manual verification

### Issue Validation
**Status**: Valid
**Recent Changes**:
- baccb60: fix(issue #257): resolve date display showing wrong day in UI
- 11ccebb: fix(issue #256): add session loading state check to dashboard pages
- No overlap with this feature request

### Current State Assessment
- **Dashboard page**: `src/app/(dashboard)/page.tsx` - Shows recent transactions with only the first line visible
- **API**: `src/app/api/dashboard/route.ts` - Already returns full `lines` array with all transaction lines
- **Data shape**: Each transaction already includes `lines[]` with `component: {id, name}` and `quantityChange`
- **Pattern for expansion**: `BOMVersionList.tsx` provides excellent reference for inline ChevronDown/ChevronRight expansion

### Dependencies & Blockers
None identified - all required data is already returned by the API.

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Low-Medium
**Effort**: 3-4 hours
**Risk**: Low - Frontend-only change, no API modifications needed

### Patterns Identified
**Primary**: `/home/pbrown/SkuInventory/src/components/features/BOMVersionList.tsx` - ChevronDown/ChevronRight inline expansion pattern with state tracking (lines 37-48, 126-244)
**Secondary**: `/home/pbrown/SkuInventory/src/components/features/TransactionDetail.tsx` - Table layout for displaying transaction lines with component links (lines 371-426)
**Alternative**: `/home/pbrown/SkuInventory/src/components/features/ImportResultDialog.tsx` - Dialog pattern with ScrollArea for displaying lists

### Ripple Effect Analysis
**Files Identified**: 1 (frontend-only change)
- `/home/pbrown/SkuInventory/src/app/(dashboard)/page.tsx` - Main file to modify

---

## Executive Summary

This feature adds inline expandability to the Recent Transactions table on the dashboard. Currently, only the first transaction line is shown with "+N more" text that has no interactivity. The implementation will add a clickable chevron icon that expands to reveal all lines within the table row, following the existing BOMVersionList pattern. All required data is already available from the API - this is a pure frontend enhancement.

## Design Decision: Inline Expansion vs Dialog

**Chosen approach**: Inline row expansion (like BOMVersionList)

**Rationale**:
1. **No extra fetches required** - All transaction lines are already in the API response
2. **Minimal clicks** - Single click to expand, matches requirement for "minimal clicks"
3. **Context preservation** - User stays in the table context, can easily compare transactions
4. **Consistent with existing patterns** - BOMVersionList uses same pattern for expandable content
5. **UX matches issue request** - Issue specifically mentions "expander" and "without navigating away"

**Alternative considered**: Dialog modal (like ImportResultDialog) - rejected because it requires additional click to close and doesn't match the request for "inline expander".

---

## Phase 1: Add Inline Expansion to Dashboard Recent Transactions

### Subtask 1.1: Add Expanded Transaction State

**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/page.tsx`
**Pattern**: Follow `BOMVersionList.tsx` lines 37-48 for state management
**Instructions**:
1. Add import for ChevronDown and ChevronRight icons from lucide-react (line ~6 area)
2. Add state to track expanded transaction ID inside the component:
   ```typescript
   const [expandedTxId, setExpandedTxId] = useState<string | null>(null)
   ```
3. Add toggle function:
   ```typescript
   const toggleExpand = (txId: string) => {
     setExpandedTxId((prev) => (prev === txId ? null : txId))
   }
   ```

**Completion Criteria**:
- [ ] ChevronDown, ChevronRight imported from lucide-react
- [ ] `expandedTxId` state added
- [ ] `toggleExpand` function added
- [ ] TypeScript compiles without errors

### Subtask 1.2: Add Clickable Expander to Component Column

**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/page.tsx`
**Pattern**: Follow `BOMVersionList.tsx` lines 128-137 for chevron rendering
**Instructions**:
1. Locate the TableCell that displays the component name (around lines 203-217)
2. Replace the current "+N more" span with an interactive expander button that:
   - Shows ChevronRight when collapsed, ChevronDown when expanded
   - Is only visible when `tx.lines.length > 1`
   - Calls `toggleExpand(tx.id)` on click
   - Stops event propagation (so row click-through to transaction detail still works for non-expander clicks)

**Current code to replace** (lines ~203-217):
```typescript
<TableCell>
  {tx.lines[0] && (
    <Link
      href={`/components/${tx.lines[0].component.id}`}
      className="hover:underline"
    >
      {tx.lines[0].component.name}
    </Link>
  )}
  {tx.lines.length > 1 && (
    <span className="text-muted-foreground">
      {' '}
      +{tx.lines.length - 1} more
    </span>
  )}
</TableCell>
```

**New implementation**:
```typescript
<TableCell>
  <div className="flex items-center gap-1">
    {tx.lines.length > 1 && (
      <button
        onClick={(e) => {
          e.stopPropagation()
          toggleExpand(tx.id)
        }}
        className="p-0.5 hover:bg-muted rounded"
        aria-label={expandedTxId === tx.id ? 'Collapse lines' : 'Expand lines'}
      >
        {expandedTxId === tx.id ? (
          <ChevronDown className="h-4 w-4 text-muted-foreground" />
        ) : (
          <ChevronRight className="h-4 w-4 text-muted-foreground" />
        )}
      </button>
    )}
    <div>
      {tx.lines[0] && (
        <Link
          href={`/components/${tx.lines[0].component.id}`}
          className="hover:underline"
          onClick={(e) => e.stopPropagation()}
        >
          {tx.lines[0].component.name}
        </Link>
      )}
      {tx.lines.length > 1 && expandedTxId !== tx.id && (
        <span className="text-muted-foreground text-xs ml-1">
          +{tx.lines.length - 1} more
        </span>
      )}
    </div>
  </div>
</TableCell>
```

**Completion Criteria**:
- [ ] Chevron icon renders for transactions with multiple lines
- [ ] Clicking chevron toggles `expandedTxId` state
- [ ] "+N more" text only shows when collapsed
- [ ] Component link click navigates correctly (stopPropagation)
- [ ] TypeScript compiles without errors

### Subtask 1.3: Add Expanded Content Row

**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/page.tsx`
**Pattern**: Follow `BOMVersionList.tsx` lines 188-244 for expanded content, and `TransactionDetail.tsx` lines 381-425 for line display format
**Instructions**:
1. After the main TableRow for each transaction (around line 235), add a conditional expanded row
2. The expanded row should:
   - Only render when `expandedTxId === tx.id`
   - Span all 4 columns using `colSpan={4}`
   - Display all lines (not just the first) with links to components
   - Show quantity change with color coding (green positive, red negative)

**Code to add after the existing TableRow** (after line 235):
```typescript
{expandedTxId === tx.id && (
  <TableRow className="bg-muted/30">
    <TableCell colSpan={4} className="py-2">
      <div className="pl-4 space-y-1">
        <p className="text-xs text-muted-foreground font-medium mb-2">
          All items in this transaction:
        </p>
        {tx.lines.map((line, idx) => (
          <div key={idx} className="flex items-center justify-between text-sm">
            <Link
              href={`/components/${line.component.id}`}
              className="hover:underline"
              onClick={(e) => e.stopPropagation()}
            >
              {line.component.name}
            </Link>
            <span
              className={`font-mono ${
                parseFloat(line.quantityChange) >= 0
                  ? 'text-green-600'
                  : 'text-red-600'
              }`}
              suppressHydrationWarning
            >
              {parseFloat(line.quantityChange) >= 0 ? '+' : ''}
              {parseFloat(line.quantityChange).toLocaleString()}
            </span>
          </div>
        ))}
      </div>
    </TableCell>
  </TableRow>
)}
```

**Completion Criteria**:
- [ ] Expanded row renders when transaction is expanded
- [ ] All transaction lines are displayed
- [ ] Component links work correctly
- [ ] Quantity changes show correct color coding
- [ ] Expanded row has visual differentiation (bg-muted/30)
- [ ] TypeScript compiles without errors

### Subtask 1.4: Update Change Column When Expanded

**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/page.tsx`
**Instructions**:
1. Locate the "Change" TableCell (lines ~219-231)
2. When the transaction is expanded, show total count or hide the individual change since all lines are visible in expanded view

**Current code** (lines ~219-231):
```typescript
<TableCell className="text-right">
  {tx.lines[0] && (
    <span
      className={`font-mono ${
        parseFloat(tx.lines[0].quantityChange) >= 0
          ? 'text-green-600'
          : 'text-red-600'
      }`}
      suppressHydrationWarning
    >
      {parseFloat(tx.lines[0].quantityChange) >= 0 ? '+' : ''}
      {parseFloat(tx.lines[0].quantityChange).toLocaleString()}
    </span>
  )}
</TableCell>
```

**Updated code**:
```typescript
<TableCell className="text-right">
  {expandedTxId === tx.id ? (
    <span className="text-xs text-muted-foreground">
      {tx.lines.length} items
    </span>
  ) : (
    tx.lines[0] && (
      <span
        className={`font-mono ${
          parseFloat(tx.lines[0].quantityChange) >= 0
            ? 'text-green-600'
            : 'text-red-600'
        }`}
        suppressHydrationWarning
      >
        {parseFloat(tx.lines[0].quantityChange) >= 0 ? '+' : ''}
        {parseFloat(tx.lines[0].quantityChange).toLocaleString()}
      </span>
    )
  )}
</TableCell>
```

**Completion Criteria**:
- [ ] When collapsed, shows first line's quantity change
- [ ] When expanded, shows "N items" count
- [ ] TypeScript compiles without errors

---

## Phase 2: Validation and Testing

### Subtask 2.1: Run Build and TypeScript Check

**Instructions**:
```bash
cd /home/pbrown/SkuInventory
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] TypeScript compiles without errors
- [ ] Build completes successfully

### Subtask 2.2: Manual Verification in Test Environment

**Instructions**:
1. Ensure test environment is running: `http://172.16.20.50:2345`
2. Navigate to dashboard
3. Verify:
   - Transactions with single line: No chevron icon visible
   - Transactions with multiple lines: Chevron icon visible
   - Clicking chevron expands to show all lines
   - All component links work
   - Quantity colors are correct
   - Clicking row (not chevron) navigates to transaction detail
   - "View all transactions" link still works

**Completion Criteria**:
- [ ] Single-line transactions display correctly (no expander)
- [ ] Multi-line transactions show expander icon
- [ ] Expansion reveals all lines with working links
- [ ] Collapse functionality works
- [ ] Navigation to transaction detail page works
- [ ] No console errors

---

## Summary of Deliverables

**Files Created**: 0
**Files Modified**: 1
- `/home/pbrown/SkuInventory/src/app/(dashboard)/page.tsx` - Add inline expansion for transaction lines

## Handoff to Build Agent

1. Execute subtasks in exact order (1.1 -> 1.2 -> 1.3 -> 1.4 -> 2.1 -> 2.2)
2. Each subtask builds on the previous
3. Verify TypeScript compiles after each code change
4. Run full build verification in Phase 2
5. Manual test in browser against test environment

## Test Strategy Note

- Manual browser testing is primary validation for this UI feature
- No new unit tests required (frontend display logic only)
- Existing dashboard functionality must not regress

## UI Acceptance Criteria
- [ ] Expander visible on transactions with >1 line
- [ ] Expander hidden on transactions with 1 line
- [ ] Expanded view shows all lines with component links
- [ ] All screen sizes display correctly (no responsive issues - content is tabular)
- [ ] Links to components work from expanded view

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 10m |
| **Total** | **30m** |

---

## Appendix: Key Code References

### BOMVersionList Expansion Pattern (reference)
File: `/home/pbrown/SkuInventory/src/components/features/BOMVersionList.tsx`
- State management: lines 37-48
- Chevron icons: lines 133-137
- Expanded content: lines 188-244

### Dashboard Page Current State
File: `/home/pbrown/SkuInventory/src/app/(dashboard)/page.tsx`
- DashboardData interface with recentTransactions: lines 24-58
- Recent Transactions table: lines 178-250
- Transaction row rendering: lines 196-235

### API Response Shape (already complete)
File: `/home/pbrown/SkuInventory/src/app/api/dashboard/route.ts`
```typescript
recentTransactions: Array<{
  id: string
  type: string
  date: string
  createdAt: string
  createdBy: { id: string; name: string }
  lines: Array<{
    component: { id: string; name: string }
    quantityChange: string
  }>
}>
```
