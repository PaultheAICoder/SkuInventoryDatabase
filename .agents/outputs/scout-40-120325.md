# Scout Report: Implement Actual Database Integration Tests

## Request Analysis
**Type**: Enhancement
**Source**: GitHub Issue #40
**Priority**: Medium

## Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED (affects integration test suite only)
**Suggested Filter**: `--config vitest.integration.config.ts`

## Issue Validation
**Status**: Valid - Enhancement request to convert documentation-style integration tests to actual database tests
**Recent Changes**: Issue #7 (closed 2025-12-02) added comprehensive test coverage including 96 integration tests

**Note**: This is a follow-up enhancement to Issue #7, which created structural/documentation-style tests that verify API patterns but don't connect to a real database.

## Current State

### Existing Test Infrastructure
- **Unit Tests**: 198 passing tests in 13 files (under `/home/pbrown/SkuInventory/tests/unit/`)
- **Integration Tests**: 96 passing "documentation-style" tests in 5 files (under `/home/pbrown/SkuInventory/tests/integration/`)
- **E2E Tests**: 12 Playwright tests that DO connect to real database (under `/home/pbrown/SkuInventory/tests/e2e/`)

### Integration Test Files (Current Documentation-Style)
1. `/home/pbrown/SkuInventory/tests/integration/auth.test.ts` - 8 tests documenting auth requirements
2. `/home/pbrown/SkuInventory/tests/integration/tenant-scoping.test.ts` - 17 tests documenting tenant isolation
3. `/home/pbrown/SkuInventory/tests/integration/transactions.test.ts` - 21 tests documenting transaction flows
4. `/home/pbrown/SkuInventory/tests/integration/settings.test.ts` - 21 tests documenting settings behavior
5. `/home/pbrown/SkuInventory/tests/integration/import-export.test.ts` - 29 tests documenting CSV import/export

**All current integration tests**: Use `expect(true).toBe(true)` pattern - they document behavior but don't test actual implementation.

### Test Helpers & Fixtures (Already Exist)
These provide foundational pieces that can be extended:

1. **Database Utilities** (`/home/pbrown/SkuInventory/tests/helpers/db.ts`):
   - `getTestPrisma()` - Creates PrismaClient for test database
   - `cleanupTestData()` - Deletes test records in correct FK order
   - `disconnectTestDb()` - Cleanup function
   - Uses `TEST_DATABASE_URL` or falls back to `DATABASE_URL`

2. **API Test Utilities** (`/home/pbrown/SkuInventory/tests/helpers/api.ts`):
   - `TestSession` type matching NextAuth session structure
   - `createMockRequest()` - Creates mock NextRequest objects
   - `TEST_USERS` - Pre-defined test users (admin, ops, viewer)
   - `expectStatus()`, `parseResponse()` - Response assertion helpers

3. **Test Fixtures** (`/home/pbrown/SkuInventory/tests/fixtures/data.ts`):
   - `createTestComponent()` - Component factory
   - `createTestSKU()` - SKU factory
   - `createTestBOMLine()` - BOM line factory
   - `createTestReceiptTransaction()` - Transaction factory
   - `TEST_CSV` - CSV test data for import/export

### Configuration Files
1. **Vitest Config for Integration** (`/home/pbrown/SkuInventory/vitest.integration.config.ts`):
   - Environment: `node` (not jsdom)
   - Timeout: 30s for DB operations
   - Includes: `tests/integration/**/*.{test,spec}.{js,ts}`
   - Setup file: `./tests/setup.ts`

2. **CI Workflow** (`/home/pbrown/SkuInventory/.github/workflows/test.yml`):
   - PostgreSQL 15 service already configured
   - Runs migrations and seed before tests
   - Currently runs unit tests only (integration tests not in CI yet)

### Database Schema & Seed
- **Schema**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
- **Seed**: `/home/pbrown/SkuInventory/prisma/seed.ts` creates:
  - Company: "Tonsil Tech"
  - Brand: "Tonsil Tech"
  - 3 Users: admin@tonsil.tech, ops@tonsil.tech, viewer@tonsil.tech (all password: changeme123)

### Authentication Pattern (from `/home/pbrown/SkuInventory/src/app/api/components/route.ts`)
All API routes follow this pattern:
```typescript
const session = await getServerSession(authOptions)
if (!session?.user) {
  return unauthorized()
}
```

Session includes: `user.id`, `user.email`, `user.name`, `user.role`, `user.companyId`, `user.companyName`

## Dependencies & Blockers

### What Exists
- Vitest testing framework
- Prisma ORM with test database utilities
- Test database support (TEST_DATABASE_URL env var)
- Test user fixtures matching seed data
- E2E tests demonstrating real database connection patterns

### What's Missing (Must Implement)
1. **NextAuth Session Mocking**:
   - Need to mock `getServerSession()` to return test user sessions
   - Must work with different roles (admin, ops, viewer)
   - Should support tenant/company scoping

2. **Database Transaction Wrapper for Tests**:
   - Each test should run in a transaction and rollback
   - Prevents test pollution and state leakage
   - Alternative: Use `cleanupTestData()` in afterEach hooks

3. **Test Database Initialization**:
   - Setup/teardown hooks for integration test suite
   - Ensure migrations are run
   - Seed with test users if needed

4. **Route Handler Test Utilities**:
   - Helper to call API route handlers directly (not via HTTP)
   - Should inject mocked session into context
   - Pattern to convert route handler Response to testable format

**Can Proceed?**: YES - All blockers are implementation tasks within scope

## Complexity Assessment
**Complexity**: Moderate
**Effort**: 4-6 hours (as estimated in issue)
**Risk**: Low - Existing e2e tests demonstrate database connection works

### Breakdown
- Session mocking setup: 1-1.5 hours
- Database transaction/cleanup setup: 0.5-1 hour
- Convert auth.test.ts (8 tests): 0.5 hour
- Convert tenant-scoping.test.ts (17 tests): 1 hour
- Convert transactions.test.ts (21 tests): 1.5 hours
- Convert settings.test.ts (21 tests): 0.5 hour
- Convert import-export.test.ts (29 tests): 1 hour
- CI workflow updates: 0.5 hour

## Patterns to Follow

### Primary Pattern: E2E Test Database Setup
**File**: `/home/pbrown/SkuInventory/tests/e2e/full-workflow.spec.ts`
- Uses real PostgreSQL database
- Playwright's test fixture handles browser authentication
- Demonstrates actual database interactions work

### Secondary Pattern: Test Helpers
**Files**:
- `/home/pbrown/SkuInventory/tests/helpers/db.ts` - Database connection
- `/home/pbrown/SkuInventory/tests/helpers/api.ts` - Mock request creation

### API Route Pattern
**File**: `/home/pbrown/SkuInventory/src/app/api/components/route.ts`
- All routes use `getServerSession(authOptions)` for auth
- Routes return Response objects from helper functions in `/home/pbrown/SkuInventory/src/lib/api-response.ts`
- Tenant scoping via `session.user.companyId`

## Files to Create/Modify

### New Files to Create
1. `/home/pbrown/SkuInventory/tests/helpers/auth-mock.ts`
   - Mock NextAuth `getServerSession` function
   - Support different user roles and companies
   - Helper to set/clear mock session for each test

2. `/home/pbrown/SkuInventory/tests/helpers/test-context.ts`
   - Database transaction wrapper for tests
   - Setup/teardown utilities for integration test suite
   - Helper to call route handlers with mocked session

3. `/home/pbrown/SkuInventory/tests/setup.integration.ts` (optional)
   - Integration test-specific setup
   - Could replace or extend existing `tests/setup.ts`

### Files to Modify
1. `/home/pbrown/SkuInventory/tests/integration/auth.test.ts`
   - Convert 8 documentation tests to actual database tests
   - Test unauthenticated requests return 401
   - Test role-based authorization (viewer vs ops vs admin)

2. `/home/pbrown/SkuInventory/tests/integration/tenant-scoping.test.ts`
   - Convert 17 documentation tests to actual database tests
   - Create multi-tenant test data
   - Verify cross-tenant access returns 404

3. `/home/pbrown/SkuInventory/tests/integration/transactions.test.ts`
   - Convert 21 documentation tests to actual database tests
   - Test receipt/adjustment/build transactions
   - Verify inventory updates after transactions
   - Test insufficient inventory checks

4. `/home/pbrown/SkuInventory/tests/integration/settings.test.ts`
   - Convert 21 documentation tests to actual database tests
   - Test settings CRUD operations
   - Verify settings affect business logic (e.g., allowNegativeInventory)

5. `/home/pbrown/SkuInventory/tests/integration/import-export.test.ts`
   - Convert 29 documentation tests to actual database tests
   - Test CSV import creates database records
   - Test CSV export reflects database state
   - Test round-trip export/import

6. `/home/pbrown/SkuInventory/vitest.integration.config.ts`
   - May need to update setup file reference
   - May need to adjust timeout if tests are slower

7. `/home/pbrown/SkuInventory/.github/workflows/test.yml`
   - Add integration test run to CI
   - Ensure TEST_DATABASE_URL is set
   - May need to run seed before integration tests

### Files Referenced (No Changes)
- `/home/pbrown/SkuInventory/tests/helpers/db.ts` - Use existing utilities
- `/home/pbrown/SkuInventory/tests/helpers/api.ts` - Use existing utilities
- `/home/pbrown/SkuInventory/tests/fixtures/data.ts` - Use existing factories
- `/home/pbrown/SkuInventory/prisma/seed.ts` - Use existing seed data

## Final Sweep Results

**Services Search**: 6 files in `/home/pbrown/SkuInventory/src/services/`
- analytics.ts, bom.ts, analytics-export.ts, export.ts, inventory.ts, import.ts
- Integration tests will test these indirectly through API routes

**API Routes**: 8 main route files in `/home/pbrown/SkuInventory/src/app/api/`
- All use getServerSession for auth - this is what we need to mock

**Type Definitions**: Located in `/home/pbrown/SkuInventory/src/types/`
- Existing types support the test scenarios

**Components**: Not directly affected (integration tests focus on API layer)

**Test Files**: 5 integration test files to modify, 2-3 helper files to create

**All Affected Files** (comprehensive list):
- `/home/pbrown/SkuInventory/tests/integration/auth.test.ts` - Convert to DB tests
- `/home/pbrown/SkuInventory/tests/integration/tenant-scoping.test.ts` - Convert to DB tests
- `/home/pbrown/SkuInventory/tests/integration/transactions.test.ts` - Convert to DB tests
- `/home/pbrown/SkuInventory/tests/integration/settings.test.ts` - Convert to DB tests
- `/home/pbrown/SkuInventory/tests/integration/import-export.test.ts` - Convert to DB tests
- `/home/pbrown/SkuInventory/tests/helpers/auth-mock.ts` - NEW: Session mocking
- `/home/pbrown/SkuInventory/tests/helpers/test-context.ts` - NEW: DB transaction wrapper
- `/home/pbrown/SkuInventory/vitest.integration.config.ts` - Update if needed
- `/home/pbrown/SkuInventory/.github/workflows/test.yml` - Add integration test run
- `/home/pbrown/SkuInventory/package.json` - Possibly add test:integration:ci script

## Acceptance Criteria

Per Issue #40:
- [ ] Test database setup/teardown utilities implemented
- [ ] Transaction rollback between tests prevents state leakage
- [ ] Test fixtures created for common scenarios
- [ ] NextAuth getServerSession mocked for test users
- [ ] Different user roles supported (admin, ops, viewer)
- [ ] Tenant/company scoping handled in test context
- [ ] auth.test.ts: Verify unauthenticated requests return 401
- [ ] tenant-scoping.test.ts: Verify cross-tenant access returns 404
- [ ] transactions.test.ts: Verify inventory updates after transactions
- [ ] settings.test.ts: Verify settings affect business logic
- [ ] import-export.test.ts: Verify CSV import creates database records
- [ ] All 96 integration tests pass with real database connections
- [ ] CI workflow runs integration tests with database service
- [ ] Test execution time remains reasonable (<2 minutes)

## Handoff to Plan Agent

**Summary**: Issue #40 requests converting 96 existing "documentation-style" integration tests to actual database-connected tests. Currently, these tests use `expect(true).toBe(true)` to document expected behavior. The goal is to make them execute real API calls against a test database, catching bugs that mocks don't reveal. The infrastructure already exists (test helpers, fixtures, database utilities, CI with PostgreSQL service), but we need to implement NextAuth session mocking and database transaction wrappers to enable actual integration testing.

**Key Points**:
1. 96 existing integration tests across 5 files need conversion from documentation to implementation
2. Test infrastructure is 80% complete - missing only session mocking and transaction wrappers
3. E2E tests demonstrate the database connection pattern works
4. All API routes follow consistent `getServerSession(authOptions)` pattern
5. Test database, seed data, and CI PostgreSQL service already configured
6. Risk is low - we're enhancing existing passing tests, not replacing them
7. Estimated 4-6 hours effort as per issue

**Suggested Phases**:
1. **Phase 1: Foundation** - Create session mocking utilities and database transaction wrapper
2. **Phase 2: Auth Tests** - Convert auth.test.ts (simplest, 8 tests) to validate approach
3. **Phase 3: Tenant Tests** - Convert tenant-scoping.test.ts (17 tests) to test multi-tenancy
4. **Phase 4: Transaction Tests** - Convert transactions.test.ts (21 tests) for inventory math
5. **Phase 5: Settings Tests** - Convert settings.test.ts (21 tests) for business logic
6. **Phase 6: Import/Export Tests** - Convert import-export.test.ts (29 tests) for CSV flows
7. **Phase 7: CI Integration** - Update workflow to run integration tests in CI

## Performance Metrics

| Phase | Duration |
|-------|----------|
| Issue Parsing | 2m |
| Codebase Exploration | 8m |
| Pattern Identification | 5m |
| Report Writing | 6m |
| **Total** | **21m** |

---

AGENT_RETURN: scout-40-120325
