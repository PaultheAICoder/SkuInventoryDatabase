# Implementation Plan

**Generated**: 2026-01-09
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #404
**Estimated Build Time**: 4-6 hours
**Complexity**: Medium

---

## Investigation Summary

### Request Analysis
**Type**: Enhancement
**Source**: GitHub Issue #404
**Priority**: P2 (from labels)

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="brand|location"` or None

### Issue Validation
**Status**: Valid
**Recent Changes**: No recent commits affecting brand default location functionality

### Current State Assessment
- **Existing Components**:
  - Brand model in Prisma schema - NO defaultLocationId field
  - BrandForm component - only supports name and isActive fields
  - Brand API routes - GET, POST, PATCH, DELETE without defaultLocationId
  - Transaction dialogs (ReceiptDialog, BuildDialog, AdjustmentDialog, etc.) - fetch locations but don't pre-select based on brand
- **Database**: Migration needed to add `defaultLocationId` to Brand model
- **API Routes**: `/api/brands`, `/api/brands/[id]` need updates
- **Types**: `src/types/brand.ts` needs schema and type updates

### Dependencies & Blockers
1. None - Locations feature already exists
2. Brand model relation to Location is straightforward

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Moderate
**Effort**: 4-6 hours
**Risk**: Low - isolated changes, existing patterns to follow

### Patterns Identified
**Primary**: `src/app/api/locations/route.ts` - API route pattern with query params
**Secondary**: `src/services/location.ts` - Service functions for default location handling
**Frontend Pattern**: `src/components/features/BrandForm.tsx` - Form with Select components

### Ripple Effect Analysis
**Files Identified**: 12 files need modification

| File | Why Affected |
|------|--------------|
| `prisma/schema.prisma` | Add defaultLocationId to Brand model |
| `src/types/brand.ts` | Update schemas and response types |
| `src/app/api/brands/route.ts` | Include defaultLocationId in create/list |
| `src/app/api/brands/[id]/route.ts` | Include defaultLocationId in get/update |
| `src/components/features/BrandForm.tsx` | Add default location selector |
| `src/components/features/ReceiptDialog.tsx` | Pre-select brand's default location |
| `src/components/features/BuildDialog.tsx` | Pre-select brand's default location |
| `src/components/features/AdjustmentDialog.tsx` | Pre-select brand's default location |
| `src/components/features/FinishedGoodsReceiptDialog.tsx` | Pre-select brand's default location |
| `src/components/features/FinishedGoodsAdjustmentDialog.tsx` | Pre-select brand's default location |
| `src/lib/auth.ts` | Include defaultLocationId in session brand data |
| `src/types/index.ts` | Update session type declarations |

---

## Executive Summary

This feature adds a "Default Location" setting to each brand. When users create transactions (receipts, builds, adjustments), the location dropdown will pre-select the brand's configured default location, reducing manual selection. The implementation requires:
1. Database migration to add the defaultLocationId field with FK to Location
2. API updates to support getting/setting the default location
3. BrandForm UI update with location selector
4. Transaction dialog updates to fetch and pre-select brand's default location from session

---

## Phase 1: Database Layer

### Subtask 1.1: Update Prisma Schema
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Pattern**: Follow existing FK patterns (e.g., `companyId` on Brand)
**Instructions**:
1. Add `defaultLocationId` optional field to Brand model
2. Add `defaultLocation` relation to Location model
3. Add reverse relation on Location model for brands using it as default

**Schema Changes**:
```prisma
model Brand {
  // ... existing fields ...
  defaultLocationId String?
  defaultLocation   Location? @relation("BrandDefaultLocation", fields: [defaultLocationId], references: [id])
  // ... existing relations ...
}

model Location {
  // ... existing relations ...
  brandsWithDefault Brand[] @relation("BrandDefaultLocation")
}
```

4. Run migration:
```bash
DATABASE_URL="postgresql://inventory_test:inventory_test_2025@localhost:2346/inventory_test" npx prisma migrate dev --name add_brand_default_location
```

**Completion Criteria**:
- [ ] Migration file created
- [ ] Migration runs successfully on test database
- [ ] `npx prisma generate` completes without errors
- [ ] Brand model has defaultLocationId and defaultLocation relation

---

## Phase 2: Types Layer

### Subtask 2.1: Update Brand Types
**File**: `/home/pbrown/SkuInventory/src/types/brand.ts`
**Pattern**: Follow existing schema patterns in file
**Instructions**:

1. Update `createBrandSchema` to include optional defaultLocationId:
```typescript
export const createBrandSchema = z.object({
  name: z.string().min(1, 'Name is required').max(100, 'Name must be 100 characters or less'),
  defaultLocationId: z.string().uuid('Invalid location ID').nullable().optional(),
})
```

2. Update `updateBrandSchema`:
```typescript
export const updateBrandSchema = z.object({
  name: z.string().min(1, 'Name is required').max(100).optional(),
  isActive: z.boolean().optional(),
  defaultLocationId: z.string().uuid('Invalid location ID').nullable().optional(),
})
```

3. Update `BrandResponse` interface:
```typescript
export interface BrandResponse {
  id: string
  name: string
  isActive: boolean
  companyId?: string
  companyName?: string
  componentCount: number
  skuCount: number
  defaultLocationId: string | null
  defaultLocationName: string | null
  createdAt: string
  updatedAt: string
}
```

**Completion Criteria**:
- [ ] Schemas updated with defaultLocationId
- [ ] BrandResponse type includes defaultLocationId and defaultLocationName
- [ ] `npx tsc --noEmit` passes

### Subtask 2.2: Update Session Types
**File**: `/home/pbrown/SkuInventory/src/lib/auth.ts`
**Pattern**: Follow existing session type extensions
**Instructions**:

1. Update the brand type in User interface to include defaultLocationId:
```typescript
// In 'next-auth' module augmentation
interface User {
  // ... existing fields ...
  brands: Array<{ id: string; name: string; defaultLocationId: string | null }>
  // ...
}
```

2. Update companiesWithBrands brand shape similarly:
```typescript
companiesWithBrands: Array<{
  id: string
  name: string
  role?: string
  brands: Array<{ id: string; name: string; defaultLocationId: string | null }>
}>
```

3. Update JWT interface similarly

4. Update authorize callback to fetch defaultLocationId when fetching brands

5. Update session callback to include defaultLocationId

**Completion Criteria**:
- [ ] Session includes defaultLocationId for each brand
- [ ] TypeScript compiles without errors
- [ ] Auth flow still works

---

## Phase 3: API Routes

### Subtask 3.1: Update Brand List Route
**File**: `/home/pbrown/SkuInventory/src/app/api/brands/route.ts`
**Pattern**: Follow existing select patterns
**Instructions**:

1. In GET handler, update select to include defaultLocation:
```typescript
select: {
  id: true,
  name: true,
  isActive: true,
  companyId: true,
  defaultLocationId: true,
  defaultLocation: {
    select: { id: true, name: true }
  },
  company: { select: { id: true, name: true } },
  // ... rest
}
```

2. Update response mapping to include defaultLocationId and defaultLocationName

3. In POST handler, accept defaultLocationId in create data:
```typescript
const { name, defaultLocationId } = validation.data

// Verify location belongs to company if provided
if (defaultLocationId) {
  const location = await prisma.location.findFirst({
    where: { id: defaultLocationId, companyId: selectedCompanyId, isActive: true }
  })
  if (!location) {
    return NextResponse.json({ error: 'Invalid location' }, { status: 400 })
  }
}

// Create brand
const brand = await prisma.brand.create({
  data: {
    companyId: selectedCompanyId,
    name,
    defaultLocationId: defaultLocationId || null,
  },
  // ... select
})
```

**Completion Criteria**:
- [ ] GET returns defaultLocationId and defaultLocationName
- [ ] POST accepts and validates defaultLocationId
- [ ] Invalid location IDs are rejected

### Subtask 3.2: Update Brand Detail Route
**File**: `/home/pbrown/SkuInventory/src/app/api/brands/[id]/route.ts`
**Pattern**: Follow existing GET/PATCH patterns
**Instructions**:

1. In GET handler, include defaultLocation in select:
```typescript
select: {
  id: true,
  name: true,
  isActive: true,
  defaultLocationId: true,
  defaultLocation: {
    select: { id: true, name: true }
  },
  // ... rest
}
```

2. In PATCH handler, accept and validate defaultLocationId:
- Accept `defaultLocationId` from request body (can be null to clear)
- Validate location belongs to company if provided
- Include in update data

3. Update response mappings in both handlers

**Completion Criteria**:
- [ ] GET returns defaultLocationId and defaultLocationName
- [ ] PATCH accepts defaultLocationId (including null to clear)
- [ ] Invalid location IDs are rejected

---

## Phase 4: Frontend - Brand Settings

### Subtask 4.1: Update BrandForm Component
**File**: `/home/pbrown/SkuInventory/src/components/features/BrandForm.tsx`
**Pattern**: Follow existing Select component usage in the codebase
**Instructions**:

1. Add state for locations and loading:
```typescript
const [locations, setLocations] = useState<Array<{ id: string; name: string }>>([])
const [isLoadingLocations, setIsLoadingLocations] = useState(false)
```

2. Add defaultLocationId to formData:
```typescript
const [formData, setFormData] = useState({
  name: brand?.name ?? '',
  isActive: brand?.isActive ?? true,
  defaultLocationId: brand?.defaultLocationId ?? '',
})
```

3. Add useEffect to fetch locations on mount:
```typescript
useEffect(() => {
  fetchLocations()
}, [])

const fetchLocations = async () => {
  setIsLoadingLocations(true)
  try {
    const res = await fetch('/api/locations?isActive=true&pageSize=50')
    if (res.ok) {
      const data = await res.json()
      setLocations(data.data || [])
    }
  } catch (err) {
    console.error('Failed to fetch locations:', err)
  } finally {
    setIsLoadingLocations(false)
  }
}
```

4. Add Select component for default location:
```tsx
<div className="space-y-2">
  <Label htmlFor="defaultLocation">Default Location</Label>
  <Select
    value={formData.defaultLocationId}
    onValueChange={(value) => setFormData((prev) => ({ ...prev, defaultLocationId: value }))}
    disabled={isLoadingLocations}
  >
    <SelectTrigger>
      <SelectValue placeholder={isLoadingLocations ? 'Loading...' : 'No default location'} />
    </SelectTrigger>
    <SelectContent>
      <SelectItem value="">No default location</SelectItem>
      {locations.map((loc) => (
        <SelectItem key={loc.id} value={loc.id}>
          {loc.name}
        </SelectItem>
      ))}
    </SelectContent>
  </Select>
  <p className="text-xs text-muted-foreground">
    This location will be pre-selected when creating transactions for this brand.
  </p>
</div>
```

5. Include defaultLocationId in submit body:
```typescript
const body: Record<string, unknown> = {
  name: formData.name,
  defaultLocationId: formData.defaultLocationId || null,
}
```

6. Add necessary imports: `Select`, `SelectContent`, `SelectItem`, `SelectTrigger`, `SelectValue`, `Label`, `useEffect`, `useState`

**Completion Criteria**:
- [ ] Default location dropdown shows all active locations
- [ ] Current default location is pre-selected when editing
- [ ] "No default location" option clears the default
- [ ] Saving brand updates the defaultLocationId
- [ ] UI compiles and renders correctly

---

## Phase 5: Frontend - Transaction Dialogs

### Design Decision: How to Get Brand's Default Location

**Option A**: Fetch brand details when dialog opens (extra API call)
**Option B**: Include defaultLocationId in session brand data (no extra API call)

**Chosen**: Option A - simpler implementation, no session changes needed. The dialogs already make API calls when opening.

### Subtask 5.1: Create Helper Function
**File**: `/home/pbrown/SkuInventory/src/lib/brand-utils.ts` (NEW FILE)
**Instructions**:

Create a new utility file:
```typescript
/**
 * Fetch the default location ID for a given brand
 */
export async function fetchBrandDefaultLocation(brandId: string): Promise<string | null> {
  try {
    const res = await fetch(`/api/brands/${brandId}`)
    if (!res.ok) return null
    const data = await res.json()
    return data?.data?.defaultLocationId ?? null
  } catch {
    return null
  }
}
```

**Completion Criteria**:
- [ ] Utility file created
- [ ] Function fetches and returns defaultLocationId or null

### Subtask 5.2: Update ReceiptDialog
**File**: `/home/pbrown/SkuInventory/src/components/features/ReceiptDialog.tsx`
**Pattern**: Follow existing fetchLocations pattern
**Instructions**:

1. Add prop for brandId (the component dialog is opened for a component which belongs to a brand):
```typescript
interface ReceiptDialogProps {
  // ... existing props ...
  brandId?: string // Pass from parent when known
}
```

2. Update useEffect to fetch brand default location and pre-select:
```typescript
useEffect(() => {
  if (open) {
    fetchLocations()
    if (brandId) {
      fetchBrandDefaultLocation(brandId).then((defaultLocId) => {
        if (defaultLocId) {
          setFormData((prev) => ({ ...prev, locationId: defaultLocId }))
        }
      })
    }
  }
}, [open, brandId])
```

3. Import the helper function

**Note**: The brandId may need to be passed from parent components. Check ComponentTable.tsx to see how ReceiptDialog is invoked and ensure brandId is available.

**Completion Criteria**:
- [ ] If brandId provided and has default location, it's pre-selected
- [ ] User can still change location
- [ ] Falls back gracefully if no default set

### Subtask 5.3: Update AdjustmentDialog
**File**: `/home/pbrown/SkuInventory/src/components/features/AdjustmentDialog.tsx`
**Pattern**: Same as ReceiptDialog
**Instructions**: Same pattern as Subtask 5.2

**Completion Criteria**:
- [ ] Same as Subtask 5.2

### Subtask 5.4: Update BuildDialog
**File**: `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx`
**Pattern**: Same approach, but BuildDialog works with SKUs
**Instructions**:

BuildDialog works with SKUs, not components. SKUs belong to brands.

1. The dialog already has a SKU selector. When a SKU is selected, we can look up its brand.
2. Modify the SKU fetching to include brandId, then fetch brand default location when SKU is selected.

Alternative simpler approach: Add a prop for the current brand's default location from the parent component that already knows the selected brand.

The component table pages know the selected brand. Pass the brand's defaultLocationId as a prop.

**Completion Criteria**:
- [ ] Build dialog pre-selects brand's default location
- [ ] User can still change location

### Subtask 5.5: Update FinishedGoodsReceiptDialog
**File**: `/home/pbrown/SkuInventory/src/components/features/FinishedGoodsReceiptDialog.tsx`
**Pattern**: Same approach
**Instructions**:

1. Add brandId prop
2. Fetch and pre-select brand's default location when dialog opens

**Completion Criteria**:
- [ ] Same as other dialogs

### Subtask 5.6: Update FinishedGoodsAdjustmentDialog
**File**: `/home/pbrown/SkuInventory/src/components/features/FinishedGoodsAdjustmentDialog.tsx`
**Pattern**: Same approach
**Instructions**: Same as Subtask 5.5

**Completion Criteria**:
- [ ] Same as other dialogs

---

## Phase 6: Update Parent Components to Pass brandId

### Subtask 6.1: Trace Dialog Usage and Update Props
**Instructions**:

Search for where each dialog is used and ensure brandId is passed:

```bash
grep -r "ReceiptDialog\|AdjustmentDialog\|BuildDialog\|FinishedGoodsReceiptDialog\|FinishedGoodsAdjustmentDialog" --include="*.tsx" src/
```

Key files likely needing updates:
- `src/components/features/ComponentTable.tsx` - uses ReceiptDialog, AdjustmentDialog
- `src/components/features/SKUTable.tsx` - uses BuildDialog, FinishedGoodsReceiptDialog, FinishedGoodsAdjustmentDialog
- `src/app/(dashboard)/skus/[id]/page.tsx` - may use dialogs

For each usage, ensure the brandId is available (usually from the component/SKU data or from session.user.selectedBrandId).

**Completion Criteria**:
- [ ] All dialog usages pass brandId where available
- [ ] Dialogs gracefully handle missing brandId

---

## Phase 7: Validation

### Subtask 7.1: Build and Type Check
**Instructions**:
```bash
npm run build
npx tsc --noEmit
npm run lint
```

**Completion Criteria**:
- [ ] Build passes
- [ ] TypeScript compiles without errors
- [ ] Lint passes

### Subtask 7.2: Manual Testing Checklist
**Instructions**:

Test on test environment (http://172.16.20.50:2345):

1. Brand Settings:
   - [ ] Navigate to Settings > Brands
   - [ ] Edit a brand, verify default location dropdown appears
   - [ ] Set a default location, save
   - [ ] Re-open brand edit, verify default location is shown
   - [ ] Set to "No default location", save
   - [ ] Verify the change persists

2. Transaction Dialogs:
   - [ ] Navigate to Components page
   - [ ] Open Receipt dialog for a component
   - [ ] Verify brand's default location is pre-selected
   - [ ] Verify you can still change the location
   - [ ] Open Adjustment dialog, verify same behavior

3. Build Dialog:
   - [ ] Navigate to SKUs page
   - [ ] Open Build dialog
   - [ ] Verify brand's default location is pre-selected after selecting an SKU

4. Finished Goods Dialogs:
   - [ ] Open Finished Goods Receipt dialog
   - [ ] Verify location pre-selection

5. Edge Cases:
   - [ ] Brand with no default location set - should show placeholder
   - [ ] Switching brands - verify correct default location used

**Completion Criteria**:
- [ ] All manual test cases pass

---

## Summary of Deliverables

**Files Created**: 2
- `prisma/migrations/YYYYMMDDHHMMSS_add_brand_default_location/migration.sql`
- `src/lib/brand-utils.ts` (helper function)

**Files Modified**: 10
- `prisma/schema.prisma` - Brand model + Location relation
- `src/types/brand.ts` - Schemas and types
- `src/app/api/brands/route.ts` - GET/POST with defaultLocationId
- `src/app/api/brands/[id]/route.ts` - GET/PATCH with defaultLocationId
- `src/components/features/BrandForm.tsx` - Location selector
- `src/components/features/ReceiptDialog.tsx` - Pre-select location
- `src/components/features/AdjustmentDialog.tsx` - Pre-select location
- `src/components/features/BuildDialog.tsx` - Pre-select location
- `src/components/features/FinishedGoodsReceiptDialog.tsx` - Pre-select location
- `src/components/features/FinishedGoodsAdjustmentDialog.tsx` - Pre-select location

---

## Test Strategy Note

- Use Vitest for unit tests (if adding)
- Manual testing on test environment (http://172.16.20.50:2345)
- Test database: inventory_test on port 2346

---

## Performance Metrics

| Phase | Estimated Duration |
|-------|-------------------|
| Investigation | 25m |
| Validation | 5m |
| Planning | 15m |
| **Total Scout-Plan** | **45m** |

---

## Notes

1. The issue mentions "default location" is different from the company-level default location (`Location.isDefault`). Brand default location is per-brand and optional.

2. The session currently stores brand info including `id` and `name`. We could optionally add `defaultLocationId` to the session to avoid an extra API call, but the simpler approach is to fetch it when needed.

3. Transaction dialogs are used in multiple places. The Build agent should verify all usage sites to ensure brandId is available and passed correctly.
