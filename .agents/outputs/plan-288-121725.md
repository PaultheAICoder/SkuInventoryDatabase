# Implementation Plan
**Generated**: 2025-12-17T03:15:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #288
**Estimated Build Time**: 2-3 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Bug (Security)
**Source**: GitHub Issue #288
**Priority**: High (Security vulnerability - tenant data exposure)

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED
**Suggested Filter**: `--testPathPattern="brands"` or `--grep="brands"`

### Issue Validation
**Status**: Valid
**Recent Changes**:
- `6861a69` feat(issue #160): add brand association editing to company edit page
- `6d85490` feat(issue #124): add brand management admin page

Both commits added the `?all=true` functionality intentionally for the company edit page brand association feature, but without proper authorization controls.

### Current State Assessment

**Existing components:**
- `/src/app/api/brands/route.ts` - Contains vulnerable `?all=true` bypass (lines 35-45)
- `/src/app/(dashboard)/settings/companies/[id]/edit/page.tsx` - Uses `?all=true` to fetch all brands for editing (line 35)
- `/src/components/features/CompanyForm.tsx` - Consumes all brands for brand association editing
- `/tests/e2e/company-brand-edit.spec.ts` - E2E test that uses `?all=true` endpoint (lines 112-129)

**Database:** No changes needed - models exist, no migrations required

**API Routes:** `/api/brands/route.ts` needs authorization fix

**Types:** `/src/types/brand.ts` - `brandListQuerySchema` may need update for `all` param validation

### Dependencies & Blockers

1. **No super-admin role exists**: The application currently has only three roles: `admin`, `ops`, `viewer`. There is no super-admin or system-admin role that could legitimately access cross-tenant data.

2. **Legitimate use case exists**: The company edit page (`/settings/companies/[id]/edit/page.tsx`) uses `?all=true` to allow admins to reassign brands between companies. This feature was added in issue #160.

3. **Multi-company access model**: Users can belong to multiple companies via `UserCompany` junction table. An admin user can only access brands from companies they are assigned to.

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Simple
**Effort**: 2-3 hours
**Risk**: Low (clear fix pattern, limited scope)

### Patterns Identified

**Primary Reference**: `/src/lib/auth.ts:validateCompanyAccess()` (lines 378-382)
- Pattern for validating company access via session.user.companies array

**Secondary Reference**: `/src/app/api/companies/switch/route.ts`
- Pattern for multi-company scoped operations

### Ripple Effect Analysis

**Files Identified**: 4 files total

1. `/src/app/api/brands/route.ts` - Main fix location (MODIFY)
2. `/src/app/(dashboard)/settings/companies/[id]/edit/page.tsx` - May need adjustment if API response changes (VERIFY)
3. `/src/types/brand.ts` - May need schema update (OPTIONAL)
4. `/tests/e2e/company-brand-edit.spec.ts` - Test needs to work with updated behavior (VERIFY)

### Pattern Detection - Similar Bugs Across Files

**Pattern scan for `all=true` bypass:**
```bash
grep -r "all=true\|showAll" --include="*.ts" src/app/api/
```

**Results:**
- `/src/app/api/brands/route.ts` - AFFECTED (this issue)
- No other API routes have this pattern

**Pattern scan for empty where clause initialization:**
```bash
grep -r "where:.*\{\}|where.*=.*\{\}" --include="*.ts" src/app/api/
```

**Results:**
- `/src/app/api/companies/route.ts` - Intentionally unscoped (global company view for admins)
- `/src/app/api/sync-logs/route.ts` - Has proper scoping applied later
- `/src/app/api/brands/route.ts` - AFFECTED (this issue)

The companies route is intentionally unscoped because it's for company management (different from cross-tenant brand listing). The brands route is the only problematic endpoint.

---

## Executive Summary

Fix the authorization bypass in GET /api/brands where `?all=true` allows any admin to retrieve brands from all companies regardless of their assigned companies. The fix will restrict the `all=true` mode to only return brands from companies the requesting user has access to (via `UserCompany` assignments), rather than removing the feature entirely which would break the legitimate company edit brand association workflow.

## Phase 1: Fix Authorization Bypass

### Subtask 1.1: Update Brands Route Authorization Logic
**File**: `/home/pbrown/SkuInventory/src/app/api/brands/route.ts`
**Pattern**: Follow `validateCompanyAccess` pattern from `/src/lib/auth.ts`
**Instructions**:

1. Replace the current `showAll` logic (lines 34-45) with company-scoped query:

Current code (VULNERABLE):
```typescript
// Check for admin "all brands" mode
const showAll = request.nextUrl.searchParams.get('all') === 'true'

// Use selected company for scoping (unless showing all)
const selectedCompanyId = session.user.selectedCompanyId

// Build where clause - only scope by company if NOT showing all
const where: Prisma.BrandWhereInput = {}

if (!showAll) {
  where.companyId = selectedCompanyId
}
```

Replace with (SECURE):
```typescript
// Check for admin "all accessible brands" mode
const showAll = request.nextUrl.searchParams.get('all') === 'true'

// Use selected company for scoping
const selectedCompanyId = session.user.selectedCompanyId

// Get all company IDs this user has access to
const accessibleCompanyIds = session.user.companies.map(c => c.id)

// Build where clause - always scope to accessible companies
const where: Prisma.BrandWhereInput = {}

if (showAll) {
  // Return brands from ALL companies user has access to (not just selected)
  where.companyId = { in: accessibleCompanyIds }
} else {
  // Return brands from selected company only
  where.companyId = selectedCompanyId
}
```

2. Update the comment at line 9:
```typescript
// GET /api/brands - List brands (admin only)
// Supports ?all=true to return brands from all companies the user has access to
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
npm run lint
```

**Completion Criteria**:
- [ ] TypeScript compiles without errors
- [ ] Build passes
- [ ] Lint passes
- [ ] `?all=true` only returns brands from user's accessible companies
- [ ] Regular brand listing (without `?all=true`) still works as before

### Subtask 1.2: Verify Type Schema (Optional Enhancement)
**File**: `/home/pbrown/SkuInventory/src/types/brand.ts`
**Instructions**:

Optionally add `all` parameter to `brandListQuerySchema` for explicit validation (lines 18-29):

Add to the schema:
```typescript
export const brandListQuerySchema = z.object({
  page: z.coerce.number().int().positive().default(1),
  pageSize: z.coerce.number().int().positive().max(100).default(50),
  search: z.string().optional(),
  isActive: z
    .string()
    .transform((val) => val === 'true')
    .optional(),
  sortBy: z.enum(['name', 'createdAt']).default('name'),
  sortOrder: z.enum(['asc', 'desc']).default('asc'),
  all: z  // Add this
    .string()
    .transform((val) => val === 'true')
    .optional(),
})
```

Then update the route to use validated `all` parameter:
```typescript
const { page, pageSize, search, isActive, sortBy, sortOrder, all: showAll } = validation.data
```

**Note**: This subtask is optional. The existing implementation reads `all` directly from query params which works, but explicit schema validation is cleaner.

**Completion Criteria**:
- [ ] If implemented: Schema validates `all` parameter
- [ ] TypeScript compiles without errors

## Phase 2: Verification

### Subtask 2.1: Manual API Testing
**Instructions**:

1. Start the test environment if not running:
```bash
cd /home/pbrown/SkuInventory/docker && docker compose -f docker-compose.test.yml up -d
```

2. Log in as a test admin user with limited company access

3. Test the endpoint:
```bash
# Without all=true - should return brands from selected company only
curl -X GET "http://172.16.20.50:2345/api/brands" -H "Cookie: next-auth.session-token=..."

# With all=true - should return brands only from accessible companies
curl -X GET "http://172.16.20.50:2345/api/brands?all=true" -H "Cookie: next-auth.session-token=..."
```

4. Verify that brands from non-accessible companies are NOT returned

**Completion Criteria**:
- [ ] `?all=true` only returns brands from user's accessible companies
- [ ] Response does not include brands from other tenants
- [ ] Company edit page still works (brands appear in selector)

### Subtask 2.2: E2E Test Verification
**File**: `/home/pbrown/SkuInventory/tests/e2e/company-brand-edit.spec.ts`
**Instructions**:

1. Run the existing E2E test to ensure it still passes:
```bash
TEST_BASE_URL=http://172.16.20.50:2345 npx playwright test tests/e2e/company-brand-edit.spec.ts
```

2. The test at line 112 (`API brands endpoint supports all=true parameter`) should still pass since the test user (admin@tonsil.tech) should have access to test companies.

3. If test fails, verify test user has proper company assignments.

**Completion Criteria**:
- [ ] E2E tests pass
- [ ] No test modifications needed (expected behavior maintained for authorized users)

## Phase 3: Security Event Logging (Optional Enhancement)

### Subtask 3.1: Add Security Logging for Cross-Company Brand Access
**File**: `/home/pbrown/SkuInventory/src/app/api/brands/route.ts`
**Pattern**: Follow `logSecurityEvent` from `/src/lib/auth.ts`
**Instructions**:

Optionally add security logging when `all=true` is used:

```typescript
import { logSecurityEvent, SECURITY_EVENTS } from '@/lib/auth'

// Inside GET handler, after showAll check:
if (showAll) {
  // Log cross-company brand access (async, non-blocking)
  logSecurityEvent({
    companyId: selectedCompanyId,
    userId: session.user.id,
    eventType: 'cross_company_brand_access',
    details: {
      accessibleCompanies: accessibleCompanyIds.length,
    },
  }).catch(() => {}) // Non-blocking
}
```

**Note**: This subtask is optional but recommended for audit trail purposes.

**Completion Criteria**:
- [ ] If implemented: Security events logged for `all=true` access
- [ ] Non-blocking (uses fire-and-forget pattern)

---

## Summary of Deliverables

**Files Modified**: 1-2 files
- `/src/app/api/brands/route.ts` (REQUIRED)
- `/src/types/brand.ts` (OPTIONAL)

**Files Verified**: 2 files
- `/src/app/(dashboard)/settings/companies/[id]/edit/page.tsx`
- `/tests/e2e/company-brand-edit.spec.ts`

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 -> Phase 2 -> Phase 3)
2. Subtask 1.1 is REQUIRED; 1.2 and 3.1 are optional enhancements
3. Test completion criteria before next subtask
4. Run validation commands after each file change

## Test Strategy Note

- Use Vitest for unit tests (if new tests needed)
- Run existing E2E tests via Playwright against test environment (port 2345)
- Manual API testing recommended to verify security fix

## Security Fix Verification Checklist

- [ ] `GET /api/brands?all=true` only returns brands from `session.user.companies`
- [ ] Users cannot see brands from companies they don't belong to
- [ ] Company edit page brand association still works
- [ ] E2E tests pass without modification
- [ ] No TypeScript or build errors

## Performance Metrics

| Phase | Duration |
|-------|----------|
| Investigation | 8m |
| Validation | 3m |
| Planning | 6m |
| **Total** | **17m** |
