# Implementation Plan
**Generated**: 2025-12-04 16:55 UTC
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #148
**Estimated Build Time**: 2-3 hours
**Complexity**: Medium

## Investigation Summary

### Request Analysis
**Type**: Bug
**Source**: GitHub Issue #148
**Priority**: High - Core feature broken, user cannot access components

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="auth|session|components"`

### Issue Validation
**Status**: Valid
**Recent Changes**:
- `4d2ae49` feat(issue #73): add location-based filtering to UI pages
- `dbdc5e0` feat(issue #96): update data queries to scope by selected company
- These changes added dependency on `selectedCompanyId` but didn't add defensive handling

### Current State Assessment

**Root Cause Identified**:
The `session.user.selectedCompanyId` is **undefined** when passed to `getCompanySettings()`, causing a Prisma validation error:

```
Invalid `prisma.company.findUnique()` invocation:
{
  where: {
    id: undefined,  // <-- THIS IS THE PROBLEM
    ...
  }
}
Argument `where` of type CompanyWhereUniqueInput needs at least one of `id` or `name` arguments.
```

**Error Chain**:
1. User navigates to `/components`
2. `ComponentsPage` gets session via `getServerSession(authOptions)`
3. `session.user.selectedCompanyId` is undefined (stale JWT token)
4. `getComponents(selectedCompanyId, {...})` is called with undefined
5. `getCompanySettings(companyId)` receives undefined
6. Prisma throws validation error: `id: undefined` is invalid
7. Server Component render fails with error #423

**Why `selectedCompanyId` is undefined**:
- The JWT callback in `src/lib/auth.ts` only sets `token.selectedCompanyId` during initial sign-in (`if (user) {...}`)
- For existing JWT tokens from before `selectedCompanyId` was added, there's no fallback logic
- The `session` callback casts potentially undefined values: `token.selectedCompanyId as string`

### Dependencies & Blockers
1. **None** - This is a self-contained fix in auth logic

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Simple to Moderate
**Effort**: 2-3 hours
**Risk**: Low (defensive fix, no schema changes)

### Patterns Identified
**Primary**: `src/lib/auth.ts` lines 120-132 - JWT callback initialization
**Secondary**: `src/services/inventory.ts` lines 17-28 - getCompanySettings function

### Ripple Effect Analysis
**Files Affected by Fix**: 1 (primary fix in auth.ts)
**Files with Similar Pattern**: 90+ (all use `session.user.selectedCompanyId`)

The fix in `src/lib/auth.ts` will automatically protect all downstream usages since it's at the source level.

**Downstream Files (no changes needed, but benefit from fix)**:
- `src/app/(dashboard)/components/page.tsx` - Uses selectedCompanyId
- `src/app/(dashboard)/skus/page.tsx` - Uses selectedCompanyId
- `src/app/(dashboard)/lots/page.tsx` - Uses selectedCompanyId
- All API routes in `src/app/api/` - Use selectedCompanyId
- `src/services/inventory.ts` - Receives companyId

---

## Executive Summary
The Components page crashes because `session.user.selectedCompanyId` can be undefined when using stale JWT tokens that predate the multi-company feature. The fix adds fallback logic in the NextAuth JWT callback to ensure `selectedCompanyId` always has a valid value by falling back to `companyId` (the user's primary company).

## Phase 1: Fix Authentication Fallback Logic

### Subtask 1.1: Add Fallback in JWT Callback
**File**: `/home/pbrown/SkuInventory/src/lib/auth.ts`
**Pattern**: Follow existing token assignment pattern (lines 120-132)
**Instructions**:

1. In the `jwt` callback, after the `if (user)` block and before the session update handlers, add fallback logic to ensure `selectedCompanyId` is never undefined.

2. Modify the JWT callback (around line 132) to add:
```typescript
// Ensure selectedCompanyId has a fallback value for backward compatibility
// This handles tokens created before multi-company support was added
if (!token.selectedCompanyId && token.companyId) {
  token.selectedCompanyId = token.companyId
  token.selectedCompanyName = token.companyName
}
```

3. This should be added AFTER the `if (user)` block but BEFORE the session update triggers.

**Full context for edit** (lines 119-135 of auth.ts):
```typescript
  callbacks: {
    async jwt({ token, user, trigger, session }) {
      if (user) {
        token.id = user.id
        token.role = user.role
        token.companyId = user.companyId
        token.companyName = user.companyName
        token.companies = user.companies
        token.selectedCompanyId = user.selectedCompanyId
        token.selectedCompanyName = user.selectedCompanyName
        token.brands = user.brands
        token.selectedBrandId = user.selectedBrandId
        token.selectedBrandName = user.selectedBrandName
      }

      // ADD FALLBACK HERE - after `if (user)` block
      // Ensure selectedCompanyId has a fallback value for backward compatibility
      if (!token.selectedCompanyId && token.companyId) {
        token.selectedCompanyId = token.companyId
        token.selectedCompanyName = token.companyName
      }

      // Handle session update (for company switching)
      if (trigger === 'update' && session?.selectedCompanyId) {
        ...
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] TypeScript compiles without errors
- [ ] Build succeeds
- [ ] JWT callback has fallback logic for selectedCompanyId

### Subtask 1.2: Add Defensive Check in getCompanySettings
**File**: `/home/pbrown/SkuInventory/src/services/inventory.ts`
**Pattern**: Follow existing validation patterns in API routes
**Instructions**:

1. Add defensive check at the start of `getCompanySettings` function to handle potential undefined:

```typescript
export async function getCompanySettings(companyId: string): Promise<CompanySettings> {
  // Defensive check - return defaults if no companyId provided
  if (!companyId) {
    console.warn('getCompanySettings called without companyId, returning defaults')
    return DEFAULT_SETTINGS
  }

  const company = await prisma.company.findUnique({
    where: { id: companyId },
    select: { settings: true },
  })
  ...
```

2. This is a belt-and-suspenders approach - the JWT fix should prevent this case, but this adds defense in depth.

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] TypeScript compiles without errors
- [ ] Build succeeds
- [ ] Function handles undefined companyId gracefully

## Phase 2: Verification and Testing

### Subtask 2.1: Rebuild Docker Container
**Instructions**:

1. Rebuild the Docker app container with the fix:
```bash
cd /home/pbrown/SkuInventory/docker
docker compose build app
docker compose up -d app
```

2. Wait for container to be healthy:
```bash
docker compose ps
```

**Completion Criteria**:
- [ ] Container rebuilds successfully
- [ ] Container starts and shows healthy status

### Subtask 2.2: Verify Fix in Production
**Instructions**:

1. Check Docker logs for any Prisma errors:
```bash
docker logs inventory-app 2>&1 | grep -i "PrismaClientValidationError" | tail -5
```

2. Access the components page in browser:
- Navigate to http://172.16.20.50:4545/components
- Verify page loads without error

3. Check no server errors in logs after navigation:
```bash
docker logs inventory-app 2>&1 | tail -20
```

**Completion Criteria**:
- [ ] No Prisma validation errors in logs
- [ ] Components page loads successfully
- [ ] Components data displays correctly

### Subtask 2.3: Run Existing Tests
**Instructions**:

1. Run the test suite to ensure no regressions:
```bash
npm test -- --filter="auth|session|component"
```

2. Run TypeScript and lint checks:
```bash
npx tsc --noEmit
npm run lint
```

**Completion Criteria**:
- [ ] All tests pass
- [ ] No TypeScript errors
- [ ] No lint warnings

---

## Summary of Deliverables
**Files Modified**: 2
- `src/lib/auth.ts` - Add fallback for selectedCompanyId in JWT callback
- `src/services/inventory.ts` - Add defensive check in getCompanySettings

## Handoff to Build Agent
1. Execute subtasks in exact order (Phase 1 before Phase 2)
2. Complete each subtask fully before moving to next
3. Run validation commands after each code change
4. Rebuild Docker container after all code changes
5. Verify fix works in running application

## Test Strategy Note
- Use existing test suite for regression testing
- Manual verification required for Docker deployment
- Check browser console for absence of React error #423

## Notes on Root Cause Analysis

**Why this bug appeared**:
1. Multi-company support was added in recent commits
2. `selectedCompanyId` became required for data scoping
3. Old JWT tokens don't have this field
4. The JWT callback assumed all tokens would have `selectedCompanyId` set during initial login
5. Users with old sessions encountered undefined values

**Recommended Future Improvements** (out of scope for this fix):
1. Add token versioning to force re-authentication when token schema changes
2. Consider adding middleware-level validation for required session fields
3. Add E2E test that simulates stale JWT scenario

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 10m |
| Validation | 5m |
| Planning | 5m |
| **Total** | **20m** |
