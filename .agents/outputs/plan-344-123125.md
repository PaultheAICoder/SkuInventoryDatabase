# Implementation Plan
**Generated**: 2025-12-31 23:15:00 UTC
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: 344
**Estimated Build Time**: 2-3 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Enhancement
**Source**: GitHub Issue #344 (follow-up from Issue #334)
**Priority**: Medium

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED (location-service.test.ts, auth.test.ts related tests)
**Suggested Filter**: `--filter="location|company|auth"`

### Issue Validation
**Status**: Valid
**Recent Changes**:
- Issue #334 (FG quantity zero after builds) was fixed on 2025-12-31
- This issue was created as a follow-up to prevent the root cause scenario

### Current State Assessment

**Existing `ensureDefaultLocation()` function** at `/home/pbrown/SkuInventory/src/services/location.ts:8-36`:
- Already fully implemented and tested
- Creates "Main Warehouse" if no locations exist
- Sets first location as default if none is marked default
- Unit tests exist at `/home/pbrown/SkuInventory/tests/unit/location-service.test.ts`

**Company Creation Entry Points**:
1. **POST `/api/companies`** (`/home/pbrown/SkuInventory/src/app/api/companies/route.ts:98-175`):
   - Creates company via `prisma.company.create()`
   - Does NOT call `ensureDefaultLocation()` - **NEEDS FIX**

2. **Database Seeding** (`/home/pbrown/SkuInventory/prisma/seed.ts`):
   - Creates company via `prisma.company.upsert()`
   - Does NOT create default location - **NEEDS FIX**

**Session/Login Entry Points**:
3. **User Login** (`/home/pbrown/SkuInventory/src/lib/auth.ts:22-139`):
   - `authorize()` callback handles login
   - Good place to ensure default location for user's primary company
   - Does NOT call `ensureDefaultLocation()` - **NEEDS FIX**

4. **Company Switch** (`/home/pbrown/SkuInventory/src/app/api/companies/switch/route.ts:20-93`):
   - Handles switching between companies
   - Good place to ensure default location for target company
   - Does NOT call `ensureDefaultLocation()` - **NEEDS FIX**

**Test Infrastructure**:
- Integration tests already handle this via `cleanupBeforeTest()` in `/home/pbrown/SkuInventory/tests/helpers/integration-context.ts:26-48`
- Test helper `getOrCreateDefaultLocation()` exists at line 277-299

### Dependencies & Blockers
None - all required infrastructure already exists.

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Simple
**Effort**: 2-3 hours
**Risk**: Low

### Patterns Identified
**Primary**: `/home/pbrown/SkuInventory/tests/helpers/integration-context.ts:30-47` - Shows pattern for ensuring default location
**Secondary**: `/home/pbrown/SkuInventory/src/services/location.ts:8-36` - The function to call

### Ripple Effect Analysis
**Files Identified**: 5 files need modification

| File | Change Type | Reason |
|------|-------------|--------|
| `src/app/api/companies/route.ts` | Modify POST | Add ensureDefaultLocation call after company creation |
| `src/lib/auth.ts` | Modify authorize | Add ensureDefaultLocation call on login |
| `src/app/api/companies/switch/route.ts` | Modify POST | Add ensureDefaultLocation call on company switch |
| `prisma/seed.ts` | Modify main | Add location creation for seeded company |
| `tests/unit/company-default-location.test.ts` | New file | Test the new integration points |

---

## Executive Summary

This enhancement adds automatic default location creation at three integration points: company creation API, user login, and company switching. The existing `ensureDefaultLocation()` function handles all the logic - we just need to call it at the right times. This prevents the scenario identified in Issue #334 where builds fail because no default location exists.

---

## Phase 1: Update Company Creation API

### Subtask 1.1: Add ensureDefaultLocation to POST /api/companies
**File**: `/home/pbrown/SkuInventory/src/app/api/companies/route.ts`
**Pattern**: Follow existing service import patterns at top of file
**Instructions**:
1. Add import for `ensureDefaultLocation` from `@/services/location`
2. After `prisma.company.create()` (line 145-155), call `await ensureDefaultLocation(company.id)`
3. Log the action for debugging

**Code Change**:
```typescript
// Add import at top (around line 1-6)
import { ensureDefaultLocation } from '@/services/location'

// After company creation (around line 155), add:
// Create default location for new company
await ensureDefaultLocation(company.id)
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Import added at top of file
- [ ] `ensureDefaultLocation()` called after company creation
- [ ] TypeScript compiles without errors

---

## Phase 2: Update Authentication Flow

### Subtask 2.1: Add ensureDefaultLocation to authorize callback
**File**: `/home/pbrown/SkuInventory/src/lib/auth.ts`
**Pattern**: Follow existing prisma.$transaction pattern at lines 88-100
**Instructions**:
1. Add import for `ensureDefaultLocation` from `@/services/location`
2. After the successful login transaction (line 100), call `await ensureDefaultLocation(loginCompanyId)`
3. This ensures users logging into a company without a default location get one created

**Code Change**:
```typescript
// Add import at top (around line 1-5)
import { ensureDefaultLocation } from '@/services/location'

// After login transaction (after line 100), add:
// Ensure company has a default location
if (loginCompanyId) {
  await ensureDefaultLocation(loginCompanyId)
}
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Import added at top of file
- [ ] `ensureDefaultLocation()` called after successful login
- [ ] Guard clause handles empty loginCompanyId
- [ ] TypeScript compiles without errors

---

## Phase 3: Update Company Switch

### Subtask 3.1: Add ensureDefaultLocation to company switch API
**File**: `/home/pbrown/SkuInventory/src/app/api/companies/switch/route.ts`
**Pattern**: Follow existing async patterns in the route
**Instructions**:
1. Add import for `ensureDefaultLocation` from `@/services/location`
2. After verifying user has access (after line 52), call `await ensureDefaultLocation(company.id)`
3. This ensures switching to a company without a default location creates one

**Code Change**:
```typescript
// Add import at top (around line 1-6)
import { ensureDefaultLocation } from '@/services/location'

// After const company = userCompany.company (line 52), add:
// Ensure target company has a default location
await ensureDefaultLocation(company.id)
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Import added at top of file
- [ ] `ensureDefaultLocation()` called after company access verified
- [ ] TypeScript compiles without errors

---

## Phase 4: Update Database Seed

### Subtask 4.1: Add default location creation to seed script
**File**: `/home/pbrown/SkuInventory/prisma/seed.ts`
**Pattern**: Follow existing upsert pattern for company/brand
**Instructions**:
1. After company creation (line 23-24), add location upsert
2. Create "Main Warehouse" as default location if not exists

**Code Change**:
```typescript
// After console.log('Created company:', company.name) (line 24), add:

// Create default location for company
const location = await prisma.location.upsert({
  where: {
    companyId_name: {
      companyId: company.id,
      name: 'Main Warehouse',
    },
  },
  update: {},
  create: {
    companyId: company.id,
    name: 'Main Warehouse',
    type: 'warehouse',
    isDefault: true,
    isActive: true,
  },
})
console.log('Created default location:', location.name)
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Location upsert added after company creation
- [ ] Uses correct unique constraint (`companyId_name`)
- [ ] Sets `isDefault: true` and `isActive: true`
- [ ] TypeScript compiles without errors

---

## Phase 5: Add Integration Tests

### Subtask 5.1: Create test file for default location integration
**File**: `/home/pbrown/SkuInventory/tests/unit/company-default-location.test.ts` (NEW FILE)
**Pattern**: Follow `/home/pbrown/SkuInventory/tests/unit/location-service.test.ts`
**Instructions**:
1. Create test file with mocked prisma
2. Test that company creation calls ensureDefaultLocation
3. Test that company switch calls ensureDefaultLocation
4. Mock imports appropriately

**Test Cases**:
```typescript
/**
 * Unit tests for default location integration points
 * Verifies ensureDefaultLocation is called during company setup
 */
import { describe, it, expect, vi, beforeEach } from 'vitest'

// Mock prisma before imports
vi.mock('@/lib/db', () => ({
  prisma: {
    company: {
      findUnique: vi.fn(),
      create: vi.fn(),
      count: vi.fn(),
      findMany: vi.fn(),
    },
    location: {
      findMany: vi.fn(),
      findFirst: vi.fn(),
      create: vi.fn(),
      update: vi.fn(),
    },
    userCompany: {
      findUnique: vi.fn(),
    },
    brand: {
      findMany: vi.fn(),
    },
    securityEvent: {
      create: vi.fn(),
    },
    $transaction: vi.fn(),
  },
}))

// Mock next-auth
vi.mock('next-auth', () => ({
  getServerSession: vi.fn(),
}))

import { prisma } from '@/lib/db'
import { ensureDefaultLocation } from '@/services/location'

describe('Default Location Integration', () => {
  beforeEach(() => {
    vi.clearAllMocks()
  })

  describe('ensureDefaultLocation function', () => {
    it('creates default location for company without locations', async () => {
      vi.mocked(prisma.location.findMany).mockResolvedValue([])
      vi.mocked(prisma.location.create).mockResolvedValue({
        id: 'loc-1',
        companyId: 'company-1',
        name: 'Main Warehouse',
        type: 'warehouse',
        isDefault: true,
        isActive: true,
        notes: null,
        createdAt: new Date(),
        updatedAt: new Date(),
      })

      await ensureDefaultLocation('company-1')

      expect(prisma.location.create).toHaveBeenCalledWith({
        data: {
          companyId: 'company-1',
          name: 'Main Warehouse',
          type: 'warehouse',
          isDefault: true,
          isActive: true,
        },
      })
    })

    it('does not create location if default already exists', async () => {
      vi.mocked(prisma.location.findMany).mockResolvedValue([{
        id: 'loc-1',
        companyId: 'company-1',
        name: 'Existing Warehouse',
        type: 'warehouse',
        isDefault: true,
        isActive: true,
        notes: null,
        createdAt: new Date(),
        updatedAt: new Date(),
      }])

      await ensureDefaultLocation('company-1')

      expect(prisma.location.create).not.toHaveBeenCalled()
      expect(prisma.location.update).not.toHaveBeenCalled()
    })
  })
})
```

**Validation**:
```bash
npm test -- --testPathPattern="company-default-location"
```

**Completion Criteria**:
- [ ] Test file created
- [ ] Tests verify ensureDefaultLocation behavior
- [ ] All tests pass

---

## Summary of Deliverables

**Files Modified**: 4
1. `/home/pbrown/SkuInventory/src/app/api/companies/route.ts` - Add ensureDefaultLocation call
2. `/home/pbrown/SkuInventory/src/lib/auth.ts` - Add ensureDefaultLocation call on login
3. `/home/pbrown/SkuInventory/src/app/api/companies/switch/route.ts` - Add ensureDefaultLocation call
4. `/home/pbrown/SkuInventory/prisma/seed.ts` - Add default location to seed data

**Files Created**: 1
1. `/home/pbrown/SkuInventory/tests/unit/company-default-location.test.ts` - Integration tests

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 through Phase 5)
2. Each phase modifies a single file - complete one before moving to next
3. Run validation commands after each subtask
4. The existing `ensureDefaultLocation()` function is fully tested - just add the calls

---

## Test Strategy Note

- Unit tests with mocked Prisma (Vitest)
- Existing location-service.test.ts already covers ensureDefaultLocation behavior
- New tests verify integration points call the function
- Run targeted tests: `npm test -- --filter="location|company"`

---

## Performance Metrics

| Phase | Duration |
|-------|----------|
| Investigation | 12m |
| Validation | 3m |
| Planning | 8m |
| **Total** | **23m** |

---

## Risk Assessment

**Low Risk** - This is a straightforward enhancement:
1. The core function (`ensureDefaultLocation`) already exists and is tested
2. We're just adding calls to it at appropriate integration points
3. The function is idempotent - calling it multiple times is safe
4. No database schema changes required
5. No breaking changes to existing APIs
