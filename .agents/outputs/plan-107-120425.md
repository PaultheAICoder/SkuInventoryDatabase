# Implementation Plan
**Generated**: 2025-12-04T17:00:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: Issue #107
**Estimated Build Time**: 6-8 hours
**Complexity**: Medium

## Investigation Summary

### Request Analysis
**Type**: Feature
**Source**: GitHub Issue #107
**Priority**: Medium (completes Parent #11 - Low-stock alerts)

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="email"` or None

### Issue Validation
**Status**: Valid
**Recent Changes**:
- c910feb feat(issue #106): add scheduled job for alert evaluation
- 7fe6f83 feat(issue #105): add Slack webhook integration and admin UI
- 11cd0db feat(issue #104): add database schema and core alert evaluation service

### Current State Assessment
- **Database**: AlertConfig model already has `emailAddresses: String[]` and `enableEmail: Boolean` fields (from Issue #104)
- **Types**: `AlertConfigResponse` and Zod schemas already include email fields (from Issue #104)
- **Services**: `lowstock-alert.ts` has placeholder comment for email delivery at line 485-489
- **API Routes**: `/api/settings/alerts` already handles email config CRUD
- **UI**: `AlertConfigForm.tsx` has placeholder "Coming Soon" card for email at line 349-359

### Dependencies & Blockers
1. **Email Package**: No email package installed - need to install `resend` or `nodemailer`
2. **Environment Variables**: Need to add `RESEND_API_KEY` or `SMTP_*` variables to env schema

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Medium
**Effort**: 6-8 hours
**Risk**: Low (follows established Slack integration patterns)

### Patterns Identified
**Primary**: `/home/pbrown/SkuInventory/src/lib/slack.ts` - Message formatting, error handling, client structure
**Secondary**: `/home/pbrown/SkuInventory/src/components/features/AlertConfigForm.tsx` - UI form patterns for Slack section

### Ripple Effect Analysis
**Files Identified**: 6 files require modification

| File | Reason |
|------|--------|
| `src/lib/email.ts` | NEW - Email client |
| `src/lib/env.ts` | Add email env vars to schema |
| `src/services/lowstock-alert.ts` | Uncomment and implement email delivery |
| `src/components/features/AlertConfigForm.tsx` | Replace placeholder with email form |
| `src/app/api/settings/alerts/test/route.ts` | Add email test endpoint |
| `.env.example` | Document email env vars |

---

## Executive Summary
Implement email delivery for low-stock alerts by creating an email client library (supporting Resend or SMTP via nodemailer), adding email-specific formatting functions, extending the AlertConfigForm to allow email address input with validation, and wiring email delivery into the existing `runAlertEvaluation` function. The existing AlertConfig model already supports email configuration, so no database changes are needed.

## Phase 0: Environment Setup

### Subtask 0.1: Install Email Package
**Instructions**:
1. Install Resend (simpler API, better for serverless):
   ```bash
   npm install resend
   ```
   OR for SMTP flexibility (nodemailer):
   ```bash
   npm install nodemailer && npm install -D @types/nodemailer
   ```
2. Verify installation: `npm list resend` or `npm list nodemailer`

**Recommendation**: Use **Resend** - simpler API, built for serverless, excellent DX, free tier (100 emails/day)

**Completion Criteria**:
- [ ] Email package installed
- [ ] `npm run build` passes
- [ ] Package visible in package.json

### Subtask 0.2: Update Environment Schema
**File**: `/home/pbrown/SkuInventory/src/lib/env.ts`
**Pattern**: Follow existing optional env var pattern (lines 8-9, 12-13)
**Instructions**:
1. Add email environment variables to the Zod schema:
   ```typescript
   // After line 13 (CRON_SECRET)
   // Email configuration - Resend API key OR SMTP settings
   RESEND_API_KEY: z.string().min(1).optional(),
   // Alternative: SMTP settings (if not using Resend)
   SMTP_HOST: z.string().optional(),
   SMTP_PORT: z.coerce.number().optional(),
   SMTP_USER: z.string().optional(),
   SMTP_PASS: z.string().optional(),
   SMTP_FROM: z.string().email().optional(),
   ```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Env schema updated
- [ ] TypeScript compiles without errors

### Subtask 0.3: Update .env.example
**File**: `/home/pbrown/SkuInventory/.env.example`
**Instructions**:
Add after line 31:
```
# Email Configuration for Low-Stock Alerts
# Option 1: Resend (recommended for serverless)
# Get your key at: https://resend.com/api-keys
RESEND_API_KEY=re_your-key-here

# Option 2: SMTP (alternative to Resend)
# SMTP_HOST=smtp.example.com
# SMTP_PORT=587
# SMTP_USER=user@example.com
# SMTP_PASS=your-smtp-password
# SMTP_FROM=alerts@yourcompany.com
```

**Completion Criteria**:
- [ ] .env.example documents email configuration options

---

## Phase 1: Email Client Library

### Subtask 1.1: Create Email Client
**File**: `/home/pbrown/SkuInventory/src/lib/email.ts` (NEW)
**Pattern**: Follow `/home/pbrown/SkuInventory/src/lib/slack.ts` structure

**Instructions**:
Create new file with:
1. Type definitions for email message and alert data
2. Custom error class `EmailDeliveryError`
3. Email provider selection based on env vars
4. `sendEmail(to, subject, html, text)` function
5. `formatLowStockAlertEmail(data)` - HTML template
6. `formatDigestEmail(alerts, baseUrl)` - HTML digest template
7. `formatTestEmail()` - Test message
8. Email validation utility

**Code Structure**:
```typescript
/**
 * Email client for low-stock alerts
 * Supports Resend API or SMTP via nodemailer
 */

// Types
export interface EmailMessage {
  to: string[]
  subject: string
  html: string
  text: string
}

export interface LowStockEmailData {
  componentName: string
  skuCode: string
  brandName: string
  currentStatus: 'warning' | 'critical'
  quantityOnHand: number
  reorderPoint: number
  leadTimeDays: number
  componentId: string
  baseUrl: string
  companyName?: string
}

export class EmailDeliveryError extends Error {
  constructor(message: string, public originalError?: unknown) {
    super(message)
    this.name = 'EmailDeliveryError'
  }
}

// Provider detection
function getEmailProvider(): 'resend' | 'smtp' | null {
  if (process.env.RESEND_API_KEY) return 'resend'
  if (process.env.SMTP_HOST) return 'smtp'
  return null
}

export function isEmailConfigured(): boolean {
  return getEmailProvider() !== null
}

// Validate email format
export function isValidEmail(email: string): boolean {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)
}

// Send email via configured provider
export async function sendEmail(message: EmailMessage): Promise<void> {
  const provider = getEmailProvider()

  if (!provider) {
    throw new EmailDeliveryError('No email provider configured')
  }

  if (provider === 'resend') {
    await sendViaResend(message)
  } else {
    await sendViaSmtp(message)
  }
}

// Resend implementation
async function sendViaResend(message: EmailMessage): Promise<void> {
  const { Resend } = await import('resend')
  const resend = new Resend(process.env.RESEND_API_KEY)

  const { error } = await resend.emails.send({
    from: 'Trevor Inventory <alerts@yourdomain.com>', // Or use RESEND_FROM env
    to: message.to,
    subject: message.subject,
    html: message.html,
    text: message.text,
  })

  if (error) {
    throw new EmailDeliveryError(`Resend error: ${error.message}`, error)
  }
}

// SMTP implementation (nodemailer)
async function sendViaSmtp(message: EmailMessage): Promise<void> {
  const nodemailer = await import('nodemailer')

  const transporter = nodemailer.createTransport({
    host: process.env.SMTP_HOST,
    port: parseInt(process.env.SMTP_PORT || '587'),
    secure: process.env.SMTP_PORT === '465',
    auth: {
      user: process.env.SMTP_USER,
      pass: process.env.SMTP_PASS,
    },
  })

  await transporter.sendMail({
    from: process.env.SMTP_FROM,
    to: message.to.join(', '),
    subject: message.subject,
    html: message.html,
    text: message.text,
  })
}

// Format single alert email
export function formatLowStockAlertEmail(data: LowStockEmailData): EmailMessage {
  const severity = data.currentStatus === 'critical' ? 'Critical' : 'Warning'
  const severityColor = data.currentStatus === 'critical' ? '#dc2626' : '#f59e0b'
  const componentUrl = `${data.baseUrl}/components/${data.componentId}`

  const html = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f5;">
  <div style="max-width: 600px; margin: 0 auto; background-color: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
    <div style="background-color: ${severityColor}; color: white; padding: 20px; text-align: center;">
      <h1 style="margin: 0; font-size: 24px;">Low Stock Alert - ${severity}</h1>
    </div>
    <div style="padding: 24px;">
      <p style="margin: 0 0 16px; color: #374151;">A component in your inventory needs attention:</p>
      <table style="width: 100%; border-collapse: collapse; margin: 16px 0;">
        <tr>
          <td style="padding: 12px; border: 1px solid #e5e7eb; font-weight: 600; background-color: #f9fafb;">Component</td>
          <td style="padding: 12px; border: 1px solid #e5e7eb;"><a href="${componentUrl}" style="color: #2563eb;">${data.componentName}</a> (${data.skuCode})</td>
        </tr>
        <tr>
          <td style="padding: 12px; border: 1px solid #e5e7eb; font-weight: 600; background-color: #f9fafb;">Brand</td>
          <td style="padding: 12px; border: 1px solid #e5e7eb;">${data.brandName}</td>
        </tr>
        <tr>
          <td style="padding: 12px; border: 1px solid #e5e7eb; font-weight: 600; background-color: #f9fafb;">Status</td>
          <td style="padding: 12px; border: 1px solid #e5e7eb; color: ${severityColor}; font-weight: 600;">${severity}</td>
        </tr>
        <tr>
          <td style="padding: 12px; border: 1px solid #e5e7eb; font-weight: 600; background-color: #f9fafb;">On Hand</td>
          <td style="padding: 12px; border: 1px solid #e5e7eb;">${data.quantityOnHand} units</td>
        </tr>
        <tr>
          <td style="padding: 12px; border: 1px solid #e5e7eb; font-weight: 600; background-color: #f9fafb;">Reorder Point</td>
          <td style="padding: 12px; border: 1px solid #e5e7eb;">${data.reorderPoint} units</td>
        </tr>
        <tr>
          <td style="padding: 12px; border: 1px solid #e5e7eb; font-weight: 600; background-color: #f9fafb;">Lead Time</td>
          <td style="padding: 12px; border: 1px solid #e5e7eb;">${data.leadTimeDays} days</td>
        </tr>
      </table>
      <div style="text-align: center; margin-top: 24px;">
        <a href="${componentUrl}" style="display: inline-block; background-color: #2563eb; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; font-weight: 500;">View Component</a>
      </div>
    </div>
    <div style="background-color: #f9fafb; padding: 16px; text-align: center; font-size: 12px; color: #6b7280;">
      <p style="margin: 0;">Sent by Trevor Inventory${data.companyName ? ` for ${data.companyName}` : ''}</p>
    </div>
  </div>
</body>
</html>`

  const text = `Low Stock Alert - ${severity}

A component in your inventory needs attention:

Component: ${data.componentName} (${data.skuCode})
Brand: ${data.brandName}
Status: ${severity}
On Hand: ${data.quantityOnHand} units
Reorder Point: ${data.reorderPoint} units
Lead Time: ${data.leadTimeDays} days

View Component: ${componentUrl}

Sent by Trevor Inventory`

  return {
    to: [], // Filled in by caller
    subject: `Low Stock Alert [${severity}]: ${data.componentName} (${data.skuCode})`,
    html,
    text,
  }
}

// Format digest email (multiple alerts)
export function formatDigestEmail(alerts: LowStockEmailData[], baseUrl: string, companyName?: string): EmailMessage {
  const criticals = alerts.filter(a => a.currentStatus === 'critical')
  const warnings = alerts.filter(a => a.currentStatus === 'warning')

  // Build rows for each alert
  const buildRows = (items: LowStockEmailData[], color: string) => items.slice(0, 10).map(a => `
    <tr>
      <td style="padding: 8px; border: 1px solid #e5e7eb;"><a href="${a.baseUrl}/components/${a.componentId}" style="color: #2563eb;">${a.componentName}</a></td>
      <td style="padding: 8px; border: 1px solid #e5e7eb;">${a.skuCode}</td>
      <td style="padding: 8px; border: 1px solid #e5e7eb; color: ${color}; font-weight: 600;">${a.quantityOnHand}</td>
      <td style="padding: 8px; border: 1px solid #e5e7eb;">${a.reorderPoint}</td>
    </tr>
  `).join('')

  const html = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f5;">
  <div style="max-width: 600px; margin: 0 auto; background-color: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
    <div style="background-color: #1e40af; color: white; padding: 20px; text-align: center;">
      <h1 style="margin: 0; font-size: 24px;">Low Stock Daily Summary</h1>
    </div>
    <div style="padding: 24px;">
      <p style="margin: 0 0 16px; color: #374151; font-size: 16px;">
        <strong>${alerts.length} components need attention</strong><br>
        <span style="color: #dc2626;">${criticals.length} Critical</span> | <span style="color: #f59e0b;">${warnings.length} Warning</span>
      </p>

      ${criticals.length > 0 ? `
      <h2 style="color: #dc2626; font-size: 18px; margin: 24px 0 12px;">Critical Items</h2>
      <table style="width: 100%; border-collapse: collapse;">
        <tr style="background-color: #fef2f2;">
          <th style="padding: 8px; border: 1px solid #e5e7eb; text-align: left;">Component</th>
          <th style="padding: 8px; border: 1px solid #e5e7eb; text-align: left;">SKU</th>
          <th style="padding: 8px; border: 1px solid #e5e7eb; text-align: left;">On Hand</th>
          <th style="padding: 8px; border: 1px solid #e5e7eb; text-align: left;">Reorder</th>
        </tr>
        ${buildRows(criticals, '#dc2626')}
      </table>
      ` : ''}

      ${warnings.length > 0 ? `
      <h2 style="color: #f59e0b; font-size: 18px; margin: 24px 0 12px;">Warning Items</h2>
      <table style="width: 100%; border-collapse: collapse;">
        <tr style="background-color: #fefce8;">
          <th style="padding: 8px; border: 1px solid #e5e7eb; text-align: left;">Component</th>
          <th style="padding: 8px; border: 1px solid #e5e7eb; text-align: left;">SKU</th>
          <th style="padding: 8px; border: 1px solid #e5e7eb; text-align: left;">On Hand</th>
          <th style="padding: 8px; border: 1px solid #e5e7eb; text-align: left;">Reorder</th>
        </tr>
        ${buildRows(warnings, '#f59e0b')}
      </table>
      ` : ''}

      ${alerts.length > 20 ? `<p style="color: #6b7280; font-size: 14px; margin-top: 16px;">...and ${alerts.length - 20} more items</p>` : ''}

      <div style="text-align: center; margin-top: 24px;">
        <a href="${baseUrl}/components" style="display: inline-block; background-color: #2563eb; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; font-weight: 500;">View All Components</a>
      </div>
    </div>
    <div style="background-color: #f9fafb; padding: 16px; text-align: center; font-size: 12px; color: #6b7280;">
      <p style="margin: 0;">Sent by Trevor Inventory${companyName ? ` for ${companyName}` : ''}</p>
    </div>
  </div>
</body>
</html>`

  const text = `Low Stock Daily Summary

${alerts.length} components need attention
${criticals.length} Critical | ${warnings.length} Warning

${criticals.length > 0 ? `CRITICAL ITEMS:
${criticals.slice(0, 10).map(a => `- ${a.componentName} (${a.skuCode}): ${a.quantityOnHand} on hand, reorder at ${a.reorderPoint}`).join('\n')}
` : ''}
${warnings.length > 0 ? `WARNING ITEMS:
${warnings.slice(0, 10).map(a => `- ${a.componentName} (${a.skuCode}): ${a.quantityOnHand} on hand, reorder at ${a.reorderPoint}`).join('\n')}
` : ''}
View all: ${baseUrl}/components

Sent by Trevor Inventory`

  return {
    to: [],
    subject: `Low Stock Summary: ${criticals.length} Critical, ${warnings.length} Warning`,
    html,
    text,
  }
}

// Format test email
export function formatTestEmail(): EmailMessage {
  return {
    to: [],
    subject: 'Trevor Inventory - Email Connection Test',
    html: `
<!DOCTYPE html>
<html>
<head><meta charset="utf-8"></head>
<body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f5;">
  <div style="max-width: 600px; margin: 0 auto; background-color: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
    <div style="background-color: #10b981; color: white; padding: 20px; text-align: center;">
      <h1 style="margin: 0; font-size: 24px;">Email Connection Test</h1>
    </div>
    <div style="padding: 24px; text-align: center;">
      <p style="font-size: 48px; margin: 0;">&#10003;</p>
      <p style="margin: 16px 0 0; color: #374151; font-size: 16px;">Your email alerts are configured correctly!</p>
      <p style="margin: 8px 0 0; color: #6b7280; font-size: 14px;">You will receive low-stock alerts at this address.</p>
    </div>
  </div>
</body>
</html>`,
    text: `Email Connection Test

Your email alerts are configured correctly!
You will receive low-stock alerts at this address.

Sent by Trevor Inventory`,
  }
}
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] File created at `src/lib/email.ts`
- [ ] TypeScript compiles without errors
- [ ] Build passes

---

## Phase 2: Service Layer Integration

### Subtask 2.1: Add Email Delivery Function to lowstock-alert.ts
**File**: `/home/pbrown/SkuInventory/src/services/lowstock-alert.ts`
**Pattern**: Follow `sendSlackAlerts` function at lines 355-410

**Instructions**:
1. Add import for email library at top of file (after line 12):
   ```typescript
   import {
     sendEmail,
     formatLowStockAlertEmail,
     formatDigestEmail,
     type LowStockEmailData,
   } from '@/lib/email'
   ```

2. Add `sendEmailAlerts` function after `sendSlackAlerts` (after line 410):
   ```typescript
   /**
    * Send low-stock alerts via email
    * Used by scheduler to deliver alerts
    */
   export async function sendEmailAlerts(
     companyId: string,
     alerts: ComponentAlertNeeded[],
     baseUrl: string
   ): Promise<{ sent: number; errors: string[] }> {
     const config = await getAlertConfig(companyId)

     if (!config || !config.enableEmail || config.emailAddresses.length === 0) {
       return { sent: 0, errors: [] }
     }

     // Get company name for email footer
     const company = await prisma.company.findUnique({
       where: { id: companyId },
       select: { name: true },
     })

     const errors: string[] = []

     // Convert alerts to LowStockEmailData format
     const alertData: LowStockEmailData[] = alerts.map((alert) => ({
       componentName: alert.componentName,
       skuCode: alert.skuCode,
       brandName: alert.brandName,
       currentStatus: alert.currentStatus as 'warning' | 'critical',
       quantityOnHand: alert.quantityOnHand,
       reorderPoint: alert.reorderPoint,
       leadTimeDays: alert.leadTimeDays,
       componentId: alert.componentId,
       baseUrl,
       companyName: company?.name,
     }))

     try {
       if (config.alertMode === 'daily_digest') {
         // Send single digest email
         const message = formatDigestEmail(alertData, baseUrl, company?.name)
         message.to = config.emailAddresses
         await sendEmail(message)
         await updateLastDigestSent(companyId)
         return { sent: alerts.length, errors: [] }
       } else {
         // Send individual alerts (per_transition mode)
         let sent = 0
         for (const data of alertData) {
           try {
             const message = formatLowStockAlertEmail(data)
             message.to = config.emailAddresses
             await sendEmail(message)
             sent++
           } catch (error) {
             errors.push(
               `Failed to send email for ${data.componentName}: ${error instanceof Error ? error.message : 'Unknown error'}`
             )
           }
         }
         return { sent, errors }
       }
     } catch (error) {
       errors.push(
         `Email delivery failed: ${error instanceof Error ? error.message : 'Unknown error'}`
       )
       return { sent: 0, errors }
     }
   }
   ```

3. Update `runAlertEvaluation` to call `sendEmailAlerts` - replace the comment block at lines 484-489:
   ```typescript
   // Send email alerts if enabled
   if (config.enableEmail && config.emailAddresses.length > 0) {
     const emailResult = await sendEmailAlerts(
       companyId,
       evaluation.componentsNeedingAlert,
       baseUrl
     )
     result.emailSent = emailResult.sent
     result.emailErrors = emailResult.errors
   }
   ```

4. Update the log message at line 491 to include email:
   ```typescript
   console.log(`[Alerts] Company ${companyId}: ${result.alertsTriggered} alerts, ${result.slackSent} Slack sent, ${result.emailSent} emails sent`)
   ```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] `sendEmailAlerts` function added
- [ ] `runAlertEvaluation` calls email delivery
- [ ] TypeScript compiles without errors
- [ ] Build passes

---

## Phase 3: API Routes

### Subtask 3.1: Add Email Test Endpoint
**File**: `/home/pbrown/SkuInventory/src/app/api/settings/alerts/test/route.ts`
**Pattern**: Follow existing Slack test pattern in same file

**Instructions**:
Modify the POST handler to support testing both Slack and email. Add after line 80:

1. First, add imports at top of file (after line 16):
   ```typescript
   import {
     sendEmail,
     formatTestEmail,
     isEmailConfigured,
     isValidEmail,
     EmailDeliveryError,
   } from '@/lib/email'
   ```

2. Update the POST handler to handle `type` parameter for email testing. Replace the entire POST function:
   ```typescript
   /**
    * POST /api/settings/alerts/test - Test Slack webhook or email (admin only)
    * Body: { type: 'slack' | 'email', webhookUrl?: string, email?: string }
    */
   export async function POST(request: NextRequest) {
     try {
       const session = await getServerSession(authOptions)

       if (!session?.user) {
         return unauthorized()
       }

       if (session.user.role !== 'admin') {
         return forbidden()
       }

       const body = await request.json().catch(() => ({}))
       const testType = body.type || 'slack' // Default to slack for backward compatibility

       if (testType === 'email') {
         // Email test
         const testEmail = body.email as string | undefined

         if (!testEmail) {
           return success({
             success: false,
             error: 'No email address provided for test',
           })
         }

         if (!isValidEmail(testEmail)) {
           return success({
             success: false,
             error: 'Invalid email address format',
           })
         }

         if (!isEmailConfigured()) {
           return success({
             success: false,
             error: 'Email provider not configured. Set RESEND_API_KEY or SMTP_* environment variables.',
           })
         }

         try {
           const message = formatTestEmail()
           message.to = [testEmail]
           await sendEmail(message)
           return success({
             success: true,
             message: `Test email sent to ${testEmail}`,
           })
         } catch (error) {
           const message =
             error instanceof EmailDeliveryError
               ? error.message
               : 'Failed to send test email'
           return success({
             success: false,
             error: message,
           })
         }
       } else {
         // Slack test (existing logic)
         let webhookUrl: string | null = null

         if (body.webhookUrl) {
           webhookUrl = body.webhookUrl
         } else {
           const config = await getAlertConfig(session.user.selectedCompanyId)
           webhookUrl = config?.slackWebhookUrl ?? null
         }

         if (!webhookUrl) {
           return success({
             success: false,
             error: 'No webhook URL configured',
           })
         }

         if (!isValidSlackWebhookUrl(webhookUrl)) {
           return success({
             success: false,
             error: 'Invalid Slack webhook URL format. URL must start with https://hooks.slack.com/services/',
           })
         }

         try {
           await sendSlackMessage(webhookUrl, formatTestMessage())
           return success({
             success: true,
             message: 'Test message sent successfully',
           })
         } catch (error) {
           const message =
             error instanceof SlackWebhookError
               ? error.message
               : 'Failed to send test message'
           return success({
             success: false,
             error: message,
           })
         }
       }
     } catch (error) {
       console.error('Error testing alert channel:', error)
       return serverError()
     }
   }
   ```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Test endpoint supports `type: 'email'`
- [ ] Email validation working
- [ ] TypeScript compiles without errors
- [ ] Build passes

---

## Phase 4: Frontend Components

### Subtask 4.1: Update AlertConfigForm for Email Support
**File**: `/home/pbrown/SkuInventory/src/components/features/AlertConfigForm.tsx`
**Pattern**: Follow Slack configuration section pattern (lines 198-345)

**Instructions**:
1. Add state for email configuration (after line 56):
   ```typescript
   const [emailAddresses, setEmailAddresses] = useState<string[]>(config?.emailAddresses ?? [])
   const [enableEmail, setEnableEmail] = useState(config?.enableEmail ?? false)
   const [newEmail, setNewEmail] = useState('')
   const [emailError, setEmailError] = useState<string | null>(null)
   const [isTestingEmail, setIsTestingEmail] = useState(false)
   const [emailTestResult, setEmailTestResult] = useState<{
     success: boolean
     message?: string
     error?: string
   } | null>(null)
   ```

2. Add email state sync to the useEffect (after line 68):
   ```typescript
   setEmailAddresses(config.emailAddresses)
   setEnableEmail(config.enableEmail)
   ```

3. Add email test handler (after line 106):
   ```typescript
   const handleTestEmail = async () => {
     if (emailAddresses.length === 0) {
       setEmailTestResult({
         success: false,
         error: 'Add at least one email address first',
       })
       return
     }

     setIsTestingEmail(true)
     setEmailTestResult(null)

     try {
       const res = await fetch('/api/settings/alerts/test', {
         method: 'POST',
         headers: { 'Content-Type': 'application/json' },
         body: JSON.stringify({ type: 'email', email: emailAddresses[0] }),
       })

       if (res.status === 403) {
         toast.error('You do not have permission to test email')
         return
       }

       const data = await res.json()

       setEmailTestResult(data.data)
       if (data.data?.success) {
         toast.success(`Test email sent to ${emailAddresses[0]}!`)
       } else {
         toast.error(data.data?.error || 'Test failed')
       }
     } catch {
       toast.error('Failed to test email')
     } finally {
       setIsTestingEmail(false)
     }
   }

   const addEmail = () => {
     setEmailError(null)
     const email = newEmail.trim().toLowerCase()

     if (!email) return

     // Simple email validation
     if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
       setEmailError('Please enter a valid email address')
       return
     }

     if (emailAddresses.includes(email)) {
       setEmailError('This email is already added')
       return
     }

     setEmailAddresses([...emailAddresses, email])
     setNewEmail('')
   }

   const removeEmail = (email: string) => {
     setEmailAddresses(emailAddresses.filter((e) => e !== email))
   }
   ```

4. Update handleSave to include email fields (update payload in handleSave around line 112-115):
   ```typescript
   const payload: Record<string, unknown> = {
     enableSlack,
     enableEmail,
     emailAddresses,
     alertMode,
   }
   ```

5. Update the reset after save (around line 139):
   ```typescript
   setEmailTestResult(null)
   ```

6. Add email imports at top (after line 29):
   ```typescript
   import { Mail, Plus, X } from 'lucide-react'
   ```

7. Replace the placeholder Email Card (lines 348-359) with full implementation:
   ```typescript
   {/* Email Configuration Card */}
   <Card>
     <CardHeader>
       <div className="flex items-center justify-between">
         <CardTitle className="flex items-center gap-2">
           {enableEmail ? (
             <Bell className="h-5 w-5 text-green-600" />
           ) : (
             <BellOff className="h-5 w-5 text-muted-foreground" />
           )}
           Email Alerts
         </CardTitle>
         <Badge variant={enableEmail && emailAddresses.length > 0 ? 'default' : 'secondary'}>
           {enableEmail && emailAddresses.length > 0 ? 'Enabled' : 'Disabled'}
         </Badge>
       </div>
       <CardDescription>
         {enableEmail && emailAddresses.length > 0
           ? `Low-stock alerts will be sent to ${emailAddresses.length} email address${emailAddresses.length > 1 ? 'es' : ''}`
           : 'Configure email addresses to receive alerts'}
       </CardDescription>
     </CardHeader>
     <CardContent className="space-y-4">
       {/* Enable Toggle */}
       <div className="flex items-center space-x-2">
         <input
           id="enableEmail"
           type="checkbox"
           className="h-4 w-4 rounded border-gray-300"
           checked={enableEmail}
           onChange={(e) => setEnableEmail(e.target.checked)}
           disabled={isLoading}
         />
         <div>
           <Label htmlFor="enableEmail" className="font-normal">
             Enable Email Alerts
           </Label>
           <p className="text-xs text-muted-foreground">
             Receive low-stock notifications via email
           </p>
         </div>
       </div>

       {/* Email Addresses */}
       <div className="space-y-2">
         <Label>Email Addresses</Label>

         {/* Existing emails */}
         {emailAddresses.length > 0 && (
           <div className="flex flex-wrap gap-2 mb-2">
             {emailAddresses.map((email) => (
               <div
                 key={email}
                 className="flex items-center gap-1 bg-secondary px-2 py-1 rounded-md text-sm"
               >
                 <Mail className="h-3 w-3" />
                 <span>{email}</span>
                 <button
                   type="button"
                   onClick={() => removeEmail(email)}
                   className="ml-1 hover:text-destructive"
                   disabled={isLoading}
                 >
                   <X className="h-3 w-3" />
                 </button>
               </div>
             ))}
           </div>
         )}

         {/* Add new email */}
         <div className="flex gap-2">
           <Input
             type="email"
             placeholder="alerts@example.com"
             value={newEmail}
             onChange={(e) => {
               setNewEmail(e.target.value)
               setEmailError(null)
             }}
             onKeyDown={(e) => {
               if (e.key === 'Enter') {
                 e.preventDefault()
                 addEmail()
               }
             }}
             disabled={isLoading}
             className="flex-1"
           />
           <Button
             type="button"
             variant="outline"
             size="icon"
             onClick={addEmail}
             disabled={isLoading || !newEmail}
           >
             <Plus className="h-4 w-4" />
           </Button>
         </div>
         {emailError && (
           <p className="text-xs text-destructive">{emailError}</p>
         )}
         <p className="text-xs text-muted-foreground">
           Add email addresses to receive low-stock alerts
         </p>
       </div>

       {/* Email Test Result Display */}
       {emailTestResult && (
         <div
           className={`rounded-md p-4 ${
             emailTestResult.success
               ? 'bg-green-50 border border-green-200'
               : 'bg-destructive/10 border border-destructive/20'
           }`}
         >
           <div className="flex items-start gap-3">
             {emailTestResult.success ? (
               <CheckCircle className="h-5 w-5 text-green-600 mt-0.5" />
             ) : (
               <XCircle className="h-5 w-5 text-destructive mt-0.5" />
             )}
             <div>
               <p
                 className={`font-medium ${
                   emailTestResult.success ? 'text-green-800' : 'text-destructive'
                 }`}
               >
                 {emailTestResult.success ? 'Test Successful' : 'Test Failed'}
               </p>
               <p className="mt-1 text-sm">
                 {emailTestResult.success
                   ? emailTestResult.message
                   : emailTestResult.error}
               </p>
             </div>
           </div>
         </div>
       )}

       {/* Test Email Button */}
       <div className="pt-2">
         <Button
           type="button"
           variant="outline"
           onClick={handleTestEmail}
           disabled={emailAddresses.length === 0 || isLoading || isTestingEmail}
         >
           {isTestingEmail ? (
             <>
               <Loader2 className="mr-2 h-4 w-4 animate-spin" />
               Sending...
             </>
           ) : (
             <>
               <Mail className="mr-2 h-4 w-4" />
               Test Email
             </>
           )}
         </Button>
       </div>
     </CardContent>
   </Card>
   ```

8. Update isLoading check to include email testing (around line 149):
   ```typescript
   const isLoading = isSaving || isTesting || isTestingEmail
   ```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Email configuration section renders
- [ ] Can add/remove email addresses
- [ ] Enable/disable toggle works
- [ ] Test email button works
- [ ] TypeScript compiles without errors
- [ ] Build passes

---

## Phase 5: Testing & Verification

### Subtask 5.1: Manual Testing Checklist
**Instructions**:
1. Start dev server: `npm run dev`
2. Navigate to `/settings/alerts`
3. Test email configuration:
   - [ ] Add email address (valid format)
   - [ ] Add email with invalid format (should show error)
   - [ ] Add duplicate email (should show error)
   - [ ] Remove email address
   - [ ] Enable/disable email toggle
   - [ ] Save settings
4. Test email delivery (requires env vars):
   - [ ] Click "Test Email" button
   - [ ] Verify test email received
5. Verify Slack still works:
   - [ ] Test Slack webhook still functions
   - [ ] Save with both channels enabled

### Subtask 5.2: Build Verification
**Instructions**:
```bash
# Full build check
npm run build

# TypeScript check
npx tsc --noEmit

# Lint check
npm run lint

# Run tests
npm test
```

**Completion Criteria**:
- [ ] All checks pass
- [ ] No TypeScript errors
- [ ] No lint warnings
- [ ] Tests pass

---

## Summary of Deliverables

**Files Created**: 1
- `src/lib/email.ts` - Email client library

**Files Modified**: 5
- `src/lib/env.ts` - Add email env vars
- `src/services/lowstock-alert.ts` - Add sendEmailAlerts function
- `src/app/api/settings/alerts/test/route.ts` - Add email test support
- `src/components/features/AlertConfigForm.tsx` - Full email UI
- `.env.example` - Document email vars

**No Changes Needed**:
- `prisma/schema.prisma` - Already has emailAddresses and enableEmail fields
- `src/types/lowstock-alert.ts` - Already has email types
- `src/app/api/settings/alerts/route.ts` - Already handles email config CRUD

---

## Handoff to Build Agent
1. Execute subtasks in exact order (Phase 0 -> 1 -> 2 -> 3 -> 4 -> 5)
2. Install Resend package first (simpler than nodemailer)
3. Test completion criteria before moving to next subtask
4. Follow Slack patterns exactly for consistency
5. Run `npm run build` after each phase

## Test Strategy Note
- **Type**: TARGETED
- Use Vitest for any unit tests
- Manual testing for email delivery (requires API key)
- E2E testing optional if Playwright configured

## Environment Requirements
For email functionality to work, ONE of these must be configured:
- `RESEND_API_KEY` - Resend API (recommended)
- OR `SMTP_HOST`, `SMTP_PORT`, `SMTP_USER`, `SMTP_PASS`, `SMTP_FROM` - SMTP

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 12m |
| Validation | 3m |
| Planning | 10m |
| **Total** | **25m** |
