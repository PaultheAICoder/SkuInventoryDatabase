# Implementation Plan
**Generated**: 2025-12-03T23:30:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #69 - "[Parent #9] Phase 2: Add locationId to transactions and transaction services"
**Estimated Build Time**: 6-8 hours
**Complexity**: Medium

## Investigation Summary

### Request Analysis
**Type**: Feature
**Source**: GitHub Issue #69 (Parent: #9)
**Priority**: High (Phase 2 of multi-location inventory tracking)

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="Transaction"` for integration tests

### Issue Validation
**Status**: Valid
**Recent Changes**: Location model was added in migration `20251203230836_add_location_model`

### Current State Assessment
- **Location model**: EXISTS in `prisma/schema.prisma` (lines 36-50) with proper fields (id, companyId, name, type, isDefault, isActive, notes)
- **Location service**: EXISTS in `src/services/location.ts` with `getDefaultLocation(companyId)` function
- **Location API**: EXISTS at `src/app/api/locations/route.ts` (admin-only, GET/POST)
- **Location types**: EXISTS in `src/types/location.ts`
- **Transaction model**: EXISTS but MISSING `locationId` field
- **Transaction services**: 4 functions need updating in `src/services/inventory.ts`
- **API Routes**: 6 route files need updating
- **Frontend**: 3 dialogs need location selector, 1 detail view needs location display

### Dependencies & Blockers
1. **Prerequisite**: Location model and service (Issue #68) - COMPLETE
2. **Database**: Need migration to add `locationId` column to Transaction table
3. **Backfill**: Existing transactions need to reference default location

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Moderate
**Effort**: 6-8 hours
**Risk**: Low - follows established patterns, backward compatible (locationId is optional)

### Patterns Identified
**Primary**: `src/app/api/transactions/receipt/route.ts` - API route pattern with session check
**Secondary**: `src/services/inventory.ts:createReceiptTransaction` - Service function pattern
**Tertiary**: `src/components/features/AdjustmentDialog.tsx` - Dialog with Select component

### Ripple Effect Analysis
**Files Identified**: 16 total files to modify

**Database Layer** (2 files):
- `prisma/schema.prisma` - Add locationId to Transaction model
- Migration file - Add column and backfill

**Types Layer** (1 file):
- `src/types/transaction.ts` - Add locationId to schemas and response types

**Service Layer** (1 file):
- `src/services/inventory.ts` - 4 functions to update:
  - `createReceiptTransaction` (line 92)
  - `createAdjustmentTransaction` (line 176)
  - `createInitialTransaction` (line 230)
  - `createBuildTransaction` (line 419)

**API Routes** (6 files):
- `src/app/api/transactions/receipt/route.ts`
- `src/app/api/transactions/adjustment/route.ts`
- `src/app/api/transactions/initial/route.ts`
- `src/app/api/transactions/build/route.ts`
- `src/app/api/transactions/route.ts` (list - include location in response)
- `src/app/api/transactions/[id]/route.ts` (detail - include location)

**Import Routes** (2 files):
- `src/app/api/import/inventory-snapshot/route.ts` - Uses `createInitialTransaction`
- `src/app/api/import/initial-inventory/route.ts` - Uses `createInitialTransaction`

**Frontend Components** (4 files):
- `src/components/features/ReceiptDialog.tsx` - Add location selector
- `src/components/features/AdjustmentDialog.tsx` - Add location selector
- `src/components/features/BuildDialog.tsx` - Add location selector
- `src/components/features/TransactionDetail.tsx` - Display location

---

## Executive Summary
This implementation adds `locationId` to the Transaction model, updates all transaction creation services and API routes to accept an optional location parameter (defaulting to the company's default location), modifies frontend dialogs to include a location selector, and updates the transaction detail view to display the location.

## Phase 1: Database Schema and Types

### Subtask 1.1: Add locationId to Transaction Model
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Pattern**: Follow existing relation pattern (e.g., `company Company @relation(...)`)
**Instructions**:
1. Add `locationId` field to Transaction model (optional String)
2. Add Location relation
3. Add relation on Location model side (transactions)
4. Add index on locationId for query performance

```prisma
model Transaction {
  // ... existing fields ...
  locationId    String?
  location      Location?       @relation(fields: [locationId], references: [id])
  // ... rest of model ...

  @@index([locationId])
}

model Location {
  // ... existing fields ...
  transactions  Transaction[]
}
```

**Validation**:
```bash
npx prisma validate
```
**Completion Criteria**:
- [ ] locationId field added as optional String
- [ ] Location relation defined
- [ ] Index on locationId added
- [ ] Prisma validates without errors

### Subtask 1.2: Create Migration and Backfill
**File**: New migration file (auto-generated)
**Pattern**: Follow existing migrations in `prisma/migrations/`
**Instructions**:
1. Run `npx prisma migrate dev --name add_location_to_transaction`
2. The migration should:
   - Add `locationId` column to Transaction table (nullable)
   - Add foreign key constraint to Location table
   - Create index on locationId
3. After migration, create a backfill script or manual SQL to set existing transactions to default location

**Backfill SQL** (to run after migration):
```sql
UPDATE "Transaction" t
SET "locationId" = (
  SELECT l.id
  FROM "Location" l
  WHERE l."companyId" = t."companyId"
    AND l."isDefault" = true
  LIMIT 1
)
WHERE t."locationId" IS NULL;
```

**Validation**:
```bash
npx prisma migrate dev --name add_location_to_transaction
npx prisma generate
```
**Completion Criteria**:
- [ ] Migration created successfully
- [ ] Migration runs without errors
- [ ] Prisma client regenerated
- [ ] Backfill script documented (or executed)

### Subtask 1.3: Update Transaction Types
**File**: `/home/pbrown/SkuInventory/src/types/transaction.ts`
**Pattern**: Follow existing schema patterns (z.string().uuid().optional())
**Instructions**:
1. Add `locationId` to `createReceiptSchema` (line 4-12)
2. Add `locationId` to `createAdjustmentSchema` (line 17-24)
3. Add `locationId` to `createInitialSchema` (line 28-36)
4. Add `locationId` to `createBuildSchema` (line 40-51)
5. Add `locationId` and `location` to `TransactionResponse` interface (line 88-107)
6. Add `location` to `TransactionDetailResponse` interface (line 117-119)

**Code additions**:
```typescript
// In each create schema, add:
locationId: z.string().uuid('Invalid location ID').optional(),

// In TransactionResponse, add:
locationId: string | null
location?: { id: string; name: string } | null

// In TransactionDetailResponse, add:
location?: { id: string; name: string; type: string } | null
```

**Validation**:
```bash
npx tsc --noEmit
```
**Completion Criteria**:
- [ ] All 4 create schemas have locationId
- [ ] TransactionResponse has locationId and location
- [ ] TransactionDetailResponse has location
- [ ] TypeScript compiles without errors

## Phase 2: Service Layer

### Subtask 2.1: Create getDefaultLocationId Helper
**File**: `/home/pbrown/SkuInventory/src/services/location.ts`
**Pattern**: Follow existing `getDefaultLocation` function (line 107-115)
**Instructions**:
1. Add a helper function that returns just the location ID (or null)

```typescript
/**
 * Get the default location ID for a company
 * Returns null if no default location exists
 */
export async function getDefaultLocationId(companyId: string): Promise<string | null> {
  const location = await getDefaultLocation(companyId)
  return location?.id ?? null
}
```

**Validation**:
```bash
npx tsc --noEmit
```
**Completion Criteria**:
- [ ] Function added and exported
- [ ] Returns string | null
- [ ] TypeScript compiles

### Subtask 2.2: Update createReceiptTransaction
**File**: `/home/pbrown/SkuInventory/src/services/inventory.ts`
**Lines**: 92-171
**Pattern**: Add optional param, resolve to default if not provided
**Instructions**:
1. Add `locationId?: string` to params interface (line 92-102)
2. Import `getDefaultLocationId` from `./location`
3. Resolve locationId early in the function:
```typescript
const locationIdToUse = locationId ?? await getDefaultLocationId(companyId)
```
4. Add `locationId: locationIdToUse` to the transaction create data (line 128-143)

**Validation**:
```bash
npx tsc --noEmit
```
**Completion Criteria**:
- [ ] locationId added to params
- [ ] Default resolution logic added
- [ ] locationId passed to prisma.transaction.create
- [ ] TypeScript compiles

### Subtask 2.3: Update createAdjustmentTransaction
**File**: `/home/pbrown/SkuInventory/src/services/inventory.ts`
**Lines**: 176-225
**Pattern**: Same as receipt transaction
**Instructions**:
1. Add `locationId?: string` to params interface (line 176-184)
2. Resolve locationId with default fallback
3. Add `locationId` to transaction create data (line 196-211)

**Validation**:
```bash
npx tsc --noEmit
```
**Completion Criteria**:
- [ ] locationId parameter added
- [ ] Default resolution logic added
- [ ] locationId in create data
- [ ] TypeScript compiles

### Subtask 2.4: Update createInitialTransaction
**File**: `/home/pbrown/SkuInventory/src/services/inventory.ts`
**Lines**: 230-306
**Pattern**: Same as receipt transaction
**Instructions**:
1. Add `locationId?: string` to params interface (line 230-239)
2. Resolve locationId with default fallback
3. Add `locationId` to transaction create data (line 264-291)

**Validation**:
```bash
npx tsc --noEmit
```
**Completion Criteria**:
- [ ] locationId parameter added
- [ ] Default resolution logic added
- [ ] locationId in create data
- [ ] TypeScript compiles

### Subtask 2.5: Update createBuildTransaction
**File**: `/home/pbrown/SkuInventory/src/services/inventory.ts`
**Lines**: 419-567
**Pattern**: Same as receipt transaction
**Instructions**:
1. Add `locationId?: string` to params interface (line 419-431)
2. Resolve locationId with default fallback (after line 450)
3. Add `locationId` to transaction create data (line 486-512)

**Validation**:
```bash
npx tsc --noEmit
```
**Completion Criteria**:
- [ ] locationId parameter added
- [ ] Default resolution logic added
- [ ] locationId in create data
- [ ] TypeScript compiles

## Phase 3: API Routes

### Subtask 3.1: Update Receipt API Route
**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/receipt/route.ts`
**Lines**: 10-73
**Pattern**: Parse locationId from body, validate location exists, pass to service
**Instructions**:
1. Body already parsed via `createReceiptSchema` (which now includes locationId)
2. Add location validation after component validation (line 37-39):
```typescript
// Validate location if provided
if (data.locationId) {
  const location = await prisma.location.findFirst({
    where: {
      id: data.locationId,
      companyId: session.user.companyId,
      isActive: true,
    },
  })
  if (!location) {
    return notFound('Location')
  }
}
```
3. Pass `locationId: data.locationId` to `createReceiptTransaction` (line 42-52)
4. Include locationId in response (line 54-68)

**Validation**:
```bash
npx tsc --noEmit
npm run build
```
**Completion Criteria**:
- [ ] Location validation added
- [ ] locationId passed to service
- [ ] locationId in response
- [ ] Build succeeds

### Subtask 3.2: Update Adjustment API Route
**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/adjustment/route.ts`
**Lines**: 10-71
**Pattern**: Same as receipt route
**Instructions**:
1. Add location validation after component validation
2. Pass `locationId: data.locationId` to `createAdjustmentTransaction`
3. Include locationId in response

**Validation**:
```bash
npx tsc --noEmit
```
**Completion Criteria**:
- [ ] Location validation added
- [ ] locationId passed to service
- [ ] locationId in response

### Subtask 3.3: Update Initial API Route
**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/initial/route.ts`
**Lines**: 10-71
**Pattern**: Same as receipt route
**Instructions**:
1. Add location validation after component validation
2. Pass `locationId: data.locationId` to `createInitialTransaction`
3. Include locationId in response

**Validation**:
```bash
npx tsc --noEmit
```
**Completion Criteria**:
- [ ] Location validation added
- [ ] locationId passed to service
- [ ] locationId in response

### Subtask 3.4: Update Build API Route
**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/build/route.ts`
**Lines**: 10-135
**Pattern**: Same as receipt route (add after SKU validation)
**Instructions**:
1. Add location validation after SKU/BOM validation (around line 58)
2. Pass `locationId: data.locationId` to `createBuildTransaction` (line 70-83)
3. Include locationId in response

**Validation**:
```bash
npx tsc --noEmit
```
**Completion Criteria**:
- [ ] Location validation added
- [ ] locationId passed to service
- [ ] locationId in response

### Subtask 3.5: Update Transaction List Route
**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/route.ts`
**Lines**: 10-98
**Pattern**: Add location to include, add to response mapping
**Instructions**:
1. Add location filter to query schema support (optional - for future)
2. Add location to prisma include (line 54-63):
```typescript
location: { select: { id: true, name: true } },
```
3. Add locationId and location to response mapping (line 67-91):
```typescript
locationId: tx.locationId,
location: tx.location,
```

**Validation**:
```bash
npx tsc --noEmit
```
**Completion Criteria**:
- [ ] location included in query
- [ ] locationId in response
- [ ] location object in response

### Subtask 3.6: Update Transaction Detail Route
**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/[id]/route.ts`
**Lines**: 6-114
**Pattern**: Add location to include with more details
**Instructions**:
1. Add location to prisma include (line 24-56):
```typescript
location: {
  select: {
    id: true,
    name: true,
    type: true,
  },
},
```
2. Add locationId and location to response (line 63-108):
```typescript
locationId: transaction.locationId,
location: transaction.location,
```

**Validation**:
```bash
npx tsc --noEmit
```
**Completion Criteria**:
- [ ] location included in query
- [ ] locationId in response
- [ ] location with type in response

## Phase 4: Import Routes (Optional locationId support)

### Subtask 4.1: Update Inventory Snapshot Import
**File**: `/home/pbrown/SkuInventory/src/app/api/import/inventory-snapshot/route.ts`
**Lines**: 186-197
**Pattern**: Pass undefined for locationId (will use default)
**Instructions**:
1. The service function now handles default location, no changes needed unless we want to accept locationId from import
2. Verify the call still works - locationId is optional

**Validation**:
```bash
npx tsc --noEmit
```
**Completion Criteria**:
- [ ] Import still works
- [ ] Uses default location automatically

### Subtask 4.2: Update Initial Inventory Import
**File**: `/home/pbrown/SkuInventory/src/app/api/import/initial-inventory/route.ts`
**Lines**: 160-169
**Pattern**: Same as inventory snapshot
**Instructions**:
1. Verify the call still works - locationId is optional
2. No changes needed unless we want to support locationId in CSV

**Validation**:
```bash
npx tsc --noEmit
```
**Completion Criteria**:
- [ ] Import still works
- [ ] Uses default location automatically

## Phase 5: Frontend Components

### Subtask 5.1: Update ReceiptDialog with Location Selector
**File**: `/home/pbrown/SkuInventory/src/components/features/ReceiptDialog.tsx`
**Lines**: 1-214
**Pattern**: Follow Select pattern in AdjustmentDialog (lines 16-22, 148-163)
**Instructions**:
1. Add state for locations and loading:
```typescript
const [locations, setLocations] = useState<Array<{ id: string; name: string }>>([])
const [isLoadingLocations, setIsLoadingLocations] = useState(false)
```
2. Add locationId to formData (after notes):
```typescript
locationId: '',
```
3. Add useEffect to fetch locations when dialog opens:
```typescript
useEffect(() => {
  if (open) {
    fetchLocations()
  }
}, [open])

const fetchLocations = async () => {
  setIsLoadingLocations(true)
  try {
    const res = await fetch('/api/locations?isActive=true&pageSize=50')
    if (res.ok) {
      const data = await res.json()
      setLocations(data.data || [])
    }
  } catch (err) {
    console.error('Failed to fetch locations:', err)
  } finally {
    setIsLoadingLocations(false)
  }
}
```
4. Add Location Select component (after Supplier field, around line 150):
```tsx
<div className="grid grid-cols-4 items-center gap-4">
  <Label htmlFor="location" className="text-right">
    Location
  </Label>
  <Select
    value={formData.locationId}
    onValueChange={(value) => setFormData((prev) => ({ ...prev, locationId: value }))}
    disabled={isLoadingLocations}
  >
    <SelectTrigger className="col-span-3">
      <SelectValue placeholder={isLoadingLocations ? 'Loading...' : 'Default location'} />
    </SelectTrigger>
    <SelectContent>
      {locations.map((loc) => (
        <SelectItem key={loc.id} value={loc.id}>
          {loc.name}
        </SelectItem>
      ))}
    </SelectContent>
  </Select>
</div>
```
5. Add locationId to API call body (line 54-62):
```typescript
locationId: formData.locationId || undefined,
```
6. Add imports for Select components

**Validation**:
```bash
npx tsc --noEmit
npm run build
```
**Completion Criteria**:
- [ ] Location Select added
- [ ] Locations fetched on dialog open
- [ ] locationId sent to API
- [ ] Build succeeds

### Subtask 5.2: Update AdjustmentDialog with Location Selector
**File**: `/home/pbrown/SkuInventory/src/components/features/AdjustmentDialog.tsx`
**Lines**: 1-241
**Pattern**: Already has Select imports (lines 16-22)
**Instructions**:
1. Add state for locations and loading
2. Add locationId to formData (after notes)
3. Add useEffect to fetch locations when dialog opens
4. Add Location Select component (after Reason field, around line 213)
5. Add locationId to API call body (line 72-78)

**Validation**:
```bash
npx tsc --noEmit
npm run build
```
**Completion Criteria**:
- [ ] Location Select added
- [ ] Locations fetched on dialog open
- [ ] locationId sent to API
- [ ] Build succeeds

### Subtask 5.3: Update BuildDialog with Location Selector
**File**: `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx`
**Lines**: 1-418
**Pattern**: Already has Select imports and pattern for fetching data
**Instructions**:
1. Add state for locations and loading
2. Add locationId to formData (after salesChannel)
3. Fetch locations in existing useEffect or new one
4. Add Location Select component (after Sales Channel field, around line 326)
5. Add locationId to API call body (line 122-132)

**Validation**:
```bash
npx tsc --noEmit
npm run build
```
**Completion Criteria**:
- [ ] Location Select added
- [ ] Locations fetched on dialog open
- [ ] locationId sent to API
- [ ] Build succeeds

### Subtask 5.4: Update TransactionDetail to Display Location
**File**: `/home/pbrown/SkuInventory/src/components/features/TransactionDetail.tsx`
**Lines**: 1-313
**Pattern**: Follow existing info display pattern (lines 148-169)
**Instructions**:
1. Add location to TransactionDetailProps interface (around line 29-56):
```typescript
location?: { id: string; name: string; type?: string } | null
```
2. Add location display in the info grid (after Sales Channel, around line 169):
```tsx
{/* Location if present */}
{transaction.location && (
  <div>
    <p className="text-sm text-muted-foreground">Location</p>
    <p className="font-medium">{transaction.location.name}</p>
    {transaction.location.type && (
      <p className="text-xs text-muted-foreground capitalize">
        {transaction.location.type.replace('_', ' ')}
      </p>
    )}
  </div>
)}
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```
**Completion Criteria**:
- [ ] location added to props interface
- [ ] Location display added
- [ ] Type displayed if available
- [ ] Build succeeds

## Phase 6: Testing

### Subtask 6.1: Update Integration Tests
**File**: `/home/pbrown/SkuInventory/tests/integration/transactions.test.ts`
**Pattern**: Follow existing test patterns
**Instructions**:
1. Add test cases for:
   - Receipt with explicit locationId
   - Receipt without locationId (uses default)
   - Adjustment with locationId
   - Build with locationId
   - Transaction list includes location
2. Verify tests pass with the new locationId field

**Validation**:
```bash
npm test -- --filter="Transaction"
```
**Completion Criteria**:
- [ ] New test cases added
- [ ] All existing tests still pass
- [ ] Location field verified in responses

---

## Summary of Deliverables
**Files Created**: 1 (migration)
**Files Modified**: 16 total
- Schema: 1 (`prisma/schema.prisma`)
- Types: 1 (`src/types/transaction.ts`)
- Services: 2 (`src/services/inventory.ts`, `src/services/location.ts`)
- API Routes: 6 (transactions/receipt, adjustment, initial, build, route.ts, [id]/route.ts)
- Import Routes: 2 (verified, no changes needed)
- Frontend: 4 (ReceiptDialog, AdjustmentDialog, BuildDialog, TransactionDetail)
- Tests: 1 (transactions.test.ts)

## Handoff to Build Agent
1. Execute subtasks in exact order (Phase 1 -> Phase 2 -> ... -> Phase 6)
2. Run `npx tsc --noEmit` after each TypeScript change
3. Run `npm run build` after completing each phase
4. Test completion criteria before moving to next subtask
5. Follow reference patterns exactly - especially for Select components
6. The locations API is admin-only (403 for non-admins) - frontend needs to handle gracefully

## Test Strategy Note
- Use Vitest for unit/integration tests
- Run `npm test` to verify all tests pass
- Focus on transaction creation with/without locationId

## Key Implementation Details
1. **Default Location Pattern**: Use `const locationIdToUse = locationId ?? await getDefaultLocationId(companyId)`
2. **Location API Access**: The `/api/locations` endpoint is admin-only. For non-admin users, the dialog should either:
   - Not show location selector (use default), OR
   - Show a read-only display of available locations
3. **Backward Compatibility**: All existing code works because locationId is optional
4. **Backfill**: After migration, run SQL to set existing transactions to default location

## Performance Metrics
| Phase | Estimated Duration |
|-------|----------|
| Investigation | 35m |
| Validation | 10m |
| Planning | 25m |
| **Total Scout-and-Plan** | **70m** |

| Build Phase | Estimated Duration |
|-------------|----------|
| Phase 1: Database/Types | 45m |
| Phase 2: Services | 45m |
| Phase 3: API Routes | 60m |
| Phase 4: Import Routes | 15m |
| Phase 5: Frontend | 90m |
| Phase 6: Testing | 45m |
| **Total Build** | **~5-6 hours** |
