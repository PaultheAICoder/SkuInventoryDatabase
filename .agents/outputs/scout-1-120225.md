# Scout Report: User Feedback Submission System with AI-Powered Clarification

## Request Analysis
**Type**: Feature (NEW_FEATURE)
**Source**: GitHub Issue #1
**Priority**: Medium

## Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="feedback"` for feedback-related tests after implementation

## Issue Validation
**Status**: ✅ Valid - Well-specified with detailed requirements
**Recent Changes**: No conflicting work found
- Last closed issue: #22 (Recent transactions on SKU detail) - unrelated
- No recent feedback system implementation found in commit history
- Dashboard layout file confirmed at expected location
- Template files exist and are ready to use

## Current State

### Existing Components
- ✅ **Dashboard Layout**: `/home/pbrown/SkuInventory/src/app/(dashboard)/layout.tsx` - Header area available (lines 113-119)
- ✅ **Dialog Components**: shadcn/ui Dialog components installed and functional
- ✅ **Reference Dialogs**: AdjustmentDialog, BuildDialog, ReceiptDialog - excellent patterns to follow
- ✅ **API Response Helpers**: `/home/pbrown/SkuInventory/src/lib/api-response.ts` - Complete set of response helpers
- ✅ **Authentication**: NextAuth fully configured with session management
- ✅ **Template Files**: `.claude/commands/bug.md` and `feature.md` exist with structured formats
- ✅ **GitHub CLI**: `gh` version 2.83.1 installed and available
- ❌ **Anthropic SDK**: Not installed - will need to add `@anthropic-ai/sdk`
- ❌ **Textarea Component**: Not in UI library - will need to create or import

### Database
- **Optional Feedback Table**: Not in current schema - can add for audit logging
- **User/Company Tables**: Exist and support multi-tenant architecture
- **Authentication**: Fully functional with session.user.id, session.user.companyId

### API Routes Structure
- `/home/pbrown/SkuInventory/src/app/api/` - Well-organized with nested routes
- Existing patterns: `/api/dashboard/route.ts`, `/api/transactions/adjustment/route.ts`
- All routes use `getServerSession(authOptions)` for authentication
- Standard response patterns via `success()`, `error()`, `unauthorized()`, `serverError()`

### Types
- `/home/pbrown/SkuInventory/src/types/` - Organized type definitions
- Common types in `index.ts`: ApiError, ApiSuccess, SessionUser
- Need to create: `feedback.ts` for feedback-specific types

### UI Components (shadcn/ui)
- ✅ Dialog, Button, Input, Label, Select - all available
- ❌ Textarea - needs to be added to `/home/pbrown/SkuInventory/src/components/ui/`
- ✅ Toast notifications via `sonner` - used in ImportForm.tsx

## Dependencies & Blockers

### Required Dependencies (Must Install)
1. **@anthropic-ai/sdk** - For Claude API integration
   ```bash
   npm install @anthropic-ai/sdk
   ```

2. **Textarea UI Component** - For multi-line input
   - Either install via shadcn/ui CLI: `npx shadcn-ui@latest add textarea`
   - Or create manually following shadcn pattern

### Environment Variables (Must Add)
1. **ANTHROPIC_API_KEY** - For Claude API access
   - Add to `.env`: `ANTHROPIC_API_KEY=sk-ant-...`
   - Add to `.env.example`: `ANTHROPIC_API_KEY=your-anthropic-api-key`
   - Add to `/home/pbrown/SkuInventory/src/lib/env.ts` schema validation

### Optional: GitHub Token
- Currently using `gh` CLI which uses system credentials
- Alternative: Add `GITHUB_TOKEN` env var if using `@octokit/rest`

**Can Proceed?**: WITH FIXES (after installing dependencies)

## Complexity Assessment
**Complexity**: Moderate
**Effort**: 10-14 hours
**Risk**: Medium

**Breakdown**:
- Setup (deps, env, types): 1-2 hours
- Backend API routes: 3-4 hours
- Frontend components: 4-5 hours
- Integration & testing: 2-3 hours

**Risk Factors**:
- External API dependency (Claude) - need fallback if unavailable
- Rate limiting consideration for abuse prevention
- Handling AI response errors gracefully
- GitHub issue creation failures

## Patterns to Follow

### Primary Patterns
1. **Dialog Component**: `/home/pbrown/SkuInventory/src/components/features/AdjustmentDialog.tsx`
   - Multi-step form handling
   - Loading states, error handling
   - Form validation and submission
   - Router refresh pattern

2. **API Route**: `/home/pbrown/SkuInventory/src/app/api/dashboard/route.ts`
   - Session authentication with `getServerSession(authOptions)`
   - Response helpers: `success()`, `unauthorized()`, `serverError()`
   - Error handling with try/catch
   - TypeScript typing for responses

3. **Multi-step Dialog**: `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx`
   - useEffect for data fetching when dialog opens
   - Loading states during fetch
   - Conditional rendering based on step

### Secondary Patterns
1. **Toast Notifications**: `/home/pbrown/SkuInventory/src/components/features/ImportForm.tsx`
   - Using `toast.success()`, `toast.error()`, `toast.warning()`

2. **Type Definitions**: `/home/pbrown/SkuInventory/src/types/component.ts`
   - Zod schemas for validation
   - Request/Response interfaces
   - Export patterns

## Files to Create

### Components (2 files)
1. `/home/pbrown/SkuInventory/src/components/features/FeedbackButton.tsx`
   - Simple button component with feedback icon (MessageSquare from lucide-react)
   - Opens dialog on click
   - Positioned in header

2. `/home/pbrown/SkuInventory/src/components/features/FeedbackDialog.tsx`
   - Multi-step dialog: select-type → describe → clarify → submitting → success
   - State management for form data
   - API calls to clarify and submit endpoints
   - Error and loading state handling

### API Routes (2 files)
3. `/home/pbrown/SkuInventory/src/app/api/feedback/clarify/route.ts`
   - POST endpoint
   - Accepts: { type: 'bug'|'feature', description: string }
   - Calls Claude API to generate 3 clarifying questions
   - Returns: { questions: string[] }

4. `/home/pbrown/SkuInventory/src/app/api/feedback/route.ts`
   - POST endpoint
   - Accepts: { type, description, answers: string[] }
   - Formats issue using bug.md or feature.md template
   - Creates GitHub issue via `gh` CLI
   - Returns: { issueUrl: string, issueNumber: number }

### Types (1 file)
5. `/home/pbrown/SkuInventory/src/types/feedback.ts`
   - FeedbackType: 'bug' | 'feature'
   - FeedbackStep enum
   - Request/Response interfaces for API
   - Zod validation schemas

### UI Components (1 file)
6. `/home/pbrown/SkuInventory/src/components/ui/textarea.tsx`
   - Standard shadcn/ui textarea component
   - Styled with tailwind classes

### Lib Utilities (1 file)
7. `/home/pbrown/SkuInventory/src/lib/claude.ts`
   - Claude API client initialization
   - Helper function for generating clarifying questions
   - Error handling and retry logic
   - Type-safe API wrapper

## Files to Modify

### Layout (1 file)
1. `/home/pbrown/SkuInventory/src/app/(dashboard)/layout.tsx`
   - **Line 113-119**: Add FeedbackButton to mobile header
   - Import FeedbackButton component
   - Position in upper right area

### Environment Configuration (3 files)
2. `/home/pbrown/SkuInventory/src/lib/env.ts`
   - Add `ANTHROPIC_API_KEY: z.string().min(1)` to envSchema

3. `/home/pbrown/SkuInventory/.env`
   - Add `ANTHROPIC_API_KEY=sk-ant-...`

4. `/home/pbrown/SkuInventory/.env.example`
   - Add `ANTHROPIC_API_KEY=your-anthropic-api-key` with explanation

### Package Configuration (1 file)
5. `/home/pbrown/SkuInventory/package.json`
   - Add `@anthropic-ai/sdk` to dependencies

## Final Sweep Results

### Services Search
**Files in src/services/**: 4 files (bom.ts, export.ts, import.ts, inventory.ts)
- ✅ None affected - no inventory or service layer changes needed

### API Routes
**Files in src/app/api/**: 13 directories
- ✅ No existing routes affected - creating new `/api/feedback` routes

### Type Definitions
**Files in src/types/**: 7 files
- ✅ None affected - creating new `feedback.ts` type file

### Components
**Dialog components found**: 3 feature dialogs (AdjustmentDialog, BuildDialog, ReceiptDialog)
- ✅ None affected - creating new FeedbackDialog following existing patterns

### Test Files
**Test directories**: tests/unit/, tests/e2e/
- ⚠️ Will need to add tests for new feedback functionality after implementation

### All Affected Files (Comprehensive List)

**Files to Create (8):**
- `/home/pbrown/SkuInventory/src/components/features/FeedbackButton.tsx` - Trigger button
- `/home/pbrown/SkuInventory/src/components/features/FeedbackDialog.tsx` - Main dialog component
- `/home/pbrown/SkuInventory/src/components/ui/textarea.tsx` - UI component for multi-line input
- `/home/pbrown/SkuInventory/src/app/api/feedback/clarify/route.ts` - AI clarification endpoint
- `/home/pbrown/SkuInventory/src/app/api/feedback/route.ts` - Issue creation endpoint
- `/home/pbrown/SkuInventory/src/types/feedback.ts` - TypeScript types
- `/home/pbrown/SkuInventory/src/lib/claude.ts` - Claude API client wrapper
- `/home/pbrown/SkuInventory/prisma/migrations/XXXXXX_add_feedback_table.sql` - Optional DB migration

**Files to Modify (5):**
- `/home/pbrown/SkuInventory/src/app/(dashboard)/layout.tsx` - Add feedback button to header
- `/home/pbrown/SkuInventory/src/lib/env.ts` - Add ANTHROPIC_API_KEY validation
- `/home/pbrown/SkuInventory/.env` - Add API key (not in repo)
- `/home/pbrown/SkuInventory/.env.example` - Add API key placeholder
- `/home/pbrown/SkuInventory/package.json` - Add @anthropic-ai/sdk dependency

**Total Files Affected**: 13 files (8 new, 5 modified)

## Ripple Effect Analysis

**No ripple effects expected** - This is a standalone feature that:
- Does NOT modify existing components
- Does NOT change existing API routes
- Does NOT alter database schema for existing tables (optional Feedback table is new)
- Does NOT affect authentication or authorization flows
- Uses external APIs (Claude, GitHub) without impacting internal services

**Function Call Chain**: New feature with isolated call chain
1. User clicks FeedbackButton → opens FeedbackDialog
2. FeedbackDialog calls → `/api/feedback/clarify` → Claude API
3. FeedbackDialog calls → `/api/feedback` → GitHub CLI
4. No existing functions are modified

**Dependency Tree**: Minimal dependencies on existing code
- Uses: Dialog UI components (no changes)
- Uses: Authentication (no changes to auth flow)
- Uses: API response helpers (no changes)

## Acceptance Criteria

- [ ] Feedback button visible in upper right of mobile header (line ~118 in layout.tsx)
- [ ] Clicking button opens dialog with bug/feature selection
- [ ] User can enter description (textarea component)
- [ ] Claude API returns 3 relevant clarifying questions
- [ ] Questions are specific to the submission type and content
- [ ] User can answer all questions
- [ ] Submitting creates GitHub issue with formatted content
- [ ] Issue follows bug.md or feature.md template format
- [ ] User sees success confirmation with issue URL
- [ ] User sees error message if submission fails
- [ ] All API calls require authentication
- [ ] Graceful fallback if Claude API unavailable (direct submission without questions)
- [ ] Rate limiting prevents abuse (max 5 submissions per hour per user)
- [ ] `npm run build` completes without errors
- [ ] `npx tsc --noEmit` completes without errors
- [ ] Sensitive data not sent to external APIs

## Implementation Phases

### Phase 1: Setup & Dependencies (2 hours)
1. Install `@anthropic-ai/sdk` and textarea component
2. Add environment variables and validation
3. Create type definitions in `feedback.ts`
4. Create Claude API wrapper in `lib/claude.ts`

### Phase 2: Backend API Routes (3-4 hours)
1. Create `/api/feedback/clarify` endpoint with Claude integration
2. Create `/api/feedback` endpoint with GitHub CLI integration
3. Add rate limiting logic
4. Add error handling and fallbacks
5. Test API endpoints with curl/Postman

### Phase 3: Frontend Components (4-5 hours)
1. Create FeedbackButton component
2. Create FeedbackDialog with multi-step flow
3. Wire up API calls
4. Add loading states and error handling
5. Add toast notifications for feedback

### Phase 4: Integration & Testing (2-3 hours)
1. Add FeedbackButton to layout header
2. Test complete user flow end-to-end
3. Test error scenarios (API failures, invalid input)
4. Test rate limiting
5. Verify GitHub issues created correctly
6. Build and typecheck verification

## Handoff to Plan Agent

**Summary**:
This is a well-specified NEW_FEATURE request to add an AI-powered feedback submission system. The feature allows users to submit bug reports or feature requests directly from the application, with Claude API generating 3 clarifying questions before creating a formatted GitHub issue. The project has all necessary infrastructure (authentication, dialog components, API patterns) in place. Two dependencies must be installed: `@anthropic-ai/sdk` and a textarea UI component. The implementation follows existing dialog patterns (AdjustmentDialog, BuildDialog) and API patterns (dashboard route). Complexity is moderate (10-14 hours) with 8 new files and 5 file modifications. No ripple effects expected as this is a standalone feature.

**Key Points**:
1. **Dependencies Required**: Install `@anthropic-ai/sdk` and add textarea component before starting
2. **Environment Setup**: Add `ANTHROPIC_API_KEY` to env files and validation schema
3. **Strong Patterns Available**: AdjustmentDialog for multi-step forms, dashboard API for authentication
4. **GitHub Integration**: Use existing `gh` CLI (v2.83.1) - no additional library needed
5. **Templates Ready**: bug.md and feature.md templates exist and are well-structured
6. **Authentication**: All routes must use `getServerSession(authOptions)` pattern
7. **No Ripple Effects**: Isolated feature with no impact on existing code
8. **Rate Limiting**: Must implement to prevent abuse (suggested: 5 per hour per user)

**Suggested Phases**:
1. Setup & Dependencies (install packages, add env vars, create types)
2. Backend API Routes (clarify endpoint with Claude, feedback endpoint with GitHub)
3. Frontend Components (FeedbackButton, FeedbackDialog with multi-step flow)
4. Integration & Testing (add to layout, test all flows, verify build)

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Issue Parsing | 1m |
| Codebase Exploration | 5m |
| Pattern Identification | 3m |
| Final Sweep | 2m |
| Report Writing | 8m |
| **Total** | **19m** |

---

**AGENT_RETURN**: scout-1-120225
