# Implementation Plan
**Generated**: 2026-01-02T14:30:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #354
**Estimated Build Time**: 2-3 hours
**Complexity**: Low-Medium

## Investigation Summary

### Request Analysis
**Type**: Feature (Database schema and types setup)
**Source**: GitHub Issue #354
**Priority**: P1-MVP (labeled)

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: FAST_PATH (database schema changes - migration validation only)
**Suggested Filter**: None (no tests for this phase)

### Issue Validation
**Status**: Valid
**Recent Changes**: None affecting this issue - this is the first task in a new feature
**Spec Reference**: `/home/pbrown/SkuInventory/specs/001-recommendation-engine/`

### Current State Assessment
- **Existing components**: None - new feature starting from scratch
- **Database**:
  - Prisma schema exists at `/home/pbrown/SkuInventory/prisma/schema.prisma` (1050 lines)
  - Related models already exist: `Brand`, `User`, `KeywordMetric`, `AdCampaign`
  - No recommendation-related models exist yet
- **API Routes**: None exist yet (planned for future issues)
- **Types**:
  - TypeScript types directory exists at `/home/pbrown/SkuInventory/src/types/`
  - Export pattern in `/home/pbrown/SkuInventory/src/types/index.ts`
  - No `recommendations.ts` file exists yet
- **Lib utilities**:
  - Pattern exists at `/home/pbrown/SkuInventory/src/lib/utils.ts`
  - No `recommendation-utils.ts` file exists yet

### Dependencies & Blockers
1. None - this is a foundational setup task with no dependencies

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Low-Medium
**Effort**: 2-3 hours
**Risk**: Low (new tables, no breaking changes to existing functionality)

### Patterns Identified
**Primary**: `/home/pbrown/SkuInventory/src/types/attribution.ts` - TypeScript types with zod schemas
**Secondary**: `/home/pbrown/SkuInventory/src/types/draft.ts` - enum types and status configurations

### Ripple Effect Analysis
**Files Identified**: 6 files to modify/create
- `/home/pbrown/SkuInventory/prisma/schema.prisma` - Add enums, models, and relations
- `/home/pbrown/SkuInventory/src/types/recommendations.ts` - New file with interfaces
- `/home/pbrown/SkuInventory/src/lib/recommendation-utils.ts` - New file with utilities
- `/home/pbrown/SkuInventory/src/types/index.ts` - Export new types

**Models requiring relation updates**:
- `Brand` - Add `recommendations` and `watchedKeywords` relations
- `User` - Add `changeLogEntries` and `watchedKeywords` relations
- `KeywordMetric` - Add `recommendations` relation
- `AdCampaign` - Add `recommendations` relation

---

## Executive Summary
This issue sets up the foundational database schema and TypeScript types for the Recommendation Engine feature. It creates four new Prisma enums (RecommendationType, RecommendationStatus, ConfidenceLevel, ChangeLogAction), three new models (Recommendation, ChangeLogEntry, WatchedKeyword) with proper indexes, adds relations to existing models, and creates TypeScript interfaces for use by future service implementations.

## Phase 1: TypeScript Types and Utilities

### Subtask 1.1: Create TypeScript Interfaces
**File**: `/home/pbrown/SkuInventory/src/types/recommendations.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/types/attribution.ts` structure
**Instructions**:
1. Create new file with TypeScript interfaces matching the spec
2. Include zod validation schemas where appropriate
3. Define the following types:
   - `RecommendationType` - enum: KEYWORD_GRADUATION, DUPLICATE_KEYWORD, NEGATIVE_KEYWORD, BUDGET_INCREASE, BID_DECREASE
   - `RecommendationStatus` - enum: PENDING, ACCEPTED, REJECTED, SNOOZED, EXPIRED
   - `ConfidenceLevel` - enum: HIGH, MEDIUM, LOW
   - `ChangeLogAction` - enum: ACCEPTED, REJECTED, SNOOZED
   - `ExpectedImpact` interface for impact JSON structure
   - `Recommendation` interface matching Prisma model
   - `ChangeLogEntry` interface matching Prisma model
   - `WatchedKeyword` interface matching Prisma model
   - `RecommendationThresholds` interface for brand settings
   - Query/filter schemas for API endpoints
4. Add JSDoc comments for complex types

**Code Reference** (from spec data-model.md):
```typescript
// Enums should match Prisma enums
export type RecommendationType =
  | 'KEYWORD_GRADUATION'
  | 'DUPLICATE_KEYWORD'
  | 'NEGATIVE_KEYWORD'
  | 'BUDGET_INCREASE'
  | 'BID_DECREASE'

export type RecommendationStatus =
  | 'PENDING'
  | 'ACCEPTED'
  | 'REJECTED'
  | 'SNOOZED'
  | 'EXPIRED'

export type ConfidenceLevel = 'HIGH' | 'MEDIUM' | 'LOW'

export type ChangeLogAction = 'ACCEPTED' | 'REJECTED' | 'SNOOZED'

// ExpectedImpact structure
export interface ExpectedImpact {
  metric: string  // e.g., 'acos', 'roas', 'spend'
  current: number
  projected: number
}

// Recommendation thresholds (stored in Brand.settings JSON)
export interface RecommendationThresholds {
  graduation?: {
    maxAcos?: number      // default: 0.25
    minConversions?: number // default: 5
    minSpend?: number      // default: 50
  }
  negative?: {
    minSpend?: number      // default: 25
    maxOrders?: number     // default: 0
    minClicks?: number     // default: 50
  }
  budget?: {
    minRoas?: number       // default: 1.5
    budgetUtilization?: number // default: 0.95
  }
}
```

**Validation Command**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] File created with all types
- [ ] Types compile without errors
- [ ] Zod schemas defined for API validation

---

### Subtask 1.2: Create Shared Utilities
**File**: `/home/pbrown/SkuInventory/src/lib/recommendation-utils.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/lib/utils.ts` structure
**Instructions**:
1. Create new file with utility functions
2. Define default threshold constants:
   ```typescript
   export const DEFAULT_THRESHOLDS = {
     graduation: {
       maxAcos: 0.25,
       minConversions: 5,
       minSpend: 50,
     },
     negative: {
       minSpend: 25,
       maxOrders: 0,
       minClicks: 50,
     },
     budget: {
       minRoas: 1.5,
       budgetUtilization: 0.95,
     },
   } as const
   ```
3. Add helper functions:
   - `mergeThresholds(brandSettings, defaults)` - Merge brand overrides with defaults
   - `calculateSnoozedUntil(days: number)` - Calculate snooze end date
   - `isRecommendationExpired(recommendation)` - Check if recommendation should be expired

**Validation Command**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] File created with constants and helpers
- [ ] Compiles without errors
- [ ] Exports are correct

---

### Subtask 1.3: Export Types from Index
**File**: `/home/pbrown/SkuInventory/src/types/index.ts`
**Pattern**: Follow existing export pattern (line 114-117)
**Instructions**:
1. Add export for recommendations types:
   ```typescript
   // Recommendation types
   export * from './recommendations'
   ```

**Validation Command**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Export added
- [ ] Types accessible via `@/types`

---

## Phase 2: Prisma Schema Updates

### Subtask 2.1: Add Prisma Enums
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Location**: After line 1049 (after ContainerMonitorConfig model)
**Instructions**:
1. Add section header comment
2. Add four enums:
   ```prisma
   // ============================================
   // Recommendation Engine (MVP-2)
   // ============================================

   enum RecommendationType {
     KEYWORD_GRADUATION
     DUPLICATE_KEYWORD
     NEGATIVE_KEYWORD
     BUDGET_INCREASE
     BID_DECREASE
   }

   enum RecommendationStatus {
     PENDING
     ACCEPTED
     REJECTED
     SNOOZED
     EXPIRED
   }

   enum ConfidenceLevel {
     HIGH
     MEDIUM
     LOW
   }

   enum ChangeLogAction {
     ACCEPTED
     REJECTED
     SNOOZED
   }
   ```

**Validation Command**:
```bash
npx prisma validate
```

**Completion Criteria**:
- [ ] Enums added to schema
- [ ] Schema validates

---

### Subtask 2.2: Add Recommendation Model
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Location**: After enums added in 2.1
**Instructions**:
1. Add Recommendation model with all fields and indexes per spec:
   ```prisma
   model Recommendation {
     id              String               @id @default(uuid())
     brandId         String
     brand           Brand                @relation(fields: [brandId], references: [id])

     type            RecommendationType
     status          RecommendationStatus @default(PENDING)
     confidence      ConfidenceLevel

     keyword         String?              @db.VarChar(500)
     keywordMetricId String?
     keywordMetric   KeywordMetric?       @relation(fields: [keywordMetricId], references: [id])
     campaignId      String?
     campaign        AdCampaign?          @relation(fields: [campaignId], references: [id])

     rationale       String               @db.Text
     expectedImpact  Json
     metadata        Json?

     generatedAt     DateTime
     snoozedUntil    DateTime?

     createdAt       DateTime             @default(now())
     updatedAt       DateTime             @updatedAt

     changeLogEntries ChangeLogEntry[]

     @@index([brandId, status, createdAt])
     @@index([brandId, type, status])
     @@index([keywordMetricId])
   }
   ```

**Validation Command**:
```bash
npx prisma validate
```

**Completion Criteria**:
- [ ] Model added with all fields
- [ ] Indexes defined correctly
- [ ] Schema validates

---

### Subtask 2.3: Add ChangeLogEntry Model
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Location**: After Recommendation model
**Instructions**:
1. Add ChangeLogEntry model with all fields and indexes:
   ```prisma
   model ChangeLogEntry {
     id               String           @id @default(uuid())
     recommendationId String
     recommendation   Recommendation   @relation(fields: [recommendationId], references: [id])

     action           ChangeLogAction
     reason           String?          @db.Text
     notes            String?          @db.Text

     beforeValues     Json
     afterValues      Json?

     userId           String
     user             User             @relation(fields: [userId], references: [id])

     createdAt        DateTime         @default(now())

     @@index([createdAt(sort: Desc)])
     @@index([action])
     @@index([recommendationId])
     @@index([userId, createdAt])
   }
   ```

**Validation Command**:
```bash
npx prisma validate
```

**Completion Criteria**:
- [ ] Model added with all fields
- [ ] Indexes defined correctly

---

### Subtask 2.4: Add WatchedKeyword Model
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Location**: After ChangeLogEntry model
**Instructions**:
1. Add WatchedKeyword model with unique constraint:
   ```prisma
   model WatchedKeyword {
     id       String   @id @default(uuid())
     userId   String
     user     User     @relation(fields: [userId], references: [id])
     keyword  String   @db.VarChar(500)
     brandId  String
     brand    Brand    @relation(fields: [brandId], references: [id])
     addedAt  DateTime @default(now())

     @@unique([userId, keyword, brandId])
     @@index([userId, brandId])
     @@index([keyword, brandId])
   }
   ```

**Validation Command**:
```bash
npx prisma validate
```

**Completion Criteria**:
- [ ] Model added with unique constraint
- [ ] Indexes defined correctly

---

### Subtask 2.5: Add Relations to Existing Models
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Instructions**:
1. **Add to Brand model** (around line 73-92):
   - After `asinSkuMappings` relation, add:
   ```prisma
   // V2: Recommendation Engine relations
   recommendations   Recommendation[]
   watchedKeywords   WatchedKeyword[]
   ```

2. **Add to User model** (around line 113-153):
   - After `notifications` relation, add:
   ```prisma
   // V2: Recommendation Engine relations
   changeLogEntries  ChangeLogEntry[]
   watchedKeywords   WatchedKeyword[]
   ```

3. **Add to KeywordMetric model** (around line 836-881):
   - After existing fields, add:
   ```prisma
   // V2: Recommendation Engine relation
   recommendations   Recommendation[]
   ```

4. **Add to AdCampaign model** (around line 785-814):
   - After existing fields, add:
   ```prisma
   // V2: Recommendation Engine relation
   recommendations   Recommendation[]
   ```

**Validation Command**:
```bash
npx prisma validate
```

**Completion Criteria**:
- [ ] Brand model updated with recommendations and watchedKeywords relations
- [ ] User model updated with changeLogEntries and watchedKeywords relations
- [ ] KeywordMetric model updated with recommendations relation
- [ ] AdCampaign model updated with recommendations relation
- [ ] Schema validates

---

## Phase 3: Migration and Verification

### Subtask 3.1: Run Prisma Migration
**File**: N/A (database operation)
**Instructions**:
1. Generate and run the migration:
   ```bash
   DATABASE_URL="postgresql://inventory_test:inventory_test_2025@localhost:2346/inventory_test" npx prisma migrate dev --name add_recommendation_engine
   ```
2. Verify migration creates:
   - 4 enums (RecommendationType, RecommendationStatus, ConfidenceLevel, ChangeLogAction)
   - 3 tables (Recommendation, ChangeLogEntry, WatchedKeyword)
   - Proper indexes

3. Generate Prisma client:
   ```bash
   npx prisma generate
   ```

**Validation Command**:
```bash
# Verify tables exist
docker exec inventory-db-test psql -U inventory_test -d inventory_test -c "\dt *recommendation*"
docker exec inventory-db-test psql -U inventory_test -d inventory_test -c "\dt *changelog*"
docker exec inventory-db-test psql -U inventory_test -d inventory_test -c "\dt *watchedkeyword*"
```

**Completion Criteria**:
- [ ] Migration runs without errors
- [ ] Tables created in test database
- [ ] Prisma client regenerated

---

### Subtask 3.2: Verify in Prisma Studio
**File**: N/A (verification step)
**Instructions**:
1. Open Prisma Studio:
   ```bash
   DATABASE_URL="postgresql://inventory_test:inventory_test_2025@localhost:2346/inventory_test" npx prisma studio
   ```
2. Verify:
   - Recommendation model appears with correct fields
   - ChangeLogEntry model appears with correct fields
   - WatchedKeyword model appears with correct fields
   - Relations visible (Brand, User, KeywordMetric, AdCampaign)

**Completion Criteria**:
- [ ] All models visible in Prisma Studio
- [ ] Fields match spec
- [ ] Relations work correctly

---

### Subtask 3.3: Final Build Verification
**File**: N/A (verification step)
**Instructions**:
1. Run TypeScript check:
   ```bash
   npx tsc --noEmit
   ```
2. Run build:
   ```bash
   npm run build
   ```

**Completion Criteria**:
- [ ] TypeScript compiles without errors
- [ ] Build completes successfully

---

## Summary of Deliverables

**Files Created**: 2
- `/home/pbrown/SkuInventory/src/types/recommendations.ts`
- `/home/pbrown/SkuInventory/src/lib/recommendation-utils.ts`

**Files Modified**: 2
- `/home/pbrown/SkuInventory/prisma/schema.prisma` (add enums, models, relations)
- `/home/pbrown/SkuInventory/src/types/index.ts` (add export)

**Database Changes**:
- 4 enums created
- 3 tables created with indexes
- 4 existing models updated with relations
- 1 migration file generated

## Handoff to Build Agent
1. Execute subtasks in exact order (Phase 1 before Phase 2, Phase 2 before Phase 3)
2. TypeScript types must compile before adding Prisma models
3. Prisma schema must validate before running migration
4. Use test database (port 2346) for all database operations
5. Follow reference patterns exactly from spec files

## Test Strategy Note
- No unit tests required for this issue (schema/types only)
- Validation via `npx prisma validate` and `npx tsc --noEmit`
- Manual verification in Prisma Studio

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 8m |
| Validation | 3m |
| Planning | 12m |
| **Total** | **23m** |

---

## Reference Documents
- Spec: `/home/pbrown/SkuInventory/specs/001-recommendation-engine/spec.md`
- Data Model: `/home/pbrown/SkuInventory/specs/001-recommendation-engine/data-model.md`
- Tasks: `/home/pbrown/SkuInventory/specs/001-recommendation-engine/tasks.md`
- API Contract: `/home/pbrown/SkuInventory/specs/001-recommendation-engine/contracts/recommendations-api.yaml`
