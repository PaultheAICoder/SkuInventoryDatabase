# Implementation Plan
**Generated**: 2026-01-01T12:00:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #350
**Estimated Build Time**: 8-10 hours
**Complexity**: Medium

---

## Investigation Summary

### Request Analysis
**Type**: Feature (UI Components)
**Source**: GitHub Issue #350
**Parent Issue**: #338 (Complete Amazon Seller Central integration)
**Priority**: High

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="analytics|chart"` or None

### Issue Validation
**Status**: Valid
**Recent Changes**: Attribution service (#348) completed, providing backend data support
**Dependencies Met**: Yes - `/api/sales-daily` route and attribution service exist

### Current State Assessment

**Existing Components**:
- `/src/app/(dashboard)/amazon/page.tsx` - Placeholder "Coming Soon" page (needs full replacement)
- `/src/components/features/DefectTrendChart.tsx` - Pattern for LineChart (Recharts)
- `/src/components/features/DefectBOMComparisonChart.tsx` - Pattern for BarChart (Recharts)
- `/src/components/features/DashboardTimeFilter.tsx` - Pattern for date range selector
- `/src/components/features/SparklineTimeFilter.tsx` - Compact time filter (7d/30d/90d buttons)

**Database**:
- `SalesDaily` model exists with `totalSales`, `adAttributedSales`, `organicSales`, etc.
- `KeywordMetric` model exists with `spend`, `sales`, `acos`, `roas`, `impressions`, `clicks`
- No migrations needed

**API Routes**:
- `/api/sales-daily` - EXISTS, returns daily sales with organic/ad breakdown
- `/api/sales-daily?breakdown=attribution` - Returns full attribution breakdown
- `/api/keyword-metrics` - DOES NOT EXIST (needs to be created for top keywords chart)
- `/api/brands` - EXISTS for brand filtering

**Types**:
- `/src/types/attribution.ts` - AttributionResponse, DailyAttribution, etc.
- Need to create Amazon analytics types

### Dependencies & Blockers

1. **Keyword Metrics API Route** - Does not exist, needs to be created for the KeywordPerformanceChart
2. **Recharts 3.5.1** - Installed and working
3. **PieChart** - Not currently used in codebase but available in Recharts

**Can Proceed?**: YES (API route for keywords can be created as part of this work)

### Complexity Assessment
**Complexity**: Moderate
**Effort**: 8-10 hours
**Risk**: Low (follows established patterns)

### Patterns Identified

**Primary Reference**: `/src/components/features/DefectTrendChart.tsx`
- LineChart with multiple lines
- Tooltip customization
- ResponsiveContainer usage
- Loading/empty states
- Card wrapper pattern

**Secondary Reference**: `/src/components/features/DefectBOMComparisonChart.tsx`
- BarChart implementation
- Custom tooltips
- Data transformation

**Time Filter Reference**: `/src/components/features/SparklineTimeFilter.tsx`
- Compact 7d/30d/90d button group

**Dashboard Layout Reference**: `/src/components/features/DefectAnalyticsDashboard.tsx`
- Tab-based layout
- Filter handling
- Data fetching pattern with useCallback
- Loading/error states

### Ripple Effect Analysis
**Files Identified**: 6 (4 new, 2 modified)

**New Files**:
- `/src/components/analytics/SalesTrendChart.tsx`
- `/src/components/analytics/AcosRoasChart.tsx`
- `/src/components/analytics/OrganicVsAdChart.tsx`
- `/src/components/analytics/KeywordPerformanceChart.tsx`

**Modified Files**:
- `/src/app/(dashboard)/amazon/page.tsx` - Replace placeholder with dashboard
- `/src/app/api/analytics/amazon/route.ts` - New API route for keyword metrics (create)

---

## Executive Summary

This issue implements the visualization layer for Amazon Analytics, creating four chart components (Sales Trend, ACOS/ROAS, Organic vs Ad pie chart, and Top Keywords bar chart) plus a date range selector. The components will fetch data from the existing `/api/sales-daily` endpoint for sales/attribution data and a new keyword metrics API endpoint. All charts follow the established Recharts patterns from DefectTrendChart and DefectBOMComparisonChart.

---

## Phase 0: Directory Setup

### Subtask 0.1: Create Analytics Components Directory
**File**: `/src/components/analytics/` (new directory)
**Instructions**:
1. Create the directory: `mkdir -p src/components/analytics`
2. This will house all Amazon analytics chart components

**Completion Criteria**:
- [ ] Directory exists

---

## Phase 1: Types Layer

### Subtask 1.1: Create Amazon Analytics Types
**File**: `/src/types/amazon-analytics.ts` (NEW)
**Pattern**: Follow `/src/types/attribution.ts` structure
**Instructions**:
1. Create new file with the following types:

```typescript
// Date range preset type
export type DateRangePreset = '7d' | '30d' | '90d' | 'custom'

// Sales trend data point for charting
export interface SalesTrendDataPoint {
  date: string  // YYYY-MM-DD
  totalSales: number
  adAttributedSales: number
  organicSales: number
}

// ACOS/ROAS trend data point
export interface AcosRoasDataPoint {
  date: string
  acos: number  // percentage
  roas: number  // ratio
  spend: number
  sales: number
}

// Organic vs Ad breakdown for pie chart
export interface OrganicAdBreakdown {
  organic: number
  adAttributed: number
  organicPercentage: number
  adPercentage: number
}

// Keyword performance data
export interface KeywordPerformanceData {
  keyword: string
  spend: number
  sales: number
  impressions: number
  clicks: number
  acos: number
  roas: number
  orders: number
}

// Summary stats for dashboard
export interface AmazonAnalyticsSummary {
  totalSales: number
  organicSales: number
  adAttributedSales: number
  organicPercentage: number
  totalSpend: number
  overallAcos: number
  overallRoas: number
}

// Keyword metrics API response
export interface KeywordMetricsResponse {
  keywords: KeywordPerformanceData[]
  dateRange: {
    startDate: string
    endDate: string
  }
  totals: {
    totalSpend: number
    totalSales: number
    totalImpressions: number
    totalClicks: number
    overallAcos: number
    overallRoas: number
  }
}
```

**Completion Criteria**:
- [ ] File created with all types
- [ ] `npx tsc --noEmit` passes

---

## Phase 2: API Layer

### Subtask 2.1: Create Keyword Metrics API Route
**File**: `/src/app/api/analytics/amazon/route.ts` (NEW)
**Pattern**: Follow `/src/app/api/analytics/defects/route.ts` and `/src/app/api/sales-daily/route.ts`
**Instructions**:
1. Create directory: `mkdir -p src/app/api/analytics/amazon`
2. Create the route file with:
   - GET handler for keyword metrics
   - Authentication via `getServerSession(authOptions)`
   - Company scoping via `session.user.selectedCompanyId`
   - Query params: `brandId`, `startDate`, `endDate`, `limit` (default 10)
   - Query the `KeywordMetric` model grouped by keyword
   - Calculate aggregated spend, sales, ACOS, ROAS per keyword
   - Sort by spend descending
   - Return top N keywords with metrics

```typescript
// Key query structure:
const keywordData = await prisma.keywordMetric.groupBy({
  by: ['keyword'],
  where: {
    date: { gte: startDate, lte: endDate },
    // Filter by campaigns belonging to user's brands
  },
  _sum: {
    spend: true,
    sales: true,
    impressions: true,
    clicks: true,
    orders: true,
  },
  orderBy: {
    _sum: { spend: 'desc' }
  },
  take: limit,
})
```

**Completion Criteria**:
- [ ] Route created at `/api/analytics/amazon`
- [ ] Returns keyword metrics with ACOS/ROAS calculated
- [ ] Authentication enforced
- [ ] Company scoping works
- [ ] `npx tsc --noEmit` passes

---

## Phase 3: Chart Components

### Subtask 3.1: Create SalesTrendChart Component
**File**: `/src/components/analytics/SalesTrendChart.tsx` (NEW)
**Pattern**: Follow `/src/components/features/DefectTrendChart.tsx` exactly
**Instructions**:
1. Create component with props:
   ```typescript
   interface SalesTrendChartProps {
     data: SalesTrendDataPoint[]
     isLoading?: boolean
   }
   ```
2. Use Recharts `LineChart` with `ResponsiveContainer`
3. Three lines: Total (blue), Organic (green), Ad-Attributed (orange)
4. Custom tooltip showing all three values with currency formatting
5. X-axis: formatted dates
6. Y-axis: currency values ($)
7. Include empty state: "No sales data available"
8. Include loading state (use Skeleton or Loader2 spinner)
9. Wrap in Card with CardHeader/CardContent

**Recharts imports needed**:
```typescript
import {
  LineChart, Line, XAxis, YAxis, CartesianGrid,
  Tooltip, Legend, ResponsiveContainer,
} from 'recharts'
```

**Color scheme**:
- Total: `#3b82f6` (blue-500)
- Organic: `#22c55e` (green-500)
- Ad-Attributed: `#f97316` (orange-500)

**Completion Criteria**:
- [ ] Component renders LineChart with 3 lines
- [ ] Empty state displays when data is empty
- [ ] Tooltip shows formatted currency values
- [ ] Responsive on mobile
- [ ] `npx tsc --noEmit` passes

### Subtask 3.2: Create AcosRoasChart Component
**File**: `/src/components/analytics/AcosRoasChart.tsx` (NEW)
**Pattern**: Follow DefectTrendChart but with dual Y-axes
**Instructions**:
1. Create component with props:
   ```typescript
   interface AcosRoasChartProps {
     data: AcosRoasDataPoint[]
     isLoading?: boolean
   }
   ```
2. Use Recharts `LineChart` with **dual Y-axes**:
   - Left Y-axis: ACOS (percentage, 0-100%)
   - Right Y-axis: ROAS (ratio, typically 0-10x)
3. Two lines: ACOS (red), ROAS (green)
4. Custom tooltip explaining both metrics
5. Include legend explaining "ACOS = Ad Cost / Sales" and "ROAS = Sales / Ad Cost"

**Dual Y-axis implementation**:
```typescript
<YAxis yAxisId="left" orientation="left" tickFormatter={(v) => `${v}%`} />
<YAxis yAxisId="right" orientation="right" tickFormatter={(v) => `${v}x`} />
<Line yAxisId="left" dataKey="acos" ... />
<Line yAxisId="right" dataKey="roas" ... />
```

**Color scheme**:
- ACOS: `#ef4444` (red-500)
- ROAS: `#22c55e` (green-500)

**Completion Criteria**:
- [ ] Dual Y-axis renders correctly
- [ ] ACOS shows as percentage, ROAS as ratio
- [ ] Tooltip explains both metrics
- [ ] `npx tsc --noEmit` passes

### Subtask 3.3: Create OrganicVsAdChart Component
**File**: `/src/components/analytics/OrganicVsAdChart.tsx` (NEW)
**Pattern**: New pattern - use Recharts PieChart
**Instructions**:
1. Create component with props:
   ```typescript
   interface OrganicVsAdChartProps {
     data: OrganicAdBreakdown
     isLoading?: boolean
   }
   ```
2. Use Recharts `PieChart` with `Pie` component
3. Two slices: Organic (green) and Ad-Attributed (orange)
4. Show percentages on chart labels
5. Center text showing total sales (optional - use custom label)
6. Include legend

**Recharts PieChart imports**:
```typescript
import {
  PieChart, Pie, Cell, Tooltip, Legend, ResponsiveContainer
} from 'recharts'
```

**Implementation notes**:
```typescript
const COLORS = ['#22c55e', '#f97316']
const pieData = [
  { name: 'Organic', value: data.organic },
  { name: 'Ad-Attributed', value: data.adAttributed },
]

<Pie
  data={pieData}
  dataKey="value"
  nameKey="name"
  label={({ percent }) => `${(percent * 100).toFixed(1)}%`}
  labelLine={false}
>
  {pieData.map((entry, index) => (
    <Cell key={entry.name} fill={COLORS[index % COLORS.length]} />
  ))}
</Pie>
```

**Completion Criteria**:
- [ ] Pie chart renders with 2 slices
- [ ] Percentages display on slices
- [ ] Legend shows Organic vs Ad-Attributed
- [ ] Tooltip shows dollar values
- [ ] `npx tsc --noEmit` passes

### Subtask 3.4: Create KeywordPerformanceChart Component
**File**: `/src/components/analytics/KeywordPerformanceChart.tsx` (NEW)
**Pattern**: Follow `/src/components/features/DefectBOMComparisonChart.tsx`
**Instructions**:
1. Create component with props:
   ```typescript
   interface KeywordPerformanceChartProps {
     data: KeywordPerformanceData[]
     isLoading?: boolean
   }
   ```
2. Use Recharts `BarChart` (horizontal bars for readability)
3. Show top 10 keywords by spend
4. Two bar groups: Spend (red) and Sales (green)
5. Tooltip showing all metrics (spend, sales, ACOS, ROAS, impressions, clicks)
6. Truncate long keywords in axis labels

**Bar orientation** - use `layout="vertical"`:
```typescript
<BarChart layout="vertical" data={chartData}>
  <XAxis type="number" />
  <YAxis type="category" dataKey="keyword" width={150} />
  <Bar dataKey="spend" name="Spend" fill="#ef4444" />
  <Bar dataKey="sales" name="Sales" fill="#22c55e" />
</BarChart>
```

**Completion Criteria**:
- [ ] Horizontal bar chart renders
- [ ] Top 10 keywords displayed
- [ ] Spend and Sales bars visible
- [ ] Tooltip shows comprehensive metrics
- [ ] Long keywords truncated
- [ ] `npx tsc --noEmit` passes

---

## Phase 4: Date Range Selector

### Subtask 4.1: Create DateRangeSelector Component
**File**: `/src/components/analytics/DateRangeSelector.tsx` (NEW)
**Pattern**: Combine `/src/components/features/SparklineTimeFilter.tsx` with custom date inputs
**Instructions**:
1. Create component with props:
   ```typescript
   interface DateRangeSelectorProps {
     value: DateRangePreset
     customStartDate?: string
     customEndDate?: string
     onChange: (preset: DateRangePreset, startDate?: string, endDate?: string) => void
   }
   ```
2. Show buttons for 7d, 30d, 90d presets
3. Add "Custom" button that shows date inputs when selected
4. Use native HTML date inputs (following DefectAnalyticsFilters pattern)
5. Calculate actual dates based on preset:
   - 7d: today - 7 days
   - 30d: today - 30 days
   - 90d: today - 90 days
6. Style with TailwindCSS, follow SparklineTimeFilter button styling

**Completion Criteria**:
- [ ] Preset buttons work (7d, 30d, 90d)
- [ ] Custom option shows date inputs
- [ ] Date inputs functional
- [ ] Selected state visually indicated
- [ ] `npx tsc --noEmit` passes

---

## Phase 5: Dashboard Integration

### Subtask 5.1: Create Export Barrel for Analytics Components
**File**: `/src/components/analytics/index.ts` (NEW)
**Instructions**:
1. Create barrel export file:
```typescript
export { SalesTrendChart } from './SalesTrendChart'
export { AcosRoasChart } from './AcosRoasChart'
export { OrganicVsAdChart } from './OrganicVsAdChart'
export { KeywordPerformanceChart } from './KeywordPerformanceChart'
export { DateRangeSelector } from './DateRangeSelector'
```

**Completion Criteria**:
- [ ] All components exported
- [ ] `npx tsc --noEmit` passes

### Subtask 5.2: Replace Amazon Page with Full Dashboard
**File**: `/src/app/(dashboard)/amazon/page.tsx` (MODIFY - complete replacement)
**Pattern**: Follow `/src/components/features/DefectAnalyticsDashboard.tsx`
**Instructions**:
1. Convert to client component with `'use client'`
2. Add state management:
   - `dateRange` (preset + custom dates)
   - `brandId` (for brand filter if multiple brands)
   - `salesData` (fetched data)
   - `keywordData` (fetched data)
   - `isLoading` states
   - `error` states
3. Fetch from `/api/sales-daily?breakdown=attribution` on mount and filter change
4. Fetch from `/api/analytics/amazon` for keyword data
5. Transform API response to chart data formats
6. Layout structure:
   ```
   Header: "Amazon Analytics" + Date Range Selector
   Row 1: Summary Cards (Total Sales, Organic %, ACOS, ROAS)
   Row 2: Sales Trend Chart (full width)
   Row 3: ACOS/ROAS Chart (left) + Organic vs Ad Pie (right)
   Row 4: Top Keywords Bar Chart (full width)
   ```
7. Responsive grid: Use `lg:grid-cols-2` for row 3
8. Handle loading states with Skeleton or Loader2
9. Handle empty states with EmptyState component
10. Add brand selector dropdown (only show if multiple brands)

**Data transformation example**:
```typescript
// Transform attribution response to SalesTrendDataPoint[]
const salesTrendData: SalesTrendDataPoint[] = attributionData.daily.map(d => ({
  date: d.date,
  totalSales: d.totalSales,
  adAttributedSales: d.adAttributedSales,
  organicSales: d.organicSales,
}))
```

**Completion Criteria**:
- [ ] Page renders without errors
- [ ] Date range selector works
- [ ] All 4 charts display
- [ ] Loading states work
- [ ] Empty states work
- [ ] Responsive on mobile
- [ ] Brand filter works (if applicable)
- [ ] No TypeScript errors
- [ ] `npm run build` passes

---

## Phase 6: Final Validation

### Subtask 6.1: Build and Lint Check
**Instructions**:
1. Run `npx tsc --noEmit` - must pass
2. Run `npm run lint` - must pass
3. Run `npm run build` - must pass

**Completion Criteria**:
- [ ] TypeScript check passes
- [ ] Lint check passes
- [ ] Build completes successfully

### Subtask 6.2: Manual Testing Checklist
**Instructions**:
Test on test environment (http://172.16.20.50:2345):
1. Navigate to /amazon
2. Verify page loads (not "Coming Soon")
3. Test date range selector:
   - [ ] 7d preset works
   - [ ] 30d preset works
   - [ ] 90d preset works
   - [ ] Custom dates work
4. Verify charts:
   - [ ] Sales trend shows 3 lines
   - [ ] ACOS/ROAS has dual Y-axes
   - [ ] Pie chart shows percentages
   - [ ] Keywords bar chart shows top 10
5. Test responsive:
   - [ ] Charts readable on mobile
   - [ ] Grid collapses properly
6. Test edge cases:
   - [ ] Empty data shows empty state
   - [ ] Loading shows loading state

**Completion Criteria**:
- [ ] All manual tests pass

---

## Summary of Deliverables

**Files Created** (8 files):
| Type | File |
|------|------|
| Types | `/src/types/amazon-analytics.ts` |
| API | `/src/app/api/analytics/amazon/route.ts` |
| Component | `/src/components/analytics/SalesTrendChart.tsx` |
| Component | `/src/components/analytics/AcosRoasChart.tsx` |
| Component | `/src/components/analytics/OrganicVsAdChart.tsx` |
| Component | `/src/components/analytics/KeywordPerformanceChart.tsx` |
| Component | `/src/components/analytics/DateRangeSelector.tsx` |
| Component | `/src/components/analytics/index.ts` |

**Files Modified** (1 file):
| File | Change |
|------|--------|
| `/src/app/(dashboard)/amazon/page.tsx` | Complete replacement with dashboard |

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 0 -> Phase 6)
2. Create analytics directory first (Phase 0)
3. Create types before components (Phase 1 before Phase 3)
4. Create API route before page integration (Phase 2 before Phase 5)
5. Test each component compiles before moving to next
6. Run TypeScript check after each phase

**Key References**:
- Line chart pattern: `/src/components/features/DefectTrendChart.tsx`
- Bar chart pattern: `/src/components/features/DefectBOMComparisonChart.tsx`
- Dashboard pattern: `/src/components/features/DefectAnalyticsDashboard.tsx`
- Time filter pattern: `/src/components/features/SparklineTimeFilter.tsx`
- API pattern: `/src/app/api/sales-daily/route.ts`

**Color Constants**:
- Total Sales: `#3b82f6` (blue)
- Organic: `#22c55e` (green)
- Ad-Attributed: `#f97316` (orange)
- ACOS/Spend: `#ef4444` (red)
- ROAS: `#22c55e` (green)

---

## Test Strategy Note

- Use `npx tsc --noEmit` after each component
- Run `npm run build` after Phase 5
- Manual testing on test environment only (port 2345)

---

## Performance Metrics

| Phase | Estimated Duration |
|-------|-------------------|
| Investigation | 35m |
| Validation | 10m |
| Planning | 25m |
| **Total Scout-Plan** | **70m** |
| **Estimated Build** | **8-10 hours** |
