# Implementation Plan
**Generated**: 2025-12-03T19:50:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #67
**Estimated Build Time**: 1-2 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Enhancement
**Source**: GitHub Issue #67
**Priority**: Medium

### Task Classification
**Category**: REFACTORING
**Test Strategy**: FAST_PATH (smoke tests only - isolated pattern application)
**Suggested Filter**: None - manual verification sufficient

### Issue Validation
**Status**: Valid
**Recent Changes**:
- `0f24c8e` fix(issue #30): add safe JSON parsing to prevent dialog crashes on non-JSON API responses
- `ff1ed35` fix(issue #29): add response validation to prevent FeedbackDialog crashes

### Current State Assessment

**Files to Modify** (5 page components with unsafe `await res.json()` calls):

| File | Line(s) | Context |
|------|---------|---------|
| `src/app/(dashboard)/skus/[id]/bom/new/page.tsx` | 24 | SKU fetch in `fetchSKU()` |
| `src/app/(dashboard)/settings/page.tsx` | 18, 39 | Settings fetch and save |
| `src/app/(dashboard)/settings/users/page.tsx` | 42 | Users list fetch |
| `src/app/(dashboard)/settings/users/[id]/edit/page.tsx` | 25 | Single user fetch |
| `src/app/(dashboard)/transactions/[id]/page.tsx` | 28 | Transaction fetch |

### Verified Line Numbers

**File 1**: `src/app/(dashboard)/skus/[id]/bom/new/page.tsx`
- Line 24: `const data = await res.json()` (in `fetchSKU()`)
- Line 25: `setSkuName(data.data.name)` - needs optional chaining

**File 2**: `src/app/(dashboard)/settings/page.tsx`
- Line 18: `const data = await res.json()` (in `fetchSettings()`)
- Line 19: `setSettings(data.data)` - needs optional chaining
- Line 39: `const data = await res.json()` (in `handleSave()` error path)
- Line 40: `throw new Error(data.error || ...)` - needs optional chaining

**File 3**: `src/app/(dashboard)/settings/users/page.tsx`
- Line 42: `const data = await res.json()` (in `fetchUsers()`)
- Line 43: `setUsers(data.data)` - needs optional chaining

**File 4**: `src/app/(dashboard)/settings/users/[id]/edit/page.tsx`
- Line 25: `const data = await res.json()` (in `fetchUser()`)
- Line 26: `setUser(data.data)` - needs optional chaining

**File 5**: `src/app/(dashboard)/transactions/[id]/page.tsx`
- Line 28: `const data = await res.json()` (in `fetchTransaction()`)
- Line 29: `setTransaction(data.data)` - needs optional chaining

### Dependencies & Blockers
None - this is a standalone refactoring task.

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Simple
**Effort**: 1-2 hours
**Risk**: Low - pattern is well-established in codebase

### Patterns Identified

**Primary Reference**: `src/components/features/FeedbackDialog.tsx` (Lines 108, 151)
```typescript
// Pattern for error responses
const data = await res.json().catch(() => ({}))
throw new Error(data?.message || 'Default error message')
```

**Secondary Reference**: `src/components/features/BuildDialog.tsx` (Lines 90, 135)
```typescript
// Pattern for successful responses with error fallback
const data = await res.json().catch(() => ({}))
// Then use: data?.property
```

### Ripple Effect Analysis
**Files Identified**: 5 (only the files listed in the issue)
- No other files are affected - this is localized to each page component
- No shared types or services need modification
- No API routes are being changed

---

## Executive Summary
Apply safe JSON parsing pattern to 5 page components that currently use unsafe `await res.json()` calls. This prevents crashes when API responses are non-JSON (e.g., HTML error pages, empty responses). The pattern adds `.catch(() => ({}))` to JSON parsing and optional chaining when accessing properties.

## Phase 1: Apply Safe JSON Parsing to Page Components

### Subtask 1.1: Update BOM New Page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/bom/new/page.tsx`
**Pattern**: Follow `src/components/features/BuildDialog.tsx:135`

**Instructions**:
1. Locate line 24 in the `fetchSKU()` function
2. Change:
   ```typescript
   // BEFORE (line 24)
   const data = await res.json()
   setSkuName(data.data.name)
   ```
   To:
   ```typescript
   // AFTER
   const data = await res.json().catch(() => ({}))
   setSkuName(data?.data?.name || '')
   ```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Line 24 uses `.catch(() => ({}))`
- [ ] Line 25 uses optional chaining `data?.data?.name`
- [ ] TypeScript compiles without errors

---

### Subtask 1.2: Update Settings Page (fetchSettings)
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/page.tsx`
**Pattern**: Follow `src/components/features/BuildDialog.tsx:135`

**Instructions**:
1. Locate line 18 in the `fetchSettings()` function
2. Change:
   ```typescript
   // BEFORE (line 18-19)
   const data = await res.json()
   setSettings(data.data)
   ```
   To:
   ```typescript
   // AFTER
   const data = await res.json().catch(() => ({}))
   setSettings(data?.data)
   ```

**Note**: `setSettings` accepts `SettingsResponse | null`, so `data?.data` returning undefined when null coalesces to null is acceptable.

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Line 18 uses `.catch(() => ({}))`
- [ ] Line 19 uses optional chaining `data?.data`
- [ ] TypeScript compiles without errors

---

### Subtask 1.3: Update Settings Page (handleSave error path)
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/page.tsx`
**Pattern**: Follow `src/components/features/FeedbackDialog.tsx:108`

**Instructions**:
1. Locate line 39 in the `handleSave()` function (inside the `if (!res.ok)` block)
2. Change:
   ```typescript
   // BEFORE (lines 38-40)
   if (!res.ok) {
     const data = await res.json()
     throw new Error(data.error || 'Failed to save settings')
   }
   ```
   To:
   ```typescript
   // AFTER
   if (!res.ok) {
     const data = await res.json().catch(() => ({}))
     throw new Error(data?.error || 'Failed to save settings')
   }
   ```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Line 39 uses `.catch(() => ({}))`
- [ ] Line 40 uses optional chaining `data?.error`
- [ ] TypeScript compiles without errors

---

### Subtask 1.4: Update Users Page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/users/page.tsx`
**Pattern**: Follow `src/components/features/BuildDialog.tsx:135`

**Instructions**:
1. Locate line 42 in the `fetchUsers()` function
2. Change:
   ```typescript
   // BEFORE (line 42-43)
   const data = await res.json()
   setUsers(data.data)
   ```
   To:
   ```typescript
   // AFTER
   const data = await res.json().catch(() => ({}))
   setUsers(data?.data || [])
   ```

**Note**: `setUsers` expects `UserResponse[]`, so provide empty array fallback.

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Line 42 uses `.catch(() => ({}))`
- [ ] Line 43 uses optional chaining with fallback `data?.data || []`
- [ ] TypeScript compiles without errors

---

### Subtask 1.5: Update Edit User Page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/users/[id]/edit/page.tsx`
**Pattern**: Follow `src/components/features/BuildDialog.tsx:135`

**Instructions**:
1. Locate line 25 in the `fetchUser()` function
2. Change:
   ```typescript
   // BEFORE (line 25-26)
   const data = await res.json()
   setUser(data.data)
   ```
   To:
   ```typescript
   // AFTER
   const data = await res.json().catch(() => ({}))
   setUser(data?.data)
   ```

**Note**: `setUser` accepts `UserResponse | null`, so undefined coalescing to null is acceptable.

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Line 25 uses `.catch(() => ({}))`
- [ ] Line 26 uses optional chaining `data?.data`
- [ ] TypeScript compiles without errors

---

### Subtask 1.6: Update Transaction Detail Page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/transactions/[id]/page.tsx`
**Pattern**: Follow `src/components/features/BuildDialog.tsx:135`

**Instructions**:
1. Locate line 28 in the `fetchTransaction()` function
2. Change:
   ```typescript
   // BEFORE (line 28-29)
   const data = await res.json()
   setTransaction(data.data)
   ```
   To:
   ```typescript
   // AFTER
   const data = await res.json().catch(() => ({}))
   setTransaction(data?.data)
   ```

**Note**: `setTransaction` accepts `TransactionResponse | null`, so undefined coalescing to null is acceptable.

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Line 28 uses `.catch(() => ({}))`
- [ ] Line 29 uses optional chaining `data?.data`
- [ ] TypeScript compiles without errors

---

## Phase 2: Final Verification

### Subtask 2.1: Run Full Build Verification
**Instructions**:
1. Run TypeScript check:
   ```bash
   npx tsc --noEmit
   ```
2. Run build:
   ```bash
   npm run build
   ```
3. Run lint:
   ```bash
   npm run lint
   ```

**Completion Criteria**:
- [ ] TypeScript compiles without errors
- [ ] Build completes successfully
- [ ] Lint passes without warnings

---

## Summary of Deliverables

**Files Modified**: 5
1. `/home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/bom/new/page.tsx`
2. `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/page.tsx`
3. `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/users/page.tsx`
4. `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/users/[id]/edit/page.tsx`
5. `/home/pbrown/SkuInventory/src/app/(dashboard)/transactions/[id]/page.tsx`

**Files Created**: 0

**Total Changes**: 7 `res.json()` calls updated across 5 files

## Handoff to Build Agent

1. Execute subtasks 1.1 through 1.6 in order
2. Each subtask modifies a single file - complete and verify before moving to next
3. Run `npx tsc --noEmit` after each file modification
4. Complete Phase 2 verification after all files are updated
5. Follow reference patterns exactly - use `.catch(() => ({}))` and optional chaining

## Test Strategy Note

- **Category**: REFACTORING
- **Test Strategy**: FAST_PATH
- No new tests required - this is defensive coding pattern application
- Manual verification: Navigate to each page in browser and verify no crashes
- The existing error handling in each component will display appropriate error messages

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 3m |
| Validation | 2m |
| Planning | 5m |
| **Total** | **10m** |
