# Implementation Plan
**Generated**: 2025-12-16T20:15:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #285
**Estimated Build Time**: 1-2 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Bug Fix
**Source**: GitHub Issue #285
**Priority**: High - Core feature (ads data ingestion) is broken

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED
**Suggested Filter**: None (manual testing via CSV upload)

### Issue Validation
**Status**: Valid - confirmed via database inspection
**Recent Changes**: Migration `20251212150826_add_ads_data_ingestion_models` was marked as applied but failed to execute SQL

### Root Cause Analysis

**Problem**: The migration `20251212150826_add_ads_data_ingestion_models` was rolled back due to an enum conflict error (`ERROR: enum label "clarification_requested" already exists`) on the first statement, and was then marked as applied (`applied_steps_count = 0`) without the SQL actually executing.

**Evidence from `_prisma_migrations` table**:
```
| finished_at | migration_name | applied_steps_count |
|-------------|----------------|---------------------|
| 2025-12-16  | 20251212150826 | 0                   |
```

The `applied_steps_count = 0` indicates the migration was marked as complete but no SQL statements were executed.

**Missing columns in `SyncLog` table**:
1. `companyId` - TEXT, nullable (schema line 897)
2. `integrationType` - VARCHAR(50), NOT NULL (schema line 900)
3. `initiatedBy` - TEXT, nullable (schema line 906)
4. `metadata` - JSONB, NOT NULL DEFAULT '{}' (schema line 922)

**Missing indexes**:
1. `SyncLog_companyId_startedAt_idx` - ON ("companyId", "startedAt" DESC)
2. `SyncLog_integrationType_status_idx` - ON ("integrationType", status)

**Missing foreign key**:
1. `SyncLog_companyId_fkey` - FOREIGN KEY ("companyId") REFERENCES "Company"("id")

### Current State Assessment
- **Prisma Schema**: Correct - has all required columns for SyncLog (lines 893-932)
- **Database (Test)**: Missing 4 columns, 2 indexes, 1 FK - port 2346
- **Database (Prod)**: Missing 4 columns, 2 indexes, 1 FK - port 4546
- **TypeScript**: Compiles successfully (types generated from schema)
- **Migration**: Exists but was not applied correctly

### Files Affected by This Bug

| File | Uses Missing Column | Line |
|------|---------------------|------|
| `src/app/api/csv/upload/route.ts` | `companyId`, `integrationType`, `initiatedBy`, `metadata` | 137-154 |
| `src/services/shopify/sync.ts` | `integrationType`, `metadata` | 47-56 |
| `src/services/amazon-ads/sync.ts` | `integrationType` | 45-52 |

### Dependencies & Blockers
1. **Blocker**: The original migration has a bad first statement (enum alteration that conflicts with existing data)
2. **Solution**: Create a new migration that only adds the missing columns

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Low
**Effort**: 1-2 hours
**Risk**: Low - straightforward schema addition, no data migration needed

### Patterns Identified
**Primary**: `/home/pbrown/SkuInventory/prisma/migrations/20251203234127_add_location_to_transaction/migration.sql` - simple ALTER TABLE pattern
**Secondary**: `/home/pbrown/SkuInventory/prisma/migrations/20251209042100_remove_user_companyid_column/migration.sql` - ALTER TABLE with IF EXISTS safety

---

## Executive Summary

CSV upload fails because the `SyncLog` table is missing 4 columns (`companyId`, `integrationType`, `initiatedBy`, `metadata`) that were supposed to be created by migration `20251212150826_add_ads_data_ingestion_models`. The migration failed on the first SQL statement (enum conflict) and was marked as applied without executing. The fix is to create a new migration that adds only the missing columns, indexes, and foreign key to the `SyncLog` table.

---

## Phase 1: Database Migration Fix

### Subtask 1.1: Create New Migration File

**File**: `/home/pbrown/SkuInventory/prisma/migrations/[timestamp]_fix_synclog_missing_columns/migration.sql`

**Pattern**: Follow `/home/pbrown/SkuInventory/prisma/migrations/20251203234127_add_location_to_transaction/migration.sql`

**Instructions**:
1. Create a new migration folder with timestamp format: `YYYYMMDDHHMMSS_fix_synclog_missing_columns`
2. Create `migration.sql` with the following SQL:

```sql
-- Fix SyncLog table: Add missing columns from failed migration
-- Migration 20251212150826_add_ads_data_ingestion_models was marked applied but SQL did not execute

-- Add missing columns
ALTER TABLE "SyncLog" ADD COLUMN IF NOT EXISTS "companyId" TEXT;
ALTER TABLE "SyncLog" ADD COLUMN IF NOT EXISTS "integrationType" VARCHAR(50);
ALTER TABLE "SyncLog" ADD COLUMN IF NOT EXISTS "initiatedBy" TEXT;
ALTER TABLE "SyncLog" ADD COLUMN IF NOT EXISTS "metadata" JSONB NOT NULL DEFAULT '{}';

-- Set default for integrationType for existing rows (if any)
UPDATE "SyncLog" SET "integrationType" = 'unknown' WHERE "integrationType" IS NULL;

-- Now make integrationType NOT NULL after populating existing rows
ALTER TABLE "SyncLog" ALTER COLUMN "integrationType" SET NOT NULL;

-- Add missing indexes
CREATE INDEX IF NOT EXISTS "SyncLog_companyId_startedAt_idx" ON "SyncLog"("companyId", "startedAt" DESC);
CREATE INDEX IF NOT EXISTS "SyncLog_integrationType_status_idx" ON "SyncLog"("integrationType", status);

-- Add foreign key constraint
ALTER TABLE "SyncLog" ADD CONSTRAINT "SyncLog_companyId_fkey" FOREIGN KEY ("companyId") REFERENCES "Company"("id") ON DELETE SET NULL ON UPDATE CASCADE;
```

**Completion Criteria**:
- [ ] Migration folder created with timestamp
- [ ] `migration.sql` file contains all required ALTER statements
- [ ] SQL syntax is valid PostgreSQL

### Subtask 1.2: Apply Migration to Test Database

**Instructions**:
1. Verify test database connection:
```bash
docker exec inventory-db-test psql -U inventory_test -d inventory_test -c "SELECT current_database();"
```

2. Apply migration to test database:
```bash
DATABASE_URL="postgresql://inventory_test:inventory_test_2025@localhost:2346/inventory_test" npx prisma migrate deploy
```

3. Verify columns exist:
```bash
docker exec inventory-db-test psql -U inventory_test -d inventory_test -c "SELECT column_name FROM information_schema.columns WHERE table_name = 'SyncLog' ORDER BY ordinal_position;"
```

**Expected columns after migration**:
- id
- credentialId
- companyId (NEW)
- integrationType (NEW)
- syncType
- status
- startedAt
- completedAt
- initiatedBy (NEW)
- recordsProcessed
- recordsCreated
- recordsUpdated
- recordsDeleted
- recordsFailed
- errorMessage
- errorDetails
- fileName
- fileSize
- metadata (NEW)
- triggeredById

**Completion Criteria**:
- [ ] Migration applies without errors
- [ ] All 4 new columns exist in test database
- [ ] Indexes created successfully
- [ ] Foreign key constraint added

### Subtask 1.3: Regenerate Prisma Client

**Instructions**:
```bash
npx prisma generate
```

**Completion Criteria**:
- [ ] Prisma client regenerated without errors

---

## Phase 2: Verification

### Subtask 2.1: TypeScript Verification

**Instructions**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] No TypeScript errors

### Subtask 2.2: Build Verification

**Instructions**:
```bash
npm run build
```

**Completion Criteria**:
- [ ] Build completes without errors

### Subtask 2.3: Functional Testing via Test Environment

**Instructions**:
1. Access test environment: http://172.16.20.50:2345
2. Navigate to Integrations page
3. Attempt CSV upload with Amazon Search Term Report
4. Verify upload completes without "companyId does not exist" error

**Completion Criteria**:
- [ ] CSV upload page loads
- [ ] File upload processes without database error
- [ ] Sync log entry created successfully

---

## Summary of Deliverables

**Files Created**: 1
- `prisma/migrations/[timestamp]_fix_synclog_missing_columns/migration.sql`

**Files Modified**: 0 (no code changes needed, only migration)

**Database Changes**:
- 4 columns added to SyncLog table
- 2 indexes added
- 1 foreign key constraint added

---

## Handoff to Build Agent

1. Execute subtasks in exact order (1.1 -> 1.2 -> 1.3 -> 2.1 -> 2.2 -> 2.3)
2. Use `IF NOT EXISTS` / `IF EXISTS` clauses for idempotency
3. Target TEST environment only (port 2346)
4. Verify each step before proceeding

---

## Test Strategy Note

- **Test Type**: TARGETED
- **Method**: Manual verification via test environment UI
- **Endpoint**: http://172.16.20.50:2345/integrations
- **Action**: Upload CSV file and verify no database errors

---

## Technical Details

### Schema vs Database Comparison

| Column | Schema (Expected) | Test DB (Actual) | Status |
|--------|-------------------|------------------|--------|
| id | String @id @default(uuid()) | text NOT NULL | OK |
| credentialId | String? | text | OK |
| companyId | String? | **MISSING** | FIX |
| integrationType | String @db.VarChar(50) | **MISSING** | FIX |
| syncType | String @db.VarChar(50) | varchar(50) NOT NULL | OK |
| status | String @db.VarChar(20) | varchar(20) NOT NULL | OK |
| startedAt | DateTime @default(now()) | timestamp NOT NULL | OK |
| completedAt | DateTime? | timestamp | OK |
| initiatedBy | String? | **MISSING** | FIX |
| recordsProcessed | Int @default(0) | integer NOT NULL | OK |
| recordsCreated | Int @default(0) | integer NOT NULL | OK |
| recordsUpdated | Int @default(0) | integer NOT NULL | OK |
| recordsDeleted | Int @default(0) | integer NOT NULL | OK |
| recordsFailed | Int @default(0) | integer NOT NULL | OK |
| errorMessage | String? @db.Text | text | OK |
| errorDetails | Json @default("{}") | jsonb NOT NULL | OK |
| fileName | String? @db.VarChar(255) | varchar(255) | OK |
| fileSize | Int? | integer | OK |
| metadata | Json @default("{}") | **MISSING** | FIX |
| triggeredById | String? | text | OK |

### Index Comparison

| Index | Schema (Expected) | Test DB (Actual) | Status |
|-------|-------------------|------------------|--------|
| SyncLog_pkey | Primary key on id | EXISTS | OK |
| SyncLog_credentialId_startedAt_idx | (credentialId, startedAt DESC) | EXISTS | OK |
| SyncLog_companyId_startedAt_idx | (companyId, startedAt DESC) | **MISSING** | FIX |
| SyncLog_integrationType_status_idx | (integrationType, status) | **MISSING** | FIX |
| SyncLog_syncType_status_idx | (syncType, status) | EXISTS | OK |
| SyncLog_startedAt_idx | (startedAt DESC) | EXISTS | OK |

---

## Performance Metrics

| Phase | Duration |
|-------|----------|
| Investigation | 10m |
| Validation | 5m |
| Planning | 5m |
| **Total** | **20m** |
