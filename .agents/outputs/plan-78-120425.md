# Implementation Plan
**Generated**: 2025-12-04T04:50:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #78 - [Parent #12] Lot tracking schema and migrations
**Estimated Build Time**: 2-3 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Feature (Database Schema)
**Source**: GitHub Issue #78
**Priority**: High (Foundational for lot tracking feature set)

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: FAST_PATH (schema-only change, verify with build and tsc)
**Suggested Filter**: None (no test files to filter)

### Issue Validation
**Status**: Valid
**Recent Changes**: No lot-related changes in recent commits. Parent issue #12 is closed but sub-issues (#78) are being worked as separate issues.

### Current State Assessment
- **Existing models**:
  - `Component` model exists at lines 154-184 in `prisma/schema.prisma` - will receive new `lots` relation
  - `TransactionLine` model exists at lines 244-254 - will receive optional `lotId` foreign key
  - No `Lot` or `LotBalance` models exist currently
- **Database**: PostgreSQL via Prisma ORM, migrations in `prisma/migrations/`
- **Last migration**: `20251204043359_add_shopify_integration_tables`
- **Build/TypeScript**: Both passing without errors

### Dependencies & Blockers
1. None - This is foundational schema work with no external dependencies
2. The issue notes location-awareness may need to be added later (Issue #9), but LotBalance can be designed without locationId for now

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Simple (schema-only, follows existing patterns)
**Effort**: 2-3 hours
**Risk**: Low (optional foreign key on existing table, no data migration needed)

### Patterns Identified
**Primary**: `prisma/schema.prisma` lines 154-184 (Component model structure)
- Uses uuid IDs
- Uses Decimal(10, 4) for quantities
- Uses DateTime for dates, @db.Date for date-only fields
- Uses @db.VarChar(N) for strings
- Uses @@index for query performance
- Uses @@unique for constraints

**Secondary**: `prisma/schema.prisma` lines 244-254 (TransactionLine model)
- References componentId as foreign key
- Uses onDelete: Cascade pattern (will need to consider for Lot -> TransactionLine)

### Ripple Effect Analysis
**Files Identified**: 3 files need modification

| File | Type | Change Required |
|------|------|-----------------|
| `prisma/schema.prisma` | Modified | Add Lot, LotBalance models; add lotId to TransactionLine; add lots relation to Component |
| `src/types/transaction.ts` | Optional (NOT in scope) | Would add lotId to TransactionLineResponse - NOT needed for this issue |
| `src/components/features/TransactionDetail.tsx` | Optional (NOT in scope) | Would display lot info - NOT needed for this issue |

**Note**: This issue is schema-only. TypeScript types and UI changes will be handled in subsequent sub-issues of #12.

---

## Executive Summary

This plan adds the foundational Prisma schema for lot/expiry tracking. We will create two new models (`Lot` and `LotBalance`) and add an optional `lotId` reference to `TransactionLine`. The Component model will receive a `lots` relation. All changes follow existing schema patterns with proper indexes and constraints.

## Phase 1: Database Schema Changes

### Subtask 1.1: Add Lot Model to Prisma Schema

**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`

**Location**: Add after line 184 (end of Component model), before line 186 (TransactionType enum)

**Pattern**: Follow Component model structure (uuid ID, Decimal for quantities, DateTime fields)

**Instructions**:
1. Add the following Lot model after the Component model:

```prisma
model Lot {
  id               String    @id @default(uuid())
  componentId      String
  component        Component @relation(fields: [componentId], references: [id])
  lotNumber        String    @db.VarChar(100)
  expiryDate       DateTime? @db.Date
  receivedQuantity Decimal   @db.Decimal(10, 4)
  supplier         String?   @db.VarChar(100)
  notes            String?   @db.Text
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  balance          LotBalance?
  transactionLines TransactionLine[]

  @@unique([componentId, lotNumber])
  @@index([componentId])
  @@index([expiryDate])
}
```

**Validation Commands**:
```bash
npx prisma format
npx prisma validate
```

**Completion Criteria**:
- [ ] Lot model added with all fields matching issue specification
- [ ] Correct field types (uuid, Decimal(10,4), VarChar, Date, Text)
- [ ] Unique constraint on (componentId, lotNumber)
- [ ] Indexes on componentId and expiryDate
- [ ] prisma validate passes

---

### Subtask 1.2: Add LotBalance Model to Prisma Schema

**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`

**Location**: Add immediately after Lot model

**Pattern**: Follow existing model patterns with Decimal for quantities

**Instructions**:
1. Add the following LotBalance model immediately after the Lot model:

```prisma
model LotBalance {
  id               String  @id @default(uuid())
  lotId            String  @unique
  lot              Lot     @relation(fields: [lotId], references: [id])
  quantity         Decimal @db.Decimal(10, 4)
  reservedQuantity Decimal @default(0) @db.Decimal(10, 4)

  @@index([lotId])
}
```

**Validation Commands**:
```bash
npx prisma validate
```

**Completion Criteria**:
- [ ] LotBalance model added with all fields
- [ ] Unique constraint on lotId (one balance per lot)
- [ ] Decimal(10,4) for quantity fields
- [ ] Index on lotId
- [ ] prisma validate passes

---

### Subtask 1.3: Add lots Relation to Component Model

**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`

**Location**: Line 178 (inside Component model, after `alertState` relation)

**Pattern**: Follow existing relation patterns in Component model

**Instructions**:
1. Add the lots relation to the Component model. Locate line 178 (`alertState ComponentAlertState?`) and add after it:

```prisma
  lots             Lot[]
```

This should be inserted between line 178 and line 180 (the blank line before @@unique).

**Validation Commands**:
```bash
npx prisma validate
```

**Completion Criteria**:
- [ ] Component model has `lots Lot[]` relation
- [ ] prisma validate passes

---

### Subtask 1.4: Add lotId Foreign Key to TransactionLine Model

**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`

**Location**: Lines 244-254 (TransactionLine model)

**Pattern**: Follow existing optional foreign key patterns (e.g., transaction.skuId)

**Instructions**:
1. Locate the TransactionLine model (lines 244-254)
2. Add the optional lotId field and relation after `costPerUnit` (line 251):

```prisma
  lotId          String?
  lot            Lot?        @relation(fields: [lotId], references: [id])
```

3. Add an index for lotId after the componentId index (line 253):

```prisma
  @@index([lotId])
```

The complete TransactionLine model should look like:

```prisma
model TransactionLine {
  id             String      @id @default(uuid())
  transactionId  String
  transaction    Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  componentId    String
  component      Component   @relation(fields: [componentId], references: [id])
  quantityChange Decimal     @db.Decimal(10, 4)
  costPerUnit    Decimal?    @db.Decimal(10, 4)
  lotId          String?
  lot            Lot?        @relation(fields: [lotId], references: [id])

  @@index([componentId])
  @@index([lotId])
}
```

**Validation Commands**:
```bash
npx prisma validate
```

**Completion Criteria**:
- [ ] TransactionLine has optional lotId field (String?)
- [ ] TransactionLine has optional lot relation (Lot?)
- [ ] Index on lotId added
- [ ] prisma validate passes

---

## Phase 2: Run Migration

### Subtask 2.1: Generate and Apply Migration

**File**: Auto-generated in `/home/pbrown/SkuInventory/prisma/migrations/`

**Instructions**:
1. Format the schema file:
```bash
npx prisma format
```

2. Generate and apply the migration:
```bash
npx prisma migrate dev --name add_lot_tracking_schema
```

3. Generate the Prisma client:
```bash
npx prisma generate
```

**Validation Commands**:
```bash
ls -la prisma/migrations/ | tail -5
```

**Completion Criteria**:
- [ ] Migration file created successfully
- [ ] Migration applied without errors
- [ ] No data loss (lotId on TransactionLine is optional)
- [ ] Prisma client regenerated

---

## Phase 3: Verification

### Subtask 3.1: Verify TypeScript Compilation

**Instructions**:
1. Run TypeScript check:
```bash
npx tsc --noEmit
```

2. Run build:
```bash
npm run build
```

**Completion Criteria**:
- [ ] `npx tsc --noEmit` passes without errors
- [ ] `npm run build` completes successfully

---

### Subtask 3.2: Verify Schema Correctness

**Instructions**:
1. Verify Lot model exists with correct fields:
```bash
grep -A 20 "model Lot {" prisma/schema.prisma
```

2. Verify LotBalance model exists:
```bash
grep -A 10 "model LotBalance {" prisma/schema.prisma
```

3. Verify TransactionLine has lotId:
```bash
grep -A 15 "model TransactionLine {" prisma/schema.prisma
```

4. Verify Component has lots relation:
```bash
grep "lots" prisma/schema.prisma
```

5. Verify indexes exist:
```bash
grep "@@index.*lotId" prisma/schema.prisma
grep "@@index.*componentId" prisma/schema.prisma
grep "@@index.*expiryDate" prisma/schema.prisma
```

6. Verify unique constraint:
```bash
grep "@@unique.*componentId.*lotNumber" prisma/schema.prisma
```

**Completion Criteria**:
- [ ] Lot model has: id, componentId, component, lotNumber, expiryDate, receivedQuantity, supplier, notes, createdAt, updatedAt, balance, transactionLines
- [ ] LotBalance model has: id, lotId, lot, quantity, reservedQuantity
- [ ] TransactionLine has: lotId, lot (both optional)
- [ ] Component has: lots relation
- [ ] Indexes exist on: Lot.componentId, Lot.expiryDate, LotBalance.lotId, TransactionLine.lotId
- [ ] Unique constraint exists on (componentId, lotNumber)

---

## Summary of Deliverables

**Files Created**:
- 1 migration file in `prisma/migrations/[timestamp]_add_lot_tracking_schema/migration.sql`

**Files Modified**:
- `prisma/schema.prisma` (add 2 new models, modify 2 existing models)

## Handoff to Build Agent

1. Execute subtasks in exact order (1.1 -> 1.2 -> 1.3 -> 1.4 -> 2.1 -> 3.1 -> 3.2)
2. Run `npx prisma validate` after each schema change
3. Run migration only after all schema changes are complete
4. Verify build and tsc pass before marking complete

## Acceptance Criteria Checklist (from Issue)
- [ ] Lot model exists with all required fields
- [ ] LotBalance model exists for tracking per-lot on-hand quantities
- [ ] TransactionLine has optional lotId field
- [ ] Migration runs successfully without data loss
- [ ] Indexes exist on componentId, expiryDate, lotNumber for Lot table
- [ ] Unique constraint enforces one lotNumber per component
- [ ] `npx prisma generate` and `npx tsc --noEmit` pass without errors
- [ ] `npm run build` completes successfully

## Test Strategy Note
- No unit tests required for this schema-only change
- Verification is done via Prisma validation, TypeScript compilation, and build

## Risk Mitigation
- TransactionLine.lotId is optional (String?), so existing data is unaffected
- LotBalance is a new table with no existing data dependencies
- Lot is a new table with no existing data dependencies
- All changes are additive, no destructive operations

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 8m |
| Validation | 2m |
| Planning | 5m |
| **Total** | **15m** |
