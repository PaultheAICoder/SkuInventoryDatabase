# Implementation Plan
**Generated**: 2025-12-04T15:30:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #117
**Estimated Build Time**: 6-8 hours
**Complexity**: Moderate

## Investigation Summary

### Request Analysis
**Type**: Feature (UI Dashboard)
**Source**: GitHub Issue #117
**Priority**: High (Phase 1 of forecasting feature)
**Parent Issue**: #13 - Consumption-based forecasting & reorder recommendations

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: None (manual testing recommended for UI)

### Issue Validation
**Status**: Valid
**Dependencies Met**: Issue #116 (API endpoints) is CLOSED - API is ready
**Recent Changes**: Forecast API endpoints implemented in recent commits

### Current State Assessment

#### Existing Components (Ready to Use)
- **API Endpoints** (Issue #116 - Complete):
  - `GET /api/forecasts` - List forecasts with pagination, sorting, filtering
  - `GET /api/forecasts/[componentId]` - Single component forecast
  - `GET /api/forecasts/config` - Configuration endpoint
- **Types**: `src/types/forecast.ts` - Full type definitions exist
- **Service Layer**: `src/services/forecast.ts` - Forecast calculations ready

#### Files to Create
1. `src/app/(dashboard)/forecasts/page.tsx` - Main forecast dashboard page
2. `src/components/features/ForecastTable.tsx` - Reusable forecast data table
3. `src/components/features/ForecastStatusBadge.tsx` - Visual urgency indicator

#### Files to Modify
1. `src/app/(dashboard)/layout.tsx` - Add navigation link (line 32-45)

### Dependencies & Blockers
1. **API Ready**: Issue #116 is CLOSED - endpoints available
2. **Types Ready**: `ComponentForecastResponse` type exists in `src/types/forecast.ts`
3. **UI Components Ready**: shadcn/ui components available (Table, Card, Badge, Button, Checkbox)
4. **Navigation Ready**: Navigation array defined in layout.tsx

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Moderate
**Effort**: 6-8 hours
**Risk**: Low - follows established patterns exactly

### Patterns Identified

**Primary Pattern (Page)**: `src/app/(dashboard)/components/page.tsx`
- Server component with session check
- Data fetching at page level
- Suspense wrapper for table component
- Header with title, description, and actions

**Secondary Pattern (Dashboard)**: `src/app/(dashboard)/page.tsx`
- Client component with useEffect data fetching
- Stats cards using DashboardStats pattern
- Loading and error states

**Table Pattern**: `src/components/features/ComponentTable.tsx` and `src/components/features/LotTable.tsx`
- Client component with 'use client' directive
- useState for local filter state
- useRouter/useSearchParams for URL-based pagination
- updateFilters helper for query param management
- handleSort for column sorting
- Badge component for status display
- Pagination controls

**Stats Cards Pattern**: `src/components/features/DashboardStats.tsx`
- Grid layout with Card components
- Icon + title header
- Large number display + subtitle

**Badge Variants**: `src/components/ui/badge.tsx`
- critical (red), warning (yellow), success (green), secondary (gray)

### Ripple Effect Analysis
**Files Identified**: 1 modification only

| File | Change Type | Impact |
|------|-------------|--------|
| `src/app/(dashboard)/layout.tsx` | Modify | Add nav item to navigation array (line 32-45) |

**TOTAL FILES TO CREATE**: 3
**TOTAL FILES TO MODIFY**: 1

---

## Executive Summary

Build a forecast dashboard page at `/forecasts` that displays component runout predictions and reorder recommendations. The page will include summary stats cards (components needing reorder, low runway items, total at-risk value) and a sortable/filterable data table showing all forecast data. Follow existing ComponentTable and Dashboard patterns exactly.

---

## Phase 1: Navigation Integration

### Subtask 1.1: Add Forecasts Link to Navigation
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/layout.tsx`
**Pattern**: Existing navigation items (lines 32-45)
**Instructions**:

1. Import the `TrendingDown` icon from lucide-react (add to existing import)
2. Add new navigation item after 'Analytics' entry:
```typescript
{ name: 'Forecasts', href: '/forecasts', icon: TrendingDown },
```

**Completion Criteria**:
- [ ] TrendingDown imported from lucide-react
- [ ] Forecasts nav item appears in sidebar
- [ ] Link navigates to /forecasts
- [ ] `npx tsc --noEmit` passes

---

## Phase 2: Status Badge Component

### Subtask 2.1: Create ForecastStatusBadge Component
**File**: `/home/pbrown/SkuInventory/src/components/features/ForecastStatusBadge.tsx`
**Pattern**: Badge usage in `src/components/features/ComponentTable.tsx` (lines 90-101, 232-235)
**Instructions**:

1. Create new file with 'use client' directive
2. Define ForecastStatus type: 'critical' | 'warning' | 'ok' | 'na'
3. Create helper function to determine status from forecast data:
   - Critical (red): `recommendedReorderDate` is not null AND is today or in the past
   - Warning (amber): `recommendedReorderDate` is not null AND is within 7 days
   - OK (green): `recommendedReorderDate` is null OR is more than 7 days away
   - N/A (gray): `averageDailyConsumption` is "0.0000" (zero consumption)
4. Use Badge component with variants: critical, warning, success, secondary
5. Display labels: CRITICAL, WARNING, OK, N/A

```typescript
'use client'

import { Badge } from '@/components/ui/badge'

export type ForecastStatus = 'critical' | 'warning' | 'ok' | 'na'

interface ForecastStatusBadgeProps {
  averageDailyConsumption: string
  recommendedReorderDate: string | null
}

export function getForecastStatus(
  averageDailyConsumption: string,
  recommendedReorderDate: string | null
): ForecastStatus {
  // Zero consumption = N/A
  if (parseFloat(averageDailyConsumption) === 0) {
    return 'na'
  }

  // No reorder needed = OK
  if (!recommendedReorderDate) {
    return 'ok'
  }

  const reorderDate = new Date(recommendedReorderDate)
  const today = new Date()
  today.setHours(0, 0, 0, 0)
  const daysUntilReorder = Math.ceil((reorderDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24))

  if (daysUntilReorder <= 0) {
    return 'critical'
  }
  if (daysUntilReorder <= 7) {
    return 'warning'
  }
  return 'ok'
}

const statusConfig = {
  critical: { variant: 'critical' as const, label: 'CRITICAL' },
  warning: { variant: 'warning' as const, label: 'WARNING' },
  ok: { variant: 'success' as const, label: 'OK' },
  na: { variant: 'secondary' as const, label: 'N/A' },
}

export function ForecastStatusBadge({ averageDailyConsumption, recommendedReorderDate }: ForecastStatusBadgeProps) {
  const status = getForecastStatus(averageDailyConsumption, recommendedReorderDate)
  const config = statusConfig[status]

  return <Badge variant={config.variant}>{config.label}</Badge>
}
```

**Completion Criteria**:
- [ ] Component renders without errors
- [ ] All 4 status types display correctly
- [ ] Badge colors match specification (red/yellow/green/gray)
- [ ] `npx tsc --noEmit` passes

---

## Phase 3: Forecast Table Component

### Subtask 3.1: Create ForecastTable Component
**File**: `/home/pbrown/SkuInventory/src/components/features/ForecastTable.tsx`
**Pattern**: `src/components/features/ComponentTable.tsx` (entire file - 275 lines)
**Instructions**:

1. Create client component with standard table imports
2. Define props interface:
```typescript
interface ForecastTableProps {
  forecasts: ComponentForecastResponse[]
  total: number
  page: number
  pageSize: number
}
```

3. Implement columns (all except Status are sortable):
   - Component Name (link to /components/[id]) - sortBy: 'name'
   - SKU Code (mono font)
   - On-Hand Qty (right-aligned, mono font)
   - Daily Consumption (right-aligned, mono font, 2 decimal places)
   - Days Until Runout (right-aligned, show '-' for null)
   - Runout Date (formatted date, show '-' for null)
   - Reorder Qty (right-aligned)
   - Reorder By Date (formatted date, show '-' for null)
   - Status (ForecastStatusBadge)

4. Implement filter controls:
   - Checkbox: "Show only at-risk" toggle (uses showOnlyAtRisk query param)

5. Implement sorting following ComponentTable pattern:
   - handleSort function updates sortBy and sortOrder params
   - ArrowUpDown icons on sortable column headers

6. Implement pagination following ComponentTable pattern:
   - Show "Showing X to Y of Z forecasts"
   - Previous/Next buttons

7. Date formatting:
   - Use `new Date(dateString).toLocaleDateString()` with suppressHydrationWarning

```typescript
'use client'

import { useState } from 'react'
import Link from 'next/link'
import { useRouter, useSearchParams } from 'next/navigation'
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import { Button } from '@/components/ui/button'
import { Checkbox } from '@/components/ui/checkbox'
import { Label } from '@/components/ui/label'
import { ArrowUpDown, ChevronLeft, ChevronRight } from 'lucide-react'
import { ForecastStatusBadge } from './ForecastStatusBadge'
import type { ComponentForecastResponse } from '@/types/forecast'
```

**Completion Criteria**:
- [ ] All 9 columns render correctly
- [ ] Sorting works for: name, consumption, runoutDate, reorderQty
- [ ] "Show only at-risk" filter updates URL and filters data
- [ ] Pagination works correctly
- [ ] Links to component detail pages work
- [ ] Dates format correctly with suppressHydrationWarning
- [ ] Empty state shows "No forecasts found."
- [ ] `npx tsc --noEmit` passes

---

## Phase 4: Forecast Dashboard Page

### Subtask 4.1: Create Forecasts Page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/forecasts/page.tsx`
**Pattern**: Hybrid of `src/app/(dashboard)/page.tsx` (dashboard) and `src/app/(dashboard)/components/page.tsx` (page structure)
**Instructions**:

1. Create as client component ('use client') for useEffect pattern
2. Import required dependencies:
```typescript
'use client'

import { useState, useEffect, useMemo } from 'react'
import { useSession } from 'next-auth/react'
import { useRouter, useSearchParams } from 'next/navigation'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { ForecastTable } from '@/components/features/ForecastTable'
import { AlertCircle, AlertTriangle, TrendingDown, DollarSign } from 'lucide-react'
import type { ComponentForecastResponse } from '@/types/forecast'
```

3. Define interfaces for API response:
```typescript
interface ForecastListResponse {
  data: ComponentForecastResponse[]
  meta: {
    total: number
    page: number
    pageSize: number
    totalPages: number
  }
}
```

4. Implement data fetching with useEffect:
   - Build URL with query params from searchParams
   - Include: page, pageSize, sortBy, sortOrder, showOnlyAtRisk
   - Handle loading and error states

5. Implement summary stats (computed from data):
   - Components needing reorder soon (status = critical)
   - Components with low runway (daysUntilRunout < 7 and not null)
   - Total at-risk components (any with recommendedReorderDate not null)
   - Use Card pattern from DashboardStats.tsx

6. Page layout:
```tsx
<div className="space-y-6">
  {/* Header */}
  <div>
    <h1 className="text-3xl font-bold">Forecasts</h1>
    <p className="text-muted-foreground">
      Component runout predictions and reorder recommendations
    </p>
  </div>

  {/* Stats Cards */}
  <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
    {/* 4 stat cards */}
  </div>

  {/* Forecast Table */}
  <ForecastTable ... />
</div>
```

7. Loading state: Show skeleton or "Loading..." text
8. Error state: Show error message in red

**Completion Criteria**:
- [ ] Page accessible at /forecasts
- [ ] Redirects to /login if not authenticated
- [ ] Summary stats cards display correctly
- [ ] Table loads and displays forecast data
- [ ] Loading state displays while fetching
- [ ] Error state displays on failure
- [ ] Page re-fetches when company changes
- [ ] `npm run build` passes
- [ ] `npx tsc --noEmit` passes

---

## Phase 5: Integration Testing

### Subtask 5.1: Manual Verification
**Instructions**:

1. Start development server: `npm run dev`
2. Navigate to `/forecasts`
3. Verify:
   - [ ] Page loads with data
   - [ ] Navigation link appears in sidebar
   - [ ] Stats cards show correct counts
   - [ ] Table shows all columns
   - [ ] Sorting works on all sortable columns
   - [ ] "Show only at-risk" filter works
   - [ ] Pagination works
   - [ ] Component links navigate correctly
   - [ ] Status badges show correct colors
   - [ ] Responsive layout works on mobile

4. Run build verification:
```bash
npm run build
npx tsc --noEmit
npm run lint
```

**Completion Criteria**:
- [ ] All manual checks pass
- [ ] Build succeeds without errors
- [ ] TypeScript check passes
- [ ] Lint passes

---

## Summary of Deliverables

**Files Created (3)**:
| File | Type | Lines Est. |
|------|------|------------|
| `src/app/(dashboard)/forecasts/page.tsx` | Page | ~180 |
| `src/components/features/ForecastTable.tsx` | Component | ~280 |
| `src/components/features/ForecastStatusBadge.tsx` | Component | ~55 |

**Files Modified (1)**:
| File | Change |
|------|--------|
| `src/app/(dashboard)/layout.tsx` | Add Forecasts nav item |

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 -> 2 -> 3 -> 4 -> 5)
2. Run `npx tsc --noEmit` after each phase
3. Run `npm run build` after Phase 4
4. Follow reference patterns exactly - do not innovate
5. Use suppressHydrationWarning on all date/number displays
6. Ensure responsive design (follow existing patterns)

## Reference Files Summary

| Purpose | File Path |
|---------|-----------|
| Page structure | `/home/pbrown/SkuInventory/src/app/(dashboard)/components/page.tsx` |
| Dashboard pattern | `/home/pbrown/SkuInventory/src/app/(dashboard)/page.tsx` |
| Table component | `/home/pbrown/SkuInventory/src/components/features/ComponentTable.tsx` |
| Table component (alt) | `/home/pbrown/SkuInventory/src/components/features/LotTable.tsx` |
| Stats cards | `/home/pbrown/SkuInventory/src/components/features/DashboardStats.tsx` |
| Badge variants | `/home/pbrown/SkuInventory/src/components/ui/badge.tsx` |
| Navigation | `/home/pbrown/SkuInventory/src/app/(dashboard)/layout.tsx` |
| API route | `/home/pbrown/SkuInventory/src/app/api/forecasts/route.ts` |
| Types | `/home/pbrown/SkuInventory/src/types/forecast.ts` |

## Test Strategy Note
- Manual UI testing is primary (no E2E tests configured for this feature)
- Run build and TypeScript checks as integration tests
- Visual verification of all UI states required

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 10m |
| **Total** | **30m** |
