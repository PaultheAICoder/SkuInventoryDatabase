# Implementation Plan
**Generated**: 2025-12-04T17:30:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #153
**Estimated Build Time**: 4-6 hours
**Complexity**: Medium

## Investigation Summary

### Request Analysis
**Type**: Bug Fix / UX Enhancement
**Source**: GitHub Issue #153
**Priority**: Medium

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="import"` or None

### Issue Validation
**Status**: Valid
**Recent Changes**: Issue #20 added multi-brand support; inventory-snapshot route was not updated to align

### Root Cause Analysis

The inventory snapshot import at `/src/app/api/import/inventory-snapshot/route.ts` fails with "No active brand found" because it uses an outdated pattern for brand resolution compared to other import routes.

**Current (broken) pattern in inventory-snapshot/route.ts (lines 38-47)**:
```typescript
const user = await prisma.user.findUnique({
  where: { id: session.user.id },
  include: { company: { include: { brands: { where: { isActive: true }, take: 1 } } } },
})

if (!user?.company.brands[0]) {
  return error('No active brand found', 400)
}
```

**Working pattern in components/route.ts and skus/route.ts (lines 34-48)**:
```typescript
// Use selected company for scoping
const selectedCompanyId = session.user.selectedCompanyId

// Use selected brand from session, or fall back to first active brand
let brandId = session.user.selectedBrandId

if (!brandId) {
  const brand = await prisma.brand.findFirst({
    where: { companyId: selectedCompanyId, isActive: true },
  })
  if (!brand) {
    return error('No active brand found for selected company', 400)
  }
  brandId = brand.id
}
```

**Why the error occurs**:
1. The old pattern queries from `user.company.brands` which uses the user's primary company, NOT the selected company
2. In multi-company/multi-brand environments, if the user is viewing a different company or the brand structure has changed, this can fail
3. The session object now contains `selectedCompanyId` and `selectedBrandId` which should be used
4. When `selectedBrandId` is `null` (no brand selected), the fallback query should use `selectedCompanyId` to find an active brand

**Additional UX Issue**:
Even with the fix, if no brand exists in the selected company, the error message is not actionable. The user should be prompted to select a brand via a dialog instead of just seeing an error.

### Current State Assessment
- **Existing components**:
  - `ImportForm.tsx` - handles file upload and API calls (line 117 calls the API)
  - `ImportResultDialog.tsx` - shows results AFTER import completes
  - `inventory-snapshot/route.ts` - API endpoint with broken brand logic
- **Database**: Brand model exists with `companyId` foreign key
- **API Routes**: Other import routes (`components`, `skus`) use correct pattern
- **Types**: Session types include `selectedBrandId: string | null` and `brands: Array<{ id: string; name: string }>`

### Dependencies & Blockers
1. None - all required patterns exist in sibling import routes

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Moderate
**Effort**: 4-6 hours
**Risk**: Low - fix aligns with existing patterns

### Patterns Identified
**Primary**: `/src/app/api/import/components/route.ts:34-48` - brand resolution with selectedCompanyId
**Secondary**: `/src/components/features/BuildDialog.tsx` - dialog with Select dropdown pattern

### Ripple Effect Analysis
**Files Identified**: 4 files

| File | Reason |
|------|--------|
| `/src/app/api/import/inventory-snapshot/route.ts` | Primary fix - update brand resolution |
| `/src/components/features/ImportForm.tsx` | Add brand selection dialog trigger |
| `/src/components/features/BrandSelectionDialog.tsx` (new) | New dialog for missing brand prompt |
| `/src/app/(dashboard)/import/page.tsx` | Wire up brand selection state |

---

## Executive Summary

This fix updates the inventory snapshot import route to use the same brand resolution pattern as other import routes (using `session.user.selectedBrandId` with fallback to `selectedCompanyId`). Additionally, it adds a graceful UX flow where users are prompted to select a brand via a dialog when no brand is configured, rather than showing a hard error.

## Phase 0: Code Analysis
### Subtask 0.1: Verify Current Brand Resolution Pattern
**File**: `/home/pbrown/SkuInventory/src/app/api/import/inventory-snapshot/route.ts`
**Instructions**:
1. Read lines 38-48 to confirm the broken pattern
2. Compare with `/src/app/api/import/components/route.ts` lines 34-48
3. Note that companyId is also needed - line 48 currently uses `user.companyId` which should use `selectedCompanyId`

**Completion Criteria**:
- [ ] Confirmed pattern difference documented
- [ ] Confirmed fix approach matches working routes

## Phase 1: API Route Fix
### Subtask 1.1: Update Brand Resolution in inventory-snapshot/route.ts
**File**: `/home/pbrown/SkuInventory/src/app/api/import/inventory-snapshot/route.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/app/api/import/components/route.ts:34-48`
**Instructions**:

1. Replace the current brand resolution block (lines 37-48) with the pattern from components/route.ts:

**Current code to replace (lines 37-48)**:
```typescript
// Get user's brand
const user = await prisma.user.findUnique({
  where: { id: session.user.id },
  include: { company: { include: { brands: { where: { isActive: true }, take: 1 } } } },
})

if (!user?.company.brands[0]) {
  return error('No active brand found', 400)
}

const brandId = user.company.brands[0].id
const companyId = user.companyId
```

**New code**:
```typescript
// Use selected company for scoping
const selectedCompanyId = session.user.selectedCompanyId

// Use selected brand from session, or fall back to first active brand
let brandId = session.user.selectedBrandId

if (!brandId) {
  const brand = await prisma.brand.findFirst({
    where: { companyId: selectedCompanyId, isActive: true },
  })
  if (!brand) {
    return error('No active brand found for selected company. Please select a brand from the sidebar or create one in Brand Management.', 400)
  }
  brandId = brand.id
}

const companyId = selectedCompanyId
```

2. Verify the `companyId` variable is updated to use `selectedCompanyId` instead of `user.companyId`

3. Ensure the rest of the route uses the updated `brandId` and `companyId` variables

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Brand resolution uses `session.user.selectedBrandId` first
- [ ] Fallback query uses `selectedCompanyId`
- [ ] Error message is more descriptive and actionable
- [ ] TypeScript compiles without errors
- [ ] Build succeeds

## Phase 2: Frontend UX Enhancement (Optional - Enhanced UX)
### Subtask 2.1: Create BrandSelectionDialog Component
**File**: `/home/pbrown/SkuInventory/src/components/features/BrandSelectionDialog.tsx` (NEW)
**Pattern**: Follow `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx` for Dialog + Select pattern
**Instructions**:

Create a new dialog component that:
1. Shows when import fails due to missing brand
2. Displays a dropdown of available brands from `session.user.brands`
3. Allows user to select a brand
4. Calls `/api/brands/switch` to set the brand in session
5. Returns the selected brand ID for retry

```typescript
'use client'

import { useState } from 'react'
import { useSession } from 'next-auth/react'
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import { Label } from '@/components/ui/label'
import { toast } from 'sonner'

interface BrandSelectionDialogProps {
  open: boolean
  onClose: () => void
  onBrandSelected: (brandId: string) => void
  title?: string
  description?: string
}

export function BrandSelectionDialog({
  open,
  onClose,
  onBrandSelected,
  title = 'Select Brand',
  description = 'Please select a brand for this import.',
}: BrandSelectionDialogProps) {
  const { data: session, update: updateSession } = useSession()
  const [selectedBrandId, setSelectedBrandId] = useState<string>('')
  const [isLoading, setIsLoading] = useState(false)

  const brands = session?.user?.brands || []

  const handleConfirm = async () => {
    if (!selectedBrandId) {
      toast.error('Please select a brand')
      return
    }

    setIsLoading(true)
    try {
      const res = await fetch('/api/brands/switch', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ brandId: selectedBrandId }),
      })

      if (!res.ok) {
        throw new Error('Failed to switch brand')
      }

      const data = await res.json()

      // Update session with new brand
      await updateSession({
        selectedBrandId: data.data.selectedBrandId,
        selectedBrandName: data.data.selectedBrandName,
      })

      toast.success(`Brand set to ${data.data.selectedBrandName}`)
      onBrandSelected(selectedBrandId)
      onClose()
    } catch (error) {
      console.error('Error setting brand:', error)
      toast.error('Failed to set brand. Please try again.')
    } finally {
      setIsLoading(false)
    }
  }

  if (brands.length === 0) {
    return (
      <Dialog open={open} onOpenChange={onClose}>
        <DialogContent className="sm:max-w-[400px]">
          <DialogHeader>
            <DialogTitle>No Brands Available</DialogTitle>
            <DialogDescription>
              No brands are configured for this company. Please contact an administrator to create a brand.
            </DialogDescription>
          </DialogHeader>
          <DialogFooter>
            <Button onClick={onClose}>Close</Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    )
  }

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="sm:max-w-[400px]">
        <DialogHeader>
          <DialogTitle>{title}</DialogTitle>
          <DialogDescription>{description}</DialogDescription>
        </DialogHeader>

        <div className="grid gap-4 py-4">
          <div className="grid grid-cols-4 items-center gap-4">
            <Label htmlFor="brand" className="text-right">
              Brand
            </Label>
            <Select value={selectedBrandId} onValueChange={setSelectedBrandId}>
              <SelectTrigger className="col-span-3">
                <SelectValue placeholder="Select a brand" />
              </SelectTrigger>
              <SelectContent>
                {brands.map((brand) => (
                  <SelectItem key={brand.id} value={brand.id}>
                    {brand.name}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>
        </div>

        <DialogFooter>
          <Button type="button" variant="outline" onClick={onClose}>
            Cancel
          </Button>
          <Button onClick={handleConfirm} disabled={isLoading || !selectedBrandId}>
            {isLoading ? 'Setting...' : 'Continue with Import'}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  )
}
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Component creates without TypeScript errors
- [ ] Uses existing UI component patterns (Dialog, Select, Button)
- [ ] Calls `/api/brands/switch` to persist selection
- [ ] Updates session via `updateSession`

### Subtask 2.2: Update ImportForm to Handle Brand Selection
**File**: `/home/pbrown/SkuInventory/src/components/features/ImportForm.tsx`
**Pattern**: Follow error handling in BuildDialog for showing confirmation dialogs
**Instructions**:

1. Add state for brand selection dialog:
```typescript
const [showBrandDialog, setShowBrandDialog] = useState(false)
const [pendingFile, setPendingFile] = useState<File | null>(null)
```

2. Update the error handling in `handleUpload` to detect "no active brand" error:
```typescript
// Inside handleUpload catch block or error check
if (errorMessage.toLowerCase().includes('no active brand')) {
  // Store the file for retry after brand selection
  setPendingFile(file)
  setShowBrandDialog(true)
  return
}
```

3. Add handler for brand selection:
```typescript
const handleBrandSelected = async () => {
  setShowBrandDialog(false)
  // Retry upload with the pending file
  if (pendingFile) {
    setFile(pendingFile)
    // Trigger upload retry
    await handleUpload()
  }
  setPendingFile(null)
}
```

4. Render the BrandSelectionDialog in the component's return:
```typescript
<BrandSelectionDialog
  open={showBrandDialog}
  onClose={() => {
    setShowBrandDialog(false)
    setPendingFile(null)
  }}
  onBrandSelected={handleBrandSelected}
  title="Brand Required"
  description="This import requires a brand to be selected. Please choose a brand to continue."
/>
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Import detects "no active brand" error
- [ ] Shows BrandSelectionDialog when error occurs
- [ ] Retries import after brand selection
- [ ] TypeScript compiles without errors

### Subtask 2.3: Update Import Page to Include BrandSelectionDialog
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/import/page.tsx`
**Instructions**:

The dialog is rendered inside ImportForm, so no changes needed to page.tsx unless we want to lift state up.

**Completion Criteria**:
- [ ] Verify page still compiles and renders

## Phase 3: Validation
### Subtask 3.1: End-to-End Testing
**Instructions**:

1. Test the API fix:
   - Log in as a user with `selectedBrandId` set
   - Upload an inventory snapshot Excel file
   - Verify import succeeds

2. Test fallback when no brand selected:
   - Clear `selectedBrandId` from session (use BrandSelector to select "All Brands")
   - Upload an inventory snapshot Excel file
   - Verify fallback query finds a brand
   - Verify import succeeds

3. Test error case (if implemented):
   - Create a test company with no brands
   - Attempt import
   - Verify descriptive error message

**Validation**:
```bash
npm run build
npx tsc --noEmit
npm run lint
```

**Completion Criteria**:
- [ ] Import works with selected brand
- [ ] Import works with fallback brand
- [ ] Error message is descriptive when no brands exist
- [ ] Build and lint pass

---

## Summary of Deliverables

**Files Modified**:
| File | Change |
|------|--------|
| `/src/app/api/import/inventory-snapshot/route.ts` | Update brand resolution to match other import routes |

**Files Created (Optional Enhanced UX)**:
| File | Purpose |
|------|---------|
| `/src/components/features/BrandSelectionDialog.tsx` | Dialog for selecting brand when missing |

**Files Updated (Optional Enhanced UX)**:
| File | Change |
|------|--------|
| `/src/components/features/ImportForm.tsx` | Handle brand selection error gracefully |

## Handoff to Build Agent

1. **Priority**: Execute Phase 1 first (API fix) - this resolves the core bug
2. Phase 2 is optional UX enhancement - can be deferred if time-constrained
3. Test completion criteria before each next subtask
4. Follow reference patterns exactly - see `/src/app/api/import/components/route.ts`

## Test Strategy Note
- Use manual testing via the `/import` page
- Verify with Excel file upload
- No automated tests required for this fix (existing patterns)

## Performance Metrics
| Phase | Estimated Duration |
|-------|----------|
| Phase 0 (Analysis) | 10m |
| Phase 1 (API Fix) | 30m |
| Phase 2 (UX Enhancement) | 2-3h |
| Phase 3 (Validation) | 30m |
| **Total** | **3.5-4.5h** |

---

## Decision Point for Build Agent

**Minimum Viable Fix (Phase 1 only)**: ~1 hour
- Fixes the bug
- Uses actionable error message
- No UI changes

**Full Implementation (Phase 1 + Phase 2)**: ~4 hours
- Fixes the bug
- Adds graceful UX with brand selection dialog
- Better user experience

**Recommendation**: Start with Phase 1. If successful and time permits, proceed with Phase 2.
