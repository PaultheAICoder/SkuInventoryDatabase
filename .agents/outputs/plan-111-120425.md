# Implementation Plan
**Generated**: 2025-12-04T12:30:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #111
**Estimated Build Time**: 6-8 hours
**Complexity**: Medium

## Investigation Summary

### Request Analysis
**Type**: Feature
**Source**: GitHub Issue #111 (Sub-issue of #98)
**Priority**: Medium

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: None

### Issue Validation
**Status**: Valid
**Recent Changes**: None affecting this feature - no existing `/transactions/new` page

### Current State Assessment
- Existing components:
  - `BuildDialog.tsx` - Full-featured build transaction dialog (689 lines)
  - `ReceiptDialog.tsx` - Receipt transaction dialog requiring component context (303 lines)
  - `AdjustmentDialog.tsx` - Adjustment dialog requiring component context (289 lines)
  - Transaction list page at `/transactions` with filtering support
- Database: No changes needed - uses existing transaction API endpoints
- API Routes:
  - `/api/transactions/receipt` - Receipt endpoint (uses `createReceiptSchema`)
  - `/api/transactions/build` - Build endpoint (uses `createBuildSchema`)
  - `/api/transactions/adjustment` - Adjustment endpoint (uses `createAdjustmentSchema`)
- Types: All transaction types defined in `src/types/transaction.ts`

### Dependencies & Blockers
1. None - all API endpoints exist
2. All required UI components (Select, Card, Input, Label, Button) available via shadcn/ui

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Medium
**Effort**: 6-8 hours
**Risk**: Low - Follows existing patterns, uses existing APIs

### Patterns Identified
**Primary**: `src/components/features/BuildDialog.tsx` - Form state management, API calls, success/error handling
**Secondary**: `src/app/(dashboard)/components/new/page.tsx` - Full page form pattern with auth check
**Tertiary**: `src/components/features/ComponentForm.tsx` - Card-based form layout with footer actions

### Ripple Effect Analysis
**Files Identified**: 4 files to create/modify
- `src/app/(dashboard)/transactions/new/page.tsx` - NEW: Quick entry page
- `src/components/features/QuickEntryForm.tsx` - NEW: Main form component
- `src/components/features/TransactionTypeSelector.tsx` - NEW: Transaction type picker
- `src/app/(dashboard)/layout.tsx` - MODIFY: Add navigation link (optional, depends on UX decision)

---

## Executive Summary
Create a unified Quick Entry interface at `/transactions/new` that allows users to quickly record Receipt, Build, and Adjustment transactions using dropdown menus. The form dynamically adapts its fields based on the selected transaction type, with all dropdowns populated from existing API endpoints. Includes smart defaults (today's date), keyboard navigation support, and a "record another" workflow for efficient data entry.

## Phase 1: Page Setup and Routing

### Subtask 1.1: Create Quick Entry Page
**File**: `src/app/(dashboard)/transactions/new/page.tsx`
**Pattern**: Follow `src/app/(dashboard)/components/new/page.tsx` (lines 1-26)
**Instructions**:
1. Create new directory `src/app/(dashboard)/transactions/new/`
2. Create `page.tsx` with server component wrapper
3. Use `getServerSession` from `next-auth` for auth check
4. Check user role - redirect viewers to `/transactions`
5. Import and render `QuickEntryForm` component
6. Include page header with title and description

**Code Reference**:
```tsx
// Pattern from src/app/(dashboard)/components/new/page.tsx
import { getServerSession } from 'next-auth'
import { redirect } from 'next/navigation'
import { authOptions } from '@/lib/auth'
import { QuickEntryForm } from '@/components/features/QuickEntryForm'

export default async function QuickEntryPage() {
  const session = await getServerSession(authOptions)
  if (!session?.user) {
    redirect('/login')
  }
  if (session.user.role === 'viewer') {
    redirect('/transactions')
  }
  return (
    <div className="mx-auto max-w-2xl space-y-6">
      <div>
        <h1 className="text-3xl font-bold">Quick Entry</h1>
        <p className="text-muted-foreground">Record a new transaction</p>
      </div>
      <QuickEntryForm />
    </div>
  )
}
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Page accessible at `/transactions/new`
- [ ] Auth redirect works for unauthenticated users
- [ ] Viewer role redirect works
- [ ] No TypeScript errors

## Phase 2: Transaction Type Selector Component

### Subtask 2.1: Create TransactionTypeSelector Component
**File**: `src/components/features/TransactionTypeSelector.tsx`
**Pattern**: Custom component using shadcn Radio/Toggle pattern
**Instructions**:
1. Create component with three transaction type options: Receipt, Build, Adjustment
2. Use button-style selection (similar to a tab/toggle group)
3. Accept `value` and `onValueChange` props
4. Include icons for each type (PackagePlus for Receipt, Hammer for Build, Scale for Adjustment)
5. Support keyboard navigation (left/right arrows, Enter to select)

**Code Reference**:
```tsx
'use client'

import { Button } from '@/components/ui/button'
import { cn } from '@/lib/utils'
import { PackagePlus, Hammer, Scale } from 'lucide-react'

export type TransactionTypeValue = 'receipt' | 'build' | 'adjustment'

interface TransactionTypeSelectorProps {
  value: TransactionTypeValue
  onValueChange: (value: TransactionTypeValue) => void
  disabled?: boolean
}

const TRANSACTION_TYPES = [
  { value: 'receipt' as const, label: 'Receipt', icon: PackagePlus, description: 'Receive components' },
  { value: 'build' as const, label: 'Build', icon: Hammer, description: 'Build SKUs' },
  { value: 'adjustment' as const, label: 'Adjustment', icon: Scale, description: 'Adjust inventory' },
]

export function TransactionTypeSelector({
  value,
  onValueChange,
  disabled = false,
}: TransactionTypeSelectorProps) {
  return (
    <div className="grid grid-cols-3 gap-2" role="radiogroup">
      {TRANSACTION_TYPES.map((type) => (
        <Button
          key={type.value}
          type="button"
          variant={value === type.value ? 'default' : 'outline'}
          className={cn(
            'h-auto flex-col gap-1 py-3',
            value === type.value && 'ring-2 ring-ring ring-offset-2'
          )}
          onClick={() => onValueChange(type.value)}
          disabled={disabled}
          role="radio"
          aria-checked={value === type.value}
        >
          <type.icon className="h-5 w-5" />
          <span className="font-medium">{type.label}</span>
          <span className="text-xs text-muted-foreground">{type.description}</span>
        </Button>
      ))}
    </div>
  )
}
```

**Validation Commands**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Component renders three transaction type options
- [ ] Selected state is visually distinct
- [ ] onClick handler triggers onValueChange
- [ ] Accessible with role="radiogroup" and aria-checked

## Phase 3: Quick Entry Form Component

### Subtask 3.1: Create QuickEntryForm Base Structure
**File**: `src/components/features/QuickEntryForm.tsx`
**Pattern**: Combine patterns from `BuildDialog.tsx` and `ComponentForm.tsx`
**Instructions**:
1. Create 'use client' component with form state management
2. Import TransactionTypeSelector and all required UI components
3. Set up state for:
   - `transactionType` (default: 'receipt')
   - `isLoading`, `error`, `successMessage`
   - Form data for each transaction type
4. Set up URL search params parsing for pre-selection (`?type=build&channel=Amazon`)
5. Include Card wrapper with header and footer

**Code Reference**:
```tsx
'use client'

import { useState, useEffect } from 'react'
import { useRouter, useSearchParams } from 'next/navigation'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardFooter, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'
import { TransactionTypeSelector, TransactionTypeValue } from './TransactionTypeSelector'
// ... additional imports

export function QuickEntryForm() {
  const router = useRouter()
  const searchParams = useSearchParams()

  const [transactionType, setTransactionType] = useState<TransactionTypeValue>('receipt')
  const [isLoading, setIsLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)
  const [successMessage, setSuccessMessage] = useState<string | null>(null)

  // Initialize from URL params
  useEffect(() => {
    const typeParam = searchParams.get('type')
    if (typeParam && ['receipt', 'build', 'adjustment'].includes(typeParam)) {
      setTransactionType(typeParam as TransactionTypeValue)
    }
    // Pre-fill sales channel from URL
    const channelParam = searchParams.get('channel')
    if (channelParam) {
      setBuildFormData(prev => ({ ...prev, salesChannel: channelParam }))
    }
  }, [searchParams])

  // ... form data states and handlers
}
```

**Validation Commands**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Component compiles without TypeScript errors
- [ ] URL params are parsed correctly
- [ ] Transaction type state changes work

### Subtask 3.2: Add Receipt Form Fields
**File**: `src/components/features/QuickEntryForm.tsx`
**Pattern**: Follow `ReceiptDialog.tsx` (lines 45-126)
**Instructions**:
1. Add state for receipt form data:
   - `date` (default: today)
   - `componentId` (required)
   - `quantity` (required)
   - `supplier` (required)
   - `costPerUnit` (optional)
   - `locationId` (optional)
   - `notes` (optional)
2. Fetch components from `/api/components?isActive=true&pageSize=100`
3. Show component dropdown with name and current quantity
4. Render fields conditionally when transactionType === 'receipt'

**Key Fields**:
- Component dropdown (required) - shows name + current quantityOnHand
- Quantity input (required, positive number)
- Supplier input (required)
- Date input (required, defaults to today)
- Cost per unit input (optional)
- Location dropdown (optional)
- Notes textarea (optional)

**Validation Commands**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Receipt fields render when type is 'receipt'
- [ ] Component dropdown populates from API
- [ ] Date defaults to today
- [ ] Form validation works

### Subtask 3.3: Add Build Form Fields
**File**: `src/components/features/QuickEntryForm.tsx`
**Pattern**: Follow `BuildDialog.tsx` (lines 75-88, 405-512)
**Instructions**:
1. Add state for build form data:
   - `date` (default: today)
   - `skuId` (required)
   - `unitsToBuild` (required)
   - `salesChannel` (optional, use salesChannels constant)
   - `locationId` (optional)
   - `notes` (optional)
2. Fetch SKUs from `/api/skus?isActive=true&pageSize=100`
3. Filter SKUs to only show those with `hasActiveBom: true` (note: the API response includes `activeBom` field)
4. Show SKU dropdown with name and max buildable units
5. Show sales channel dropdown using `salesChannels` from `@/types`

**Key Fields**:
- SKU dropdown (required) - filter to hasActiveBom, show maxBuildableUnits
- Units to build input (required, positive integer)
- Sales channel dropdown (optional) - Amazon, Shopify, TikTok, Generic
- Date input (required, defaults to today)
- Location dropdown (optional)
- Notes textarea (optional)

**Validation Commands**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Build fields render when type is 'build'
- [ ] SKU dropdown only shows SKUs with active BOM
- [ ] Sales channel dropdown uses existing salesChannels constant
- [ ] Max buildable units shown in SKU dropdown

### Subtask 3.4: Add Adjustment Form Fields
**File**: `src/components/features/QuickEntryForm.tsx`
**Pattern**: Follow `AdjustmentDialog.tsx` (lines 32-61, 157-274)
**Instructions**:
1. Add state for adjustment form data:
   - `date` (default: today)
   - `componentId` (required)
   - `adjustmentType` ('add' | 'subtract', default: 'subtract')
   - `quantity` (required, positive number)
   - `reason` (required, dropdown with predefined options)
   - `locationId` (optional)
   - `notes` (optional)
2. Use same components list fetched for receipts
3. Use ADJUSTMENT_REASONS constant from AdjustmentDialog pattern

**ADJUSTMENT_REASONS** (copy from AdjustmentDialog.tsx line 32-39):
```tsx
const ADJUSTMENT_REASONS = [
  { value: 'Inventory count correction', label: 'Inventory count correction' },
  { value: 'Damaged goods', label: 'Damaged goods' },
  { value: 'Lost/missing', label: 'Lost/missing' },
  { value: 'Sample/testing', label: 'Sample/testing' },
  { value: 'Returned to supplier', label: 'Returned to supplier' },
  { value: 'Other', label: 'Other (specify in notes)' },
]
```

**Key Fields**:
- Component dropdown (required) - shows name + current quantity
- Adjustment type selector (Add/Subtract toggle)
- Quantity input (required, positive number)
- Reason dropdown (required)
- Date input (required, defaults to today)
- Location dropdown (optional)
- Notes textarea (optional)
- Preview of new quantity based on adjustment

**Validation Commands**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Adjustment fields render when type is 'adjustment'
- [ ] Add/Subtract toggle works
- [ ] Reason dropdown has all options
- [ ] New quantity preview updates correctly

### Subtask 3.5: Implement Form Submission Logic
**File**: `src/components/features/QuickEntryForm.tsx`
**Pattern**: Follow submission patterns from BuildDialog.tsx (lines 181-270)
**Instructions**:
1. Create `handleSubmit` function that:
   - Validates required fields
   - Calls appropriate API endpoint based on transaction type:
     - Receipt: POST `/api/transactions/receipt`
     - Build: POST `/api/transactions/build`
     - Adjustment: POST `/api/transactions/adjustment`
   - Handles success state with message
   - Handles error state
2. Create `handleRecordAnother` function that resets form but keeps transaction type
3. Handle insufficient inventory warning for builds (show warning, allow force submit)

**API Payloads** (from src/types/transaction.ts):
- Receipt: `{ date, componentId, quantity, supplier, costPerUnit?, notes?, locationId? }`
- Build: `{ date, skuId, unitsToBuild, salesChannel?, notes?, locationId? }`
- Adjustment: `{ date, componentId, quantity (signed), reason, notes?, locationId? }`

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Form submits to correct API endpoint
- [ ] Success message shows after successful submission
- [ ] Error message shows on failure
- [ ] "Record Another" resets form appropriately

### Subtask 3.6: Add Success State and Record Another Flow
**File**: `src/components/features/QuickEntryForm.tsx`
**Pattern**: Custom success flow
**Instructions**:
1. After successful submission, show success state with:
   - Green success message with transaction summary
   - "Record Another" button that resets form
   - "View Transactions" button that navigates to transaction list
   - "Done" button that navigates back
2. On "Record Another":
   - Clear form data but keep transaction type selection
   - Reset date to today
   - Clear success/error messages
   - Focus on first input field

**Code Reference**:
```tsx
{successMessage && (
  <div className="rounded-md bg-green-50 border border-green-200 p-4">
    <p className="font-medium text-green-800">{successMessage}</p>
    <div className="mt-4 flex gap-2">
      <Button type="button" onClick={handleRecordAnother}>
        Record Another
      </Button>
      <Button type="button" variant="outline" onClick={() => router.push('/transactions')}>
        View Transactions
      </Button>
    </div>
  </div>
)}
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Success state displays after successful submission
- [ ] "Record Another" resets form correctly
- [ ] Navigation buttons work

## Phase 4: Navigation Integration

### Subtask 4.1: Add Link to Transactions Page
**File**: `src/app/(dashboard)/transactions/page.tsx`
**Pattern**: Similar to other list pages with action buttons
**Instructions**:
1. Add "New Transaction" button in the page header next to Export button
2. Button should link to `/transactions/new`
3. Use Plus icon from lucide-react
4. Only show for non-viewer roles (check session.user.role)

**Code Location**: Around line 177-183, after ExportButton
```tsx
// Add after ExportButton in the header
import Link from 'next/link'
import { Plus } from 'lucide-react'

// In header area:
{session?.user?.role !== 'viewer' && (
  <Link href="/transactions/new">
    <Button>
      <Plus className="h-4 w-4 mr-2" />
      New Transaction
    </Button>
  </Link>
)}
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] "New Transaction" button visible on transactions page
- [ ] Button navigates to `/transactions/new`
- [ ] Button hidden for viewer role

## Phase 5: Final Integration and Testing

### Subtask 5.1: Wrap QuickEntryForm in Suspense Boundary
**File**: `src/app/(dashboard)/transactions/new/page.tsx`
**Pattern**: Follow transactions/page.tsx Suspense pattern
**Instructions**:
1. Wrap QuickEntryForm in Suspense boundary for useSearchParams
2. Add fallback loading state

**Code Reference**:
```tsx
import { Suspense } from 'react'

export default async function QuickEntryPage() {
  // ... auth checks ...
  return (
    <div className="mx-auto max-w-2xl space-y-6">
      <div>
        <h1 className="text-3xl font-bold">Quick Entry</h1>
        <p className="text-muted-foreground">Record a new transaction</p>
      </div>
      <Suspense fallback={<div className="text-muted-foreground">Loading...</div>}>
        <QuickEntryForm />
      </Suspense>
    </div>
  )
}
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] No hydration errors
- [ ] useSearchParams works correctly in Suspense boundary

### Subtask 5.2: End-to-End Validation
**Instructions**:
1. Run full build to ensure no errors
2. Test manually:
   - Navigate to `/transactions/new`
   - Test each transaction type selection
   - Test form submission for each type
   - Test "Record Another" flow
   - Test URL parameter pre-selection
   - Test viewer role restriction

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
npm run lint
```

**Completion Criteria**:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` passes
- [ ] `npm run lint` passes (or no new warnings)
- [ ] All acceptance criteria from issue met

---

## Summary of Deliverables
**Files Created**: 3
- `src/app/(dashboard)/transactions/new/page.tsx`
- `src/components/features/QuickEntryForm.tsx`
- `src/components/features/TransactionTypeSelector.tsx`

**Files Modified**: 1
- `src/app/(dashboard)/transactions/page.tsx` (add navigation button)

## Handoff to Build Agent
1. Execute subtasks in exact order (Phase 1 -> Phase 5)
2. Complete each subtask fully before moving to next
3. Run validation commands after each subtask
4. Follow reference patterns exactly
5. Test completion criteria before marking subtask done

## Test Strategy Note
- No automated tests required for this feature per issue scope
- Manual testing outlined in Subtask 5.2

## API Reference Quick Guide
| Transaction Type | Endpoint | Key Payload Fields |
|-----------------|----------|-------------------|
| Receipt | POST /api/transactions/receipt | componentId, quantity, supplier, date |
| Build | POST /api/transactions/build | skuId, unitsToBuild, salesChannel?, date |
| Adjustment | POST /api/transactions/adjustment | componentId, quantity (signed), reason, date |

## Data Fetching Endpoints
| Data | Endpoint | Notes |
|------|----------|-------|
| Components | GET /api/components?isActive=true&pageSize=100 | Returns quantityOnHand |
| SKUs | GET /api/skus?isActive=true&pageSize=100 | Filter client-side for activeBom !== null |
| Locations | GET /api/locations?isActive=true&pageSize=50 | Standard location list |

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 12m |
| Validation | 3m |
| Planning | 15m |
| **Total** | **30m** |
