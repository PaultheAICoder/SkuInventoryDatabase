# Implementation Plan
**Generated**: 2025-12-03T04:15:00Z
**Task ID**: Issue #28 (duplicate: #32)
**Estimated Build Time**: 0.5 hours
**Complexity**: Low

## Executive Summary
Fix the BuildDialog component's `fetchSkus()` function to properly handle API errors. Currently when `/api/skus` fails (network error or HTTP error), no user-facing error is displayed. The error state and UI already exist in the component; they just need to be wired up in the `fetchSkus()` function.

## Schema Verification
N/A - No database changes required. This is a frontend-only bug fix.

## Ripple Effect Analysis
**Function**: `fetchSkus()` (local function, not exported)
**Direct Callers**: 1 location (line 63 in useEffect)
**Indirect Callers**: 0 (function is private to component)
**TOTAL FILES AFFECTED**: 1 (only BuildDialog.tsx)
**Impact**: Zero breaking changes - only adding error handling, not changing function signature

## Phase 1: Fix Error Handling in fetchSkus()

### Subtask 1.1: Add else block for HTTP errors
**File**: `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx`
**Pattern**: Follow `handleSubmit()` function in same file (lines 100-167)
**Location**: Lines 71-93 (fetchSkus function)

**Instructions**:
1. Add `setError(null)` at the start of the function to clear previous errors (after line 72)
2. Add else block after the `if (res.ok)` block (after line 87) to handle HTTP errors

**Current Code** (lines 71-93):
```typescript
const fetchSkus = async () => {
  setIsLoadingSkus(true)
  try {
    const res = await fetch('/api/skus?pageSize=100&isActive=true')
    if (res.ok) {
      const data = await res.json()
      // Filter to only SKUs with active BOMs
      setSkus(
        data.data.filter((sku: SKUOption) => sku.hasActiveBom).map((sku: SKUOption) => ({
          id: sku.id,
          name: sku.name,
          internalCode: sku.internalCode,
          maxBuildableUnits: sku.maxBuildableUnits,
          hasActiveBom: sku.hasActiveBom,
        }))
      )
    }
  } catch (err) {
    console.error('Failed to fetch SKUs:', err)
  } finally {
    setIsLoadingSkus(false)
  }
}
```

**New Code**:
```typescript
const fetchSkus = async () => {
  setIsLoadingSkus(true)
  setError(null)
  try {
    const res = await fetch('/api/skus?pageSize=100&isActive=true')
    if (res.ok) {
      const data = await res.json()
      // Filter to only SKUs with active BOMs
      setSkus(
        data.data.filter((sku: SKUOption) => sku.hasActiveBom).map((sku: SKUOption) => ({
          id: sku.id,
          name: sku.name,
          internalCode: sku.internalCode,
          maxBuildableUnits: sku.maxBuildableUnits,
          hasActiveBom: sku.hasActiveBom,
        }))
      )
    } else {
      // Handle HTTP errors (4xx, 5xx)
      const errorData = await res.json().catch(() => ({}))
      setError(errorData.error || 'Failed to load SKUs. Please try again.')
    }
  } catch (err) {
    console.error('Failed to fetch SKUs:', err)
    setError('Unable to connect. Please check your network and try again.')
  } finally {
    setIsLoadingSkus(false)
  }
}
```

**Specific Edits**:

**Edit 1**: Add `setError(null)` after `setIsLoadingSkus(true)` (line 72)
- **old_string**:
```typescript
  const fetchSkus = async () => {
    setIsLoadingSkus(true)
    try {
```
- **new_string**:
```typescript
  const fetchSkus = async () => {
    setIsLoadingSkus(true)
    setError(null)
    try {
```

**Edit 2**: Add else block after the `if (res.ok)` closing brace
- **old_string**:
```typescript
          }))
        )
      }
    } catch (err) {
      console.error('Failed to fetch SKUs:', err)
    } finally {
```
- **new_string**:
```typescript
          }))
        )
      } else {
        // Handle HTTP errors (4xx, 5xx)
        const errorData = await res.json().catch(() => ({}))
        setError(errorData.error || 'Failed to load SKUs. Please try again.')
      }
    } catch (err) {
      console.error('Failed to fetch SKUs:', err)
      setError('Unable to connect. Please check your network and try again.')
    } finally {
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
npm run lint
```

**Completion Criteria**:
- [ ] `setError(null)` added at start of fetchSkus()
- [ ] else block added to handle `!res.ok` case
- [ ] catch block calls `setError()` for network errors
- [ ] TypeScript compilation succeeds (`npx tsc --noEmit`)
- [ ] Build succeeds (`npm run build`)
- [ ] Lint passes (`npm run lint`)

## Phase 2: Manual Testing

### Subtask 2.1: Test error scenarios
**Type**: Manual Testing (no code changes)

**Instructions**:
1. Start the development server (`npm run dev`)
2. Open browser DevTools Network tab
3. Navigate to SKUs page
4. Click "Record Build" button to open BuildDialog

**Test Case A: Network Error**
1. In DevTools Network tab, right-click `/api/skus` request and select "Block request URL"
2. Close and reopen the BuildDialog
3. Verify: Error message "Unable to connect. Please check your network and try again." appears
4. Verify: Loading state disappears (no infinite spinner)
5. Unblock the request URL

**Test Case B: HTTP 500 Error (optional, requires API modification)**
1. If possible, temporarily modify API to return 500
2. Open BuildDialog
3. Verify: Error message appears
4. Verify: Loading state disappears

**Test Case C: Success Case (Regression)**
1. Ensure network requests are not blocked
2. Open BuildDialog
3. Verify: SKU dropdown loads correctly
4. Verify: SKUs with active BOMs are displayed
5. Verify: No error message shown
6. Verify: Can successfully submit a build transaction

**Test Case D: Dialog Reopen**
1. Block network request, open dialog, see error
2. Unblock network request
3. Close and reopen dialog
4. Verify: Error is cleared and SKUs load correctly

**Completion Criteria**:
- [ ] Network error shows user-friendly message
- [ ] Error message replaces loading state
- [ ] Dialog remains functional (can close/reopen)
- [ ] Success case still works (regression check)
- [ ] Reopening dialog clears previous error

## Summary of Deliverables

**Files Created**: 0
**Files Modified**: 1
- `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx`

**Changes Made**:
1. Added `setError(null)` at start of `fetchSkus()` to clear previous errors
2. Added else block to handle HTTP errors (`!res.ok`)
3. Updated catch block to call `setError()` for network errors

## Handoff to Build Agent

1. Execute subtasks in exact order (1.1 first, then 2.1)
2. Make both edits to BuildDialog.tsx as specified
3. Run validation commands after edits
4. Test manually using the test cases in Phase 2
5. Only mark complete when all completion criteria are checked

**Key Reference**: The pattern used matches `handleSubmit()` in the same file (lines 100-167), specifically:
- Line 110: `setError(null)` at start
- Line 163: `setError(err instanceof Error ? err.message : 'An error occurred')` in catch

**Error Messages**:
- HTTP errors: `'Failed to load SKUs. Please try again.'` (or API error message if available)
- Network errors: `'Unable to connect. Please check your network and try again.'`

## Acceptance Criteria (from Issue)
- [ ] When `/api/skus` returns HTTP error (4xx, 5xx), user sees error message
- [ ] When `/api/skus` fails with network error, user sees error message
- [ ] Error message is user-friendly (not technical jargon)
- [ ] Error message suggests action ("Please try again")
- [ ] Loading spinner disappears when error occurs
- [ ] Dialog remains open to allow user to read error and try again
- [ ] Existing functionality not affected (success case still works)
- [ ] TypeScript compilation succeeds
- [ ] Build succeeds with no errors

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Scout Review | 5m |
| Pattern Research | 3m |
| Plan Writing | 8m |
| **Total** | **16m** |

---

AGENT_RETURN: plan-28-120325
