# Quick Fix Plan

**Issue**: #394 - Fraction input for component prices rounds incorrectly
**Tier**: 1 (Quick Fix)
**Type**: Bug Fix
**Est. Time**: 1-2 hours
**Generated**: 2026-01-08
**Generated By**: Scout-and-Plan Agent (combined workflow)

## Investigation Summary

### Request Analysis
**Type**: Bug Fix
**Source**: GitHub Issue #394
**Priority**: P2 (Medium)
**Category**: BUG_FIX
**Test Strategy**: TARGETED

### Issue Validation
**Status**: Valid
**Verified**: 2026-01-08 - Reproduction confirmed

### Current State Assessment

The problem is clearly identified:

1. **ComponentForm.tsx** (line 228-235) uses `type="number"` for the costPerUnit input:
   ```typescript
   <Input
     id="costPerUnit"
     type="number"
     step="0.000001"
     min="0"
     value={formData.costPerUnit}
     onChange={(e) => setFormData((prev) => ({ ...prev, costPerUnit: e.target.value }))}
   />
   ```

2. HTML `type="number"` inputs do NOT accept fraction strings like "1/45" - they only accept numeric values.

3. When user types "1/45", the browser likely rejects it or parses it incorrectly.

4. The form submit uses `parseFloat(formData.costPerUnit)` which cannot parse fractions.

### Existing Pattern (Already Implemented)

**The solution already exists in the codebase!** The BOM forms successfully handle fraction input:

- **Pattern File**: `/home/pbrown/SkuInventory/src/components/features/BOMVersionForm.tsx` (lines 310-318)
  - Uses `type="text"` instead of `type="number"`
  - Stores raw string value (including fractions)
  - Uses `parseFractionOrNumber()` from `src/lib/utils.ts` for calculations

- **Utility Function**: `/home/pbrown/SkuInventory/src/lib/utils.ts` (lines 82-115)
  - `parseFractionOrNumber()` - handles both fractions (e.g., "1/45") and decimal numbers
  - Already used in: BOMVersionForm, BOMVersionEditForm, import services

- **Schema Pattern**: `/home/pbrown/SkuInventory/src/types/bom.ts` (lines 8-33)
  - Uses `z.union([z.string(), z.number()])` with custom transform
  - Calls `parseFractionOrNumber()` for validation

### Pattern Scan for Similar Issues

Checked other forms with costPerUnit inputs:
- `FinishedGoodsReceiptDialog.tsx` (line 227-234): Uses `type="number"` - **SAME BUG**
- `QuickEntryForm.tsx` (line 503-512): Uses `type="number"` - **SAME BUG**

**Decision**: Fix only ComponentForm.tsx in this issue (as reported). The other forms should be addressed in a follow-up issue since they are less likely to need fraction input for receipt costs.

---

## The Fix

The ComponentForm.tsx uses `type="number"` for costPerUnit, which doesn't support fraction input like "1/45". The fix is to:
1. Change input type from "number" to "text"
2. Add placeholder showing fraction support
3. Use existing `parseFractionOrNumber()` utility on form submit
4. Update the component type schema to handle fractions

---

## Changes Required

| File | Line | Change |
|------|------|--------|
| `src/components/features/ComponentForm.tsx` | 1-10 | Add import for `parseFractionOrNumber` |
| `src/components/features/ComponentForm.tsx` | 228-235 | Change costPerUnit input from `type="number"` to `type="text"`, add placeholder |
| `src/components/features/ComponentForm.tsx` | 96 | Use `parseFractionOrNumber()` instead of `parseFloat()` |
| `src/types/component.ts` | 19 | Update costPerUnit schema to handle fractions |

---

## Detailed Implementation

### Phase 1: Update Type Schema

**File**: `/home/pbrown/SkuInventory/src/types/component.ts`

**Current** (line 19):
```typescript
costPerUnit: z.coerce.number().nonnegative('Cost must be non-negative').default(0),
```

**Change to** (following pattern from `src/types/bom.ts` lines 8-33):
```typescript
costPerUnit: z
  .union([z.string(), z.number()])
  .transform((val, ctx) => {
    // If already a number, validate it directly
    if (typeof val === 'number') {
      if (isNaN(val) || val < 0) {
        ctx.addIssue({
          code: z.ZodIssueCode.custom,
          message: 'Cost must be a non-negative number',
        })
        return z.NEVER
      }
      return val
    }

    // Parse string (fraction or decimal)
    const parsed = parseFractionOrNumber(val)
    if (parsed === null || parsed < 0) {
      ctx.addIssue({
        code: z.ZodIssueCode.custom,
        message: 'Cost must be a non-negative number or fraction (e.g., "0.02", "1/45")',
      })
      return z.NEVER
    }
    return parsed
  })
  .default(0),
```

**Also add import at top**:
```typescript
import { parseFractionOrNumber } from '@/lib/utils'
```

**Completion Criteria**:
- [ ] Import added at top of file
- [ ] costPerUnit schema updated with fraction support
- [ ] Error message mentions fraction support

### Phase 2: Update Component Form

**File**: `/home/pbrown/SkuInventory/src/components/features/ComponentForm.tsx`

**Step 2.1**: Add import (after line 17):
```typescript
import { parseFractionOrNumber } from '@/lib/utils'
```

**Step 2.2**: Update costPerUnit input (lines 228-235):

**Current**:
```typescript
<Input
  id="costPerUnit"
  type="number"
  step="0.000001"
  min="0"
  value={formData.costPerUnit}
  onChange={(e) => setFormData((prev) => ({ ...prev, costPerUnit: e.target.value }))}
/>
```

**Change to** (following pattern from BOMVersionForm.tsx lines 310-318):
```typescript
<Input
  id="costPerUnit"
  type="text"
  value={formData.costPerUnit}
  onChange={(e) => setFormData((prev) => ({ ...prev, costPerUnit: e.target.value }))}
  placeholder="e.g., 0.02, 1/45"
/>
```

**Step 2.3**: Update form submit parsing (line 96):

**Current**:
```typescript
costPerUnit: parseFloat(formData.costPerUnit),
```

**Change to**:
```typescript
costPerUnit: parseFractionOrNumber(formData.costPerUnit) ?? 0,
```

**Completion Criteria**:
- [ ] Import added for `parseFractionOrNumber`
- [ ] Input type changed from "number" to "text"
- [ ] Placeholder shows fraction example
- [ ] Form submit uses `parseFractionOrNumber()`

---

## Validation Commands

```bash
# TypeScript check
npx tsc --noEmit

# Build check
npm run build

# Lint check
npm run lint

# Run related unit tests
npm test -- --testPathPattern="date-utils"

# Run E2E test for BOM fraction (reference)
npm run test:e2e -- --grep="fraction"
```

---

## Manual Testing Checklist

Test at: http://172.16.20.50:2345/components/new

1. [ ] Navigate to Components > Add New Component
2. [ ] Verify costPerUnit field shows placeholder "e.g., 0.02, 1/45"
3. [ ] Enter "1/45" in costPerUnit field
4. [ ] Verify value is accepted (not rejected)
5. [ ] Fill other required fields (name, SKU code)
6. [ ] Submit form
7. [ ] Verify component created with costPerUnit = 0.022222 (full precision)
8. [ ] Edit the component and verify value displays correctly
9. [ ] Test with regular decimal input "0.5" still works
10. [ ] Test with edge cases: "0", "100", "1/3"

---

## Files Summary

**Created**: 0
**Modified**: 2
- `src/types/component.ts` - Update costPerUnit schema
- `src/components/features/ComponentForm.tsx` - Update input and parsing

---

## Follow-Up Issues Recommended

The following forms have the same bug pattern but were not included in this fix:

1. `src/components/features/FinishedGoodsReceiptDialog.tsx` (line 227) - uses `type="number"` for costPerUnit
2. `src/components/features/QuickEntryForm.tsx` (line 505) - uses `type="number"` for costPerUnit

**Recommendation**: Create a follow-up issue to apply the same fix pattern to these forms if fraction input is needed for receipt transactions.

---

## Notes

- The database already supports full precision - Component.costPerUnit is `Decimal(12, 6)` in Prisma schema
- The `parseFractionOrNumber` utility is battle-tested and already used in BOM forms and import services
- No database migration needed
- No API route changes needed (schema transform handles the parsing)
