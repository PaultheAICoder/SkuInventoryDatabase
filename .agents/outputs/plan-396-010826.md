# Implementation Plan

**Issue**: #396 - Show missing fields in natural language preview with fill-in capability
**Tier**: 2 (Standard)
**Type**: Enhancement
**Est. Time**: 4-6 hours
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED

## Summary

Enhance `ParsedTransactionPreview` component to display missing required fields (supplier, location, reason) as inline-editable dropdowns with visual indicators, rather than requiring the user to switch to "Edit Manually" mode. This enables quick completion of partially parsed transactions directly within the preview.

## Current State

- **ParsedTransactionPreview.tsx** (287 lines): Displays parsed transaction with confidence indicators
  - Missing fields are currently hidden or show "(default)" text
  - No inline editing capability - user must click "Edit Manually" to fill missing fields
  - Has warning banners for low confidence and missing fields
- **QuickEntryWrapper.tsx** manages state and passes parsed result to preview
  - Calls `submitParsedTransaction` with the parsed data directly
  - Currently falls back to "Unknown" supplier or "Adjustment" reason when values missing
- **QuickEntryForm.tsx** has existing Select dropdowns for location, and text input for supplier
- **LineMappingDialog.tsx** has a good pattern: search input + Select dropdown with API fetch
- **Locations API** exists at `/api/locations?isActive=true`
- **No Suppliers API** - suppliers are stored as free text strings on transactions
  - Issue #397 proposes adding Vendor/Supplier management (database table + API)
  - For now, can query distinct suppliers from existing transactions

## Dependencies

**Soft Dependency**: Issue #397 (Vendors/Suppliers management) would provide a proper supplier list API. However, this issue can proceed by:
1. Using distinct supplier values from existing Transaction records
2. Allowing free-text entry for new suppliers

**No Blockers**: This feature can be implemented independently.

## Changes Required

### Phase 1: Add Suppliers Endpoint for Distinct Values

| Subtask | File | Change | Completion Criteria |
|---------|------|--------|---------------------|
| 1.1 | `/home/pbrown/SkuInventory/src/app/api/suppliers/route.ts` | Create new endpoint to return distinct supplier values from Transaction table, plus accept query param for searching | [ ] Returns `{ data: [{value: string}] }` format |
| 1.2 | Test endpoint | Verify via manual testing | [ ] `GET /api/suppliers` returns supplier list |

**Subtask 1.1 Details**:
```typescript
// Pattern: Follow /api/locations/route.ts GET handler
// Query: SELECT DISTINCT supplier FROM "Transaction" WHERE companyId = $1 AND supplier IS NOT NULL
// Add search param support: WHERE supplier ILIKE '%search%'
// Response format: { data: [{ value: "Supplier Name" }, ...] }
```

### Phase 2: Create Editable Field Component

| Subtask | File | Change | Completion Criteria |
|---------|------|--------|---------------------|
| 2.1 | `/home/pbrown/SkuInventory/src/components/features/EditablePreviewField.tsx` | Create reusable component for inline editable dropdown fields with missing indicator | [ ] Component renders, types correct |

**Subtask 2.1 Details**:
Pattern to follow: `LineMappingDialog.tsx` lines 159-192 (search input + Select)

```typescript
interface EditablePreviewFieldProps {
  label: string
  icon: React.ReactNode
  value: string | null
  onChange: (value: string) => void
  options: Array<{ value: string; label: string }>
  isLoading?: boolean
  onSearch?: (query: string) => void
  placeholder?: string
  required?: boolean
  allowFreeText?: boolean  // For supplier - can type new value
}

// Visual indicators:
// - Missing required: red X icon, text "Required - click to select"
// - Missing optional: amber indicator, "Not specified"
// - Filled: green check, display value
```

### Phase 3: Enhance ParsedTransactionPreview with Editable Fields

| Subtask | File | Change | Completion Criteria |
|---------|------|--------|---------------------|
| 3.1 | `/home/pbrown/SkuInventory/src/components/features/ParsedTransactionPreview.tsx` | Add local state for editable field values (supplier, location, reason) | [ ] State management works |
| 3.2 | Same file | Fetch locations and suppliers on mount | [ ] Data loads correctly |
| 3.3 | Same file | Replace static display with EditablePreviewField components for supplier (receipts), location (all), reason (adjustments) | [ ] Fields are editable |
| 3.4 | Same file | Disable Confirm button when required fields are missing | [ ] Button disabled appropriately |
| 3.5 | Same file | Pass updated values to onConfirm callback | [ ] Changes propagate to parent |

**Subtask 3.1-3.5 Details**:

Update props interface to accept onFieldChange callback:
```typescript
interface ParsedTransactionPreviewProps {
  result: ParseTransactionResponse
  onConfirm: (overrides?: { supplier?: string; locationId?: string; reason?: string }) => void
  onEdit: () => void
  onCancel: () => void
  onSaveAsDraft?: (overrides?: { supplier?: string; locationId?: string; reason?: string }) => void
  isSubmitting?: boolean
}
```

Location where supplier is currently displayed (lines 183-194):
```typescript
// BEFORE:
{parsed.supplier && parsed.supplier.value && (
  <div className="flex items-center justify-between">
    ...
  </div>
)}

// AFTER: Always show for receipts, make editable if missing
{parsed.transactionType.value === 'receipt' && (
  <EditablePreviewField
    label="Supplier"
    icon={<Truck className="h-4 w-4" />}
    value={supplierValue}
    onChange={setSupplierValue}
    options={suppliers}
    isLoading={isLoadingSuppliers}
    onSearch={handleSupplierSearch}
    placeholder="Select or enter supplier"
    required={true}
    allowFreeText={true}
  />
)}
```

### Phase 4: Update QuickEntryWrapper to Handle Overrides

| Subtask | File | Change | Completion Criteria |
|---------|------|--------|---------------------|
| 4.1 | `/home/pbrown/SkuInventory/src/components/features/QuickEntryWrapper.tsx` | Update handleConfirm to accept and use override values from ParsedTransactionPreview | [ ] Overrides used in API call |
| 4.2 | Same file | Update submitParsedTransaction to use overrides | [ ] Transaction created with correct values |

**Subtask 4.1-4.2 Details**:

Update handleConfirm signature (line 138):
```typescript
const handleConfirm = async (overrides?: { supplier?: string; locationId?: string; reason?: string }) => {
  if (!parsedResult) return
  const success = await submitParsedTransaction(parsedResult.parsed, overrides)
  // ...
}
```

Update submitParsedTransaction (line 72):
```typescript
const submitParsedTransaction = useCallback(async (
  parsed: ParsedTransaction,
  overrides?: { supplier?: string; locationId?: string; reason?: string }
) => {
  // ... in receipt case (line 85-93):
  payload = {
    componentId: parsed.itemId.value,
    date,
    quantity: parsed.quantity.value,
    supplier: overrides?.supplier || parsed.supplier?.value || 'Unknown',
    // ...
  }
  // Similar for locationId and reason in other cases
}, [])
```

## Validation

- [ ] `npm run build` passes
- [ ] `npm run lint` passes
- [ ] `npx tsc --noEmit` passes
- [ ] Manual test: Parse "received 100 bottles" - should show empty Supplier field with X indicator
- [ ] Manual test: Click supplier field, search, select - should update preview
- [ ] Manual test: Confirm with filled supplier - should create transaction with correct supplier
- [ ] Manual test: Try to confirm without filling required supplier - button should be disabled

## Files Summary

**Created**: 2
- `/home/pbrown/SkuInventory/src/app/api/suppliers/route.ts` - New API endpoint
- `/home/pbrown/SkuInventory/src/components/features/EditablePreviewField.tsx` - New reusable component

**Modified**: 2
- `/home/pbrown/SkuInventory/src/components/features/ParsedTransactionPreview.tsx` - Add editable fields
- `/home/pbrown/SkuInventory/src/components/features/QuickEntryWrapper.tsx` - Pass overrides to submission

## UI Acceptance Criteria

- [ ] Missing required fields show red X icon with "Required" indicator
- [ ] Missing optional fields show amber indicator
- [ ] Clicking missing field opens searchable dropdown
- [ ] Supplier dropdown allows free-text entry for new suppliers
- [ ] Location dropdown shows company locations
- [ ] Confirm button disabled until required fields filled
- [ ] Filled values properly included in transaction creation

## Technical Notes

1. **Supplier vs Vendor**: The database stores `supplier` as a plain string on Transaction. Issue #397 proposes a Vendor table, but this issue can proceed with distinct supplier values + free-text entry.

2. **Location Resolution**: The parser extracts location NAME, but the API needs locationId. The EditablePreviewField should store the selected location's ID.

3. **Pattern Reference**:
   - Search + Select pattern: `LineMappingDialog.tsx` lines 55-98 (debounced search)
   - Select component usage: `QuickEntryForm.tsx` lines 517-537

4. **Confidence Display**: Maintain existing confidence icons for parsed values, only apply "missing" indicator for null/undefined values.

---

**Generated**: 2026-01-08
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: Issue #396
**Complexity**: Medium
