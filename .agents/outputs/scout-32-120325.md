# Scout Report: Bug #32 - BuildDialog infinite loading on SKU API failure

## Request Analysis
**Type**: Bug
**Source**: GitHub Issue #32
**Priority**: Medium (same as #28)
**Verified**: 2025-12-03

## Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="BuildDialog"` or `--filter="dialog"` for related dialogs

## Issue Validation
**Status**: DUPLICATE of Issue #28
**Recent Changes**: None to BuildDialog since issue #15 (defect tracking)
**Overlap Analysis**: Both issues describe the exact same bug with identical symptoms, location, and root cause

### Comparison with Issue #28

| Aspect | Issue #28 | Issue #32 |
|--------|-----------|-----------|
| **Title** | BuildDialog shows infinite loading when SKU API fails | When you open the Build Dialog and the SKU API fails to load (network error, ...) |
| **File** | `src/components/features/BuildDialog.tsx:68-90` | `src/components/features/BuildDialog.tsx (lines 68-90)` |
| **Problem** | Missing error handling - no else block for `!res.ok` | Missing else block - error silently swallowed |
| **Expected** | Show error message like "Failed to load SKUs. Please try again." | Show error message like "Failed to load SKUs. Please try again." |
| **Reproduction** | 1. Block `/api/skus` requests<br>2. Open Build dialog<br>3. See infinite loading | 1. Go to SKUs page<br>2. Open Build dialog<br>3. If `/api/skus` fails, infinite loading |
| **Root Cause** | `if (res.ok) { ... }` with no else block | Same - no else block when `res.ok` is false |
| **Severity** | Medium | Medium |

**Conclusion**: These are IDENTICAL issues. Issue #32 should be closed as duplicate of #28.

## Current State

### Error Details
- **Error Type**: Missing error handling
- **Error Message**: None (that's the problem - user sees nothing)
- **Location**: `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx:71-93`
- **Trigger**: When `/api/skus?pageSize=100&isActive=true` endpoint fails (network error, 500, 404, etc.)

### Current Implementation
```typescript
// Line 71-93
const fetchSkus = async () => {
  setIsLoadingSkus(true)
  try {
    const res = await fetch('/api/skus?pageSize=100&isActive=true')
    if (res.ok) {
      const data = await res.json()
      // Filter to only SKUs with active BOMs
      setSkus(
        data.data.filter((sku: SKUOption) => sku.hasActiveBom).map((sku: SKUOption) => ({
          id: sku.id,
          name: sku.name,
          internalCode: sku.internalCode,
          maxBuildableUnits: sku.maxBuildableUnits,
          hasActiveBom: sku.hasActiveBom,
        }))
      )
    }
    // ← MISSING: No else block to handle !res.ok case
  } catch (err) {
    console.error('Failed to fetch SKUs:', err)
    // ← MISSING: No user-facing error (setError not called)
  } finally {
    setIsLoadingSkus(false)
  }
}
```

### State Variables Available
- Line 42: `const [isLoading, setIsLoading] = useState(false)` - for form submission
- Line 43: `const [isLoadingSkus, setIsLoadingSkus] = useState(true)` - for SKU loading
- Line 44: `const [error, setError] = useState<string | null>(null)` - already exists!
- Line 45: `const [skus, setSkus] = useState<SKUOption[]>([])` - SKU list

### UI Rendering
- Line 185-189: Error display already implemented for form submission errors
- Line 258: Loading state shows "Loading SKUs..." in SelectTrigger placeholder
- **Problem**: When `isLoadingSkus=true` and `error=null` and `skus=[]`, user sees "Loading SKUs..." forever

### Why This Happens
1. User clicks Build button
2. Dialog opens, `fetchSkus()` is called (line 63)
3. `/api/skus` endpoint fails (network error, server down, etc.)
4. Response has `res.ok = false` (status 400, 500, etc.)
5. Code skips the `if (res.ok)` block
6. No else block exists to handle this case
7. `setError()` is never called - error state remains `null`
8. `setIsLoadingSkus(false)` runs in finally block
9. But `skus` array is still empty `[]`
10. UI shows SelectTrigger with "Select SKU" placeholder and disabled state
11. User sees disabled dropdown but no error message explaining why

**Wait, correction**: I need to re-read the code...

Actually looking at line 255-258:
```typescript
disabled={isLoadingSkus}
```
and line 258:
```typescript
<SelectValue placeholder={isLoadingSkus ? 'Loading SKUs...' : 'Select SKU'} />
```

So when `isLoadingSkus=false` (which it becomes in finally), the placeholder changes to "Select SKU" but the dropdown is enabled and empty. User can click but sees no options. Still no error message!

## Similar Patterns in Codebase

**Other dialogs with similar pattern** (may have same issue):

1. `/home/pbrown/SkuInventory/src/components/features/BOMVersionForm.tsx:60-75`
   - Fetches components on mount
   - Has same pattern: `if (res.ok) { ... }` with no else block
   - Only logs error to console, no user-facing error

2. `/home/pbrown/SkuInventory/src/components/features/BOMVersionList.tsx:67-72`
   - Clone BOM version action
   - Has `if (res.ok) { ... }` but wraps in try/catch that only logs

3. `/home/pbrown/SkuInventory/src/components/features/UserTable.tsx:53-58, 70-75`
   - Toggle status and delete actions
   - Same pattern

**Total files with this anti-pattern**: 9 files found (grep results)

**However**, BuildDialog is the only dialog that:
1. Fetches data on open (critical path)
2. Shows loading state to user
3. Requires data to be functional
4. Has an existing `error` state variable (line 44)

Other components either:
- Fetch data for display only (BOMVersionForm)
- Are action buttons that fail silently (UserTable)
- Don't have loading states

So BuildDialog is the most critical to fix, but BOMVersionForm should also be considered.

## Dependencies & Blockers

**Can Proceed?**: YES - No blockers

**Dependencies**: None
- Error state variable already exists (line 44)
- Error display UI already exists (line 185-189)
- Just need to wire them up in fetchSkus()

## Complexity Assessment
**Complexity**: Simple
**Effort**: 15-30 minutes
**Risk**: Low - adding error handling to existing try/catch block

## Patterns to Follow

**Primary Reference**: Same file - BuildDialog form submission handler
- Lines 109-167: `handleSubmit` function
- Line 110: `setError(null)` to clear previous errors
- Line 163: `setError(err instanceof Error ? err.message : 'An error occurred')` to set error
- Lines 185-189: Error display UI

**Secondary Reference**: Other dialog error handling patterns
- `/home/pbrown/SkuInventory/src/components/features/ReceiptDialog.tsx:46-86`
  - Lines 48, 83: Same setError pattern
- `/home/pbrown/SkuInventory/src/components/features/AdjustmentDialog.tsx:62-99`
  - Lines 63, 98: Same setError pattern

**Best Practice Pattern**: Always handle both success and failure cases when fetching data
```typescript
try {
  const res = await fetch('/api/endpoint')
  if (res.ok) {
    // Handle success
    const data = await res.json()
    setState(data)
  } else {
    // Handle HTTP error (4xx, 5xx)
    const errorData = await res.json().catch(() => ({}))
    setError(errorData.error || 'Failed to load data')
  }
} catch (err) {
  // Handle network error (no response)
  setError('Network error. Please try again.')
} finally {
  setIsLoading(false)
}
```

## Files to Create/Modify

### Modify
1. `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx`
   - **Add else block** to `fetchSkus()` function (after line 86)
   - **Add setError call** in else block to display user-facing error
   - **Add setError call** in catch block (currently only logs to console)
   - **Optional**: Add retry mechanism (button in error state)

### Expected Changes
```diff
  const fetchSkus = async () => {
    setIsLoadingSkus(true)
+   setError(null) // Clear any previous errors
    try {
      const res = await fetch('/api/skus?pageSize=100&isActive=true')
      if (res.ok) {
        const data = await res.json()
        // Filter to only SKUs with active BOMs
        setSkus(
          data.data.filter((sku: SKUOption) => sku.hasActiveBom).map((sku: SKUOption) => ({
            id: sku.id,
            name: sku.name,
            internalCode: sku.internalCode,
            maxBuildableUnits: sku.maxBuildableUnits,
            hasActiveBom: sku.hasActiveBom,
          }))
        )
+     } else {
+       // Handle HTTP errors (4xx, 5xx)
+       const errorData = await res.json().catch(() => ({}))
+       setError(errorData.error || 'Failed to load SKUs. Please try again.')
      }
    } catch (err) {
      console.error('Failed to fetch SKUs:', err)
+     // Handle network errors
+     setError('Unable to connect. Please check your network and try again.')
    } finally {
      setIsLoadingSkus(false)
    }
  }
```

**Optional Enhancement**: Add retry button in error state
```diff
  {error && (
    <div className="rounded-md bg-destructive/10 p-3 text-sm text-destructive">
-     {error}
+     <div className="flex items-center justify-between">
+       <span>{error}</span>
+       {isLoadingSkus === false && (
+         <Button
+           size="sm"
+           variant="outline"
+           onClick={fetchSkus}
+         >
+           Retry
+         </Button>
+       )}
+     </div>
    </div>
  )}
```

## Final Sweep Results

**Services Search**: No service changes needed
**API Routes**: No API changes needed
**Type Definitions**: No type changes needed
**Components**: 1 component affected (BuildDialog.tsx)
**Test Files**: No existing tests for BuildDialog error states

**All Affected Files** (comprehensive list):
- `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx` - Add error handling to fetchSkus()

**Related Files with Same Pattern** (not fixing in this issue, but should be considered for future):
- `/home/pbrown/SkuInventory/src/components/features/BOMVersionForm.tsx` - Same pattern (lines 60-75)
- `/home/pbrown/SkuInventory/src/components/features/BOMVersionList.tsx` - Same pattern (lines 67-72, 85-90)
- `/home/pbrown/SkuInventory/src/components/features/UserTable.tsx` - Same pattern (lines 53-58, 70-75)
- `/home/pbrown/SkuInventory/src/components/features/DefectAnalyticsDashboard.tsx` - May have similar pattern
- `/home/pbrown/SkuInventory/src/components/features/FeedbackDialog.tsx` - May have similar pattern
- `/home/pbrown/SkuInventory/src/components/features/UserForm.tsx` - May have similar pattern
- `/home/pbrown/SkuInventory/src/components/features/ComponentForm.tsx` - May have similar pattern
- `/home/pbrown/SkuInventory/src/components/features/SKUForm.tsx` - May have similar pattern

**Recommendation**: After fixing #28/#32, audit all 9 files found by grep to ensure consistent error handling patterns across the codebase.

## Ripple Effect Analysis

**Function**: `fetchSkus()` (local function, not exported)
**Direct Callers**: 1 location
  - Line 63: Called in useEffect when dialog opens

**Indirect Callers**: 0 (function is private to component)

**TOTAL FILES AFFECTED**: 1 (only BuildDialog.tsx)

**Impact**: Zero breaking changes
- Only adding error handling, not changing function signature
- No other components call this function
- No props changes
- No type changes

## Acceptance Criteria
- [ ] When `/api/skus` returns HTTP error (4xx, 5xx), user sees error message
- [ ] When `/api/skus` fails with network error, user sees error message
- [ ] Error message is user-friendly (not technical jargon)
- [ ] Error message suggests action ("Please try again")
- [ ] Loading spinner disappears when error occurs
- [ ] Dialog remains open to allow user to read error and try again
- [ ] No console errors (error is still logged, but user sees message)
- [ ] Existing functionality not affected (success case still works)
- [ ] TypeScript compilation succeeds
- [ ] Build succeeds with no errors
- [ ] (Optional) Retry button allows user to attempt fetch again

## Handoff to Plan Agent

**Summary**: Issue #32 is a DUPLICATE of Issue #28. Both describe the same bug: BuildDialog's `fetchSkus()` function has no error handling for failed API responses. When `/api/skus` endpoint fails (network error, server error, etc.), the function skips the success block but doesn't call `setError()`, leaving users staring at a disabled dropdown with no explanation. The fix is simple: add an else block to handle `!res.ok` cases and update the catch block to set user-facing errors. The component already has all the infrastructure (error state variable, error display UI) - we just need to wire it up in `fetchSkus()`.

**Key Points**:
1. **DUPLICATE**: Issue #32 is identical to Issue #28 - recommend closing #32 as duplicate
2. Single file affected: `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx`
3. Error state and UI already exist - just need to connect them
4. Simple fix: Add else block + update catch block to call `setError()`
5. Pattern already used in same file (handleSubmit function)
6. Low risk: Adding error handling, not changing core logic
7. Quick fix: Should take 15-30 minutes including testing
8. Broader issue: 9 components in codebase have similar pattern - consider audit after fix

**Issue Recommendations**:
1. Mark Issue #32 as duplicate of Issue #28
2. Fix Issue #28 (which will fix both)
3. Create follow-up enhancement issue: "Audit error handling in all dialog fetch operations" to address the 8 other files with similar patterns

**Suggested Phases**:
1. **Phase 1**: Add error handling to fetchSkus()
   - Add `setError(null)` at start of function
   - Add else block for `!res.ok` with user-facing error
   - Update catch block to call `setError()` instead of just logging
   - Follow pattern from handleSubmit() in same file
2. **Phase 2**: Manual testing
   - Test with blocked network request (DevTools)
   - Test with 500 error from API
   - Test with 404 error
   - Verify error message displays correctly
   - Verify success case still works
   - Test dialog close/reopen clears error
3. **Phase 3**: (Optional) Add retry button
   - Allow user to retry failed fetch without closing dialog
   - Improve UX for transient network errors
4. **Phase 4**: (Optional) Regression test
   - Add E2E test for error handling
   - Mock API failure in test
   - Verify error message appears

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Issue Parsing | 3m |
| Duplicate Detection | 5m |
| Codebase Exploration | 12m |
| Pattern Identification | 8m |
| Similar Issues Audit | 10m |
| Report Writing | 15m |
| **Total** | **53m** |

---

AGENT_RETURN: scout-32-120325
