# Implementation Plan

**Generated**: 2026-01-09
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: Issue #407
**Estimated Build Time**: 6-8 hours
**Complexity**: Medium (Tier 2)

## Investigation Summary

### Request Analysis
**Type**: Enhancement
**Source**: GitHub Issue #407 - Vendor dropdown for receipt transactions
**Priority**: Medium
**Prerequisite**: Issue #397 (Complete - Vendor model and management UI exist)

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED (affected modules)
**Suggested Filter**: `--filter="transaction|vendor|receipt"`

### Issue Validation
**Status**: Valid
**Recent Changes**:
- Vendor model added via migration `20260108200000_add_vendor_model`
- Vendor CRUD API exists at `/api/vendors`
- Vendor management page exists at `/settings/vendors`

### Current State Assessment

**Existing Components:**
- `Vendor` model: EXISTS in `prisma/schema.prisma` (lines 119-134)
- Vendor API: EXISTS at `src/app/api/vendors/route.ts`
- Vendor types: EXISTS at `src/types/vendor.ts`
- Transaction model: EXISTS but NO `vendorId` field
- `/api/suppliers` endpoint: EXISTS - returns distinct supplier strings from transactions (legacy)

**Missing:**
- `vendorId` foreign key on `Transaction` model
- Migration to add column
- Vendor dropdown UI in receipt forms
- Integration with natural language parser for vendor matching

**Database Migration Required:** YES

**API Routes Involved:**
- `POST /api/transactions/receipt` - needs vendorId support
- `GET /api/vendors` - already supports search
- `POST /api/transactions/parse` - natural language parsing (enhancement)

### Dependencies & Blockers
1. None - Vendor model already exists

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Medium
**Effort**: 6-8 hours
**Risk**: Low - additive changes, backward compatible

### Patterns Identified

**Primary Pattern**: Location dropdown in ReceiptDialog (lines 203-222)
```tsx
<Select
  value={formData.locationId}
  onValueChange={(value) => setFormData((prev) => ({ ...prev, locationId: value }))}
  disabled={isLoadingLocations}
>
  <SelectTrigger className="col-span-3">
    <SelectValue placeholder={isLoadingLocations ? 'Loading...' : 'Default location'} />
  </SelectTrigger>
  <SelectContent>
    {locations.map((loc) => (
      <SelectItem key={loc.id} value={loc.id}>
        {loc.name}
      </SelectItem>
    ))}
  </SelectContent>
</Select>
```

**Secondary Pattern**: EditablePreviewField with free text + suggestions
- `src/components/features/EditablePreviewField.tsx` - for autocomplete with fallback

**Note on Combobox**: No shadcn/ui Combobox component exists. Two approaches:
1. Simple: Use Select dropdown (matching Location pattern)
2. Enhanced: Input with datalist (already used in EditablePreviewField)

### Ripple Effect Analysis

**Files Identified**: 15+ files reference `.supplier`

**Files requiring modification:**

| File | Change Type | Reason |
|------|-------------|--------|
| `prisma/schema.prisma` | ADD | vendorId FK on Transaction, Vendor relation |
| `src/types/transaction.ts` | MODIFY | Add vendorId to receipt schema, TransactionResponse |
| `src/services/inventory.ts` | MODIFY | Accept vendorId in createReceiptTransaction |
| `src/app/api/transactions/receipt/route.ts` | MODIFY | Pass vendorId to service |
| `src/components/features/ReceiptDialog.tsx` | MODIFY | Add vendor dropdown |
| `src/components/features/QuickEntryForm.tsx` | MODIFY | Add vendor dropdown to receipt section |
| `src/app/(dashboard)/transactions/[id]/edit/page.tsx` | MODIFY | Add vendor dropdown for receipt edit |
| `src/app/(dashboard)/transactions/page.tsx` | INFO | Display vendor name (currently shows supplier) |
| `src/components/features/TransactionDetail.tsx` | MODIFY | Display vendor name with link |
| `src/lib/transaction-parser.ts` | MODIFY | Vendor matching in natural language parser |
| `src/types/parser.ts` | MODIFY | Add vendor context and matching types |

**IMPORTANT**: The `supplier` field (string) will be PRESERVED for backward compatibility. The new `vendorId` is OPTIONAL.

---

## Executive Summary

This enhancement adds a vendor dropdown to receipt transaction forms, allowing users to select from the Vendor model created in issue #397. The implementation:
1. Adds optional `vendorId` foreign key to Transaction model
2. Updates receipt forms with vendor dropdown (with search/autocomplete)
3. Preserves `supplier` free-text field as fallback for one-off suppliers
4. Enhances natural language parsing to suggest vendor matches

The `supplier` field remains for backward compatibility and as fallback when a vendor is not in the system.

---

## Phase 1: Database Layer

### Subtask 1.1: Add vendorId to Transaction model

**File**: `prisma/schema.prisma`
**Pattern**: Follow Location relation pattern (lines 344-345)

**Instructions**:
1. Add optional `vendorId` field and `vendor` relation to Transaction model:
```prisma
// In Transaction model, after supplier field (line 354):
vendorId   String?
vendor     Vendor?   @relation(fields: [vendorId], references: [id])
```
2. Add reverse relation to Vendor model:
```prisma
// In Vendor model (around line 132):
transactions Transaction[]
```
3. Add index on vendorId:
```prisma
@@index([vendorId])
```

**Validation**:
```bash
npx prisma validate
```

**Completion Criteria**:
- [ ] Schema validates without errors
- [ ] vendorId field is optional (String?)
- [ ] Relation to Vendor model defined
- [ ] Index on vendorId added

### Subtask 1.2: Create migration for vendorId

**File**: `prisma/migrations/[timestamp]_add_vendor_id_to_transaction/migration.sql`

**Instructions**:
1. Run migration:
```bash
DATABASE_URL="postgresql://inventory_test:inventory_test_2025@localhost:2346/inventory_test" npx prisma migrate dev --name add_vendor_id_to_transaction
```
2. Verify migration SQL created with:
   - ALTER TABLE to add vendorId column
   - Foreign key constraint to Vendor
   - Index creation

**Validation**:
```bash
DATABASE_URL="postgresql://inventory_test:inventory_test_2025@localhost:2346/inventory_test" npx prisma migrate status
```

**Completion Criteria**:
- [ ] Migration file created
- [ ] Migration applies successfully to test database
- [ ] Prisma client regenerated

---

## Phase 2: Types Layer

### Subtask 2.1: Update transaction types

**File**: `src/types/transaction.ts`

**Instructions**:
1. Add vendorId to createReceiptSchema (line ~10):
```typescript
vendorId: z.string().uuid('Invalid vendor ID').optional(),
```

2. Add vendorId and vendor to TransactionResponse interface (around line 163):
```typescript
vendorId: string | null
vendor?: { id: string; name: string } | null
```

**Pattern**: Follow locationId/location pattern in same interface

**Completion Criteria**:
- [ ] createReceiptSchema includes optional vendorId
- [ ] TransactionResponse includes vendorId and vendor fields
- [ ] Types compile: `npx tsc --noEmit`

---

## Phase 3: Service Layer

### Subtask 3.1: Update createReceiptTransaction service

**File**: `src/services/inventory.ts`

**Instructions**:
1. Add vendorId parameter to createReceiptTransaction params (line ~243):
```typescript
vendorId?: string
```
2. Add vendorId to destructuring (line ~256)
3. Add vendorId to transaction creation data (line ~357):
```typescript
vendorId: vendorId ?? null,
```
4. Include vendor in response include (around line 386):
```typescript
vendor: {
  select: { id: true, name: true },
},
```

**Pattern**: Follow locationId parameter handling

**Completion Criteria**:
- [ ] Service accepts vendorId parameter
- [ ] Transaction created with vendorId
- [ ] Vendor included in response

---

## Phase 4: API Layer

### Subtask 4.1: Update receipt API route

**File**: `src/app/api/transactions/receipt/route.ts`

**Instructions**:
1. Add vendorId validation (if provided, verify vendor exists and belongs to company) after location validation (~line 56):
```typescript
if (data.vendorId) {
  const vendor = await prisma.vendor.findFirst({
    where: {
      id: data.vendorId,
      companyId: selectedCompanyId,
      isActive: true,
    },
  })
  if (!vendor) {
    return notFound('Vendor')
  }
}
```
2. Pass vendorId to service (line ~64):
```typescript
vendorId: data.vendorId,
```
3. Include vendorId and vendor in response (line ~81):
```typescript
vendorId: transaction.vendorId,
vendor: transaction.vendor,
```

**Pattern**: Follow locationId validation pattern (lines 45-56)

**Completion Criteria**:
- [ ] API validates vendorId if provided
- [ ] Vendor existence checked against company
- [ ] vendorId passed to service
- [ ] Response includes vendor info

### Subtask 4.2: Update transactions list API

**File**: `src/app/api/transactions/route.ts`

**Instructions**:
1. Add vendor to select include in transaction list query (~line 87):
```typescript
vendor: {
  select: { id: true, name: true },
},
```
2. Include vendorId and vendor in response mapping (~line 116):
```typescript
vendorId: tx.vendorId,
vendor: tx.vendor,
```

**Completion Criteria**:
- [ ] List endpoint returns vendor info
- [ ] No N+1 query issues (vendor included in select)

### Subtask 4.3: Update transaction detail API

**File**: `src/app/api/transactions/[id]/route.ts`

**Instructions**:
1. Add vendor to include in findFirst query (~line 64):
```typescript
vendor: {
  select: { id: true, name: true },
},
```
2. Add to response (~line 154):
```typescript
vendorId: transaction.vendorId,
vendor: transaction.vendor,
```

**Completion Criteria**:
- [ ] Detail endpoint returns vendor info

---

## Phase 5: Frontend - Receipt Forms

### Subtask 5.1: Add vendor dropdown to ReceiptDialog

**File**: `src/components/features/ReceiptDialog.tsx`

**Instructions**:
1. Add vendors state and loading state (after locations state, ~line 46):
```typescript
const [vendors, setVendors] = useState<Array<{ id: string; name: string }>>([])
const [isLoadingVendors, setIsLoadingVendors] = useState(false)
```

2. Add vendorId to formData initial state (~line 51):
```typescript
vendorId: '',
```

3. Add fetchVendors function (after fetchLocations, ~line 88):
```typescript
const fetchVendors = async () => {
  setIsLoadingVendors(true)
  try {
    const res = await fetch('/api/vendors?isActive=true&pageSize=100')
    if (res.ok) {
      const data = await res.json()
      setVendors(data.data || [])
    }
  } catch (err) {
    console.error('Failed to fetch vendors:', err)
  } finally {
    setIsLoadingVendors(false)
  }
}
```

4. Call fetchVendors in useEffect (~line 62):
```typescript
fetchVendors()
```

5. Add vendor dropdown UI after supplier input (lines 189-199). Replace the supplier Input with a Select + Input combo:
```tsx
<div className="grid grid-cols-4 items-center gap-4">
  <Label htmlFor="vendor" className="text-right">
    Vendor
  </Label>
  <Select
    value={formData.vendorId}
    onValueChange={(value) => {
      setFormData((prev) => ({
        ...prev,
        vendorId: value,
        supplier: vendors.find(v => v.id === value)?.name || prev.supplier,
      }))
    }}
    disabled={isLoadingVendors}
  >
    <SelectTrigger className="col-span-3">
      <SelectValue placeholder={isLoadingVendors ? 'Loading...' : 'Select vendor (optional)'} />
    </SelectTrigger>
    <SelectContent>
      {vendors.map((v) => (
        <SelectItem key={v.id} value={v.id}>
          {v.name}
        </SelectItem>
      ))}
    </SelectContent>
  </Select>
</div>

<div className="grid grid-cols-4 items-center gap-4">
  <Label htmlFor="supplier" className="text-right">
    Supplier *
  </Label>
  <Input
    id="supplier"
    className="col-span-3"
    placeholder="e.g., XYZ Corp (or select vendor above)"
    value={formData.supplier}
    onChange={(e) => setFormData((prev) => ({ ...prev, supplier: e.target.value }))}
    required
  />
</div>
```

6. Update handleSubmit to include vendorId (~line 106):
```typescript
vendorId: formData.vendorId || undefined,
```

7. Reset vendorId in form reset (~line 125):
```typescript
vendorId: '',
```

**Pattern**: Follow Location dropdown pattern

**Completion Criteria**:
- [ ] Vendor dropdown visible in receipt dialog
- [ ] Selecting vendor auto-fills supplier field
- [ ] Supplier field remains editable as fallback
- [ ] vendorId sent to API on submit

### Subtask 5.2: Add vendor dropdown to QuickEntryForm

**File**: `src/components/features/QuickEntryForm.tsx`

**Instructions**:
1. Add vendors state and fetch function (similar to ReceiptDialog)
2. Add vendorId to inboundFormData (~line 108)
3. Add vendor dropdown before supplier input (around line 645)
4. When vendor selected, auto-fill supplier field
5. Include vendorId in API request (~line 328)

**Pattern**: Match ReceiptDialog implementation

**Completion Criteria**:
- [ ] Vendor dropdown in quick entry receipt form
- [ ] Auto-fill supplier on vendor selection
- [ ] vendorId included in API request

### Subtask 5.3: Add vendor dropdown to transaction edit page

**File**: `src/app/(dashboard)/transactions/[id]/edit/page.tsx`

**Instructions**:
1. Add vendors state and fetch function
2. Add vendorId to formData initialization (~line 139)
3. Add vendor dropdown in receipt-specific fields section (~line 453)
4. Include vendorId in save request

**Note**: Only show vendor dropdown for receipt transactions

**Completion Criteria**:
- [ ] Vendor dropdown on receipt edit page
- [ ] Pre-selects current vendor if set
- [ ] vendorId saved on update

---

## Phase 6: Display Updates

### Subtask 6.1: Update TransactionDetail to display vendor

**File**: `src/components/features/TransactionDetail.tsx`

**Instructions**:
1. Add vendor to TransactionDetailProps type (~line 73):
```typescript
vendorId?: string | null
vendor?: { id: string; name: string } | null
```

2. Display vendor name with link to vendor detail (around line 276, after supplier display):
```tsx
{transaction.vendor && (
  <>
    <h3 className="font-medium text-sm text-muted-foreground">Vendor</h3>
    <p className="font-medium">
      <Link
        href={`/settings/vendors/${transaction.vendor.id}/edit`}
        className="text-primary hover:underline"
      >
        {transaction.vendor.name}
      </Link>
    </p>
  </>
)}
```

**Completion Criteria**:
- [ ] Vendor name displayed for receipt transactions
- [ ] Link to vendor edit page
- [ ] Graceful handling when no vendor set

### Subtask 6.2: Update transactions list display

**File**: `src/app/(dashboard)/transactions/page.tsx`

**Instructions**:
1. Update formatTransactionSummary to prefer vendor name (~line 173):
```typescript
case 'receipt':
  const vendorName = tx.vendor?.name
  const supplierName = tx.supplier
  return `Received from ${vendorName || supplierName || 'Unknown'}`
```

**Completion Criteria**:
- [ ] List shows vendor name when available
- [ ] Falls back to supplier string
- [ ] No visual regression

---

## Phase 7: Natural Language Parser Enhancement (Optional/Lower Priority)

### Subtask 7.1: Add vendor matching to parser context

**File**: `src/types/parser.ts`

**Instructions**:
1. Add vendors to ParserContext interface:
```typescript
vendors: Array<{ id: string; name: string }>
```

**File**: `src/lib/transaction-parser.ts`

**Instructions**:
1. Add fuzzy matching for vendors similar to components/SKUs
2. Return matched vendorId in ParsedTransaction for receipt types
3. Update prompt to extract supplier for vendor matching

**Note**: This is an enhancement - can be deferred if time constrained.

**Completion Criteria**:
- [ ] Parser context includes vendors
- [ ] Fuzzy matching for vendor names
- [ ] Parsed result includes matched vendorId suggestion

---

## Validation & Testing

### Build Verification

```bash
npm run build
npx tsc --noEmit
npm run lint
```

### Manual Testing Checklist

- [ ] Create receipt with vendor dropdown selection
- [ ] Create receipt with free-text supplier (no vendor)
- [ ] Edit existing receipt to add vendor
- [ ] View transaction detail shows vendor with link
- [ ] Transaction list shows vendor/supplier correctly
- [ ] Quick entry form works with vendor dropdown
- [ ] Natural language "received from [vendor]" matches existing vendor

---

## Summary of Deliverables

**Files Created**: 1
- Migration file for vendorId column

**Files Modified**: 12
- `prisma/schema.prisma`
- `src/types/transaction.ts`
- `src/services/inventory.ts`
- `src/app/api/transactions/receipt/route.ts`
- `src/app/api/transactions/route.ts`
- `src/app/api/transactions/[id]/route.ts`
- `src/components/features/ReceiptDialog.tsx`
- `src/components/features/QuickEntryForm.tsx`
- `src/app/(dashboard)/transactions/[id]/edit/page.tsx`
- `src/components/features/TransactionDetail.tsx`
- `src/app/(dashboard)/transactions/page.tsx`
- (Optional) `src/lib/transaction-parser.ts`

---

## Test Strategy Note

- Use Vitest for unit tests if needed
- Manual testing recommended for UI changes
- E2E testing against test environment (port 2345)

---

## Performance Metrics

| Phase | Estimated Duration |
|-------|-------------------|
| Investigation | 25m |
| Validation | 10m |
| Planning | 30m |
| **Total Scout-Plan** | **65m** |

---

## Risk Notes

1. **Backward Compatibility**: The `supplier` field is preserved. Existing transactions with only `supplier` will continue to work. This is by design.

2. **Migration Safety**: The migration only ADDs a nullable column - no data loss risk.

3. **UI Complexity**: The vendor dropdown is OPTIONAL - supplier free-text remains as fallback for one-off suppliers not in the system.
