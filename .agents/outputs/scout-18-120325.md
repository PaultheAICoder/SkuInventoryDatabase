# Scout Report: Dashboard Time Filter and Component On-Hand Trend Sparkline

## Request Analysis
**Type**: Enhancement
**Source**: GitHub Issue #18
**Priority**: Medium

## Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="dashboard|components|analytics"` for affected modules

## Issue Validation
**Status**: Valid and ready for implementation
**Recent Changes**: Dashboard last modified for issue #33 (hydration warning fixes). No conflicts detected.
**Dependencies Confirmed**:
- Transaction history exists and is indexed
- recharts library already installed (v3.5.1)
- Existing chart patterns in DefectTrendChart.tsx

## Current State

### Dashboard Implementation
- **Main Dashboard**: `/home/pbrown/SkuInventory/src/app/(dashboard)/page.tsx`
  - Client component fetching from `/api/dashboard`
  - Shows recent transactions (last 10, hardcoded)
  - Displays component stats, critical components, top buildable SKUs
  - No time filtering currently implemented

- **Dashboard API**: `/home/pbrown/SkuInventory/src/app/api/dashboard/route.ts`
  - Returns recent transactions with `take: 10` hardcoded
  - No date-based filtering parameters
  - Uses Prisma transaction queries

- **Dashboard Features**:
  - DashboardStats component (stat cards)
  - CriticalComponentsList
  - TopBuildableSkusList
  - Recent Transactions table (inline in page.tsx)

### Component Detail Implementation
- **Component Detail Page**: `/home/pbrown/SkuInventory/src/app/(dashboard)/components/[id]/page.tsx`
  - Shows component inventory, costing, and details cards
  - Displays recent transactions (last 10)
  - No sparkline or trend visualization currently

- **Component API**: `/home/pbrown/SkuInventory/src/app/api/components/[id]/route.ts`
  - Returns recent transactions via `transactionLines` relation
  - Uses `orderBy: { transaction: { createdAt: 'desc' } }` with `take: 10`
  - No date range filtering

### Transaction History
- **Database Schema**: Transactions table with:
  - `date` field (DateTime @db.Date) - transaction date
  - `createdAt` field (DateTime) - audit timestamp
  - Indexed on `[companyId, createdAt(sort: Desc)]`
  - TransactionLine with `quantityChange` field

- **Services**: `/home/pbrown/SkuInventory/src/services/inventory.ts`
  - `getComponentQuantity(componentId)` - sums all transaction lines
  - `getComponentQuantities(componentIds[])` - batch version
  - Can derive on-hand at any point in time by filtering transactions

### Existing Chart Infrastructure
- **recharts Library**: v3.5.1 installed
- **Pattern Reference**: `/home/pbrown/SkuInventory/src/components/features/DefectTrendChart.tsx`
  - Uses LineChart, XAxis, YAxis, CartesianGrid, Tooltip, Legend
  - ResponsiveContainer for responsive sizing
  - Custom tooltips with styled content
  - Date formatting utilities

- **Another Pattern**: `/home/pbrown/SkuInventory/src/components/features/DefectBOMComparisonChart.tsx`
  - Bar chart implementation
  - Similar responsive patterns

### Existing Time Filter Patterns
- **Analytics Dashboard**: `/home/pbrown/SkuInventory/src/components/features/DefectAnalyticsDashboard.tsx`
  - Implements date filters with `dateFrom` and `dateTo` inputs
  - Filter panel component pattern
  - Apply/Clear filter buttons
  - URL parameter-based filtering

- **Analytics Service**: `/home/pbrown/SkuInventory/src/services/analytics.ts`
  - Shows date range filtering pattern:
    ```typescript
    const where: Prisma.TransactionWhereInput = {
      ...(dateFrom || dateTo
        ? {
            date: {
              ...(dateFrom && { gte: dateFrom }),
              ...(dateTo && { lte: dateTo }),
            },
          }
        : {}),
    }
    ```

- **UI Components Available**:
  - Select component (`/home/pbrown/SkuInventory/src/components/ui/select.tsx`)
  - Card components for layout
  - Button components

## Dependencies & Blockers

**All dependencies satisfied:**
1. recharts library - INSTALLED (v3.5.1)
2. Transaction history - EXISTS with proper indexing
3. Component detail endpoint - EXISTS
4. Dashboard endpoint - EXISTS
5. Select UI component - EXISTS
6. Chart patterns - EXISTS (DefectTrendChart, DefectBOMComparisonChart)

**Can Proceed?**: YES

No blockers identified. All required infrastructure is in place.

## Complexity Assessment
**Complexity**: Moderate
**Effort**: 6-8 hours
**Risk**: Low

**Breakdown**:
- Dashboard time filter UI: 1-2 hours
- Dashboard API date filtering: 1 hour
- Sparkline calculation logic: 2-3 hours (need to compute on-hand over time)
- Sparkline component creation: 1-2 hours
- Testing and refinement: 1 hour

**Risk Factors**:
- Calculating historical on-hand requires aggregating transactions up to each date point
- Performance consideration for large transaction histories
- May need to optimize query strategy

## Patterns to Follow

### Primary Patterns

1. **Time Filter UI Pattern**: `/home/pbrown/SkuInventory/src/components/features/DefectAnalyticsFilters.tsx`
   - Date range inputs with dateFrom/dateTo
   - Select dropdown for preset periods (adapt to 7/30/90 days)
   - Filter state management

2. **Chart Component Pattern**: `/home/pbrown/SkuInventory/src/components/features/DefectTrendChart.tsx`
   - ResponsiveContainer wrapper
   - LineChart with minimal config for sparkline
   - Custom date formatting
   - Loading/empty states

3. **API Date Filtering**: `/home/pbrown/SkuInventory/src/services/analytics.ts` lines 20-38
   - Prisma where clause construction
   - Date range handling
   - Optional filter parameters

### Secondary Patterns

1. **Select Component Usage**: `/home/pbrown/SkuInventory/src/components/features/SKUTable.tsx`
   - Filter dropdown implementation
   - State management with filter updates

2. **Card Layout**: `/home/pbrown/SkuInventory/src/app/(dashboard)/components/[id]/page.tsx`
   - Grid layout for component details
   - Card components for sections

## Files to Create/Modify

### Files to Create

1. **`/home/pbrown/SkuInventory/src/components/features/ComponentSparkline.tsx`**
   - Purpose: Reusable sparkline chart component for on-hand trends
   - Pattern: Based on DefectTrendChart.tsx but simplified for sparkline
   - Props: `data: Array<{date: string, quantity: number}>`, `height?: number`

2. **`/home/pbrown/SkuInventory/src/components/features/DashboardTimeFilter.tsx`**
   - Purpose: Time filter dropdown for dashboard (7/30/90 days, All)
   - Pattern: Similar to filter controls in DefectAnalyticsFilters.tsx
   - Props: `value: number | null`, `onChange: (days: number | null) => void`

### Files to Modify

1. **`/home/pbrown/SkuInventory/src/app/(dashboard)/page.tsx`**
   - Add DashboardTimeFilter component to header
   - Add state for selected time filter (days)
   - Update fetch URL to include `days` query parameter
   - Pass filter value to dashboard API

2. **`/home/pbrown/SkuInventory/src/app/api/dashboard/route.ts`**
   - Add `days` query parameter handling
   - Filter recent transactions by date range: `where: { date: { gte: startDate } }`
   - Calculate startDate based on days parameter

3. **`/home/pbrown/SkuInventory/src/app/(dashboard)/components/[id]/page.tsx`**
   - Add ComponentSparkline to inventory card
   - Add time window selector (7/30/90 days) above sparkline
   - Fetch trend data from new API endpoint
   - State management for selected time window

4. **`/home/pbrown/SkuInventory/src/app/api/components/[id]/route.ts`**
   - Add new query parameter: `trendDays` (optional)
   - Add trend data calculation logic to response
   - Return array of `{date, quantityOnHand}` points

5. **`/home/pbrown/SkuInventory/src/types/component.ts`**
   - Extend `ComponentDetailResponse` to include optional `trend` field
   - Add type: `trend?: Array<{ date: string; quantityOnHand: number }>`

### Supporting Files to Reference

1. **`/home/pbrown/SkuInventory/src/services/inventory.ts`**
   - Use `getComponentQuantity` as reference
   - May need new function: `getComponentQuantityHistory(componentId, dateFrom, dateTo, interval)`

## Final Sweep Results

**Services Search**: No new service files needed, will extend existing inventory.ts if needed

**API Routes Affected**:
- `/home/pbrown/SkuInventory/src/app/api/dashboard/route.ts` (add time filter)
- `/home/pbrown/SkuInventory/src/app/api/components/[id]/route.ts` (add trend data)

**Type Definitions**:
- `/home/pbrown/SkuInventory/src/types/component.ts` (extend ComponentDetailResponse)

**Components Affected**:
- `/home/pbrown/SkuInventory/src/app/(dashboard)/page.tsx` (add filter UI)
- `/home/pbrown/SkuInventory/src/app/(dashboard)/components/[id]/page.tsx` (add sparkline)

**New Components**:
- `/home/pbrown/SkuInventory/src/components/features/ComponentSparkline.tsx`
- `/home/pbrown/SkuInventory/src/components/features/DashboardTimeFilter.tsx`

**Test Files**: Will need to add/update:
- Dashboard API tests for date filtering
- Component API tests for trend data
- Component tests for new UI components

**All Affected Files** (comprehensive list):
- `/home/pbrown/SkuInventory/src/app/(dashboard)/page.tsx` - Add time filter UI
- `/home/pbrown/SkuInventory/src/app/api/dashboard/route.ts` - Add date filtering logic
- `/home/pbrown/SkuInventory/src/app/(dashboard)/components/[id]/page.tsx` - Add sparkline display
- `/home/pbrown/SkuInventory/src/app/api/components/[id]/route.ts` - Add trend data endpoint
- `/home/pbrown/SkuInventory/src/types/component.ts` - Add trend types
- `/home/pbrown/SkuInventory/src/components/features/ComponentSparkline.tsx` - NEW
- `/home/pbrown/SkuInventory/src/components/features/DashboardTimeFilter.tsx` - NEW

## Ripple Effect Analysis

### Function: Transaction Filtering Pattern
**Scope**: New pattern, no existing callers to update
**Impact**: Self-contained addition

### Type: ComponentDetailResponse Extension
**Direct Callers**: 1 file
- `/home/pbrown/SkuInventory/src/app/(dashboard)/components/[id]/page.tsx`

**Impact**: Low - optional field, backward compatible

### Dashboard API Response
**Direct Callers**: 1 file
- `/home/pbrown/SkuInventory/src/app/(dashboard)/page.tsx`

**Impact**: Low - existing structure unchanged, just filtering applied

**TOTAL COMPLEXITY**: Low ripple effect, changes are additive

## Acceptance Criteria

From Issue #18:

- [ ] **Dashboard time filter**: Users can select a dashboard time window (7/30/90 days, All) and see recent transactions filtered accordingly
- [ ] **Component sparkline**: Component detail shows a sparkline of on-hand quantity over time, with selectable time window
- [ ] **Transaction-based trends**: Trend uses transaction history to accurately plot on-hand over time
- [ ] **Tests**: Tests cover trend generation logic and time-filtered dashboard data
- [ ] **Performance**: Trend queries stay fast for typical transaction counts (no N+1 queries)

## Implementation Approach

### Phase 1: Dashboard Time Filter (2-3 hours)
1. Create `DashboardTimeFilter` component with preset options (7/30/90 days, All)
2. Add filter to dashboard page header
3. Update dashboard API to accept `days` parameter
4. Filter transactions by date range in API
5. Test dashboard filtering works correctly

### Phase 2: Sparkline Component (3-4 hours)
1. Create `ComponentSparkline` component using recharts
2. Implement minimal sparkline style (no axes, compact)
3. Add loading/empty states
4. Test with mock data

### Phase 3: Trend Data Calculation (2-3 hours)
1. Add trend calculation logic to component API
   - Query transactions for component within date range
   - Calculate cumulative on-hand at each date point
   - Sample or aggregate if too many points (>30)
2. Add optional `trendDays` parameter to component detail API
3. Extend ComponentDetailResponse type
4. Return trend data in API response

### Phase 4: Integration (1 hour)
1. Add sparkline to component detail inventory card
2. Add time window selector above sparkline
3. Fetch and display trend data
4. Handle loading/error states

### Phase 5: Testing (1 hour)
1. Test dashboard filtering with different time ranges
2. Test sparkline rendering with various data patterns
3. Test trend calculation accuracy
4. Test performance with larger datasets
5. Add unit tests for trend calculation
6. Add integration tests for filtered endpoints

## UI Visibility Requirements

**Dashboard Time Filter**:
- **Element**: Time filter dropdown/buttons
- **Location**: Dashboard page header, above stats cards
- **Visibility**: ALL devices (responsive design)
- **CSS classes to avoid**: Do NOT hide on any screen size
- **Implementation**: Use responsive grid, stack vertically on mobile if needed

**Component Sparkline**:
- **Element**: Sparkline chart in component detail
- **Location**: Within Inventory card on component detail page
- **Visibility**: ALL devices (chart should scale down on mobile)
- **CSS classes to avoid**: Do NOT use `lg:hidden` or similar
- **Implementation**: Use ResponsiveContainer from recharts for automatic scaling

## Handoff to Plan Agent

### Summary
Issue #18 requests adding dashboard time filtering (7/30/90 days) and component on-hand trend sparklines. The codebase already has all required infrastructure: recharts library, transaction history with proper indexing, existing chart patterns, and filter UI patterns. Implementation involves creating two new components (DashboardTimeFilter and ComponentSparkline), modifying dashboard and component detail pages/APIs to support time filtering and trend data, and extending types. The primary technical challenge is efficiently calculating historical on-hand quantities from transaction history without N+1 queries.

### Key Points
1. All dependencies satisfied - recharts installed, transaction data available, patterns exist
2. Follow DefectTrendChart.tsx pattern for sparkline implementation
3. Follow analytics date filtering pattern for dashboard time filter
4. Trend calculation requires cumulative aggregation of transactions
5. Keep sparklines simple - minimal axes, compact design
6. Add query parameter filtering to existing APIs (backward compatible)
7. Moderate complexity with 6-8 hour estimated effort
8. Low risk - additive changes, no breaking modifications

### Suggested Implementation Phases
1. **Phase 1**: Dashboard time filter UI and API
2. **Phase 2**: Sparkline component creation
3. **Phase 3**: Trend calculation logic in component API
4. **Phase 4**: Integration into component detail page
5. **Phase 5**: Testing and performance validation

### Technical Considerations
- **Performance**: For large transaction histories, consider:
  - Limiting trend data points to ~30 max (sample/aggregate as needed)
  - Using database-level aggregation where possible
  - Caching trend data if performance becomes an issue
- **Accuracy**: Ensure cumulative calculation correctly handles all transaction types (receipt, build, adjustment, initial)
- **Time zones**: Use date field (Date type) consistently, avoid timezone issues
- **Responsive design**: Sparklines must be visible on ALL devices

## Performance Metrics

| Phase | Duration |
|-------|----------|
| Issue Parsing | 2m |
| Codebase Exploration | 12m |
| Pattern Identification | 8m |
| Dependency Verification | 5m |
| Final Sweep | 6m |
| Report Writing | 15m |
| **Total** | **48m** |

---

**Report generated**: 2025-12-03
**Scout Agent**: Ready for Plan Agent handoff
**Status**: COMPLETE - All investigation tasks finished, no blockers identified
