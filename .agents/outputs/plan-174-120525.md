# Implementation Plan
**Generated**: 2025-12-05T02:15:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #174
**Estimated Build Time**: 1-2 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Bug Fix
**Source**: GitHub Issue #174
**Priority**: High - Core feature broken

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="inventory-snapshot"` or `--testPathPattern="import"`

### Issue Validation
**Status**: Valid
**Recent Changes**:
- `c68f26c` fix(issue #153): align inventory-snapshot import with brand selection pattern
- `3645335` feat(issue #17): add inventory snapshot import from Excel (XLSX) files

The bug was introduced when the inventory-snapshot import feature was added (issue #17). The `companyId` field was not included in the component creation, though it was properly used for the transaction creation (line 192).

### Current State Assessment
- **Affected file**: `src/app/api/import/inventory-snapshot/route.ts` (lines 140-152)
- **Root cause confirmed**: Component creation at line 140-152 does NOT set `companyId`
- **Comparison with correct pattern**: `src/app/api/components/route.ts` (line 209) correctly sets `companyId: selectedCompanyId`
- **Comparison with correct pattern**: `src/app/api/import/components/route.ts` (line 275) correctly sets `companyId`

### Prisma Schema Verification
The `Component` model in `prisma/schema.prisma` shows:
```prisma
model Component {
  id            String   @id @default(uuid())
  brandId       String
  brand         Brand    @relation(fields: [brandId], references: [id])
  companyId     String?   // <-- Optional, defaults to null
  company       Company? @relation("CompanyComponents", fields: [companyId], references: [id])
  ...
}
```

The `companyId` is nullable (`String?`), which is why components created without it don't cause database errors but are invisible in the components list (which filters by `companyId`).

### Dependencies & Blockers
None identified. The fix is straightforward.

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Simple
**Effort**: 1-2 hours
**Risk**: Low - Single file change, well-understood pattern, data remediation SQL provided

### Patterns Identified
**Primary**: `/home/pbrown/SkuInventory/src/app/api/components/route.ts:206-221` - Correct component creation with `companyId`
**Secondary**: `/home/pbrown/SkuInventory/src/app/api/import/components/route.ts:272-284` - Correct import pattern with `companyId`

### Ripple Effect Analysis
**Files Identified**: 1

The fix is isolated to a single file. No ripple effects expected since:
1. The `companyId` variable is already defined at line 53: `const companyId = selectedCompanyId`
2. It is already used for transaction creation at line 192
3. Just needs to be added to component creation at lines 140-152

---

## Executive Summary

This is a bug fix for GitHub Issue #174 where components imported via the inventory-snapshot XLSX import are created without the `companyId` field, causing them to be invisible in the components list (which filters by `companyId`). The fix requires adding `companyId` to the component creation call in `src/app/api/import/inventory-snapshot/route.ts`, plus a data remediation SQL script for any existing orphaned components, and a regression test.

---

## Phase 1: Code Fix

### Subtask 1.1: Add companyId to component creation in inventory-snapshot import
**File**: `/home/pbrown/SkuInventory/src/app/api/import/inventory-snapshot/route.ts`
**Lines**: 140-152
**Pattern**: Follow `src/app/api/components/route.ts:206-221`

**Current Code** (lines 140-152):
```typescript
component = await prisma.component.create({
  data: {
    brandId,
    name: row.itemName,
    skuCode: generatedSkuCode,
    unitOfMeasure: 'each',
    costPerUnit: new Prisma.Decimal(0),
    reorderPoint: 0,
    leadTimeDays: settings.defaultLeadTimeDays || 0,
    createdById: session.user.id,
    updatedById: session.user.id,
  },
})
```

**Fix**: Add `companyId,` after `brandId,` (line 142):
```typescript
component = await prisma.component.create({
  data: {
    brandId,
    companyId,  // <-- ADD THIS LINE
    name: row.itemName,
    skuCode: generatedSkuCode,
    unitOfMeasure: 'each',
    costPerUnit: new Prisma.Decimal(0),
    reorderPoint: 0,
    leadTimeDays: settings.defaultLeadTimeDays || 0,
    createdById: session.user.id,
    updatedById: session.user.id,
  },
})
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
npm run lint
```

**Completion Criteria**:
- [ ] `companyId` is added to component creation data object
- [ ] TypeScript compiles without errors
- [ ] Build succeeds
- [ ] Lint passes

---

## Phase 2: Data Remediation

### Subtask 2.1: Create data remediation SQL script
**File**: `/home/pbrown/SkuInventory/scripts/fix-orphaned-components.sql` (NEW FILE)

**Instructions**:
Create a SQL script that fixes existing components with null `companyId` by inheriting the `companyId` from their associated brand:

```sql
-- Fix orphaned components created by inventory-snapshot import
-- Issue #174: Components imported via XLSX don't appear in components list
--
-- This script updates components that have null companyId by inheriting
-- the companyId from their associated brand.

-- Preview: Show affected components
SELECT
  c.id,
  c.name,
  c."skuCode",
  c."brandId",
  b.name as brand_name,
  b."companyId" as brand_company_id,
  c."companyId" as component_company_id
FROM "Component" c
JOIN "Brand" b ON c."brandId" = b.id
WHERE c."companyId" IS NULL;

-- Fix: Update companyId from brand
UPDATE "Component" c
SET "companyId" = b."companyId"
FROM "Brand" b
WHERE c."brandId" = b.id
  AND c."companyId" IS NULL;

-- Verify: Confirm no orphaned components remain
SELECT COUNT(*) as orphaned_count
FROM "Component"
WHERE "companyId" IS NULL;
```

**Validation Commands**:
```bash
# Verify syntax is valid (dry run in test environment)
# This will be run manually against the database
cat /home/pbrown/SkuInventory/scripts/fix-orphaned-components.sql
```

**Completion Criteria**:
- [ ] SQL script created with preview, fix, and verification queries
- [ ] Script is documented with issue reference
- [ ] Script can be run idempotently (running twice causes no harm)

---

## Phase 3: Integration Test

### Subtask 3.1: Add integration test for inventory-snapshot import with companyId verification
**File**: `/home/pbrown/SkuInventory/tests/integration/import-export.test.ts`
**Pattern**: Follow existing import tests in the file (lines 1-100)

**Instructions**:
Add a new test case in the `Import/Export API` describe block that:
1. Imports the inventory-snapshot route handler
2. Creates a test XLSX file with a new component
3. Verifies the created component has the correct `companyId`

Add the following import at the top of the file (after line 23):
```typescript
import { POST as importInventorySnapshot } from '@/app/api/import/inventory-snapshot/route'
```

Add a new describe block for inventory-snapshot tests:
```typescript
describe('POST /api/import/inventory-snapshot', () => {
  it('creates components with correct companyId', async () => {
    setTestSession(TEST_SESSIONS.admin!)
    const prisma = getIntegrationPrisma()

    // Create a minimal XLSX buffer with test data
    // Note: This test uses xlsx library to create a valid XLSX file
    const XLSX = await import('xlsx')
    const workbook = XLSX.utils.book_new()
    const worksheet = XLSX.utils.aoa_to_sheet([
      ['Item Name', 'Current Balance'],
      ['Test Import Component', 100],
    ])
    XLSX.utils.book_append_sheet(workbook, worksheet, 'Sheet1')
    const xlsxBuffer = XLSX.write(workbook, { type: 'buffer', bookType: 'xlsx' })

    // Create FormData with the file
    const formData = new FormData()
    const file = new File([xlsxBuffer], 'test-snapshot.xlsx', {
      type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
    })
    formData.append('file', file)

    // Create request with FormData
    const url = new URL('/api/import/inventory-snapshot', 'http://localhost:4500')
    const request = new NextRequest(url, {
      method: 'POST',
      body: formData,
    })

    const response = await importInventorySnapshot(request)
    expect(response.status).toBe(200)

    const json = await response.json()
    expect(json.data.componentsCreated).toBeGreaterThan(0)

    // Verify the created component has the correct companyId
    const createdComponent = await prisma.component.findFirst({
      where: {
        name: 'Test Import Component',
      },
    })

    expect(createdComponent).not.toBeNull()
    expect(createdComponent!.companyId).toBe(TEST_SESSIONS.admin!.user.companyId)
  })
})
```

**Validation Commands**:
```bash
npm test -- --testPathPattern="import-export" --run
```

**Completion Criteria**:
- [ ] Test imports the inventory-snapshot route handler
- [ ] Test creates a valid XLSX file
- [ ] Test verifies `companyId` is set on created component
- [ ] Test passes

---

## Summary of Deliverables

**Files Modified**: 2
1. `/home/pbrown/SkuInventory/src/app/api/import/inventory-snapshot/route.ts` - Add `companyId` to component creation

**Files Created**: 2
1. `/home/pbrown/SkuInventory/scripts/fix-orphaned-components.sql` - Data remediation SQL script
2. Test case added to `/home/pbrown/SkuInventory/tests/integration/import-export.test.ts`

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 -> Phase 2 -> Phase 3)
2. Subtask 1.1 is the critical fix - add single line `companyId,`
3. Subtask 2.1 creates a SQL script for data remediation (manual execution)
4. Subtask 3.1 adds regression test to prevent future occurrences
5. After all subtasks complete, run full validation:
   ```bash
   npx tsc --noEmit && npm run build && npm run lint && npm test -- --run
   ```

---

## Test Strategy Note

- **Unit/Integration Tests**: Use Vitest (`npm test`)
- **E2E Tests**: Playwright is configured but not required for this fix
- **Test Filter**: `--testPathPattern="import-export"` for targeted testing

---

## Data Remediation Note

The SQL script in Phase 2 should be run manually against the production database AFTER deploying the code fix. The script:
1. First shows a preview of affected components
2. Then updates them with the correct `companyId` from their brand
3. Finally verifies no orphaned components remain

Run order:
1. Deploy code fix (Phase 1)
2. Run data remediation SQL (Phase 2 output)
3. Verify components now appear in the list

---

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 8m |
| Validation | 2m |
| Planning | 5m |
| **Total** | **15m** |
