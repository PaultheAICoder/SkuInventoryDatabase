# Implementation Plan
**Generated**: 2025-12-17T17:00:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: Issue #305
**Estimated Build Time**: 4-6 hours
**Complexity**: Low-Medium

## Investigation Summary

### Request Analysis
**Type**: Enhancement
**Source**: GitHub Issue #305
**Priority**: Medium

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="SKUForm|ComponentForm|api-response"`

### Issue Validation
**Status**: Valid
**Recent Changes**: No recent commits affecting SKUForm or api-response.ts

### Current State Assessment
- **Existing components**:
  - `src/lib/api-response.ts` - Has `error()` helper with `details` parameter for field-level errors
  - `src/lib/api-response.ts` - Has `validationError()` that converts Zod errors to field-level details
  - `src/components/ui/sonner.tsx` - Toaster configured with `richColors` in layout
  - `src/components/features/SKUForm.tsx` - Uses generic error display (line 164-168)
  - `src/components/features/ComponentForm.tsx` - Same generic error pattern
- **Database**: No changes needed
- **API Routes**:
  - `src/app/api/skus/route.ts` - Already returns specific error messages for some cases
  - `src/app/api/components/route.ts` - Returns `conflict()` for duplicates
- **Types**: `src/types/index.ts` has `ApiError` interface with `details?: Array<{ field: string; message: string }>`

### Dependencies & Blockers
1. None - sonner toast library already installed and configured
2. API response helpers already support field-level error details

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Low-Medium
**Effort**: 4-6 hours
**Risk**: Low - primarily UI changes with minimal backend work

### Patterns Identified
**Primary**: `src/components/features/ImportForm.tsx:129-186` - Shows error handling with toast
**Secondary**: `src/lib/api-response.ts:64-78` - validationError function with details array

### Ripple Effect Analysis
**Files Identified**: 4-5 core files
- `src/components/features/SKUForm.tsx` - Add field-level error display and toast
- `src/components/features/ComponentForm.tsx` - Add field-level error display and toast
- `src/app/api/skus/route.ts` - Ensure consistent error response format
- `src/app/api/components/route.ts` - Ensure consistent error response format
- (Optional) `src/lib/api-response.ts` - Add helper if needed

---

## Executive Summary
This enhancement improves API error feedback by:
1. Displaying specific error messages from the API in forms (not just generic "Failed to save")
2. Adding field-level error indicators for validation errors
3. Using toast notifications for immediate feedback while preserving form state
4. Ensuring API routes return structured error responses with field information

The infrastructure for field-level errors already exists in `api-response.ts` (`details` array in `ApiError`), but frontend forms don't currently utilize it.

## Phase 1: Create Error Handling Utility

### Subtask 1.1: Create API Error Helper Hook
**File**: `src/lib/api-errors.ts` (new file)
**Pattern**: Follow existing lib utilities pattern
**Instructions**:
1. Create a new utility file for standardized API error handling
2. Define types for structured error responses
3. Create helper function to parse API error responses and extract field errors

```typescript
// src/lib/api-errors.ts
import type { ApiError } from '@/types'

export interface FieldErrors {
  [field: string]: string
}

export interface ParsedApiError {
  message: string
  fieldErrors: FieldErrors
  isValidationError: boolean
}

/**
 * Parse an API error response into a structured format
 * Handles both general errors and validation errors with field details
 */
export function parseApiError(data: Partial<ApiError> | undefined): ParsedApiError {
  const fieldErrors: FieldErrors = {}
  let isValidationError = false

  if (data?.details && Array.isArray(data.details)) {
    isValidationError = true
    for (const detail of data.details) {
      if (detail.field && detail.message) {
        fieldErrors[detail.field] = detail.message
      }
    }
  }

  return {
    message: data?.message || 'An unexpected error occurred',
    fieldErrors,
    isValidationError,
  }
}
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run lint
```

**Completion Criteria**:
- [ ] File created at `src/lib/api-errors.ts`
- [ ] Types defined for FieldErrors and ParsedApiError
- [ ] parseApiError function exported
- [ ] TypeScript compiles without errors

## Phase 2: Update SKUForm Component

### Subtask 2.1: Add Field Error State and Toast to SKUForm
**File**: `src/components/features/SKUForm.tsx`
**Pattern**: Follow ImportForm.tsx:129-186 for toast usage
**Instructions**:
1. Import `toast` from sonner
2. Import `parseApiError` from `@/lib/api-errors`
3. Add `fieldErrors` state alongside existing `error` state
4. Update error handling in `handleSubmit` to:
   - Parse API response for field-level errors
   - Set field errors for validation errors
   - Show toast for immediate feedback
   - Keep form error for persistent display
5. Add field-level error display under inputs

**Key Changes**:
```typescript
// Add imports
import { toast } from 'sonner'
import { parseApiError, type FieldErrors } from '@/lib/api-errors'

// Add state
const [fieldErrors, setFieldErrors] = useState<FieldErrors>({})

// Update handleSubmit error handling (around line 134-151)
if (!res.ok) {
  const data = await res.json().catch(() => ({}))
  const parsed = parseApiError(data)

  setFieldErrors(parsed.fieldErrors)
  setError(parsed.message)

  // Show toast for immediate feedback
  toast.error('Failed to save SKU', {
    description: parsed.message,
  })
  return
}

// Clear field errors on successful submit
setFieldErrors({})

// Add field error display under internalCode input (after line 192)
{fieldErrors.internalCode && (
  <p className="text-sm text-destructive">{fieldErrors.internalCode}</p>
)}
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] toast imported from sonner
- [ ] parseApiError imported and used
- [ ] fieldErrors state added
- [ ] Error handling shows toast notification
- [ ] Field-level errors displayed under inputs
- [ ] Form compiles and renders without errors

## Phase 3: Update ComponentForm Component

### Subtask 3.1: Add Field Error State and Toast to ComponentForm
**File**: `src/components/features/ComponentForm.tsx`
**Pattern**: Same as SKUForm changes in Phase 2
**Instructions**:
1. Import `toast` from sonner
2. Import `parseApiError` from `@/lib/api-errors`
3. Add `fieldErrors` state
4. Update error handling in `handleSubmit` to parse and display errors
5. Add field-level error display under name and skuCode inputs

**Key Changes**:
```typescript
// Add imports
import { toast } from 'sonner'
import { parseApiError, type FieldErrors } from '@/lib/api-errors'

// Add state (after line 41)
const [fieldErrors, setFieldErrors] = useState<FieldErrors>({})

// Update handleSubmit error handling (around line 101-104)
if (!res.ok) {
  const data = await res.json().catch(() => ({}))
  const parsed = parseApiError(data)

  setFieldErrors(parsed.fieldErrors)
  setError(parsed.message)

  toast.error('Failed to save component', {
    description: parsed.message,
  })
  return
}

// Clear on success
setFieldErrors({})

// Add field error display under name input (after line 141)
{fieldErrors.name && (
  <p className="text-sm text-destructive">{fieldErrors.name}</p>
)}

// Add field error display under skuCode input (after line 153)
{fieldErrors.skuCode && (
  <p className="text-sm text-destructive">{fieldErrors.skuCode}</p>
)}
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] toast imported from sonner
- [ ] parseApiError imported and used
- [ ] fieldErrors state added
- [ ] Error handling shows toast notification
- [ ] Field-level errors displayed under name and skuCode
- [ ] Form compiles and renders without errors

## Phase 4: Enhance API Error Responses

### Subtask 4.1: Update SKUs API Route Error Handling
**File**: `src/app/api/skus/route.ts`
**Pattern**: Follow existing conflict() usage at line 136-137
**Instructions**:
1. Ensure all constraint violation errors return with field information
2. Update DUPLICATE_INTERNAL_CODE error to include field detail
3. Verify error messages are user-friendly

**Key Changes**:
```typescript
// Update line 136-137 to include field information
case 'DUPLICATE_INTERNAL_CODE':
  return error(
    'A SKU with this internal code already exists',
    409,
    'Conflict',
    [{ field: 'internalCode', message: 'This internal code is already in use' }]
  )
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] DUPLICATE_INTERNAL_CODE error includes field detail
- [ ] Error response includes details array
- [ ] API compiles without errors

### Subtask 4.2: Update Components API Route Error Handling
**File**: `src/app/api/components/route.ts`
**Pattern**: Same as SKUs API changes
**Instructions**:
1. Update conflict errors (lines 168-171) to include field details
2. Ensure both name and skuCode conflicts specify which field

**Key Changes**:
```typescript
// Update lines 168-171
if (existing.name === data.name) {
  return error(
    'A component with this name already exists',
    409,
    'Conflict',
    [{ field: 'name', message: 'This name is already in use' }]
  )
}
return error(
  'A component with this SKU code already exists',
  409,
  'Conflict',
  [{ field: 'skuCode', message: 'This SKU code is already in use' }]
)
```

Note: Need to import `error` function - check if already imported, otherwise add to imports.

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Name conflict includes field detail
- [ ] SKU code conflict includes field detail
- [ ] API compiles without errors

## Phase 5: Manual Verification

### Subtask 5.1: Test Error Scenarios
**Instructions**:
1. Start the development server: `npm run dev`
2. Navigate to SKU creation page
3. Test duplicate internal code error:
   - Create a SKU with code "TEST-001"
   - Try to create another SKU with "TEST-001"
   - Verify toast appears with specific message
   - Verify field-level error appears under Internal Code input
4. Navigate to Component creation page
5. Test duplicate name error:
   - Create component with name "Test Component"
   - Try to create another with same name
   - Verify toast and field error display
6. Test validation errors (empty required fields)

**Completion Criteria**:
- [ ] SKU duplicate code shows toast with "internal code already in use"
- [ ] SKU form shows field-level error under Internal Code field
- [ ] Component duplicate shows toast with specific message
- [ ] Component form shows field-level error under Name or SKU Code
- [ ] Validation errors display properly

---

## Summary of Deliverables

**Files Created**: 1
- `src/lib/api-errors.ts` - API error parsing utility

**Files Modified**: 4
- `src/components/features/SKUForm.tsx` - Add field errors and toast
- `src/components/features/ComponentForm.tsx` - Add field errors and toast
- `src/app/api/skus/route.ts` - Add field details to error responses
- `src/app/api/components/route.ts` - Add field details to error responses

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 before Phase 2)
2. Create `src/lib/api-errors.ts` first as it's imported by forms
3. Run `npx tsc --noEmit` after each file modification
4. Run `npm run build` after completing each phase
5. Test error scenarios manually in Phase 5

## Test Strategy Note
- No automated tests required for this enhancement
- Manual verification of error display is sufficient
- TARGETED testing recommended if any tests reference these components

## Future Enhancements (Out of Scope)
- Add field-level errors to other forms (BrandForm, CategoryForm, etc.)
- Add error boundary for unhandled errors
- Consider form validation library (react-hook-form + zod) for client-side validation
- Add retry button to toast notifications

## Performance Metrics
| Phase | Estimated Duration |
|-------|--------------------|
| Investigation | 30m |
| Validation | 15m |
| Planning | 30m |
| **Total Planning** | **75m** |
| Implementation (Phase 1-4) | 3-4h |
| Verification (Phase 5) | 30m |
| **Total Build** | **4-5h** |
