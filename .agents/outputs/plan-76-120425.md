# Implementation Plan
**Generated**: 2025-12-04T16:30:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #76
**Estimated Build Time**: 2-3 hours
**Complexity**: Low-Medium

## Investigation Summary

### Request Analysis
**Type**: Feature (Database Schema)
**Source**: GitHub Issue #76
**Priority**: High (blocks all other Shopify sub-issues)
**Parent Issue**: #10 - Shopify order integration to auto-create consumption/build transactions

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: FAST_PATH (schema-only, no business logic)
**Suggested Filter**: None (no tests to run, schema validation only)

### Issue Validation
**Status**: Valid
**Recent Changes**: No Shopify-related commits found; schema.prisma last modified for finished goods lines (issue #72)

### Current State Assessment
- **Existing Shopify references**: "Shopify" exists as a sales channel option in `src/types/index.ts` and `SKUForm.tsx` has a `shopifyHandle` external ID field
- **No integration tables exist**: No ShopifyConnection, ShopifyOrder, ShopifyOrderLine, or SkuChannelMapping models
- **Database**: 11 migrations exist, latest is `20251204024531_add_finished_goods_line`
- **Build status**: Clean (npm run build passes, npx tsc --noEmit passes)

### Dependencies & Blockers
1. None - this is foundational work for the Shopify integration feature

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Low-Medium
**Effort**: 2-3 hours
**Risk**: Low
- Schema changes are well-defined in the issue
- No existing code depends on these tables
- Migration is additive (no breaking changes)

### Patterns Identified
**Primary**: `/home/pbrown/SkuInventory/prisma/schema.prisma` - existing model patterns (Company, Location, Transaction)
**Secondary**: `/home/pbrown/SkuInventory/prisma/migrations/20251204024531_add_finished_goods_line/migration.sql` - migration SQL pattern

### Ripple Effect Analysis
**Files Identified**: 2 (minimal scope)
- `/home/pbrown/SkuInventory/prisma/schema.prisma` - add 4 new models, update 2 existing models
- TypeScript types will be auto-generated by `prisma generate`

**Existing code impact**: NONE (these are new tables with no current consumers)

---

## Executive Summary
Create foundational database schema for Shopify integration by adding 4 new models (ShopifyConnection, ShopifyOrder, ShopifyOrderLine, SkuChannelMapping) and 1 new enum (ShopifyOrderStatus) to Prisma schema, with appropriate relations to existing Company and SKU models. Generate and apply migration.

## Phase 1: Prisma Schema Changes

### Subtask 1.1: Add ShopifyOrderStatus Enum
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Pattern**: Follow existing enum patterns at lines 34, 78, 182 (LocationType, UserRole, TransactionType)
**Location**: Add after line 188 (after TransactionType enum)
**Instructions**:
1. Add the ShopifyOrderStatus enum with values: pending, approved, posted, skipped, error
2. Place after the TransactionType enum block for logical grouping with other enums

**Code to add**:
```prisma
enum ShopifyOrderStatus {
  pending       // Newly synced, awaiting review
  approved      // Ready for transaction posting
  posted        // Transaction created
  skipped       // Manually skipped
  error         // Processing error
}
```

**Completion Criteria**:
- [ ] Enum added to schema.prisma after TransactionType
- [ ] No syntax errors in schema

---

### Subtask 1.2: Add ShopifyConnection Model
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Pattern**: Follow Company model structure (lines 13-32), Location model (lines 42-60)
**Location**: Add in new "Shopify Integration" section at end of file (after ComponentAlertState)
**Instructions**:
1. Add section comment: `// ============================================`
2. Add section title: `// Shopify Integration Entities`
3. Add section footer: `// ============================================`
4. Add ShopifyConnection model with all fields from issue specification

**Code to add** (after line 407):
```prisma
// ============================================
// Shopify Integration Entities
// ============================================

model ShopifyConnection {
  id           String   @id @default(uuid())
  companyId    String
  company      Company  @relation(fields: [companyId], references: [id])
  shopName     String   @db.VarChar(100)  // e.g., "mystore.myshopify.com"
  accessToken  String   @db.VarChar(255)  // encrypted API token
  isActive     Boolean  @default(true)
  lastSyncAt   DateTime?
  syncStatus   String?  @db.VarChar(50)   // "idle", "syncing", "error"
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  orders ShopifyOrder[]

  @@unique([companyId])  // One connection per company initially
  @@index([companyId, isActive])
}
```

**Completion Criteria**:
- [ ] Model added with correct field types and attributes
- [ ] Relation to Company model defined
- [ ] Indexes and unique constraints added
- [ ] Section comments added for organization

---

### Subtask 1.3: Add ShopifyOrder Model
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Pattern**: Follow Transaction model structure (lines 190-230) for complex relations
**Location**: Add after ShopifyConnection model
**Instructions**:
1. Add ShopifyOrder model with all fields from issue specification
2. Include relation to ShopifyConnection
3. Include lines array relation for ShopifyOrderLine

**Code to add** (after ShopifyConnection):
```prisma
model ShopifyOrder {
  id                 String              @id @default(uuid())
  connectionId       String
  connection         ShopifyConnection   @relation(fields: [connectionId], references: [id])
  shopifyOrderId     String              // Shopify's order ID
  shopifyOrderNumber String              // Human-readable order number
  orderDate          DateTime
  fulfillmentStatus  String?             @db.VarChar(50)
  financialStatus    String?             @db.VarChar(50)
  status             ShopifyOrderStatus  @default(pending)
  transactionId      String?             // Link to created Transaction
  errorMessage       String?             @db.Text
  rawData            Json                @default("{}")  // Store raw order JSON
  syncedAt           DateTime            @default(now())
  processedAt        DateTime?

  lines ShopifyOrderLine[]

  @@unique([connectionId, shopifyOrderId])
  @@index([connectionId, status])
  @@index([syncedAt])
}
```

**Completion Criteria**:
- [ ] Model added with correct field types
- [ ] ShopifyOrderStatus enum used for status field
- [ ] Relation to ShopifyConnection defined
- [ ] Unique constraint on connectionId + shopifyOrderId
- [ ] Appropriate indexes added

---

### Subtask 1.4: Add ShopifyOrderLine Model
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Pattern**: Follow TransactionLine model structure (lines 232-242), FinishedGoodsLine (lines 244-258)
**Location**: Add after ShopifyOrder model
**Instructions**:
1. Add ShopifyOrderLine model with all fields from issue specification
2. Include relation to ShopifyOrder with onDelete: Cascade
3. Note: mappedSkuId is intentionally NOT a foreign key (could be null or refer to unmapped item)

**Code to add** (after ShopifyOrder):
```prisma
model ShopifyOrderLine {
  id               String       @id @default(uuid())
  orderId          String
  order            ShopifyOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  shopifyLineId    String
  shopifyVariantId String?      // May be null for custom items
  shopifySku       String?      @db.VarChar(100)
  title            String       @db.VarChar(255)
  quantity         Int
  price            Decimal      @db.Decimal(10, 2)
  mappedSkuId      String?      // Internal SKU if mapped (not a FK - may be unmapped)
  mappingStatus    String       @default("unmapped") @db.VarChar(20)  // "mapped", "unmapped", "not_found"

  @@index([orderId])
  @@index([shopifyVariantId])
}
```

**Completion Criteria**:
- [ ] Model added with correct field types
- [ ] Relation to ShopifyOrder with Cascade delete
- [ ] Price field uses Decimal(10, 2)
- [ ] Appropriate indexes added

---

### Subtask 1.5: Add SkuChannelMapping Model
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Pattern**: Follow BOMLine model pattern (lines 316-326) for join-table-like structure
**Location**: Add after ShopifyOrderLine model
**Instructions**:
1. Add SkuChannelMapping model with all fields from issue specification
2. Include relations to Company and SKU
3. This is a generic mapping table (channelType supports future Amazon, TikTok, etc.)

**Code to add** (after ShopifyOrderLine):
```prisma
model SkuChannelMapping {
  id          String   @id @default(uuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  channelType String   @default("shopify") @db.VarChar(20)  // Future: amazon, tiktok, etc.
  externalId  String   @db.VarChar(100)  // Shopify variant ID
  externalSku String?  @db.VarChar(100)  // Shopify SKU for reference
  skuId       String
  sku         SKU      @relation(fields: [skuId], references: [id])
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([companyId, channelType, externalId])
  @@index([companyId, channelType])
  @@index([skuId])
}
```

**Completion Criteria**:
- [ ] Model added with correct field types
- [ ] Relations to Company and SKU defined
- [ ] Unique constraint on companyId + channelType + externalId
- [ ] Appropriate indexes added

---

### Subtask 1.6: Update Company Model with New Relations
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Location**: Lines 13-32 (Company model)
**Instructions**:
1. Add shopifyConnection relation (optional, one-to-one)
2. Add skuChannelMappings relation (one-to-many)
3. Add after existing relations (line 31, after `skus` relation)

**Code to add** (after line 31 `skus` relation, before closing brace):
```prisma
  // Shopify integration relations
  shopifyConnection    ShopifyConnection?
  skuChannelMappings   SkuChannelMapping[]
```

**Completion Criteria**:
- [ ] shopifyConnection relation added (optional, one-to-one)
- [ ] skuChannelMappings relation added (one-to-many)
- [ ] Placed logically after existing relations

---

### Subtask 1.7: Update SKU Model with New Relation
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Location**: Lines 264-292 (SKU model)
**Instructions**:
1. Add channelMappings relation (one-to-many)
2. Add after existing relations (line 287, after `finishedGoodsLines` relation)

**Code to add** (after line 287 `finishedGoodsLines` relation, before closing brace with indexes):
```prisma
  // Channel mapping relations
  channelMappings      SkuChannelMapping[]
```

**Completion Criteria**:
- [ ] channelMappings relation added
- [ ] Placed logically after existing relations

---

## Phase 2: Migration Generation and Validation

### Subtask 2.1: Validate Schema Syntax
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Instructions**:
1. Run Prisma format to validate syntax
2. Check for any relation errors

**Commands**:
```bash
cd /home/pbrown/SkuInventory && npx prisma format
```

**Completion Criteria**:
- [ ] `prisma format` completes without errors
- [ ] Schema is properly formatted

---

### Subtask 2.2: Generate Migration
**File**: `/home/pbrown/SkuInventory/prisma/migrations/`
**Instructions**:
1. Generate migration with descriptive name
2. Review generated SQL for correctness

**Commands**:
```bash
cd /home/pbrown/SkuInventory && npx prisma migrate dev --name add_shopify_integration_tables
```

**Completion Criteria**:
- [ ] Migration generates successfully
- [ ] Migration creates 4 new tables
- [ ] Migration creates 1 new enum type
- [ ] Foreign keys are correctly defined
- [ ] Indexes are created

---

### Subtask 2.3: Generate Prisma Client
**Instructions**:
1. Regenerate Prisma client with new types
2. Verify types are available

**Commands**:
```bash
cd /home/pbrown/SkuInventory && npx prisma generate
```

**Completion Criteria**:
- [ ] `prisma generate` completes without errors
- [ ] New model types available in generated client

---

## Phase 3: Build Verification

### Subtask 3.1: Verify TypeScript Compilation
**Instructions**:
1. Run TypeScript compiler in check mode
2. Ensure no type errors from schema changes

**Commands**:
```bash
cd /home/pbrown/SkuInventory && npx tsc --noEmit
```

**Completion Criteria**:
- [ ] No TypeScript errors
- [ ] No warnings related to new Prisma types

---

### Subtask 3.2: Verify Full Build
**Instructions**:
1. Run full Next.js build
2. Ensure application builds successfully

**Commands**:
```bash
cd /home/pbrown/SkuInventory && npm run build
```

**Completion Criteria**:
- [ ] Build completes without errors
- [ ] No warnings related to schema changes

---

## Summary of Deliverables

**Files Created**:
- 1 Prisma migration file (auto-generated in `prisma/migrations/`)

**Files Modified**:
- `/home/pbrown/SkuInventory/prisma/schema.prisma` - add enum + 4 models + update 2 models

**New Database Objects**:
| Object Type | Name | Purpose |
|-------------|------|---------|
| Enum | ShopifyOrderStatus | Order processing states |
| Table | ShopifyConnection | API credentials per company |
| Table | ShopifyOrder | Synced orders with status |
| Table | ShopifyOrderLine | Individual order line items |
| Table | SkuChannelMapping | Maps external IDs to internal SKUs |

**Indexes Created**:
- ShopifyConnection: (companyId, isActive)
- ShopifyOrder: (connectionId, status), (syncedAt)
- ShopifyOrderLine: (orderId), (shopifyVariantId)
- SkuChannelMapping: (companyId, channelType), (skuId)

**Unique Constraints**:
- ShopifyConnection: (companyId)
- ShopifyOrder: (connectionId, shopifyOrderId)
- SkuChannelMapping: (companyId, channelType, externalId)

---

## Handoff to Build Agent

1. Execute subtasks in exact order (1.1 through 3.2)
2. Schema changes in Phase 1 must all be completed before Phase 2
3. Run validation commands after each major step
4. If migration fails, check for typos in field names or relation definitions
5. The enum must be defined BEFORE models that reference it

## Test Strategy Note
- No unit tests required (schema-only change)
- No E2E tests required
- Validation is via `prisma migrate dev`, `prisma generate`, `tsc --noEmit`, and `npm run build`

## Acceptance Criteria (from Issue)
- [ ] All four new models created in schema.prisma
- [ ] Company and SKU models updated with new relations
- [ ] Migration generated successfully (`npx prisma migrate dev`)
- [ ] `npx prisma generate` completes without errors
- [ ] `npm run build` passes
- [ ] `npx tsc --noEmit` passes

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 8m |
| Validation | 2m |
| Planning | 5m |
| **Total** | **15m** |
