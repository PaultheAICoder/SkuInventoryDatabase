# Implementation Plan
**Generated**: 2025-12-04T05:30:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #81 - [Parent #12] Lot capture on receipts
**Estimated Build Time**: 4-6 hours
**Complexity**: Moderate

## Investigation Summary

### Request Analysis
**Type**: Feature
**Source**: GitHub Issue #81
**Priority**: High (Part of V3 roadmap, sub-issue 2 of 5)

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="receipt|lot"` or `--testPathPattern="transactions|inventory"`

### Issue Validation
**Status**: Valid
**Recent Changes**:
- Issue #78 (Lot tracking schema and migrations) was CLOSED on 2025-12-04 - Lot, LotBalance tables and TransactionLine.lotId field now exist
- Recent commits to affected files are related to location features (issues #69, #70, #72, #73, #79, #96) - no conflicts expected

### Current State Assessment
- **Existing components**:
  - `prisma/schema.prisma`: Lot, LotBalance models exist; TransactionLine has lotId field (COMPLETE from #78)
  - `src/types/transaction.ts`: createReceiptSchema exists without lot fields (NEEDS UPDATE)
  - `src/services/inventory.ts`: createReceiptTransaction exists without lot handling (NEEDS UPDATE)
  - `src/app/api/transactions/receipt/route.ts`: POST handler exists (NEEDS UPDATE)
  - `src/components/features/ReceiptDialog.tsx`: Form exists without lot fields (NEEDS UPDATE)
- **Database**: Lot and LotBalance tables exist with proper relations
- **API Routes**: /api/transactions/receipt exists, needs lot parameter handling
- **Types**: TransactionLineResponse may need lotId/lot field for display

### Dependencies & Blockers
1. **Dependency Met**: Sub-issue #78 (Lot tracking schema) is CLOSED - schema exists
2. **No blocking issues identified**

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Moderate
**Effort**: 4-6 hours
**Risk**: Low - follows established patterns, optional fields maintain backward compatibility

### Patterns Identified
**Primary**: `/home/pbrown/SkuInventory/src/services/inventory.ts:275-362` - createReceiptTransaction with $transaction block pattern
**Secondary**: `/home/pbrown/SkuInventory/src/services/lowstock-alert.ts:89-106` - Prisma upsert pattern for Lot/LotBalance handling
**UI Pattern**: `/home/pbrown/SkuInventory/src/components/features/ReceiptDialog.tsx` - Form structure with shadcn/ui components

### Ripple Effect Analysis
**Files Identified**: 4 primary + 1 optional
- `/home/pbrown/SkuInventory/src/types/transaction.ts` - Add lotNumber/expiryDate to schema
- `/home/pbrown/SkuInventory/src/services/inventory.ts` - Extend createReceiptTransaction
- `/home/pbrown/SkuInventory/src/app/api/transactions/receipt/route.ts` - Pass lot params to service
- `/home/pbrown/SkuInventory/src/components/features/ReceiptDialog.tsx` - Add lot form fields
- `/home/pbrown/SkuInventory/src/types/transaction.ts` (TransactionLineResponse) - Optional: include lot info

---

## Executive Summary
Add optional lot number and expiry date fields to the receipt transaction flow. When lot info is provided during receipt, create or update Lot and LotBalance records within the same transaction. Update the ReceiptDialog UI with optional lot input fields. Maintain backward compatibility by making all lot fields optional.

## Phase 1: Types Layer

### Subtask 1.1: Extend createReceiptSchema with Lot Fields
**File**: `/home/pbrown/SkuInventory/src/types/transaction.ts`
**Pattern**: Follow existing schema field patterns in the same file
**Instructions**:
1. Add `lotNumber` field to `createReceiptSchema`:
   ```typescript
   lotNumber: z.string().max(100).optional(),
   ```
2. Add `expiryDate` field with YYYY-MM-DD format validation:
   ```typescript
   expiryDate: z.string().regex(/^\d{4}-\d{2}-\d{2}$/, 'Invalid date format').optional(),
   ```
3. Place these after the existing `locationId` field for logical grouping

**Validation Commands**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Schema compiles without errors
- [ ] Optional fields allow receipt creation without lot data
- [ ] CreateReceiptInput type includes lotNumber and expiryDate

### Subtask 1.2: Update TransactionLineResponse for Lot Display (Optional)
**File**: `/home/pbrown/SkuInventory/src/types/transaction.ts`
**Pattern**: Follow existing nested object pattern in TransactionLineResponse
**Instructions**:
1. Add optional `lotId` and `lot` fields to `TransactionLineResponse` interface:
   ```typescript
   export interface TransactionLineResponse {
     id: string
     component: { id: string; name: string; skuCode: string }
     quantityChange: string
     costPerUnit: string | null
     lotId: string | null  // ADD
     lot: { id: string; lotNumber: string; expiryDate: string | null } | null  // ADD
   }
   ```

**Validation Commands**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] TransactionLineResponse includes lot fields
- [ ] No type errors in consuming code

---

## Phase 2: Service Layer

### Subtask 2.1: Extend createReceiptTransaction for Lot Handling
**File**: `/home/pbrown/SkuInventory/src/services/inventory.ts`
**Pattern**: Follow existing $transaction block pattern (lines 302-361), use upsert pattern from lowstock-alert.ts
**Instructions**:
1. Add `lotNumber` and `expiryDate` parameters to the function signature:
   ```typescript
   export async function createReceiptTransaction(params: {
     companyId: string
     componentId: string
     quantity: number
     date: Date
     supplier: string
     costPerUnit?: number
     updateComponentCost: boolean
     notes?: string | null
     createdById: string
     locationId?: string
     lotNumber?: string      // ADD
     expiryDate?: string     // ADD (YYYY-MM-DD format string)
   }) {
   ```

2. Inside the `$transaction` block, after getting the component and before creating the transaction, add lot handling logic:
   ```typescript
   // Handle lot creation/update if lotNumber provided
   let lotId: string | null = null
   if (lotNumber) {
     // Parse expiry date if provided
     const expiryDateValue = expiryDate ? new Date(expiryDate) : null

     // Check if lot already exists for this component
     const existingLot = await tx.lot.findUnique({
       where: {
         componentId_lotNumber: {
           componentId,
           lotNumber,
         },
       },
     })

     if (existingLot) {
       // Lot exists - update receivedQuantity and LotBalance
       await tx.lot.update({
         where: { id: existingLot.id },
         data: {
           receivedQuantity: {
             increment: new Prisma.Decimal(quantity),
           },
         },
       })

       // Update or create LotBalance
       await tx.lotBalance.upsert({
         where: { lotId: existingLot.id },
         create: {
           lotId: existingLot.id,
           quantity: new Prisma.Decimal(quantity),
         },
         update: {
           quantity: {
             increment: new Prisma.Decimal(quantity),
           },
         },
       })

       lotId = existingLot.id
     } else {
       // Create new Lot and LotBalance
       const newLot = await tx.lot.create({
         data: {
           componentId,
           lotNumber,
           expiryDate: expiryDateValue,
           receivedQuantity: new Prisma.Decimal(quantity),
           supplier,
           notes,
         },
       })

       await tx.lotBalance.create({
         data: {
           lotId: newLot.id,
           quantity: new Prisma.Decimal(quantity),
         },
       })

       lotId = newLot.id
     }
   }
   ```

3. Modify the transaction line creation to include lotId:
   ```typescript
   lines: {
     create: {
       componentId,
       quantityChange: new Prisma.Decimal(quantity),
       costPerUnit: new Prisma.Decimal(lineCostPerUnit),
       lotId,  // ADD - will be null if no lot provided
     },
   },
   ```

4. Update the include block to include lot information in the response:
   ```typescript
   lines: {
     include: {
       component: {
         select: { id: true, name: true, skuCode: true },
       },
       lot: {
         select: { id: true, lotNumber: true, expiryDate: true },
       },
     },
   },
   ```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Function accepts lotNumber and expiryDate parameters
- [ ] Lot record created for new lot numbers
- [ ] Existing lot receivedQuantity incremented for duplicate lot numbers
- [ ] LotBalance created or updated atomically
- [ ] TransactionLine correctly references lotId
- [ ] All operations within $transaction block for atomicity

---

## Phase 3: API Route

### Subtask 3.1: Update Receipt Route to Pass Lot Data
**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/receipt/route.ts`
**Pattern**: Follow existing parameter passing pattern (lines 57-68)
**Instructions**:
1. Pass lot fields to createReceiptTransaction:
   ```typescript
   const transaction = await createReceiptTransaction({
     companyId: selectedCompanyId,
     componentId: data.componentId,
     quantity: data.quantity,
     date: data.date,
     supplier: data.supplier,
     costPerUnit: data.costPerUnit,
     updateComponentCost: data.updateComponentCost,
     notes: data.notes,
     createdById: session.user.id,
     locationId: data.locationId,
     lotNumber: data.lotNumber,      // ADD
     expiryDate: data.expiryDate,    // ADD
   })
   ```

2. Optionally update the response to include lot info in lines:
   ```typescript
   lines: transaction.lines.map((line) => ({
     id: line.id,
     component: line.component,
     quantityChange: line.quantityChange.toString(),
     costPerUnit: line.costPerUnit?.toString() ?? null,
     lotId: line.lotId ?? null,  // ADD
     lot: line.lot ? {           // ADD
       id: line.lot.id,
       lotNumber: line.lot.lotNumber,
       expiryDate: line.lot.expiryDate?.toISOString().split('T')[0] ?? null,
     } : null,
   })),
   ```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Route passes lotNumber and expiryDate to service
- [ ] Response includes lot info when provided
- [ ] Backward compatible (works without lot data)

---

## Phase 4: Frontend Components

### Subtask 4.1: Add Lot Fields to ReceiptDialog
**File**: `/home/pbrown/SkuInventory/src/components/features/ReceiptDialog.tsx`
**Pattern**: Follow existing form field patterns (Input, Label) and location Select pattern
**Instructions**:
1. Add lot fields to formData state (after locationId):
   ```typescript
   const [formData, setFormData] = useState({
     date: new Date().toISOString().split('T')[0],
     quantity: '',
     supplier: '',
     costPerUnit: currentCost,
     updateComponentCost: false,
     notes: '',
     locationId: '',
     lotNumber: '',       // ADD
     expiryDate: '',      // ADD
   })
   ```

2. Add reset for lot fields in form reset section:
   ```typescript
   setFormData({
     date: new Date().toISOString().split('T')[0],
     quantity: '',
     supplier: '',
     costPerUnit: currentCost,
     updateComponentCost: false,
     notes: '',
     locationId: '',
     lotNumber: '',       // ADD
     expiryDate: '',      // ADD
   })
   ```

3. Add lot fields to the form submission body (before notes):
   ```typescript
   body: JSON.stringify({
     componentId,
     date: formData.date,
     quantity: parseFloat(formData.quantity),
     supplier: formData.supplier,
     costPerUnit: formData.costPerUnit ? parseFloat(formData.costPerUnit) : undefined,
     updateComponentCost: formData.updateComponentCost,
     notes: formData.notes || null,
     locationId: formData.locationId || undefined,
     lotNumber: formData.lotNumber || undefined,     // ADD
     expiryDate: formData.expiryDate || undefined,   // ADD
   }),
   ```

4. Add UI fields after Location field and before Cost/Unit field. Add a subtle separator for visual grouping:
   ```tsx
   {/* Lot Tracking Section */}
   <div className="grid grid-cols-4 items-center gap-4">
     <Label htmlFor="lotNumber" className="text-right">
       Lot Number
     </Label>
     <Input
       id="lotNumber"
       className="col-span-3"
       placeholder="e.g., LOT-2024-001"
       value={formData.lotNumber}
       onChange={(e) => setFormData((prev) => ({ ...prev, lotNumber: e.target.value }))}
     />
   </div>

   <div className="grid grid-cols-4 items-center gap-4">
     <Label htmlFor="expiryDate" className="text-right">
       Expiry Date
     </Label>
     <Input
       id="expiryDate"
       type="date"
       className="col-span-3"
       value={formData.expiryDate}
       onChange={(e) => setFormData((prev) => ({ ...prev, expiryDate: e.target.value }))}
       disabled={!formData.lotNumber}
     />
   </div>
   ```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
npm run lint
```

**Completion Criteria**:
- [ ] Lot Number input field appears in dialog
- [ ] Expiry Date input appears (disabled until lot number entered)
- [ ] Fields are optional (form submits without lot data)
- [ ] Fields are included in API request when populated
- [ ] Dialog resets lot fields after successful submission

---

## Phase 5: Tests

### Subtask 5.1: Add Integration Tests for Receipt with Lot
**File**: `/home/pbrown/SkuInventory/tests/integration/transactions.test.ts`
**Pattern**: Follow existing receipt test patterns in the same file
**Instructions**:
1. Add test case: "receipt with lot info creates Lot and LotBalance records":
   ```typescript
   it('receipt with lot info creates Lot and LotBalance records', async () => {
     setTestSession(TEST_SESSIONS.admin!)
     const component = await createTestComponentInDb(TEST_SESSIONS.admin!.user.companyId)

     const request = createTestRequest('/api/transactions/receipt', {
       method: 'POST',
       body: {
         componentId: component.id,
         quantity: 50,
         supplier: 'Test Supplier',
         date: new Date().toISOString().split('T')[0],
         lotNumber: 'LOT-001',
         expiryDate: '2025-12-31',
       },
     })

     const response = await createReceipt(request)
     const result = await parseRouteResponse(response)

     expect(result.status).toBe(201)

     // Verify Lot created
     const prisma = getIntegrationPrisma()
     const lot = await prisma.lot.findFirst({
       where: { componentId: component.id, lotNumber: 'LOT-001' },
       include: { balance: true },
     })

     expect(lot).toBeDefined()
     expect(lot?.lotNumber).toBe('LOT-001')
     expect(lot?.expiryDate?.toISOString().split('T')[0]).toBe('2025-12-31')
     expect(Number(lot?.receivedQuantity)).toBe(50)
     expect(Number(lot?.balance?.quantity)).toBe(50)
   })
   ```

2. Add test case: "receipt without lot info remains backward compatible":
   ```typescript
   it('receipt without lot info remains backward compatible', async () => {
     setTestSession(TEST_SESSIONS.admin!)
     const component = await createTestComponentInDb(TEST_SESSIONS.admin!.user.companyId)

     const request = createTestRequest('/api/transactions/receipt', {
       method: 'POST',
       body: {
         componentId: component.id,
         quantity: 25,
         supplier: 'Test Supplier',
         date: new Date().toISOString().split('T')[0],
         // No lotNumber or expiryDate
       },
     })

     const response = await createReceipt(request)
     const result = await parseRouteResponse(response)

     expect(result.status).toBe(201)

     // Verify no lot created
     const prisma = getIntegrationPrisma()
     const lots = await prisma.lot.findMany({
       where: { componentId: component.id },
     })

     expect(lots.length).toBe(0)
   })
   ```

3. Add test case: "receipt adding to existing lot increases LotBalance":
   ```typescript
   it('receipt adding to existing lot increases LotBalance', async () => {
     setTestSession(TEST_SESSIONS.admin!)
     const component = await createTestComponentInDb(TEST_SESSIONS.admin!.user.companyId)

     // First receipt creates lot
     const request1 = createTestRequest('/api/transactions/receipt', {
       method: 'POST',
       body: {
         componentId: component.id,
         quantity: 50,
         supplier: 'Supplier A',
         date: new Date().toISOString().split('T')[0],
         lotNumber: 'LOT-MULTI',
         expiryDate: '2025-12-31',
       },
     })
     await createReceipt(request1)

     // Second receipt adds to same lot
     const request2 = createTestRequest('/api/transactions/receipt', {
       method: 'POST',
       body: {
         componentId: component.id,
         quantity: 30,
         supplier: 'Supplier B',
         date: new Date().toISOString().split('T')[0],
         lotNumber: 'LOT-MULTI',
         // Note: expiryDate not provided - should not update existing
       },
     })
     const response = await createReceipt(request2)
     expect((await parseRouteResponse(response)).status).toBe(201)

     // Verify lot balance increased
     const prisma = getIntegrationPrisma()
     const lot = await prisma.lot.findFirst({
       where: { componentId: component.id, lotNumber: 'LOT-MULTI' },
       include: { balance: true },
     })

     expect(lot).toBeDefined()
     expect(Number(lot?.receivedQuantity)).toBe(80) // 50 + 30
     expect(Number(lot?.balance?.quantity)).toBe(80) // 50 + 30
   })
   ```

**Validation Commands**:
```bash
npm test -- --testPathPattern="transactions"
```

**Completion Criteria**:
- [ ] Test for receipt with lot passes
- [ ] Test for receipt without lot passes (backward compat)
- [ ] Test for adding to existing lot passes
- [ ] All existing receipt tests still pass

---

## Summary of Deliverables
**Files Created**: 0
**Files Modified**:
1. `/home/pbrown/SkuInventory/src/types/transaction.ts` - Add lot fields to schema and response types
2. `/home/pbrown/SkuInventory/src/services/inventory.ts` - Extend createReceiptTransaction with lot handling
3. `/home/pbrown/SkuInventory/src/app/api/transactions/receipt/route.ts` - Pass lot data to service
4. `/home/pbrown/SkuInventory/src/components/features/ReceiptDialog.tsx` - Add lot input fields
5. `/home/pbrown/SkuInventory/tests/integration/transactions.test.ts` - Add lot receipt tests

## Handoff to Build Agent
1. Execute subtasks in exact order (Phase 1 -> Phase 5)
2. Types must compile before service changes
3. Service must work before route changes
4. Run validation commands at each phase boundary
5. Final checks:
   - `npm run build` must pass
   - `npx tsc --noEmit` must pass
   - `npm test -- --testPathPattern="transactions"` must pass

## Test Strategy Note
- Use Vitest for unit tests
- Integration tests verify full receipt flow with Lot/LotBalance creation
- Existing receipt tests must continue to pass (backward compatibility)

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 10m |
| **Total** | **30m** |
