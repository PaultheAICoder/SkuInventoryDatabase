# Implementation Plan
**Generated**: 2025-12-09T22:15:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #240
**Estimated Build Time**: 1.5 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Operational/Data Population Task (not code implementation)
**Source**: GitHub Issue #240
**Priority**: Medium

### Task Classification
**Category**: CHORE (data backfill and operational verification)
**Test Strategy**: FAST_PATH - Manual verification only
**Suggested Filter**: N/A - No automated tests needed

### Issue Validation
**Status**: Valid
**Recent Changes**:
- Phases 1-5 completed (#235-#239) - feedback system fully implemented
- Issue #217 closed 2025-12-08 23:39 - NO notification sent
- Issue #222 closed 2025-12-09 00:30 - notification sent 04:34

### Current State Assessment
- **Feedback table**: Exists (Phase 1 migration applied)
- **Feedback records**: NONE exist in test or production database
- **EmailMonitorState**: `lastCheckTime = 2025-12-09 21:47:46` (Phase 4)
- **Webhook handler**: Ready to create records on issue close (Phase 3)
- **Email monitor**: Ready to process replies (Phase 4)
- **Cron scheduler**: Active, polling every 5 minutes (Phase 5)

### GitHub Issue Analysis

| Issue | Closed At | Notification | Status |
|-------|-----------|--------------|--------|
| #217 | 2025-12-08 23:39 | NOT sent | Missing comment |
| #222 | 2025-12-09 00:30 | Sent 04:34 | Has comment |

**Issue #217 Comment Analysis**: No "Notification sent" comment exists
**Issue #222 Comment Analysis**: Has "Notification sent to submitter (tbaek@vital-enterprises.com) requesting verification" comment

### Dependencies & Blockers

1. **Environment Variables Required**:
   - `CRON_SECRET` - For authenticating manual email monitor trigger
   - `AZURE_TENANT_ID`, `AZURE_CLIENT_ID`, `AZURE_CLIENT_SECRET`, `FEEDBACK_EMAIL` - For Graph API email operations
   - `GITHUB_API_TOKEN` - For GitHub API operations

2. **User Reference**:
   - Trevor's user ID: `ca6e8d94-7c20-45b8-a715-4563180dc908`
   - Trevor's email: `tbaek@vital-enterprises.com`

**Can Proceed?**: YES (operational tasks only)

### Complexity Assessment
**Complexity**: Simple (operational data tasks)
**Effort**: 1.5 hours
**Risk**: Low - read operations and database inserts, no code changes

### Patterns Identified
**Primary**: SQL INSERT patterns from issue #240 description
**Secondary**: `src/services/feedback.ts` - createFeedback function

### Ripple Effect Analysis
**Files Identified**: 0 code files
**This is an operational task** - no code modifications required.

---

## Executive Summary

This is Phase 6 (final phase) of the feedback system implementation. The task involves:
1. Creating Feedback database records for pre-existing issues #217 and #222
2. Triggering the email monitor with extended lookback to catch any missed replies
3. Potentially re-sending notification for issue #217 (which never received one)
4. Verifying the final state of all feedback records

No code changes are required - this is purely an operational/data backfill task.

## Phase 0: Environment Verification

### Subtask 0.1: Verify Test Database Connection
**Target**: Test database (inventory-db-test:2346)
**Instructions**:
```bash
docker exec inventory-db-test psql -U inventory_test -d inventory_test -c "SELECT current_database();"
# Expected: inventory_test
```
**Completion Criteria**: [ ] Output shows `inventory_test`

### Subtask 0.2: Verify Environment Variables
**Instructions**:
Check that the following environment variables are set in production (port 4545):
- `CRON_SECRET`
- `AZURE_TENANT_ID`
- `AZURE_CLIENT_ID`
- `AZURE_CLIENT_SECRET`
- `FEEDBACK_EMAIL`
- `GITHUB_API_TOKEN`

**Note**: These API calls must target PRODUCTION (port 4545) because:
- The Feedback records need to be in production database
- The email monitor needs to access the real email inbox
- The GitHub comments need to be posted to real issues

**Completion Criteria**: [ ] All required env vars are configured

---

## Phase 1: Create Feedback Records

### Subtask 1.1: Create Feedback Record for Issue #217
**Target**: Production database (via webhook endpoint)
**Instructions**:

Since issue #217 was closed before the feedback tracking system was restored, we need to manually create a Feedback record.

**Option A: Direct SQL (Production)**:
```sql
-- Execute against production database
INSERT INTO "Feedback" (id, "userId", "githubIssueNumber", "githubIssueUrl", status, "createdAt", "updatedAt")
VALUES (
  gen_random_uuid(),
  'ca6e8d94-7c20-45b8-a715-4563180dc908',
  217,
  'https://github.com/PaultheAICoder/SkuInventoryDatabase/issues/217',
  'resolved',
  NOW(),
  NOW()
);
```

**Option B: Use feedback service (preferred)**:
The webhook handler already has the logic to create feedback records. However, since the issue is already closed, we cannot re-trigger the webhook.

**Important Notes**:
- Status should be 'resolved' (issue is closed, but notification was never sent)
- `notificationSentAt` should be NULL (no notification was sent for #217)

**Completion Criteria**:
- [ ] Feedback record exists for issue #217
- [ ] Status is 'resolved'
- [ ] notificationSentAt is NULL

### Subtask 1.2: Create Feedback Record for Issue #222
**Target**: Production database
**Instructions**:

Issue #222 received a notification on 2025-12-09 04:34:09Z.

```sql
-- Execute against production database
INSERT INTO "Feedback" (id, "userId", "githubIssueNumber", "githubIssueUrl", status, "notificationSentAt", "createdAt", "updatedAt")
VALUES (
  gen_random_uuid(),
  'ca6e8d94-7c20-45b8-a715-4563180dc908',
  222,
  'https://github.com/PaultheAICoder/SkuInventoryDatabase/issues/222',
  'resolved',
  '2025-12-09T04:34:09Z',
  NOW(),
  NOW()
);
```

**Completion Criteria**:
- [ ] Feedback record exists for issue #222
- [ ] Status is 'resolved'
- [ ] notificationSentAt is '2025-12-09T04:34:09Z'

---

## Phase 2: Process Backlogged Emails

### Subtask 2.1: Trigger Email Monitor with Extended Lookback
**Target**: Production API (port 4545)
**Instructions**:

Trigger the email monitor to check for replies since December 8th:

```bash
curl -X POST "http://172.16.20.50:4545/api/cron/email-monitor" \
  -H "Authorization: Bearer $CRON_SECRET" \
  -H "Content-Type: application/json" \
  -d '{"since": "2025-12-08T00:00:00Z"}'
```

**Expected Response**:
```json
{
  "status": "success",
  "emailsChecked": <number>,
  "processed": <number>,
  "verified": <number>,
  "changesRequested": <number>,
  "skipped": <number>,
  "skippedReasons": [...],
  "errors": [],
  "lastCheckTimeUpdated": true
}
```

**Completion Criteria**:
- [ ] API returns status "success"
- [ ] Check `processed`, `verified`, `changesRequested` counts
- [ ] No errors in response

### Subtask 2.2: Analyze Email Monitor Results
**Instructions**:

Based on the results from 2.1:

1. **If replies were found and processed**:
   - Check Feedback records were updated
   - Verify GitHub comments were added
   - Check if follow-up issues were created

2. **If no replies found**:
   - Trevor may not have replied yet
   - Issue #217 never received notification, so reply is unlikely

3. **If errors occurred**:
   - Check Graph API credentials
   - Verify FEEDBACK_EMAIL inbox permissions

**Completion Criteria**: [ ] Email monitor results analyzed and documented

---

## Phase 3: Handle Issue #217 (No Notification Sent)

### Subtask 3.1: Decision Point for Issue #217
**Instructions**:

Issue #217 was resolved but the user was never notified. Options:

**Option A: Send notification manually**
- Use Graph API to send the notification email
- Update Feedback record with notificationSentAt
- Add comment to GitHub issue

**Option B: Skip notification**
- Trevor may have already tested the fix organically
- Risk: User doesn't know the issue was fixed
- Risk: No opportunity for verification feedback

**Option C: Ask Trevor directly**
- Contact Trevor through other channels
- Ask if the date off-by-one bug is fixed
- Update Feedback record based on response

**Recommended**: Option A (send notification) if email system is working, otherwise Option C.

**Completion Criteria**: [ ] Decision made and documented

### Subtask 3.2: Execute Chosen Option (if Option A)
**Instructions**:

If sending notification manually, use the webhook handler pattern:

```bash
# Option A: Re-invoke webhook handler simulation
# This is complex - the webhook expects GitHub event payload

# Alternative: Send email directly via Graph API test endpoint
# Check if there's a manual email endpoint, or use the email library directly
```

**Note**: The cleanest approach may be to re-open and close issue #217 via GitHub API:
```bash
# Re-open the issue
gh issue reopen 217 --repo PaultheAICoder/SkuInventoryDatabase

# Close it again (this will trigger the webhook)
gh issue close 217 --repo PaultheAICoder/SkuInventoryDatabase --comment "Re-closing to trigger notification system"
```

**Completion Criteria**:
- [ ] Notification sent to Trevor (if Option A)
- [ ] GitHub comment added
- [ ] Feedback record updated with notificationSentAt

---

## Phase 4: Final Verification

### Subtask 4.1: Verify Feedback Records
**Target**: Production database
**Instructions**:

```sql
SELECT
  "githubIssueNumber",
  status,
  "notificationSentAt",
  "responseReceivedAt",
  "followUpIssueNumber"
FROM "Feedback"
WHERE "githubIssueNumber" IN (217, 222);
```

**Expected State**:
| Issue | Status | notificationSentAt | responseReceivedAt |
|-------|--------|-------------------|-------------------|
| 217 | resolved or verified | SET if Option A | SET if Trevor replied |
| 222 | resolved or verified | 2025-12-09 04:34 | SET if Trevor replied |

**Completion Criteria**:
- [ ] Both issues have Feedback records
- [ ] Status reflects actual response state
- [ ] Timestamps are accurate

### Subtask 4.2: Verify GitHub Issue State
**Instructions**:

```bash
# Check issue #217 comments
gh api repos/PaultheAICoder/SkuInventoryDatabase/issues/217/comments --jq '.[].body' | head -20

# Check issue #222 comments
gh api repos/PaultheAICoder/SkuInventoryDatabase/issues/222/comments --jq '.[].body' | head -20
```

**Expected**:
- Issue #222: Has "Notification sent" comment
- Issue #217: May have new "Notification sent" comment (if Option A executed)
- Both: May have verification comments if Trevor replied

**Completion Criteria**:
- [ ] GitHub comments verified
- [ ] Follow-up issues created if changes requested

### Subtask 4.3: Document Final State
**Instructions**:

Create completion documentation with:
1. Final Feedback record states for both issues
2. Any email responses processed
3. Any follow-up issues created
4. Outstanding items (if any)

**Completion Criteria**: [ ] Completion doc created in `completion-docs/`

---

## Summary of Deliverables

**Files Created**: 0 (operational task)
**Files Modified**: 0
**Database Records Created**: 2 Feedback records
**API Calls**: Email monitor trigger, GitHub API queries

## Handoff to Build Agent

**IMPORTANT**: This is NOT a typical code implementation task.

The Build agent should:
1. Execute Phase 0 to verify environment
2. Execute Phase 1 SQL statements against PRODUCTION database (requires manual approval)
3. Execute Phase 2 API calls against PRODUCTION (port 4545)
4. Execute Phase 3 based on decision
5. Execute Phase 4 verifications

**Database Target**: Production database (port 4546 / inventory-db-prod)
- The Feedback records must go in production, not test
- This is because the issues (#217, #222) are in production GitHub
- The email monitor needs to match real emails to production records

**Security Note**: Phase 1 requires production database access. Build agent should:
- Use explicit production connection string
- Get approval before executing INSERT statements
- Verify records after creation

## Test Strategy Note

No automated tests needed for this operational task.
- Verification is via SQL queries and API responses
- Success criteria are documented in each subtask

## Performance Metrics

| Phase | Duration |
|-------|----------|
| Investigation | 12m |
| Validation | 5m |
| Planning | 8m |
| **Total** | **25m** |

---

## Appendix: Key Information Reference

### User ID for Feedback Records
```
User: Trevor Baek
Email: tbaek@vital-enterprises.com
User ID: ca6e8d94-7c20-45b8-a715-4563180dc908
```

### GitHub Issue URLs
```
Issue #217: https://github.com/PaultheAICoder/SkuInventoryDatabase/issues/217
Issue #222: https://github.com/PaultheAICoder/SkuInventoryDatabase/issues/222
```

### API Endpoints
```
Email Monitor: POST http://172.16.20.50:4545/api/cron/email-monitor
Webhook (info): GET http://172.16.20.50:4545/api/webhooks/github
```

### Existing Feedback Service Functions
Location: `/home/pbrown/SkuInventory/src/services/feedback.ts`
- `createFeedback(input: CreateFeedbackInput)` - Create new record
- `getFeedbackByIssueNumber(issueNumber: number)` - Query by issue
- `updateFeedbackStatus(id: string, input: UpdateFeedbackInput)` - Update status
