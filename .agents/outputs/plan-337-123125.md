# Implementation Plan
**Generated**: 2025-12-31T12:00:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #337
**Estimated Build Time**: 2-3 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Bug Fix / Enhancement
**Source**: GitHub Issue #337
**Priority**: Medium

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="container"` or None

### Issue Validation
**Status**: Valid
**Recent Changes**: Feature added in commit bb6004c (issue #329) on 2025-12-30

### Current State Assessment

The health monitoring system was implemented in issue #329 and has three main components:

1. **Monitor Shell Script** (`docker/monitor/monitor.sh`):
   - Polls Docker containers for health status
   - Sends health logs via webhook to the Next.js app
   - Returns "unknown" status when `docker inspect` fails (line 41-42)

2. **Container Health Service** (`src/services/container-health.ts`):
   - `getContainerStatusSummary()` returns `'unknown'` as fallback when no health log exists (line 258)
   - Queries database for latest health log per container

3. **Dashboard UI** (`src/components/features/DockerHealthDashboard.tsx`):
   - Displays status as badge with color coding
   - "unknown" status shows yellow/warning color (same as "starting")
   - No explicit handling for "unknown" - just falls through to default

### Root Causes of "Unknown" Status

After thorough analysis, the "unknown" status appears in these scenarios:

1. **No Health Logs Recorded Yet**: When `getContainerStatusSummary()` is called for a container with no entries in `ContainerHealthLog` table, it falls back to `'unknown'` (line 258: `currentStatus: (latestHealth?.status as ContainerStatus) ?? 'unknown'`)

2. **Monitor Script Failure**: When `docker inspect` fails in `monitor.sh` (line 40-43), the script returns "unknown" status and records it to the database

3. **Container Not Running**: When a monitored container name doesn't exist or isn't running, Docker commands fail silently

4. **Missing Monitor Service**: If the monitor sidecar container isn't running or hasn't started yet, no health data is collected

### Dependencies & Blockers
1. No blockers identified
2. Monitor shell script requires Docker socket access

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Low (Simple)
**Effort**: 2-3 hours
**Risk**: Low

### Patterns Identified
**Primary**: `/home/pbrown/SkuInventory/src/services/container-health.ts` - Status detection logic
**Secondary**: `/home/pbrown/SkuInventory/docker/monitor/monitor.sh` - Container health polling

### Ripple Effect Analysis
**Files Identified**: 5
- `/home/pbrown/SkuInventory/docker/monitor/monitor.sh` - Status detection improvements
- `/home/pbrown/SkuInventory/src/services/container-health.ts` - Status summary logic
- `/home/pbrown/SkuInventory/src/components/features/DockerHealthDashboard.tsx` - UI display
- `/home/pbrown/SkuInventory/src/types/container-health.ts` - Type definitions (verify)
- `/home/pbrown/SkuInventory/src/app/api/admin/docker-health/route.ts` - API endpoint (verify)

---

## Executive Summary

The health monitor displays "unknown" status when containers haven't been checked yet or when the monitor script can't determine container state. This fix will:
1. Improve the monitor script to better detect container states and report "stopped" instead of "unknown"
2. Add real-time Docker status checking in the API to supplement historical health logs
3. Update the UI to clearly distinguish between "unknown" (never checked) and "stopped" (container not running)

## Phase 1: Improve Monitor Shell Script

### Subtask 1.1: Enhance Container Health Detection in monitor.sh
**File**: `/home/pbrown/SkuInventory/docker/monitor/monitor.sh`
**Pattern**: Current get_container_health function (lines 34-56)
**Instructions**:
1. Modify `get_container_health()` function to better detect container states
2. Add check if container exists at all (vs just running)
3. Return "stopped" when container exists but isn't running (instead of "unknown")
4. Return "not_found" when container doesn't exist in Docker
5. Improve error handling for Docker command failures

**Current Code** (lines 34-56):
```bash
get_container_health() {
    local container="$1"

    # Get container inspect data
    local inspect=$(docker inspect "$container" 2>/dev/null || echo "{}")

    if [ "$inspect" = "{}" ] || [ "$inspect" = "[]" ]; then
        echo "unknown"
        return
    fi

    # Extract health status
    local health=$(echo "$inspect" | jq -r '.[0].State.Health.Status // "none"')
    local running=$(echo "$inspect" | jq -r '.[0].State.Running')

    if [ "$running" = "false" ]; then
        echo "unhealthy"
    elif [ "$health" = "healthy" ] || [ "$health" = "none" ] && [ "$running" = "true" ]; then
        echo "healthy"
    else
        echo "$health"
    fi
}
```

**New Code**:
```bash
get_container_health() {
    local container="$1"

    # Check if container exists first
    if ! docker inspect "$container" >/dev/null 2>&1; then
        echo "not_found"
        return
    fi

    # Get container inspect data
    local inspect=$(docker inspect "$container" 2>/dev/null)

    if [ -z "$inspect" ] || [ "$inspect" = "[]" ]; then
        echo "not_found"
        return
    fi

    # Extract state information
    local running=$(echo "$inspect" | jq -r '.[0].State.Running // "false"')
    local status=$(echo "$inspect" | jq -r '.[0].State.Status // "unknown"')
    local health=$(echo "$inspect" | jq -r '.[0].State.Health.Status // "none"')

    # Container not running
    if [ "$running" = "false" ]; then
        if [ "$status" = "exited" ] || [ "$status" = "dead" ]; then
            echo "stopped"
        else
            echo "unhealthy"
        fi
        return
    fi

    # Container is running - check health status
    if [ "$health" = "healthy" ]; then
        echo "healthy"
    elif [ "$health" = "unhealthy" ]; then
        echo "unhealthy"
    elif [ "$health" = "starting" ]; then
        echo "starting"
    elif [ "$health" = "none" ]; then
        # No health check configured but container is running
        echo "healthy"
    else
        echo "$health"
    fi
}
```

**Validation**:
```bash
# Test script syntax
bash -n /home/pbrown/SkuInventory/docker/monitor/monitor.sh

# Test with mock docker command (manual verification)
```

**Completion Criteria**:
- [ ] Script has no syntax errors
- [ ] Returns "stopped" for exited containers
- [ ] Returns "not_found" for non-existent containers
- [ ] Returns "healthy" for running containers with no health check
- [ ] Returns correct health status for containers with health checks

## Phase 2: Update Type Definitions

### Subtask 2.1: Add New Status Values to ContainerStatus Type
**File**: `/home/pbrown/SkuInventory/src/types/container-health.ts`
**Pattern**: Current type definition (line 5)
**Instructions**:
1. Add "stopped" and "not_found" to ContainerStatus type
2. Keep existing values for backwards compatibility

**Current Code** (line 5):
```typescript
export type ContainerStatus = 'healthy' | 'unhealthy' | 'starting' | 'none' | 'unknown'
```

**New Code**:
```typescript
export type ContainerStatus = 'healthy' | 'unhealthy' | 'starting' | 'none' | 'unknown' | 'stopped' | 'not_found'
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] TypeScript compiles without errors
- [ ] New status values are available in type

## Phase 3: Improve Service Layer Status Detection

### Subtask 3.1: Add Real-Time Docker Status Check to API
**File**: `/home/pbrown/SkuInventory/src/services/container-health.ts`
**Pattern**: Current getContainerStatusSummary function (lines 225-276)
**Instructions**:
1. Improve status summary to provide better context when no health logs exist
2. Add logic to check if last health log is stale (older than 2x polling interval)
3. When status is "unknown", add metadata indicating why

**Key Changes**:
- If no health log exists, return "unknown" with `lastHealthCheck: null` (already works this way)
- Add `statusReason` field to ContainerStatusSummary to explain why status is what it is
- If last health log is older than 5 minutes, consider status potentially stale

**New Interface Addition** to `/home/pbrown/SkuInventory/src/types/container-health.ts`:
```typescript
export interface ContainerStatusSummary {
  containerName: string
  currentStatus: ContainerStatus
  lastHealthCheck: string | null
  recentEvents: ContainerEventEntry[]
  restartCount24h: number
  isRunning: boolean
  statusReason?: 'healthy' | 'unhealthy' | 'no_data' | 'stale_data' | 'container_stopped' | 'container_not_found'
}
```

**Update to getContainerStatusSummary** in `/home/pbrown/SkuInventory/src/services/container-health.ts`:
```typescript
// After getting latestHealth (around line 238), add status reason logic:
let statusReason: ContainerStatusSummary['statusReason'] = undefined

if (!latestHealth) {
  statusReason = 'no_data'
} else if (latestHealth.status === 'stopped') {
  statusReason = 'container_stopped'
} else if (latestHealth.status === 'not_found') {
  statusReason = 'container_not_found'
} else {
  // Check if data is stale (older than 5 minutes)
  const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000)
  if (latestHealth.createdAt < fiveMinutesAgo) {
    statusReason = 'stale_data'
  } else if (latestHealth.status === 'healthy') {
    statusReason = 'healthy'
  } else {
    statusReason = 'unhealthy'
  }
}

summaries.push({
  containerName,
  currentStatus: (latestHealth?.status as ContainerStatus) ?? 'unknown',
  lastHealthCheck: latestHealth?.createdAt.toISOString() ?? null,
  recentEvents: /* ... */,
  restartCount24h: restartCount,
  isRunning: latestHealth?.status === 'healthy' || latestHealth?.status === 'starting',
  statusReason,
})
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] TypeScript compiles without errors
- [ ] statusReason is properly set based on container state
- [ ] API returns statusReason in response

## Phase 4: Update Dashboard UI

### Subtask 4.1: Update ContainerStatusCard for New Status Values
**File**: `/home/pbrown/SkuInventory/src/components/features/DockerHealthDashboard.tsx`
**Pattern**: Current ContainerStatusCard function (lines 50-100)
**Instructions**:
1. Add icon and color handling for "stopped", "not_found", and "unknown" states
2. Display statusReason to help users understand why status is shown
3. Improve user feedback for each status type

**Update statusIcon logic** (lines 51-58):
```typescript
const statusIcon =
  container.currentStatus === 'healthy' ? (
    <CheckCircle className="h-5 w-5 text-green-600" />
  ) : container.currentStatus === 'unhealthy' ? (
    <XCircle className="h-5 w-5 text-destructive" />
  ) : container.currentStatus === 'stopped' || container.currentStatus === 'not_found' ? (
    <XCircle className="h-5 w-5 text-gray-500" />
  ) : container.currentStatus === 'unknown' ? (
    <AlertCircle className="h-5 w-5 text-gray-400" />
  ) : (
    <AlertCircle className="h-5 w-5 text-yellow-500" />
  )
```

**Update statusColor logic** (lines 59-63):
```typescript
const statusColor =
  container.currentStatus === 'healthy'
    ? 'bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400'
    : container.currentStatus === 'unhealthy'
    ? 'bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-400'
    : container.currentStatus === 'stopped' || container.currentStatus === 'not_found'
    ? 'bg-gray-100 text-gray-800 dark:bg-gray-900/20 dark:text-gray-400'
    : container.currentStatus === 'unknown'
    ? 'bg-gray-100 text-gray-600 dark:bg-gray-900/20 dark:text-gray-500'
    : 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-400'
```

**Add status explanation** (after line 80, inside CardContent):
```typescript
{container.statusReason && (
  <div className="flex items-center justify-between">
    <span className="text-sm text-muted-foreground">Info</span>
    <span className="text-xs text-muted-foreground">
      {container.statusReason === 'no_data' && 'Never checked'}
      {container.statusReason === 'stale_data' && 'Data may be stale'}
      {container.statusReason === 'container_stopped' && 'Container stopped'}
      {container.statusReason === 'container_not_found' && 'Container not found'}
    </span>
  </div>
)}
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
npm run lint
```

**Completion Criteria**:
- [ ] TypeScript compiles without errors
- [ ] Build completes successfully
- [ ] UI shows distinct colors for each status
- [ ] Status reason is displayed when applicable
- [ ] "stopped" and "not_found" show gray (inactive) color
- [ ] "unknown" shows neutral gray color
- [ ] "starting" shows yellow/warning color

## Phase 5: Update Prisma Schema Comment (Optional)

### Subtask 5.1: Update Schema Comment for Status Field
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Pattern**: ContainerHealthLog model status field comment
**Instructions**:
1. Update comment to reflect new status values

**Current** (around line with ContainerHealthLog.status):
```prisma
status        String   @db.VarChar(20) // "healthy", "unhealthy", "starting", "none", "unknown"
```

**New**:
```prisma
status        String   @db.VarChar(20) // "healthy", "unhealthy", "starting", "none", "unknown", "stopped", "not_found"
```

**Note**: This is just a comment update - no migration needed.

**Validation**:
```bash
npx prisma validate
```

**Completion Criteria**:
- [ ] Prisma validates schema successfully

---

## Summary of Deliverables

**Files Modified**: 5
1. `/home/pbrown/SkuInventory/docker/monitor/monitor.sh` - Improved status detection
2. `/home/pbrown/SkuInventory/src/types/container-health.ts` - Added new status values and statusReason
3. `/home/pbrown/SkuInventory/src/services/container-health.ts` - Added statusReason logic
4. `/home/pbrown/SkuInventory/src/components/features/DockerHealthDashboard.tsx` - UI updates
5. `/home/pbrown/SkuInventory/prisma/schema.prisma` - Comment update (optional)

**Files Created**: 0

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 through Phase 5)
2. Run validation commands after each subtask
3. Test completion criteria before next subtask
4. Follow reference patterns exactly
5. After all phases, rebuild the app and verify the dashboard

## Test Strategy Note

- Manual testing: Visit `/admin/docker-health` page to verify status display
- Unit tests: None specifically needed for this change (display logic only)
- E2E tests: Not needed for this minor enhancement

## Verification Steps (Post-Implementation)

1. Build the application: `npm run build`
2. Start test environment: `cd docker && docker compose -f docker-compose.test.yml up -d`
3. Access health dashboard: http://172.16.20.50:2345/admin/docker-health
4. Verify:
   - Containers with health checks show "healthy" or "unhealthy"
   - Stopped containers show "stopped" instead of "unknown"
   - Non-existent containers show "not_found"
   - Status reasons display in the UI
   - Colors are correct for each status

## Performance Metrics

| Phase | Duration |
|-------|----------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 10m |
| **Total** | **30m** |
