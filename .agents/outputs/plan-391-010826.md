# Implementation Plan

**Generated**: 2026-01-08
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #391
**Estimated Build Time**: 3-4 hours
**Complexity**: Medium

## Investigation Summary

### Request Analysis
**Type**: Bug
**Source**: GitHub Issue #391 - "Settings fail to load for Rise/Mella brands"
**Priority**: P1-MVP (High)

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="settings|auth|user"` or run affected API route tests

### Issue Validation
**Status**: Valid
**Recent Changes**: Issue #352 (commit 48c8d18) fixed Settings menu visibility to show for admins in ANY company, but did NOT update API routes to match

### Current State Assessment

**Root Cause Identified**:
The fix for issue #352 made the Settings menu visible when user is admin in ANY company (cross-company visibility), but the API routes still check if user is admin in the CURRENTLY SELECTED company. This creates a mismatch:

1. **UI Logic** (`src/app/(dashboard)/layout.tsx` line 83):
   ```typescript
   const isAdminInAnyCompany = session?.user?.companies?.some(c => c.role === 'admin') ?? false
   ```
   - Settings menu visible if user is admin in ANY company they have access to

2. **API Logic** (all settings routes):
   ```typescript
   const companyRole = getSelectedCompanyRole(session)
   if (companyRole !== 'admin') {
     return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
   }
   ```
   - API only works if user is admin in the CURRENTLY SELECTED company

**Data Verification**:
- User `pbrown@vital-enterprises.com` has `admin` for Tonsil Tech, but `ops` for Rise and Mella
- When switching to Rise/Mella, user sees Settings menu but API returns 403
- Rise and Mella have NO admin users assigned (all users are `ops`)

### Dependencies & Blockers
1. None - self-contained fix

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Moderate
**Effort**: 3-4 hours
**Risk**: Low - well-understood pattern, follows existing issue #352 fix approach

### Patterns Identified
**Primary**: `src/app/(dashboard)/layout.tsx` line 83 - `isAdminInAnyCompany` pattern
**Secondary**: `src/lib/auth.ts` - existing helper functions like `getSelectedCompanyRole`

### Ripple Effect Analysis

**Files Requiring Admin Check Update**: 13 API route files

Settings-related routes that need cross-company admin access:
1. `src/app/api/users/route.ts` - GET and POST (lines 28, 153)
2. `src/app/api/users/[id]/route.ts` - GET, PUT, DELETE (lines 30, 120, 254)
3. `src/app/api/users/[id]/companies/route.ts` - GET and POST (lines 30, 107)
4. `src/app/api/brands/route.ts` - GET and POST (lines 28, 143)
5. `src/app/api/brands/[id]/route.ts` - GET, PUT, DELETE (lines 29, 98, 231)
6. `src/app/api/categories/route.ts` - GET and POST (lines 27, 139)
7. `src/app/api/categories/[id]/route.ts` - GET, PUT, DELETE (lines 29, 99, 231)
8. `src/app/api/companies/route.ts` - GET and POST (lines 28, 117)
9. `src/app/api/companies/[id]/route.ts` - GET, PUT, DELETE (lines 29, 114, 323)
10. `src/app/api/locations/route.ts` - POST (line 112)
11. `src/app/api/locations/[id]/route.ts` - GET, PUT, DELETE (lines 30, 92, 219)
12. `src/app/api/settings/route.ts` - GET and PATCH (lines 31, 90)
13. `src/app/api/settings/alerts/route.ts` - GET and PATCH (lines 36, 78)

**New File**: `src/lib/auth.ts` - add helper function

**TOTAL FILES AFFECTED**: 14 files (1 new function + 13 route updates)

---

## Executive Summary

The Settings menu is correctly shown when a user is admin in ANY accessible company (cross-company visibility per issue #352 fix). However, the API routes still require admin role in the CURRENTLY SELECTED company, causing 403 errors when switching to companies where the user has `ops` role.

The fix adds a new `isAdminInAnyCompany()` helper function and updates all settings-related API routes to use this cross-company admin check instead of the company-specific `getSelectedCompanyRole()` check.

---

## Phase 1: Auth Library Update

### Subtask 1.1: Add isAdminInAnyCompany Helper Function

**File**: `/home/pbrown/SkuInventory/src/lib/auth.ts`
**Location**: After `getSelectedCompanyRole` function (around line 418)
**Pattern**: Follow existing helper function pattern in same file

**Instructions**:
1. Add new helper function after `getSelectedCompanyRole`:

```typescript
/**
 * Check if user is admin in ANY company they have access to
 * Used for cross-company admin features like Settings management
 * This matches the UI logic in layout.tsx for Settings menu visibility
 */
export function isAdminInAnyCompany(
  session: { user: { companies: Array<{ id: string; role?: string }> } }
): boolean {
  return session.user.companies.some((c) => c.role === 'admin')
}
```

**Completion Criteria**:
- [ ] Function added to `/home/pbrown/SkuInventory/src/lib/auth.ts`
- [ ] TypeScript compiles without errors: `npx tsc --noEmit`
- [ ] Function is exported

---

## Phase 2: API Route Updates

For each route, replace:
```typescript
const companyRole = getSelectedCompanyRole(session)
if (companyRole !== 'admin') {
  return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
}
```

With:
```typescript
if (!isAdminInAnyCompany(session)) {
  return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
}
```

**Note**: Import `isAdminInAnyCompany` in each file: `import { authOptions, isAdminInAnyCompany } from '@/lib/auth'`

### Subtask 2.1: Update Users Route

**File**: `/home/pbrown/SkuInventory/src/app/api/users/route.ts`
**Lines**: 4, 27-29, 152-154

**Instructions**:
1. Update import on line 4 to add `isAdminInAnyCompany`:
   ```typescript
   import { authOptions, isAdminInAnyCompany } from '@/lib/auth'
   ```
2. Replace lines 27-29 (GET) with:
   ```typescript
   if (!isAdminInAnyCompany(session)) {
     return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
   }
   ```
3. Replace lines 152-154 (POST) with same pattern

**Completion Criteria**:
- [ ] Import updated
- [ ] GET handler updated
- [ ] POST handler updated
- [ ] TypeScript compiles: `npx tsc --noEmit`

### Subtask 2.2: Update Users [id] Route

**File**: `/home/pbrown/SkuInventory/src/app/api/users/[id]/route.ts`
**Lines**: 4, 29-31, 119-121, 253-255

**Instructions**:
1. Update import to add `isAdminInAnyCompany`
2. Replace admin checks in GET, PUT, DELETE handlers

**Completion Criteria**:
- [ ] Import updated
- [ ] GET handler updated (line ~30)
- [ ] PUT handler updated (line ~120)
- [ ] DELETE handler updated (line ~254)
- [ ] TypeScript compiles

### Subtask 2.3: Update Users [id]/companies Route

**File**: `/home/pbrown/SkuInventory/src/app/api/users/[id]/companies/route.ts`
**Lines**: Similar pattern

**Instructions**:
1. Update import to add `isAdminInAnyCompany`
2. Replace admin checks in GET and POST handlers

**Completion Criteria**:
- [ ] Import updated
- [ ] GET handler updated
- [ ] POST handler updated
- [ ] TypeScript compiles

### Subtask 2.4: Update Brands Route

**File**: `/home/pbrown/SkuInventory/src/app/api/brands/route.ts`
**Lines**: 3, 27-29, 142-144

**Instructions**:
1. Update import to add `isAdminInAnyCompany`
2. Replace admin checks in GET and POST handlers

**Completion Criteria**:
- [ ] Import updated
- [ ] GET handler updated
- [ ] POST handler updated
- [ ] TypeScript compiles

### Subtask 2.5: Update Brands [id] Route

**File**: `/home/pbrown/SkuInventory/src/app/api/brands/[id]/route.ts`

**Instructions**:
1. Update import to add `isAdminInAnyCompany`
2. Replace admin checks in GET, PUT, DELETE handlers

**Completion Criteria**:
- [ ] Import updated
- [ ] All handlers updated
- [ ] TypeScript compiles

### Subtask 2.6: Update Categories Route

**File**: `/home/pbrown/SkuInventory/src/app/api/categories/route.ts`

**Instructions**:
1. Update import to add `isAdminInAnyCompany`
2. Replace admin checks in GET and POST handlers

**Completion Criteria**:
- [ ] Import updated
- [ ] All handlers updated
- [ ] TypeScript compiles

### Subtask 2.7: Update Categories [id] Route

**File**: `/home/pbrown/SkuInventory/src/app/api/categories/[id]/route.ts`

**Instructions**:
1. Update import to add `isAdminInAnyCompany`
2. Replace admin checks in GET, PUT, DELETE handlers

**Completion Criteria**:
- [ ] Import updated
- [ ] All handlers updated
- [ ] TypeScript compiles

### Subtask 2.8: Update Companies Route

**File**: `/home/pbrown/SkuInventory/src/app/api/companies/route.ts`

**Instructions**:
1. Update import to add `isAdminInAnyCompany`
2. Replace admin checks in GET and POST handlers

**Completion Criteria**:
- [ ] Import updated
- [ ] All handlers updated
- [ ] TypeScript compiles

### Subtask 2.9: Update Companies [id] Route

**File**: `/home/pbrown/SkuInventory/src/app/api/companies/[id]/route.ts`

**Instructions**:
1. Update import to add `isAdminInAnyCompany`
2. Replace admin checks in GET, PUT, DELETE handlers

**Completion Criteria**:
- [ ] Import updated
- [ ] All handlers updated
- [ ] TypeScript compiles

### Subtask 2.10: Update Locations Route

**File**: `/home/pbrown/SkuInventory/src/app/api/locations/route.ts`

**Instructions**:
1. Update import to add `isAdminInAnyCompany`
2. Replace admin check in POST handler (line ~112)
3. Note: GET does NOT require admin - leave unchanged

**Completion Criteria**:
- [ ] Import updated
- [ ] POST handler updated
- [ ] GET handler left unchanged
- [ ] TypeScript compiles

### Subtask 2.11: Update Locations [id] Route

**File**: `/home/pbrown/SkuInventory/src/app/api/locations/[id]/route.ts`

**Instructions**:
1. Update import to add `isAdminInAnyCompany`
2. Replace admin checks in GET, PUT, DELETE handlers

**Completion Criteria**:
- [ ] Import updated
- [ ] All handlers updated
- [ ] TypeScript compiles

### Subtask 2.12: Update Settings Route

**File**: `/home/pbrown/SkuInventory/src/app/api/settings/route.ts`

**Instructions**:
1. Update import to add `isAdminInAnyCompany`
2. Replace admin checks in GET and PATCH handlers

**Completion Criteria**:
- [ ] Import updated
- [ ] All handlers updated
- [ ] TypeScript compiles

### Subtask 2.13: Update Settings Alerts Route

**File**: `/home/pbrown/SkuInventory/src/app/api/settings/alerts/route.ts`

**Instructions**:
1. Update import to add `isAdminInAnyCompany`
2. Replace admin checks in GET and PATCH handlers

**Completion Criteria**:
- [ ] Import updated
- [ ] All handlers updated
- [ ] TypeScript compiles

---

## Phase 3: Validation

### Subtask 3.1: Build and Type Check

**Instructions**:
```bash
cd /home/pbrown/SkuInventory
npx tsc --noEmit
npm run build
npm run lint
```

**Completion Criteria**:
- [ ] TypeScript compiles without errors
- [ ] Next.js build succeeds
- [ ] Lint passes

### Subtask 3.2: Run Related Tests

**Instructions**:
```bash
cd /home/pbrown/SkuInventory
npm test -- --testPathPattern="(auth|users|brands|categories|companies|locations|settings)"
```

**Completion Criteria**:
- [ ] All related tests pass

---

## Summary of Deliverables

**Files Created**: 0
**Files Modified**: 14

| File | Change |
|------|--------|
| `src/lib/auth.ts` | Add `isAdminInAnyCompany` helper function |
| `src/app/api/users/route.ts` | Update admin check to cross-company |
| `src/app/api/users/[id]/route.ts` | Update admin check to cross-company |
| `src/app/api/users/[id]/companies/route.ts` | Update admin check to cross-company |
| `src/app/api/brands/route.ts` | Update admin check to cross-company |
| `src/app/api/brands/[id]/route.ts` | Update admin check to cross-company |
| `src/app/api/categories/route.ts` | Update admin check to cross-company |
| `src/app/api/categories/[id]/route.ts` | Update admin check to cross-company |
| `src/app/api/companies/route.ts` | Update admin check to cross-company |
| `src/app/api/companies/[id]/route.ts` | Update admin check to cross-company |
| `src/app/api/locations/route.ts` | Update admin check to cross-company |
| `src/app/api/locations/[id]/route.ts` | Update admin check to cross-company |
| `src/app/api/settings/route.ts` | Update admin check to cross-company |
| `src/app/api/settings/alerts/route.ts` | Update admin check to cross-company |

---

## Test Strategy Note

- Use Vitest for unit tests
- Test pattern: Verify user with admin in Company A can access settings when switched to Company B (where they have ops role)
- E2E tests should verify settings pages load for Rise/Mella companies

---

## Design Decision Rationale

**Why cross-company admin access for Settings?**

Per issue #352 fix, the design intent is that Settings is a "cross-company feature" - if you're an admin in any company, you should be able to manage settings for all companies you have access to. This enables:
1. Single admin managing multiple company brands
2. Consistent UX - menu visibility matches API access
3. Simplified permission model for small organizations

**Routes NOT updated (intentionally)**:
- Integration routes (Amazon, Shopify) - these are company-specific operations
- Data routes (SKUs, Components, Transactions) - these are company-scoped data
- Other admin features (thresholds, alerts/defects, forecasts) - need separate analysis

---

## Performance Metrics

| Phase | Estimated Duration |
|-------|----------|
| Investigation | 25m |
| Validation | 5m |
| Planning | 15m |
| **Total** | **45m** |
