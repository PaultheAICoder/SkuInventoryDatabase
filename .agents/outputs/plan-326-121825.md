# Implementation Plan
**Generated**: 2025-12-18T12:30:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #326
**Estimated Build Time**: 2-3 hours
**Complexity**: Low

---

## Investigation Summary

### Request Analysis
**Type**: Refactoring / Bug Fix
**Source**: GitHub Issue #326
**Priority**: Medium

### Task Classification
**Category**: REFACTORING
**Test Strategy**: FAST_PATH (Smoke tests only - low-risk refactoring)
**Suggested Filter**: None

### Issue Validation
**Status**: Valid
**Recent Changes**: Issue #324 previously fixed this pattern in `users/route.ts` and `forecasts/config/route.ts` - those files now have the correct pattern to use as reference.

### Problem Description
Several API routes check `getSelectedCompanyRole(session)` BEFORE checking if `selectedCompanyId` exists. This causes:
- When no company is selected: returns 403 Forbidden (incorrect)
- Expected behavior: return 400 Bad Request with "No company selected" message

The correct order is:
1. Check `session?.user` exists (401 Unauthorized if not)
2. Check `selectedCompanyId` exists (400 Bad Request if not)
3. Check role permission (403 Forbidden if insufficient)

### Current State Assessment

**Files with CORRECT pattern (reference):**
- `/home/pbrown/SkuInventory/src/app/api/users/route.ts` - GET and POST methods
- `/home/pbrown/SkuInventory/src/app/api/forecasts/config/route.ts` - GET and PUT methods

**Files with INCORRECT pattern (to fix per issue #326):**
1. `/home/pbrown/SkuInventory/src/app/api/brands/route.ts` - GET (line 18) and POST (line 127)
2. `/home/pbrown/SkuInventory/src/app/api/categories/route.ts` - GET (line 17) and POST (line 123)
3. `/home/pbrown/SkuInventory/src/app/api/chatbot/route.ts` - POST (line 17)
4. `/home/pbrown/SkuInventory/src/app/api/companies/route.ts` - GET (line 17) and POST (line 97)
5. `/home/pbrown/SkuInventory/src/app/api/settings/route.ts` - GET (line 21) and PATCH (line 74)
6. `/home/pbrown/SkuInventory/src/app/api/sync-logs/route.ts` - GET (line 23)
7. `/home/pbrown/SkuInventory/src/app/api/locations/route.ts` - POST only (line 102) - GET does not have role check

**Additional files with same pattern (discovered during comprehensive sweep):**
Based on the pattern scan, the following additional files have the same issue but were NOT listed in the original issue. These use `selectedCompanyId` AFTER the role check:
- `/home/pbrown/SkuInventory/src/app/api/brands/[id]/route.ts` - GET, PATCH, DELETE
- `/home/pbrown/SkuInventory/src/app/api/categories/[id]/route.ts` - GET, PATCH, DELETE
- `/home/pbrown/SkuInventory/src/app/api/companies/[id]/route.ts` - GET, PATCH, DELETE (note: companies route doesn't use selectedCompanyId in same way)
- `/home/pbrown/SkuInventory/src/app/api/locations/[id]/route.ts` - GET, PATCH, DELETE
- `/home/pbrown/SkuInventory/src/app/api/users/[id]/route.ts` - GET, PATCH, DELETE
- `/home/pbrown/SkuInventory/src/app/api/users/[id]/companies/route.ts` - GET, PUT
- `/home/pbrown/SkuInventory/src/app/api/settings/alerts/route.ts` - GET, PATCH
- `/home/pbrown/SkuInventory/src/app/api/settings/alerts/test/route.ts` - POST
- `/home/pbrown/SkuInventory/src/app/api/integrations/amazon-ads/connect/route.ts` - POST
- `/home/pbrown/SkuInventory/src/app/api/integrations/amazon-ads/sync/route.ts` - POST
- `/home/pbrown/SkuInventory/src/app/api/integrations/amazon-ads/disconnect/route.ts` - DELETE
- `/home/pbrown/SkuInventory/src/app/api/integrations/shopify/connect/route.ts` - POST
- `/home/pbrown/SkuInventory/src/app/api/integrations/shopify/sync/route.ts` - POST
- `/home/pbrown/SkuInventory/src/app/api/integrations/shopify/disconnect/route.ts` - DELETE

**Decision**: Fix ONLY the files listed in issue #326. The additional files should be addressed in a separate follow-up issue to avoid scope creep.

### Dependencies & Blockers
None identified. This is a straightforward refactoring task.

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Simple
**Effort**: 2-3 hours
**Risk**: Low - pattern already established in fixed files, no database changes, no type changes

### Patterns Identified
**Primary Reference**: `/home/pbrown/SkuInventory/src/app/api/users/route.ts` (lines 18-30)
```typescript
// Check selectedCompanyId BEFORE role check to return proper 400 error
const selectedCompanyId = session.user.selectedCompanyId
if (!selectedCompanyId) {
  return NextResponse.json(
    { error: 'No company selected. Please refresh the page and try again.' },
    { status: 400 }
  )
}

const companyRole = getSelectedCompanyRole(session)
if (companyRole !== 'admin') {
  return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
}
```

**Secondary Reference**: `/home/pbrown/SkuInventory/src/app/api/forecasts/config/route.ts` (uses api-response helpers)
```typescript
const selectedCompanyId = session.user.selectedCompanyId
if (!selectedCompanyId) {
  return error('No company selected. Please select a company from the sidebar.', 400)
}

const companyRole = getSelectedCompanyRole(session)
if (companyRole !== 'admin') {
  return forbidden()
}
```

### Ripple Effect Analysis
**Files Identified**: 7 (as listed in issue)
**Impact**: None - this is an internal refactoring that changes the order of checks but not the overall behavior for valid requests.

---

## Executive Summary
This refactoring task fixes the validation order in 7 API route files to check `selectedCompanyId` before the role check. This ensures users without a selected company receive the correct 400 Bad Request error instead of an incorrect 403 Forbidden error. The pattern has already been successfully implemented in `users/route.ts` and `forecasts/config/route.ts`.

---

## Phase 1: Fix Core API Routes

### Subtask 1.1: Fix brands/route.ts
**File**: `/home/pbrown/SkuInventory/src/app/api/brands/route.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/app/api/users/route.ts` lines 18-30

**Instructions for GET method (starting at line 18):**
1. Move the `selectedCompanyId` check (currently at line 36) to BEFORE the role check
2. Add the early return with 400 status for missing selectedCompanyId
3. Keep the role check after

**Current code (lines 18-36):**
```typescript
const companyRole = getSelectedCompanyRole(session)
if (companyRole !== 'admin') {
  return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
}

const searchParams = Object.fromEntries(request.nextUrl.searchParams)
// ... validation ...

// Use selected company for scoping
const selectedCompanyId = session.user.selectedCompanyId
```

**New code pattern:**
```typescript
// Check selectedCompanyId BEFORE role check to return proper 400 error
const selectedCompanyId = session.user.selectedCompanyId
if (!selectedCompanyId) {
  return NextResponse.json(
    { error: 'No company selected. Please refresh the page and try again.' },
    { status: 400 }
  )
}

const companyRole = getSelectedCompanyRole(session)
if (companyRole !== 'admin') {
  return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
}

const searchParams = Object.fromEntries(request.nextUrl.searchParams)
```

**Instructions for POST method (starting at line 127):**
1. Same pattern - move selectedCompanyId check (at line 145) before role check
2. Add early return with 400 status

**Validation commands:**
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria:**
- [ ] GET method has selectedCompanyId check before role check
- [ ] POST method has selectedCompanyId check before role check
- [ ] TypeScript compiles without errors
- [ ] Build succeeds

---

### Subtask 1.2: Fix categories/route.ts
**File**: `/home/pbrown/SkuInventory/src/app/api/categories/route.ts`
**Pattern**: Same as Subtask 1.1

**Instructions for GET method (lines 17-35):**
1. Move `selectedCompanyId` check (line 35) before role check (line 17)
2. Add 400 error return

**Instructions for POST method (lines 123-141):**
1. Move `selectedCompanyId` check (line 141) before role check (line 123)
2. Add 400 error return

**Completion Criteria:**
- [ ] GET method has selectedCompanyId check before role check
- [ ] POST method has selectedCompanyId check before role check
- [ ] TypeScript compiles without errors

---

### Subtask 1.3: Fix chatbot/route.ts
**File**: `/home/pbrown/SkuInventory/src/app/api/chatbot/route.ts`
**Pattern**: Same as Subtask 1.1

**Instructions for POST method (lines 17-33):**
1. Move `const companyId = session.user.selectedCompanyId` (line 33) before role check (line 17)
2. Rename `companyId` to `selectedCompanyId` for consistency
3. Add 400 error return if not set

**Current code:**
```typescript
// Admin-only access
const companyRole = getSelectedCompanyRole(session)
if (companyRole !== 'admin') {
  return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
}

const body = await request.json()
// ...
const companyId = session.user.selectedCompanyId
```

**New code pattern:**
```typescript
// Check selectedCompanyId BEFORE role check to return proper 400 error
const selectedCompanyId = session.user.selectedCompanyId
if (!selectedCompanyId) {
  return NextResponse.json(
    { error: 'No company selected. Please refresh the page and try again.' },
    { status: 400 }
  )
}

// Admin-only access
const companyRole = getSelectedCompanyRole(session)
if (companyRole !== 'admin') {
  return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
}

const body = await request.json()
// ...
// Use selectedCompanyId (already defined above) in sendChatMessage call
const response = await sendChatMessage(message, [], selectedCompanyId)
```

**Completion Criteria:**
- [ ] POST method has selectedCompanyId check before role check
- [ ] Variable renamed for consistency
- [ ] TypeScript compiles without errors

---

### Subtask 1.4: Fix companies/route.ts
**File**: `/home/pbrown/SkuInventory/src/app/api/companies/route.ts`
**Pattern**: Same as Subtask 1.1

**Special Note**: The companies route is for global admin functionality (listing ALL companies). However, the `getSelectedCompanyRole` check still requires a selectedCompanyId to determine the user's role. So we need the selectedCompanyId check first.

**Instructions for GET method (lines 17-34):**
1. Add selectedCompanyId check before role check (line 17)
2. Note: This route doesn't use selectedCompanyId for scoping (it's global), but needs it for role check

**Instructions for POST method (lines 97-101):**
1. Add selectedCompanyId check before role check (line 97)

**Completion Criteria:**
- [ ] GET method has selectedCompanyId check before role check
- [ ] POST method has selectedCompanyId check before role check
- [ ] TypeScript compiles without errors

---

### Subtask 1.5: Fix settings/route.ts
**File**: `/home/pbrown/SkuInventory/src/app/api/settings/route.ts`
**Pattern**: Same as Subtask 1.1

**Instructions for GET method (lines 21-27):**
1. Move selectedCompanyId check (line 27) before role check (line 21)
2. Add 400 error return

**Instructions for PATCH method (lines 74-80):**
1. Move selectedCompanyId check (line 80) before role check (line 74)
2. Add 400 error return

**Completion Criteria:**
- [ ] GET method has selectedCompanyId check before role check
- [ ] PATCH method has selectedCompanyId check before role check
- [ ] TypeScript compiles without errors

---

### Subtask 1.6: Fix sync-logs/route.ts
**File**: `/home/pbrown/SkuInventory/src/app/api/sync-logs/route.ts`
**Pattern**: Same as Subtask 1.1

**Instructions for GET method (lines 23-38):**
1. Move `const companyId = session.user.selectedCompanyId` (line 38) before role check (line 23)
2. Rename to `selectedCompanyId` for consistency
3. Add 400 error return if not set

**Completion Criteria:**
- [ ] GET method has selectedCompanyId check before role check
- [ ] Variable renamed for consistency
- [ ] TypeScript compiles without errors

---

### Subtask 1.7: Fix locations/route.ts (POST only)
**File**: `/home/pbrown/SkuInventory/src/app/api/locations/route.ts`
**Pattern**: Same as Subtask 1.1

**Note**: Only POST method needs fixing (line 102). GET method does not have a role check.

**Instructions for POST method (lines 102-120):**
1. Move selectedCompanyId check (line 120) before role check (line 102)
2. Add 400 error return

**Completion Criteria:**
- [ ] POST method has selectedCompanyId check before role check
- [ ] TypeScript compiles without errors

---

## Phase 2: Validation

### Subtask 2.1: Full Build Verification
**Instructions:**
1. Run TypeScript check: `npx tsc --noEmit`
2. Run full build: `npm run build`
3. Run lint: `npm run lint`

**Completion Criteria:**
- [ ] No TypeScript errors
- [ ] Build completes successfully
- [ ] No lint errors

### Subtask 2.2: Manual Verification (Optional)
**Instructions:**
If test server is available, verify one of the routes:
1. Log in as admin
2. Clear selectedCompanyId (if possible via dev tools)
3. Call one of the fixed routes
4. Verify response is 400 Bad Request, not 403 Forbidden

---

## Summary of Deliverables
**Files Created**: 0
**Files Modified**: 7

| File | Methods Modified |
|------|------------------|
| `/home/pbrown/SkuInventory/src/app/api/brands/route.ts` | GET, POST |
| `/home/pbrown/SkuInventory/src/app/api/categories/route.ts` | GET, POST |
| `/home/pbrown/SkuInventory/src/app/api/chatbot/route.ts` | POST |
| `/home/pbrown/SkuInventory/src/app/api/companies/route.ts` | GET, POST |
| `/home/pbrown/SkuInventory/src/app/api/settings/route.ts` | GET, PATCH |
| `/home/pbrown/SkuInventory/src/app/api/sync-logs/route.ts` | GET |
| `/home/pbrown/SkuInventory/src/app/api/locations/route.ts` | POST |

---

## Handoff to Build Agent
1. Execute subtasks in order (1.1 through 1.7, then 2.1)
2. For each file:
   - Read the file first
   - Identify the role check and selectedCompanyId usage
   - Move selectedCompanyId check before role check
   - Add early return with 400 status if missing
3. After all files are modified, run validation (2.1)
4. Follow reference pattern from `/home/pbrown/SkuInventory/src/app/api/users/route.ts` exactly

---

## Test Strategy Note
- FAST_PATH: No targeted tests needed - this is a low-risk refactoring
- Smoke test: Build must pass (`npm run build`)
- Existing integration tests should continue to pass (they use valid sessions)

---

## Follow-up Issue Recommended
Create a new GitHub issue to address the same pattern in additional files discovered during investigation:
- `brands/[id]/route.ts`, `categories/[id]/route.ts`, `locations/[id]/route.ts`
- `users/[id]/route.ts`, `users/[id]/companies/route.ts`
- `companies/[id]/route.ts`
- `settings/alerts/route.ts`, `settings/alerts/test/route.ts`
- Integration routes (`amazon-ads/*`, `shopify/*`)

---

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 10m |
| **Total** | **30m** |
