# Build Agent Report
**Generated**: 2025-12-17T06:58:00Z
**Task**: GitHub Issue #295 - Fix PUT /api/users/[id]/companies to preserve existing UserCompany roles
**Status**: Complete
**Completion**: 2 of 2 phases (100%)

## Executive Summary
Fixed the bug in the PUT `/api/users/[id]/companies` route where roles were being hardcoded based on primary company status instead of preserving existing roles. Added comprehensive regression tests to verify role preservation behavior.

## Execution Log

### Phase 1: Fix API Route

#### Subtask 1.1: Preserve existing roles in PUT handler
**Status**: Completed
**Files Modified**:
- `/home/pbrown/SkuInventory/src/app/api/users/[id]/companies/route.ts`

**Changes Made**:
1. Added code to fetch existing UserCompany roles before deletion:
   ```typescript
   const existingUserCompanies = await tx.userCompany.findMany({
     where: { userId: id },
     select: { companyId: true, role: true },
   })
   const existingRoles = new Map(
     existingUserCompanies.map((uc) => [uc.companyId, uc.role])
   )
   ```

2. Modified role assignment to use preserved roles with 'ops' as default for new companies:
   ```typescript
   role: existingRoles.get(companyId) ?? UserRole.ops,
   ```

3. Removed the unused `userPrimaryCompanyId` variable

**Validation Results**:
- `npx tsc --noEmit`: Passed (no errors)
- `npm run build`: Passed
- `npm run lint`: Passed

**Completion Criteria**:
- [x] TypeScript compiles without errors
- [x] Build completes successfully
- [x] Existing roles are fetched before deletion
- [x] Roles are preserved when recreating UserCompany records
- [x] New company assignments default to 'ops' role

### Phase 2: Add Regression Tests

#### Subtask 2.1: Create user companies integration test file
**Status**: Completed
**Files Created**:
- `/home/pbrown/SkuInventory/tests/integration/user-companies.test.ts`

**Test Coverage**:
12 tests total covering:

1. **GET /api/users/[id]/companies**:
   - Returns user company assignments with roles
   - Returns 403 for non-admin users
   - Returns 401 for unauthenticated requests

2. **PUT /api/users/[id]/companies - Role Preservation**:
   - Preserves admin role when adding new company (core bug fix test)
   - Preserves admin role for non-primary companies (core bug fix test)
   - Preserves viewer role when updating companies
   - Assigns default ops role to newly added companies
   - Preserves roles when removing and re-adding companies
   - Returns 403 for non-admin users
   - Returns 401 for unauthenticated requests
   - Returns 400 for non-existent company IDs
   - Returns 400 for invalid UUID format

**Validation Results**:
```
npm run test:integration -- tests/integration/user-companies.test.ts

Test Files  1 passed (1)
Tests       12 passed (12)
Duration    5.30s
```

**Completion Criteria**:
- [x] Test file created following project patterns
- [x] Test for admin role preservation on non-primary company
- [x] Test for new company defaulting to ops
- [x] All tests pass

## Docker Container Rebuild
- [x] `docker compose build app` completed successfully
- [x] `docker compose up -d app` started successfully
- [x] Container health check: **healthy**
- [x] Application logs show no errors or warnings

## Final Verification
- [x] All phases addressed
- [x] Schema consistency verified (no schema changes required)
- [x] TypeScript compiles (zero warnings)
- [x] API routes respond correctly
- [x] Build passes
- [x] Lint passes
- [x] All tests pass
- [x] Docker container rebuilt and healthy

## Summary
**Phases Completed**: 2 of 2
**Files Created**: 1
- `/home/pbrown/SkuInventory/tests/integration/user-companies.test.ts`

**Files Modified**: 1
- `/home/pbrown/SkuInventory/src/app/api/users/[id]/companies/route.ts`

**Blockers for Test Agent**: None

**Pre-existing Test Failures**: The integration test suite has pre-existing failures in unrelated test files:
- `tests/integration/lot-consumption.test.ts` (6 failures)
- `tests/integration/tenant-scoping.test.ts` (2 failures)

These failures are NOT related to the changes made in this issue. The user-companies.test.ts file passes all 12 tests.

## Test Strategy Recommendation
**Category**: BUG_FIX
**Strategy**: TARGETED
**Filter**: `tests/integration/user-companies.test.ts`
**Behavioral Changes**: YES - API now preserves existing roles instead of hardcoding them

## Additional Files Discovered (Not in Plan)
**Count**: 0 files beyond Plan's 2 files

The Plan correctly identified all affected files. No additional files were discovered during implementation.

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Plan Review | 2m |
| Phase 1 (API Fix) | 3m |
| Phase 2 (Tests) | 8m |
| Docker Rebuild | 2m |
| Validation | 2m |
| **Total** | **17m** |

## Code Changes

### Route Handler Fix (`src/app/api/users/[id]/companies/route.ts`)

Before (buggy):
```typescript
const userPrimaryCompanyId = currentPrimary?.companyId

await tx.userCompany.deleteMany({ where: { userId: id } })

const userCompanyRecords = companyIds.map((companyId) => ({
  userId: id,
  companyId,
  role: userPrimaryCompanyId === companyId ? UserRole.admin : UserRole.ops,  // BUG: hardcodes roles
  isPrimary: companyId === newPrimaryCompanyId,
}))
```

After (fixed):
```typescript
const existingUserCompanies = await tx.userCompany.findMany({
  where: { userId: id },
  select: { companyId: true, role: true },
})
const existingRoles = new Map(
  existingUserCompanies.map((uc) => [uc.companyId, uc.role])
)

await tx.userCompany.deleteMany({ where: { userId: id } })

const userCompanyRecords = companyIds.map((companyId) => ({
  userId: id,
  companyId,
  role: existingRoles.get(companyId) ?? UserRole.ops,  // FIX: preserves existing roles
  isPrimary: companyId === newPrimaryCompanyId,
}))
```

The fix ensures that:
1. Existing roles are captured before deletion
2. When recreating records, existing roles are preserved
3. Only new company assignments get the default 'ops' role
