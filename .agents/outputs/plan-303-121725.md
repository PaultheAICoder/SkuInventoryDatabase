# Implementation Plan
**Generated**: 2025-12-17T10:30:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: Issue #303
**Estimated Build Time**: 4-6 hours
**Complexity**: Medium

## Investigation Summary

### Request Analysis
**Type**: Enhancement / Refactoring
**Source**: GitHub Issue #303
**Priority**: Medium

### Task Classification
**Category**: REFACTORING
**Test Strategy**: TARGETED (lot-selection and inventory-related tests ~5-10 min)
**Suggested Filter**: `--filter="lot|inventory|build"`

### Issue Validation
**Status**: Valid
**Recent Changes**: Issue #84 (2025-12-04) created the initial `lot-selection.ts` service but did not consolidate all FEFO logic

### Current State Assessment

#### Existing Components

1. **`src/services/lot-selection.ts`** (264 lines) - ALREADY EXISTS with:
   - `getAvailableLotsForComponent()` - Gets lots ordered by FEFO
   - `selectLotsForConsumption()` - Selects lots for consumption
   - `checkLotAvailabilityForBuild()` - Pre-check for build operations
   - `validateLotOverrides()` - Validates manual lot overrides
   - **LIMITATION**: Uses global `prisma` client, NOT transaction-aware

2. **Duplicated FEFO Logic in `src/services/inventory.ts`**:
   - `checkExpiredLotsForBuild()` (lines 718-783) - Duplicates FEFO sorting logic
   - `createBuildTransaction()` (lines 963-1008) - Duplicates FEFO selection logic within `prisma.$transaction()`

3. **Duplicated FEFO Logic in `src/services/transaction-edit.ts`**:
   - `editBuildTransaction()` (lines 618-692) - Duplicates FEFO selection logic within `prisma.$transaction()`

4. **Missing FEFO Logic in `src/services/draft-transaction.ts`**:
   - `approveDraftTransaction()` (lines 557-610) - Does NOT use FEFO lot selection for build approval
   - This is a BUG: builds approved from drafts don't consume lots correctly

#### Database
- **Lot** model exists with `expiryDate`, `componentId`, `lotNumber`
- **LotBalance** model exists with `quantity`, `reservedQuantity`
- No schema changes needed

#### API Routes
- `/api/skus/[id]/lot-availability` - Uses `checkLotAvailabilityForBuild()` correctly
- No API changes needed

#### Types
- Existing types in `src/types/transaction.ts`: `LotSelection`, `ComponentLotOverride`
- May need new types for transaction-aware selection

### Dependencies & Blockers
1. None - all dependencies exist

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Medium
**Effort**: 4-6 hours
**Risk**: Medium (refactoring core inventory logic, need comprehensive testing)

### Patterns Identified
**Primary**: `src/services/lot-selection.ts` (existing service to extend)
**Secondary**: `src/services/inventory.ts:updateInventoryBalance()` (pattern for transaction-aware functions)

### Ripple Effect Analysis
**Files Identified**: 6

| File | Why Affected |
|------|--------------|
| `src/services/lot-selection.ts` | Add transaction-aware FEFO functions |
| `src/services/inventory.ts` | Remove duplicated FEFO logic, use centralized service |
| `src/services/transaction-edit.ts` | Remove duplicated FEFO logic, use centralized service |
| `src/services/draft-transaction.ts` | Add FEFO lot consumption for build approvals |
| `tests/unit/lot-selection.test.ts` | Add tests for new transaction-aware functions |
| `tests/integration/lot-consumption.test.ts` | Verify integration still works |

---

## Executive Summary

This enhancement consolidates duplicated FEFO (First-Expiry-First-Out) lot selection logic into the existing `lot-selection.ts` service. Currently, the FEFO sorting and selection algorithm is duplicated in three files (`lot-selection.ts`, `inventory.ts`, `transaction-edit.ts`) and missing entirely from `draft-transaction.ts`. The refactoring will:

1. Add transaction-aware versions of FEFO functions that accept a `Prisma.TransactionClient`
2. Replace duplicated logic in `inventory.ts` and `transaction-edit.ts` with calls to the centralized service
3. Add missing FEFO lot consumption to draft transaction approval
4. Ensure estimates (pre-check) and actual consumption always use the same algorithm

---

## Phase 1: Extend Lot Selection Service with Transaction-Aware Functions

### Subtask 1.1: Add Transaction-Aware FEFO Selection Function
**File**: `/home/pbrown/SkuInventory/src/services/lot-selection.ts`
**Pattern**: Follow existing function signatures with added `tx` parameter

**Instructions**:
1. Import `Prisma` type for `TransactionClient`:
   ```typescript
   import { prisma } from '@/lib/db'
   import { Prisma } from '@prisma/client'
   ```

2. Add new function `getAvailableLotsForComponentTx()` that accepts a transaction client:
   ```typescript
   /**
    * Transaction-aware version of getAvailableLotsForComponent
    * Use within prisma.$transaction() for atomic operations
    */
   export async function getAvailableLotsForComponentTx(
     tx: Prisma.TransactionClient,
     componentId: string,
     options?: LotSelectionOptions
   ): Promise<Array<{
     lotId: string
     lotNumber: string
     availableQuantity: number
     expiryDate: Date | null
     isExpired: boolean
   }>>
   ```

3. Extract the core FEFO sorting logic into a reusable helper function:
   ```typescript
   /**
    * Sort lots using FEFO algorithm (earliest expiry first, nulls last)
    */
   function sortLotsByFEFO<T extends { expiryDate: Date | null }>(lots: T[]): T[] {
     return [...lots].sort((a, b) => {
       if (a.expiryDate === null && b.expiryDate === null) return 0
       if (a.expiryDate === null) return 1 // nulls to end
       if (b.expiryDate === null) return -1
       return a.expiryDate.getTime() - b.expiryDate.getTime()
     })
   }
   ```

4. Refactor `getAvailableLotsForComponent()` to use the helper

**Validation**:
```bash
npx tsc --noEmit
npm run lint
```

**Completion Criteria**:
- [ ] New `getAvailableLotsForComponentTx()` function added
- [ ] `sortLotsByFEFO()` helper function extracted
- [ ] Original `getAvailableLotsForComponent()` refactored to use helper
- [ ] TypeScript compiles without errors

### Subtask 1.2: Add Transaction-Aware Lot Consumption Function
**File**: `/home/pbrown/SkuInventory/src/services/lot-selection.ts`
**Pattern**: Follow `selectLotsForConsumption()` signature

**Instructions**:
1. Add new function `consumeLotsForBuildTx()` that:
   - Accepts `Prisma.TransactionClient`
   - Takes BOM lines with required quantities
   - Handles lot overrides
   - Creates TransactionLines
   - Updates LotBalance atomically
   - Returns consumed lot details

   ```typescript
   export interface ConsumedLot {
     componentId: string
     lotId: string | null
     lotNumber: string | null
     quantity: number
     costPerUnit: number
   }

   export async function consumeLotsForBuildTx(params: {
     tx: Prisma.TransactionClient
     transactionId: string
     bomLines: Array<{
       componentId: string
       quantityRequired: number
       costPerUnit: number
     }>
     lotOverrides?: Array<{
       componentId: string
       allocations: Array<{ lotId: string; quantity: number }>
     }>
     allowInsufficientInventory?: boolean
   }): Promise<ConsumedLot[]>
   ```

2. Implement the FEFO consumption logic inside this function (consolidating from inventory.ts lines 935-1028)

**Validation**:
```bash
npx tsc --noEmit
npm run lint
```

**Completion Criteria**:
- [ ] New `consumeLotsForBuildTx()` function added
- [ ] Function creates TransactionLines
- [ ] Function updates LotBalance atomically
- [ ] Handles manual lot overrides
- [ ] Handles pooled (lot-less) inventory fallback
- [ ] TypeScript compiles without errors

---

## Phase 2: Refactor inventory.ts to Use Centralized Service

### Subtask 2.1: Refactor checkExpiredLotsForBuild()
**File**: `/home/pbrown/SkuInventory/src/services/inventory.ts`
**Pattern**: Use `getAvailableLotsForComponent()` from lot-selection.ts

**Instructions**:
1. Import the lot-selection service:
   ```typescript
   import { getAvailableLotsForComponent } from './lot-selection'
   ```

2. Refactor `checkExpiredLotsForBuild()` (lines 718-783) to use `getAvailableLotsForComponent()` instead of duplicating FEFO logic:
   - Remove the inline Prisma query (lines 744-751)
   - Remove the inline sorting logic (lines 754-759)
   - Use `getAvailableLotsForComponent(line.componentId)` instead
   - Map the result to check for expired lots

**Validation**:
```bash
npx tsc --noEmit
npm run lint
npm test -- --filter="lot|expired"
```

**Completion Criteria**:
- [ ] `checkExpiredLotsForBuild()` uses centralized FEFO service
- [ ] Inline FEFO sorting removed
- [ ] All existing tests pass
- [ ] TypeScript compiles without errors

### Subtask 2.2: Refactor createBuildTransaction()
**File**: `/home/pbrown/SkuInventory/src/services/inventory.ts`
**Pattern**: Use `consumeLotsForBuildTx()` from lot-selection.ts

**Instructions**:
1. Import the new function:
   ```typescript
   import { consumeLotsForBuildTx } from './lot-selection'
   ```

2. Refactor `createBuildTransaction()` (lines 895-1109):
   - Remove the inline FEFO selection logic (lines 963-1028)
   - Replace with call to `consumeLotsForBuildTx()`
   - Pass the `tx` transaction client
   - Adapt the rest of the function to use the returned `ConsumedLot[]`

3. Ensure the function still:
   - Creates the Transaction record
   - Updates InventoryBalance
   - Creates FinishedGoodsLine
   - Updates FinishedGoodsBalance

**Validation**:
```bash
npx tsc --noEmit
npm run lint
npm test -- --filter="build|inventory"
```

**Completion Criteria**:
- [ ] `createBuildTransaction()` uses centralized FEFO service
- [ ] Inline FEFO selection logic removed (~65 lines)
- [ ] Lot consumption still atomic within transaction
- [ ] All existing tests pass
- [ ] TypeScript compiles without errors

---

## Phase 3: Refactor transaction-edit.ts to Use Centralized Service

### Subtask 3.1: Refactor editBuildTransaction()
**File**: `/home/pbrown/SkuInventory/src/services/transaction-edit.ts`
**Pattern**: Use `consumeLotsForBuildTx()` from lot-selection.ts

**Instructions**:
1. Import the new function:
   ```typescript
   import { consumeLotsForBuildTx } from './lot-selection'
   ```

2. Refactor the FEFO consumption section (lines 614-692):
   - Remove the inline FEFO selection logic
   - Replace with call to `consumeLotsForBuildTx()`
   - Pass the `tx` transaction client

3. Ensure the edit operation still:
   - Reverses previous lot balances
   - Creates new consumption lines
   - Updates balances atomically

**Validation**:
```bash
npx tsc --noEmit
npm run lint
npm test -- --filter="transaction-edit|build"
```

**Completion Criteria**:
- [ ] `editBuildTransaction()` uses centralized FEFO service
- [ ] Inline FEFO selection logic removed (~75 lines)
- [ ] Edit operation still works correctly
- [ ] All existing tests pass
- [ ] TypeScript compiles without errors

---

## Phase 4: Add FEFO Lot Consumption to Draft Approval

### Subtask 4.1: Add Lot Consumption to approveDraftTransaction()
**File**: `/home/pbrown/SkuInventory/src/services/draft-transaction.ts`
**Pattern**: Use `consumeLotsForBuildTx()` from lot-selection.ts

**Instructions**:
1. Import the new function:
   ```typescript
   import { consumeLotsForBuildTx } from './lot-selection'
   ```

2. Modify the build approval path (lines 487-610):
   - After creating placeholder transaction lines for BOM
   - Call `consumeLotsForBuildTx()` to properly consume lots
   - Update the transaction lines with lot IDs
   - This fixes the bug where draft approvals don't use FEFO

3. Specifically update:
   - The legacy BOM path (lines 507-556)
   - The snapshot BOM path (lines 558-610)
   Both need to use lot consumption

**Validation**:
```bash
npx tsc --noEmit
npm run lint
npm test -- --filter="draft|build"
```

**Completion Criteria**:
- [ ] Draft build approvals now use FEFO lot consumption
- [ ] Both legacy and snapshot BOM paths updated
- [ ] LotBalance updated on approval
- [ ] All existing tests pass
- [ ] TypeScript compiles without errors

---

## Phase 5: Update Tests

### Subtask 5.1: Add Unit Tests for Transaction-Aware Functions
**File**: `/home/pbrown/SkuInventory/tests/unit/lot-selection.test.ts`
**Pattern**: Follow existing test structure

**Instructions**:
1. Add new describe block for `getAvailableLotsForComponentTx`:
   - Test FEFO ordering
   - Test null expiry handling
   - Test with mocked transaction client

2. Add new describe block for `consumeLotsForBuildTx`:
   - Test FEFO consumption
   - Test manual overrides
   - Test pooled inventory fallback
   - Test insufficient inventory handling

**Validation**:
```bash
npm test -- --filter="lot-selection"
```

**Completion Criteria**:
- [ ] Tests added for `getAvailableLotsForComponentTx()`
- [ ] Tests added for `consumeLotsForBuildTx()`
- [ ] Tests added for `sortLotsByFEFO()` helper
- [ ] All tests pass
- [ ] Test coverage maintained or improved

### Subtask 5.2: Verify Integration Tests
**File**: `/home/pbrown/SkuInventory/tests/integration/lot-consumption.test.ts`

**Instructions**:
1. Run existing integration tests to verify no regression
2. If any tests fail, investigate and fix

**Validation**:
```bash
npm test -- --filter="lot-consumption"
```

**Completion Criteria**:
- [ ] All integration tests pass
- [ ] No regression from refactoring

---

## Phase 6: Final Validation

### Subtask 6.1: Full Test Suite and Build
**Instructions**:
1. Run full test suite
2. Run TypeScript compilation
3. Run build
4. Run lint

**Validation**:
```bash
npx tsc --noEmit
npm run build
npm run lint
npm test
```

**Completion Criteria**:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` passes
- [ ] `npm run lint` passes (zero warnings)
- [ ] `npm test` passes

---

## Summary of Deliverables

**Files Created**: 0
**Files Modified**: 5

| File | Change |
|------|--------|
| `src/services/lot-selection.ts` | Add transaction-aware FEFO functions (+~150 lines) |
| `src/services/inventory.ts` | Remove duplicated FEFO logic (-~100 lines) |
| `src/services/transaction-edit.ts` | Remove duplicated FEFO logic (-~75 lines) |
| `src/services/draft-transaction.ts` | Add FEFO lot consumption (+~50 lines) |
| `tests/unit/lot-selection.test.ts` | Add tests for new functions (+~100 lines) |

**Net Lines**: ~+125 (adds tests, removes duplication)

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 -> Phase 2 -> Phase 3 -> Phase 4 -> Phase 5 -> Phase 6)
2. Complete each phase fully before moving to next
3. Run validation commands after each subtask
4. Follow reference patterns exactly
5. **CRITICAL**: Ensure all FEFO logic is consolidated - no duplication should remain

## Test Strategy Note

- Use Vitest for unit tests
- Run targeted tests after each phase: `npm test -- --filter="lot|inventory|build"`
- Run full suite in Phase 6

## Performance Metrics

| Phase | Duration |
|-------|----------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 15m |
| **Total** | **35m** |

## Risk Mitigation

1. **Regression Risk**: Extensive test coverage exists for lot consumption
2. **Atomicity Risk**: Transaction-aware functions ensure atomicity is preserved
3. **Backward Compatibility**: Function signatures remain compatible; only internal implementation changes

## Design Decision: Transaction Client Pattern

The new functions accept `Prisma.TransactionClient` as the first parameter, following the established pattern in this codebase:
- `updateInventoryBalance(tx, componentId, locationId, delta)` in inventory.ts
- `updateFinishedGoodsBalance(tx, skuId, locationId, delta)` in finished-goods.ts
- `reverseTransactionLines(tx, transactionId)` in transaction-edit.ts

This pattern ensures:
1. Operations remain atomic within the caller's transaction
2. No race conditions between FEFO selection and balance updates
3. Consistent API across the codebase
