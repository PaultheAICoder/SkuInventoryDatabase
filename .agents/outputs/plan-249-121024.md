# Implementation Plan
**Generated**: 2025-12-10T14:30:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #249
**Estimated Build Time**: 4-6 hours
**Complexity**: Medium

## Investigation Summary

### Request Analysis
**Type**: Feature
**Source**: GitHub Issue #249
**Priority**: Medium

**User Request**: Add the ability to delete transactions if mistakes were made in creating them. The user clarified:
- This should be allowed forever (no time restriction)
- Balances should revert to the state before the transaction (full inventory reversal)
- Example: If 100 units Advil + 50 inbound = 150, then delete 50 inbound transaction = 100 units final

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="transaction"` for unit tests

### Issue Validation
**Status**: Valid
**Recent Changes**: Issue #243 (transaction edit) was recently implemented, which provides excellent patterns for transaction reversal logic. The `reverseTransactionLines` and `reverseFinishedGoodsLines` functions in `src/services/transaction-edit.ts` can be reused.

### Current State Assessment
- **Existing components**:
  - Transaction edit service with reversal logic EXISTS (`src/services/transaction-edit.ts`)
  - Transaction API route at `src/app/api/transactions/[id]/route.ts` has GET and PUT, NO DELETE
  - TransactionDetail component (`src/components/features/TransactionDetail.tsx`) has Edit button pattern
  - AlertDialog confirmation pattern exists (`src/components/features/BrandTable.tsx`)
- **Database**:
  - Transaction model with `onDelete: Cascade` for TransactionLine and FinishedGoodsLine
  - LotBalance needs reversal before deletion (not cascaded)
  - DefectAlert has FK to Transaction (needs handling)
- **API Routes**: DELETE endpoint needed at `src/app/api/transactions/[id]/route.ts`
- **Types**: TransactionResponse type exists, may need DeleteTransactionResult type

### Dependencies & Blockers
1. **DefectAlert FK constraint**: Transactions may have associated defect alerts that need to be deleted first
2. **LotBalance reversal**: Must reverse lot balance changes before deleting transaction
3. **FinishedGoodsLine reversal**: Build/outbound transactions affect FG inventory

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Medium
**Effort**: 4-6 hours
**Risk**: Medium - Need to ensure inventory is properly reversed in all cases (components + FG + lots)

### Patterns Identified
**Primary**: `src/services/transaction-edit.ts` lines 24-68 - `reverseTransactionLines()` and `reverseFinishedGoodsLines()` functions
**Secondary**: `src/app/api/transactions/drafts/[id]/route.ts` - DELETE handler pattern
**Tertiary**: `src/components/features/BrandTable.tsx` lines 172-201 - AlertDialog confirmation pattern

### Ripple Effect Analysis
**Files Identified**: 4 files affected

| File | Change Type | Reason |
|------|-------------|--------|
| `src/services/transaction-edit.ts` | Modified | Add `deleteTransaction()` function reusing reversal logic |
| `src/app/api/transactions/[id]/route.ts` | Modified | Add DELETE handler |
| `src/components/features/TransactionDetail.tsx` | Modified | Add Delete button with AlertDialog confirmation |
| `src/types/transaction-edit.ts` | Modified | Add `TransactionDeleteResult` type |

---

## Executive Summary
This feature adds the ability to delete approved transactions with full inventory reversal. When a transaction is deleted:
1. Component inventory is reversed (transaction lines undone)
2. Lot balances are restored (for lot-tracked components)
3. Finished goods inventory is reversed (for build/outbound transactions)
4. Associated defect alerts are deleted
5. The transaction and all related records are permanently deleted

The implementation reuses the existing reversal logic from the transaction edit feature (#243).

## Phase 1: Service Layer - Delete Transaction Function

### Subtask 1.1: Add TransactionDeleteResult Type
**File**: `/home/pbrown/SkuInventory/src/types/transaction-edit.ts`
**Pattern**: Follow existing `TransactionUpdateResult` interface (lines 99-104)
**Instructions**:
1. Add new `TransactionDeleteResult` interface after `TransactionUpdateResult`:
```typescript
/**
 * Result type for transaction delete operations
 */
export interface TransactionDeleteResult {
  id: string
  type: string
  deleted: boolean
}
```

**Validation commands**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Type compiles without errors
- [ ] Type is exported from the module

### Subtask 1.2: Create deleteTransaction Service Function
**File**: `/home/pbrown/SkuInventory/src/services/transaction-edit.ts`
**Pattern**: Follow `reverseTransactionLines()` (lines 24-55) and `reverseFinishedGoodsLines()` (lines 60-68)
**Instructions**:
1. Add import for `TransactionDeleteResult` from types
2. Add new function `deleteTransaction()` after the existing update functions (around line 825):

```typescript
// =============================================================================
// Delete Transaction
// =============================================================================

/**
 * Delete an approved transaction and reverse all inventory effects
 * This permanently removes the transaction and restores inventory to pre-transaction state
 */
export async function deleteTransaction(params: {
  transactionId: string
  companyId: string
  userId: string
}): Promise<TransactionDeleteResult> {
  const { transactionId, companyId, userId: _userId } = params

  return prisma.$transaction(async (tx) => {
    // 1. Verify transaction exists and belongs to company
    const existingTransaction = await tx.transaction.findFirst({
      where: {
        id: transactionId,
        companyId,
        status: 'approved', // Can only delete approved transactions
      },
      include: {
        lines: true,
        finishedGoodsLines: true,
        defectAlerts: true,
      },
    })

    if (!existingTransaction) {
      throw new Error('Transaction not found or cannot be deleted')
    }

    // 2. Reverse lot balance changes for all transaction lines
    for (const line of existingTransaction.lines) {
      if (line.lotId) {
        // Decrement reverses the original change
        await tx.lotBalance.update({
          where: { lotId: line.lotId },
          data: {
            quantity: {
              decrement: line.quantityChange,
            },
          },
        })
      }
    }

    // 3. Delete any associated defect alerts
    if (existingTransaction.defectAlerts.length > 0) {
      await tx.defectAlert.deleteMany({
        where: { transactionId },
      })
    }

    // 4. Delete the transaction (cascade will delete lines and finished goods lines)
    await tx.transaction.delete({
      where: { id: transactionId },
    })

    return {
      id: transactionId,
      type: existingTransaction.type,
      deleted: true,
    }
  })
}
```

**Validation commands**:
```bash
npx tsc --noEmit
npm run lint
```

**Completion Criteria**:
- [ ] Function compiles without errors
- [ ] Function handles lot balance reversal
- [ ] Function handles defect alert deletion
- [ ] Function uses database transaction for atomicity

## Phase 2: API Route - DELETE Handler

### Subtask 2.1: Add DELETE Handler to Transaction Route
**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/[id]/route.ts`
**Pattern**: Follow DELETE handler in `src/app/api/transactions/drafts/[id]/route.ts` (lines 102-137)
**Instructions**:
1. Add import for `deleteTransaction` from services
2. Add import for `TransactionDeleteResult` from types (if used in response)
3. Add DELETE handler after the existing PUT handler:

```typescript
// DELETE /api/transactions/[id] - Delete an approved transaction
export async function DELETE(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  // Mark request as used
  void request

  try {
    const session = await getServerSession(authOptions)

    if (!session?.user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    // Check role - Viewer cannot delete transactions
    if (session.user.role === 'viewer') {
      return NextResponse.json(
        { error: 'You do not have permission to delete transactions' },
        { status: 403 }
      )
    }

    const { id } = await params
    const selectedCompanyId = session.user.selectedCompanyId

    const result = await deleteTransaction({
      transactionId: id,
      companyId: selectedCompanyId,
      userId: session.user.id,
    })

    return NextResponse.json({ data: result })
  } catch (error) {
    console.error('Error deleting transaction:', error)
    if (error instanceof Error) {
      return NextResponse.json({ error: error.message }, { status: 400 })
    }
    return NextResponse.json({ error: 'Failed to delete transaction' }, { status: 500 })
  }
}
```

**Validation commands**:
```bash
npx tsc --noEmit
npm run lint
```

**Completion Criteria**:
- [ ] DELETE handler compiles without errors
- [ ] Handler checks authentication
- [ ] Handler checks viewer role restriction
- [ ] Handler calls deleteTransaction service

## Phase 3: Frontend - Delete Button with Confirmation

### Subtask 3.1: Add Delete Button and AlertDialog to TransactionDetail
**File**: `/home/pbrown/SkuInventory/src/components/features/TransactionDetail.tsx`
**Pattern**: Follow `src/components/features/BrandTable.tsx` lines 22-30 (AlertDialog imports) and lines 172-201 (AlertDialog usage)
**Instructions**:
1. Add imports for AlertDialog components and Trash2 icon:
```typescript
import { Trash2 } from 'lucide-react'
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/components/ui/alert-dialog'
```

2. Add state variables after the existing `canEdit` check:
```typescript
const [showDeleteDialog, setShowDeleteDialog] = useState(false)
const [isDeleting, setIsDeleting] = useState(false)
const [deleteError, setDeleteError] = useState<string | null>(null)
```

3. Add `useState` to the imports from 'react'

4. Add `useRouter` from 'next/navigation' and create router instance:
```typescript
import { useRouter } from 'next/navigation'
// ... inside component:
const router = useRouter()
```

5. Add delete handler function:
```typescript
const handleDelete = async () => {
  setIsDeleting(true)
  setDeleteError(null)
  try {
    const res = await fetch(`/api/transactions/${transaction.id}`, {
      method: 'DELETE',
    })

    if (!res.ok) {
      const data = await res.json().catch(() => ({}))
      throw new Error(data?.error || 'Failed to delete transaction')
    }

    // Redirect to transactions list on success
    router.push('/transactions')
  } catch (error) {
    setDeleteError(error instanceof Error ? error.message : 'Failed to delete transaction')
    setIsDeleting(false)
  }
}
```

6. Add Delete button next to Edit button (inside the existing header div with Edit button):
```typescript
{canEdit && (
  <>
    <Link href={`/transactions/${transaction.id}/edit`}>
      <Button variant="outline" size="sm">
        <Pencil className="h-4 w-4 mr-2" />
        Edit
      </Button>
    </Link>
    <Button
      variant="outline"
      size="sm"
      className="text-destructive hover:bg-destructive/10"
      onClick={() => setShowDeleteDialog(true)}
    >
      <Trash2 className="h-4 w-4 mr-2" />
      Delete
    </Button>
  </>
)}
```

7. Add error display after the buttons section (inside CardContent):
```typescript
{deleteError && (
  <div className="mt-4 rounded-md bg-destructive/10 p-3 text-sm text-destructive">
    {deleteError}
  </div>
)}
```

8. Add AlertDialog at the end of the component (before the closing `</div>`):
```typescript
<AlertDialog open={showDeleteDialog} onOpenChange={setShowDeleteDialog}>
  <AlertDialogContent>
    <AlertDialogHeader>
      <AlertDialogTitle>Delete Transaction</AlertDialogTitle>
      <AlertDialogDescription>
        Are you sure you want to delete this {transaction.type} transaction from{' '}
        <span suppressHydrationWarning>
          {new Date(transaction.date).toLocaleDateString()}
        </span>
        ?
        <span className="block mt-2 font-medium">
          This will reverse all inventory changes made by this transaction.
        </span>
        <span className="block mt-2 text-destructive">
          This action cannot be undone.
        </span>
      </AlertDialogDescription>
    </AlertDialogHeader>
    <AlertDialogFooter>
      <AlertDialogCancel disabled={isDeleting}>Cancel</AlertDialogCancel>
      <AlertDialogAction
        onClick={handleDelete}
        disabled={isDeleting}
        className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
      >
        {isDeleting ? 'Deleting...' : 'Delete Transaction'}
      </AlertDialogAction>
    </AlertDialogFooter>
  </AlertDialogContent>
</AlertDialog>
```

**Validation commands**:
```bash
npx tsc --noEmit
npm run lint
npm run build
```

**Completion Criteria**:
- [ ] Delete button visible on transaction detail page for non-viewer roles
- [ ] AlertDialog shows confirmation with warning about inventory reversal
- [ ] Delete action calls API and redirects on success
- [ ] Error state displays if delete fails
- [ ] Component compiles without errors

## Phase 4: Testing and Verification

### Subtask 4.1: Manual Testing Verification
**Instructions**:
1. Start the test environment: `cd docker && docker compose -f docker-compose.test.yml up -d`
2. Access test app at http://172.16.20.50:2345
3. Create a test receipt transaction
4. Note component quantity before and after
5. Delete the transaction
6. Verify component quantity is restored
7. Test with build transaction to verify FG reversal
8. Test that viewers cannot see Delete button

**Completion Criteria**:
- [ ] Receipt deletion reverses component inventory
- [ ] Build deletion reverses component consumption AND FG output
- [ ] Transfer deletion reverses both location changes
- [ ] Viewer role cannot see Delete button
- [ ] Confirmation dialog shows before deletion

### Subtask 4.2: Run Existing Tests
**Instructions**:
```bash
npm test -- --filter="transaction"
```

**Completion Criteria**:
- [ ] All existing transaction tests pass
- [ ] No regressions introduced

---

## Summary of Deliverables
**Files Created**: 0
**Files Modified**: 4
- `src/types/transaction-edit.ts` - Add TransactionDeleteResult type
- `src/services/transaction-edit.ts` - Add deleteTransaction function
- `src/app/api/transactions/[id]/route.ts` - Add DELETE handler
- `src/components/features/TransactionDetail.tsx` - Add Delete button with confirmation dialog

## Handoff to Build Agent
1. Execute subtasks in exact order (1.1 -> 1.2 -> 2.1 -> 3.1 -> 4.1 -> 4.2)
2. Run validation commands after each subtask
3. Verify completion criteria before proceeding
4. The reversal logic in Phase 1 is critical - ensure lot balances are properly reversed

## Test Strategy Note
- Use Vitest for unit tests
- Manual testing required for UI verification
- Existing transaction tests should continue to pass

## Important Implementation Notes

### Inventory Reversal Logic
The `deleteTransaction` function MUST reverse inventory in this order:
1. **LotBalance reversal** - Decrement the quantity change (this reverses adds and removes)
2. **DefectAlert deletion** - Remove any alerts tied to this transaction
3. **Transaction deletion** - Prisma cascade handles TransactionLine and FinishedGoodsLine

### Edge Cases to Consider
- Transactions with lot-tracked components must reverse LotBalance
- Build transactions have both TransactionLines (component consumption) AND FinishedGoodsLines (FG output)
- Transfer transactions have two transaction lines (from and to locations)
- The `onDelete: Cascade` on TransactionLine and FinishedGoodsLine relations handles their deletion automatically

### UI Placement
The Delete button should be placed:
- Next to the existing Edit button in the header
- Using destructive styling (red text/outline)
- With AlertDialog confirmation before actual deletion

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 25m |
| Validation | 5m |
| Planning | 15m |
| **Total** | **45m** |

---

## Acceptance Criteria from Issue
- [x] Feature works as described (inventory reverts when transaction deleted)
- [ ] No TypeScript errors
- [ ] All tests passing
- [ ] Build completes successfully
