# Implementation Plan
**Generated**: 2025-12-18T00:45:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #324
**Estimated Build Time**: 3-4 hours
**Complexity**: Medium

## Investigation Summary

### Request Analysis
**Type**: Bug Fix
**Source**: GitHub Issue #324 - Bug: Integration test failures in brand filtering and tenant scoping
**Priority**: Medium - Test infrastructure issues, not production code bugs

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED
**Suggested Filter**: `--testNamePattern="tenant-scoping|forecasts|auth"`

### Issue Validation
**Status**: Valid - Tests are failing with reproducible issues
**Recent Changes**: Session mock changes (commit 5689b18) were mentioned but are NOT the root cause

### Current State Assessment
After thorough investigation, the issue description in #324 is **outdated/incorrect**. The actual failures are different from what was reported:

**Original Issue Description** (11 tests in 4 files):
- tenant-scoping.test.ts (2 failures) - component/SKU list tests
- forecasts.test.ts (4 failures) - brand filtering
- import-export.test.ts (4 failures) - export empty data
- sku-api.test.ts (1 failure) - version field

**Actual Current Failures** (5 tests in 3 files):
1. **auth.test.ts** (2 failures):
   - "GET /api/users returns 400 when selectedCompanyId is missing" - Gets 403 instead of 400
   - "POST /api/users returns 400 when selectedCompanyId is missing" - Gets 403 instead of 400

2. **forecasts.test.ts** (2 failures):
   - "returns default values when no config exists" - Gets lookbackDays: 45 instead of 30
   - "returns 400 when selectedCompanyId is missing" (PUT) - Gets 403 instead of 400

3. **tenant-scoping.test.ts** (1 failure):
   - "admin can only see users from their own company" - admin@tonsil.tech not in results

### Root Cause Analysis

**Root Cause 1: Order of Checks in API Routes (3 tests)**
Files affected:
- `/home/pbrown/SkuInventory/src/app/api/users/route.ts` (GET and POST)
- `/home/pbrown/SkuInventory/src/app/api/forecasts/config/route.ts` (PUT)

The role check (`getSelectedCompanyRole`) happens BEFORE the `selectedCompanyId` validation. When `selectedCompanyId` is empty string:
1. `getSelectedCompanyRole()` returns `undefined` (no company matches empty string)
2. `undefined !== 'admin'` returns 403 Forbidden
3. The `!selectedCompanyId` check never runs

**Expected flow**: Check if company is selected first, THEN check role.

**Root Cause 2: ForecastConfig Not Cleaned Up Between Tests (1 test)**
File affected:
- `/home/pbrown/SkuInventory/tests/helpers/db.ts`

The `cleanupTestData()` function does NOT clean the `ForecastConfig` table. A previous test ("updates config for admin user") sets `lookbackDays: 45`, which persists into the subsequent test ("returns default values when no config exists").

**Root Cause 3: Test Database State Corruption (1 test)**
The test database has inconsistent UserCompany associations:
- `admin@tonsil.tech` is linked to "Mela Vitamins" company
- `ops@tonsil.tech` and `viewer@tonsil.tech` are linked to "Tonsil Tech" company

This causes the tenant-scoping test to fail because when querying users for "Tonsil Tech", the admin user is not returned.

**Resolution Options for Root Cause 3**:
- Option A: Re-seed the test database (recommended)
- Option B: Fix the test to not assume seed data consistency
- Option C: Add test setup to ensure correct user-company associations

### Dependencies & Blockers
1. Test database schema was out of sync - **RESOLVED** during investigation
2. Missing columns in Transaction table (`deletedAt`, `deletedById`) - **RESOLVED** during investigation

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Medium
**Effort**: 3-4 hours
**Risk**: Low - Changes are isolated to test infrastructure and minor API route ordering

### Patterns Identified
**Primary**: `/home/pbrown/SkuInventory/src/app/api/forecasts/route.ts:29-32` - Correct order: selectedCompanyId check BEFORE role-specific operations
**Secondary**: `/home/pbrown/SkuInventory/tests/helpers/db.ts:33-52` - Pattern for cleanupTestData function

### Ripple Effect Analysis
**Files Identified**: 5 files total

API Routes requiring check reordering:
- `/home/pbrown/SkuInventory/src/app/api/users/route.ts` (GET and POST)
- `/home/pbrown/SkuInventory/src/app/api/forecasts/config/route.ts` (PUT only)

Test helper requiring update:
- `/home/pbrown/SkuInventory/tests/helpers/db.ts`

Test database requiring reseed:
- Test database via `docker exec inventory-db-test` command

---

## Executive Summary
Fix 5 failing integration tests caused by: (1) incorrect order of validation checks in API routes (role check before selectedCompanyId check), (2) missing ForecastConfig table cleanup in test helpers, and (3) corrupted test database user-company associations requiring reseed.

## Phase 0: Test Database Restoration
### Subtask 0.1: Reseed Test Database
**Instructions**:
1. Reset the test database to ensure clean state
2. Run seed script against test database

**Commands**:
```bash
# Reset and reseed test database
DATABASE_URL="postgresql://inventory_test:inventory_test_2025@localhost:2346/inventory_test" npx prisma migrate reset --force
```

**Completion Criteria**:
- [ ] Admin, ops, and viewer users all associated with "Tonsil Tech" company
- [ ] Verify: `docker exec inventory-db-test psql -U inventory_test -d inventory_test -c "SELECT u.email, c.name FROM \"User\" u JOIN \"UserCompany\" uc ON u.id = uc.\"userId\" JOIN \"Company\" c ON uc.\"companyId\" = c.id WHERE u.email LIKE '%@tonsil.tech';"`

## Phase 1: Fix Test Data Cleanup
### Subtask 1.1: Add ForecastConfig Cleanup to cleanupTestData
**File**: `/home/pbrown/SkuInventory/tests/helpers/db.ts`
**Pattern**: Follow existing deleteMany pattern at lines 35-52
**Instructions**:
1. Add `await prisma.forecastConfig.deleteMany({})` to the cleanup sequence
2. Place it near the end since it has a FK to Company (which is preserved)

**Code Change**:
```typescript
// In cleanupTestData function, add after line 50:
await prisma.forecastConfig.deleteMany({})
```

**Completion Criteria**:
- [ ] ForecastConfig table is cleaned between tests
- [ ] Test "returns default values when no config exists" passes

## Phase 2: Fix API Route Validation Order
### Subtask 2.1: Fix /api/users GET Route
**File**: `/home/pbrown/SkuInventory/src/app/api/users/route.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/app/api/forecasts/route.ts:29-32`
**Instructions**:
1. Move the `selectedCompanyId` check (lines 36-43) to BEFORE the role check (lines 18-21)
2. The order should be: auth check -> selectedCompanyId check -> role check

**Code Change**:
```typescript
// After line 15 (auth check), add:
const selectedCompanyId = session.user.selectedCompanyId
if (!selectedCompanyId) {
  return NextResponse.json(
    { error: 'No company selected. Please refresh the page and try again.' },
    { status: 400 }
  )
}

// Then keep the role check:
const companyRole = getSelectedCompanyRole(session)
if (companyRole !== 'admin') {
  return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
}

// Remove the duplicate selectedCompanyId check from lines 36-43
```

**Completion Criteria**:
- [ ] GET /api/users returns 400 when selectedCompanyId is empty
- [ ] GET /api/users returns 403 when user is not admin (but has valid company)
- [ ] Test "GET /api/users returns 400 when selectedCompanyId is missing" passes

### Subtask 2.2: Fix /api/users POST Route
**File**: `/home/pbrown/SkuInventory/src/app/api/users/route.ts`
**Instructions**:
1. Same pattern as Subtask 2.1 but for POST function (starts at line 135)
2. Move the `selectedCompanyId` check (lines 174-180) to BEFORE the role check

**Code Change**:
```typescript
// After line 140 (auth check), add:
const selectedCompanyId = session.user.selectedCompanyId
if (!selectedCompanyId) {
  return NextResponse.json(
    { error: 'No company selected. Please refresh the page and try again.' },
    { status: 400 }
  )
}

// Then keep the role check at line 144:
const companyRole = getSelectedCompanyRole(session)
if (companyRole !== 'admin') {
  return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
}

// Remove the duplicate selectedCompanyId check from lines 174-180
```

**Completion Criteria**:
- [ ] POST /api/users returns 400 when selectedCompanyId is empty
- [ ] Test "POST /api/users returns 400 when selectedCompanyId is missing" passes

### Subtask 2.3: Fix /api/forecasts/config PUT Route
**File**: `/home/pbrown/SkuInventory/src/app/api/forecasts/config/route.ts`
**Instructions**:
1. Move the `selectedCompanyId` check (lines 79-82) to BEFORE the role check (lines 74-77)

**Code Change**:
```typescript
// After line 70 (auth check), add selectedCompanyId check first:
const selectedCompanyId = session.user.selectedCompanyId
if (!selectedCompanyId) {
  return error('No company selected. Please select a company from the sidebar.', 400)
}

// Then keep the role check:
const companyRole = getSelectedCompanyRole(session)
if (companyRole !== 'admin') {
  return forbidden()
}

// Remove the duplicate selectedCompanyId check from lines 79-82
```

**Completion Criteria**:
- [ ] PUT /api/forecasts/config returns 400 when selectedCompanyId is empty
- [ ] Test "returns 400 when selectedCompanyId is missing" (PUT) passes

## Phase 3: Verification
### Subtask 3.1: Run All Integration Tests
**Instructions**:
1. Run the full integration test suite
2. Verify all 5 failing tests now pass
3. Verify no regressions in other tests

**Commands**:
```bash
npm run test:integration
```

**Completion Criteria**:
- [ ] All 210 tests pass (204 + 5 fixed + 1 skipped)
- [ ] No new failures introduced
- [ ] `npm run build` succeeds
- [ ] `npx tsc --noEmit` succeeds

---

## Summary of Deliverables
**Files Modified**: 3
- `src/app/api/users/route.ts` - Reorder validation checks (GET and POST)
- `src/app/api/forecasts/config/route.ts` - Reorder validation checks (PUT)
- `tests/helpers/db.ts` - Add ForecastConfig cleanup

**Database Operations**: 1
- Reseed test database to fix user-company associations

## Handoff to Build Agent
1. Execute Phase 0 first to fix test database state
2. Execute Phases 1-2 in order (test cleanup before API fixes)
3. Run verification after each phase change
4. Complete Phase 3 verification before marking complete

## Test Strategy Note
- Use Vitest with integration config: `npm run test:integration`
- Run targeted tests with: `npm run test:integration -- --testNamePattern="pattern"`

## Similar Pattern Check - COMPLETED
The validation order issue (checking role before selectedCompanyId) was scanned across ALL API routes.

**Pattern Scan Results**: 7 additional files have the same issue (besides the 2 being fixed in this plan):
1. `/home/pbrown/SkuInventory/src/app/api/brands/route.ts` - GET (line 18) and POST (line 127)
2. `/home/pbrown/SkuInventory/src/app/api/categories/route.ts` - GET (line 17) and POST (line 123)
3. `/home/pbrown/SkuInventory/src/app/api/chatbot/route.ts` - POST (line 17)
4. `/home/pbrown/SkuInventory/src/app/api/companies/route.ts` - both methods (lines 17, 97)
5. `/home/pbrown/SkuInventory/src/app/api/settings/route.ts` - GET (line 21) and PATCH (line 74)
6. `/home/pbrown/SkuInventory/src/app/api/sync-logs/route.ts` - GET (line 23)
7. `/home/pbrown/SkuInventory/src/app/api/locations/route.ts` - POST only (line 102)

**Decision**: Since >3 files have this issue, create a follow-up GitHub issue for batch fix.

**Follow-up Action Required**:
```bash
gh issue create --title "Refactor: Fix validation order in API routes (selectedCompanyId before role check)" \
  --body "## Summary
Several API routes check role BEFORE selectedCompanyId, which returns 403 Forbidden instead of 400 Bad Request when company is not selected.

## Affected Files
- src/app/api/brands/route.ts
- src/app/api/categories/route.ts
- src/app/api/chatbot/route.ts
- src/app/api/companies/route.ts
- src/app/api/settings/route.ts
- src/app/api/sync-logs/route.ts
- src/app/api/locations/route.ts (POST only)

## Pattern to Fix
Move selectedCompanyId check to run BEFORE getSelectedCompanyRole check.

## Related
- Issue #324 fixed this pattern in users/route.ts and forecasts/config/route.ts" \
  --label "refactoring"
```

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 30m |
| Validation | 15m |
| Planning | 10m |
| **Total** | **55m** |
