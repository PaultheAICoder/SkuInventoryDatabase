# Implementation Plan
**Generated**: 2026-01-04T23:45:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #364
**Estimated Build Time**: 2-3 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Feature (Shopify Order Sync)
**Source**: GitHub Issue #364
**Priority**: P1-MVP

### Task Classification
**Category**: FEATURE_COMPLETION (Most functionality exists, completing remaining pieces)
**Test Strategy**: TARGETED - Run Shopify-related tests
**Suggested Filter**: `--filter="shopify"` or None

### Issue Validation
**Status**: Partially Complete
**Recent Changes**: Issue #363 (Database schema extensions) was just closed - schema is ready

### Current State Assessment

| Task from Issue | Current State | Gap |
|-----------------|---------------|-----|
| Order fetch with pagination in `src/services/shopify/sync-orders.ts` | EXISTS at `src/services/shopify/sync.ts` | Filename differs from spec - acceptable |
| Idempotent order upsert | EXISTS (processBatch function, lines 212-289) | COMPLETE |
| Line item sync | EXISTS (lines 261-280 in sync.ts) | COMPLETE |
| Add sync to daily scheduler | MISSING - No cron endpoint for Shopify | **GAP** |
| POST /api/integrations/shopify/sync | EXISTS at same path | COMPLETE |
| GET /api/integrations/shopify/orders | EXISTS at `/api/shopify/orders` | Path differs but functional |
| ShopifyOrdersTable component | EXISTS as `OrderReviewTable.tsx` | Name differs but functional |
| Shopify Orders page | EXISTS at expected path | COMPLETE |

### Summary of Existing Code

**Services**:
- `/home/pbrown/SkuInventory/src/services/shopify/sync.ts` - Full sync service with:
  - `syncAll()` function with date range support
  - `processBatch()` for idempotent order upsert
  - Line item sync with SKU mapping status
  - SalesDaily calculation integration
  - Sync logging via SyncLog model

- `/home/pbrown/SkuInventory/src/services/shopify/client.ts` - API client with:
  - `fetchOrders()` with automatic pagination
  - Rate limiting and retry logic
  - OAuth support

**API Routes**:
- `/home/pbrown/SkuInventory/src/app/api/integrations/shopify/sync/route.ts` - Manual trigger (POST)
- `/home/pbrown/SkuInventory/src/app/api/shopify/orders/route.ts` - List orders (GET)
- `/home/pbrown/SkuInventory/src/app/api/shopify/orders/[id]/route.ts` - Get single order (GET)

**UI Components**:
- `/home/pbrown/SkuInventory/src/components/features/OrderReviewTable.tsx` - Order list table
- `/home/pbrown/SkuInventory/src/components/features/OrderDetail.tsx` - Order detail view
- `/home/pbrown/SkuInventory/src/app/(dashboard)/shopify/orders/page.tsx` - Orders list page
- `/home/pbrown/SkuInventory/src/app/(dashboard)/shopify/orders/[id]/page.tsx` - Order detail page

### Dependencies & Blockers
1. No blockers - all prerequisite work is complete
2. Issue #363 (database schema) is closed - ShopifyOrder, ShopifyOrderLine, ShopifyCustomer models exist

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Low
**Effort**: 2-3 hours
**Risk**: Low

### Patterns Identified
**Primary**: `/home/pbrown/SkuInventory/src/app/api/cron/ads-sync/route.ts` - Cron endpoint pattern
**Secondary**: `/home/pbrown/SkuInventory/src/services/amazon-sync/scheduler.ts` - Scheduler service pattern

### Ripple Effect Analysis
**Files Identified**: 2 new files to create, 0 files to modify
- NEW: `src/app/api/cron/shopify-sync/route.ts`
- NEW: `src/services/shopify/scheduler.ts`

---

## Executive Summary

Most of Issue #364's requirements are already implemented. The only missing piece is adding Shopify order sync to the daily scheduler via a cron endpoint. This requires:

1. Creating a scheduler service for Shopify sync (following Amazon pattern)
2. Creating a cron endpoint that can be triggered by an external scheduler

The existing `syncAll()` function in `src/services/shopify/sync.ts` already handles all the sync logic including pagination, idempotency, line items, and logging.

---

## Phase 1: Shopify Sync Scheduler Service

### Subtask 1.1: Create Shopify Sync Scheduler Service
**File**: `/home/pbrown/SkuInventory/src/services/shopify/scheduler.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/services/amazon-sync/scheduler.ts`
**Instructions**:

1. Create the file with the following structure:
```typescript
/**
 * Shopify Order Sync Scheduler
 *
 * Orchestrates daily synchronization of Shopify orders.
 * Called by /api/cron/shopify-sync at scheduled intervals.
 *
 * Features:
 * - Syncs all active Shopify connections
 * - Retry logic for transient failures
 * - Weekend skip option (optional)
 * - Configurable via environment variables
 */

import { prisma } from '@/lib/db'
import { syncAll } from '@/services/shopify/sync'
import { format, subDays } from 'date-fns'

// ============================================
// Types
// ============================================

export interface ShopifySyncResult {
  totalConnections: number
  syncsTriggered: number
  syncsCompleted: number
  syncsFailed: number
  results: ConnectionSyncResult[]
  skipped: SkipReason | null
  duration: number
}

export interface ConnectionSyncResult {
  connectionId: string
  shopName: string
  status: 'completed' | 'partial' | 'failed' | 'skipped'
  ordersProcessed?: number
  ordersCreated?: number
  ordersUpdated?: number
  error?: string
  retryCount: number
}

export type SkipReason = 'disabled' | 'weekend'

// ============================================
// Configuration
// ============================================

function getConfig() {
  return {
    disabled: process.env.DISABLE_SHOPIFY_SYNC === 'true',
    skipWeekends: process.env.SKIP_SHOPIFY_WEEKENDS === 'true',
    staggerMs: parseInt(process.env.SHOPIFY_SYNC_STAGGER_MS || '3000', 10),
    maxRetries: parseInt(process.env.SHOPIFY_SYNC_MAX_RETRIES || '3', 10),
  }
}

function isWeekend(): boolean {
  const now = new Date()
  const day = now.getDay()
  return day === 0 || day === 6 // Sunday = 0, Saturday = 6
}

function getDefaultDateRange(): { startDate: string; endDate: string } {
  const yesterday = subDays(new Date(), 1)
  const dateStr = format(yesterday, 'yyyy-MM-dd')
  return { startDate: dateStr, endDate: dateStr }
}

// ============================================
// Retry Logic
// ============================================

async function syncWithRetry(
  connectionId: string,
  shopName: string,
  dateRange: { startDate: string; endDate: string },
  maxRetries: number
): Promise<{ result?: Awaited<ReturnType<typeof syncAll>>; error?: string; retryCount: number }> {
  let lastError: string | undefined

  for (let attempt = 0; attempt <= maxRetries; attempt++) {
    try {
      const result = await syncAll({
        connectionId,
        dateRange,
      })
      return { result, retryCount: attempt }
    } catch (error) {
      lastError = error instanceof Error ? error.message : 'Unknown error'
      console.error(
        `[Shopify Sync] Attempt ${attempt + 1}/${maxRetries + 1} failed for ${shopName}: ${lastError}`
      )

      if (attempt < maxRetries) {
        // Exponential backoff: 2^attempt * 1000ms (1s, 2s, 4s, 8s...)
        const backoffMs = Math.pow(2, attempt) * 1000
        await new Promise(resolve => setTimeout(resolve, backoffMs))
      }
    }
  }

  return { error: lastError, retryCount: maxRetries }
}

// ============================================
// Main Scheduler Function
// ============================================

/**
 * Run scheduled sync for all active Shopify connections
 * Called by /api/cron/shopify-sync daily
 */
export async function runScheduledShopifySync(): Promise<ShopifySyncResult> {
  const startTime = Date.now()
  const config = getConfig()

  // Check if disabled
  if (config.disabled) {
    console.log('[Shopify Sync] Sync is disabled via DISABLE_SHOPIFY_SYNC')
    return {
      totalConnections: 0,
      syncsTriggered: 0,
      syncsCompleted: 0,
      syncsFailed: 0,
      results: [],
      skipped: 'disabled',
      duration: Date.now() - startTime,
    }
  }

  // Check weekend skip
  if (config.skipWeekends && isWeekend()) {
    console.log('[Shopify Sync] Skipping sync on weekend (SKIP_SHOPIFY_WEEKENDS=true)')
    return {
      totalConnections: 0,
      syncsTriggered: 0,
      syncsCompleted: 0,
      syncsFailed: 0,
      results: [],
      skipped: 'weekend',
      duration: Date.now() - startTime,
    }
  }

  console.log('[Shopify Sync] Starting scheduled sync...')

  // Fetch all active Shopify connections
  const connections = await prisma.shopifyConnection.findMany({
    where: { isActive: true },
    select: {
      id: true,
      shopName: true,
      companyId: true,
    },
  })

  const results: ConnectionSyncResult[] = []
  let syncsCompleted = 0
  let syncsFailed = 0

  const dateRange = getDefaultDateRange()

  console.log(`[Shopify Sync] Processing ${connections.length} active connections`)

  for (let i = 0; i < connections.length; i++) {
    const connection = connections[i]

    const { result, error, retryCount } = await syncWithRetry(
      connection.id,
      connection.shopName,
      dateRange,
      config.maxRetries
    )

    if (result) {
      results.push({
        connectionId: connection.id,
        shopName: connection.shopName,
        status: result.success ? 'completed' : 'partial',
        ordersProcessed: result.ordersProcessed,
        ordersCreated: result.ordersCreated,
        ordersUpdated: result.ordersUpdated,
        retryCount,
      })
      syncsCompleted++
    } else {
      results.push({
        connectionId: connection.id,
        shopName: connection.shopName,
        status: 'failed',
        error,
        retryCount,
      })
      syncsFailed++
    }

    // Stagger between connections to avoid rate limiting
    if (config.staggerMs > 0 && i < connections.length - 1) {
      await new Promise(resolve => setTimeout(resolve, config.staggerMs))
    }
  }

  const duration = Date.now() - startTime
  console.log(
    `[Shopify Sync] Completed: ${syncsCompleted} succeeded, ${syncsFailed} failed. Duration: ${duration}ms`
  )

  return {
    totalConnections: connections.length,
    syncsTriggered: connections.length,
    syncsCompleted,
    syncsFailed,
    results,
    skipped: null,
    duration,
  }
}
```

**Completion Criteria**:
- [ ] File created at specified path
- [ ] Follows Amazon scheduler pattern
- [ ] Exports `runScheduledShopifySync()` function
- [ ] `npx tsc --noEmit` passes

---

## Phase 2: Cron Endpoint

### Subtask 2.1: Create Shopify Sync Cron Endpoint
**File**: `/home/pbrown/SkuInventory/src/app/api/cron/shopify-sync/route.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/app/api/cron/ads-sync/route.ts`
**Instructions**:

1. Create the directory if needed
2. Create the file with the following structure:
```typescript
/**
 * POST /api/cron/shopify-sync
 *
 * Scheduled endpoint for daily Shopify order sync.
 * Authenticated via CRON_SECRET header.
 *
 * Syncs all active Shopify connections.
 *
 * Configuration (via environment variables):
 * - DISABLE_SHOPIFY_SYNC: Set to 'true' to disable
 * - SKIP_SHOPIFY_WEEKENDS: Set to 'true' to skip Saturday/Sunday
 * - SHOPIFY_SYNC_STAGGER_MS: Delay between connections (default 3000)
 * - SHOPIFY_SYNC_MAX_RETRIES: Max retry attempts (default 3)
 */

import { NextRequest, NextResponse } from 'next/server'
import { runScheduledShopifySync } from '@/services/shopify/scheduler'

// Force dynamic rendering
export const dynamic = 'force-dynamic'

// Maximum execution time (10 minutes for large syncs)
export const maxDuration = 600

export async function POST(request: NextRequest) {
  try {
    // Verify cron secret
    const cronSecret = process.env.CRON_SECRET
    const providedSecret = request.headers.get('X-Cron-Secret')

    if (!cronSecret || cronSecret.length < 16) {
      console.error('[Shopify Sync Cron] CRON_SECRET not properly configured')
      return NextResponse.json(
        { error: 'Server configuration error' },
        { status: 500 }
      )
    }

    if (providedSecret !== cronSecret) {
      return NextResponse.json(
        { error: 'Invalid cron secret' },
        { status: 401 }
      )
    }

    // Run scheduled sync
    const result = await runScheduledShopifySync()

    // Check if skipped
    if (result.skipped) {
      return NextResponse.json({
        success: true,
        skipped: result.skipped,
        message: result.skipped === 'disabled'
          ? 'Shopify sync is disabled via DISABLE_SHOPIFY_SYNC'
          : 'Shopify sync skipped on weekend (SKIP_SHOPIFY_WEEKENDS=true)',
        duration: result.duration,
      })
    }

    return NextResponse.json({
      success: true,
      totalConnections: result.totalConnections,
      syncsTriggered: result.syncsTriggered,
      syncsCompleted: result.syncsCompleted,
      syncsFailed: result.syncsFailed,
      results: result.results.map(r => ({
        connectionId: r.connectionId,
        shopName: r.shopName,
        status: r.status,
        ordersProcessed: r.ordersProcessed,
        ordersCreated: r.ordersCreated,
        ordersUpdated: r.ordersUpdated,
        error: r.error,
        retries: r.retryCount,
      })),
      duration: result.duration,
    })
  } catch (error) {
    console.error('[Shopify Sync Cron] Error:', error)
    return NextResponse.json(
      {
        success: false,
        error: error instanceof Error ? error.message : 'Failed to run Shopify sync',
      },
      { status: 500 }
    )
  }
}
```

**Completion Criteria**:
- [ ] File created at specified path
- [ ] Follows ads-sync cron pattern
- [ ] Uses CRON_SECRET authentication
- [ ] `npm run build` passes

---

## Phase 3: Validation

### Subtask 3.1: Build and TypeScript Verification
**Instructions**:
1. Run `npx tsc --noEmit` to verify type checking
2. Run `npm run build` to verify production build
3. Run `npm run lint` to verify linting passes

**Commands**:
```bash
npx tsc --noEmit
npm run build
npm run lint
```

**Completion Criteria**:
- [ ] TypeScript compiles without errors
- [ ] Build succeeds without errors
- [ ] Lint passes

### Subtask 3.2: Verify Cron Endpoint (Optional Manual Test)
**Instructions**:
If testing is desired, the endpoint can be tested with:
```bash
curl -X POST http://172.16.20.50:2345/api/cron/shopify-sync \
  -H "X-Cron-Secret: $CRON_SECRET" \
  -H "Content-Type: application/json"
```

Note: Requires active Shopify connection in test database.

**Completion Criteria**:
- [ ] Endpoint returns 401 without valid secret
- [ ] Endpoint returns 200 with valid secret (or appropriate skip message)

---

## Summary of Deliverables
**Files Created**: 2
- `/home/pbrown/SkuInventory/src/services/shopify/scheduler.ts`
- `/home/pbrown/SkuInventory/src/app/api/cron/shopify-sync/route.ts`

**Files Modified**: 0

---

## Handoff to Build Agent
1. Execute subtasks in exact order (Phase 1 -> Phase 2 -> Phase 3)
2. Create both files with the provided code
3. Run validation commands before completing
4. All existing code already handles the remaining issue tasks

---

## Test Strategy Note
- Use Vitest for unit tests (if adding tests)
- E2E tests not required for cron endpoint
- Focus on build verification

---

## Acceptance Criteria Verification

From the issue:
| Criteria | Status |
|----------|--------|
| Orders sync with order number, date, status, totals, line items | EXISTING - `sync.ts` already does this |
| No duplicates on re-sync | EXISTING - `processBatch()` checks for existing orders |
| Status updates captured (fulfilled, refunded) | EXISTING - `orderData` includes status fields |
| Sync log shows counts and errors | EXISTING - SyncLog model used in `syncAll()` |

The new scheduler/cron work enables daily automated sync while all functional requirements are already met by existing code.

---

## Performance Metrics
| Phase | Estimated Duration |
|-------|----------|
| Phase 1 (Scheduler) | 30m |
| Phase 2 (Cron Endpoint) | 20m |
| Phase 3 (Validation) | 10m |
| **Total** | **~1 hour** |

---

## Environment Variables Reference
New environment variables that can optionally be configured:
- `DISABLE_SHOPIFY_SYNC` - Set to 'true' to disable scheduled sync
- `SKIP_SHOPIFY_WEEKENDS` - Set to 'true' to skip Saturday/Sunday
- `SHOPIFY_SYNC_STAGGER_MS` - Delay between connections (default: 3000)
- `SHOPIFY_SYNC_MAX_RETRIES` - Max retry attempts (default: 3)

These are optional - the scheduler will work with defaults if not set.
