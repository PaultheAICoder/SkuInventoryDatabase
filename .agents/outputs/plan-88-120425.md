# Implementation Plan
**Generated**: 2025-12-04T12:00:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: Issue #88
**Estimated Build Time**: 10-14 hours
**Complexity**: High

## Investigation Summary

### Request Analysis
**Type**: Feature
**Source**: GitHub Issue #88 (Parent #12)
**Priority**: High

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: None (new feature, no existing tests)

### Issue Validation
**Status**: Valid
**Recent Changes**: Lot-related infrastructure already exists from sub-issues 1-3 (schema, lot capture, lot consumption)

### Current State Assessment
- **Existing components**:
  - Lot model and LotBalance model exist in schema.prisma (lines 187-215)
  - TransactionLine has optional `lotId` field (line 283-284)
  - lot-selection.ts service exists for FEFO algorithm
  - `/api/skus/[id]/lot-availability` endpoint exists
- **Database**: Lot, LotBalance models ready; indexes on componentId and expiryDate exist
- **API Routes**: Need to create lot list/detail/trace routes
- **Types**: Need to create src/types/lot.ts
- **Navigation**: Dashboard layout has navigation array at line 29-39

### Dependencies & Blockers
1. **Dependency**: Lot and LotBalance models must exist (CONFIRMED - they do)
2. **Dependency**: TransactionLine.lotId must exist (CONFIRMED - it does)
3. **Dependency**: Component -> Company relationship for tenant scoping (CONFIRMED via companyId)

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: High (new feature with multiple pages, 3 API routes, types, navigation changes)
**Effort**: 10-14 hours
**Risk**: Medium (follows established patterns but new domain)

### Patterns Identified
**Primary**:
- List page: `/src/app/(dashboard)/components/page.tsx` - Server component with search params
- Detail page: `/src/app/(dashboard)/components/[id]/page.tsx` - Client component with fetch
- Table component: `/src/components/features/ComponentTable.tsx` - Client component with filters
- API list route: `/src/app/api/components/route.ts` - GET with pagination
- API detail route: `/src/app/api/components/[id]/route.ts` - GET single item
- Types: `/src/types/component.ts` - Zod schemas + TypeScript interfaces

**Secondary**:
- Transaction API: `/src/app/api/transactions/route.ts` - For reference on lotId inclusion
- Export pattern: `/src/services/export.ts` - For CSV export columns

### Ripple Effect Analysis
**Files Identified**: 7 files to modify, 9 files to create

**Files to Create**:
1. `src/types/lot.ts` - Types and schemas
2. `src/app/api/lots/route.ts` - Lot list API
3. `src/app/api/lots/[id]/route.ts` - Lot detail API
4. `src/app/api/lots/[id]/trace/route.ts` - Trace API
5. `src/app/api/export/lots/route.ts` - Export API
6. `src/app/(dashboard)/lots/page.tsx` - Lot list page
7. `src/app/(dashboard)/lots/[id]/page.tsx` - Lot detail page
8. `src/components/features/LotTable.tsx` - Lot table component
9. `src/services/lot.ts` - Lot query service functions

**Files to Modify**:
1. `src/app/(dashboard)/layout.tsx` - Add navigation item (line 29-39)
2. `src/services/export.ts` - Add lot export columns and types
3. `src/components/features/ExportButton.tsx` - Add 'lots' to exportType union (line 12)

---

## Executive Summary

This implementation adds a recall tracing view that enables operators to search lots by lot number, component, or expiry date range, view lot details including current balance and received info, see complete transaction history for each lot, and identify which SKUs were built using a specific lot. The feature follows the established patterns in the codebase with a server-rendered list page, client-rendered detail page, and paginated API endpoints.

Key deliverables:
1. Lot list page with search/filter/pagination
2. Lot detail page with metadata, balance, transaction history, and affected SKUs
3. API routes for list, detail, and trace operations
4. CSV export for recall documentation
5. Navigation link in sidebar

---

## Phase 0: Create Types and Schemas

### Subtask 0.1: Create Lot Types File
**File**: `/home/pbrown/SkuInventory/src/types/lot.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/types/component.ts`
**Instructions**:
1. Create Zod schemas for lot list query parameters
2. Define TypeScript interfaces for lot response, detail response
3. Include types for expiry status calculation

```typescript
// Key schemas and types to include:
// - lotListQuerySchema (page, pageSize, search, componentId, expiryDateFrom, expiryDateTo, status, sortBy, sortOrder)
// - LotResponse interface (id, lotNumber, componentId, componentName, componentSkuCode, expiryDate, receivedQuantity, balance, supplier, status, createdAt)
// - LotDetailResponse extends LotResponse (transactions, affectedSkus)
// - LotTransactionResponse (id, date, type, quantityChange, skuName?)
// - AffectedSkuResponse (id, name, internalCode, quantityUsed, transactionCount)
// - ExpiryStatus type = 'ok' | 'expiring_soon' | 'expired'
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] File created at correct path
- [ ] Zod schema validates query params
- [ ] TypeScript interfaces match expected API responses
- [ ] No TypeScript errors

---

## Phase 1: Service Layer

### Subtask 1.1: Create Lot Query Service
**File**: `/home/pbrown/SkuInventory/src/services/lot.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/services/inventory.ts`
**Instructions**:
1. Create function to calculate expiry status based on date:
   - `expired`: expiryDate < today
   - `expiring_soon`: expiryDate within 30 days
   - `ok`: expiryDate > 30 days or null
2. Create function to get lot balance from LotBalance table
3. Create function to trace lot through transactions

```typescript
// Functions to implement:
// - calculateExpiryStatus(expiryDate: Date | null): 'ok' | 'expiring_soon' | 'expired'
// - getLotBalance(lotId: string): Promise<number>
// - getAffectedSkusForLot(lotId: string): Promise<Array<{skuId, skuName, internalCode, quantityUsed, transactionCount}>>
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Service file created
- [ ] Expiry status calculation works correctly
- [ ] Functions use proper Prisma queries
- [ ] No TypeScript errors

---

## Phase 2: API Routes

### Subtask 2.1: Create Lot List API Route
**File**: `/home/pbrown/SkuInventory/src/app/api/lots/route.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/app/api/components/route.ts`
**Instructions**:
1. Create GET handler with authentication check
2. Parse query params using lotListQuerySchema
3. Build Prisma where clause with tenant scoping via Component -> companyId
4. Support search by lotNumber, filter by componentId, expiryDate range, status
5. Include component info in response
6. Calculate expiry status for each lot
7. Return paginated response

**Tenant Scoping Pattern**:
```typescript
// Lots are scoped through Component -> Company relationship
const where: Prisma.LotWhereInput = {
  component: {
    companyId: session.user.selectedCompanyId,
  },
  // ... other filters
}
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] GET endpoint returns paginated lot list
- [ ] Search by lot number works
- [ ] Filter by component works
- [ ] Filter by expiry date range works
- [ ] Filter by status (ok/expiring_soon/expired) works
- [ ] Tenant scoping enforced
- [ ] Build passes

### Subtask 2.2: Create Lot Detail API Route
**File**: `/home/pbrown/SkuInventory/src/app/api/lots/[id]/route.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/app/api/components/[id]/route.ts`
**Instructions**:
1. Create GET handler with authentication check
2. Fetch lot with component relation
3. Validate tenant scoping (lot's component must belong to user's company)
4. Get current balance from LotBalance
5. Return lot metadata, balance info

```typescript
// Response should include:
// - Lot metadata (lotNumber, expiryDate, receivedQuantity, supplier, notes, createdAt)
// - Component info (id, name, skuCode)
// - Current balance from LotBalance
// - Expiry status
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] GET endpoint returns lot detail
- [ ] Tenant scoping enforced
- [ ] Returns 404 for non-existent or unauthorized lots
- [ ] Build passes

### Subtask 2.3: Create Lot Trace API Route
**File**: `/home/pbrown/SkuInventory/src/app/api/lots/[id]/trace/route.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/app/api/transactions/route.ts`
**Instructions**:
1. Create GET handler with pagination support
2. Fetch all TransactionLines for this lotId
3. Include transaction details (type, date, sku if build)
4. Extract affected SKUs from build transactions
5. Support pagination for transaction history

**Query Pattern (from issue description)**:
```typescript
// Get all transactions that used this lot
const transactionLines = await prisma.transactionLine.findMany({
  where: { lotId },
  include: {
    transaction: {
      include: {
        sku: true,
        bomVersion: true,
        createdBy: true,
        location: true,
      },
    },
    component: true,
  },
  orderBy: { transaction: { date: 'desc' } },
})

// Extract affected SKUs from build transactions
const affectedSkus = transactionLines
  .filter(line => line.transaction.type === 'build' && line.transaction.sku)
  .reduce((acc, line) => {
    // Aggregate by SKU
  }, new Map())
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] GET endpoint returns transaction history with pagination
- [ ] Includes affected SKUs with quantities
- [ ] Tenant scoping enforced
- [ ] Build passes

### Subtask 2.4: Create Lot Export API Route
**File**: `/home/pbrown/SkuInventory/src/app/api/export/lots/route.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/app/api/export/components/route.ts`
**Instructions**:
1. Create GET handler with authentication
2. Fetch all lots for the company (tenant scoped)
3. Include balance, expiry status, component info
4. Generate CSV using export service

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] CSV export works
- [ ] Tenant scoping enforced
- [ ] Build passes

---

## Phase 3: Update Export Service

### Subtask 3.1: Add Lot Export Types and Columns
**File**: `/home/pbrown/SkuInventory/src/services/export.ts`
**Pattern**: Follow existing `ComponentExportData` and `componentExportColumns`
**Instructions**:
1. Add `LotExportData` interface
2. Add `lotExportColumns` array
3. Update `generateExportFilename` to accept 'lots'

```typescript
// Add to export.ts:
export interface LotExportData {
  id: string
  lotNumber: string
  componentName: string
  componentSkuCode: string
  expiryDate: string | null
  receivedQuantity: string
  balance: string
  supplier: string | null
  status: string
  notes: string | null
  createdAt: string
}

export const lotExportColumns: CSVColumn<LotExportData>[] = [
  { header: 'ID', accessor: (l) => l.id },
  { header: 'Lot Number', accessor: (l) => l.lotNumber },
  { header: 'Component Name', accessor: (l) => l.componentName },
  { header: 'Component SKU', accessor: (l) => l.componentSkuCode },
  { header: 'Expiry Date', accessor: (l) => l.expiryDate },
  { header: 'Received Quantity', accessor: (l) => l.receivedQuantity },
  { header: 'Current Balance', accessor: (l) => l.balance },
  { header: 'Supplier', accessor: (l) => l.supplier },
  { header: 'Status', accessor: (l) => l.status },
  { header: 'Notes', accessor: (l) => l.notes },
  { header: 'Created At', accessor: (l) => l.createdAt },
]

// Update generateExportFilename to accept 'lots'
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Types added
- [ ] Columns defined
- [ ] No TypeScript errors

### Subtask 3.2: Update ExportButton Component
**File**: `/home/pbrown/SkuInventory/src/components/features/ExportButton.tsx`
**Pattern**: Existing component
**Instructions**:
1. Update `exportType` prop type from `'components' | 'skus' | 'transactions'` to include `'lots'`

```typescript
// Line 12, change to:
exportType: 'components' | 'skus' | 'transactions' | 'lots'
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Type union updated
- [ ] No TypeScript errors

---

## Phase 4: Frontend Components

### Subtask 4.1: Create LotTable Component
**File**: `/home/pbrown/SkuInventory/src/components/features/LotTable.tsx`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/components/features/ComponentTable.tsx`
**Instructions**:
1. Create client component with 'use client' directive
2. Accept props: lots, total, page, pageSize
3. Implement search input (lot number search)
4. Implement filters: component dropdown, expiry status dropdown, date range
5. Implement sortable table columns
6. Implement pagination controls
7. Display: Lot Number, Component, Expiry Date, Balance, Status (with Badge)
8. Link lot number to detail page

**Status Badge Mapping**:
```typescript
const getStatusBadgeVariant = (status: string) => {
  switch (status) {
    case 'expired': return 'critical'
    case 'expiring_soon': return 'warning'
    case 'ok': return 'success'
    default: return 'secondary'
  }
}
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Table displays lot data
- [ ] Search works
- [ ] Filters work
- [ ] Pagination works
- [ ] Status badges display correctly
- [ ] Links to detail page
- [ ] No TypeScript errors

### Subtask 4.2: Create Lot List Page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/lots/page.tsx`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/app/(dashboard)/components/page.tsx`
**Instructions**:
1. Create server component (no 'use client')
2. Get session and redirect if not authenticated
3. Parse search params
4. Fetch lots from API with tenant scoping
5. Render page header with title and export button
6. Render LotTable component with Suspense wrapper

```typescript
// Use session.user.selectedCompanyId for tenant scoping
// Fetch lots via prisma directly (server component pattern)
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Page renders
- [ ] Authentication enforced
- [ ] Data fetched with tenant scoping
- [ ] Export button present
- [ ] Build passes

### Subtask 4.3: Create Lot Detail Page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/lots/[id]/page.tsx`
**Pattern**: Follow `/home/pbrown/SkuInventory/src/app/(dashboard)/components/[id]/page.tsx`
**Instructions**:
1. Create client component with 'use client'
2. Fetch lot detail and trace data from APIs
3. Display header with back button, lot number, status badge
4. Create info cards:
   - Balance card: Current balance, Received quantity
   - Component card: Component name, SKU code, link to component
   - Received info card: Date, Supplier
5. Create Transaction History table (paginated):
   - Date, Type, Quantity Change, SKU (if build)
   - Link to transaction detail
6. Create Affected SKUs table:
   - SKU Name, Internal Code, Quantity Used, Transaction Count
   - Link to SKU detail

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Page renders
- [ ] Back button works
- [ ] Info cards display correctly
- [ ] Transaction history table paginated
- [ ] Affected SKUs table displays
- [ ] All links work
- [ ] Build passes

---

## Phase 5: Navigation Update

### Subtask 5.1: Add Lots Navigation Item
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/layout.tsx`
**Pattern**: Existing navigation array (lines 29-39)
**Instructions**:
1. Import `Package2` or similar icon from lucide-react (or reuse existing)
2. Add Lots item to navigation array after Transactions (to group inventory-related items)

```typescript
// Add to imports (line 22 area):
import { Layers } from 'lucide-react'  // Or use Package2

// Add to navigation array (after line 33, Transactions):
{ name: 'Lots', href: '/lots', icon: Layers },
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Lots item appears in sidebar navigation
- [ ] Icon displays correctly
- [ ] Link navigates to /lots
- [ ] Active state highlights when on /lots pages
- [ ] Build passes

---

## Phase 6: Verification

### Subtask 6.1: Final Build and Type Check
**Instructions**:
1. Run full build
2. Run type check
3. Verify no lint errors

```bash
npm run build
npx tsc --noEmit
npm run lint
```

**Completion Criteria**:
- [ ] `npm run build` passes without errors
- [ ] `npx tsc --noEmit` passes without errors
- [ ] No lint errors

---

## Summary of Deliverables

**Files Created**: 9
- `src/types/lot.ts`
- `src/services/lot.ts`
- `src/app/api/lots/route.ts`
- `src/app/api/lots/[id]/route.ts`
- `src/app/api/lots/[id]/trace/route.ts`
- `src/app/api/export/lots/route.ts`
- `src/app/(dashboard)/lots/page.tsx`
- `src/app/(dashboard)/lots/[id]/page.tsx`
- `src/components/features/LotTable.tsx`

**Files Modified**: 3
- `src/services/export.ts` (add lot export types/columns)
- `src/components/features/ExportButton.tsx` (add 'lots' to type)
- `src/app/(dashboard)/layout.tsx` (add navigation item)

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 0 -> 1 -> 2 -> 3 -> 4 -> 5 -> 6)
2. Run validation commands after each subtask
3. Verify completion criteria before moving to next subtask
4. Follow reference patterns exactly - pay special attention to:
   - Tenant scoping via `session.user.selectedCompanyId`
   - API response patterns using `success()`, `paginated()`, `notFound()` helpers
   - Client vs Server component patterns
   - Zod schema validation with `parseQuery()` and `parseBody()`

## Test Strategy Note
- TARGETED testing recommended
- Test lot list API with various filters
- Test lot detail API with valid/invalid IDs
- Test trace API pagination
- Test export functionality
- Test navigation item rendering

## UI Acceptance Criteria (from issue)
- [ ] Lots page lists all lots with search and filtering
- [ ] Lot detail page shows complete lot information
- [ ] Transaction history shows all movements for the lot
- [ ] Affected SKUs list shows all builds that consumed from this lot
- [ ] Expiry status is clearly indicated (OK, expiring soon, expired)
- [ ] Navigation includes link to Lots section
- [ ] All queries respect tenant scoping
- [ ] Pagination works for large transaction histories
- [ ] `npm run build` and `npx tsc --noEmit` pass without errors

## Performance Metrics
| Phase | Estimated Duration |
|-------|----------|
| Phase 0: Types | 30m |
| Phase 1: Service | 45m |
| Phase 2: API Routes | 3h |
| Phase 3: Export | 30m |
| Phase 4: Frontend | 4h |
| Phase 5: Navigation | 15m |
| Phase 6: Verification | 15m |
| **Total** | **~9-10h** |
