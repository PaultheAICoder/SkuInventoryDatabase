# Implementation Plan
**Generated**: 2025-12-31 09:45:00 UTC
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #333
**Estimated Build Time**: 2-3 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Bug
**Source**: GitHub Issue #333
**Priority**: High (affects user experience and appears as errors)

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="role|auth"` or None (focused changes)

### Issue Validation
**Status**: Valid
**Recent Changes**: Issue #310 (fix legacy role checks) was closed 2025-12-17 but missed these files

### Current State Assessment

**Root Cause Identified**:
When a user selects the "Rise" brand, the API routes correctly use `getSelectedCompanyRole()` which returns the user's role for that specific company (`ops` for Rise). However, the client-side dashboard components still check the legacy `session.user.role` field which contains the global role (`admin`), creating a mismatch:

- User: Paul Brown / Trevor Baek
- Global `User.role`: `admin`
- `UserCompany.role` for Tonsil Tech: `admin` (works fine)
- `UserCompany.role` for Rise: `ops` (causes errors)

**What happens**:
1. User selects Rise brand
2. Sidebar shows Settings menu (because `session.user.role === 'admin'` is true)
3. User clicks on Brands/Categories/Companies/Settings
4. API returns 403 Forbidden (because `getSelectedCompanyRole()` correctly returns `ops`)
5. User sees error message on page

**Fix Pattern**: Replace `session.user.role === 'admin'` with `getClientCompanyRole(session.user) === 'admin'`

### Dependencies & Blockers
None - the helper function `getClientCompanyRole` already exists in `src/lib/utils.ts`

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Simple
**Effort**: 2-3 hours
**Risk**: Low (pattern is already established in other files)

### Patterns Identified
**Primary**: `src/app/(dashboard)/import/page.tsx` - lines 8, 34
- Already uses `getClientCompanyRole` correctly

**Secondary**: `src/app/(dashboard)/settings/alerts/page.tsx` - lines 7, 60
- Already uses `getClientCompanyRole` correctly

### Ripple Effect Analysis
**Files Identified**: 4 files need updates

| File | Line | Current Code | Impact |
|------|------|--------------|--------|
| `src/app/(dashboard)/layout.tsx` | 76 | `session?.user?.role === 'admin'` | Settings menu visibility |
| `src/app/(dashboard)/integrations/page.tsx` | 121 | `session?.user?.role === 'admin'` | Admin features on integration cards |
| `src/app/(dashboard)/forecasts/page.tsx` | 38 | `session?.user?.role === 'admin'` | Forecast edit permissions |
| `src/app/(dashboard)/admin/docker-health/page.tsx` | 48, 58, 62 | `session.user.role !== 'admin'` | Admin-only page access |

---

## Executive Summary

This bug occurs because 4 client-side files still use the legacy `session.user.role` field for permission checks instead of the company-specific `getClientCompanyRole()` helper. When a user selects a company where they have a lower role (e.g., `ops` instead of `admin`), the UI shows options they cannot access, resulting in 403 errors. The fix involves updating these files to use the existing `getClientCompanyRole()` utility.

---

## Phase 1: Update Client-Side Role Checks

### Subtask 1.1: Update Dashboard Layout (Sidebar Navigation)
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/layout.tsx`
**Pattern**: Follow `src/app/(dashboard)/import/page.tsx` lines 8, 34
**Instructions**:

1. Add import for `getClientCompanyRole` from `@/lib/utils`:
   ```typescript
   import { getClientCompanyRole } from '@/lib/utils'
   ```

2. Replace line 76:
   ```typescript
   // OLD:
   const isAdmin = session?.user?.role === 'admin'

   // NEW:
   const isAdmin = getClientCompanyRole(session?.user) === 'admin'
   ```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Import added for `getClientCompanyRole`
- [ ] `isAdmin` uses `getClientCompanyRole(session?.user)` instead of `session?.user?.role`
- [ ] TypeScript compiles without errors
- [ ] Build succeeds

### Subtask 1.2: Update Integrations Page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/integrations/page.tsx`
**Pattern**: Follow `src/app/(dashboard)/import/page.tsx` lines 8, 34
**Instructions**:

1. Add import for `getClientCompanyRole` from `@/lib/utils`:
   ```typescript
   import { getClientCompanyRole } from '@/lib/utils'
   ```

2. Replace line 121:
   ```typescript
   // OLD:
   const isAdmin = session?.user?.role === 'admin'

   // NEW:
   const isAdmin = getClientCompanyRole(session?.user) === 'admin'
   ```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Import added for `getClientCompanyRole`
- [ ] `isAdmin` uses `getClientCompanyRole(session?.user)` instead of `session?.user?.role`
- [ ] TypeScript compiles without errors
- [ ] Build succeeds

### Subtask 1.3: Update Forecasts Page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/forecasts/page.tsx`
**Pattern**: Follow `src/app/(dashboard)/import/page.tsx` lines 8, 34
**Instructions**:

1. Add import for `getClientCompanyRole` from `@/lib/utils`:
   ```typescript
   import { getClientCompanyRole } from '@/lib/utils'
   ```

2. Replace line 38:
   ```typescript
   // OLD:
   const canEdit = session?.user?.role === 'admin'

   // NEW:
   const canEdit = getClientCompanyRole(session?.user) === 'admin'
   ```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Import added for `getClientCompanyRole`
- [ ] `canEdit` uses `getClientCompanyRole(session?.user)` instead of `session?.user?.role`
- [ ] TypeScript compiles without errors
- [ ] Build succeeds

### Subtask 1.4: Update Docker Health Page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/admin/docker-health/page.tsx`
**Pattern**: Follow `src/app/(dashboard)/import/page.tsx` lines 8, 34
**Instructions**:

1. Add import for `getClientCompanyRole` from `@/lib/utils`:
   ```typescript
   import { getClientCompanyRole } from '@/lib/utils'
   ```

2. Replace line 48:
   ```typescript
   // OLD:
   if (session.user.role !== 'admin') {

   // NEW:
   if (getClientCompanyRole(session.user) !== 'admin') {
   ```

3. Replace line 58:
   ```typescript
   // OLD:
   if (status !== 'authenticated' || session?.user?.role !== 'admin') return

   // NEW:
   if (status !== 'authenticated' || getClientCompanyRole(session?.user) !== 'admin') return
   ```

4. Replace line 62 (within the dependencies array of useEffect):
   ```typescript
   // OLD:
   }, [status, session?.user?.role, fetchData])

   // NEW - create a derived companyRole variable:
   ```

   **Note**: Since useEffect dependencies should be primitive values, refactor to:
   ```typescript
   // Before the useEffect, add:
   const companyRole = getClientCompanyRole(session?.user)

   // Update useEffect line 57-62:
   useEffect(() => {
     if (status !== 'authenticated' || companyRole !== 'admin') return

     const interval = setInterval(fetchData, 30000)
     return () => clearInterval(interval)
   }, [status, companyRole, fetchData])
   ```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Import added for `getClientCompanyRole`
- [ ] All 3 role checks use `getClientCompanyRole()` instead of `session.user.role`
- [ ] useEffect dependency updated to use derived `companyRole` variable
- [ ] TypeScript compiles without errors
- [ ] Build succeeds

---

## Phase 2: Verification

### Subtask 2.1: Full Build Verification
**Instructions**:
```bash
npm run build
npx tsc --noEmit
npm run lint
```

**Completion Criteria**:
- [ ] Build succeeds without errors
- [ ] TypeScript check passes
- [ ] Lint passes

### Subtask 2.2: Manual Test Verification (Document for User)
**Instructions**:
Document these manual test steps for the user to verify:

1. Log in as user with multiple companies (pbrown@vital-enterprises.com or tbaek@vital-enterprises.com)
2. Select "Rise" brand from dropdown
3. Verify Settings menu items are NOT visible (since user has `ops` role for Rise)
4. Switch to "Tonsil Tech" brand
5. Verify Settings menu items ARE visible (since user has `admin` role for Tonsil Tech)
6. Click through each Settings page to verify no 403 errors

**Completion Criteria**:
- [ ] Settings menu correctly hidden when non-admin role for selected company
- [ ] Settings menu correctly shown when admin role for selected company
- [ ] No 403 errors when navigating to pages user should have access to

---

## Summary of Deliverables

**Files Created**: 0
**Files Modified**: 4

| File | Changes |
|------|---------|
| `src/app/(dashboard)/layout.tsx` | Add import, update `isAdmin` calculation |
| `src/app/(dashboard)/integrations/page.tsx` | Add import, update `isAdmin` calculation |
| `src/app/(dashboard)/forecasts/page.tsx` | Add import, update `canEdit` calculation |
| `src/app/(dashboard)/admin/docker-health/page.tsx` | Add import, update 3 role checks, add derived variable |

---

## Handoff to Build Agent

1. Execute subtasks in exact order (1.1 -> 1.2 -> 1.3 -> 1.4 -> 2.1)
2. Each file should be validated with `npx tsc --noEmit` after modification
3. Final build verification confirms all changes work together
4. Follow reference patterns exactly from `src/app/(dashboard)/import/page.tsx`

---

## Test Strategy Note

- **Unit Tests**: No unit tests needed - this is a simple pattern replacement
- **Manual Testing**: User should verify behavior with Rise vs Tonsil Tech brand selection
- **E2E Tests**: If existing, run against test environment (http://172.16.20.50:2345)

---

## Related Issues

- **Issue #310**: "Remove Legacy Global Role Checks" - This was the original fix that missed these 4 files
- The pattern and helper function (`getClientCompanyRole`) were established in issue #310

---

## Performance Metrics

| Phase | Duration |
|-------|----------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 10m |
| **Total** | **30m** |
