# Implementation Plan
**Generated**: 2025-12-17T21:45:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #314
**Estimated Build Time**: 3-4 hours
**Complexity**: Medium

## Investigation Summary

### Request Analysis
**Type**: Bug Fix (Test Infrastructure)
**Source**: GitHub Issue #314
**Priority**: Medium - Test infrastructure issue affecting multiple integration test files

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="lot-consumption"` after fix, then full integration suite

### Issue Validation
**Status**: Valid but root cause has evolved
**Recent Changes**:
- Commit `5689b18` (issue #310) introduced `getSelectedCompanyRole()` which requires `session.user.companies` array
- This broke ALL integration tests that use `setTestSession()` because the mock doesn't include `companies`

### Current State Assessment

**Root Causes Identified (TWO related issues)**:

1. **Test Session Mock Missing `companies` Array** (BLOCKING)
   - `getSelectedCompanyRole()` in `src/lib/auth.ts:410` expects `session.user.companies`
   - `TestUserSession` interface in `tests/helpers/auth-mock.ts` does NOT include `companies`
   - This causes ALL tests that call API routes using role checks to fail with:
     `TypeError: Cannot read properties of undefined (reading 'find')`
   - **142 tests failing** across 12 integration test files

2. **createLotWithBalance Missing InventoryBalance** (ORIGINAL REPORT)
   - `createLotWithBalance()` creates `Lot` + `LotBalance` records
   - `checkInsufficientInventory()` checks `InventoryBalance` table (not `LotBalance`)
   - Lots appear to have inventory, but build validation fails
   - **Would affect 6 tests** in `lot-consumption.test.ts` after session fix

**Files Affected**:
- `tests/helpers/auth-mock.ts` - Session mock needs `companies` array
- `tests/integration/lot-consumption.test.ts` - `createLotWithBalance()` helper needs to create `InventoryBalance`

### Dependencies & Blockers
1. **Issue #1 blocks Issue #2**: Cannot verify inventory fix until session fix is applied
2. Both fixes are isolated to test infrastructure - no production code changes needed

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Medium
**Effort**: 3-4 hours
**Risk**: Low - changes only affect test infrastructure

### Patterns Identified
**Primary Reference**: `tests/helpers/integration-context.ts:addPooledInventory()` - creates `Transaction` with `TransactionLine` which triggers `InventoryBalance` update
**Secondary Reference**: `src/services/inventory.ts:createReceiptTransaction()` - production pattern for creating inventory with proper balances

### Ripple Effect Analysis

**Pattern Detection - Similar Bugs Across Files**:
Searched for similar `createLotWithBalance` usage pattern:
```bash
grep -l "createLotWithBalance" tests/
```
Result: Only `tests/integration/lot-consumption.test.ts` uses this pattern

**Files Affected by Session Fix**:
All 12 integration test files benefit from the session fix but require no individual changes.

**Files Identified**: 2 (direct changes)
- `tests/helpers/auth-mock.ts` - Add `companies` to TestUserSession and session initialization
- `tests/integration/lot-consumption.test.ts` - Update `createLotWithBalance()` to also create `InventoryBalance`

---

## Executive Summary

This issue involves TWO related bugs in the test infrastructure:

1. **Session Mock Bug (5689b18 regression)**: The integration test session mock is missing the `companies` array that `getSelectedCompanyRole()` now requires. This breaks 142 tests across all integration test files.

2. **Inventory Balance Bug (original report)**: The `createLotWithBalance()` helper creates lots without corresponding `InventoryBalance` records, causing build validation to fail even though lots have quantity.

Both fixes are isolated to test infrastructure and do not affect production code.

## Phase 1: Fix Test Session Mock (HIGH PRIORITY)

### Subtask 1.1: Update TestUserSession Interface
**File**: `/home/pbrown/SkuInventory/tests/helpers/auth-mock.ts`
**Pattern**: Follow `src/lib/auth.ts:284-300` session User interface
**Instructions**:
1. Add `companies` array to `TestUserSession.user` interface
2. Add `companiesWithBrands` array (optional but maintains consistency)
3. Add `brands` array
4. Add `selectedBrandId` and `selectedBrandName` fields

```typescript
// Add to TestUserSession interface (around line 32-42)
export interface TestUserSession {
  user: {
    id: string
    email: string
    name: string
    role: 'admin' | 'ops' | 'viewer'
    companyId: string
    companyName: string
    selectedCompanyId: string
    selectedCompanyName: string
    // NEW: Add companies array for getSelectedCompanyRole()
    companies: Array<{ id: string; name: string; role?: string }>
    companiesWithBrands: Array<{ id: string; name: string; role?: string; brands: Array<{ id: string; name: string }> }>
    brands: Array<{ id: string; name: string }>
    selectedBrandId: string | null
    selectedBrandName: string | null
  }
}
```

**Completion Criteria**:
- [ ] Interface includes `companies` array
- [ ] Interface includes `companiesWithBrands` array
- [ ] Interface includes `brands`, `selectedBrandId`, `selectedBrandName`
- [ ] TypeScript compiles without errors

### Subtask 1.2: Update initializeTestSessions to Populate New Fields
**File**: `/home/pbrown/SkuInventory/tests/helpers/auth-mock.ts`
**Pattern**: Follow existing session initialization in lines 82-129
**Instructions**:
1. Fetch brand data along with user/company data
2. Update TEST_SESSIONS.admin, ops, viewer objects to include all new fields
3. Set role in companies array from user's role (for single-company test setup)

```typescript
// Update initializeTestSessions (around line 76+)
export async function initializeTestSessions(prisma: PrismaClient): Promise<void> {
  // ... existing checks ...

  const [admin, ops, viewer, company, brand] = await Promise.all([
    prisma.user.findUnique({ where: { email: 'admin@tonsil.tech' } }),
    prisma.user.findUnique({ where: { email: 'ops@tonsil.tech' } }),
    prisma.user.findUnique({ where: { email: 'viewer@tonsil.tech' } }),
    prisma.company.findFirst({ where: { name: 'Tonsil Tech' } }),
    prisma.brand.findFirst({ where: { company: { name: 'Tonsil Tech' }, isActive: true } }),
  ])

  // ... error checks ...

  TEST_SESSIONS.admin = {
    user: {
      id: admin.id,
      email: admin.email,
      name: admin.name,
      role: admin.role as 'admin',
      companyId: company.id,
      companyName: company.name,
      selectedCompanyId: company.id,
      selectedCompanyName: company.name,
      // NEW fields
      companies: [{ id: company.id, name: company.name, role: admin.role }],
      companiesWithBrands: [{
        id: company.id,
        name: company.name,
        role: admin.role,
        brands: brand ? [{ id: brand.id, name: brand.name }] : []
      }],
      brands: brand ? [{ id: brand.id, name: brand.name }] : [],
      selectedBrandId: brand?.id ?? null,
      selectedBrandName: brand?.name ?? null,
    },
  }
  // ... repeat for ops and viewer ...
}
```

**Completion Criteria**:
- [ ] Brand is fetched in initializeTestSessions
- [ ] All three session objects (admin, ops, viewer) include companies array
- [ ] Role is set in companies array entries
- [ ] companiesWithBrands includes brand data

### Subtask 1.3: Update Dynamic Session Creation in lot-consumption.test.ts
**File**: `/home/pbrown/SkuInventory/tests/integration/lot-consumption.test.ts`
**Pattern**: Follow updated TestUserSession interface
**Instructions**:
1. Update the custom session creation around line 493-500 (Company B context switch)
2. Ensure companies array is included when creating custom sessions

```typescript
// Around line 493-500, update setTestSession call:
setTestSession({
  user: {
    ...TEST_SESSIONS.admin!.user,
    companyId: companyB.companyId,
    selectedCompanyId: companyB.companyId,
    selectedCompanyName: 'Test Company',
    companyName: 'Test Company',
    companies: [{ id: companyB.companyId, name: 'Test Company', role: 'admin' }],
    companiesWithBrands: [{
      id: companyB.companyId,
      name: 'Test Company',
      role: 'admin',
      brands: [{ id: companyB.brandId, name: 'Test Brand' }]
    }],
    brands: [{ id: companyB.brandId, name: 'Test Brand' }],
    selectedBrandId: companyB.brandId,
    selectedBrandName: 'Test Brand',
  },
})
```

**Completion Criteria**:
- [ ] Custom session in cross-tenant tests includes companies array
- [ ] TypeScript compiles without errors

## Phase 2: Fix createLotWithBalance to Include InventoryBalance

### Subtask 2.1: Update createLotWithBalance Helper
**File**: `/home/pbrown/SkuInventory/tests/integration/lot-consumption.test.ts`
**Pattern**: Follow `addPooledInventory()` pattern from `tests/helpers/integration-context.ts:102-126`
**Instructions**:
1. Modify `createLotWithBalance()` to also create `InventoryBalance` record
2. Get or create default location for the component's company
3. Use Prisma transaction for atomicity

```typescript
// Update createLotWithBalance (around line 47-70)
async function createLotWithBalance(
  componentId: string,
  lotNumber: string,
  quantity: number,
  expiryDate?: Date
): Promise<{ lotId: string; lotNumber: string }> {
  const prisma = getIntegrationPrisma()

  // Get component to find companyId
  const component = await prisma.component.findUnique({
    where: { id: componentId },
    select: { companyId: true },
  })
  if (!component) throw new Error('Component not found')

  // Get default location for inventory balance
  const location = await getOrCreateDefaultLocation(component.companyId)

  const lot = await prisma.lot.create({
    data: {
      componentId,
      lotNumber,
      expiryDate,
      receivedQuantity: new Prisma.Decimal(quantity),
      supplier: 'Test Supplier',
    },
  })

  await prisma.lotBalance.create({
    data: {
      lotId: lot.id,
      quantity: new Prisma.Decimal(quantity),
    },
  })

  // NEW: Create InventoryBalance for checkInsufficientInventory
  await prisma.inventoryBalance.upsert({
    where: {
      componentId_locationId: {
        componentId,
        locationId: location.id,
      },
    },
    create: {
      componentId,
      locationId: location.id,
      quantity: new Prisma.Decimal(quantity),
    },
    update: {
      quantity: {
        increment: new Prisma.Decimal(quantity),
      },
    },
  })

  return { lotId: lot.id, lotNumber: lot.lotNumber }
}
```

**Completion Criteria**:
- [ ] Function creates `Lot` record
- [ ] Function creates `LotBalance` record
- [ ] Function creates/updates `InventoryBalance` record
- [ ] Uses upsert to handle multiple lots for same component

## Phase 3: Validation

### Subtask 3.1: Run lot-consumption Integration Tests
**File**: N/A (command)
**Instructions**:
1. Run the lot-consumption tests specifically
2. Verify all 8 tests pass

```bash
npm run test:integration -- tests/integration/lot-consumption.test.ts
```

**Completion Criteria**:
- [ ] All 8 tests pass
- [ ] No TypeScript compilation errors

### Subtask 3.2: Run Full Integration Test Suite
**File**: N/A (command)
**Instructions**:
1. Run the complete integration test suite
2. Verify significant improvement from 67 passing to 180+ passing

```bash
npm run test:integration
```

**Completion Criteria**:
- [ ] 142+ previously failing tests now pass
- [ ] Only unrelated test failures remain (if any)

### Subtask 3.3: Verify Build and TypeScript Compilation
**File**: N/A (command)
**Instructions**:
1. Run TypeScript compilation
2. Run production build

```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] No TypeScript errors
- [ ] Build completes successfully

---

## Summary of Deliverables
**Files Created**: 0
**Files Modified**: 2
- `tests/helpers/auth-mock.ts` - Updated session interface and initialization
- `tests/integration/lot-consumption.test.ts` - Updated createLotWithBalance helper and custom sessions

## Handoff to Build Agent
1. Execute subtasks in exact order (Phase 1 before Phase 2)
2. Complete all Phase 1 subtasks before moving to Phase 2
3. Test completion criteria before next subtask
4. Session fix must be done first as it blocks inventory fix verification
5. Run validation tests after each phase

## Test Strategy Note
- Use Vitest for integration tests
- Run `npm run test:integration` for full suite
- Run with `-- tests/integration/lot-consumption.test.ts` for targeted testing

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 25m |
| Validation | 10m |
| Planning | 15m |
| **Total** | **50m** |
