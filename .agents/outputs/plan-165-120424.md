# Implementation Plan
**Generated**: 2025-12-04T22:30:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #165
**Estimated Build Time**: 4-6 hours
**Complexity**: Medium

## Investigation Summary

### Request Analysis
**Type**: Enhancement / UX Improvement
**Source**: GitHub Issue #165
**Priority**: Low (current error message is actionable; this is a UX polish)

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="import"` or None

### Issue Validation
**Status**: Valid
**Recent Changes**: Issue #153 fixed the core brand resolution bug on Dec 4, 2025. Issue #165 was created as deferred Phase 2 work from #153.

### Background Context

Issue #153 fixed the "No active brand found" error during inventory snapshot imports. The fix improved the error message to be more actionable:

> "No active brand found for selected company. Please select a brand from the sidebar or create one in Brand Management."

Issue #165 enhances the UX by showing a dialog that allows users to select a brand without leaving the import page, then auto-retrying the import after brand selection.

### Current State Assessment
- **Existing components**:
  - `ImportForm.tsx` - handles file upload and API calls (line 117-127 handle upload and error display)
  - `ImportResultDialog.tsx` - shows results AFTER import completes
  - `BrandSelector.tsx` - sidebar brand selector (lines 24-65 contain brand switch logic)
  - `inventory-snapshot/route.ts` - API endpoint returns 400 with "No active brand found" message

- **Database**: Brand model exists with `companyId` foreign key
- **API Routes**: `/api/brands/switch` exists and persists brand selection
- **Types**: Session types include:
  - `selectedBrandId: string | null`
  - `selectedBrandName: string | null`
  - `brands: Array<{ id: string; name: string }>`

### Dependencies & Blockers
1. None - all required patterns and APIs exist

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Medium
**Effort**: 4-6 hours
**Risk**: Low - follows existing dialog and brand selection patterns

### Patterns Identified
**Primary Dialog Pattern**: `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx` (lines 56-687)
- Dialog with Select dropdown
- Form state management with useState
- Loading state handling
- Error display
- API calls with try/catch

**Primary Brand Switch Pattern**: `/home/pbrown/SkuInventory/src/components/features/BrandSelector.tsx` (lines 24-65)
- `handleBrandChange` function calls `/api/brands/switch`
- Updates session via `updateSession`
- Toast notifications for success/error

**Error Handling Pattern**: `/home/pbrown/SkuInventory/src/components/features/ImportForm.tsx` (lines 148-157)
- Error captured in catch block
- `setUploadError(errorMessage)` for display
- Toast notifications via `toast.error()`

### Ripple Effect Analysis
**Files Identified**: 3 files

| File | Reason |
|------|--------|
| `/home/pbrown/SkuInventory/src/components/features/BrandSelectionDialog.tsx` (NEW) | New dialog component for brand selection |
| `/home/pbrown/SkuInventory/src/components/features/ImportForm.tsx` | Add brand dialog trigger and retry logic |
| `/home/pbrown/SkuInventory/tests/e2e/brand-selection-dialog-import.spec.ts` (NEW) | E2E test for the new flow |

---

## Executive Summary

This enhancement adds a BrandSelectionDialog component that appears when an import fails due to missing brand selection. Instead of just showing an error message, users can select a brand from a dropdown, the selection is persisted via `/api/brands/switch`, and the import auto-retries. This improves UX by keeping users on the import page without requiring navigation to the sidebar.

## Phase 1: Create BrandSelectionDialog Component

### Subtask 1.1: Create BrandSelectionDialog.tsx
**File**: `/home/pbrown/SkuInventory/src/components/features/BrandSelectionDialog.tsx` (NEW)
**Pattern Reference**:
- Dialog structure: `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx:276-283`
- Select dropdown: `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx:409-429`
- Brand switch logic: `/home/pbrown/SkuInventory/src/components/features/BrandSelector.tsx:24-65`

**Instructions**:

Create a new dialog component that:
1. Shows available brands from `session.user.brands`
2. Allows user to select a brand from a dropdown
3. Calls `/api/brands/switch` to persist selection
4. Updates session via `updateSession`
5. Notifies parent via callback for retry

**Required Code Structure**:

```typescript
'use client'

import { useState } from 'react'
import { useSession } from 'next-auth/react'
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import { Label } from '@/components/ui/label'
import { AlertTriangle } from 'lucide-react'
import { toast } from 'sonner'

interface BrandSelectionDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  onBrandSelected: (brandId: string) => void
  title?: string
  description?: string
}

export function BrandSelectionDialog({
  open,
  onOpenChange,
  onBrandSelected,
  title = 'Brand Required',
  description = 'Please select a brand to continue with the import.',
}: BrandSelectionDialogProps) {
  const { data: session, update: updateSession } = useSession()
  const [selectedBrandId, setSelectedBrandId] = useState<string>('')
  const [isLoading, setIsLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)

  const brands = session?.user?.brands || []

  const handleClose = () => {
    setSelectedBrandId('')
    setError(null)
    onOpenChange(false)
  }

  const handleConfirm = async () => {
    if (!selectedBrandId) {
      setError('Please select a brand')
      return
    }

    setIsLoading(true)
    setError(null)
    try {
      const res = await fetch('/api/brands/switch', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ brandId: selectedBrandId }),
      })

      if (!res.ok) {
        const data = await res.json().catch(() => ({}))
        throw new Error(data?.error || 'Failed to set brand')
      }

      const data = await res.json()

      // Update session with new brand
      await updateSession({
        selectedBrandId: data.data.selectedBrandId,
        selectedBrandName: data.data.selectedBrandName,
      })

      toast.success(`Brand set to ${data.data.selectedBrandName}`)

      // Notify parent and close
      onBrandSelected(selectedBrandId)
      handleClose()
    } catch (err) {
      console.error('Error setting brand:', err)
      setError(err instanceof Error ? err.message : 'Failed to set brand. Please try again.')
    } finally {
      setIsLoading(false)
    }
  }

  // Handle case where user has no brands
  if (brands.length === 0) {
    return (
      <Dialog open={open} onOpenChange={handleClose}>
        <DialogContent className="sm:max-w-[425px]">
          <DialogHeader>
            <DialogTitle className="flex items-center gap-2">
              <AlertTriangle className="h-5 w-5 text-yellow-500" />
              No Brands Available
            </DialogTitle>
            <DialogDescription>
              No brands are configured for your company. Please contact an administrator to create a brand, or go to Settings &gt; Brands to create one.
            </DialogDescription>
          </DialogHeader>
          <DialogFooter>
            <Button onClick={handleClose}>Close</Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    )
  }

  return (
    <Dialog open={open} onOpenChange={handleClose}>
      <DialogContent className="sm:max-w-[425px]">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <AlertTriangle className="h-5 w-5 text-yellow-500" />
            {title}
          </DialogTitle>
          <DialogDescription>{description}</DialogDescription>
        </DialogHeader>

        <div className="grid gap-4 py-4">
          {error && (
            <div className="rounded-md bg-destructive/10 p-3 text-sm text-destructive">
              {error}
            </div>
          )}

          <div className="grid grid-cols-4 items-center gap-4">
            <Label htmlFor="brand-select" className="text-right">
              Brand
            </Label>
            <Select value={selectedBrandId} onValueChange={setSelectedBrandId}>
              <SelectTrigger id="brand-select" className="col-span-3">
                <SelectValue placeholder="Select a brand" />
              </SelectTrigger>
              <SelectContent>
                {brands.map((brand) => (
                  <SelectItem key={brand.id} value={brand.id}>
                    {brand.name}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>
        </div>

        <DialogFooter>
          <Button type="button" variant="outline" onClick={handleClose}>
            Cancel
          </Button>
          <Button onClick={handleConfirm} disabled={isLoading || !selectedBrandId}>
            {isLoading ? 'Setting...' : 'Continue with Import'}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  )
}
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Component file created at `/src/components/features/BrandSelectionDialog.tsx`
- [ ] Uses Dialog, Select, Button from existing UI components
- [ ] Follows BuildDialog pattern for layout (DialogHeader, DialogFooter)
- [ ] Follows BrandSelector pattern for `/api/brands/switch` call
- [ ] Updates session via `updateSession`
- [ ] Handles loading state with disabled button
- [ ] Handles error state with error message display
- [ ] TypeScript compiles without errors
- [ ] Build succeeds

## Phase 2: Update ImportForm to Trigger Brand Selection Dialog

### Subtask 2.1: Add Brand Selection Dialog State and Import to ImportForm
**File**: `/home/pbrown/SkuInventory/src/components/features/ImportForm.tsx`
**Pattern Reference**: `/home/pbrown/SkuInventory/src/components/features/ImportForm.tsx:48-53` (existing state variables)

**Instructions**:

1. Add import for BrandSelectionDialog at the top of the file (after line 9):
```typescript
import { BrandSelectionDialog } from './BrandSelectionDialog'
```

2. Add state variables after line 53 (after `const fileInputRef = useRef...`):
```typescript
const [showBrandDialog, setShowBrandDialog] = useState(false)
const [pendingRetry, setPendingRetry] = useState(false)
```

**Completion Criteria**:
- [ ] BrandSelectionDialog imported
- [ ] State variables added for dialog visibility and pending retry

### Subtask 2.2: Update Error Handling to Detect Brand Error and Show Dialog
**File**: `/home/pbrown/SkuInventory/src/components/features/ImportForm.tsx`
**Pattern Reference**: Lines 148-157 (existing error handling)

**Instructions**:

Update the catch block in `handleUpload` (around lines 148-157) to detect brand-related errors:

**Current code** (lines 148-157):
```typescript
    } catch (error) {
      console.error('Upload error:', error)
      const errorMessage = error instanceof Error ? error.message : 'Import failed. Please try again.'
      setUploadError(errorMessage)
      toast.error('Import failed', {
        description: errorMessage,
      })
    } finally {
      setIsUploading(false)
    }
```

**Replace with**:
```typescript
    } catch (error) {
      console.error('Upload error:', error)
      const errorMessage = error instanceof Error ? error.message : 'Import failed. Please try again.'

      // Check if error is brand-related
      if (errorMessage.toLowerCase().includes('no active brand')) {
        setShowBrandDialog(true)
        setUploadError(null) // Clear any previous error
        return
      }

      setUploadError(errorMessage)
      toast.error('Import failed', {
        description: errorMessage,
      })
    } finally {
      setIsUploading(false)
    }
```

**Note**: The `finally` block will still execute when we return early, so `isUploading` will be set to false. This is correct behavior.

**Completion Criteria**:
- [ ] Error handling detects "no active brand" message
- [ ] Shows BrandSelectionDialog instead of error toast for brand errors
- [ ] Clears uploadError when showing dialog

### Subtask 2.3: Add Brand Selection Callback Handler
**File**: `/home/pbrown/SkuInventory/src/components/features/ImportForm.tsx`

**Instructions**:

Add a handler function after the `handleUpload` function (after line 158):

```typescript
  const handleBrandSelected = async () => {
    // Set flag to trigger retry, then close dialog
    setPendingRetry(true)
    setShowBrandDialog(false)
  }
```

Add useEffect to handle retry after brand selection (after the handler function):

```typescript
  // Retry upload after brand selection
  useEffect(() => {
    if (pendingRetry && file) {
      setPendingRetry(false)
      handleUpload()
    }
  }, [pendingRetry]) // eslint-disable-line react-hooks/exhaustive-deps
```

**Note**: The eslint disable comment is needed because we intentionally don't include `file` and `handleUpload` in deps - we only want to trigger on `pendingRetry` change, and we've already verified `file` exists in the condition.

**Completion Criteria**:
- [ ] Handler function `handleBrandSelected` added
- [ ] useEffect for retry logic added
- [ ] Retry uses existing `handleUpload` function
- [ ] Pending retry state properly managed

### Subtask 2.4: Render BrandSelectionDialog in ImportForm Return
**File**: `/home/pbrown/SkuInventory/src/components/features/ImportForm.tsx`
**Pattern Reference**: Lines 160-275 (existing return statement)

**Instructions**:

Add BrandSelectionDialog rendering at the end of the return statement, just before the closing `</Card>` tag (around line 273):

```typescript
      {/* Brand Selection Dialog */}
      <BrandSelectionDialog
        open={showBrandDialog}
        onOpenChange={(open) => {
          setShowBrandDialog(open)
          if (!open) {
            setPendingRetry(false)
          }
        }}
        onBrandSelected={handleBrandSelected}
        title="Brand Required"
        description="This import requires a brand to be selected. Please choose a brand to continue."
      />
```

The final return structure should look like:
```typescript
  return (
    <Card>
      {/* ... existing CardHeader and CardContent ... */}

      {/* Brand Selection Dialog */}
      <BrandSelectionDialog
        open={showBrandDialog}
        onOpenChange={(open) => {
          setShowBrandDialog(open)
          if (!open) {
            setPendingRetry(false)
          }
        }}
        onBrandSelected={handleBrandSelected}
        title="Brand Required"
        description="This import requires a brand to be selected. Please choose a brand to continue."
      />
    </Card>
  )
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
npm run lint
```

**Completion Criteria**:
- [ ] BrandSelectionDialog rendered inside Card component
- [ ] Dialog controlled by `showBrandDialog` state
- [ ] onOpenChange handles dialog close properly
- [ ] onBrandSelected triggers retry
- [ ] TypeScript compiles without errors
- [ ] Build succeeds
- [ ] Lint passes

## Phase 3: Add E2E Test

### Subtask 3.1: Create E2E Test for Brand Selection Dialog Flow
**File**: `/home/pbrown/SkuInventory/tests/e2e/brand-selection-dialog-import.spec.ts` (NEW)
**Pattern Reference**: `/home/pbrown/SkuInventory/tests/e2e/inventory-snapshot-import.spec.ts`

**Instructions**:

Create a new E2E test file that tests:
1. Import page loads correctly
2. Brand selection dialog appears when needed
3. Brand can be selected and import retries

**Note**: This test requires a user without a selected brand to fully test the flow. For now, test that the dialog component renders correctly when triggered.

```typescript
import { test, expect } from '@playwright/test'

/**
 * Brand Selection Dialog Import E2E Tests
 *
 * Tests for Issue #165: Brand selection dialog for import when no brand selected
 */
test.describe('Brand Selection Dialog Import Feature', () => {
  test.beforeEach(async ({ page }) => {
    // Login as admin
    await page.goto('/login')
    await page.waitForSelector('#email', { timeout: 10000 })
    await page.fill('#email', 'admin@tonsil.tech')
    await page.fill('#password', 'changeme123')
    await page.click('button[type="submit"]')
    await page.waitForURL('/', { timeout: 15000 })
  })

  test('Import page loads and shows import forms', async ({ page }) => {
    await page.goto('/import')

    // Wait for page to load
    await expect(page.locator('h1')).toContainText('Import Data')

    // Verify all import forms are visible
    await expect(page.getByRole('heading', { name: /Components/i })).toBeVisible()
    await expect(page.getByRole('heading', { name: /SKUs/i })).toBeVisible()
    await expect(page.getByRole('heading', { name: /Inventory Snapshot/i })).toBeVisible()
  })

  test('ImportForm component renders without BrandSelectionDialog visible initially', async ({ page }) => {
    await page.goto('/import')

    // Wait for page to load
    await expect(page.locator('h1')).toContainText('Import Data')

    // Verify Brand Selection Dialog is not visible by default
    await expect(page.getByRole('dialog')).not.toBeVisible()
  })

  test('Brand selection is available in sidebar for multi-brand users', async ({ page }) => {
    await page.goto('/import')

    // Wait for page to load
    await expect(page.locator('h1')).toContainText('Import Data')

    // Check that brand selector exists in sidebar (if user has multiple brands)
    // This may not be visible if user only has one brand
    const brandSelector = page.locator('[data-testid="brand-selector"]')
    // Brand selector only renders for multi-brand users
    // Just verify page loaded correctly
  })
})
```

**Validation**:
```bash
npm run test:e2e -- --grep "Brand Selection Dialog"
```

**Completion Criteria**:
- [ ] Test file created
- [ ] Tests verify import page loads
- [ ] Tests verify dialog is not shown by default
- [ ] Tests pass

## Phase 4: Validation

### Subtask 4.1: TypeScript and Build Verification
**Instructions**:

Run full validation suite:

```bash
# TypeScript check
npx tsc --noEmit

# Build check
npm run build

# Lint check
npm run lint

# Unit tests
npm test
```

**Completion Criteria**:
- [ ] TypeScript compiles without errors
- [ ] Build succeeds
- [ ] Lint passes without warnings
- [ ] Unit tests pass

### Subtask 4.2: Manual Testing Checklist
**Instructions**:

1. **Test with brand already selected**:
   - Log in as admin user
   - Navigate to /import
   - Upload an inventory snapshot Excel file
   - Verify import succeeds (dialog should NOT appear)

2. **Test dialog appearance** (requires deselecting brand):
   - In sidebar, click brand selector and select "All Brands"
   - Navigate to /import
   - Upload an inventory snapshot Excel file
   - Verify BrandSelectionDialog appears
   - Select a brand from dropdown
   - Click "Continue with Import"
   - Verify import retries and succeeds

3. **Test dialog cancel**:
   - Trigger the dialog as above
   - Click "Cancel" or close button
   - Verify dialog closes
   - Verify no import attempt happens

**Completion Criteria**:
- [ ] Import works when brand is already selected
- [ ] Dialog appears when no brand selected
- [ ] Brand selection persists via API
- [ ] Import auto-retries after selection
- [ ] Cancel closes dialog without retrying

---

## Summary of Deliverables

**Files Created**:
| File | Purpose |
|------|---------|
| `/src/components/features/BrandSelectionDialog.tsx` | Dialog component for selecting brand when missing |
| `/tests/e2e/brand-selection-dialog-import.spec.ts` | E2E test for the new flow |

**Files Modified**:
| File | Change |
|------|--------|
| `/src/components/features/ImportForm.tsx` | Add brand selection dialog trigger, state, and retry logic |

## Handoff to Build Agent

1. Execute subtasks in order (1.1 -> 2.1 -> 2.2 -> 2.3 -> 2.4 -> 3.1 -> 4.1 -> 4.2)
2. Complete Phase 1 fully before Phase 2 (dialog must exist before ImportForm can import it)
3. Test completion criteria before each next subtask
4. Follow reference patterns exactly:
   - Dialog: `BuildDialog.tsx`
   - Brand switch: `BrandSelector.tsx`
   - Error handling: `ImportForm.tsx`

## Test Strategy Note

- Use Vitest for unit tests
- Use Playwright for E2E tests
- Manual testing required to verify full flow (brand deselection -> dialog -> selection -> retry)

## UI Acceptance Criteria

- [ ] BrandSelectionDialog visible when import fails due to missing brand
- [ ] Dialog shows dropdown of available brands
- [ ] Dialog shows warning icon (AlertTriangle)
- [ ] "Continue with Import" button is disabled until brand selected
- [ ] Loading state shown during brand switch API call
- [ ] Error state shown if brand switch fails
- [ ] Dialog closes after successful brand selection
- [ ] Import auto-retries after brand selection

## Performance Metrics

| Phase | Estimated Duration |
|-------|----------|
| Phase 1 (Dialog Component) | 1-2h |
| Phase 2 (ImportForm Integration) | 1-2h |
| Phase 3 (E2E Test) | 30m |
| Phase 4 (Validation) | 30m |
| **Total** | **3-5h** |

---

AGENT_RETURN: plan-165-120424
