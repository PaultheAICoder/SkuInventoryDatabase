# Implementation Plan
**Generated**: 2026-01-02 20:15:00 UTC
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #353
**Estimated Build Time**: 2-3 hours
**Complexity**: Medium

## Investigation Summary

### Request Analysis
**Type**: Bug
**Source**: GitHub Issue #353
**Priority**: High - Monitoring feature provides no value in current state

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED - Manual verification of monitor container and dashboard
**Suggested Filter**: None (no unit tests for container monitoring)

### Issue Validation
**Status**: Valid
**Recent Changes**:
- `bb6004c` (Dec 31) - feat(issue #329): add Docker container health monitoring system
- `eaec92a` (Dec 31) - fix(issue #337): improve health monitor status detection

### Root Cause Analysis

The Docker Health Monitor feature (issue #329) was fully implemented but has TWO distinct problems:

**Problem 1 - Monitor Container Not Running:**
The `inventory-monitor` container was defined in docker-compose files but never started. Evidence:
- `docker ps` shows no `inventory-monitor*` containers
- ContainerHealthLog table has 0 rows
- ContainerEvent table has 0 rows

**Problem 2 - Container Name Mismatch (Code Bug):**
The API route hardcodes container names that don't match the actual deployment:

```typescript
// src/app/api/admin/docker-health/route.ts (line 16-20)
const MONITORED_CONTAINERS = [
  'inventory-app',
  'inventory-db-prod',
  'inventory-nginx',
]
```

Actual running containers:
- `inventory-app` (exists)
- `inventory-app-test` (exists)
- `inventory-db-test` (exists)
- `inventory-db-prod` does NOT exist
- `inventory-nginx` does NOT exist

### Current State Assessment
- **Database schema**: Correct (3 models exist, tables created)
- **Service layer**: Correct (`container-health.ts`, `container-health-alert.ts`)
- **API routes**: Has hardcoded container names that don't match reality
- **Dashboard UI**: Correct (properly shows "unknown" and "Never checked")
- **Monitor script**: Correct (`docker/monitor/monitor.sh`)
- **Docker services**: Defined but not started

### Dependencies & Blockers
1. Monitor container requires Docker socket access (`/var/run/docker.sock`)
2. Requires `CRON_SECRET` environment variable - already set in `.env`
3. Container names must be configurable, not hardcoded

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Medium
**Effort**: 2-3 hours
**Risk**: Low (infrastructure change + minor code fix)

### Patterns Identified
**Primary**: `docker/docker-compose.test.yml` lines 66-83 - monitor-test service definition
**Secondary**: `src/app/api/admin/docker-health/route.ts` - current container name list

### Ripple Effect Analysis
**Files Identified**: 3 files affected

1. `src/app/api/admin/docker-health/route.ts` - Update container name logic
2. `docker/docker-compose.test.yml` - Verify/update monitor-test container names
3. `docker/docker-compose.prod.yml` - Verify/update monitor container names

**No downstream dependencies** - changes are isolated to configuration

---

## Executive Summary

The Docker Health Monitor shows "unknown" status because:
1. The monitor container (which collects health data) was never started
2. The API route monitors non-existent containers (`inventory-db-prod`, `inventory-nginx`)

The fix requires:
1. Starting the monitor container
2. Updating container names to match actual deployment
3. Optionally making container names configurable via environment variable

---

## Phase 0: Verification

### Subtask 0.1: Verify Test Environment Status
**Instructions**:
1. Confirm test containers are running:
```bash
docker ps --filter "name=inventory" --format "table {{.Names}}\t{{.Status}}"
```
Expected: inventory-app-test, inventory-db-test running

2. Verify database tables exist:
```bash
docker exec inventory-db-test psql -U inventory_test -d inventory_test -c "SELECT current_database();"
docker exec inventory-db-test psql -U inventory_test -d inventory_test -c "SELECT COUNT(*) FROM \"ContainerHealthLog\";"
```
Expected: inventory_test, 0 rows

**Completion Criteria**:
- [ ] Test containers confirmed running
- [ ] Database tables confirmed empty

---

## Phase 1: Code Fix - Update Container Names

### Subtask 1.1: Make Container Names Environment-Configurable
**File**: `/home/pbrown/SkuInventory/src/app/api/admin/docker-health/route.ts`
**Pattern**: Follow existing env var usage in `src/app/api/cron/ads-sync/route.ts`

**Current Code (lines 15-20)**:
```typescript
// Container names to monitor
const MONITORED_CONTAINERS = [
  'inventory-app',
  'inventory-db-prod',
  'inventory-nginx',
]
```

**New Code**:
```typescript
// Container names to monitor (configurable via environment)
// Default: inventory-app,inventory-db-prod for production
// Test: Set DOCKER_MONITOR_CONTAINERS=inventory-app-test,inventory-db-test
function getMonitoredContainers(): string[] {
  const envContainers = process.env.DOCKER_MONITOR_CONTAINERS
  if (envContainers) {
    return envContainers.split(',').map(c => c.trim()).filter(Boolean)
  }
  // Default containers for production
  return ['inventory-app', 'inventory-db-prod']
}

const MONITORED_CONTAINERS = getMonitoredContainers()
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Container names read from environment variable
- [ ] Falls back to sensible defaults
- [ ] TypeScript compiles without errors
- [ ] Build passes

---

## Phase 2: Update Docker Compose Files

### Subtask 2.1: Update Test Environment Docker Compose
**File**: `/home/pbrown/SkuInventory/docker/docker-compose.test.yml`
**Current (lines 77-78)**:
```yaml
- CONTAINERS_TO_MONITOR=inventory-app-test,inventory-db-test
```
This is already correct - no change needed.

**Action**: Verify and document - no code change

**Completion Criteria**:
- [ ] Confirmed CONTAINERS_TO_MONITOR matches actual test containers

### Subtask 2.2: Update Production Docker Compose
**File**: `/home/pbrown/SkuInventory/docker/docker-compose.prod.yml`
**Current (line 79)**:
```yaml
- CONTAINERS_TO_MONITOR=inventory-app,inventory-db-prod,inventory-nginx
```

**New Code**:
```yaml
- CONTAINERS_TO_MONITOR=inventory-app,inventory-db-prod
```
Remove `inventory-nginx` since nginx is not currently deployed.

**Or if we want the app environment to read the same list**:
Add to app service environment (line 39):
```yaml
- DOCKER_MONITOR_CONTAINERS=${CONTAINERS_TO_MONITOR:-inventory-app,inventory-db-prod}
```

**Completion Criteria**:
- [ ] Container list matches actual production deployment
- [ ] No references to non-existent containers

---

## Phase 3: Start Monitor Container (Test Environment)

### Subtask 3.1: Start Monitor Container in Test Environment
**Instructions**:
```bash
cd /home/pbrown/SkuInventory/docker
docker compose -f docker-compose.test.yml up -d monitor-test
```

**Verify container started**:
```bash
docker ps --filter "name=inventory-monitor-test" --format "table {{.Names}}\t{{.Status}}\t{{.Image}}"
```
Expected: inventory-monitor-test running

**Check monitor logs**:
```bash
docker logs inventory-monitor-test --tail 20
```
Expected: "Starting Docker Health Monitor" and health check messages

**Completion Criteria**:
- [ ] Monitor container started
- [ ] Monitor logs show it's polling containers
- [ ] No errors in monitor logs

### Subtask 3.2: Verify Health Data Collection
**Instructions**:
Wait 60 seconds for data collection, then verify:

```bash
docker exec inventory-db-test psql -U inventory_test -d inventory_test -c "SELECT COUNT(*) FROM \"ContainerHealthLog\";"
```
Expected: > 0 rows

```bash
docker exec inventory-db-test psql -U inventory_test -d inventory_test -c "SELECT \"containerName\", \"status\", \"createdAt\" FROM \"ContainerHealthLog\" ORDER BY \"createdAt\" DESC LIMIT 5;"
```
Expected: Recent health logs for monitored containers

**Completion Criteria**:
- [ ] ContainerHealthLog has data
- [ ] Health logs show correct container names
- [ ] Status shows "healthy" for running containers

---

## Phase 4: Verify Dashboard

### Subtask 4.1: Test Dashboard Shows Live Data
**Instructions**:
1. Access test dashboard: http://172.16.20.50:2345/admin/docker-health
2. Login as admin user
3. Verify containers show actual status (healthy/running)
4. Verify "Last Check" shows recent timestamp
5. Verify no more "unknown" or "Never checked" messages for monitored containers

**Completion Criteria**:
- [ ] Dashboard loads without errors
- [ ] Containers show "healthy" or accurate status
- [ ] Last Check shows timestamp within last minute
- [ ] Restart count displays correctly
- [ ] No containers showing "unknown" for monitored containers

---

## Phase 5: Update Environment Files

### Subtask 5.1: Add DOCKER_MONITOR_CONTAINERS to .env.example
**File**: `/home/pbrown/SkuInventory/.env.example`
**Add**:
```env
# Docker Health Monitoring
# Comma-separated list of container names to monitor
# Default: inventory-app,inventory-db-prod
DOCKER_MONITOR_CONTAINERS=inventory-app,inventory-db-prod
```

**Completion Criteria**:
- [ ] Environment variable documented
- [ ] Example shows correct format

### Subtask 5.2: Add to test environment app service
**File**: `/home/pbrown/SkuInventory/docker/docker-compose.test.yml`
**Add to app-test environment section (around line 32)**:
```yaml
- DOCKER_MONITOR_CONTAINERS=inventory-app-test,inventory-db-test
```

This ensures the test app API returns data for the correct containers.

**Completion Criteria**:
- [ ] Test app configured with correct container names
- [ ] Rebuild and restart test app if needed

---

## Summary of Deliverables

**Files Created**: 0

**Files Modified**:
1. `src/app/api/admin/docker-health/route.ts` - Make container names configurable
2. `docker/docker-compose.test.yml` - Add DOCKER_MONITOR_CONTAINERS to app-test
3. `docker/docker-compose.prod.yml` - Update CONTAINERS_TO_MONITOR (remove nginx)
4. `.env.example` - Document new environment variable

**Infrastructure Changes**:
- Start `inventory-monitor-test` container

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 0 through Phase 5)
2. Phase 0 is verification only - no code changes
3. Phase 1 is the main code fix
4. Phase 2 updates docker-compose files
5. Phase 3 starts the monitor container
6. Phase 4 is manual verification
7. Phase 5 updates documentation

**Important Notes**:
- Do NOT modify production containers (inventory-app, inventory-db-prod)
- All testing on test environment (port 2345)
- Rebuild test app container after environment changes:
  ```bash
  cd /home/pbrown/SkuInventory/docker
  docker compose -f docker-compose.test.yml build app-test
  docker compose -f docker-compose.test.yml up -d app-test
  ```

---

## Test Strategy Note

**No automated tests** - This is infrastructure/deployment configuration.

**Manual Verification Required**:
1. Monitor container running
2. Health data collecting to database
3. Dashboard displaying live data

---

## Performance Metrics

| Phase | Duration |
|-------|----------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 10m |
| **Total** | **30m** |
