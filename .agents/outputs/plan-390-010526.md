# Implementation Plan
**Generated**: 2026-01-05 (Scout-and-Plan Agent)
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #390
**Estimated Build Time**: 3-4 hours
**Complexity**: Low-Medium

## Investigation Summary

### Request Analysis
**Type**: Bug Fix (2 separate but related issues)
**Source**: GitHub Issue #390
**Priority**: High - Core feature partially broken

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="mapping"` or manual verification

### Issue Validation
**Status**: Valid - Verified code paths match issue description
**Recent Changes**:
- `d150da5 feat(issue #85): add SKU channel mapping API and UI` - Original feature
- No recent changes to affected files

### Current State Assessment

**Issue 1: pageSize validation failure**
- `src/components/features/SkuMappingForm.tsx` line 89 requests: `/api/skus?pageSize=500&isActive=true`
- `src/types/sku.ts` line 41 validates: `pageSize: z.coerce.number().int().positive().max(100).default(50)`
- 500 > 100 causes Zod validation to fail with 400 Bad Request

**Issue 2: Amazon mappings not displayed**
- **SkuChannelMapping table**: Unified channel mapping (shopify, amazon, tiktok) - used by `/api/shopify/mappings` route
- **AsinSkuMapping table**: Separate Amazon-specific ASIN mapping - NOT queried by the page
- The `/shopify/mappings` page ONLY queries `SkuChannelMapping`, never showing `AsinSkuMapping` data
- Amazon integrations from Tonsil Tech store mappings in `AsinSkuMapping` which is never displayed on this unified page

**Database Models (from prisma/schema.prisma)**:
- `SkuChannelMapping` (line 725): companyId, channelType, externalId, externalSku, skuId, isActive
- `AsinSkuMapping` (line 1038): brandId, asin, skuId, productName, createdById

**Key Difference**: SkuChannelMapping is company-scoped; AsinSkuMapping is brand-scoped

### Dependencies & Blockers
1. None - All required models and APIs exist
2. Decision needed: Should AsinSkuMapping data be displayed read-only, or migrated/unified?

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Low-Medium
**Effort**: 3-4 hours
**Risk**: Low - Changes are isolated to form component and API route

### Patterns Identified
**Primary**: `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx` - line 143 shows correct pattern: `pageSize=100`
**Secondary**: `/home/pbrown/SkuInventory/src/components/features/QuickEntryForm.tsx` - line 154 shows correct pattern: `pageSize=100`

### Pattern Scan - Other Files with Same Bug
```bash
# Search for pageSize > 100 patterns
grep -r "pageSize=500\|pageSize=200\|pageSize=300" src/
```

**Results**:
- `src/components/features/SkuMappingForm.tsx:89` - **AFFECTED** (pageSize=500)
- `src/_deferred/shopify/components/SkuMappingForm.tsx:89` - Also affected (deferred code)

**Only 2 files affected** - include both in this plan.

### Ripple Effect Analysis
**Files Identified**: 4 files

| File | Reason |
|------|--------|
| `/home/pbrown/SkuInventory/src/components/features/SkuMappingForm.tsx` | Fix pageSize from 500 to 100 |
| `/home/pbrown/SkuInventory/src/_deferred/shopify/components/SkuMappingForm.tsx` | Same fix (deferred code) |
| `/home/pbrown/SkuInventory/src/app/api/shopify/mappings/route.ts` | Add AsinSkuMapping query to include Amazon mappings |
| `/home/pbrown/SkuInventory/src/types/channel-mapping.ts` | May need source field for unified display |

---

## Executive Summary

This bug fix addresses two issues on the SKU Channel Mappings page:
1. **SKU loading failure**: The form requests pageSize=500 but the API schema only allows max 100, causing a 400 error when opening the "Add Mapping" dialog
2. **Missing Amazon mappings**: The page only queries SkuChannelMapping but Amazon integrations store data in AsinSkuMapping - we'll add a combined view to show both sources

---

## Phase 1: Fix pageSize Validation Error (Issue 1)

### Subtask 1.1: Fix SkuMappingForm pageSize
**File**: `/home/pbrown/SkuInventory/src/components/features/SkuMappingForm.tsx`
**Line**: 89
**Pattern**: Follow `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx:143`

**Current Code**:
```typescript
const res = await fetch('/api/skus?pageSize=500&isActive=true')
```

**Instructions**:
1. Change `pageSize=500` to `pageSize=100` to comply with API schema validation
2. This matches the pattern used in other similar components (BuildDialog, QuickEntryForm)

**New Code**:
```typescript
const res = await fetch('/api/skus?pageSize=100&isActive=true')
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] pageSize changed from 500 to 100
- [ ] TypeScript compiles without errors
- [ ] Build succeeds

### Subtask 1.2: Fix Deferred SkuMappingForm (consistency)
**File**: `/home/pbrown/SkuInventory/src/_deferred/shopify/components/SkuMappingForm.tsx`
**Line**: 89
**Pattern**: Same as 1.1

**Instructions**:
1. Change `pageSize=500` to `pageSize=100` for consistency with active code

**Completion Criteria**:
- [ ] pageSize changed from 500 to 100
- [ ] Deferred code stays consistent with active code

---

## Phase 2: Display Amazon Mappings (Issue 2)

### Subtask 2.1: Update MappingResponse Type for Source Indicator
**File**: `/home/pbrown/SkuInventory/src/types/channel-mapping.ts`
**Pattern**: Follow existing interface structure

**Instructions**:
1. Add optional `source` field to MappingResponse to distinguish between SkuChannelMapping and AsinSkuMapping origins
2. Add optional `productName` field for AsinSkuMapping entries
3. Add optional `brandName` field for AsinSkuMapping entries (since they're brand-scoped)

**New Fields**:
```typescript
// Add to MappingResponse interface (around line 60)
export interface MappingResponse {
  id: string
  channelType: string
  externalId: string
  externalSku: string | null
  skuId: string
  sku: {
    id: string
    name: string
    internalCode: string
  }
  isActive: boolean
  createdAt: string
  updatedAt: string
  // New fields for unified display
  source?: 'channel' | 'asin'  // Indicates which table the mapping came from
  productName?: string | null   // Amazon product name (from AsinSkuMapping)
  brandName?: string | null     // Brand name (from AsinSkuMapping)
}
```

**Completion Criteria**:
- [ ] MappingResponse interface updated with source, productName, brandName fields
- [ ] TypeScript compiles without errors

### Subtask 2.2: Update GET /api/shopify/mappings to Include AsinSkuMapping Data
**File**: `/home/pbrown/SkuInventory/src/app/api/shopify/mappings/route.ts`
**Pattern**: Follow existing query structure, combine results

**Instructions**:
1. After querying SkuChannelMapping, also query AsinSkuMapping for the selected company's brands
2. Transform AsinSkuMapping records to match MappingResponse format
3. Combine results, marking source as 'channel' or 'asin'
4. Handle pagination appropriately (may need adjustment)
5. AsinSkuMapping entries should appear as channelType='amazon'
6. AsinSkuMapping doesn't have isActive field - default to true

**Key Considerations**:
- SkuChannelMapping uses companyId directly
- AsinSkuMapping uses brandId - need to get brands for company first
- Filter by channelType should still work (AsinSkuMapping = 'amazon' only)
- Search should search both tables

**Implementation Approach** (after line 87, before returning):
```typescript
// Get brands for this company to query AsinSkuMapping
const brands = await prisma.brand.findMany({
  where: { companyId: selectedCompanyId },
  select: { id: true, name: true },
})
const brandIds = brands.map(b => b.id)
const brandNameMap = Object.fromEntries(brands.map(b => [b.id, b.name]))

// Only include AsinSkuMapping if not filtering by non-amazon channel
const includeAsinMappings = !channelType || channelType === 'amazon'

let asinMappings: Array<{
  id: string
  channelType: string
  externalId: string
  externalSku: string | null
  skuId: string
  sku: { id: string; name: string; internalCode: string }
  isActive: boolean
  createdAt: Date
  updatedAt: Date
  source: 'asin'
  productName: string | null
  brandName: string
}> = []

if (includeAsinMappings && brandIds.length > 0) {
  // Build AsinSkuMapping where clause
  const asinWhere: Prisma.AsinSkuMappingWhereInput = {
    brandId: { in: brandIds },
  }

  if (search) {
    asinWhere.OR = [
      { asin: { contains: search, mode: 'insensitive' } },
      { productName: { contains: search, mode: 'insensitive' } },
      { sku: { internalCode: { contains: search, mode: 'insensitive' } } },
      { sku: { name: { contains: search, mode: 'insensitive' } } },
    ]
  }

  const rawAsinMappings = await prisma.asinSkuMapping.findMany({
    where: asinWhere,
    include: {
      sku: { select: { id: true, name: true, internalCode: true } },
    },
    orderBy: { createdAt: 'desc' },
  })

  // Transform to unified format
  asinMappings = rawAsinMappings.map(m => ({
    id: m.id,
    channelType: 'amazon',
    externalId: m.asin,
    externalSku: null,
    skuId: m.skuId,
    sku: m.sku,
    isActive: true, // AsinSkuMapping has no isActive field
    createdAt: m.createdAt,
    updatedAt: m.createdAt, // No updatedAt in AsinSkuMapping
    source: 'asin' as const,
    productName: m.productName,
    brandName: brandNameMap[m.brandId] || '',
  }))
}

// Combine and sort all mappings
const allMappings = [
  ...mappings.map(m => ({ ...m, source: 'channel' as const })),
  ...asinMappings,
].sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime())

// Apply pagination to combined results
const paginatedMappings = allMappings.slice((page - 1) * pageSize, page * pageSize)
const combinedTotal = total + asinMappings.length
```

**Note**: For isActive filter, AsinSkuMapping entries should only show when isActive is true or undefined (they don't have an inactive state).

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] AsinSkuMapping data queried alongside SkuChannelMapping
- [ ] Results transformed to unified MappingResponse format
- [ ] Combined results sorted by createdAt descending
- [ ] Pagination works correctly with combined data
- [ ] Channel filter still works (amazon filter includes both sources)
- [ ] Search works across both tables
- [ ] TypeScript compiles without errors
- [ ] Build succeeds

### Subtask 2.3: Update SkuMappingTable to Display Source and Product Name
**File**: `/home/pbrown/SkuInventory/src/components/features/SkuMappingTable.tsx`
**Pattern**: Follow existing table column structure

**Instructions**:
1. Optionally show source indicator (subtle badge or icon) to distinguish SkuChannelMapping vs AsinSkuMapping entries
2. For AsinSkuMapping entries (source='asin'), show productName in the External SKU column if available
3. Show brandName for AsinSkuMapping entries (optional, could be tooltip)
4. Note: AsinSkuMapping entries may not be editable through this UI (they use different API endpoints)

**Considerations**:
- Edit/Delete actions may need to be disabled for AsinSkuMapping entries (different API)
- OR route edit/delete to `/api/asin-mapping/[id]` for source='asin' entries

**Option A (simpler)**: Make AsinSkuMapping entries read-only on this page
- Disable Edit/Toggle/Delete buttons when source='asin'
- Add tooltip: "Manage Amazon ASIN mappings in the Amazon integration settings"

**Option B (full integration)**: Route actions to correct API
- Edit button routes to different endpoint
- More complex but fully unified experience

**Recommended**: Option A for this bug fix (simpler, less risk)

**UI Changes**:
```typescript
// In the actions menu, add conditional logic:
{mapping.source !== 'asin' && (
  <>
    <DropdownMenuItem onClick={() => onEdit(mapping)}>
      <Edit className="mr-2 h-4 w-4" />
      Edit
    </DropdownMenuItem>
    {/* ... other actions */}
  </>
)}
{mapping.source === 'asin' && (
  <DropdownMenuItem disabled className="text-muted-foreground">
    Managed via Amazon integration
  </DropdownMenuItem>
)}
```

**Completion Criteria**:
- [ ] AsinSkuMapping entries display correctly in table
- [ ] ProductName shown for AsinSkuMapping entries where available
- [ ] Edit/Delete actions appropriately handled for different sources
- [ ] TypeScript compiles without errors

---

## Phase 3: Verification & Testing

### Subtask 3.1: Manual Verification
**Instructions**:
1. Start test environment
2. Navigate to /shopify/mappings
3. Click "Add Mapping" - verify SKU dropdown loads (Issue 1 fix)
4. Verify Amazon mappings from AsinSkuMapping appear in the list (Issue 2 fix)
5. Verify filtering by channel type works
6. Verify search works across both mapping sources
7. Verify pagination works with combined data

**Test URL**: http://172.16.20.50:2345/shopify/mappings

**Verification Steps**:
```bash
# Start test environment
cd /home/pbrown/SkuInventory/docker && docker compose -f docker-compose.test.yml up -d

# Verify test database is running
docker exec inventory-db-test psql -U inventory_test -d inventory_test -c "SELECT current_database();"

# Check if AsinSkuMapping has data
docker exec inventory-db-test psql -U inventory_test -d inventory_test -c "SELECT COUNT(*) FROM \"AsinSkuMapping\";"

# Check SkuChannelMapping count
docker exec inventory-db-test psql -U inventory_test -d inventory_test -c "SELECT COUNT(*) FROM \"SkuChannelMapping\";"
```

**Completion Criteria**:
- [ ] "Add Mapping" dialog loads SKUs successfully
- [ ] Amazon mappings from AsinSkuMapping visible in list
- [ ] Filters work correctly
- [ ] No console errors

### Subtask 3.2: Build Verification
**Instructions**:
```bash
cd /home/pbrown/SkuInventory
npm run build
npx tsc --noEmit
npm run lint
```

**Completion Criteria**:
- [ ] Build succeeds without errors
- [ ] TypeScript check passes
- [ ] Lint passes

---

## Summary of Deliverables

**Files Modified**: 4
1. `/home/pbrown/SkuInventory/src/components/features/SkuMappingForm.tsx` - Fix pageSize
2. `/home/pbrown/SkuInventory/src/_deferred/shopify/components/SkuMappingForm.tsx` - Fix pageSize (consistency)
3. `/home/pbrown/SkuInventory/src/types/channel-mapping.ts` - Add source, productName, brandName fields
4. `/home/pbrown/SkuInventory/src/app/api/shopify/mappings/route.ts` - Query and combine AsinSkuMapping data
5. `/home/pbrown/SkuInventory/src/components/features/SkuMappingTable.tsx` - Handle source display and actions

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 -> Phase 2 -> Phase 3)
2. Phase 1 is quick win - fixes the immediate user-facing error
3. Phase 2 requires careful implementation to unify the two mapping sources
4. Test completion criteria before moving to next subtask
5. Follow reference patterns exactly

## Alternative Approaches Considered

**Alternative 1: Increase pageSize limit to 500**
- Rejected: Would require changing all query schemas, could cause performance issues
- Better to keep 100 limit and paginate if needed

**Alternative 2: Migrate AsinSkuMapping to SkuChannelMapping**
- Rejected for this fix: Too invasive, risk of data loss, breaks existing Amazon integration code
- Could be considered for future unification effort

**Alternative 3: Create separate Amazon mappings page**
- Rejected: Issue specifically requests unified view on existing page
- User expectation is "all channel mappings" on one page

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Combined pagination off-by-one | Low | Low | Test thoroughly with data in both tables |
| AsinSkuMapping edit/delete confusion | Medium | Low | Disable actions for ASIN mappings with clear messaging |
| Performance with large combined datasets | Low | Medium | Both queries already use pagination |

## Test Strategy Note

- Use manual verification for this bug fix (targeted approach)
- Verify on test environment (port 2345)
- No E2E tests needed for this fix (existing manual testing sufficient)

## Performance Metrics

| Phase | Duration |
|-------|----------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 10m |
| **Total** | **30m** |
