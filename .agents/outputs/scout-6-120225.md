# Scout Report: Settings are unused; seed writes wrong key

## Request Analysis
**Type**: Bug
**Source**: GitHub Issue #6
**Priority**: High

## Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="settings|inventory|seed"`

## Issue Validation
**Status**: Valid
**Recent Changes**: No recent commits affecting settings logic (last settings-related change was in initial implementation)

## Current State

### Settings Infrastructure (WORKING)
- Settings API: `/home/pbrown/SkuInventory/src/app/api/settings/route.ts` - GET/PATCH endpoints working correctly
- Settings Types: `/home/pbrown/SkuInventory/src/types/settings.ts` - Defines all settings with DEFAULT_SETTINGS
- Settings Form: `/home/pbrown/SkuInventory/src/components/features/SettingsForm.tsx` - UI for managing settings
- Settings Page: `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/page.tsx` - Settings page

### Seed Script Issue (CONFIRMED)
- Location: `/home/pbrown/SkuInventory/prisma/seed.ts` (lines 20-23)
- Current code: `settings: { blockNegativeInventory: false }`
- Problem: Uses `blockNegativeInventory` (doesn't exist) instead of `allowNegativeInventory` (correct key)
- Impact: Seed data creates settings with wrong key, which is ignored by the application

### Settings NOT Applied (CONFIRMED)
Settings are stored and retrieved correctly but NOT used in business logic:

1. **allowNegativeInventory** - UNUSED
   - Should be used in: Build transaction creation
   - Current: BuildDialog calls `/api/transactions/build` (endpoint MISSING)
   - Problem: No build endpoint exists to enforce this setting

2. **reorderWarningMultiplier** - HARDCODED
   - Location: `/home/pbrown/SkuInventory/src/services/inventory.ts` (line 59)
   - Current: Hardcoded as `1.5` in `calculateReorderStatus()`
   - Should use: Company settings value

3. **defaultLeadTimeDays** - PARTIALLY USED
   - Location: Component creation in `/home/pbrown/SkuInventory/src/app/api/components/route.ts` (line 209)
   - Current: Uses user-provided value, NOT settings default
   - Should use: Settings default when no value provided

## Dependencies & Blockers

### BLOCKER 1: Missing Build Transaction API Endpoint
- BuildDialog calls `/api/transactions/build` (line 110 of BuildDialog.tsx)
- This endpoint does NOT exist
- Directory structure shows: receipt/, adjustment/, [id]/, but NO build/
- The service function `createBuildTransaction` exists but is never called from an API route

### BLOCKER 2: Settings Not Passed to Service Functions
- Service functions in `inventory.ts` don't accept settings parameters
- No mechanism to fetch and pass company settings to these functions
- Need to add settings parameter to affected functions

**Can Proceed?**: YES (with fixes)

## Complexity Assessment
**Complexity**: Moderate
**Effort**: 6-8 hours
**Risk**: Medium - Touches core inventory logic, requires careful testing

## Patterns to Follow

**Primary Pattern**: API Settings Integration
- File: `/home/pbrown/SkuInventory/src/app/api/settings/route.ts`
- Pattern: Fetch company settings with `prisma.company.findUnique()` and merge with DEFAULT_SETTINGS

**Secondary Pattern**: Transaction Creation
- File: `/home/pbrown/SkuInventory/src/app/api/transactions/receipt/route.ts`
- Pattern: Validate permissions, verify entities, call service function, return response

**Tertiary Pattern**: Service Function with Settings
- Will need to create new pattern for passing settings to service functions

## Files to Create/Modify

### Files to CREATE:
1. `/home/pbrown/SkuInventory/src/app/api/transactions/build/route.ts` - Build transaction POST endpoint (MISSING)

### Files to MODIFY:

#### Seed Script (CRITICAL):
1. `/home/pbrown/SkuInventory/prisma/seed.ts`
   - Lines 20-23: Replace `blockNegativeInventory: false` with proper DEFAULT_SETTINGS import and usage

#### Service Layer (CORE LOGIC):
2. `/home/pbrown/SkuInventory/src/services/inventory.ts`
   - Line 49-63: `calculateReorderStatus()` - Add `reorderWarningMultiplier` parameter
   - Line 311-432: `createBuildTransaction()` - Respect `allowNegativeInventory` setting

#### API Routes (INTEGRATION):
3. `/home/pbrown/SkuInventory/src/app/api/components/route.ts`
   - Line 200-217: POST handler - Apply `defaultLeadTimeDays` from settings when not provided
   - Lines 115-157: GET handler - Pass settings to `calculateReorderStatus()`

4. `/home/pbrown/SkuInventory/src/app/api/components/[id]/route.ts`
   - GET/PATCH handlers - Pass settings to `calculateReorderStatus()`

5. `/home/pbrown/SkuInventory/src/app/api/dashboard/route.ts`
   - Pass settings to `calculateReorderStatus()` for dashboard stats

6. `/home/pbrown/SkuInventory/src/app/api/export/components/route.ts`
   - Pass settings to `calculateReorderStatus()` for CSV export

#### UI Components:
7. `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx`
   - Already calls correct endpoint (no changes needed, just needs endpoint created)

## Final Sweep Results

**Services Search**: 1 file in src/services/
- `/home/pbrown/SkuInventory/src/services/inventory.ts` - Contains hardcoded multiplier and build logic

**API Routes**: 6 files calling affected functions
- `/home/pbrown/SkuInventory/src/app/api/components/route.ts` - Calls calculateReorderStatus (2 places)
- `/home/pbrown/SkuInventory/src/app/api/components/[id]/route.ts` - Calls calculateReorderStatus
- `/home/pbrown/SkuInventory/src/app/api/dashboard/route.ts` - Calls calculateReorderStatus
- `/home/pbrown/SkuInventory/src/app/api/export/components/route.ts` - Calls calculateReorderStatus
- `/home/pbrown/SkuInventory/src/app/api/transactions/build/route.ts` - MISSING (needs to call createBuildTransaction)

**Type Definitions**: 1 file
- `/home/pbrown/SkuInventory/src/types/settings.ts` - Defines CompanySettings schema

**Components**: 2 files
- `/home/pbrown/SkuInventory/src/components/features/SettingsForm.tsx` - Settings UI (no changes needed)
- `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx` - Calls build API

**Test Files**: 0 test files found (no test coverage exists yet - see issue #7)

**All Affected Files** (comprehensive list):
- `/home/pbrown/SkuInventory/prisma/seed.ts` - Wrong settings key
- `/home/pbrown/SkuInventory/src/types/settings.ts` - Reference for correct keys
- `/home/pbrown/SkuInventory/src/services/inventory.ts` - Core logic changes
- `/home/pbrown/SkuInventory/src/app/api/transactions/build/route.ts` - MUST CREATE
- `/home/pbrown/SkuInventory/src/app/api/components/route.ts` - Settings integration
- `/home/pbrown/SkuInventory/src/app/api/components/[id]/route.ts` - Settings integration
- `/home/pbrown/SkuInventory/src/app/api/dashboard/route.ts` - Settings integration
- `/home/pbrown/SkuInventory/src/app/api/export/components/route.ts` - Settings integration
- `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx` - Already correct (no changes)

## Ripple Effect Analysis

### Function: calculateReorderStatus (src/services/inventory.ts)
**Current Signature**: `calculateReorderStatus(quantityOnHand: number, reorderPoint: number): ReorderStatus`
**New Signature**: `calculateReorderStatus(quantityOnHand: number, reorderPoint: number, reorderWarningMultiplier: number): ReorderStatus`

**Direct Callers**: 6 locations
1. `/home/pbrown/SkuInventory/src/app/api/components/route.ts` (line 81, 132)
2. `/home/pbrown/SkuInventory/src/app/api/components/[id]/route.ts` (used in GET/PATCH)
3. `/home/pbrown/SkuInventory/src/app/(dashboard)/components/page.tsx` (client-side, may not need changes)
4. `/home/pbrown/SkuInventory/src/app/api/export/components/route.ts` (CSV export)
5. `/home/pbrown/SkuInventory/src/app/api/dashboard/route.ts` (dashboard stats)

**TOTAL FILES AFFECTED**: 6 files (ALL must be updated to pass the new parameter)

### Function: createBuildTransaction (src/services/inventory.ts)
**Current Signature**: Has `allowInsufficientInventory?: boolean` parameter
**Change**: Needs to check against settings `allowNegativeInventory`

**Direct Callers**: 1 location (to be created)
1. `/home/pbrown/SkuInventory/src/app/api/transactions/build/route.ts` - MUST CREATE

**TOTAL FILES AFFECTED**: 1 file (must be created)

### Database Access Pattern for Settings
**Every affected API route must**:
1. Fetch company settings: `await prisma.company.findUnique({ where: { id: session.user.companyId }, select: { settings: true } })`
2. Merge with defaults: `const settings = { ...DEFAULT_SETTINGS, ...(company.settings as Record<string, unknown>) } as CompanySettings`
3. Validate: `const validated = companySettingsSchema.safeParse(settings)`
4. Pass to service functions

**Pattern occurs in**: 5 API route files (all that call calculateReorderStatus or createBuildTransaction)

## Acceptance Criteria

- [ ] Seed script uses correct settings keys from DEFAULT_SETTINGS
- [ ] Re-running seed creates company with valid settings
- [ ] Build transaction API endpoint exists and works
- [ ] Build transactions respect `allowNegativeInventory` setting
  - [ ] When false: Build is blocked if inventory insufficient
  - [ ] When true: Build proceeds with warning
- [ ] Reorder status calculation uses `reorderWarningMultiplier` from settings
- [ ] Component creation uses `defaultLeadTimeDays` when leadTimeDays not provided
- [ ] All settings changes in UI immediately affect behavior
- [ ] `npm run build` completes without errors
- [ ] `npx tsc --noEmit` completes without errors

## Handoff to Plan Agent

**Summary**: Issue #6 identifies two critical bugs: (1) seed script writes invalid settings keys, and (2) company settings are not applied in inventory logic. The settings infrastructure (API, types, UI) is complete and functional, but the business logic doesn't consume the settings. Key changes needed: fix seed script, create missing build transaction API endpoint, add reorderWarningMultiplier parameter to calculateReorderStatus(), fetch and apply settings in 5 API routes, and use defaultLeadTimeDays in component creation. The changes are moderate complexity with medium risk since they touch core inventory logic.

**Key Points**:
1. Seed script bug is trivial fix - import and use DEFAULT_SETTINGS
2. Missing `/api/transactions/build` endpoint is critical blocker - BuildDialog calls it but it doesn't exist
3. Settings infrastructure is complete - only business logic integration is missing
4. 6 files call calculateReorderStatus() - all need settings parameter added
5. Service layer functions need settings parameters - architectural change required
6. Testing strategy: TARGETED - focus on inventory calculations and build transactions

**Suggested Phases**:
1. Fix seed script (10 min) - Quick win, unblocks fresh DB setup
2. Create build transaction API endpoint (1-2 hrs) - Unblocks BuildDialog
3. Refactor calculateReorderStatus to accept multiplier (1-2 hrs) - Update 6 callers
4. Integrate settings into component creation (30 min) - Apply defaultLeadTimeDays
5. Update build transaction logic for allowNegativeInventory (1 hr)
6. Add helper function for fetching settings in API routes (30 min) - DRY principle
7. Manual testing and verification (1-2 hrs)

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Issue Parsing | 2m |
| Codebase Exploration | 15m |
| Pattern Identification | 8m |
| Ripple Effect Analysis | 10m |
| Report Writing | 12m |
| **Total** | **47m** |
