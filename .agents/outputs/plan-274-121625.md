# Implementation Plan
**Generated**: 2025-12-16T08:00:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #274
**Estimated Build Time**: 1-2 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Bug
**Source**: GitHub Issue #274
**Priority**: High (blocks user from building SKUs)

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: FAST_PATH (smoke tests only, isolated frontend fix)
**Suggested Filter**: None

### Issue Validation
**Status**: Valid - bug confirmed in code
**Recent Changes**: BuildDialog.tsx has had multiple recent commits but none addressing this specific bug

### Bug Description
When user navigates to a SKU detail page (e.g., `/skus/17f261d5-305c-453e-86c8-e67582abd040`) and clicks the "Build" button, the browser console shows:
```
Error: A <Select.Item /> must have a value prop that is not an empty string. This is because the Select value can be set to an empty string to clear the selection and show the placeholder.
```

### Root Cause Analysis
The Radix UI `Select` component (from `@radix-ui/react-select`) requires all `SelectItem` values to be non-empty strings. The error is thrown because:

**File**: `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx`
**Line**: 550
```tsx
<SelectItem value="">No finished goods output</SelectItem>
```

This empty string value violates Radix UI's validation. The dialog crashes before it can render.

### Current State Assessment
- **Existing components**: BuildDialog.tsx has an "Output To" location select with an invalid empty value option
- **Database**: No changes needed
- **API Routes**: No changes needed (API already handles undefined/null outputLocationId correctly)
- **Types**: No changes needed

### Dependencies & Blockers
None - this is an isolated frontend fix.

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Simple
**Effort**: 1-2 hours
**Risk**: Low (isolated change, follows existing pattern)

### Patterns Identified
**Primary**: `/home/pbrown/SkuInventory/src/components/features/SKUForm.tsx` - Lines 31, 82, 307, 314

The codebase already has a pattern for handling "no selection" options in Select components:

```tsx
// Line 31: Define constant for empty value
const EMPTY_VALUE = '__none__'

// Line 82: Transform back to empty string when setting value
const newValue = value === EMPTY_VALUE ? '' : value

// Line 307 & 314: Use in Select
value={line.componentId || EMPTY_VALUE}
<SelectItem value={EMPTY_VALUE}>-- None --</SelectItem>
```

**Secondary**: N/A

### Ripple Effect Analysis
**Files Identified**: 2

1. `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx` - Primary fix (directly causes the bug)
2. `/home/pbrown/SkuInventory/src/components/integrations/csv-upload.tsx` - Same bug pattern at line 284

**Pattern Detection - Same Bug in Multiple Files**:
```bash
grep -r 'SelectItem.*value=""' --include="*.tsx" src/
```
Results:
- `src/components/features/BuildDialog.tsx:550` - `<SelectItem value="">No finished goods output</SelectItem>`
- `src/components/integrations/csv-upload.tsx:284` - `<SelectItem value="">No brand</SelectItem>`

**Decision**: Fix both files in this issue (only 2 affected files).

---

## Executive Summary
Fix Radix UI Select component crash when opening Build dialog by replacing empty string values with a sentinel constant (`__none__`) and transforming it back when setting form state. The same pattern fix will be applied to csv-upload.tsx which has the identical bug.

## Phase 1: Fix BuildDialog.tsx

### Subtask 1.1: Add EMPTY_VALUE constant to BuildDialog
**File**: `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx`
**Pattern**: Follow `src/components/features/SKUForm.tsx:31`
**Instructions**:
1. Add constant at the top of the file (after imports, before interfaces):
```tsx
// Sentinel value for "no selection" in Select components
// Radix UI Select requires non-empty string values
const EMPTY_VALUE = '__none__'
```
2. Place after line 22 (after the `import` statements), before the `interface SKUOption` declaration

**Completion Criteria**:
- [ ] Constant `EMPTY_VALUE` is defined
- [ ] TypeScript compiles without errors

### Subtask 1.2: Update outputLocationId Select value handling
**File**: `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx`
**Pattern**: Follow `src/components/features/SKUForm.tsx:82, 307, 314`
**Instructions**:
1. Change line 550 from:
```tsx
<SelectItem value="">No finished goods output</SelectItem>
```
to:
```tsx
<SelectItem value={EMPTY_VALUE}>No finished goods output</SelectItem>
```

2. Update the Select component's onValueChange handler (around line 544) to transform EMPTY_VALUE back to empty string:
```tsx
onValueChange={(value) => setFormData((prev) => ({
  ...prev,
  outputLocationId: value === EMPTY_VALUE ? '' : value
}))}
```

3. Update the Select component's value prop (around line 543) to use EMPTY_VALUE when outputLocationId is empty:
```tsx
value={formData.outputLocationId || EMPTY_VALUE}
```

**Context for lines 541-558**:
```tsx
// Current code (lines 541-558):
<Select
  value={formData.outputLocationId}
  onValueChange={(value) => setFormData((prev) => ({ ...prev, outputLocationId: value }))}
  disabled={isLoadingLocations}
>
  <SelectTrigger className="col-span-3">
    <SelectValue placeholder={isLoadingLocations ? 'Loading...' : 'Select finished goods location (optional)'} />
  </SelectTrigger>
  <SelectContent>
    <SelectItem value="">No finished goods output</SelectItem>
    {locations.map((loc) => (
      <SelectItem key={loc.id} value={loc.id}>
        {loc.name}
      </SelectItem>
    ))}
  </SelectContent>
</Select>

// Should become:
<Select
  value={formData.outputLocationId || EMPTY_VALUE}
  onValueChange={(value) => setFormData((prev) => ({
    ...prev,
    outputLocationId: value === EMPTY_VALUE ? '' : value
  }))}
  disabled={isLoadingLocations}
>
  <SelectTrigger className="col-span-3">
    <SelectValue placeholder={isLoadingLocations ? 'Loading...' : 'Select finished goods location (optional)'} />
  </SelectTrigger>
  <SelectContent>
    <SelectItem value={EMPTY_VALUE}>No finished goods output</SelectItem>
    {locations.map((loc) => (
      <SelectItem key={loc.id} value={loc.id}>
        {loc.name}
      </SelectItem>
    ))}
  </SelectContent>
</Select>
```

**Completion Criteria**:
- [ ] SelectItem uses `value={EMPTY_VALUE}` instead of `value=""`
- [ ] Select value transforms empty string to EMPTY_VALUE: `value={formData.outputLocationId || EMPTY_VALUE}`
- [ ] onValueChange transforms EMPTY_VALUE back to empty string
- [ ] TypeScript compiles without errors: `npx tsc --noEmit`
- [ ] Build succeeds: `npm run build`

## Phase 2: Fix csv-upload.tsx (Same Bug Pattern)

### Subtask 2.1: Add EMPTY_VALUE constant to csv-upload
**File**: `/home/pbrown/SkuInventory/src/components/integrations/csv-upload.tsx`
**Pattern**: Follow `src/components/features/SKUForm.tsx:31`
**Instructions**:
1. Read the file first to identify correct insertion point (after imports, before component)
2. Add the same constant:
```tsx
// Sentinel value for "no selection" in Select components
const EMPTY_VALUE = '__none__'
```

**Completion Criteria**:
- [ ] Constant `EMPTY_VALUE` is defined in csv-upload.tsx
- [ ] TypeScript compiles without errors

### Subtask 2.2: Update brand Select value handling in csv-upload
**File**: `/home/pbrown/SkuInventory/src/components/integrations/csv-upload.tsx`
**Pattern**: Follow the fix applied in Subtask 1.2
**Instructions**:
1. Locate the brand Select component (around lines 279-291)
2. Change line 284 from:
```tsx
<SelectItem value="">No brand</SelectItem>
```
to:
```tsx
<SelectItem value={EMPTY_VALUE}>No brand</SelectItem>
```

3. Update the Select value prop (line 279) to use EMPTY_VALUE when empty:
```tsx
value={selectedBrand || EMPTY_VALUE}
```

4. Update the onValueChange handler to transform EMPTY_VALUE back to empty string:
```tsx
onValueChange={(value) => setSelectedBrand(value === EMPTY_VALUE ? '' : value)}
```

**Completion Criteria**:
- [ ] SelectItem uses `value={EMPTY_VALUE}` instead of `value=""`
- [ ] Select value transforms empty string to EMPTY_VALUE
- [ ] onValueChange transforms EMPTY_VALUE back to empty string
- [ ] TypeScript compiles without errors: `npx tsc --noEmit`
- [ ] Build succeeds: `npm run build`

## Phase 3: Validation

### Subtask 3.1: Run full build verification
**Instructions**:
1. Run TypeScript check:
```bash
npx tsc --noEmit
```
2. Run build:
```bash
npm run build
```
3. Run linter:
```bash
npm run lint
```

**Completion Criteria**:
- [ ] TypeScript check passes with no errors
- [ ] Build completes successfully
- [ ] Linter passes with no errors

### Subtask 3.2: Manual smoke test on test environment
**Target**: http://172.16.20.50:2345
**Instructions**:
1. Navigate to a SKU detail page with an active BOM (e.g., `/skus/[id]`)
2. Click the "Build" button
3. Verify the dialog opens without console errors
4. Verify the "Output To" dropdown shows "No finished goods output" as an option
5. Select a location, then select "No finished goods output" again
6. Verify form data is correctly cleared (no location selected)
7. Fill out form and submit a test build (optional)

**Completion Criteria**:
- [ ] Build dialog opens without JavaScript errors
- [ ] "Output To" dropdown works correctly
- [ ] Can select and deselect location options
- [ ] Build transaction can be submitted successfully

---

## Summary of Deliverables
**Files Created**: 0
**Files Modified**: 2
- `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx`
- `/home/pbrown/SkuInventory/src/components/integrations/csv-upload.tsx`

## Handoff to Build Agent
1. Execute subtasks in exact order (Phase 1, then Phase 2, then Phase 3)
2. Read each file before editing
3. Test completion criteria before moving to next subtask
4. Follow reference pattern from SKUForm.tsx exactly
5. Use `EMPTY_VALUE = '__none__'` (lowercase, with underscores)

## Test Strategy Note
- This is a FAST_PATH fix - isolated frontend changes only
- TypeScript compilation and build are sufficient for validation
- Manual smoke test on test environment confirms user-facing fix
- No unit tests need modification (UI-only change)

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 10m |
| **Total** | **30m** |

---

## Additional Context

### Error Message Details
The first error in the issue (`Extension context invalidated`) is a browser extension error and is NOT related to this application. The relevant error is:
```
Error: A <Select.Item /> must have a value prop that is not an empty string. This is because the Select value can be set to an empty string to clear the selection and show the placeholder.
```

### Why This Pattern Works
Radix UI's Select component reserves empty string (`""`) as a special value to clear the selection and show the placeholder. By using a sentinel value (`__none__`) that is unlikely to conflict with real data, we can:
1. Have a valid non-empty value for the "no selection" option
2. Transform it back to empty string in state so the API receives the expected value
3. The API already handles `undefined`/`null`/empty outputLocationId correctly

### Reference Implementation
See `/home/pbrown/SkuInventory/src/components/features/SKUForm.tsx` lines 31, 82, 307, 314 for the complete working pattern.
