# Implementation Plan: Bug Fix - Dialog Components Show Poor Error Message When API Returns Non-JSON

**Generated**: 2025-12-03T14:30:00Z
**Task ID**: Issue #30
**Estimated Build Time**: 1-2 hours
**Complexity**: Low

## Executive Summary

This bug fix addresses unsafe `await res.json()` calls in dialog and form components that crash with cryptic `SyntaxError` when the API returns non-JSON responses (e.g., HTML error pages from reverse proxies, 502 Bad Gateway, etc.). The fix applies a proven pattern from Issue #29 (FeedbackDialog): wrap `res.json()` with `.catch(() => ({}))` and use optional chaining for message extraction.

## Scope Validation

**Scout Report Verification**: Confirmed 7 files with 8 total locations requiring fixes.
- Primary: ReceiptDialog.tsx (1 location)
- Secondary: 6 additional components with same vulnerability

**Pattern Verified**: FeedbackDialog.tsx (Issue #29) demonstrates the safe pattern at lines 108 and 151.

## Phase 1: Apply Safe JSON Parsing Pattern to All Components

All fixes follow the identical pattern. Each subtask is independent and can be executed in parallel.

---

### Subtask 1.1: Fix ReceiptDialog.tsx

**File**: `/home/pbrown/SkuInventory/src/components/features/ReceiptDialog.tsx`
**Lines**: 65-68
**Pattern Reference**: FeedbackDialog.tsx line 108

**Current Code (Line 65-68)**:
```typescript
      if (!res.ok) {
        const data = await res.json()
        throw new Error(data.message || 'Failed to record receipt')
      }
```

**Fixed Code**:
```typescript
      if (!res.ok) {
        const data = await res.json().catch(() => ({}))
        throw new Error(data?.message || 'Failed to record receipt')
      }
```

**Changes**:
1. Line 66: Add `.catch(() => ({}))` after `res.json()`
2. Line 67: Change `data.message` to `data?.message`

**Completion Criteria**:
- [ ] Code compiles without TypeScript errors
- [ ] Pattern matches FeedbackDialog exactly

---

### Subtask 1.2: Fix AdjustmentDialog.tsx

**File**: `/home/pbrown/SkuInventory/src/components/features/AdjustmentDialog.tsx`
**Lines**: 81-84
**Pattern Reference**: FeedbackDialog.tsx line 108

**Current Code (Line 81-84)**:
```typescript
      if (!res.ok) {
        const data = await res.json()
        throw new Error(data.message || 'Failed to record adjustment')
      }
```

**Fixed Code**:
```typescript
      if (!res.ok) {
        const data = await res.json().catch(() => ({}))
        throw new Error(data?.message || 'Failed to record adjustment')
      }
```

**Changes**:
1. Line 82: Add `.catch(() => ({}))` after `res.json()`
2. Line 83: Change `data.message` to `data?.message`

**Completion Criteria**:
- [ ] Code compiles without TypeScript errors
- [ ] Pattern matches FeedbackDialog exactly

---

### Subtask 1.3: Fix BuildDialog.tsx (Main Submit Handler)

**File**: `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx`
**Lines**: 135-144
**Pattern Reference**: FeedbackDialog.tsx line 151

**NOTE**: BuildDialog already has the fix at line 90 for fetchSkus. This fix addresses the main submit handler.

**Current Code (Line 135)**:
```typescript
      const data = await res.json()

      if (!res.ok) {
        // Handle insufficient inventory error
        if (data.insufficientItems && data.insufficientItems.length > 0) {
          setInsufficientItems(data.insufficientItems)
          setShowWarning(true)
          return
        }
        throw new Error(data.error || 'Failed to record build')
      }
```

**Fixed Code**:
```typescript
      const data = await res.json().catch(() => ({}))

      if (!res.ok) {
        // Handle insufficient inventory error
        if (data?.insufficientItems && data.insufficientItems.length > 0) {
          setInsufficientItems(data.insufficientItems)
          setShowWarning(true)
          return
        }
        throw new Error(data?.error || 'Failed to record build')
      }
```

**Changes**:
1. Line 135: Add `.catch(() => ({}))` after `res.json()`
2. Line 139: Change `data.insufficientItems` to `data?.insufficientItems`
3. Line 144: Change `data.error` to `data?.error`

**Completion Criteria**:
- [ ] Code compiles without TypeScript errors
- [ ] Existing functionality for insufficient inventory warning is preserved
- [ ] Pattern matches FeedbackDialog exactly

---

### Subtask 1.4: Fix ComponentForm.tsx

**File**: `/home/pbrown/SkuInventory/src/components/features/ComponentForm.tsx`
**Lines**: 79-82
**Pattern Reference**: FeedbackDialog.tsx line 108

**Current Code (Line 79-82)**:
```typescript
      if (!res.ok) {
        const data = await res.json()
        throw new Error(data.message || 'Failed to save component')
      }
```

**Fixed Code**:
```typescript
      if (!res.ok) {
        const data = await res.json().catch(() => ({}))
        throw new Error(data?.message || 'Failed to save component')
      }
```

**Changes**:
1. Line 80: Add `.catch(() => ({}))` after `res.json()`
2. Line 81: Change `data.message` to `data?.message`

**Completion Criteria**:
- [ ] Code compiles without TypeScript errors
- [ ] Pattern matches FeedbackDialog exactly

---

### Subtask 1.5: Fix SKUForm.tsx

**File**: `/home/pbrown/SkuInventory/src/components/features/SKUForm.tsx`
**Lines**: 65-68
**Pattern Reference**: FeedbackDialog.tsx line 108

**Current Code (Line 65-68)**:
```typescript
      if (!res.ok) {
        const data = await res.json()
        throw new Error(data.message || 'Failed to save SKU')
      }
```

**Fixed Code**:
```typescript
      if (!res.ok) {
        const data = await res.json().catch(() => ({}))
        throw new Error(data?.message || 'Failed to save SKU')
      }
```

**Changes**:
1. Line 66: Add `.catch(() => ({}))` after `res.json()`
2. Line 67: Change `data.message` to `data?.message`

**Completion Criteria**:
- [ ] Code compiles without TypeScript errors
- [ ] Pattern matches FeedbackDialog exactly

---

### Subtask 1.6: Fix BOMVersionForm.tsx (First Location - fetchComponents)

**File**: `/home/pbrown/SkuInventory/src/components/features/BOMVersionForm.tsx`
**Lines**: 63-67
**Pattern Reference**: FeedbackDialog.tsx line 108

**Current Code (Line 63-67)**:
```typescript
        const res = await fetch('/api/components?isActive=true&pageSize=100')
        if (res.ok) {
          const data = await res.json()
          setComponents(data.data)
        }
```

**Fixed Code**:
```typescript
        const res = await fetch('/api/components?isActive=true&pageSize=100')
        if (res.ok) {
          const data = await res.json().catch(() => ({}))
          setComponents(data?.data || [])
        }
```

**Changes**:
1. Line 65: Add `.catch(() => ({}))` after `res.json()`
2. Line 66: Change `data.data` to `data?.data || []` to handle undefined

**Completion Criteria**:
- [ ] Code compiles without TypeScript errors
- [ ] Component list defaults to empty array if parsing fails

---

### Subtask 1.7: Fix BOMVersionForm.tsx (Second Location - handleSubmit)

**File**: `/home/pbrown/SkuInventory/src/components/features/BOMVersionForm.tsx`
**Lines**: 149-152
**Pattern Reference**: FeedbackDialog.tsx line 151

**Current Code (Line 149-152)**:
```typescript
      if (!res.ok) {
        const data = await res.json()
        throw new Error(data.message || 'Failed to create BOM version')
      }
```

**Fixed Code**:
```typescript
      if (!res.ok) {
        const data = await res.json().catch(() => ({}))
        throw new Error(data?.message || 'Failed to create BOM version')
      }
```

**Changes**:
1. Line 150: Add `.catch(() => ({}))` after `res.json()`
2. Line 151: Change `data.message` to `data?.message`

**Completion Criteria**:
- [ ] Code compiles without TypeScript errors
- [ ] Pattern matches FeedbackDialog exactly

---

### Subtask 1.8: Fix UserForm.tsx

**File**: `/home/pbrown/SkuInventory/src/components/features/UserForm.tsx`
**Lines**: 73-76
**Pattern Reference**: FeedbackDialog.tsx line 108

**Current Code (Line 73-76)**:
```typescript
      if (!res.ok) {
        const data = await res.json()
        throw new Error(data.error || 'Failed to save user')
      }
```

**Fixed Code**:
```typescript
      if (!res.ok) {
        const data = await res.json().catch(() => ({}))
        throw new Error(data?.error || 'Failed to save user')
      }
```

**Changes**:
1. Line 74: Add `.catch(() => ({}))` after `res.json()`
2. Line 75: Change `data.error` to `data?.error`

**Completion Criteria**:
- [ ] Code compiles without TypeScript errors
- [ ] Pattern matches FeedbackDialog exactly

---

## Phase 2: Validation

### Subtask 2.1: TypeScript Compilation Check

**Instructions**:
```bash
cd /home/pbrown/SkuInventory && npx tsc --noEmit
```

**Completion Criteria**:
- [ ] No TypeScript errors
- [ ] No new warnings introduced

### Subtask 2.2: Build Verification

**Instructions**:
```bash
cd /home/pbrown/SkuInventory && npm run build
```

**Completion Criteria**:
- [ ] Build completes successfully
- [ ] No new build warnings

### Subtask 2.3: Lint Check

**Instructions**:
```bash
cd /home/pbrown/SkuInventory && npm run lint
```

**Completion Criteria**:
- [ ] Lint passes
- [ ] No new lint warnings

---

## Summary of Deliverables

**Files Modified**: 7
1. `/home/pbrown/SkuInventory/src/components/features/ReceiptDialog.tsx`
2. `/home/pbrown/SkuInventory/src/components/features/AdjustmentDialog.tsx`
3. `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx`
4. `/home/pbrown/SkuInventory/src/components/features/ComponentForm.tsx`
5. `/home/pbrown/SkuInventory/src/components/features/SKUForm.tsx`
6. `/home/pbrown/SkuInventory/src/components/features/BOMVersionForm.tsx`
7. `/home/pbrown/SkuInventory/src/components/features/UserForm.tsx`

**Total Locations Fixed**: 8 (BOMVersionForm has 2 locations)

**Files Created**: 0

**Tests**: Optional - test pattern available in `/home/pbrown/SkuInventory/tests/unit/FeedbackDialog.test.tsx` lines 1027-1045 demonstrating JSON parse failure handling.

---

## Testing Strategy (Optional)

For each component, the following manual test can be performed:

1. Modify the API route temporarily to return HTML instead of JSON
2. Trigger the dialog action
3. Verify error message displays correctly (not a cryptic SyntaxError)
4. Verify UI doesn't crash

**Automated Test Pattern** (from FeedbackDialog.test.tsx):
```typescript
it('handles JSON parse failure gracefully', async () => {
  mockFetch.mockResolvedValueOnce({
    ok: false,
    json: () => Promise.reject(new Error('Invalid JSON'))
  })

  // Trigger action and verify fallback error message is shown
})
```

---

## Acceptance Criteria

- [ ] All 7 files modified with safe JSON parsing pattern
- [ ] All 8 locations have `.catch(() => ({}))` wrapper
- [ ] All error message extractions use optional chaining (`?.`)
- [ ] TypeScript compiles without errors
- [ ] Build succeeds without errors
- [ ] Lint passes
- [ ] When API returns non-JSON, user sees friendly error message (not SyntaxError)

---

## Handoff to Build Agent

1. Execute subtasks 1.1-1.8 (can be done in parallel or sequence)
2. Each file edit is a simple find-and-replace operation
3. After all edits, run Phase 2 validation checks
4. Commit all changes in a single commit with message: `fix(issue #30): add safe JSON parsing to prevent dialog crashes on non-JSON API responses`

---

## Notes for Build Agent

**Key Pattern to Apply**:
```typescript
// BEFORE (unsafe)
const data = await res.json()
throw new Error(data.message || 'Fallback')

// AFTER (safe)
const data = await res.json().catch(() => ({}))
throw new Error(data?.message || 'Fallback')
```

**Why This Works**:
- `.catch(() => ({}))` returns an empty object if JSON parsing fails
- `data?.message` safely returns `undefined` if `data` is empty or missing `message`
- The fallback string is used when `data?.message` is falsy

**Reference Implementation**: See `/home/pbrown/SkuInventory/src/components/features/FeedbackDialog.tsx` lines 107-109 and 150-152.

---

## Out of Scope

The following page components were identified with similar patterns but are not included in this fix (recommend separate issue):
- `src/app/(dashboard)/skus/[id]/bom/new/page.tsx`
- `src/app/(dashboard)/settings/page.tsx`
- `src/app/(dashboard)/settings/users/page.tsx`
- `src/app/(dashboard)/settings/users/[id]/edit/page.tsx`
- `src/app/(dashboard)/transactions/[id]/page.tsx`

---

## Performance Metrics

| Phase | Duration |
|-------|----------|
| Scout Review | 5m |
| Code Verification | 10m |
| Pattern Research | 3m |
| Plan Writing | 12m |
| **Total** | **30m** |

---

AGENT_RETURN: plan-30-120325
