# Implementation Plan
**Generated**: 2025-12-18 16:45 UTC
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #328
**Estimated Build Time**: 2-3 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Feature
**Source**: GitHub Issue #328
**Priority**: Medium

**Issue Title**: Feature: Allow manual ASIN entry in ASIN Mapping

**Issue Description Summary**:
Users cannot manually enter an ASIN to create a mapping. The current ASIN Mapping feature only shows:
1. ASINs that were already imported from Amazon Ads sync or CSV upload
2. A search box that filters existing mappings (doesn't create new ones)

Users need the ability to proactively create ASIN mappings before importing sales data by manually entering an ASIN.

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: `--testPathPattern="integration"` (no specific ASIN tests exist)

### Issue Validation
**Status**: Valid
**Recent Changes**:
- `5689b18` fix(issue #310): use company-specific role checks for all permissions
- `a5c9604` fix(issue #289): fix CSV upload and related routes using isPrimary
- The API route already validates ASIN format (10 alphanumeric chars) - line 206-212 of route.ts

### Current State Assessment

**Existing Components**:
1. `src/components/integrations/asin-mapping-list.tsx` - Main list component, needs "Add Mapping" button
2. `src/components/integrations/asin-mapping-modal.tsx` - Existing modal for mapping unmapped ASINs to SKUs (can be reused/extended)

**Database**:
- `AsinSkuMapping` model exists in Prisma schema (lines 917-936)
- No schema changes required

**API Routes**:
- `POST /api/asin-mapping` - Already exists and supports manual creation (lines 183-282)
- Already validates ASIN format (10 alphanumeric characters)
- Already checks for duplicate mappings
- Already requires admin role

**Types**: No new types needed - existing interfaces in component files are sufficient

### Dependencies & Blockers
None. The API already supports the required functionality. This is purely a UI feature.

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Simple
**Effort**: 2-3 hours
**Risk**: Low

### Patterns Identified

**Primary Pattern**: `src/components/features/DefectThresholdConfig.tsx` (lines 206-310)
- CardHeader with "Add" button using DialogTrigger pattern
- Form fields inside Dialog with validation
- Uses `Plus` icon from lucide-react
- Has loading/saving states
- Refreshes list after successful creation

**Secondary Pattern**: `src/components/integrations/asin-mapping-modal.tsx`
- Existing modal structure for ASIN mapping
- Already fetches SKUs
- Already handles brand selection (though currently read-only from unmappedAsin)
- Can be extended to support manual ASIN entry mode

### Ripple Effect Analysis
**Files Identified**: 2

| File | Reason |
|------|--------|
| `src/components/integrations/asin-mapping-list.tsx` | Add "Add Mapping" button, new state for manual modal |
| `src/components/integrations/asin-mapping-modal.tsx` | Extend to support manual ASIN entry mode |

**No Additional Files Required**:
- API route already supports manual creation
- No new types needed
- No database changes needed

---

## Executive Summary

This feature adds a UI to allow users to manually create ASIN-to-SKU mappings. The API already supports this functionality (POST /api/asin-mapping with ASIN validation), so only frontend changes are needed. We will add an "Add Mapping" button to the ASIN Mappings card header and extend the existing modal to support manual ASIN entry with brand selection.

---

## Phase 1: Extend ASIN Mapping Modal for Manual Entry

### Subtask 1.1: Update AsinMappingModal Props Interface
**File**: `/home/pbrown/SkuInventory/src/components/integrations/asin-mapping-modal.tsx`
**Pattern**: Follow existing interface pattern at lines 42-48
**Instructions**:
1. Add a `mode` prop to distinguish between 'map-unmapped' and 'manual-entry' modes
2. Make `unmappedAsin` optional (only required for 'map-unmapped' mode)
3. Add prop types for the new mode

**Code Change**:
```typescript
interface AsinMappingModalProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  mode: 'map-unmapped' | 'manual-entry'  // NEW
  unmappedAsin?: UnmappedAsin | null     // Make optional
  brands: Brand[]
  onSuccess: () => void
}
```

**Completion Criteria**:
- [ ] Props interface updated with mode and optional unmappedAsin
- [ ] No TypeScript errors

### Subtask 1.2: Add State for Manual ASIN Entry
**File**: `/home/pbrown/SkuInventory/src/components/integrations/asin-mapping-modal.tsx`
**Pattern**: Follow existing state declarations at lines 57-62
**Instructions**:
1. Add state for manual ASIN input: `const [manualAsin, setManualAsin] = useState('')`
2. Add state for selected brand: `const [selectedBrandId, setSelectedBrandId] = useState<string>('')`
3. Add state for ASIN validation error: `const [asinError, setAsinError] = useState<string | null>(null)`

**Code Change**:
```typescript
const [manualAsin, setManualAsin] = useState('')
const [selectedBrandId, setSelectedBrandId] = useState<string>('')
const [asinError, setAsinError] = useState<string | null>(null)
```

**Completion Criteria**:
- [ ] New state variables added
- [ ] No TypeScript errors

### Subtask 1.3: Update Reset Logic in useEffect
**File**: `/home/pbrown/SkuInventory/src/components/integrations/asin-mapping-modal.tsx`
**Pattern**: Follow existing useEffect at lines 65-72
**Instructions**:
1. Reset manualAsin, selectedBrandId, and asinError when modal opens
2. If mode is 'map-unmapped' and unmappedAsin exists, pre-select the brand

**Code Change**:
```typescript
useEffect(() => {
  if (open) {
    setSelectedSku('')
    setSearchTerm('')
    setError(null)
    setManualAsin('')
    setAsinError(null)
    // Pre-select brand from unmappedAsin if in map-unmapped mode
    if (mode === 'map-unmapped' && unmappedAsin) {
      setSelectedBrandId(unmappedAsin.brandId)
    } else {
      setSelectedBrandId('')
    }
    fetchSkus()
  }
}, [open, mode, unmappedAsin])
```

**Completion Criteria**:
- [ ] useEffect updated with new reset logic
- [ ] Dependencies array includes mode and unmappedAsin
- [ ] No TypeScript errors

### Subtask 1.4: Add ASIN Validation Function
**File**: `/home/pbrown/SkuInventory/src/components/integrations/asin-mapping-modal.tsx`
**Pattern**: Follow API validation pattern at route.ts lines 206-212
**Instructions**:
1. Add a function to validate ASIN format (10 alphanumeric characters)
2. Called onChange for immediate feedback

**Code Change** (add after state declarations):
```typescript
const validateAsin = (asin: string): string | null => {
  if (!asin) return null // Don't show error for empty
  if (!/^[A-Z0-9]{10}$/i.test(asin)) {
    return 'ASIN must be 10 alphanumeric characters'
  }
  return null
}

const handleAsinChange = (value: string) => {
  const upperValue = value.toUpperCase()
  setManualAsin(upperValue)
  setAsinError(validateAsin(upperValue))
}
```

**Completion Criteria**:
- [ ] Validation function matches API validation
- [ ] ASIN is auto-uppercased (consistent with API)
- [ ] No TypeScript errors

### Subtask 1.5: Update handleSubmit for Manual Entry Mode
**File**: `/home/pbrown/SkuInventory/src/components/integrations/asin-mapping-modal.tsx`
**Pattern**: Follow existing handleSubmit at lines 89-121
**Instructions**:
1. Update validation to check for manual mode requirements
2. Use manualAsin and selectedBrandId when in manual-entry mode
3. Keep existing logic for map-unmapped mode

**Code Change**:
```typescript
const handleSubmit = async () => {
  // Determine ASIN and brandId based on mode
  const asin = mode === 'manual-entry' ? manualAsin : unmappedAsin?.asin
  const brandId = mode === 'manual-entry' ? selectedBrandId : unmappedAsin?.brandId

  if (!asin || !brandId || !selectedSku) {
    if (!asin) {
      setError('Please enter an ASIN')
    } else if (!brandId) {
      setError('Please select a brand')
    } else {
      setError('Please select a SKU')
    }
    return
  }

  // Validate ASIN format for manual entry
  if (mode === 'manual-entry') {
    const validationError = validateAsin(asin)
    if (validationError) {
      setError(validationError)
      return
    }
  }

  setSaving(true)
  setError(null)

  try {
    const response = await fetch('/api/asin-mapping', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        brandId,
        asin,
        skuId: selectedSku,
        productName: mode === 'map-unmapped' ? unmappedAsin?.productName : null,
      }),
    })

    if (!response.ok) {
      const data = await response.json()
      throw new Error(data.error || 'Failed to create mapping')
    }

    onSuccess()
  } catch (err) {
    setError(err instanceof Error ? err.message : 'Failed to create mapping')
  } finally {
    setSaving(false)
  }
}
```

**Completion Criteria**:
- [ ] handleSubmit works for both modes
- [ ] Proper validation for manual entry
- [ ] No TypeScript errors

### Subtask 1.6: Update Dialog Content for Manual Entry Mode
**File**: `/home/pbrown/SkuInventory/src/components/integrations/asin-mapping-modal.tsx`
**Pattern**: Follow existing Dialog structure at lines 136-251
**Instructions**:
1. Update DialogTitle and DialogDescription based on mode
2. Add ASIN input field for manual-entry mode (instead of read-only display)
3. Add Brand selector for manual-entry mode (instead of read-only display)
4. Keep existing SKU selection logic

**Key Changes in the JSX**:
1. Change DialogTitle to show "Add ASIN Mapping" for manual mode
2. For manual mode: show Input for ASIN with validation feedback
3. For manual mode: show Select dropdown for brand selection
4. For map-unmapped mode: keep existing read-only displays

**Code Structure** (conceptual - actual implementation will be in Edit):
```typescript
<DialogTitle>
  {mode === 'manual-entry' ? 'Add ASIN Mapping' : 'Map ASIN to SKU'}
</DialogTitle>
<DialogDescription>
  {mode === 'manual-entry'
    ? 'Enter an ASIN and select a brand and SKU to create a mapping.'
    : 'Select an internal SKU to map to this Amazon ASIN.'}
</DialogDescription>

{/* ASIN Field */}
{mode === 'manual-entry' ? (
  <div className="space-y-2">
    <Label htmlFor="asin-input">ASIN</Label>
    <Input
      id="asin-input"
      placeholder="e.g., B07XXXXXXXXX"
      value={manualAsin}
      onChange={(e) => handleAsinChange(e.target.value)}
      maxLength={10}
    />
    {asinError && (
      <p className="text-sm text-destructive">{asinError}</p>
    )}
  </div>
) : (
  // Existing read-only ASIN display
)}

{/* Brand Field */}
{mode === 'manual-entry' ? (
  <div className="space-y-2">
    <Label>Brand</Label>
    <Select value={selectedBrandId} onValueChange={setSelectedBrandId}>
      <SelectTrigger>
        <SelectValue placeholder="Select a brand" />
      </SelectTrigger>
      <SelectContent>
        {brands.map(brand => (
          <SelectItem key={brand.id} value={brand.id}>
            {brand.name}
          </SelectItem>
        ))}
      </SelectContent>
    </Select>
  </div>
) : (
  // Existing read-only brand display
)}
```

**Completion Criteria**:
- [ ] Dialog shows appropriate title/description based on mode
- [ ] Manual mode shows ASIN input with validation
- [ ] Manual mode shows brand selector
- [ ] Map-unmapped mode continues to work as before
- [ ] No TypeScript errors

### Subtask 1.7: Add Select Import
**File**: `/home/pbrown/SkuInventory/src/components/integrations/asin-mapping-modal.tsx`
**Pattern**: Follow import pattern in asin-mapping-list.tsx lines 14-20
**Instructions**:
1. Add Select component imports from @/components/ui/select

**Code Change**:
```typescript
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
```

**Completion Criteria**:
- [ ] Select components imported
- [ ] No import errors

---

## Phase 2: Add "Add Mapping" Button to List Component

### Subtask 2.1: Add State for Manual Modal
**File**: `/home/pbrown/SkuInventory/src/components/integrations/asin-mapping-list.tsx`
**Pattern**: Follow existing modal state at lines 74-76
**Instructions**:
1. Add state to track when manual entry modal should be open

**Code Change** (add after line 76):
```typescript
const [manualModalOpen, setManualModalOpen] = useState(false)
```

**Completion Criteria**:
- [ ] New state variable added
- [ ] No TypeScript errors

### Subtask 2.2: Add Plus Icon Import
**File**: `/home/pbrown/SkuInventory/src/components/integrations/asin-mapping-list.tsx`
**Pattern**: Follow existing icon imports at line 29
**Instructions**:
1. Add `Plus` to the lucide-react import

**Code Change**:
```typescript
import { Loader2, Link2, Unlink, Search, ChevronDown, ChevronUp, Plus } from 'lucide-react'
```

**Completion Criteria**:
- [ ] Plus icon imported
- [ ] No import errors

### Subtask 2.3: Add "Add Mapping" Button to CardHeader
**File**: `/home/pbrown/SkuInventory/src/components/integrations/asin-mapping-list.tsx`
**Pattern**: Follow `amazon-ads-card.tsx` pattern at lines 150-175, and `DefectThresholdConfig.tsx` at lines 209-225
**Instructions**:
1. Add "Add Mapping" button next to the CardTitle/CardDescription
2. Only show for admin users (using isAdmin prop)
3. Button should open the manual entry modal

**Code Change** (modify CardHeader section around lines 173-185):
```typescript
<CardHeader>
  <div className="flex items-center justify-between">
    <div>
      <CardTitle className="flex items-center gap-2">
        <Link2 className="h-5 w-5" />
        ASIN Mappings
      </CardTitle>
      <CardDescription>
        Map Amazon ASINs to your internal SKU codes for sales attribution.
      </CardDescription>
    </div>
    {isAdmin && (
      <Button onClick={() => setManualModalOpen(true)}>
        <Plus className="h-4 w-4 mr-2" />
        Add Mapping
      </Button>
    )}
  </div>
</CardHeader>
```

**Completion Criteria**:
- [ ] "Add Mapping" button appears in header
- [ ] Button only visible for admin users
- [ ] Button opens modal when clicked
- [ ] No TypeScript errors

### Subtask 2.4: Add Handler for Manual Modal Success
**File**: `/home/pbrown/SkuInventory/src/components/integrations/asin-mapping-list.tsx`
**Pattern**: Follow handleMappingCreated at lines 137-141
**Instructions**:
1. Add handler function for when manual mapping is created

**Code Change** (add after handleMappingCreated):
```typescript
const handleManualMappingCreated = () => {
  setManualModalOpen(false)
  fetchMappings()
}
```

**Completion Criteria**:
- [ ] Handler function added
- [ ] Closes modal and refreshes list
- [ ] No TypeScript errors

### Subtask 2.5: Add Second Modal Instance for Manual Entry
**File**: `/home/pbrown/SkuInventory/src/components/integrations/asin-mapping-list.tsx`
**Pattern**: Follow existing modal instance at lines 347-355
**Instructions**:
1. Add a second AsinMappingModal instance for manual entry mode
2. Pass mode="manual-entry" prop
3. Use manualModalOpen state

**Code Change** (add after existing AsinMappingModal, around line 355):
```typescript
{/* Manual Entry Modal */}
<AsinMappingModal
  open={manualModalOpen}
  onOpenChange={setManualModalOpen}
  mode="manual-entry"
  brands={brands}
  onSuccess={handleManualMappingCreated}
/>
```

**Completion Criteria**:
- [ ] Second modal instance added
- [ ] Uses manual-entry mode
- [ ] No TypeScript errors

### Subtask 2.6: Update Existing Modal Instance
**File**: `/home/pbrown/SkuInventory/src/components/integrations/asin-mapping-list.tsx`
**Pattern**: Existing modal at lines 347-355
**Instructions**:
1. Add mode="map-unmapped" prop to existing modal instance

**Code Change**:
```typescript
{/* Mapping Modal */}
<AsinMappingModal
  open={modalOpen}
  onOpenChange={setModalOpen}
  mode="map-unmapped"
  unmappedAsin={selectedUnmapped}
  brands={brands}
  onSuccess={handleMappingCreated}
/>
```

**Completion Criteria**:
- [ ] Existing modal updated with mode prop
- [ ] No TypeScript errors

---

## Phase 3: Validation and Testing

### Subtask 3.1: TypeScript Verification
**Instructions**:
1. Run TypeScript check to ensure no type errors

**Validation Commands**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] No TypeScript errors

### Subtask 3.2: Build Verification
**Instructions**:
1. Run build to ensure no compilation errors

**Validation Commands**:
```bash
npm run build
```

**Completion Criteria**:
- [ ] Build completes successfully

### Subtask 3.3: Lint Verification
**Instructions**:
1. Run linter to check code style

**Validation Commands**:
```bash
npm run lint
```

**Completion Criteria**:
- [ ] No lint errors

### Subtask 3.4: Manual UI Testing (Test Environment)
**Instructions**:
1. Access test environment at http://172.16.20.50:2345
2. Navigate to Integrations page
3. Verify "Add Mapping" button is visible for admin users
4. Click "Add Mapping" button
5. Verify modal opens with ASIN input, Brand selector, and SKU selector
6. Test ASIN validation (enter invalid ASIN, see error)
7. Test successful mapping creation

**Test Scenarios**:
1. ASIN validation - less than 10 chars -> error message
2. ASIN validation - non-alphanumeric -> error message
3. ASIN validation - exactly 10 alphanumeric -> no error
4. Missing brand selection -> error message
5. Missing SKU selection -> error message
6. Duplicate ASIN mapping -> API error displayed
7. Successful creation -> modal closes, list refreshes

**Completion Criteria**:
- [ ] Add Mapping button visible for admin
- [ ] Modal opens with all required fields
- [ ] ASIN validation works correctly
- [ ] Brand selector works
- [ ] SKU selector works
- [ ] Error messages display properly
- [ ] Successful creation closes modal and refreshes list

---

## Summary of Deliverables

**Files Created**: 0
**Files Modified**: 2

| File | Changes |
|------|---------|
| `src/components/integrations/asin-mapping-modal.tsx` | Add mode prop, manual ASIN input, brand selector |
| `src/components/integrations/asin-mapping-list.tsx` | Add "Add Mapping" button, manual modal state |

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 before Phase 2)
2. Complete all Phase 1 subtasks before starting Phase 2
3. Test completion criteria before next subtask
4. Follow reference patterns exactly:
   - `DefectThresholdConfig.tsx` for button/dialog pattern
   - `amazon-ads-card.tsx` for CardHeader button layout
5. Use test environment (http://172.16.20.50:2345) for verification

---

## Test Strategy Note

**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
- No existing ASIN-specific tests to run
- Manual UI testing against test environment required
- Integration tests for API already exist (API supports this feature)

---

## UI Acceptance Criteria

- [ ] "Add Mapping" button visible in ASIN Mappings card header (admin only)
- [ ] Button visible on all screen sizes (no lg:hidden classes)
- [ ] Modal opens when button clicked
- [ ] Modal contains: ASIN input, Brand selector, SKU selector
- [ ] ASIN validates to 10 alphanumeric characters with real-time feedback
- [ ] Brand selector shows all brands for current company
- [ ] SKU selector shows all SKUs for current company
- [ ] Duplicate ASIN error from API is displayed to user
- [ ] List refreshes after successful creation

---

## Performance Metrics

| Phase | Duration |
|-------|----------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 10m |
| **Total** | **30m** |
