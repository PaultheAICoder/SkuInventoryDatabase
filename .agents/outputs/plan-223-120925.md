# Implementation Plan
**Generated**: 2025-12-09T10:45:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #223
**Estimated Build Time**: 4-6 hours
**Complexity**: Medium

## Investigation Summary

### Request Analysis
**Type**: Refactoring
**Source**: GitHub Issue #223 - "Refactor: User-Company Phase 2 - Update auth.ts to use UserCompany exclusively"
**Priority**: Medium
**Parent Issue**: #214 (Phase 1 complete - added isPrimary to UserCompany)

### Task Classification
**Category**: REFACTORING
**Test Strategy**: TARGETED (auth-related tests, ~5-10 minutes)
**Suggested Filter**: `--filter="auth"` for unit tests

### Issue Validation
**Status**: Valid
**Recent Changes**:
- Phase 1 (#214) completed 2025-12-08: Added `isPrimary` to UserCompany model
- Data migration script created to ensure all users have UserCompany records
- All users now have proper UserCompany records with isPrimary flags

### Current State Assessment

#### auth.ts Analysis
The current `src/lib/auth.ts` has several "backward compatibility" workarounds that need to be removed:

1. **Line 52-56**: Building `accessibleCompanyIds` includes a fallback to add `user.companyId` if not in UserCompany
   ```typescript
   const accessibleCompanyIds = user ? user.userCompanies.map(uc => uc.company.id) : []
   // Ensure primary company is included
   if (user && !accessibleCompanyIds.includes(user.companyId)) {
     accessibleCompanyIds.push(user.companyId)
   }
   ```

2. **Line 107-111**: Building companies list from userCompanies with fallback to user.company
   ```typescript
   // Ensure primary company is included (for backward compatibility)
   const primaryCompanyIncluded = companiesFromJoin.some(c => c.id === user.companyId)
   const companies = primaryCompanyIncluded
     ? companiesFromJoin
     : [{ id: user.company.id, name: user.company.name, role: user.role }, ...companiesFromJoin]
   ```

3. **Line 113-115**: selectedCompanyId defaults to user.companyId
   ```typescript
   // Selected company defaults to primary company
   const selectedCompanyId = user.companyId
   const selectedCompanyName = user.company.name
   ```

4. **Line 190-195**: JWT callback fallback for tokens without selectedCompanyId
   ```typescript
   // Ensure selectedCompanyId has a fallback value for backward compatibility
   // This handles tokens created before multi-company support was added
   if (!token.selectedCompanyId && token.companyId) {
     token.selectedCompanyId = token.companyId
     token.selectedCompanyName = token.companyName
   }
   ```

5. **Line 206-208**: Company switching keeps companyId in sync
   ```typescript
   // Keep companyId in sync for backward compatibility
   token.companyId = session.selectedCompanyId
   token.companyName = session.selectedCompanyName
   ```

#### Files Using `session.user.companyId` (need review)

After Phase 2, most files should use `session.user.selectedCompanyId`. However, some files still use `session.user.companyId`:

| File | Lines | Usage Context | Action |
|------|-------|---------------|--------|
| `src/lib/auth.ts` | multiple | Session building | Update to use UserCompany.isPrimary |
| `src/app/api/users/[id]/route.ts` | 29,116,133,227 | User management within admin's company | Keep - appropriate for tenant scoping |
| `src/app/api/users/[id]/companies/route.ts` | 30,106,159,167 | User company assignments | Partial update - line 167 backward compat |
| `src/app/api/transactions/[id]/route.ts` | 22 | Transaction access check | Change to selectedCompanyId |
| `src/app/api/export/transactions/route.ts` | 47 | Export for user's company | Change to selectedCompanyId |
| `src/app/api/chatbot/route.ts` | 32 | Chatbot context | Change to selectedCompanyId |
| `src/app/api/alerts/defects/route.ts` | 38,46,70 | Defect alerts | Change to selectedCompanyId |
| `src/app/api/analytics/defects/route.ts` | 32,50,51,65 | Defect analytics | Change to selectedCompanyId |
| `src/types/index.ts` | 92 | SessionUser type | Update comment, keep field for now |

#### Key Observation
The issue mentions "potentially 7 other files" but our investigation found:
- `auth.ts` has 5 backward compatibility patterns
- 6 API routes still use `session.user.companyId` instead of `selectedCompanyId`
- These API routes should use `selectedCompanyId` for consistency with the rest of the codebase

### Dependencies & Blockers
1. **Phase 1 Complete**: isPrimary field exists and all users have UserCompany records
2. **No blockers identified**

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Moderate
**Effort**: 4-6 hours
**Risk**: Medium - Session changes could affect logged-in users. Users with stale JWT tokens may need to re-login.

### Patterns Identified
**Primary**: Most API routes already use `session.user.selectedCompanyId` (see grep results showing 90+ usages)
**Secondary**: UserCompany queries use `isPrimary` flag to identify primary company

### Ripple Effect Analysis

**Files Identified**: 9 files

| File | Why Affected |
|------|--------------|
| `src/lib/auth.ts` | Main target - remove backward compatibility code |
| `src/app/api/users/[id]/route.ts` | Uses companyId for tenant scoping (may keep) |
| `src/app/api/users/[id]/companies/route.ts` | Line 167 has backward compat code |
| `src/app/api/transactions/[id]/route.ts` | Uses companyId, should use selectedCompanyId |
| `src/app/api/export/transactions/route.ts` | Uses user.companyId lookup |
| `src/app/api/chatbot/route.ts` | Uses companyId, should use selectedCompanyId |
| `src/app/api/alerts/defects/route.ts` | Uses companyId, should use selectedCompanyId |
| `src/app/api/analytics/defects/route.ts` | Uses companyId, should use selectedCompanyId |
| `src/types/index.ts` | SessionUser.companyId comment needs update |

**Test Files Affected**:
- `tests/unit/auth-validation.test.ts` - May need updates for new behavior
- `tests/integration/auth.test.ts` - May need updates for session structure
- `tests/helpers/auth-mock.ts` - Session mock structure

---

## Executive Summary

This refactoring updates `src/lib/auth.ts` and 6 API routes to derive company access exclusively from the UserCompany table, eliminating backward compatibility workarounds that were added during the multi-company transition. The session will be built from UserCompany records, using `isPrimary` to determine the default selected company. This is Phase 2 of a 3-phase refactoring effort.

## Phase 1: Update auth.ts - Session Building

### Subtask 1.1: Update authorize() to use UserCompany.isPrimary for primary company
**File**: `/home/pbrown/SkuInventory/src/lib/auth.ts`
**Lines**: 40-65 (accessibleCompanyIds building)
**Pattern**: Use `isPrimary: true` from UserCompany instead of `user.companyId`

**Instructions**:
1. Find the UserCompany record with `isPrimary: true` to determine primary company
2. Remove the "Ensure primary company is included" fallback (lines 53-56)
3. Build `accessibleCompanyIds` directly from UserCompany records without fallback

**Code Change**:
```typescript
// BEFORE (lines 52-56):
const accessibleCompanyIds = user ? user.userCompanies.map(uc => uc.company.id) : []
// Ensure primary company is included
if (user && !accessibleCompanyIds.includes(user.companyId)) {
  accessibleCompanyIds.push(user.companyId)
}

// AFTER:
const accessibleCompanyIds = user ? user.userCompanies.map(uc => uc.company.id) : []
// UserCompany records are the single source of truth - no fallback needed
```

**Completion Criteria**:
- [ ] accessibleCompanyIds built from UserCompany only
- [ ] No fallback to user.companyId
- [ ] "Ensure primary company is included" comment removed

### Subtask 1.2: Update companies list building to use UserCompany exclusively
**File**: `/home/pbrown/SkuInventory/src/lib/auth.ts`
**Lines**: 100-115 (companies building and selectedCompanyId)
**Pattern**: Use UserCompany.isPrimary for determining primary company

**Instructions**:
1. Remove the backward compatibility check (lines 107-111)
2. Update selectedCompanyId to use the isPrimary UserCompany record
3. Update selectedCompanyName similarly

**Code Change**:
```typescript
// BEFORE (lines 100-115):
// Build companies list from userCompanies
const companiesFromJoin = user.userCompanies.map(uc => ({
  id: uc.company.id,
  name: uc.company.name,
  role: uc.role,
}))

// Ensure primary company is included (for backward compatibility)
const primaryCompanyIncluded = companiesFromJoin.some(c => c.id === user.companyId)
const companies = primaryCompanyIncluded
  ? companiesFromJoin
  : [{ id: user.company.id, name: user.company.name, role: user.role }, ...companiesFromJoin]

// Selected company defaults to primary company
const selectedCompanyId = user.companyId
const selectedCompanyName = user.company.name

// AFTER:
// Build companies list from userCompanies (single source of truth)
const companies = user.userCompanies.map(uc => ({
  id: uc.company.id,
  name: uc.company.name,
  role: uc.role,
}))

// Find primary company from UserCompany.isPrimary
const primaryUserCompany = user.userCompanies.find(uc => uc.isPrimary)
const selectedCompanyId = primaryUserCompany?.company.id ?? companies[0]?.id ?? ''
const selectedCompanyName = primaryUserCompany?.company.name ?? companies[0]?.name ?? ''
```

**Completion Criteria**:
- [ ] "backward compatibility" comment removed
- [ ] Companies list built from UserCompany only
- [ ] selectedCompanyId uses isPrimary UserCompany
- [ ] Fallback to first company if no isPrimary (defensive)

### Subtask 1.3: Update brands fetching to use isPrimary company
**File**: `/home/pbrown/SkuInventory/src/lib/auth.ts`
**Lines**: 41-49 (brands fetching for primary company)
**Pattern**: Use isPrimary UserCompany instead of user.companyId

**Instructions**:
1. Update brands query to use the isPrimary company

**Code Change**:
```typescript
// BEFORE (lines 41-49):
// Fetch brands for the user's primary company
const brands = user ? await prisma.brand.findMany({
  where: {
    companyId: user.companyId,
    isActive: true,
  },
  select: { id: true, name: true },
  orderBy: { name: 'asc' },
}) : []

// AFTER:
// Find primary company from UserCompany
const primaryCompany = user?.userCompanies.find(uc => uc.isPrimary)
// Fetch brands for the user's primary company
const brands = user && primaryCompany ? await prisma.brand.findMany({
  where: {
    companyId: primaryCompany.company.id,
    isActive: true,
  },
  select: { id: true, name: true },
  orderBy: { name: 'asc' },
}) : []
```

**Completion Criteria**:
- [ ] Brands fetched using isPrimary UserCompany
- [ ] No reference to user.companyId for brand fetching

### Subtask 1.4: Update JWT callback backward compatibility code
**File**: `/home/pbrown/SkuInventory/src/lib/auth.ts`
**Lines**: 190-208 (JWT callback)
**Pattern**: Remove fallback code

**Instructions**:
1. Remove the selectedCompanyId fallback (lines 190-195)
2. Keep the company switching sync (lines 206-208) but update comment

**Code Change**:
```typescript
// BEFORE (lines 190-195):
// Ensure selectedCompanyId has a fallback value for backward compatibility
// This handles tokens created before multi-company support was added
if (!token.selectedCompanyId && token.companyId) {
  token.selectedCompanyId = token.companyId
  token.selectedCompanyName = token.companyName
}

// AFTER:
// Note: Old tokens without selectedCompanyId will need re-authentication
// This is acceptable as Phase 1 ensured all users have proper UserCompany records
```

**Completion Criteria**:
- [ ] Fallback code removed
- [ ] Comment explains expected behavior for old tokens

### Subtask 1.5: Update company switching sync comment
**File**: `/home/pbrown/SkuInventory/src/lib/auth.ts`
**Lines**: 206-208
**Pattern**: Update comment to reflect current state

**Instructions**:
1. Update comment from "backward compatibility" to explain the sync purpose

**Code Change**:
```typescript
// BEFORE (lines 206-208):
// Keep companyId in sync for backward compatibility
token.companyId = session.selectedCompanyId
token.companyName = session.selectedCompanyName

// AFTER:
// Keep companyId synced with selectedCompanyId for session consistency
token.companyId = session.selectedCompanyId
token.companyName = session.selectedCompanyName
```

**Completion Criteria**:
- [ ] Comment updated to remove "backward compatibility" reference
- [ ] Sync behavior preserved

## Phase 2: Update API Routes Using session.user.companyId

### Subtask 2.1: Update transactions/[id]/route.ts
**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/[id]/route.ts`
**Line**: 22
**Pattern**: Follow other transaction routes using selectedCompanyId

**Instructions**:
1. Change `session.user.companyId` to `session.user.selectedCompanyId`

**Code Change**:
```typescript
// BEFORE (line 22):
companyId: session.user.companyId,

// AFTER:
companyId: session.user.selectedCompanyId,
```

**Completion Criteria**:
- [ ] Uses selectedCompanyId for company scoping

### Subtask 2.2: Update chatbot/route.ts
**File**: `/home/pbrown/SkuInventory/src/app/api/chatbot/route.ts`
**Line**: 32
**Pattern**: Use selectedCompanyId for context

**Instructions**:
1. Change `session.user.companyId` to `session.user.selectedCompanyId`

**Code Change**:
```typescript
// BEFORE (line 32):
const companyId = session.user.companyId

// AFTER:
const companyId = session.user.selectedCompanyId
```

**Completion Criteria**:
- [ ] Chatbot uses selectedCompanyId for context

### Subtask 2.3: Update alerts/defects/route.ts
**File**: `/home/pbrown/SkuInventory/src/app/api/alerts/defects/route.ts`
**Lines**: 38, 46, 70
**Pattern**: Use selectedCompanyId for alerts

**Instructions**:
1. Change all 3 occurrences of `session.user.companyId` to `session.user.selectedCompanyId`

**Code Change**:
```typescript
// Line 38: const thresholds = await getDefectThresholds(session.user.selectedCompanyId)
// Line 46: const alerts = await getDefectAlerts(session.user.selectedCompanyId, queryResult.data)
// Line 70: session.user.selectedCompanyId,
```

**Completion Criteria**:
- [ ] All 3 occurrences updated to selectedCompanyId

### Subtask 2.4: Update analytics/defects/route.ts
**File**: `/home/pbrown/SkuInventory/src/app/api/analytics/defects/route.ts`
**Lines**: 32, 50, 51, 65
**Pattern**: Use selectedCompanyId for analytics

**Instructions**:
1. Change all 4 occurrences of `session.user.companyId` to `session.user.selectedCompanyId`

**Code Change**:
```typescript
// Line 32: const csv = await generateDefectAnalyticsExport(session.user.selectedCompanyId, queryResult.data)
// Line 50: getSKUsWithBuilds(session.user.selectedCompanyId),
// Line 51: getBOMVersionsForFilter(session.user.selectedCompanyId, skuId),
// Line 65: const analytics = await getDefectAnalytics(session.user.selectedCompanyId, queryResult.data)
```

**Completion Criteria**:
- [ ] All 4 occurrences updated to selectedCompanyId

### Subtask 2.5: Update export/transactions/route.ts
**File**: `/home/pbrown/SkuInventory/src/app/api/export/transactions/route.ts`
**Lines**: 29-47
**Pattern**: Use session.user.selectedCompanyId directly instead of database lookup

**Instructions**:
1. Remove unnecessary database lookup for user.companyId
2. Use session.user.selectedCompanyId directly

**Code Change**:
```typescript
// BEFORE (lines 28-47):
// Get user's company
const user = await prisma.user.findUnique({
  where: { id: session.user.id },
  select: { companyId: true },
})

if (!user) {
  // Return empty CSV
  const csv = toCSV([], transactionExportColumns)
  return new NextResponse(csv, {
    headers: {
      'Content-Type': 'text/csv',
      'Content-Disposition': `attachment; filename="${generateExportFilename('transactions')}"`,
    },
  })
}

// Build where clause
const where: Prisma.TransactionWhereInput = {
  companyId: user.companyId,
}

// AFTER:
// Get selected company from session
const selectedCompanyId = session.user.selectedCompanyId
if (!selectedCompanyId) {
  // Return empty CSV if no company selected
  const csv = toCSV([], transactionExportColumns)
  return new NextResponse(csv, {
    headers: {
      'Content-Type': 'text/csv',
      'Content-Disposition': `attachment; filename="${generateExportFilename('transactions')}"`,
    },
  })
}

// Build where clause
const where: Prisma.TransactionWhereInput = {
  companyId: selectedCompanyId,
}
```

**Completion Criteria**:
- [ ] Database lookup removed
- [ ] Uses selectedCompanyId from session
- [ ] Appropriate handling if selectedCompanyId missing

### Subtask 2.6: Update users/[id]/companies/route.ts backward compat code
**File**: `/home/pbrown/SkuInventory/src/app/api/users/[id]/companies/route.ts`
**Line**: 167-171
**Pattern**: Keep User.companyId sync but update comment

**Instructions**:
1. Update comment from "backward compatibility" to explain it's Phase 3 work to remove

**Code Change**:
```typescript
// BEFORE (line 167):
// Keep User.companyId in sync (backward compatibility)
await tx.user.update({
  where: { id },
  data: { companyId: newPrimaryCompanyId },
})

// AFTER:
// Keep User.companyId in sync with isPrimary UserCompany
// TODO: Remove in Phase 3 when User.companyId column is dropped
await tx.user.update({
  where: { id },
  data: { companyId: newPrimaryCompanyId },
})
```

**Completion Criteria**:
- [ ] Comment updated with TODO for Phase 3
- [ ] Sync behavior preserved for now

## Phase 3: Update Types and Comments

### Subtask 3.1: Update SessionUser type comment
**File**: `/home/pbrown/SkuInventory/src/types/index.ts`
**Line**: 92
**Pattern**: Update comment to reflect current state

**Instructions**:
1. Update the comment on companyId field

**Code Change**:
```typescript
// BEFORE (line 92):
companyId: string  // Selected company ID (for backward compatibility)

// AFTER:
companyId: string  // Synced with selectedCompanyId (will be removed in Phase 3)
```

**Completion Criteria**:
- [ ] Comment updated with Phase 3 TODO

## Phase 4: Verify and Test

### Subtask 4.1: Run TypeScript check
**Instructions**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] No TypeScript errors

### Subtask 4.2: Run build
**Instructions**:
```bash
npm run build
```

**Completion Criteria**:
- [ ] Build succeeds without errors

### Subtask 4.3: Run auth-related tests
**Instructions**:
```bash
npm test -- --filter="auth"
```

**Completion Criteria**:
- [ ] All auth tests pass (may need minor updates to test files)

### Subtask 4.4: Run full test suite
**Instructions**:
```bash
npm test
```

**Completion Criteria**:
- [ ] All tests pass

---

## Summary of Deliverables

**Files Created**: 0

**Files Modified**: 9
1. `src/lib/auth.ts` - Remove backward compatibility code, use UserCompany.isPrimary
2. `src/app/api/transactions/[id]/route.ts` - Use selectedCompanyId
3. `src/app/api/chatbot/route.ts` - Use selectedCompanyId
4. `src/app/api/alerts/defects/route.ts` - Use selectedCompanyId (3 places)
5. `src/app/api/analytics/defects/route.ts` - Use selectedCompanyId (4 places)
6. `src/app/api/export/transactions/route.ts` - Remove DB lookup, use selectedCompanyId
7. `src/app/api/users/[id]/companies/route.ts` - Update comment for Phase 3
8. `src/types/index.ts` - Update comment on companyId
9. `tests/helpers/auth-mock.ts` - May need session structure updates (verify after code changes)

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 -> Phase 2 -> Phase 3 -> Phase 4)
2. Complete each subtask fully before moving to the next
3. Test after each phase to catch issues early
4. Follow reference patterns exactly
5. **Important**: The users/[id]/route.ts file uses companyId for tenant scoping (ensuring admin only manages users in their company). This is intentional and should NOT be changed - those queries check if the target user belongs to the admin's primary company.

## Test Strategy Note

- Use Vitest for unit tests: `npm test`
- Auth-related tests: `npm test -- --filter="auth"`
- Build verification: `npm run build && npx tsc --noEmit`

## Performance Metrics

| Phase | Duration |
|-------|----------|
| Investigation | 25m |
| Validation | 10m |
| Planning | 15m |
| **Total** | **50m** |

## Risk Mitigation

1. **Stale JWT Tokens**: Users with old tokens (before Phase 1) may need to re-login. This is acceptable as Phase 1 ensured all users have proper UserCompany records.

2. **Testing**: Run full test suite after changes. Auth tests specifically validate session handling.

3. **Rollback**: If issues arise, the backward compatibility code can be temporarily restored.
