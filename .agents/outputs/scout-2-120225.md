# Scout Report: Lock down tenant scoping across components/SKUs/BOM/transactions APIs

## Request Analysis
**Type**: Bug (Security Vulnerability)
**Source**: GitHub Issue #2
**Priority**: Critical
**Severity**: High - Cross-tenant data leakage and unauthorized writes possible

## Task Classification
**Category**: BUG_FIX (Security)
**Test Strategy**: FULL
**Suggested Filter**: None (requires comprehensive testing across all affected routes)

## Issue Validation
**Status**: ✅ Valid - This is a critical security issue
**Recent Changes**: No recent commits address this issue
**Affects**: All tenant-scoped API routes for components, SKUs, BOM versions, and transactions

## Current State

### Multi-Tenancy Architecture
The application uses a three-tier tenant hierarchy:
1. **Company** (top-level tenant)
2. **Brand** (belongs to Company, scoped resource owner)
3. **User** (belongs to Company, has role)

**Data Model Relationships**:
- `Component` -> `Brand` -> `Company`
- `SKU` -> `Brand` -> `Company`
- `BOMVersion` -> `SKU` -> `Brand` -> `Company`
- `Transaction` -> `Company` (direct relationship)

**Session Data Available**:
- `session.user.id` - User ID
- `session.user.companyId` - Company ID (tenant identifier)
- `session.user.role` - User role (admin/ops/viewer)

### Vulnerability Assessment

#### ✅ SECURE Routes (Already Properly Scoped):
1. **List Routes** (properly scoped):
   - `GET /api/components` - Filters by brandId from user's company
   - `GET /api/skus` - Filters by brandId from user's company
   - `GET /api/transactions` - Filters by `companyId: session.user.companyId`

2. **Creation Routes with Pre-Validation**:
   - `POST /api/transactions/receipt` - Validates component belongs to company (lines 28-39)
   - `POST /api/transactions/adjustment` - Validates component belongs to company (lines 28-39)

#### ❌ VULNERABLE Routes (Missing Tenant Validation):

**Components API** (`/home/pbrown/SkuInventory/src/app/api/components/[id]/route.ts`):
- ❌ Line 34-64: `GET /api/components/:id` - No brandId/companyId check
- ❌ Line 150-156: `PATCH /api/components/:id` - No brandId/companyId check
- ❌ Line 236-243: `DELETE /api/components/:id` - No brandId/companyId check

**SKUs API** (`/home/pbrown/SkuInventory/src/app/api/skus/[id]/route.ts`):
- ❌ Line 29-53: `GET /api/skus/:id` - No brandId/companyId check
- ❌ Line 130-136: `PATCH /api/skus/:id` - No brandId/companyId check
- ❌ Line 220-226: `DELETE /api/skus/:id` - No brandId/companyId check

**SKU BOM Versions API** (`/home/pbrown/SkuInventory/src/app/api/skus/[id]/bom-versions/route.ts`):
- ❌ Line 36-42: `GET /api/skus/:id/bom-versions` - No SKU ownership check
- ❌ Line 135-141: `POST /api/skus/:id/bom-versions` - No SKU ownership check

**BOM Versions API** (`/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/route.ts`):
- ❌ Line 25-50: `GET /api/bom-versions/:id` - No ownership check

**BOM Activate API** (`/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/activate/route.ts`):
- ❌ Line 24: `POST /api/bom-versions/:id/activate` - Calls service without ownership check

**BOM Clone API** (`/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/clone/route.ts`):
- ❌ Line 31-35: `POST /api/bom-versions/:id/clone` - Calls service without ownership check

**Transactions Build API**:
- ⚠️ Route does NOT exist yet (`/home/pbrown/SkuInventory/src/app/api/transactions/build/route.ts`)
- However, `createBuildTransaction` service exists in `/home/pbrown/SkuInventory/src/services/inventory.ts` (lines 311-432)
- If route is added later, it MUST include tenant validation

## Dependencies & Blockers

**None - Can Proceed: YES**

All necessary infrastructure exists:
- ✅ Session management with `companyId` available
- ✅ Prisma schema has proper relationships
- ✅ Auth middleware properly configured
- ✅ Examples of proper tenant scoping in list routes

## Complexity Assessment
**Complexity**: Moderate
**Effort**: 6-8 hours
**Risk**: Medium (security fix, must be comprehensive)

**Breakdown**:
- 7 existing API routes need validation added (3-4 hours)
- Service layer functions need safety checks (1-2 hours)
- Comprehensive regression tests for all routes (2-3 hours)
- Manual penetration testing (1 hour)

## Patterns to Follow

**Primary Pattern**: `/home/pbrown/SkuInventory/src/app/api/transactions/receipt/route.ts` (lines 27-39)
```typescript
// Verify component exists and belongs to user's company
const component = await prisma.component.findFirst({
  where: {
    id: data.componentId,
    brand: {
      company: { id: session.user.companyId },
    },
  },
})

if (!component) {
  return notFound('Component')
}
```

**Secondary Pattern**: `/home/pbrown/SkuInventory/src/app/api/components/route.ts` (lines 35-44)
```typescript
// Get user's brand for tenant scoping
const user = await prisma.user.findUnique({
  where: { id: session.user.id },
  include: { company: { include: { brands: { where: { isActive: true }, take: 1 } } } },
})

if (!user?.company.brands[0]) {
  return success([])
}

const brandId = user.company.brands[0].id
```

**Return 404 vs 403**: Use 404 to avoid leaking information about resource existence across tenants.

## Files to Create/Modify

### API Routes to Modify (7 files):

1. **`/home/pbrown/SkuInventory/src/app/api/components/[id]/route.ts`**
   - Add tenant check to GET (after line 32)
   - Add tenant check to PATCH (after line 142, reuse existing fetch)
   - Add tenant check to DELETE (after line 233, reuse existing fetch)

2. **`/home/pbrown/SkuInventory/src/app/api/skus/[id]/route.ts`**
   - Add tenant check to GET (after line 27)
   - Add tenant check to PATCH (after line 122, reuse existing fetch)
   - Add tenant check to DELETE (after line 217, reuse existing fetch)

3. **`/home/pbrown/SkuInventory/src/app/api/skus/[id]/bom-versions/route.ts`**
   - Add SKU ownership check to GET (after line 28)
   - Add SKU ownership check to POST (after line 127)

4. **`/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/route.ts`**
   - Add BOM version ownership check to GET (after line 23)

5. **`/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/activate/route.ts`**
   - Add BOM version ownership check before calling service (after line 22)

6. **`/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/clone/route.ts`**
   - Add BOM version ownership check before calling service (after line 24)

### Service Layer Safety Checks (3 files):

7. **`/home/pbrown/SkuInventory/src/services/bom.ts`**
   - `activateBOMVersion()` (line 303) - Add defensive check (optional, API should validate)
   - `cloneBOMVersion()` (line 241) - Add defensive check (optional, API should validate)

8. **`/home/pbrown/SkuInventory/src/services/inventory.ts`**
   - `createBuildTransaction()` (line 311) - Document that caller must validate

### Tests to Create (2-3 files):

9. **`/home/pbrown/SkuInventory/tests/e2e/tenant-scoping.spec.ts`** (NEW)
   - Test cross-tenant access blocked for all routes
   - Test that 404 is returned (not 403) for unauthorized access

10. **`/home/pbrown/SkuInventory/tests/unit/api-security.test.ts`** (NEW)
   - Unit tests for tenant validation logic

## Final Sweep Results

**API Routes Search**: 7 routes confirmed vulnerable
**Service Layer**: 3 service functions called by vulnerable routes
**Type Definitions**: No type changes needed
**Components**: No frontend components need updating
**Test Files**: 2 new test files needed

**All Affected Files** (comprehensive list):

### Direct Impact (Must Fix):
1. `/home/pbrown/SkuInventory/src/app/api/components/[id]/route.ts` - 3 vulnerable endpoints
2. `/home/pbrown/SkuInventory/src/app/api/skus/[id]/route.ts` - 3 vulnerable endpoints
3. `/home/pbrown/SkuInventory/src/app/api/skus/[id]/bom-versions/route.ts` - 2 vulnerable endpoints
4. `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/route.ts` - 1 vulnerable endpoint
5. `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/activate/route.ts` - 1 vulnerable endpoint
6. `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/clone/route.ts` - 1 vulnerable endpoint

### Indirect Impact (Service Layer - Optional Hardening):
7. `/home/pbrown/SkuInventory/src/services/bom.ts` - Called by vulnerable routes
8. `/home/pbrown/SkuInventory/src/services/inventory.ts` - `createBuildTransaction` needs docs

### Testing Requirements:
9. `/home/pbrown/SkuInventory/tests/e2e/tenant-scoping.spec.ts` - NEW
10. `/home/pbrown/SkuInventory/tests/unit/api-security.test.ts` - NEW (optional)

**TOTAL FILES AFFECTED: 10 files (6 critical, 2 optional hardening, 2 test)**

## Ripple Effect Analysis

### Function Call Chain Analysis:

**activateBOMVersion** (src/services/bom.ts:303):
- Direct Callers: 1 file
  - `src/app/api/bom-versions/[id]/activate/route.ts:24`
- Indirect Callers: None
- **TOTAL FILES: 1**

**cloneBOMVersion** (src/services/bom.ts:241):
- Direct Callers: 1 file
  - `src/app/api/bom-versions/[id]/clone/route.ts:31`
- Indirect Callers: None
- **TOTAL FILES: 1**

**createBOMVersion** (src/services/bom.ts:167):
- Direct Callers: 1 file
  - `src/app/api/skus/[id]/bom-versions/route.ts:157`
- Indirect Callers: None
- **TOTAL FILES: 1**

**createBuildTransaction** (src/services/inventory.ts:311):
- Direct Callers: 0 files (NO API ROUTE YET)
- **Risk**: If build route is added without tenant checks, vulnerability will be introduced
- **Recommendation**: Add comment in service function warning about tenant validation

### Database Query Patterns:
All vulnerable routes use `prisma.*.findUnique({ where: { id } })` without additional tenant filters.

**Fix Pattern** for Components/SKUs:
```typescript
const record = await prisma.component.findFirst({
  where: {
    id,
    brand: {
      companyId: session.user.companyId
    }
  }
})
```

**Fix Pattern** for BOMVersions:
```typescript
const bomVersion = await prisma.bOMVersion.findFirst({
  where: {
    id,
    sku: {
      brand: {
        companyId: session.user.companyId
      }
    }
  },
  include: { /* existing includes */ }
})
```

## Acceptance Criteria

- [ ] All 6 vulnerable API routes validate tenant ownership
- [ ] Cross-tenant access attempts return 404 (not 403 or 200)
- [ ] Existing functionality preserved for valid same-tenant requests
- [ ] Service functions document caller responsibility for tenant checks
- [ ] Regression tests cover all affected routes
- [ ] Tests verify cross-tenant attacks are blocked
- [ ] Build completes without errors or warnings
- [ ] Manual penetration test confirms vulnerability is fixed

## Attack Scenarios (For Testing)

**Scenario 1**: User from Company A tries to read Component from Company B
- Request: `GET /api/components/{company-b-component-id}`
- Expected: 404 Not Found
- Current: 200 OK with full component data ⚠️

**Scenario 2**: User from Company A tries to update SKU from Company B
- Request: `PATCH /api/skus/{company-b-sku-id}`
- Expected: 404 Not Found
- Current: 200 OK with updated data ⚠️

**Scenario 3**: User from Company A tries to activate BOM version for Company B's SKU
- Request: `POST /api/bom-versions/{company-b-bom-id}/activate`
- Expected: 404 Not Found
- Current: 200 OK, deactivates Company B's active BOM ⚠️

**Scenario 4**: User from Company A tries to clone BOM version from Company B
- Request: `POST /api/bom-versions/{company-b-bom-id}/clone`
- Expected: 404 Not Found
- Current: 201 Created, clones into Company A's context ⚠️

## Security Impact

**Data Leakage Risk**: HIGH
- Attackers can enumerate IDs and read all tenant data
- Component costs, SKU details, BOM formulas visible across tenants

**Data Integrity Risk**: HIGH
- Attackers can modify/deactivate other tenants' resources
- Can activate wrong BOM versions, causing inventory/cost miscalculations
- Can deactivate components/SKUs used by other tenants

**Business Impact**: CRITICAL
- Multi-tenant architecture is fundamentally broken
- Complete data isolation failure
- Regulatory compliance issues (SOC2, GDPR)

## Handoff to Plan Agent

**Summary**:
Issue #2 identifies a critical multi-tenant security vulnerability affecting 6 API routes. Components, SKUs, and BOM versions can be read and modified across tenant boundaries because routes trust ID parameters without validating that the resource belongs to the requesting user's company. The fix requires adding tenant ownership checks using the existing `session.user.companyId` before performing any operations. Two transaction creation routes already implement the correct pattern and should be used as reference. Service layer functions are not the primary issue but should be documented. Comprehensive testing is required to verify all attack vectors are closed.

**Key Points**:
1. **Scope**: 6 API route files need modification (3 operations × 2 resources + 2 BOM operations)
2. **Pattern**: Use `prisma.*.findFirst()` with nested brand/company filters instead of `findUnique()`
3. **Response**: Return 404 (not 403) to avoid information leakage
4. **Reference**: Receipt/adjustment transaction routes show correct implementation
5. **Testing**: Full test strategy needed - this is a security fix affecting critical paths
6. **No Blockers**: All infrastructure exists, straightforward fix with good examples

**Suggested Phases**:
1. **Phase 1**: Fix Component routes (GET/PATCH/DELETE)
2. **Phase 2**: Fix SKU routes (GET/PATCH/DELETE)
3. **Phase 3**: Fix BOM routes (GET, BOM list, activate, clone)
4. **Phase 4**: Add service layer defensive checks (optional but recommended)
5. **Phase 5**: Create comprehensive test suite
6. **Phase 6**: Manual penetration testing and verification

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Issue Parsing | 2m |
| Codebase Exploration | 8m |
| Pattern Identification | 5m |
| Security Analysis | 4m |
| Ripple Effect Tracing | 3m |
| Report Writing | 8m |
| **Total** | **30m** |

---

**AGENT_RETURN: scout-2-120225**
