# Implementation Plan
**Generated**: 2025-12-09T12:09:25
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: Issue #224
**Estimated Build Time**: 5-6 hours
**Complexity**: Medium

## Investigation Summary

### Request Analysis
**Type**: Refactoring
**Source**: GitHub Issue #224
**Priority**: Medium
**Parent Issues**: #214 (Phase 1 - complete), #223 (Phase 2 - CLOSED/complete)

### Task Classification
**Category**: REFACTORING
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="user|auth|company"` for unit tests, full E2E suite required

### Issue Validation
**Status**: Valid - Prerequisites complete
**Recent Changes**:
- `9c8658b` refactor(issue #223): use UserCompany exclusively in auth.ts (Phase 2)
- `a79df87` feat(issue #214): Phase 1 - add isPrimary to UserCompany

### Current State Assessment

#### Schema (prisma/schema.prisma lines 103-139)
User model currently has:
- `companyId String` (line 105) - **TO BE REMOVED**
- `company Company @relation(...)` (line 106) - **TO BE REMOVED**
- `@@index([companyId, isActive])` (line 138) - **TO BE REMOVED**

Company model currently has:
- `users User[]` (line 22) - **TO BE REMOVED**

UserCompany model (lines 141-155):
- Fully set up with `isPrimary` flag (Phase 1 complete)
- Already used as source of truth (Phase 2 complete)

#### Code References to Remove/Update

**Files using `user.companyId` (database column):**
1. `src/lib/auth.ts` (lines 75, 92, 126, 144) - Uses `user.companyId` from Prisma query
2. `src/app/api/companies/switch/route.ts` (lines 48-54) - Includes `company` relation, checks `user?.companyId`
3. `src/app/api/users/[id]/companies/route.ts` (lines 159, 167-171) - Uses `user.companyId` for role logic, sync code

**Files using `session.user.companyId` (session property):**
- `src/lib/auth.ts` (line 233) - Sets session.user.companyId
- `src/app/api/users/[id]/route.ts` (lines 29, 116, 133, 227) - Uses for user scoping
- `src/app/api/users/[id]/companies/route.ts` (lines 30, 106) - Uses for user scoping

**Note**: `session.user.companyId` is KEPT because it's the session property that tracks the current company. Only the database column is removed.

**Files using `_count.users` or `users` relation:**
1. `src/app/api/companies/[id]/route.ts` (lines 305, 331, 341) - DELETE operation uses `_count.users`

**Test files needing updates:**
1. `tests/helpers/auth-mock.ts` (lines 38, 99, 112, 125) - `companyId` in TestUserSession interface
2. `tests/helpers/integration-context.ts` (lines 121, 167) - Uses `where: { companyId }` on User queries

**Seed file:**
- `prisma/seed.ts` (lines 64, 79, 94) - Creates users with `companyId` field

### Dependencies & Blockers
1. Phase 2 (#223) must be complete - **VERIFIED CLOSED**
2. Migration must handle existing data - All users already have UserCompany records (Phase 1 ensured this)

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Medium
**Effort**: 5-6 hours
**Risk**: Medium - Schema migration, requires careful testing

### Patterns Identified
**Primary**: `prisma/migrations/20251208210123_add_feedback_tables/` - Recent migration pattern
**Secondary**: UserCompany queries throughout auth.ts - Pattern for company access

### Ripple Effect Analysis
**Files Identified**: 12

| File | Change Type | Reason |
|------|-------------|--------|
| `prisma/schema.prisma` | Schema change | Remove column and relations |
| `prisma/seed.ts` | Update | Remove companyId from user creation |
| `src/lib/auth.ts` | Update | Stop using user.companyId from DB, derive from UserCompany |
| `src/app/api/companies/switch/route.ts` | Update | Remove include { company }, remove user?.companyId check |
| `src/app/api/companies/[id]/route.ts` | Update | Replace `_count.users` with `_count.userCompanies` |
| `src/app/api/users/route.ts` | Update | Change scoping from `companyId` to UserCompany-based |
| `src/app/api/users/[id]/route.ts` | Update | Change scoping from `user.companyId` to UserCompany-based |
| `src/app/api/users/[id]/companies/route.ts` | Update | Remove sync code, update role logic |
| `tests/helpers/auth-mock.ts` | Update | Keep `companyId` in interface (session property) |
| `tests/helpers/integration-context.ts` | Update | Use UserCompany for user lookups |
| `tests/integration/tenant-scoping.test.ts` | Verify | May need updates for scoping |
| New migration file | Create | Drop column migration |

---

## Executive Summary
Remove the `User.companyId` direct foreign key column and `Company.users` relation from the Prisma schema, completing the consolidation to UserCompany as the single source of truth for user-company membership. Update all code that references these removed fields to use UserCompany instead. Create a Prisma migration to drop the column.

---

## Phase 0: Pre-Migration Verification (Optional but Recommended)

### Subtask 0.1: Verify All Users Have UserCompany Records
**File**: N/A (verification only)
**Instructions**:
1. Run query to verify no users exist without UserCompany records:
```bash
docker exec inventory-db-test psql -U inventory_test -d inventory_test -c "
SELECT u.id, u.email, u.companyId
FROM \"User\" u
LEFT JOIN \"UserCompany\" uc ON u.id = uc.\"userId\" AND u.\"companyId\" = uc.\"companyId\"
WHERE uc.id IS NULL;"
```
2. Expected result: 0 rows (all users have matching UserCompany records)
3. If any users found, Phase 1 migration must have failed - investigate before proceeding

**Completion Criteria**:
- [ ] Query returns 0 rows
- [ ] All users have corresponding UserCompany records

---

## Phase 1: Update Application Code (Before Migration)

### Subtask 1.1: Update auth.ts - Remove user.companyId from DB Access
**File**: `/home/pbrown/SkuInventory/src/lib/auth.ts`
**Pattern**: Already uses UserCompany for companies list
**Instructions**:
1. Line 27-39: Remove `company: true` from the include (keep `userCompanies`)
2. Lines 73-80: Change `companyId: user.companyId` to derive from primary UserCompany:
```typescript
// Get primary company ID from UserCompany
const primaryUC = user.userCompanies.find(uc => uc.isPrimary) || user.userCompanies[0]
const primaryCompanyId = primaryUC?.company.id ?? ''
// Then use primaryCompanyId instead of user.companyId
```
3. Lines 89-97: Same change for login security event
4. Lines 121-135: Update to build from UserCompany:
   - Line 126: Change `companyId: user.companyId` to `companyId: selectedCompanyId`
   - Line 127: Change `user.company.name` to `selectedCompanyName` (already computed)

**Validation Commands**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] No references to `user.companyId` in authorize function
- [ ] No reference to `user.company` relation
- [ ] TypeScript compiles without errors

### Subtask 1.2: Update companies/switch/route.ts - Remove Redundant Check
**File**: `/home/pbrown/SkuInventory/src/app/api/companies/switch/route.ts`
**Pattern**: UserCompany check is already done
**Instructions**:
1. Lines 47-54: Remove the entire block that fetches user with company include
2. Line 53: Remove the `user?.companyId === companyId` check
3. Simplify: The `userCompany` variable already confirms access - no need to double-check
4. Line 54: Get company from `userCompany.company` only

Updated code (lines 47-58 become):
```typescript
// UserCompany check is sufficient - userCompany already has company data
if (!userCompany) {
  return forbidden('You do not have access to this company')
}

const company = userCompany.company
```

**Validation Commands**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] No `include: { company }` on User model
- [ ] No `user?.companyId` check
- [ ] TypeScript compiles without errors

### Subtask 1.3: Update companies/[id]/route.ts - Replace _count.users
**File**: `/home/pbrown/SkuInventory/src/app/api/companies/[id]/route.ts`
**Pattern**: Already uses `_count.userCompanies` in GET/PATCH
**Instructions**:
1. Lines 303-313 (DELETE function): Change `_count` select:
   - Remove `users: true` from _count select
   - Already has `userCompanies: true` - this becomes the user count
2. Lines 330-341: Update the counting logic:
   - Remove `existingCompany._count.users` from totalCount
   - Change `_count.users > 0` check to use `_count.userCompanies`
   - Update the error message

Updated code for DELETE _count (lines 302-313):
```typescript
_count: {
  select: {
    userCompanies: true,
    brands: true,
    locations: true,
    transactions: true,
    components: true,
    skus: true,
  },
},
```

Updated counting (lines 329-344):
```typescript
const totalCount =
  existingCompany._count.userCompanies +
  existingCompany._count.brands +
  existingCompany._count.locations +
  existingCompany._count.transactions +
  existingCompany._count.components +
  existingCompany._count.skus

if (totalCount > 0) {
  const details = []
  if (existingCompany._count.userCompanies > 0) details.push(`${existingCompany._count.userCompanies} users`)
  if (existingCompany._count.brands > 0) details.push(`${existingCompany._count.brands} brands`)
  // ... rest unchanged
```

**Validation Commands**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] No `users: true` in _count select
- [ ] Uses `_count.userCompanies` for user counting
- [ ] TypeScript compiles without errors

### Subtask 1.4: Update users/route.ts - Change Scoping Query
**File**: `/home/pbrown/SkuInventory/src/app/api/users/route.ts`
**Pattern**: Use UserCompany join for scoping
**Instructions**:
1. Lines 45-47 (GET): Change the where clause to scope by UserCompany:
```typescript
const where: Prisma.UserWhereInput = {
  userCompanies: {
    some: {
      companyId: selectedCompanyId,
    },
  },
}
```

2. Lines 179-186 (POST): Remove `companyId: selectedCompanyId` from user.create data:
```typescript
const newUser = await tx.user.create({
  data: {
    email,
    passwordHash,
    name,
    role,
  },
  // ... select unchanged
})
```

3. The UserCompany creation at lines 199-207 remains unchanged (this is now the only company assignment)

**Validation Commands**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] GET scopes users by UserCompany.companyId
- [ ] POST does not set User.companyId
- [ ] TypeScript compiles without errors

### Subtask 1.5: Update users/[id]/route.ts - Change User Lookup Scoping
**File**: `/home/pbrown/SkuInventory/src/app/api/users/[id]/route.ts`
**Pattern**: Use UserCompany for ownership check
**Instructions**:
1. Lines 26-30 (GET): Change the where clause:
```typescript
const user = await prisma.user.findFirst({
  where: {
    id,
    userCompanies: {
      some: {
        companyId: session.user.companyId,
      },
    },
  },
  // ... select unchanged
})
```
Note: Change from `findUnique` to `findFirst` because the composite filter isn't a unique index.

2. Lines 113-118 (PATCH): Same change for existingUser lookup
3. Lines 131-136 (PATCH): Change admin count query:
```typescript
const adminCount = await prisma.user.count({
  where: {
    userCompanies: {
      some: {
        companyId: session.user.companyId,
      },
    },
    role: 'admin',
    isActive: true,
  },
})
```

4. Lines 224-229 (DELETE): Same change for existingUser lookup

**Validation Commands**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] All user lookups use UserCompany for scoping
- [ ] Changed from `findUnique` to `findFirst` where needed
- [ ] TypeScript compiles without errors

### Subtask 1.6: Update users/[id]/companies/route.ts - Remove Sync Code
**File**: `/home/pbrown/SkuInventory/src/app/api/users/[id]/companies/route.ts`
**Pattern**: UserCompany is now the only source
**Instructions**:
1. Lines 27-32 (GET): Change the where clause:
```typescript
const user = await prisma.user.findFirst({
  where: {
    id,
    userCompanies: {
      some: {
        companyId: session.user.companyId,
      },
    },
  },
  // ... select unchanged, but remove companyId from select if present
})
```

2. Lines 103-112 (PUT): Change the where clause similarly:
```typescript
const user = await prisma.user.findFirst({
  where: {
    id,
    userCompanies: {
      some: {
        companyId: session.user.companyId,
      },
    },
  },
  select: {
    id: true,
    // Remove: companyId: true,
  },
})
```

3. Lines 155-161: Update role assignment logic (can't use `user.companyId`):
```typescript
// Get user's primary company to determine role
const primaryUC = await tx.userCompany.findFirst({
  where: { userId: id, isPrimary: true },
})
const userPrimaryCompanyId = primaryUC?.companyId

const userCompanyRecords = companyIds.map((companyId) => ({
  userId: id,
  companyId,
  role: userPrimaryCompanyId === companyId ? UserRole.admin : UserRole.ops,
  isPrimary: companyId === newPrimaryCompanyId,
}))
```

4. Lines 167-172: **REMOVE** the entire sync block that updates User.companyId:
```typescript
// REMOVE THIS ENTIRE BLOCK:
// Keep User.companyId in sync with isPrimary UserCompany
// TODO: Remove in Phase 3 when User.companyId column is dropped
// await tx.user.update({
//   where: { id },
//   data: { companyId: newPrimaryCompanyId },
// })
```

**Validation Commands**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] No `user.companyId` references
- [ ] Sync code block removed
- [ ] Role logic updated to query UserCompany instead
- [ ] TypeScript compiles without errors

---

## Phase 2: Update Test Files

### Subtask 2.1: Update tests/helpers/integration-context.ts
**File**: `/home/pbrown/SkuInventory/tests/helpers/integration-context.ts`
**Instructions**:
1. Lines 120-122: Change admin user lookup:
```typescript
const admin = await db.user.findFirst({
  where: {
    userCompanies: {
      some: { companyId },
    },
    role: 'admin',
  },
})
```

2. Lines 165-168: Same change for SKU creation admin lookup

3. Lines 197-199: Same change for receipt creation admin lookup

**Validation Commands**:
```bash
npm test -- --filter="integration"
```

**Completion Criteria**:
- [ ] No `where: { companyId }` on User model
- [ ] Tests compile without errors

### Subtask 2.2: Update tests/helpers/auth-mock.ts
**File**: `/home/pbrown/SkuInventory/tests/helpers/auth-mock.ts`
**Instructions**:
The `TestUserSession` interface (lines 32-42) has `companyId` - this is the SESSION property, NOT the database column. **KEEP IT AS-IS**.

The session property `companyId` tracks the currently selected company and is derived from UserCompany.isPrimary at login time. It is NOT the database column.

**No changes needed** - the interface correctly reflects the session structure which retains companyId.

**Validation Commands**:
```bash
npm test -- --filter="auth"
```

**Completion Criteria**:
- [ ] TestUserSession interface unchanged (companyId is session property)
- [ ] Test mocks still work correctly

---

## Phase 3: Update Seed File

### Subtask 3.1: Update prisma/seed.ts - Add UserCompany Records
**File**: `/home/pbrown/SkuInventory/prisma/seed.ts`
**Instructions**:
1. Lines 60-70: Update admin user creation to not include companyId, add UserCompany:
```typescript
const admin = await prisma.user.upsert({
  where: { email: 'admin@tonsil.tech' },
  update: {},
  create: {
    email: 'admin@tonsil.tech',
    passwordHash: adminPassword,
    name: 'Admin User',
    role: 'admin',
  },
})

// Create UserCompany for admin
await prisma.userCompany.upsert({
  where: {
    userId_companyId: {
      userId: admin.id,
      companyId: company.id,
    },
  },
  update: {},
  create: {
    userId: admin.id,
    companyId: company.id,
    role: 'admin',
    isPrimary: true,
  },
})
console.log('Created admin user:', admin.email)
```

2. Same pattern for ops user (lines 74-86)
3. Same pattern for viewer user (lines 89-101)

**Validation Commands**:
```bash
# Test seed runs without errors (on test DB)
DATABASE_URL="postgresql://inventory_test:inventory_test_2025@localhost:2346/inventory_test" npx prisma db seed
```

**Completion Criteria**:
- [ ] No `companyId` in user.create data
- [ ] UserCompany records created for each user
- [ ] Seed runs successfully

---

## Phase 4: Schema Migration

### Subtask 4.1: Update Prisma Schema
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Instructions**:
1. Lines 103-139: Update User model - remove:
   - Line 105: `companyId    String`
   - Line 106: `company      Company   @relation(fields: [companyId], references: [id])`
   - Line 138: `@@index([companyId, isActive])`

2. Lines 13-38: Update Company model - remove:
   - Line 22: `users            User[]`

**Updated User model (lines 103-138):**
```prisma
model User {
  id           String    @id @default(uuid())
  email        String    @unique @db.VarChar(255)
  passwordHash String    @db.VarChar(255)
  name         String    @db.VarChar(100)
  role         UserRole  @default(ops)
  isActive     Boolean   @default(true)
  lastLoginAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Audit relations
  componentsCreated Component[]     @relation("ComponentCreatedBy")
  componentsUpdated Component[]     @relation("ComponentUpdatedBy")
  skusCreated       SKU[]           @relation("SKUCreatedBy")
  skusUpdated       SKU[]           @relation("SKUUpdatedBy")
  bomVersions       BOMVersion[]
  transactions      Transaction[]
  securityEvents    SecurityEvent[]

  // Defect alert relations
  thresholdsCreated  DefectThreshold[] @relation("ThresholdCreatedBy")
  alertsAcknowledged DefectAlert[]     @relation("AlertAcknowledgedBy")

  // Draft transaction review relation
  transactionsReviewed Transaction[] @relation("TransactionReviewedBy")

  // Multi-company assignment (SINGLE SOURCE OF TRUTH)
  userCompanies UserCompany[]

  // Feedback relations
  feedbacks Feedback[]
}
```

**Updated Company model (lines 13-38):**
```prisma
model Company {
  id        String   @id @default(uuid())
  name      String   @unique @db.VarChar(100)
  settings  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  brands           Brand[]
  categories       Category[]
  locations        Location[]
  transactions     Transaction[]
  securityEvents   SecurityEvent[]
  defectThresholds DefectThreshold[]
  alertConfig      AlertConfig?
  forecastConfig   ForecastConfig?

  // Multi-company relations
  userCompanies UserCompany[] @relation("UserCompanies")
  components    Component[]   @relation("CompanyComponents")
  skus          SKU[]         @relation("CompanySKUs")

  // [V2-DEFERRED] Shopify integration relations
  shopifyConnection  ShopifyConnection?
  skuChannelMappings SkuChannelMapping[]
}
```

**Validation Commands**:
```bash
npx prisma validate
```

**Completion Criteria**:
- [ ] companyId removed from User model
- [ ] company relation removed from User model
- [ ] users relation removed from Company model
- [ ] index on [companyId, isActive] removed
- [ ] Schema validates

### Subtask 4.2: Create and Run Migration
**File**: New migration in `prisma/migrations/`
**Instructions**:
1. Generate migration:
```bash
DATABASE_URL="postgresql://inventory_test:inventory_test_2025@localhost:2346/inventory_test" npx prisma migrate dev --name remove_user_companyid_column
```

2. The migration should:
   - Drop the index on User(companyId, isActive)
   - Drop the foreign key constraint on User.companyId
   - Drop the companyId column from User table

3. Verify migration SQL looks correct (no data loss):
```sql
-- Expected migration content (approximately):
-- DropForeignKey
ALTER TABLE "User" DROP CONSTRAINT "User_companyId_fkey";

-- DropIndex
DROP INDEX "User_companyId_isActive_idx";

-- AlterTable
ALTER TABLE "User" DROP COLUMN "companyId";
```

**Validation Commands**:
```bash
# Verify migration applied
DATABASE_URL="postgresql://inventory_test:inventory_test_2025@localhost:2346/inventory_test" npx prisma migrate status

# Verify schema matches
DATABASE_URL="postgresql://inventory_test:inventory_test_2025@localhost:2346/inventory_test" npx prisma db pull --print | grep -A 20 "model User"
```

**Completion Criteria**:
- [ ] Migration created
- [ ] Migration applied to test database
- [ ] User table no longer has companyId column

### Subtask 4.3: Regenerate Prisma Client
**File**: Generated Prisma client
**Instructions**:
```bash
npx prisma generate
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Prisma client regenerated
- [ ] TypeScript compiles without errors
- [ ] Build completes without errors

---

## Phase 5: Testing and Verification

### Subtask 5.1: Run Unit Tests
**Instructions**:
```bash
npm test -- --filter="auth|user"
```

**Completion Criteria**:
- [ ] All auth-related tests pass
- [ ] All user-related tests pass

### Subtask 5.2: Run Integration Tests
**Instructions**:
```bash
npm test -- --filter="integration"
```

**Completion Criteria**:
- [ ] All integration tests pass

### Subtask 5.3: Run E2E Tests
**Instructions**:
```bash
TEST_BASE_URL=http://172.16.20.50:2345 npm run test:e2e
```

**Completion Criteria**:
- [ ] All E2E tests pass
- [ ] Login/logout works correctly
- [ ] Company switching works correctly
- [ ] User management works correctly

### Subtask 5.4: Manual Verification
**Instructions**:
1. Access test app at http://172.16.20.50:2345
2. Login as admin@tonsil.tech
3. Verify:
   - Dashboard loads correctly
   - Company selector works
   - User management page works
   - Can create new users
   - Can view/edit existing users

**Completion Criteria**:
- [ ] All manual tests pass
- [ ] No console errors in browser

---

## Summary of Deliverables

**Files Modified**: 9
| File | Change |
|------|--------|
| `prisma/schema.prisma` | Remove User.companyId, User.company, Company.users |
| `prisma/seed.ts` | Remove companyId from user creation, add UserCompany |
| `src/lib/auth.ts` | Use UserCompany.isPrimary for companyId derivation |
| `src/app/api/companies/switch/route.ts` | Remove redundant user.companyId check |
| `src/app/api/companies/[id]/route.ts` | Replace _count.users with _count.userCompanies |
| `src/app/api/users/route.ts` | Change scoping to UserCompany |
| `src/app/api/users/[id]/route.ts` | Change scoping to UserCompany |
| `src/app/api/users/[id]/companies/route.ts` | Remove sync code, update role logic |
| `tests/helpers/integration-context.ts` | Update user lookup queries |

**Files Created**: 1
| File | Description |
|------|-------------|
| `prisma/migrations/YYYYMMDDHHMMSS_remove_user_companyid_column/migration.sql` | Drop column migration |

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 0 -> 1 -> 2 -> 3 -> 4 -> 5)
2. Complete all Phase 1 subtasks before Phase 2
3. Test completion criteria before next subtask
4. Follow reference patterns exactly
5. **CRITICAL**: Run migration AFTER code changes to avoid TypeScript errors

## Test Strategy Note
- Use Vitest for unit tests
- Use Playwright for E2E tests
- All tests target TEST environment (port 2345/2346)

## Important Distinction

**Session `companyId`** vs **Database column `companyId`**:
- Session property `session.user.companyId` is KEPT - it tracks the current company context
- Database column `User.companyId` is REMOVED - it was redundant with UserCompany
- After this change, `session.user.companyId` is derived from UserCompany.isPrimary at login time and synced with selectedCompanyId during company switching

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 10m |
| **Total** | **30m** |

---

AGENT_RETURN: plan-224-120925
