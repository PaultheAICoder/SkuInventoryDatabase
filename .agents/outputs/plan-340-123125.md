# Implementation Plan
**Generated**: 2025-12-31T10:00:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: Issue #340
**Estimated Build Time**: 6-8 hours
**Complexity**: Medium

## Investigation Summary

### Request Analysis
**Type**: Bug
**Source**: GitHub Issue #340
**Priority**: Medium

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED
**Suggested Filter**: `--testPathPattern="transaction"` or None

### Issue Validation
**Status**: Valid
**Recent Changes**:
- `999fefe` - fix timezone date truncation bug
- `39cf6df` - update quick entry to inbound/outbound/adjustment
- `6e9a6ba` - add conversational AI transaction parser

### Current State Assessment

The investigation reveals a significant field consistency gap between natural language parsing and form-based input:

#### Natural Language Input (via ConversationalInput.tsx -> transaction-parser.ts)

**Fields Extracted by AI Parser:**
| Field | Source | Required | Notes |
|-------|--------|----------|-------|
| transactionType | Inferred from action | Always | Maps to receipt/outbound/adjustment |
| itemType | Inferred from action | Always | sku or component |
| itemId | Fuzzy match resolution | Always (attempted) | Can be null if not matched |
| itemName | From user input | Always | Raw text |
| quantity | From user input | Always | Numeric |
| date | From user input or default | Always | Defaults to today |
| salesChannel | From user input | **Outbound only** | Can be null |
| supplier | From user input | **Receipt only** | Can be null (defaults to "Unknown") |
| reason | NOT EXTRACTED | **Missing for adjustment** | BUG: Not in parser prompt |
| notes | From user input | Optional | Any additional context |
| locationId | NOT EXTRACTED | Never | BUG: Not in parser prompt |

**Submission Logic (QuickEntryWrapper.tsx:71-99):**
- **Receipt**: `componentId`, `date`, `quantity`, `supplier` (defaults "Unknown"), `notes`
- **Outbound**: `skuId`, `date`, `quantity`, `salesChannel` (defaults "Generic"), `notes`
- **Adjustment**: `componentId`, `date`, `quantity` (negated), `reason` (defaults "Adjustment"), `notes`

#### Form-Based Input (via QuickEntryForm.tsx)

**Inbound (Receipt) Form Fields:**
| Field | Required | Schema Required |
|-------|----------|-----------------|
| date | Yes (*) | Yes |
| componentId | Yes (*) | Yes |
| quantity | Yes (*) | Yes |
| supplier | Yes (*) | Yes |
| costPerUnit | No | No |
| locationId | No | No |
| lotNumber | No | No |
| expiryDate | No | No (requires lotNumber) |
| notes | No | No |

**Outbound Form Fields:**
| Field | Required | Schema Required |
|-------|----------|-----------------|
| date | Yes (*) | Yes |
| skuId | Yes (*) | Yes |
| salesChannel | Yes (*) | Yes |
| quantity | Yes (*) | Yes |
| locationId | No | No |
| notes | No | No |

**Adjustment Form Fields:**
| Field | Required | Schema Required |
|-------|----------|-----------------|
| date | Yes (*) | Yes |
| componentId | Yes (*) | Yes |
| adjustmentType | Yes (*) | N/A (derived) |
| quantity | Yes (*) | Yes (non-zero) |
| reason | Yes (*) | Yes |
| locationId | No | No |
| notes | No | No |

### Identified Inconsistencies

#### 1. **Reason Field for Adjustments** (Critical)
- **Form**: Required field with predefined options (Inventory count correction, Damaged goods, etc.)
- **NL Parser**: NOT extracted at all - defaults to "Adjustment" on submission
- **Impact**: Data quality - adjustments via NL have generic reasons

#### 2. **Location Field** (Moderate)
- **Form**: Optional dropdown for all transaction types
- **NL Parser**: NOT extracted at all - always null
- **Impact**: Location tracking inconsistent between input methods

#### 3. **Supplier Field for Receipts** (Moderate)
- **Form**: Required field with text input
- **NL Parser**: Extracted but defaults to "Unknown" if not mentioned
- **Impact**: Form enforces, NL allows silent default

#### 4. **Sales Channel for Outbound** (Moderate)
- **Form**: Required field with dropdown
- **NL Parser**: Extracted but defaults to "Generic" if not mentioned
- **Impact**: Form enforces, NL allows silent default

#### 5. **Build Transaction Type Missing** (By Design)
- **Form**: Uses "outbound" (ships finished goods)
- **NL Parser**: Uses "outbound" for "ship"/"build" actions
- **Note**: This is intentional - "build" is a separate workflow via BuildDialog

#### 6. **Cost Per Unit for Receipts** (Minor)
- **Form**: Optional field
- **NL Parser**: NOT extracted
- **Impact**: Cost not captured via NL

### Dependencies & Blockers
1. ANTHROPIC_API_KEY must be set for AI parsing to work
2. No blocking dependencies

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Moderate
**Effort**: 6-8 hours
**Risk**: Low - changes are additive to the parser prompt and submission logic

### Patterns Identified
**Primary**: `/home/pbrown/SkuInventory/src/lib/transaction-parser.ts` - Parser prompt and field extraction
**Secondary**: `/home/pbrown/SkuInventory/src/components/features/QuickEntryWrapper.tsx` - Submission logic

### Ripple Effect Analysis
**Files Identified**: 5 files

1. `/home/pbrown/SkuInventory/src/lib/transaction-parser.ts`
   - Add reason extraction for adjustments
   - Add location extraction
   - Update parser prompt

2. `/home/pbrown/SkuInventory/src/types/parser.ts`
   - Add `location` field to `ParsedTransaction`
   - Add `RawClaudeParseResponse.reason` field

3. `/home/pbrown/SkuInventory/src/components/features/QuickEntryWrapper.tsx`
   - Update submission to include locationId
   - Remove silent defaults or make them explicit

4. `/home/pbrown/SkuInventory/src/components/features/ParsedTransactionPreview.tsx`
   - Add location display
   - Add reason display for adjustments
   - Add warning for missing required fields

5. `/home/pbrown/SkuInventory/src/app/api/transactions/parse/route.ts`
   - Pass locations to parser context (already doing this)
   - No changes needed

---

## Executive Summary

This bug fix addresses field requirement inconsistency between natural language and form-based transaction input. The natural language parser does not extract reason (for adjustments) or location (for all types), leading to data quality issues. The fix involves updating the AI parser prompt to extract these fields, adding them to the type definitions, displaying them in the preview, and ensuring both input methods have consistent validation behavior.

---

## Phase 1: Update Type Definitions

### Subtask 1.1: Add Location and Reason to ParsedTransaction and RawClaudeParseResponse

**File**: `/home/pbrown/SkuInventory/src/types/parser.ts`
**Pattern**: Follow existing ParsedField pattern (line 10-14)

**Instructions**:
1. Add `location` field to `ParsedTransaction` interface:
   ```typescript
   location?: ParsedField<string | null>
   ```
2. Add `reason` field to `RawClaudeParseResponse`:
   ```typescript
   reason: string | null
   ```
3. Add `location` field to `RawClaudeParseResponse`:
   ```typescript
   location: string | null
   ```

**Completion Criteria**:
- [ ] `npx tsc --noEmit` passes without errors
- [ ] ParsedTransaction includes optional location field
- [ ] RawClaudeParseResponse includes reason and location fields

---

## Phase 2: Update Transaction Parser

### Subtask 2.1: Update Parser Prompt to Extract Reason and Location

**File**: `/home/pbrown/SkuInventory/src/lib/transaction-parser.ts`
**Pattern**: Follow existing prompt structure at line 34-71

**Instructions**:
1. Update `buildParsePrompt()` function to add extraction instructions:
   - Add `reason` to the extraction list:
     ```
     - reason: reason for adjustment if mentioned (damaged, lost, count correction, or null)
     ```
   - Add `location` to the extraction list:
     ```
     - location: warehouse or location name if mentioned (or null)
     ```
2. Update the JSON response format in the prompt:
   ```json
   {
     "action": "ship|receive|adjust|build",
     "item": "item name as mentioned",
     "quantity": 123,
     "channel": "Amazon|Shopify|TikTok|Generic|null",
     "date": "YYYY-MM-DD",
     "supplier": "supplier name or null",
     "reason": "adjustment reason or null",
     "location": "location/warehouse name or null",
     "notes": "any additional context or null"
   }
   ```
3. Add common adjustment reasons to interpretation patterns:
   ```
   - "damaged" or "broke" -> reason: "Damaged goods"
   - "lost" or "missing" or "can't find" -> reason: "Lost/missing"
   - "count" or "recount" or "inventory count" -> reason: "Inventory count correction"
   - "sample" or "testing" -> reason: "Sample/testing"
   ```

**Completion Criteria**:
- [ ] Prompt includes reason extraction instructions
- [ ] Prompt includes location extraction instructions
- [ ] JSON format in prompt includes both fields

### Subtask 2.2: Update parseClaudeResponse to Extract New Fields

**File**: `/home/pbrown/SkuInventory/src/lib/transaction-parser.ts`
**Pattern**: Follow existing field extraction at line 77-107

**Instructions**:
1. Update the return statement in `parseClaudeResponse` to include:
   ```typescript
   reason: parsed.reason || null,
   location: parsed.location || null,
   ```

**Completion Criteria**:
- [ ] parseClaudeResponse extracts reason field
- [ ] parseClaudeResponse extracts location field

### Subtask 2.3: Update parseTransactionText to Build ParsedTransaction with New Fields

**File**: `/home/pbrown/SkuInventory/src/lib/transaction-parser.ts`
**Pattern**: Follow existing field building at line 390-441

**Instructions**:
1. After the transaction type specific fields (around line 434), add reason handling for adjustments:
   ```typescript
   if (transactionType === 'adjustment') {
     parsed.reason = {
       value: rawParsed.reason,
       confidence: rawParsed.reason ? 'high' : 'low',
     }
   }
   ```
2. Add location field for all transaction types (after line 441):
   ```typescript
   if (rawParsed.location) {
     parsed.location = {
       value: rawParsed.location,
       confidence: 'medium', // Fuzzy match could improve this
     }
   }
   ```

**Completion Criteria**:
- [ ] Adjustments include reason in parsed output
- [ ] All transaction types can include location

### Subtask 2.4: Update Fallback Parser to Include New Fields

**File**: `/home/pbrown/SkuInventory/src/lib/transaction-parser.ts`
**Pattern**: Follow existing fallback at line 268-323

**Instructions**:
1. In `createFallbackParse`, add reason detection for adjustments:
   ```typescript
   let reason: string | null = null
   if (transactionType === 'adjustment') {
     if (/damag/i.test(text)) reason = 'Damaged goods'
     else if (/lost|missing/i.test(text)) reason = 'Lost/missing'
     else if (/count|recount/i.test(text)) reason = 'Inventory count correction'
     else if (/sample|test/i.test(text)) reason = 'Sample/testing'
   }
   ```
2. Add reason field to fallback return when transactionType is adjustment

**Completion Criteria**:
- [ ] Fallback parser extracts basic reason from text
- [ ] Fallback parser handles adjustment reasons

---

## Phase 3: Update Preview Component

### Subtask 3.1: Add Location and Reason Display to ParsedTransactionPreview

**File**: `/home/pbrown/SkuInventory/src/components/features/ParsedTransactionPreview.tsx`
**Pattern**: Follow existing field display pattern at line 145-182

**Instructions**:
1. Add import for MapPin icon:
   ```typescript
   import { ..., MapPin } from 'lucide-react'
   ```
2. Add location display after notes (around line 194):
   ```typescript
   {/* Location */}
   {parsed.location && parsed.location.value && (
     <div className="flex items-center justify-between">
       <div className="flex items-center gap-2">
         <MapPin className="h-4 w-4 text-muted-foreground" />
         <span className="text-sm font-medium">Location</span>
       </div>
       <div className="flex items-center gap-2">
         <span>{parsed.location.value}</span>
         <ConfidenceIcon level={parsed.location.confidence} />
       </div>
     </div>
   )}
   ```
3. Add reason display for adjustments (after transaction type display):
   ```typescript
   {/* Reason (for adjustments) */}
   {parsed.transactionType.value === 'adjustment' && parsed.reason && (
     <div className="flex items-center justify-between">
       <div className="flex items-center gap-2">
         <span className="text-sm font-medium">Reason</span>
       </div>
       <div className="flex items-center gap-2">
         <span>{parsed.reason.value || 'Not specified'}</span>
         <ConfidenceIcon level={parsed.reason?.confidence || 'low'} />
       </div>
     </div>
   )}
   ```
4. Add warning for missing required fields (adjust hasLowConfidence logic):
   ```typescript
   const missingRequiredFields =
     (parsed.transactionType.value === 'adjustment' && !parsed.reason?.value) ||
     (parsed.transactionType.value === 'receipt' && !parsed.supplier?.value)
   ```

**Completion Criteria**:
- [ ] Location displayed when available
- [ ] Reason displayed for adjustments
- [ ] Warning shown when required fields missing

---

## Phase 4: Update Submission Logic

### Subtask 4.1: Update QuickEntryWrapper Submission to Use Parsed Fields

**File**: `/home/pbrown/SkuInventory/src/components/features/QuickEntryWrapper.tsx`
**Pattern**: Follow existing submission at line 58-122

**Instructions**:
1. Update receipt payload (line 72-79) to NOT use silent defaults:
   ```typescript
   if (transactionType === 'receipt') {
     endpoint = '/api/transactions/receipt'
     payload = {
       componentId: parsed.itemId.value,
       date,
       quantity: parsed.quantity.value,
       supplier: parsed.supplier?.value || '', // Let API validate
       notes: parsed.notes?.value || `Parsed from: "${parsed.originalInput}"`,
     }
   }
   ```
   **Alternative**: Keep default but show warning in preview

2. Update adjustment payload (line 89-99) to use parsed reason:
   ```typescript
   } else {
     // adjustment
     endpoint = '/api/transactions/adjustment'
     payload = {
       componentId: parsed.itemId.value,
       date,
       quantity: -Math.abs(parsed.quantity.value),
       reason: parsed.reason?.value || 'Adjustment', // Use parsed or fallback
       notes: parsed.notes?.value || `Parsed from: "${parsed.originalInput}"`,
     }
   }
   ```

3. Consider adding locationId to all payloads when available:
   - This requires resolving location name to ID (similar to item resolution)
   - For now, log a TODO comment for future enhancement

**Completion Criteria**:
- [ ] Receipt submission uses parsed supplier (not silent default)
- [ ] Adjustment submission uses parsed reason
- [ ] Silent defaults are documented or shown as warnings

### Subtask 4.2: Add Location Resolution to Parse Route (Optional Enhancement)

**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/parse/route.ts`
**Pattern**: Follow existing item resolution at line 60-90

**Instructions**:
1. Add a helper function to fuzzy match location name to ID:
   ```typescript
   function resolveLocationToId(
     locationName: string | null,
     locations: Array<{ id: string; name: string }>
   ): { id: string; confidence: ConfidenceLevel } | null {
     if (!locationName) return null
     const fuse = new Fuse(locations, {
       keys: ['name'],
       threshold: 0.4,
       includeScore: true,
     })
     const results = fuse.search(locationName)
     if (results.length === 0) return null
     const best = results[0]
     return {
       id: best.item.id,
       confidence: (best.score || 1) < 0.2 ? 'high' : (best.score || 1) < 0.35 ? 'medium' : 'low',
     }
   }
   ```
2. Resolve location after item resolution
3. Add locationId to finalParsed output

**Note**: This subtask is optional - can be deferred if time constrained.

**Completion Criteria**:
- [ ] Location name resolved to locationId when matched
- [ ] LocationId included in parse response

---

## Phase 5: Validation and Testing

### Subtask 5.1: Verify TypeScript Compilation

**Instructions**:
1. Run `npx tsc --noEmit` from project root
2. Fix any type errors

**Completion Criteria**:
- [ ] No TypeScript errors

### Subtask 5.2: Verify Build Passes

**Instructions**:
1. Run `npm run build` from project root
2. Fix any build errors

**Completion Criteria**:
- [ ] Build completes successfully

### Subtask 5.3: Manual Testing Checklist

**Instructions**:
Test the following scenarios on the test environment (http://172.16.20.50:2345):

1. **Natural Language - Receipt**:
   - Input: "Received 500 bottles from XYZ supplier yesterday"
   - Verify: Supplier field extracted and displayed in preview
   - Verify: Transaction created with supplier "XYZ supplier"

2. **Natural Language - Outbound**:
   - Input: "Shipped 10 units of 3-pack to Amazon today"
   - Verify: Sales channel extracted and displayed
   - Verify: Transaction created with channel "Amazon"

3. **Natural Language - Adjustment with reason**:
   - Input: "Found 5 damaged bottles of the vitamin supplement"
   - Verify: Reason extracted as "Damaged goods"
   - Verify: Preview shows reason field
   - Verify: Transaction created with reason "Damaged goods"

4. **Natural Language - Adjustment without reason**:
   - Input: "Adjusted inventory by -10 bottles"
   - Verify: Reason defaults to "Adjustment" or shows warning
   - Verify: Preview indicates low confidence or missing field

5. **Form Input - Verify unchanged behavior**:
   - All form fields still work as expected
   - Required fields still enforced

**Completion Criteria**:
- [ ] All 5 test scenarios pass
- [ ] Form behavior unchanged

---

## Summary of Deliverables

**Files Created**: 0
**Files Modified**: 4-5 files

| File | Changes |
|------|---------|
| `/home/pbrown/SkuInventory/src/types/parser.ts` | Add location and reason to types |
| `/home/pbrown/SkuInventory/src/lib/transaction-parser.ts` | Update prompt, parsing, and fallback |
| `/home/pbrown/SkuInventory/src/components/features/ParsedTransactionPreview.tsx` | Add location and reason display |
| `/home/pbrown/SkuInventory/src/components/features/QuickEntryWrapper.tsx` | Update submission logic |
| `/home/pbrown/SkuInventory/src/app/api/transactions/parse/route.ts` | (Optional) Add location resolution |

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 -> Phase 5)
2. Complete each phase fully before moving to next
3. Run `npx tsc --noEmit` after each file modification
4. Follow reference patterns exactly
5. Test on http://172.16.20.50:2345 (test environment)

---

## Test Strategy Note

- Use Vitest for unit tests if adding tests
- Manual testing via test environment UI
- No E2E tests required for this fix

---

## Performance Metrics

| Phase | Estimated Duration |
|-------|-------------------|
| Investigation | 25m |
| Validation | 10m |
| Planning | 15m |
| **Total Scout-Plan** | **50m** |

---

## Alternative Approaches Considered

### Approach A: Strict Validation (Rejected)
Block NL submission if required fields missing. This would break existing workflows where users rely on defaults.

### Approach B: Warning-Based (Selected)
Show warnings for missing fields but allow submission with defaults. Maintain backward compatibility while improving data quality awareness.

### Approach C: Full Parity (Future Enhancement)
Add all form fields to NL parser (cost per unit, lot number, expiry date). This is over-engineering for the current issue and can be addressed separately if needed.
