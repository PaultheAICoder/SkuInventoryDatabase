# Implementation Plan
**Generated**: 2025-12-04T16:30:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #144
**Estimated Build Time**: 2-3 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Bug
**Source**: GitHub Issue #144
**Priority**: High - Core feature broken, user cannot access main dashboard

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED - Dashboard and related component tests
**Suggested Filter**: `--filter="Dashboard|BuildFooter|hydration"`

### Issue Validation
**Status**: Valid - Issue confirmed to be active and reproducible
**Recent Changes**:
- `b7cfeb6` fix(issue #33): add suppressHydrationWarning to dashboard locale-dependent elements
- Previous fix was incomplete - `BuildFooter.tsx` was not addressed

### Current State Assessment

**Root Cause Identified**: The `BuildFooter.tsx` component is missing the `'use client'` directive and does not use `suppressHydrationWarning` on its date-formatted output. This causes React hydration mismatch errors (#425, #418, #423) when server-rendered HTML differs from client-side rendered content.

**Error Pattern**:
- Error #425: Text content does not match server-rendered HTML
- Error #418: Hydration failed because initial UI does not match server-rendered HTML
- Error #423: Error while hydrating Suspense boundary

**Existing Components**:
- `src/components/ui/BuildFooter.tsx` - **AFFECTED** - No `'use client'`, uses `toLocaleDateString()` without `suppressHydrationWarning`
- `src/app/(dashboard)/page.tsx` - Client component, already has some `suppressHydrationWarning` attributes
- `src/app/(dashboard)/layout.tsx` - Client component, imports `BuildFooter`

**Database**: No changes needed
**API Routes**: No changes needed
**Types**: No changes needed

### Dependencies & Blockers
None identified - this is an isolated UI component fix.

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Simple
**Effort**: 2-3 hours
**Risk**: Low - Isolated change with clear solution pattern

### Patterns Identified
**Primary**: `src/app/(dashboard)/page.tsx:194-195` - Uses `suppressHydrationWarning` on `TableCell` with date formatting
**Secondary**: Issue #56 documentation - Comprehensive guidance on fixing hydration warnings

### Ripple Effect Analysis
**Files Identified**: 1

**Component: BuildFooter.tsx**
- Direct Callers: 1 file
  - `src/app/(dashboard)/layout.tsx` (line 147)
- Indirect Callers: 0 files
- **TOTAL FILES AFFECTED**: 1 (BuildFooter.tsx only needs modification)

The fix is isolated to `BuildFooter.tsx` - no callers need modification since the component signature remains unchanged.

---

## Executive Summary

The dashboard loading issue is caused by React hydration mismatch in the `BuildFooter` component. The component uses locale-dependent date formatting (`toLocaleDateString`) without the `'use client'` directive and without `suppressHydrationWarning`. This causes the server-rendered HTML to differ from the client-rendered content when the server and client have different locale settings or timezones.

The fix requires:
1. Adding `'use client'` directive to `BuildFooter.tsx`
2. Adding `suppressHydrationWarning` to the element containing the formatted timestamp
3. Optionally, using `useState` with `useEffect` for client-only date rendering (deferred hydration pattern)

---

## Phase 1: Fix BuildFooter Hydration Issue

### Subtask 1.1: Add Client Directive and Fix Hydration Warning in BuildFooter.tsx

**File**: `/home/pbrown/SkuInventory/src/components/ui/BuildFooter.tsx`

**Pattern**: Follow `src/app/(dashboard)/page.tsx:194-195`:
```tsx
<TableCell className="font-mono text-sm" suppressHydrationWarning>
  {new Date(tx.date).toLocaleDateString()}
</TableCell>
```

**Current Code (lines 1-36)**:
```tsx
import { cn } from '@/lib/utils'
import versionData from '../../../version.json'

interface BuildFooterProps {
  className?: string
}

function formatTimestamp(isoString: string): string {
  try {
    const date = new Date(isoString)
    return date.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
    })
  } catch {
    return 'Unknown'
  }
}

export function BuildFooter({ className }: BuildFooterProps) {
  return (
    <footer
      className={cn(
        'border-t bg-muted/50 px-4 py-2 text-center text-xs text-muted-foreground',
        className
      )}
    >
      <span>Build {versionData.version}</span>
      <span className="mx-2">|</span>
      <span>{formatTimestamp(versionData.buildTimestamp)}</span>
    </footer>
  )
}
```

**Instructions**:
1. Add `'use client'` directive at the very top of the file
2. Import `useState` and `useEffect` from React
3. Convert the component to use client-only date rendering to prevent hydration mismatch:
   - Initialize state with a placeholder or server-safe value
   - Use `useEffect` to set the formatted date only on the client
4. Add `suppressHydrationWarning` to the span containing the timestamp as a fallback safety measure

**Recommended Fix**:
```tsx
'use client'

import { useState, useEffect } from 'react'
import { cn } from '@/lib/utils'
import versionData from '../../../version.json'

interface BuildFooterProps {
  className?: string
}

function formatTimestamp(isoString: string): string {
  try {
    const date = new Date(isoString)
    return date.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
    })
  } catch {
    return 'Unknown'
  }
}

export function BuildFooter({ className }: BuildFooterProps) {
  const [formattedDate, setFormattedDate] = useState<string>('')

  useEffect(() => {
    setFormattedDate(formatTimestamp(versionData.buildTimestamp))
  }, [])

  return (
    <footer
      className={cn(
        'border-t bg-muted/50 px-4 py-2 text-center text-xs text-muted-foreground',
        className
      )}
    >
      <span>Build {versionData.version}</span>
      <span className="mx-2">|</span>
      <span suppressHydrationWarning>{formattedDate}</span>
    </footer>
  )
}
```

**Alternative Simpler Fix** (if the above is too invasive):
```tsx
'use client'

import { cn } from '@/lib/utils'
import versionData from '../../../version.json'

// ... rest unchanged ...

export function BuildFooter({ className }: BuildFooterProps) {
  return (
    <footer
      className={cn(
        'border-t bg-muted/50 px-4 py-2 text-center text-xs text-muted-foreground',
        className
      )}
      suppressHydrationWarning
    >
      <span>Build {versionData.version}</span>
      <span className="mx-2">|</span>
      <span>{formatTimestamp(versionData.buildTimestamp)}</span>
    </footer>
  )
}
```

**Validation Commands**:
```bash
# TypeScript check
npx tsc --noEmit

# Build check
npm run build

# Lint check
npm run lint
```

**Completion Criteria**:
- [ ] `'use client'` directive added at top of file
- [ ] `suppressHydrationWarning` added to timestamp span or parent footer
- [ ] File compiles without TypeScript errors
- [ ] Build completes successfully
- [ ] No lint errors

---

## Phase 2: Verification

### Subtask 2.1: Manual Verification of Dashboard Loading

**Instructions**:
1. Start the test environment:
   ```bash
   cd /home/pbrown/SkuInventory/docker
   docker compose -f docker-compose.test.yml up -d --build
   ```
2. Wait for container to be healthy
3. Navigate to http://172.16.20.50:2345
4. Login and verify:
   - Dashboard loads without getting stuck
   - No hydration errors in browser console (check DevTools Console)
   - BuildFooter displays correctly at the bottom of the page

**Completion Criteria**:
- [ ] Dashboard loads successfully
- [ ] No React hydration error messages (#425, #418, #423) in console
- [ ] BuildFooter visible with correct version and timestamp

### Subtask 2.2: Run Existing Tests

**Instructions**:
```bash
# Run unit tests
npm test

# Run any existing E2E tests related to dashboard/footer
npm run test:e2e -- --grep "footer|Footer|dashboard|Dashboard"
```

**Completion Criteria**:
- [ ] All existing unit tests pass
- [ ] Any existing E2E tests pass
- [ ] No regressions introduced

---

## Summary of Deliverables

**Files Created**: 0
**Files Modified**:
1. `/home/pbrown/SkuInventory/src/components/ui/BuildFooter.tsx` - Add client directive and fix hydration

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 before Phase 2)
2. Use the recommended fix pattern with `useState` + `useEffect` for robust hydration handling
3. Test completion criteria before moving to next subtask
4. Follow the pattern from `src/app/(dashboard)/page.tsx:194-195` for `suppressHydrationWarning` usage

---

## Test Strategy Note

- **Unit Tests**: Vitest - verify BuildFooter renders correctly
- **E2E Tests**: Playwright - verify dashboard loads without console errors
- **Manual Verification**: Check browser console for hydration warnings

---

## Related Issues

| Issue | Status | Relationship |
|-------|--------|--------------|
| #33 | CLOSED | Original hydration issue - partial fix applied |
| #56 | CLOSED | Enhancement to fix remaining hydration warnings - BuildFooter mentioned but not fully fixed |
| #144 | OPEN | Current issue - same root cause, BuildFooter not addressed |

---

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 8m |
| Validation | 2m |
| Planning | 5m |
| **Total** | **15m** |
