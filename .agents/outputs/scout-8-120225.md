# Scout Report: Initial Inventory Import & Opening Balance Transactions

## Request Analysis
**Type**: Feature
**Source**: GitHub Issue #8
**Priority**: High

## Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="initial|import|transaction"` for focused testing

## Issue Validation
**Status**: Valid - Active Issue
**Recent Changes**:
- Component/SKU import functionality exists (commit d16261e - "feat: complete Phase 10 - CSV import functionality")
- Transaction types include 'initial' in enum but no creation API/UI exists
- Last transaction-related commit: 09688ad (settings integration)
- No overlapping closed issues found

**Current State**: Issue is accurate. The 'initial' transaction type exists in Prisma schema but has no implementation for creation or bulk import.

## Current State

### Existing Components
**Database Schema** (prisma/schema.prisma):
- Transaction model (lines 128-154): Includes 'initial' in TransactionType enum (line 125)
- TransactionLine model (lines 156-166): Supports quantityChange and costPerUnit

**Transaction APIs**:
- /api/transactions/route.ts: GET endpoint with filtering, includes 'initial' type in query schema
- /api/transactions/receipt/route.ts: POST endpoint for receipt transactions
- /api/transactions/adjustment/route.ts: POST endpoint for adjustment transactions
- /api/transactions/build/route.ts: POST endpoint for build transactions
- NO /api/transactions/initial/route.ts endpoint exists

**Services**:
- src/services/inventory.ts:
  - createReceiptTransaction (lines 91-170)
  - createAdjustmentTransaction (lines 175-224)
  - NO createInitialTransaction function
- src/services/import.ts:
  - processComponentImport (lines 216-244): Parses CSV, validates, returns ImportSummary
  - processSKUImport (lines 249-277): Similar pattern
  - Does NOT handle quantities or create transactions

**Types**:
- src/types/transaction.ts:
  - createReceiptSchema, createAdjustmentSchema, createBuildSchema defined
  - transactionListQuerySchema includes 'initial' filter (line 60)
  - TransactionResponse type includes 'initial' (line 74)
  - NO createInitialSchema defined

**UI Components**:
- src/app/(dashboard)/import/page.tsx: Existing import page with Components and SKUs forms
- src/components/features/ImportForm.tsx: Generic CSV import form (used for components/skus)
- src/components/features/ImportResultDialog.tsx: Shows import results
- src/app/(dashboard)/transactions/page.tsx: Lists transactions, includes 'initial' in filter dropdown (line 33)
- src/components/features/TransactionDetail.tsx: Displays transaction details, has 'initial' config (lines 74-79)

**Import API Routes**:
- src/app/api/import/components/route.ts: POST endpoint, creates Components from CSV (no transactions)
- src/app/api/import/skus/route.ts: POST endpoint, creates SKUs from CSV
- src/app/api/import/template/[type]/route.ts: Returns CSV templates

## Dependencies & Blockers

**Prerequisites**:
1. Components must exist before initial transactions can be created
2. User must have admin/ops role (viewer cannot create transactions)
3. Tenant scoping must be enforced (companyId validation)

**No External Blockers**: All required infrastructure exists

**Can Proceed?**: YES

## Complexity Assessment
**Complexity**: Moderate
**Effort**: 8-12 hours
**Risk**: Low-Medium

**Breakdown**:
- Service layer (createInitialTransaction): 1-2 hours
- API endpoint (POST /api/transactions/initial): 1 hour
- Transaction type/schema: 30 minutes
- CSV import schema extension: 1-2 hours
- Bulk import API (POST /api/import/initial-inventory): 2-3 hours
- UI for single initial transaction: 1-2 hours
- CSV import UI integration: 1-2 hours
- Testing: 2 hours

**Risk Factors**:
- Idempotency logic for preventing double-initialization is moderately complex
- CSV parsing for quantities must handle decimals correctly
- Need to ensure cost updates don't conflict with existing component costs

## Patterns to Follow

**Primary Pattern - Transaction Creation**:
- File: src/app/api/transactions/receipt/route.ts
- Pattern:
  1. Session validation and role check (lines 12-20)
  2. Parse/validate request body with Zod schema (line 22)
  3. Verify component exists and belongs to user's company (lines 28-39)
  4. Call service function with normalized parameters (lines 42-52)
  5. Return created response with formatted data (lines 54-68)

**Primary Pattern - Service Transaction Creation**:
- File: src/services/inventory.ts (createReceiptTransaction, lines 91-170)
- Pattern:
  1. Use Prisma transaction ($transaction)
  2. Fetch component for cost snapshot (lines 116-122)
  3. Create Transaction with nested TransactionLine (lines 127-155)
  4. Include related data in response (lines 143-154)
  5. Optionally update component cost (lines 158-166)

**Secondary Pattern - CSV Import with Validation**:
- File: src/app/api/import/components/route.ts
- Pattern:
  1. Session/role validation (lines 24-32)
  2. Get user's brandId (lines 35-44)
  3. Parse multipart form data or raw CSV (lines 46-66)
  4. Process CSV with service function (line 69)
  5. Loop through results, check duplicates, create records (lines 79-141)
  6. Return summary with imported/skipped/errors (lines 71-76, 143)

**Secondary Pattern - Import Service Processing**:
- File: src/services/import.ts (processComponentImport, lines 216-244)
- Pattern:
  1. Parse CSV into rows (line 219)
  2. Extract headers and data rows (lines 230-231)
  3. Map each row through validation function (lines 233-236)
  4. Return ImportSummary with counts and results (lines 238-244)

## Files to Create/Modify

### Files to Create (5 files):
1. **/home/pbrown/SkuInventory/src/app/api/transactions/initial/route.ts**
   - Purpose: POST endpoint for creating single initial transactions
   - Pattern: Follow receipt/route.ts structure
   - Accepts: componentId, quantity, date, costPerUnit (optional), notes

2. **/home/pbrown/SkuInventory/src/app/api/import/initial-inventory/route.ts**
   - Purpose: POST endpoint for bulk CSV import of initial inventory
   - Pattern: Follow import/components/route.ts structure
   - Accepts: CSV file with columns: component_sku_code, quantity, cost_per_unit (optional), date, notes (optional)

3. **/home/pbrown/SkuInventory/src/app/api/import/template/initial-inventory/route.ts**
   - Purpose: GET endpoint to download CSV template for initial inventory
   - Pattern: Follow existing template routes
   - Returns: CSV with headers and example row

4. **UI Component TBD** (if single-transaction form needed)
   - Purpose: Form to create single initial transaction
   - Location: Likely src/components/features/InitialTransactionForm.tsx or integrated into existing component detail page
   - Pattern: Similar to receipt/adjustment forms (if they exist in UI)

5. **UI Enhancement TBD** (bulk import on import page)
   - Purpose: Add initial inventory import card to import page
   - Location: Modify src/app/(dashboard)/import/page.tsx
   - Pattern: Add third ImportForm instance for initial-inventory

### Files to Modify (4 files):
1. **/home/pbrown/SkuInventory/src/services/inventory.ts**
   - Add: createInitialTransaction function (similar to createReceiptTransaction)
   - Location: After line 224 (after createAdjustmentTransaction)
   - Parameters: componentId, quantity, date, costPerUnit (optional), notes, companyId, createdById

2. **/home/pbrown/SkuInventory/src/services/import.ts**
   - Add: processInitialInventoryImport function
   - Add: initialInventoryImportSchema (Zod schema for CSV validation)
   - Add: generateInitialInventoryTemplate function
   - Location: After line 277 (after processSKUImport)

3. **/home/pbrown/SkuInventory/src/types/transaction.ts**
   - Add: createInitialSchema (Zod schema for API validation)
   - Add: CreateInitialInput type
   - Location: After line 25 (after createAdjustmentSchema)

4. **/home/pbrown/SkuInventory/src/app/(dashboard)/import/page.tsx** (OPTIONAL for Phase 2)
   - Add: State for initial inventory import result
   - Add: ImportForm instance for initial-inventory type
   - Add: ImportResultDialog for initial inventory
   - Pattern: Follow existing component/SKU import pattern

## Final Sweep Results

**Services Search**: 1 file needs modification
- src/services/inventory.ts - Add createInitialTransaction function

**Import Services**: 1 file needs modification
- src/services/import.ts - Add initial inventory CSV processing

**API Routes**: 3 new routes needed
- src/app/api/transactions/initial/route.ts - Create single initial transaction
- src/app/api/import/initial-inventory/route.ts - Bulk CSV import
- src/app/api/import/template/initial-inventory/route.ts - Download template

**Type Definitions**: 1 file needs modification
- src/types/transaction.ts - Add createInitialSchema

**Components**: 1 file may need modification (optional)
- src/app/(dashboard)/import/page.tsx - Add initial inventory import UI

**Test Files**: Search revealed no existing test files for transactions
- Will need to create tests as part of implementation

**All Affected Files** (comprehensive list):
1. /home/pbrown/SkuInventory/src/services/inventory.ts - Add createInitialTransaction
2. /home/pbrown/SkuInventory/src/services/import.ts - Add processInitialInventoryImport
3. /home/pbrown/SkuInventory/src/types/transaction.ts - Add createInitialSchema
4. /home/pbrown/SkuInventory/src/app/api/transactions/initial/route.ts - CREATE NEW
5. /home/pbrown/SkuInventory/src/app/api/import/initial-inventory/route.ts - CREATE NEW
6. /home/pbrown/SkuInventory/src/app/api/import/template/initial-inventory/route.ts - CREATE NEW
7. /home/pbrown/SkuInventory/src/app/(dashboard)/import/page.tsx - OPTIONAL: Add UI for bulk import

**No service layer or API consumers found beyond above** - This is a new feature, so no existing callers to update.

## Ripple Effect Analysis

**Function: createInitialTransaction (NEW)**
- Direct Callers:
  - src/app/api/transactions/initial/route.ts (new file)
  - src/app/api/import/initial-inventory/route.ts (new file, in loop)
- Indirect Callers: None (new function)
- TOTAL FILES AFFECTED: 2 (both new)

**Function: processInitialInventoryImport (NEW)**
- Direct Callers:
  - src/app/api/import/initial-inventory/route.ts (new file)
- Indirect Callers: None
- TOTAL FILES AFFECTED: 1 (new)

**Type: createInitialSchema (NEW)**
- Direct Consumers:
  - src/app/api/transactions/initial/route.ts (new file)
- TOTAL FILES AFFECTED: 1 (new)

**Existing Functions**: No existing function signatures are being changed. This feature is purely additive.

**Conclusion**: Minimal ripple effect. All changes are new code with no modifications to existing function signatures.

## Idempotency Requirements

The issue states: "Prevent double initialization: guard against multiple initial imports unless explicitly allowed"

**Suggested Approach**:
1. **Option 1 - Component-level flag** (simpler):
   - No schema changes needed
   - Check if component has any 'initial' type transactions before creating new one
   - Query: `prisma.transaction.count({ where: { type: 'initial', lines: { some: { componentId } } } })`
   - If count > 0, either reject or require `allowOverwrite` parameter

2. **Option 2 - Explicit overwrite parameter** (more flexible):
   - Add `allowOverwrite: boolean` to createInitialSchema (default false)
   - For CSV import, add option at UI/API level to allow re-initialization
   - Clear error message when attempting duplicate: "Component X already has initial inventory. Use allowOverwrite to replace."

**Recommendation**: Use Option 1 for single transactions (strict), Option 2 for CSV import (allow retry scenarios)

## CSV Template Format

Based on requirement "component SKU/code, quantity, optional cost per unit":

```csv
Component SKU Code,Quantity,Cost Per Unit,Date,Notes
COMP-001,100,10.50,2025-01-01,Opening balance
COMP-002,50,,2025-01-01,Initial stock (use default cost)
```

**Field Mappings**:
- component_sku_code → Required, lookup component by skuCode + brandId
- quantity → Required, positive decimal
- cost_per_unit → Optional, decimal (if blank, use component's default costPerUnit)
- date → Optional, defaults to today
- notes → Optional, text

## Acceptance Criteria

From issue:
- [x] Requirement validated: User can create 'initial' transaction via API (will create POST /api/transactions/initial)
- [x] Requirement validated: User can create 'initial' transaction via UI (can extend transaction creation UI or use bulk import)
- [x] Requirement validated: CSV import can set opening balances for multiple components
- [x] Requirement validated: Success/error summary returned from import
- [x] Requirement validated: Resulting quantities reflect imported values without duplicate double-counting (idempotency)
- [x] Requirement validated: 'initial' transactions appear in logs (already supported - UI has filter)
- [x] Requirement validated: AuthZ enforced (will follow receipt/adjustment pattern - viewer cannot create)
- [x] Requirement validated: Tests cover API and import paths (will include in implementation)

## Handoff to Plan Agent

**Summary**:
Issue #8 requests the ability to set opening inventory balances via an 'initial' transaction type. The database schema already includes this transaction type in the enum, and the UI already displays it in filters and transaction details. However, there is no API endpoint to CREATE initial transactions, and the existing CSV import functionality only creates Components/SKUs without setting quantities. This feature requires: (1) a service function to create initial transactions, (2) API endpoints for single and bulk creation, (3) CSV import processing with quantity support, (4) schemas/types for validation, and (5) optional UI enhancements for the import page. The implementation follows established patterns from receipt/adjustment transactions and component/SKU imports. Complexity is moderate due to idempotency requirements and CSV parsing for quantities, but risk is low as all infrastructure exists.

**Key Points**:
1. Database schema already supports 'initial' transaction type - no migration needed
2. Follow receipt/adjustment transaction patterns for service and API layers
3. Extend existing import service patterns for CSV processing with quantities
4. Implement idempotency check to prevent double-initialization
5. CSV should accept component SKU code (not ID) for easier import UX
6. Cost per unit is optional - fall back to component's default cost if not provided
7. UI already displays initial transactions - only creation needs implementation
8. Test strategy: TARGETED - focus on new initial transaction APIs and import service
9. No ripple effects - purely additive feature

**Suggested Phases**:
1. **Phase 1 - Core Transaction Creation** (3-4 hours):
   - Add createInitialSchema to types/transaction.ts
   - Add createInitialTransaction to services/inventory.ts
   - Create app/api/transactions/initial/route.ts
   - Test single transaction creation via API

2. **Phase 2 - CSV Import Backend** (3-4 hours):
   - Add processInitialInventoryImport to services/import.ts
   - Add initialInventoryImportSchema and template generator
   - Create app/api/import/initial-inventory/route.ts
   - Create app/api/import/template/initial-inventory/route.ts
   - Implement idempotency check with clear error messages
   - Test bulk import via API

3. **Phase 3 - UI Integration** (2-3 hours, OPTIONAL):
   - Modify app/(dashboard)/import/page.tsx
   - Add initial inventory import card
   - Add result dialog state
   - Test end-to-end CSV import workflow

4. **Phase 4 - Testing & Documentation** (2 hours):
   - Write tests for createInitialTransaction service
   - Write tests for API endpoints
   - Write tests for CSV import with various edge cases
   - Update API documentation if exists

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Issue Parsing | 2m |
| Codebase Exploration | 8m |
| Pattern Identification | 5m |
| Report Writing | 10m |
| **Total** | **25m** |
