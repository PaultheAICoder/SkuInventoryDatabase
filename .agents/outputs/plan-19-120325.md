# Implementation Plan: Reorder View Lead-Time Hints and Prioritized List

**Generated**: 2025-12-03T16:30:00Z
**Task ID**: Issue #19
**Estimated Build Time**: 4-6 hours
**Complexity**: Low to Medium

## Executive Summary

This feature enhances the existing CriticalComponentsList on the dashboard with lead-time-based urgency hints and improved sorting. The implementation adds a "Lead Time" column, generates contextual hint text (e.g., "Order soon (X days lead time)"), and sorts critical components by urgency score that factors in both deficit ratio and lead time. All required data (leadTimeDays) already exists in the database schema.

---

## Ripple Effect Validation

### Verified Counts
- `CriticalComponentsList` references: 4 files (matches Scout)
- `criticalComponents` references: 6 files (matches Scout)
- `calculateReorderStatus` callers: Not modified (no signature change)

### Files Confirmed
Scout's file list verified - no additional files discovered.

---

## Schema Verification (COMPLETED)

### Verified Fields
- **Prisma Schema** (line 103): `leadTimeDays Int @default(0)` - EXISTS
- **Dashboard API** (line 82-90): Currently selects `id, name, skuCode, reorderPoint` - MISSING leadTimeDays
- **CriticalComponent Interface** (line 14-21): Currently has `id, name, skuCode, quantityOnHand, reorderPoint, reorderStatus` - MISSING leadTimeDays

### Column Naming
- Field name: `leadTimeDays` (camelCase) - consistent across schema and types

---

## Phase 0: No Code Untangling Needed

Scout did not flag any complex code requiring pre-work. The existing patterns are straightforward.

---

## Phase 1: Backend Enhancement

### Subtask 1.1: Add leadTimeDays to Dashboard API Response

**File**: `/home/pbrown/SkuInventory/src/app/api/dashboard/route.ts`

**Pattern Reference**: Existing component selection at line 82-90

**Current Code** (lines 82-90):
```typescript
const components = await prisma.component.findMany({
  where: { brandId, isActive: true },
  select: {
    id: true,
    name: true,
    skuCode: true,
    reorderPoint: true,
  },
})
```

**Instructions**:
1. Add `leadTimeDays: true` to the select statement
2. Update `DashboardResponse` interface (line 17-24) to include `leadTimeDays: number` in criticalComponents array

**Updated Code**:
```typescript
// Line 17-24: Update interface
criticalComponents: Array<{
  id: string
  name: string
  skuCode: string
  quantityOnHand: number
  reorderPoint: number
  leadTimeDays: number  // ADD THIS
  reorderStatus: ReorderStatus
}>

// Line 82-90: Update select
const components = await prisma.component.findMany({
  where: { brandId, isActive: true },
  select: {
    id: true,
    name: true,
    skuCode: true,
    reorderPoint: true,
    leadTimeDays: true,  // ADD THIS
  },
})
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] TypeScript compiles without errors
- [ ] API endpoint returns leadTimeDays in criticalComponents array
- [ ] No build warnings

---

### Subtask 1.2: Implement Urgency Sorting in Dashboard API

**File**: `/home/pbrown/SkuInventory/src/app/api/dashboard/route.ts`

**Pattern Reference**: Existing sort at lines 127-131

**Current Code** (lines 125-132):
```typescript
const criticalComponents = componentsWithStatus
  .filter((c) => c.reorderStatus === 'critical')
  .sort((a, b) => {
    const aDeficit = a.reorderPoint - a.quantityOnHand
    const bDeficit = b.reorderPoint - b.quantityOnHand
    return bDeficit - aDeficit
  })
  .slice(0, 10)
```

**Instructions**:
1. Replace simple deficit sort with urgency score sort
2. Urgency score formula: `(deficitRatio * 100) + (leadTimeDays * 2)`
   - deficitRatio = deficit / max(reorderPoint, 1)
   - Higher lead time = more urgent
   - Higher deficit ratio = more urgent

**Updated Code**:
```typescript
// Helper function (add before GET handler or inline)
function calculateUrgencyScore(
  quantityOnHand: number,
  reorderPoint: number,
  leadTimeDays: number
): number {
  const deficit = reorderPoint - quantityOnHand
  const deficitRatio = deficit / Math.max(reorderPoint, 1)
  // Combine deficit ratio (primary) with lead time factor (secondary)
  // Lead time weighted at 2 points per day to influence ordering
  return (deficitRatio * 100) + (leadTimeDays * 2)
}

// Updated sort (lines 125-132)
const criticalComponents = componentsWithStatus
  .filter((c) => c.reorderStatus === 'critical')
  .sort((a, b) => {
    const aUrgency = calculateUrgencyScore(a.quantityOnHand, a.reorderPoint, a.leadTimeDays)
    const bUrgency = calculateUrgencyScore(b.quantityOnHand, b.reorderPoint, b.leadTimeDays)
    return bUrgency - aUrgency  // Higher urgency first
  })
  .slice(0, 10)
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Components sorted by urgency score (higher first)
- [ ] Critical components with longer lead times appear higher in list
- [ ] TypeScript compiles without errors

---

## Phase 2: Frontend Type Updates

### Subtask 2.1: Update DashboardData Type in Dashboard Page

**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/page.tsx`

**Pattern Reference**: Existing type at lines 27-34

**Current Code** (lines 27-34):
```typescript
criticalComponents: Array<{
  id: string
  name: string
  skuCode: string
  quantityOnHand: number
  reorderPoint: number
  reorderStatus: ReorderStatus
}>
```

**Instructions**:
1. Add `leadTimeDays: number` to the criticalComponents array type

**Updated Code**:
```typescript
criticalComponents: Array<{
  id: string
  name: string
  skuCode: string
  quantityOnHand: number
  reorderPoint: number
  leadTimeDays: number  // ADD THIS
  reorderStatus: ReorderStatus
}>
```

**Validation Commands**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Type matches API response
- [ ] TypeScript compiles without errors

---

## Phase 3: UI Component Enhancement

### Subtask 3.1: Update CriticalComponent Interface

**File**: `/home/pbrown/SkuInventory/src/components/features/CriticalComponentsList.tsx`

**Pattern Reference**: Existing interface at lines 14-21

**Current Code** (lines 14-21):
```typescript
interface CriticalComponent {
  id: string
  name: string
  skuCode: string
  quantityOnHand: number
  reorderPoint: number
  reorderStatus: ReorderStatus
}
```

**Instructions**:
1. Add `leadTimeDays: number` to interface

**Updated Code**:
```typescript
interface CriticalComponent {
  id: string
  name: string
  skuCode: string
  quantityOnHand: number
  reorderPoint: number
  leadTimeDays: number  // ADD THIS
  reorderStatus: ReorderStatus
}
```

**Completion Criteria**:
- [ ] Interface includes leadTimeDays
- [ ] TypeScript compiles

---

### Subtask 3.2: Add Lead Time Hint Generator Function

**File**: `/home/pbrown/SkuInventory/src/components/features/CriticalComponentsList.tsx`

**Instructions**:
1. Add helper function before the component definition
2. Generate contextual hint text based on status and lead time

**Code to Add** (after imports, before interface):
```typescript
/**
 * Generate lead-time urgency hint text based on reorder status and lead time
 */
function getLeadTimeHint(status: ReorderStatus, leadTimeDays: number): string {
  if (status === 'ok') {
    return ''  // No hint needed for OK status
  }

  if (leadTimeDays === 0) {
    return status === 'critical' ? 'Order immediately' : 'Monitor stock'
  }

  if (leadTimeDays <= 3) {
    return status === 'critical'
      ? 'Order immediately'
      : `Monitor (${leadTimeDays}d lead time)`
  }

  if (leadTimeDays <= 7) {
    return `Order soon (${leadTimeDays} days lead time)`
  }

  if (leadTimeDays <= 14) {
    return `Order within 1 week (${leadTimeDays} days lead time)`
  }

  const weeks = Math.ceil(leadTimeDays / 7)
  return `Order urgently (${weeks} weeks lead time)`
}
```

**Completion Criteria**:
- [ ] Function returns appropriate hint text for each scenario
- [ ] Handles edge cases (0 lead time, very long lead time)

---

### Subtask 3.3: Add Lead Time Column and Hint Display

**File**: `/home/pbrown/SkuInventory/src/components/features/CriticalComponentsList.tsx`

**Pattern Reference**: Existing table structure at lines 51-93

**Instructions**:
1. Add "Lead Time" table header after "Deficit"
2. Add "Action" table header after "Status" for hint text
3. Add corresponding table cells in the row mapping

**Current Table Header** (lines 52-59):
```typescript
<TableHeader>
  <TableRow>
    <TableHead>Component</TableHead>
    <TableHead className="text-right">On Hand</TableHead>
    <TableHead className="text-right">Reorder Point</TableHead>
    <TableHead className="text-right">Deficit</TableHead>
    <TableHead>Status</TableHead>
  </TableRow>
</TableHeader>
```

**Updated Table Header**:
```typescript
<TableHeader>
  <TableRow>
    <TableHead>Component</TableHead>
    <TableHead className="text-right">On Hand</TableHead>
    <TableHead className="text-right">Reorder Point</TableHead>
    <TableHead className="text-right">Deficit</TableHead>
    <TableHead className="text-right">Lead Time</TableHead>
    <TableHead>Status</TableHead>
    <TableHead>Action</TableHead>
  </TableRow>
</TableHeader>
```

**Updated Row Mapping** (add inside map after Status cell):
```typescript
{components.map((component) => {
  const deficit = component.reorderPoint - component.quantityOnHand
  const hint = getLeadTimeHint(component.reorderStatus, component.leadTimeDays)
  return (
    <TableRow key={component.id}>
      {/* ... existing cells ... */}
      <TableCell className="text-right font-mono text-red-600" suppressHydrationWarning>
        -{deficit.toLocaleString()}
      </TableCell>
      {/* NEW: Lead Time cell */}
      <TableCell className="text-right font-mono" suppressHydrationWarning>
        {component.leadTimeDays > 0 ? `${component.leadTimeDays}d` : '-'}
      </TableCell>
      <TableCell>
        <ReorderStatusBadge status={component.reorderStatus} />
      </TableCell>
      {/* NEW: Action/Hint cell */}
      <TableCell className="text-sm text-muted-foreground whitespace-nowrap">
        {hint}
      </TableCell>
    </TableRow>
  )
})}
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
npm run lint
```

**Completion Criteria**:
- [ ] Lead Time column displays correctly
- [ ] Action column shows appropriate hint text
- [ ] Table renders without layout issues
- [ ] No TypeScript errors
- [ ] No lint warnings

---

## Phase 4: Testing

### Subtask 4.1: Create Unit Tests for Lead Time Hints and Urgency Sorting

**File**: `/home/pbrown/SkuInventory/tests/unit/reorder-urgency.test.ts` (NEW FILE)

**Pattern Reference**: `/home/pbrown/SkuInventory/tests/unit/inventory-service.test.ts`

**Instructions**:
1. Create new test file following existing patterns
2. Test hint generation for all scenarios
3. Test urgency score calculation

**Test File Content**:
```typescript
import { describe, it, expect } from 'vitest'

/**
 * Tests for reorder urgency features (Issue #19)
 * - Lead time hint generation
 * - Urgency score calculation for sorting
 */

// Re-implement the functions here for unit testing
// (or export them from a shared utils file)

function getLeadTimeHint(status: 'critical' | 'warning' | 'ok', leadTimeDays: number): string {
  if (status === 'ok') {
    return ''
  }

  if (leadTimeDays === 0) {
    return status === 'critical' ? 'Order immediately' : 'Monitor stock'
  }

  if (leadTimeDays <= 3) {
    return status === 'critical'
      ? 'Order immediately'
      : `Monitor (${leadTimeDays}d lead time)`
  }

  if (leadTimeDays <= 7) {
    return `Order soon (${leadTimeDays} days lead time)`
  }

  if (leadTimeDays <= 14) {
    return `Order within 1 week (${leadTimeDays} days lead time)`
  }

  const weeks = Math.ceil(leadTimeDays / 7)
  return `Order urgently (${weeks} weeks lead time)`
}

function calculateUrgencyScore(
  quantityOnHand: number,
  reorderPoint: number,
  leadTimeDays: number
): number {
  const deficit = reorderPoint - quantityOnHand
  const deficitRatio = deficit / Math.max(reorderPoint, 1)
  return (deficitRatio * 100) + (leadTimeDays * 2)
}

describe('getLeadTimeHint', () => {
  describe('critical status', () => {
    it('returns "Order immediately" for 0 lead time', () => {
      expect(getLeadTimeHint('critical', 0)).toBe('Order immediately')
    })

    it('returns "Order immediately" for 1-3 day lead time', () => {
      expect(getLeadTimeHint('critical', 1)).toBe('Order immediately')
      expect(getLeadTimeHint('critical', 3)).toBe('Order immediately')
    })

    it('returns "Order soon" for 4-7 day lead time', () => {
      expect(getLeadTimeHint('critical', 5)).toBe('Order soon (5 days lead time)')
      expect(getLeadTimeHint('critical', 7)).toBe('Order soon (7 days lead time)')
    })

    it('returns "Order within 1 week" for 8-14 day lead time', () => {
      expect(getLeadTimeHint('critical', 10)).toBe('Order within 1 week (10 days lead time)')
      expect(getLeadTimeHint('critical', 14)).toBe('Order within 1 week (14 days lead time)')
    })

    it('returns "Order urgently" with weeks for 15+ day lead time', () => {
      expect(getLeadTimeHint('critical', 15)).toBe('Order urgently (3 weeks lead time)')
      expect(getLeadTimeHint('critical', 21)).toBe('Order urgently (3 weeks lead time)')
      expect(getLeadTimeHint('critical', 28)).toBe('Order urgently (4 weeks lead time)')
    })
  })

  describe('warning status', () => {
    it('returns "Monitor stock" for 0 lead time', () => {
      expect(getLeadTimeHint('warning', 0)).toBe('Monitor stock')
    })

    it('returns "Monitor" with lead time for 1-3 days', () => {
      expect(getLeadTimeHint('warning', 2)).toBe('Monitor (2d lead time)')
    })

    it('returns same hints as critical for 4+ day lead time', () => {
      expect(getLeadTimeHint('warning', 5)).toBe('Order soon (5 days lead time)')
    })
  })

  describe('ok status', () => {
    it('returns empty string for any lead time', () => {
      expect(getLeadTimeHint('ok', 0)).toBe('')
      expect(getLeadTimeHint('ok', 10)).toBe('')
      expect(getLeadTimeHint('ok', 30)).toBe('')
    })
  })
})

describe('calculateUrgencyScore', () => {
  describe('deficit ratio component', () => {
    it('calculates higher score for larger deficit', () => {
      // Same lead time, different deficits
      const score1 = calculateUrgencyScore(5, 10, 7)  // 50% deficit
      const score2 = calculateUrgencyScore(2, 10, 7)  // 80% deficit
      expect(score2).toBeGreaterThan(score1)
    })

    it('handles zero reorder point without division error', () => {
      const score = calculateUrgencyScore(5, 0, 7)
      expect(score).toBe(14)  // 0 deficit ratio + 7*2 lead time
    })

    it('handles negative quantity (below zero)', () => {
      const score = calculateUrgencyScore(-5, 10, 7)
      expect(score).toBeGreaterThan(calculateUrgencyScore(5, 10, 7))
    })
  })

  describe('lead time component', () => {
    it('calculates higher score for longer lead time', () => {
      // Same deficit, different lead times
      const score1 = calculateUrgencyScore(5, 10, 7)   // 7 days
      const score2 = calculateUrgencyScore(5, 10, 14)  // 14 days
      expect(score2).toBeGreaterThan(score1)
    })

    it('handles zero lead time', () => {
      const score = calculateUrgencyScore(5, 10, 0)
      expect(score).toBe(50)  // 50% deficit * 100 + 0
    })
  })

  describe('combined scoring', () => {
    it('prioritizes high deficit + long lead time', () => {
      const highUrgency = calculateUrgencyScore(0, 100, 30)   // 100% deficit + 30 days
      const mediumUrgency = calculateUrgencyScore(50, 100, 7) // 50% deficit + 7 days
      const lowUrgency = calculateUrgencyScore(90, 100, 0)    // 10% deficit + 0 days

      expect(highUrgency).toBeGreaterThan(mediumUrgency)
      expect(mediumUrgency).toBeGreaterThan(lowUrgency)
    })

    it('breaks tie on lead time when deficit is equal', () => {
      const longerLead = calculateUrgencyScore(5, 10, 14)
      const shorterLead = calculateUrgencyScore(5, 10, 7)
      expect(longerLead).toBeGreaterThan(shorterLead)
    })
  })
})

describe('urgency sorting order', () => {
  it('sorts components correctly by urgency', () => {
    const components = [
      { name: 'A', quantityOnHand: 90, reorderPoint: 100, leadTimeDays: 0 },   // 10% deficit, 0 days
      { name: 'B', quantityOnHand: 0, reorderPoint: 100, leadTimeDays: 30 },   // 100% deficit, 30 days
      { name: 'C', quantityOnHand: 50, reorderPoint: 100, leadTimeDays: 7 },   // 50% deficit, 7 days
    ]

    const sorted = [...components].sort((a, b) => {
      const aScore = calculateUrgencyScore(a.quantityOnHand, a.reorderPoint, a.leadTimeDays)
      const bScore = calculateUrgencyScore(b.quantityOnHand, b.reorderPoint, b.leadTimeDays)
      return bScore - aScore  // Higher urgency first
    })

    expect(sorted[0].name).toBe('B')  // Highest urgency
    expect(sorted[1].name).toBe('C')  // Medium urgency
    expect(sorted[2].name).toBe('A')  // Lowest urgency
  })
})
```

**Validation Commands**:
```bash
npm test -- --testPathPattern="reorder-urgency"
```

**Completion Criteria**:
- [ ] All tests pass
- [ ] Tests cover hint generation edge cases
- [ ] Tests verify urgency sorting order

---

## Phase 5: Integration Verification

### Subtask 5.1: Verify Full Stack Integration

**Instructions**:
1. Start development server
2. Navigate to dashboard
3. Verify critical components list shows:
   - Lead Time column with days or dash
   - Action column with hint text
   - Correct sorting (most urgent first)

**Validation Commands**:
```bash
npm run dev
# Then verify in browser at http://172.16.20.50:4545
```

**Manual Test Cases**:
1. Verify Lead Time column displays:
   - "Xd" for components with lead time > 0
   - "-" for components with lead time = 0
2. Verify Action column displays hint text
3. Verify components are sorted by urgency (not just deficit)
4. Verify hint text matches expected values:
   - Critical + 0 days: "Order immediately"
   - Critical + 7 days: "Order soon (7 days lead time)"
   - Critical + 14 days: "Order within 1 week (14 days lead time)"

**Completion Criteria**:
- [ ] UI displays correctly
- [ ] Sorting reflects urgency score
- [ ] Hint text is contextual and helpful
- [ ] No console errors
- [ ] Responsive layout maintained

---

## Summary of Deliverables

### Files Created (1)
| Type | File |
|------|------|
| Test | `/home/pbrown/SkuInventory/tests/unit/reorder-urgency.test.ts` |

### Files Modified (3)
| File | Changes |
|------|---------|
| `/home/pbrown/SkuInventory/src/app/api/dashboard/route.ts` | Add leadTimeDays to select, update response interface, add urgency sorting |
| `/home/pbrown/SkuInventory/src/app/(dashboard)/page.tsx` | Update DashboardData type to include leadTimeDays |
| `/home/pbrown/SkuInventory/src/components/features/CriticalComponentsList.tsx` | Add interface field, hint function, Lead Time column, Action column |

---

## Handoff to Build Agent

### Execution Order
1. **Execute Phase 1 (Backend)** first - API must return leadTimeDays before frontend can use it
2. **Execute Phase 2 (Types)** - Update frontend types to match API
3. **Execute Phase 3 (UI)** - Add columns and hint display
4. **Execute Phase 4 (Tests)** - Write and run unit tests
5. **Execute Phase 5 (Verify)** - Manual integration check

### Critical Notes
1. **Order matters**: Backend changes must be deployed before frontend can consume them
2. **Type safety**: Ensure all interfaces match between API response and component props
3. **Testing**: Run `npm run build` after each phase to catch type errors early
4. **Urgency formula**: The formula `(deficitRatio * 100) + (leadTimeDays * 2)` can be tuned if needed

### Commands to Run After Each Phase
```bash
npx tsc --noEmit
npm run build
npm run lint
npm test -- --testPathPattern="reorder-urgency|inventory"
```

---

## Acceptance Criteria Mapping

| AC | Description | Implementation | Verification |
|----|-------------|----------------|--------------|
| AC1 | Warning/Critical components appear in prioritized reorder view with lead-time hint text | Phase 3: CriticalComponentsList shows leadTimeDays column and Action column with contextual hints | Manual: Check dashboard shows Lead Time and Action columns |
| AC2 | Sorting reflects urgency (deficit magnitude + lead time) | Phase 1.2: Urgency score = (deficitRatio * 100) + (leadTimeDays * 2) | Test: Verify sort order in unit tests |
| AC3 | Filters work | No changes needed - existing dashboard time filter preserved | Manual: Verify time filter still works |
| AC4 | Tests cover hint generation and ordering logic | Phase 4: Unit tests for getLeadTimeHint and calculateUrgencyScore | `npm test -- --testPathPattern="reorder-urgency"` |

---

## Performance Metrics

| Phase | Duration |
|-------|----------|
| Scout Review | 5m |
| Pattern Research | 8m |
| Schema Verification | 3m |
| Plan Writing | 15m |
| **Total** | **31m** |

---

AGENT_RETURN: plan-19-120325
