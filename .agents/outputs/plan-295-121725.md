# Implementation Plan
**Generated**: 2025-12-17T12:00:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #295
**Estimated Build Time**: 2-3 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Bug
**Source**: GitHub Issue #295
**Priority**: Critical

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="user*companies"` or None (no existing tests for this route)

### Issue Validation
**Status**: Valid
**Recent Changes**:
- `b82738a` refactor(issue #224): remove User.companyId database column (Phase 3)
- `9c8658b` refactor(issue #223): use UserCompany exclusively in auth.ts (Phase 2)
- `a79df87` feat(issue #214): Phase 1 - add isPrimary to UserCompany
- `5bec8ca` feat(issue #94): add user-company assignment UI and API

The bug was introduced when this route was created (issue #94) and persisted through subsequent refactoring. The logic at line 169 hardcodes role assignment based on primary company status only.

### Current State Assessment
- **Existing components**:
  - Route handler: `/home/pbrown/SkuInventory/src/app/api/users/[id]/companies/route.ts` (contains the bug)
  - Schema: `updateUserCompaniesSchema` in `/home/pbrown/SkuInventory/src/types/user.ts` (only accepts companyIds array)
  - UI Component: `/home/pbrown/SkuInventory/src/components/features/CompanyAssignment.tsx` (checkbox-based)
  - Edit Page: `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/users/[id]/edit/page.tsx`
- **Database**: `UserCompany` model with `role` field (enum: admin, ops, viewer)
- **API Routes**: PUT `/api/users/[id]/companies` - deletes all and recreates with hardcoded roles
- **Types**: `UserCompanyAssignment` interface includes role field

### The Bug
In `/home/pbrown/SkuInventory/src/app/api/users/[id]/companies/route.ts` at line 169:
```typescript
role: userPrimaryCompanyId === companyId ? UserRole.admin : UserRole.ops,
```

This line assigns roles based solely on whether the company is the user's primary company:
- Primary company -> admin role
- Non-primary company -> ops role (hardcoded)

This ignores any existing `admin` or `viewer` roles the user may have had for non-primary companies.

### Dependencies & Blockers
1. None - this is an isolated bug fix in a single API route

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Simple
**Effort**: 2-3 hours
**Risk**: Low - single file change with clear fix approach

### Patterns Identified
**Primary**: `/home/pbrown/SkuInventory/src/app/api/users/[id]/companies/route.ts` - current route structure
**Secondary**: `/home/pbrown/SkuInventory/tests/integration/settings.test.ts` - test pattern for API routes

### Ripple Effect Analysis
**Files Identified**: 1 (the fix is isolated)
- `/home/pbrown/SkuInventory/src/app/api/users/[id]/companies/route.ts` - route to fix

**UI Impact**: None - the UI already displays roles correctly and calls this API with companyIds only
**Schema Impact**: None - current schema is sufficient (we preserve existing roles, not accept new ones)

---

## Executive Summary
Fix the PUT `/api/users/[id]/companies` route to preserve existing UserCompany roles instead of hardcoding them. The fix involves fetching existing roles before deletion and reapplying them when recreating records. Add regression tests to verify role preservation.

## Phase 1: Fix API Route

### Subtask 1.1: Preserve existing roles in PUT handler
**File**: `/home/pbrown/SkuInventory/src/app/api/users/[id]/companies/route.ts`
**Pattern**: Existing transaction structure in same file
**Instructions**:

1. Inside the `$transaction` block (starting at line 146), BEFORE deleting UserCompany records, fetch ALL existing UserCompany records for the user to capture their roles:
```typescript
// Fetch existing roles before deletion
const existingUserCompanies = await tx.userCompany.findMany({
  where: { userId: id },
  select: { companyId: true, role: true },
})
// Create a map of companyId -> role for lookup
const existingRoles = new Map(
  existingUserCompanies.map((uc) => [uc.companyId, uc.role])
)
```

2. Modify the `userCompanyRecords` mapping (around line 166-171) to use the preserved role if available, defaulting to `ops` for new companies:
```typescript
const userCompanyRecords = companyIds.map((companyId) => ({
  userId: id,
  companyId,
  // Preserve existing role, default to 'ops' for newly assigned companies
  role: existingRoles.get(companyId) ?? UserRole.ops,
  isPrimary: companyId === newPrimaryCompanyId,
}))
```

3. Remove the now-unused `userPrimaryCompanyId` variable assignment (line 157-158) as it's no longer needed.

**Validation commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] TypeScript compiles without errors
- [ ] Build completes successfully
- [ ] Existing roles are fetched before deletion
- [ ] Roles are preserved when recreating UserCompany records
- [ ] New company assignments default to 'ops' role

## Phase 2: Add Regression Tests

### Subtask 2.1: Create user companies integration test file
**File**: `/home/pbrown/SkuInventory/tests/integration/user-companies.test.ts`
**Pattern**: Follow `/home/pbrown/SkuInventory/tests/integration/settings.test.ts`
**Instructions**:

1. Create a new test file with the following structure:
```typescript
/**
 * Integration tests for User Company Assignments
 * Tests role preservation when updating company assignments
 */
import { describe, it, expect, beforeAll, beforeEach, afterAll } from 'vitest'
import { setTestSession, clearTestSession, TEST_SESSIONS, initializeTestSessions } from '../helpers/auth-mock'
import {
  getIntegrationPrisma,
  cleanupBeforeTest,
  createTestRequest,
  parseRouteResponse,
} from '../helpers/integration-context'
import { disconnectTestDb } from '../helpers/db'

// Import route handlers directly
import { GET, PUT } from '@/app/api/users/[id]/companies/route'

describe('User Company Assignments', () => {
  let testUserId: string
  let secondCompanyId: string
  let thirdCompanyId: string

  beforeAll(async () => {
    const prisma = getIntegrationPrisma()
    await initializeTestSessions(prisma)
  })

  beforeEach(async () => {
    await cleanupBeforeTest()
    clearTestSession()

    // Create test user and additional companies for testing
    const prisma = getIntegrationPrisma()
    // ... setup code
  })

  afterAll(async () => {
    await disconnectTestDb()
  })

  describe('PUT /api/users/[id]/companies - Role Preservation', () => {
    it('preserves admin role when adding new company', async () => {
      // Test that existing admin role on Company A is preserved when adding Company B
    })

    it('preserves admin role for non-primary companies', async () => {
      // Test that admin role on non-primary company is NOT downgraded to ops
    })

    it('preserves viewer role when updating companies', async () => {
      // Test that viewer role is preserved
    })

    it('assigns default ops role to newly added companies', async () => {
      // Test that new companies get ops role by default
    })

    it('preserves roles when removing and re-adding companies', async () => {
      // Test role preservation through add/remove cycles
    })
  })
})
```

2. Key test scenarios:
   - User with admin role on Company A (primary) and admin role on Company B
   - Update to add Company C -> Company B should retain admin role
   - User with admin on Company A, viewer on Company B -> viewer should be preserved
   - New company added -> should default to ops role

**Validation commands**:
```bash
npm test -- --testPathPattern="user-companies"
```

**Completion Criteria**:
- [ ] Test file created following project patterns
- [ ] Test for admin role preservation on non-primary company
- [ ] Test for new company defaulting to ops
- [ ] All tests pass

---

## Summary of Deliverables
**Files Created**: 1
- `/home/pbrown/SkuInventory/tests/integration/user-companies.test.ts`

**Files Modified**: 1
- `/home/pbrown/SkuInventory/src/app/api/users/[id]/companies/route.ts`

## Handoff to Build Agent
1. Execute subtasks in exact order
2. Phase 1 modifies the route handler - test manually or with TypeScript check
3. Phase 2 adds regression tests - run tests after creation
4. Verify all completion criteria before marking complete

## Test Strategy Note
- Use Vitest for integration tests
- Follow existing test patterns in `tests/integration/`
- Use `setTestSession`, `TEST_SESSIONS` for auth mocking
- Use `createTestRequest`, `parseRouteResponse` for route testing

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 10m |
| **Total** | **30m** |
