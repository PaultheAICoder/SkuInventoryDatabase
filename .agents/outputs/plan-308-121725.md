# Implementation Plan
**Generated**: 2025-12-17T20:30:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: Issue #308 - Implement Soft Deletes for Transaction Drafts
**Estimated Build Time**: 4-6 hours
**Complexity**: Medium

## Investigation Summary

### Request Analysis
**Type**: Feature Enhancement
**Source**: GitHub Issue #308
**Priority**: Medium

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="draft"` for targeted tests

### Issue Validation
**Status**: Valid
**Recent Changes**: No recent changes to the draft deletion logic. Last schema change to Transaction was for BOM snapshot (issue #297).

### Current State Assessment

**Existing Components:**
- `prisma/schema.prisma`: Transaction model exists at line 289, has `status` field but NO soft delete fields (`deletedAt`, `deletedById`)
- `src/services/draft-transaction.ts`: Contains `deleteDraftTransaction` function at line 363 that performs hard delete via `prisma.transaction.delete()`
- `src/app/api/transactions/drafts/[id]/route.ts`: DELETE endpoint that calls `deleteDraftTransaction`
- `src/types/draft.ts`: Draft type definitions - will need update to include delete info in response

**Database:**
- Transaction model has `status` enum: `draft`, `approved`, `rejected`
- NO existing soft delete pattern in the codebase (searched for `deletedAt`, `deletedById`, `isDeleted` - none found)
- Will need schema migration to add `deletedAt` and `deletedById` fields

**API Routes:**
- DELETE `/api/transactions/drafts/[id]` - Currently returns `{ message: 'Draft deleted successfully' }`
- GET `/api/transactions/drafts` - Filters by `status: 'draft'` - will need additional filter for `deletedAt IS NULL`
- GET `/api/transactions/drafts/count` - Same filter needed

**Types:**
- `DraftTransactionResponse` in `src/types/draft.ts` - will need `deletedAt` and `deletedBy` fields for audit visibility

### Dependencies & Blockers
1. No blockers identified
2. Database migration required - MUST run on TEST environment only

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Medium
**Effort**: 4-6 hours
**Risk**: Low - isolated change to draft functionality, existing patterns for audit fields exist

### Patterns Identified

**Primary Pattern**: Transaction model audit fields
- File: `prisma/schema.prisma` lines 315-323
- Pattern: `reviewedAt`, `reviewedById`, `reviewedBy` relation - follow same pattern for `deletedAt`, `deletedById`, `deletedBy`

**Secondary Pattern**: User relation naming convention
- File: `prisma/schema.prisma` lines 137-138
- Pattern: User has `transactionsReviewed Transaction[] @relation("TransactionReviewedBy")` - add similar `transactionsDeleted Transaction[] @relation("TransactionDeletedBy")`

### Ripple Effect Analysis

**Files to Modify**: 6 files
1. `prisma/schema.prisma` - Add `deletedAt` and `deletedById` fields to Transaction model, add relation to User
2. `src/services/draft-transaction.ts` - Update `deleteDraftTransaction`, `getDraftTransactions`, `getDraftCount` to handle soft deletes
3. `src/app/api/transactions/drafts/[id]/route.ts` - Pass `userId` to delete function
4. `src/types/draft.ts` - Add `deletedAt` and `deletedBy` to `DraftTransactionResponse`
5. `tests/integration/drafts.test.ts` - Add tests for soft delete behavior
6. NEW migration file in `prisma/migrations/` - Add soft delete columns

**No UI Changes Required**: The existing DraftTransactionList component only shows drafts with status='draft', and soft-deleted items will be filtered at the query level.

---

## Executive Summary

This plan implements soft deletes for draft transactions by adding `deletedAt` (timestamp) and `deletedById` (user FK) fields to the Transaction model. Instead of permanently erasing draft records, the `deleteDraftTransaction` function will set the `deletedAt` timestamp. All draft queries will be updated to exclude soft-deleted records (`deletedAt IS NULL`). This enables compliance officers to audit who deleted draft transactions and when.

---

## Phase 1: Database Schema Layer

### Subtask 1.1: Update Prisma Schema with Soft Delete Fields

**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Pattern**: Follow existing `reviewedAt`/`reviewedById` pattern at lines 321-323
**Instructions**:

1. Add soft delete fields to the Transaction model (after line 324, before `bomSnapshot`):

```prisma
  // Soft delete fields for audit trail
  deletedAt    DateTime?
  deletedById  String?
  deletedBy    User?             @relation("TransactionDeletedBy", fields: [deletedById], references: [id])
```

2. Add the reverse relation to the User model (after line 138, after `transactionsReviewed`):

```prisma
  // Soft delete audit relation
  transactionsDeleted  Transaction[] @relation("TransactionDeletedBy")
```

3. Add an index for efficient soft delete filtering (after line 344):

```prisma
  @@index([companyId, status, deletedAt])
```

**Completion Criteria**:
- [ ] `deletedAt` field added with correct type (`DateTime?`)
- [ ] `deletedById` field added with correct type (`String?`)
- [ ] `deletedBy` relation added with correct name (`"TransactionDeletedBy"`)
- [ ] User model has reverse relation `transactionsDeleted`
- [ ] Index added for query optimization
- [ ] No Prisma schema validation errors: `npx prisma validate`

### Subtask 1.2: Create Database Migration

**File**: `/home/pbrown/SkuInventory/prisma/migrations/[timestamp]_add_soft_delete_to_transaction/migration.sql`
**Instructions**:

1. Generate migration for test environment:
```bash
DATABASE_URL="postgresql://inventory_test:inventory_test_2025@localhost:2346/inventory_test" npx prisma migrate dev --name add_soft_delete_to_transaction
```

2. Verify migration SQL contains:
```sql
ALTER TABLE "Transaction" ADD COLUMN "deletedAt" TIMESTAMP(3);
ALTER TABLE "Transaction" ADD COLUMN "deletedById" TEXT;
ALTER TABLE "Transaction" ADD CONSTRAINT "Transaction_deletedById_fkey" FOREIGN KEY ("deletedById") REFERENCES "User"("id") ON DELETE SET NULL ON UPDATE CASCADE;
CREATE INDEX "Transaction_companyId_status_deletedAt_idx" ON "Transaction"("companyId", "status", "deletedAt");
```

3. Generate Prisma client:
```bash
npx prisma generate
```

**Completion Criteria**:
- [ ] Migration file created
- [ ] Migration runs successfully on test database
- [ ] Prisma client regenerated
- [ ] `npx tsc --noEmit` passes

---

## Phase 2: TypeScript Types Layer

### Subtask 2.1: Update DraftTransactionResponse Type

**File**: `/home/pbrown/SkuInventory/src/types/draft.ts`
**Pattern**: Follow existing `reviewedAt`/`reviewedBy` pattern at lines 158-159
**Instructions**:

1. Add soft delete fields to `DraftTransactionResponse` interface (after line 159, after `reviewedBy`):

```typescript
  deletedAt: string | null
  deletedBy: { id: string; name: string } | null
```

**Completion Criteria**:
- [ ] `deletedAt` field added with type `string | null`
- [ ] `deletedBy` field added with type `{ id: string; name: string } | null`
- [ ] `npx tsc --noEmit` passes

---

## Phase 3: Service Layer

### Subtask 3.1: Update deleteDraftTransaction to Soft Delete

**File**: `/home/pbrown/SkuInventory/src/services/draft-transaction.ts`
**Pattern**: Follow existing `rejectDraftTransaction` pattern at lines 649-682
**Instructions**:

1. Update `deleteDraftTransaction` function signature to accept `deletedById` parameter:

```typescript
export async function deleteDraftTransaction(params: {
  id: string
  companyId: string
  deletedById: string  // NEW: required for audit trail
}): Promise<void> {
```

2. Replace the hard delete with a soft delete update (replace lines 382-385):

```typescript
  // Soft delete: set deletedAt timestamp and deletedById for audit trail
  await prisma.transaction.update({
    where: { id },
    data: {
      deletedAt: new Date(),
      deletedById,
    },
  })
```

**Completion Criteria**:
- [ ] Function signature updated with `deletedById` parameter
- [ ] Hard delete (`prisma.transaction.delete`) replaced with soft delete (`prisma.transaction.update` setting `deletedAt` and `deletedById`)
- [ ] `npx tsc --noEmit` passes

### Subtask 3.2: Update getDraftTransactions to Filter Out Soft-Deleted

**File**: `/home/pbrown/SkuInventory/src/services/draft-transaction.ts`
**Instructions**:

1. Update the `where` clause in `getDraftTransactions` function (around line 245) to exclude soft-deleted records:

```typescript
  const where: Prisma.TransactionWhereInput = {
    companyId,
    status,
    deletedAt: null,  // NEW: Exclude soft-deleted drafts
    ...(type && { type: type as Prisma.TransactionWhereInput['type'] }),
  }
```

**Completion Criteria**:
- [ ] `deletedAt: null` filter added to `where` clause
- [ ] Soft-deleted drafts no longer appear in list
- [ ] `npx tsc --noEmit` passes

### Subtask 3.3: Update getDraftCount to Filter Out Soft-Deleted

**File**: `/home/pbrown/SkuInventory/src/services/draft-transaction.ts`
**Instructions**:

1. Update the `where` clause in `getDraftCount` function (around line 296) to exclude soft-deleted records:

```typescript
export async function getDraftCount(companyId: string): Promise<number> {
  return prisma.transaction.count({
    where: {
      companyId,
      status: 'draft',
      deletedAt: null,  // NEW: Exclude soft-deleted drafts
    },
  })
}
```

**Completion Criteria**:
- [ ] `deletedAt: null` filter added to count query
- [ ] Count excludes soft-deleted drafts
- [ ] `npx tsc --noEmit` passes

### Subtask 3.4: Update getDraftTransaction to Filter Out Soft-Deleted

**File**: `/home/pbrown/SkuInventory/src/services/draft-transaction.ts`
**Instructions**:

1. Update the `where` clause in `getDraftTransaction` function (around line 277) to exclude soft-deleted records:

```typescript
  const transaction = await prisma.transaction.findFirst({
    where: {
      id,
      companyId,
      deletedAt: null,  // NEW: Exclude soft-deleted drafts
    },
    include: draftInclude,
  })
```

**Completion Criteria**:
- [ ] `deletedAt: null` filter added to single-record query
- [ ] Soft-deleted drafts return null (not found)
- [ ] `npx tsc --noEmit` passes

### Subtask 3.5: Update transformDraftTransaction to Include Soft Delete Fields

**File**: `/home/pbrown/SkuInventory/src/services/draft-transaction.ts`
**Instructions**:

1. Update the Prisma type in `transformDraftTransaction` function (around line 17) to include deleted fields:

```typescript
function transformDraftTransaction(tx: Prisma.TransactionGetPayload<{
  include: {
    sku: { select: { id: true; name: true } }
    bomVersion: { select: { id: true; versionName: true } }
    location: { select: { id: true; name: true } }
    fromLocation: { select: { id: true; name: true } }
    toLocation: { select: { id: true; name: true } }
    createdBy: { select: { id: true; name: true } }
    reviewedBy: { select: { id: true; name: true } }
    deletedBy: { select: { id: true; name: true } }  // NEW
    lines: {
      include: {
        component: { select: { id: true; name: true; skuCode: true } }
        lot: { select: { id: true; lotNumber: true; expiryDate: true } }
      }
    }
  }
}>): DraftTransactionResponse {
```

2. Add the soft delete fields to the return object (after `reviewedBy`, around line 57):

```typescript
    deletedAt: tx.deletedAt?.toISOString() ?? null,
    deletedBy: tx.deletedBy,
```

3. Update the `draftInclude` constant (around line 76) to include `deletedBy`:

```typescript
const draftInclude = {
  sku: { select: { id: true, name: true } },
  bomVersion: { select: { id: true, versionName: true } },
  location: { select: { id: true, name: true } },
  fromLocation: { select: { id: true, name: true } },
  toLocation: { select: { id: true, name: true } },
  createdBy: { select: { id: true, name: true } },
  reviewedBy: { select: { id: true, name: true } },
  deletedBy: { select: { id: true, name: true } },  // NEW
  lines: {
    include: {
      component: { select: { id: true, name: true, skuCode: true } },
      lot: { select: { id: true, lotNumber: true, expiryDate: true } },
    },
  },
}
```

**Completion Criteria**:
- [ ] `deletedBy` added to Prisma include type
- [ ] `deletedAt` and `deletedBy` added to transform return
- [ ] `draftInclude` constant updated
- [ ] `npx tsc --noEmit` passes

---

## Phase 4: API Route Layer

### Subtask 4.1: Update DELETE Route to Pass User ID

**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/drafts/[id]/route.ts`
**Pattern**: Follow existing `session.user.id` usage in approve/reject routes
**Instructions**:

1. Update the DELETE handler (around line 133) to pass `deletedById`:

```typescript
    await deleteDraftTransaction({
      id,
      companyId: selectedCompanyId,
      deletedById: session.user.id,  // NEW: Pass user ID for audit
    })
```

**Completion Criteria**:
- [ ] `deletedById: session.user.id` passed to service function
- [ ] `npx tsc --noEmit` passes
- [ ] API returns same response format (backward compatible)

---

## Phase 5: Tests

### Subtask 5.1: Add Soft Delete Tests to drafts.test.ts

**File**: `/home/pbrown/SkuInventory/tests/integration/drafts.test.ts`
**Instructions**:

1. Add a new describe block for soft delete tests (after the existing batch approve tests):

```typescript
describe('Soft Delete - DELETE /api/transactions/drafts/[id]', () => {
  it('soft deletes draft instead of hard deleting', async () => {
    setTestSession(TEST_SESSIONS.admin!)
    const prisma = getIntegrationPrisma()
    const component = await createTestComponentInDb(TEST_SESSIONS.admin!.user.companyId)

    // Create a draft
    const createRequest = new Request('http://localhost/api/transactions/drafts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        type: 'receipt',
        date: toLocalDateString(new Date()),
        componentId: component.id,
        quantity: 100,
        supplier: 'Test Supplier',
      }),
    })
    const createResponse = await createDraft(createRequest as never)
    expect(createResponse.status).toBe(201)
    const { data: draft } = await createResponse.json()

    // Delete the draft
    const deleteRequest = createTestRequest(`/api/transactions/drafts/${draft.id}`)
    const params = { params: Promise.resolve({ id: draft.id }) }
    const deleteResponse = await deleteDraft(deleteRequest, params)

    expect(deleteResponse.status).toBe(200)

    // Verify soft delete: record still exists with deletedAt set
    const deletedRecord = await prisma.transaction.findUnique({
      where: { id: draft.id },
    })
    expect(deletedRecord).not.toBeNull()
    expect(deletedRecord!.deletedAt).not.toBeNull()
    expect(deletedRecord!.deletedById).toBe(TEST_SESSIONS.admin!.user.id)
  })

  it('excludes soft-deleted drafts from list', async () => {
    setTestSession(TEST_SESSIONS.admin!)
    const prisma = getIntegrationPrisma()
    const component = await createTestComponentInDb(TEST_SESSIONS.admin!.user.companyId)

    // Create and soft-delete a draft
    const createRequest = new Request('http://localhost/api/transactions/drafts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        type: 'receipt',
        date: toLocalDateString(new Date()),
        componentId: component.id,
        quantity: 50,
      }),
    })
    const createResponse = await createDraft(createRequest as never)
    const { data: draft } = await createResponse.json()

    // Soft delete it
    await prisma.transaction.update({
      where: { id: draft.id },
      data: {
        deletedAt: new Date(),
        deletedById: TEST_SESSIONS.admin!.user.id,
      },
    })

    // Fetch drafts list
    const listResponse = await getDrafts(createTestRequest('/api/transactions/drafts'))
    const { data: drafts } = await listResponse.json()

    // Soft-deleted draft should NOT appear in list
    expect(drafts.find((d: { id: string }) => d.id === draft.id)).toBeUndefined()
  })

  it('excludes soft-deleted drafts from count', async () => {
    setTestSession(TEST_SESSIONS.admin!)
    const prisma = getIntegrationPrisma()
    const component = await createTestComponentInDb(TEST_SESSIONS.admin!.user.companyId)

    // Get initial count
    const initialCountResponse = await getDraftCount(createTestRequest('/api/transactions/drafts/count'))
    const { count: initialCount } = await initialCountResponse.json()

    // Create a draft
    const createRequest = new Request('http://localhost/api/transactions/drafts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        type: 'receipt',
        date: toLocalDateString(new Date()),
        componentId: component.id,
        quantity: 25,
      }),
    })
    const createResponse = await createDraft(createRequest as never)
    const { data: draft } = await createResponse.json()

    // Verify count increased
    const afterCreateResponse = await getDraftCount(createTestRequest('/api/transactions/drafts/count'))
    const { count: afterCreateCount } = await afterCreateResponse.json()
    expect(afterCreateCount).toBe(initialCount + 1)

    // Soft delete it
    await prisma.transaction.update({
      where: { id: draft.id },
      data: {
        deletedAt: new Date(),
        deletedById: TEST_SESSIONS.admin!.user.id,
      },
    })

    // Verify count decreased
    const afterDeleteResponse = await getDraftCount(createTestRequest('/api/transactions/drafts/count'))
    const { count: afterDeleteCount } = await afterDeleteResponse.json()
    expect(afterDeleteCount).toBe(initialCount)
  })
})
```

**Completion Criteria**:
- [ ] Test for soft delete instead of hard delete
- [ ] Test for exclusion from draft list
- [ ] Test for exclusion from draft count
- [ ] All tests pass: `npm test -- --filter="draft"`

---

## Summary of Deliverables

**Files Created**: 1
- Migration file: `prisma/migrations/[timestamp]_add_soft_delete_to_transaction/migration.sql`

**Files Modified**: 5
- `prisma/schema.prisma` - Add `deletedAt`, `deletedById` fields and index
- `src/types/draft.ts` - Add `deletedAt`, `deletedBy` to response type
- `src/services/draft-transaction.ts` - Update delete function and all queries
- `src/app/api/transactions/drafts/[id]/route.ts` - Pass user ID to delete
- `tests/integration/drafts.test.ts` - Add soft delete test cases

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 -> 2 -> 3 -> 4 -> 5)
2. Run validation commands after each subtask
3. Run migrations on TEST database only (port 2346)
4. After Phase 3, run `npx tsc --noEmit` to verify all service changes compile
5. After Phase 5, run `npm test -- --filter="draft"` to verify tests pass

---

## Test Strategy Note

- Use Vitest for integration tests
- Test filter: `--filter="draft"` to run drafts.test.ts
- All tests target TEST environment (port 2346 database)

---

## Performance Metrics

| Phase | Estimated Duration |
|-------|----------|
| Investigation | 25m |
| Validation | 10m |
| Planning | 20m |
| **Total** | **55m** |

---

## Verification Commands

After each phase, run:
```bash
# TypeScript check
npx tsc --noEmit

# Build check
npm run build

# Lint check
npm run lint

# Tests (after Phase 5)
npm test -- --filter="draft"
```
