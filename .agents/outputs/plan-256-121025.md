# Implementation Plan
**Generated**: 2025-12-10 17:30 UTC
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #256
**Estimated Build Time**: 2-3 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Bug Fix
**Source**: GitHub Issue #256
**Priority**: Medium

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: FAST_PATH (smoke tests only - pattern is well-established and isolated to loading state handling)
**Suggested Filter**: None required - changes are UI-only loading state guards

### Issue Validation
**Status**: Valid
**Recent Changes**: Issue #250 (commit 4f3d084) fixed the same pattern in `/src/app/(dashboard)/skus/[id]/page.tsx` on 2025-12-10

### Current State Assessment

**Analysis of 11 files using `useSession()` in dashboard:**

| File | Status | Pattern Applied |
|------|--------|-----------------|
| `/src/app/(dashboard)/forecasts/page.tsx` | CORRECT | Line 25: `{ data: session, status }`, Line 103: guard, Line 112: dependency, Line 172: render check |
| `/src/app/(dashboard)/skus/[id]/page.tsx` | CORRECT | Line 32: `{ data: session, status }`, Line 46: guard, Line 70: dependency, Line 80: render check |
| `/src/app/(dashboard)/settings/page.tsx` | CORRECT | Line 9: `{ data: session, status }`, Line 33: guard, Line 42: dependency, Line 60: render check |
| `/src/app/(dashboard)/settings/alerts/page.tsx` | CORRECT | Line 21: `{ data: session, status }`, Lines 52-64: guards, Lines 65,72: dependencies, Line 74: render check |
| `/src/app/(dashboard)/import/page.tsx` | CORRECT | Line 10: `{ data: session, status }`, Lines 21-27: early return on loading |
| `/src/app/(dashboard)/page.tsx` | **NEEDS FIX** | Line 76: only `{ data: session }` - missing status |
| `/src/app/(dashboard)/layout.tsx` | **NEEDS FIX** | Line 54: only `{ data: session }` - missing status |
| `/src/app/(dashboard)/settings/users/page.tsx` | **NEEDS FIX** | Line 20: only `{ data: session }` - missing status |
| `/src/app/(dashboard)/settings/companies/page.tsx` | **NEEDS FIX** | Line 13: only `{ data: session }` - missing status |
| `/src/app/(dashboard)/components/[id]/page.tsx` | **NEEDS FIX** | Line 30: only `{ data: session }` - missing status |
| `/src/app/(dashboard)/transactions/page.tsx` | **NEEDS FIX** | Line 42: only `{ data: session }` - missing status |

**Total Files Affected**: 6 files need the fix (as listed in the issue)

### Dependencies & Blockers
None - this is a straightforward pattern application with no external dependencies.

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Simple (isolated changes, well-established pattern)
**Effort**: 2-3 hours
**Risk**: Low (pattern is proven, no database/API changes)

### Patterns Identified

**Primary Pattern**: `/src/app/(dashboard)/forecasts/page.tsx`
- Lines 25, 84-111, 112, 172-180

The correct pattern consists of 4 elements:

1. **Destructure status from useSession** (Line 25):
```typescript
const { data: session, status } = useSession()
```

2. **Guard in data fetching useEffect** (Lines 102-111):
```typescript
useEffect(() => {
  async function fetchData() {
    // ... fetch logic
  }

  // Don't fetch while session is loading
  if (status === 'loading') return

  if (session?.user?.selectedCompanyId) {
    fetchData()
  } else {
    setIsLoading(false)
  }
}, [status, session?.user?.selectedCompanyId, /* other deps */])
```

3. **Include status in dependency array** (Line 112):
```typescript
}, [status, queryString, session?.user?.selectedCompanyId, refreshKey])
```

4. **Loading state render condition** (Lines 172-180):
```typescript
if (status === 'loading' || isLoading) {
  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-3xl font-bold tracking-tight">Page Title</h1>
        <p className="text-muted-foreground">Loading...</p>
      </div>
    </div>
  )
}
```

**Secondary Pattern**: `/src/app/(dashboard)/skus/[id]/page.tsx` (recently fixed in #250)
- Shows the pattern applied to a detail page with useCallback

### Ripple Effect Analysis
**Files Identified**: 6
- All changes are isolated to individual page components
- No shared types, services, or API routes affected
- No cross-file dependencies

---

## Executive Summary
Apply the session loading state pattern from `forecasts/page.tsx` to 6 dashboard pages that currently use `useSession()` without checking the `status` property. This prevents potential issues during session loading such as premature API calls, undefined session data access, and inconsistent loading states.

## Phase 1: Dashboard Main Page

### Subtask 1.1: Fix `/src/app/(dashboard)/page.tsx`
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/page.tsx`
**Pattern**: Follow `/src/app/(dashboard)/forecasts/page.tsx` (lines 25, 102-112, 172)

**Current Code (Line 76)**:
```typescript
const { data: session } = useSession()
```

**Instructions**:

1. **Update useSession destructuring** (Line 76):
```typescript
const { data: session, status } = useSession()
```

2. **Add guard in useEffect** (around Line 85-118):
```typescript
useEffect(() => {
  async function fetchDashboard() {
    // ... existing fetch logic unchanged
  }

  // Don't fetch while session is loading
  if (status === 'loading') return

  if (session?.user?.selectedCompanyId) {
    fetchDashboard()
  }
}, [timeFilter, locationId, session?.user?.selectedCompanyId, session?.user?.selectedBrandId, status])
```

3. **Update loading render condition** (Line 121):
```typescript
if (status === 'loading' || isLoading) {
```

4. **Add `status` to useEffect dependency array** (Line 119):
```typescript
}, [timeFilter, locationId, session?.user?.selectedCompanyId, session?.user?.selectedBrandId, status])
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] `status` destructured from useSession
- [ ] Guard added: `if (status === 'loading') return`
- [ ] `status` added to useEffect dependency array
- [ ] Loading condition includes `status === 'loading'`
- [ ] TypeScript compiles without errors

---

## Phase 2: Dashboard Layout

### Subtask 2.1: Fix `/src/app/(dashboard)/layout.tsx`
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/layout.tsx`
**Pattern**: Follow `/src/app/(dashboard)/forecasts/page.tsx`

**Current Code (Line 54)**:
```typescript
const { data: session } = useSession()
```

**Instructions**:

1. **Update useSession destructuring** (Line 54):
```typescript
const { data: session, status } = useSession()
```

2. **Add loading state handling** - The layout component doesn't fetch data, but accessing `session?.user?.role` and `session?.user?.name` during loading can cause issues. Add a loading guard for the sidebar content that depends on session data.

After line 58 (after `const [chatbotOpen, setChatbotOpen] = useState(false)`), add:
```typescript
// Show minimal layout while session is loading
if (status === 'loading') {
  return (
    <div className="min-h-screen bg-background">
      <div className="flex items-center justify-center h-screen">
        <p className="text-muted-foreground">Loading...</p>
      </div>
    </div>
  )
}
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] `status` destructured from useSession
- [ ] Loading guard added before main return
- [ ] TypeScript compiles without errors

---

## Phase 3: Settings Pages

### Subtask 3.1: Fix `/src/app/(dashboard)/settings/users/page.tsx`
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/users/page.tsx`
**Pattern**: Follow `/src/app/(dashboard)/forecasts/page.tsx`

**Current Code (Line 20)**:
```typescript
const { data: session } = useSession()
```

**Instructions**:

1. **Update useSession destructuring** (Line 20):
```typescript
const { data: session, status } = useSession()
```

2. **Add guard in useEffect** (around Line 51-53):
```typescript
useEffect(() => {
  // Don't fetch while session is loading
  if (status === 'loading') return

  fetchUsers()
}, [fetchUsers, status])
```

3. **Update loading state render** - Modify the existing loading check (Line 122-125) to include status:
```typescript
{/* Loading State */}
{(status === 'loading' || isLoading) && (
  <div className="py-10 text-center text-muted-foreground">Loading users...</div>
)}
```

4. **Update the UserTable render condition** (Line 128):
```typescript
{!isLoading && status !== 'loading' && !error && session?.user && (
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] `status` destructured from useSession
- [ ] Guard added in useEffect
- [ ] `status` added to dependency array
- [ ] Loading condition updated
- [ ] TypeScript compiles without errors

---

### Subtask 3.2: Fix `/src/app/(dashboard)/settings/companies/page.tsx`
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/companies/page.tsx`
**Pattern**: Follow `/src/app/(dashboard)/forecasts/page.tsx`

**Current Code (Line 13)**:
```typescript
const { data: session } = useSession()
```

**Instructions**:

1. **Update useSession destructuring** (Line 13):
```typescript
const { data: session, status } = useSession()
```

2. **Add guard in useEffect** (around Line 40-42):
```typescript
useEffect(() => {
  // Don't fetch while session is loading
  if (status === 'loading') return

  fetchCompanies()
}, [fetchCompanies, status])
```

3. **Update loading state render** (Line 88-91):
```typescript
{/* Loading State */}
{(status === 'loading' || isLoading) && (
  <div className="py-10 text-center text-muted-foreground">Loading companies...</div>
)}
```

4. **Update the CompanyTable render condition** (Line 94):
```typescript
{!isLoading && status !== 'loading' && !error && session?.user && (
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] `status` destructured from useSession
- [ ] Guard added in useEffect
- [ ] `status` added to dependency array
- [ ] Loading condition updated
- [ ] TypeScript compiles without errors

---

## Phase 4: Detail Pages

### Subtask 4.1: Fix `/src/app/(dashboard)/components/[id]/page.tsx`
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/components/[id]/page.tsx`
**Pattern**: Follow `/src/app/(dashboard)/skus/[id]/page.tsx` (already fixed for #250)

**Current Code (Line 30)**:
```typescript
const { data: session } = useSession()
```

**Instructions**:

1. **Update useSession destructuring** (Line 30):
```typescript
const { data: session, status } = useSession()
```

2. **Add guard in fetchComponent callback** (Line 39-55):
```typescript
const fetchComponent = useCallback(async () => {
  // Don't fetch while session is loading
  if (status === 'loading') return

  try {
    const res = await fetch(`/api/components/${id}?trendDays=${sparklineDays}`)
    // ... rest of existing logic
  }
}, [id, sparklineDays, status])
```

3. **Update loading state render** (Line 76):
```typescript
if (status === 'loading' || isLoading) {
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] `status` destructured from useSession
- [ ] Guard added in useCallback: `if (status === 'loading') return`
- [ ] `status` added to useCallback dependency array
- [ ] Loading condition includes `status === 'loading'`
- [ ] TypeScript compiles without errors

---

### Subtask 4.2: Fix `/src/app/(dashboard)/transactions/page.tsx`
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/transactions/page.tsx`
**Pattern**: Follow `/src/app/(dashboard)/forecasts/page.tsx`

**Note**: This file has a nested component structure with `TransactionLogContent` inside `TransactionsPage`.

**Current Code (Line 42)**:
```typescript
const { data: session } = useSession()
```

**Instructions**:

1. **Update useSession destructuring** (Line 42):
```typescript
const { data: session, status } = useSession()
```

2. **Add guard in useEffect** (around Line 126-129):
```typescript
// Refetch when company changes or fetchTransactions changes
useEffect(() => {
  // Don't fetch while session is loading
  if (status === 'loading') return

  fetchTransactions()
  fetchDraftCount()
}, [fetchTransactions, fetchDraftCount, session?.user?.selectedCompanyId, status])
```

3. **Update loading state render** (Line 320-324):
```typescript
{/* Loading State */}
{(status === 'loading' || isLoading) && (
  <Card>
    <CardContent className="py-10 text-center text-muted-foreground">Loading...</CardContent>
  </Card>
)}
```

4. **Update transaction table render condition** (Line 327):
```typescript
{!isLoading && status !== 'loading' && !error && (
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] `status` destructured from useSession
- [ ] Guard added in useEffect
- [ ] `status` added to dependency array
- [ ] Loading condition updated
- [ ] Table render condition updated
- [ ] TypeScript compiles without errors

---

## Phase 5: Final Validation

### Subtask 5.1: Full Build Validation
**Instructions**:
1. Run TypeScript check: `npx tsc --noEmit`
2. Run full build: `npm run build`
3. Run lint: `npm run lint`

**Validation Commands**:
```bash
cd /home/pbrown/SkuInventory
npx tsc --noEmit
npm run build
npm run lint
```

**Completion Criteria**:
- [ ] TypeScript compiles without errors
- [ ] Build completes successfully
- [ ] No lint warnings or errors

---

## Summary of Deliverables

**Files Modified**: 6
1. `/home/pbrown/SkuInventory/src/app/(dashboard)/page.tsx`
2. `/home/pbrown/SkuInventory/src/app/(dashboard)/layout.tsx`
3. `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/users/page.tsx`
4. `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/companies/page.tsx`
5. `/home/pbrown/SkuInventory/src/app/(dashboard)/components/[id]/page.tsx`
6. `/home/pbrown/SkuInventory/src/app/(dashboard)/transactions/page.tsx`

**Files Created**: 0

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 through Phase 5)
2. For each file modification:
   - Add `status` to useSession destructuring
   - Add loading guard in appropriate location
   - Add `status` to dependency arrays
   - Update loading render conditions
3. Run validation commands after each phase
4. Final validation must pass all checks before completion

## Test Strategy Note
- **Strategy**: FAST_PATH - smoke tests only
- Changes are isolated to loading state handling
- No database or API changes
- Pattern is well-established from existing implementations
- Manual verification: Check each page loads correctly with session

## Performance Metrics
| Phase | Estimated Duration |
|-------|-------------------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 10m |
| **Total** | **30m** |

---

## Reference Code Snippets

### Complete Pattern from forecasts/page.tsx

```typescript
// Line 25 - Destructure status
const { data: session, status } = useSession()

// Lines 84-112 - useEffect with guard
useEffect(() => {
  async function fetchForecasts() {
    try {
      setIsLoading(true)
      setError(null)
      const res = await fetch(`/api/forecasts?${queryString}`)
      if (!res.ok) {
        throw new Error('Failed to load forecasts')
      }
      const result = await res.json()
      setResponse(result)
    } catch (err) {
      setError(err instanceof Error ? err.message : 'An error occurred')
    } finally {
      setIsLoading(false)
    }
  }

  // Don't fetch while session is loading
  if (status === 'loading') return

  // If authenticated with a company selected, fetch forecasts
  if (session?.user?.selectedCompanyId) {
    fetchForecasts()
  } else {
    // Session loaded but no company - stop loading
    setIsLoading(false)
  }
}, [status, queryString, session?.user?.selectedCompanyId, refreshKey])

// Lines 172-180 - Loading render
if (status === 'loading' || isLoading) {
  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-3xl font-bold tracking-tight">Forecasts</h1>
        <p className="text-muted-foreground">Loading...</p>
      </div>
    </div>
  )
}
```

### Complete Pattern from skus/[id]/page.tsx (useCallback variant)

```typescript
// Line 32 - Destructure status
const { data: session, status } = useSession()

// Lines 43-70 - useCallback with guard
const fetchData = useCallback(async () => {
  if (!skuId) return
  // Don't fetch while session is loading
  if (status === 'loading') return

  try {
    const [skuRes, bomRes] = await Promise.all([
      fetch(`/api/skus/${skuId}`),
      fetch(`/api/skus/${skuId}/bom-versions?includeInactive=true`),
    ])

    if (!skuRes.ok) {
      throw new Error('SKU not found')
    }

    const skuData = await skuRes.json()
    setSku(skuData.data)

    if (bomRes.ok) {
      const bomData = await bomRes.json()
      setBomVersions(bomData.data)
    }
  } catch (err) {
    setError(err instanceof Error ? err.message : 'Failed to load SKU')
  } finally {
    setIsLoading(false)
  }
}, [skuId, status])

// Lines 80-92 - Loading render
if (isLoading || status === 'loading') {
  return (
    <div className="space-y-6">
      <div className="flex items-center gap-4">
        <Button variant="ghost" size="sm" onClick={() => router.back()}>
          <ArrowLeft className="h-4 w-4 mr-2" />
          Back
        </Button>
      </div>
      <p>Loading...</p>
    </div>
  )
}
```
