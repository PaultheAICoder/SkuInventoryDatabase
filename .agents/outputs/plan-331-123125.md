# Implementation Plan
**Generated**: 2025-12-31T12:00:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #331
**Estimated Build Time**: 4-6 hours
**Complexity**: Moderate

## Investigation Summary

### Request Analysis
**Type**: Bug
**Source**: GitHub Issue #331
**Priority**: High - Core functionality broken for finished goods transactions

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED - Affected modules (~5-15 min)
**Suggested Filter**: `--filter="transaction"` or manual verification via UI

### Issue Validation
**Status**: Valid - Bug confirmed through code analysis
**Recent Changes**: No recent changes address this specific issue

### Current State Assessment

#### Root Cause Analysis

The bug occurs because the transaction detail API (`/api/transactions/[id]/route.ts`) only fetches and returns `lines` (TransactionLine - for component inventory), but does NOT fetch or return `finishedGoodsLines` (FinishedGoodsLine - for SKU/finished goods inventory).

**Two types of transaction lines exist in the database:**

| Type | Model | For | Created By |
|------|-------|-----|------------|
| `lines` | TransactionLine | Component inventory (receipt, adjustment, initial, build consumption) | `src/services/inventory.ts` |
| `finishedGoodsLines` | FinishedGoodsLine | SKU/Finished goods inventory (FG receipt, FG adjustment, FG transfer, outbound) | `src/services/finished-goods.ts` |

**Affected transaction types:**
- FG Receipt (via Receive FG button on SKU page)
- FG Adjustment
- FG Transfer
- Outbound

When viewing these transactions, quantity and location are empty because:
1. The API doesn't include `finishedGoodsLines` in the Prisma query
2. The API doesn't return `finishedGoodsLines` in the response
3. The frontend component only renders `lines`, not `finishedGoodsLines`

#### Files Affected

**Primary files to modify:**
1. `/home/pbrown/SkuInventory/src/app/api/transactions/[id]/route.ts` - Add finishedGoodsLines to query and response
2. `/home/pbrown/SkuInventory/src/types/transaction.ts` - Add FinishedGoodsLine types to response interfaces
3. `/home/pbrown/SkuInventory/src/components/features/TransactionDetail.tsx` - Render finishedGoodsLines when present

**Secondary files with same pattern (should be fixed for consistency):**
- `/home/pbrown/SkuInventory/src/app/api/transactions/route.ts` - Transaction list API
- `/home/pbrown/SkuInventory/src/app/api/export/transactions/route.ts` - Transaction export
- `/home/pbrown/SkuInventory/src/app/api/dashboard/route.ts` - Dashboard recent transactions

### Dependencies & Blockers
None identified - this is a straightforward data flow fix.

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Moderate
**Effort**: 4-6 hours
**Risk**: Low - changes are additive, not modifying existing functionality

### Patterns Identified

**Primary Pattern**: Existing `lines` handling in `/home/pbrown/SkuInventory/src/app/api/transactions/[id]/route.ts`
- Lines 72-87: Include statement for lines with component data
- Lines 120-135: Response mapping for lines

**Secondary Pattern**: Type definition in `/home/pbrown/SkuInventory/src/types/finished-goods.ts:55-64`
```typescript
export interface FinishedGoodsLineResponse {
  id: string
  skuId: string
  skuName: string
  skuInternalCode: string
  quantityChange: string
  costPerUnit: string | null
  locationId: string
  locationName: string
}
```

### Ripple Effect Analysis
**Files Identified**: 6
- `/home/pbrown/SkuInventory/src/app/api/transactions/[id]/route.ts` - PRIMARY: Add finishedGoodsLines to GET
- `/home/pbrown/SkuInventory/src/types/transaction.ts` - Add finishedGoodsLines to TransactionResponse
- `/home/pbrown/SkuInventory/src/components/features/TransactionDetail.tsx` - Render finishedGoodsLines
- `/home/pbrown/SkuInventory/src/app/api/transactions/route.ts` - SECONDARY: Same pattern fix
- `/home/pbrown/SkuInventory/src/app/api/export/transactions/route.ts` - SECONDARY: Same pattern fix
- `/home/pbrown/SkuInventory/src/app/api/dashboard/route.ts` - SECONDARY: Same pattern fix (if FG transactions appear on dashboard)

---

## Executive Summary

This bug fix adds `finishedGoodsLines` data to the transaction detail API response and updates the TransactionDetail component to display finished goods line items (quantity, location) for FG receipt, FG adjustment, FG transfer, and outbound transactions. Currently, these transaction types show empty line items because only component-based `lines` are fetched and displayed.

---

## Phase 1: Types Layer

### Subtask 1.1: Add FinishedGoodsLineResponse to TransactionResponse
**File**: `/home/pbrown/SkuInventory/src/types/transaction.ts`
**Pattern**: Follow existing `TransactionLineResponse` interface (lines 173-180)

**Instructions**:
1. Add `finishedGoodsLines` field to `TransactionResponse` interface after `lines` field
2. Type should match pattern from `/home/pbrown/SkuInventory/src/types/finished-goods.ts:55-64`

**Code to add** (after line 171, before the closing brace of TransactionResponse):
```typescript
  finishedGoodsLines?: FinishedGoodsLineResponse[]
```

3. Add import or inline type for FinishedGoodsLineResponse:
```typescript
// Option A: Import from finished-goods.ts
import type { FinishedGoodsLineResponse } from './finished-goods'

// Option B: Define inline (if import causes circular dependency)
export interface FinishedGoodsLineResponse {
  id: string
  skuId: string
  skuName: string
  skuInternalCode: string
  quantityChange: string
  costPerUnit: string | null
  locationId: string
  locationName: string
}
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] `finishedGoodsLines` field added to TransactionResponse
- [ ] Type imports/definitions correct
- [ ] TypeScript compiles without errors

---

## Phase 2: API Layer (Primary Fix)

### Subtask 2.1: Update Transaction Detail API to include finishedGoodsLines
**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/[id]/route.ts`
**Pattern**: Follow existing `lines` include pattern (lines 72-87)

**Instructions**:

1. **Add finishedGoodsLines to Prisma include** (after `lines` include block, around line 84):
```typescript
        finishedGoodsLines: {
          include: {
            sku: {
              select: {
                id: true,
                name: true,
                internalCode: true,
              },
            },
            location: {
              select: {
                id: true,
                name: true,
              },
            },
          },
        },
```

2. **Add finishedGoodsLines to response mapping** (after `lines` mapping, around line 135):
```typescript
        finishedGoodsLines: transaction.finishedGoodsLines.map((fgLine) => ({
          id: fgLine.id,
          skuId: fgLine.skuId,
          skuName: fgLine.sku.name,
          skuInternalCode: fgLine.sku.internalCode,
          quantityChange: fgLine.quantityChange.toString(),
          costPerUnit: fgLine.costPerUnit?.toString() ?? null,
          locationId: fgLine.locationId,
          locationName: fgLine.location.name,
        })),
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] finishedGoodsLines included in Prisma query
- [ ] finishedGoodsLines mapped in response
- [ ] TypeScript compiles without errors
- [ ] Build succeeds

---

## Phase 3: Frontend Component Update

### Subtask 3.1: Update TransactionDetailProps interface
**File**: `/home/pbrown/SkuInventory/src/components/features/TransactionDetail.tsx`
**Pattern**: Follow existing TransactionLine interface (lines 31-42)

**Instructions**:

1. **Add FinishedGoodsLine interface** (after TransactionLine interface, around line 43):
```typescript
interface FinishedGoodsLine {
  id: string
  skuId: string
  skuName: string
  skuInternalCode: string
  quantityChange: string
  costPerUnit: string | null
  locationId: string
  locationName: string
}
```

2. **Add finishedGoodsLines to TransactionDetailProps** (after `lines` field, around line 68):
```typescript
    finishedGoodsLines?: FinishedGoodsLine[]
```

**Completion Criteria**:
- [ ] FinishedGoodsLine interface added
- [ ] finishedGoodsLines added to props

### Subtask 3.2: Add Finished Goods Lines table rendering
**File**: `/home/pbrown/SkuInventory/src/components/features/TransactionDetail.tsx`
**Pattern**: Follow existing lines table (lines 358-441)

**Instructions**:

1. **Add conditional rendering for finishedGoodsLines** after the existing Transaction Lines card (around line 441, before the Delete Confirmation Dialog):

```typescript
      {/* Finished Goods Lines - for FG receipt, adjustment, transfer, outbound transactions */}
      {transaction.finishedGoodsLines && transaction.finishedGoodsLines.length > 0 && (
        <Card>
          <CardHeader>
            <CardTitle>Finished Goods</CardTitle>
            <CardDescription>
              {transaction.finishedGoodsLines.length} SKU item(s) in this transaction
            </CardDescription>
          </CardHeader>
          <CardContent>
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>SKU</TableHead>
                  <TableHead>Location</TableHead>
                  <TableHead className="text-right">Quantity Change</TableHead>
                  <TableHead className="text-right">Cost/Unit</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {transaction.finishedGoodsLines.map((fgLine) => {
                  const qtyChange = parseFloat(fgLine.quantityChange)
                  const costPerUnit = fgLine.costPerUnit ? parseFloat(fgLine.costPerUnit) : null

                  return (
                    <TableRow key={fgLine.id}>
                      <TableCell>
                        <Link
                          href={`/skus/${fgLine.skuId}`}
                          className="font-medium hover:underline"
                        >
                          {fgLine.skuName}
                        </Link>
                        <div className="text-xs text-muted-foreground font-mono">
                          {fgLine.skuInternalCode}
                        </div>
                      </TableCell>
                      <TableCell>
                        {fgLine.locationName}
                      </TableCell>
                      <TableCell className="text-right">
                        <span
                          className={`font-mono ${qtyChange >= 0 ? 'text-green-600' : 'text-red-600'}`}
                          suppressHydrationWarning
                        >
                          {qtyChange >= 0 ? '+' : ''}
                          {qtyChange.toLocaleString()}
                        </span>
                      </TableCell>
                      <TableCell className="text-right font-mono">
                        {costPerUnit != null ? `$${costPerUnit.toFixed(4)}` : '-'}
                      </TableCell>
                    </TableRow>
                  )
                })}
              </TableBody>
            </Table>
          </CardContent>
        </Card>
      )}
```

2. **Update line items card visibility** - Optionally hide the component lines card when empty and FG lines exist (around line 358):
```typescript
      {/* Transaction Lines - Component-based transactions */}
      {transaction.lines.length > 0 && (
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
npm run lint
```

**Completion Criteria**:
- [ ] FinishedGoodsLine interface added
- [ ] finishedGoodsLines prop added
- [ ] New table renders for finishedGoodsLines
- [ ] Component compiles without errors
- [ ] Lint passes

---

## Phase 4: Secondary Pattern Fixes (Same Bug in Other Files)

### Subtask 4.1: Update Transaction List API
**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/route.ts`
**Pattern**: Follow same pattern as Subtask 2.1

**Instructions**:

1. **Add finishedGoodsLines to Prisma include** (after `lines` include, around line 80):
```typescript
        finishedGoodsLines: {
          include: {
            sku: {
              select: { id: true, name: true, internalCode: true },
            },
            location: {
              select: { id: true, name: true },
            },
          },
        },
```

2. **Add finishedGoodsLines to response mapping** (after `lines` mapping, around line 122):
```typescript
      finishedGoodsLines: tx.finishedGoodsLines?.map((fgLine) => ({
        id: fgLine.id,
        skuId: fgLine.skuId,
        skuName: fgLine.sku.name,
        skuInternalCode: fgLine.sku.internalCode,
        quantityChange: fgLine.quantityChange.toString(),
        costPerUnit: fgLine.costPerUnit?.toString() ?? null,
        locationId: fgLine.locationId,
        locationName: fgLine.location.name,
      })) ?? [],
```

**Completion Criteria**:
- [ ] finishedGoodsLines included in list API
- [ ] TypeScript compiles

### Subtask 4.2: Update Transaction Export API
**File**: `/home/pbrown/SkuInventory/src/app/api/export/transactions/route.ts`
**Pattern**: Follow existing lines export pattern (lines 104-165)

**Instructions**:

1. **Add finishedGoodsLines to Prisma include** (after `lines` include, around line 85):
```typescript
        finishedGoodsLines: {
          include: {
            sku: {
              select: {
                name: true,
                internalCode: true,
              },
            },
            location: {
              select: {
                name: true,
              },
            },
          },
        },
```

2. **Add finishedGoodsLines export logic** (after lines export loop, around line 136):
```typescript
      // If transaction has finished goods lines, create one row per line
      if (tx.finishedGoodsLines && tx.finishedGoodsLines.length > 0) {
        for (const fgLine of tx.finishedGoodsLines) {
          exportData.push({
            id: tx.id,
            type: tx.type,
            date: toLocalDateString(tx.date),
            skuName: fgLine.sku.name,
            skuCode: fgLine.sku.internalCode,
            salesChannel: tx.salesChannel,
            unitsBuild: tx.unitsBuild,
            unitBomCost: tx.unitBomCost?.toString() ?? null,
            totalBomCost: tx.totalBomCost?.toString() ?? null,
            supplier: tx.supplier,
            reason: tx.reason,
            notes: tx.notes,
            defectCount: tx.defectCount,
            defectNotes: tx.defectNotes,
            affectedUnits: tx.affectedUnits,
            createdAt: tx.createdAt.toISOString(),
            createdByName: tx.createdBy.name,
            fromLocationName: tx.fromLocation?.name ?? fgLine.location.name,
            toLocationName: tx.toLocation?.name ?? null,
            componentName: '', // FG lines don't have components
            componentSkuCode: '',
            quantityChange: fgLine.quantityChange.toString(),
            costPerUnit: fgLine.costPerUnit?.toString() ?? null,
          })
        }
      }
```

3. **Update the conditional logic** to check both lines types:
```typescript
      // If transaction has lines (component or finished goods), use them
      if (tx.lines.length > 0) {
        // existing lines handling
      } else if (tx.finishedGoodsLines && tx.finishedGoodsLines.length > 0) {
        // new FG lines handling (from step 2)
      } else {
        // Transaction with no lines
      }
```

**Completion Criteria**:
- [ ] finishedGoodsLines included in export
- [ ] Export correctly handles both line types

---

## Phase 5: Verification

### Subtask 5.1: TypeScript and Build Verification
**Instructions**:
```bash
cd /home/pbrown/SkuInventory
npx tsc --noEmit
npm run build
npm run lint
```

**Completion Criteria**:
- [ ] TypeScript compiles without errors
- [ ] Build succeeds
- [ ] Lint passes

### Subtask 5.2: Manual UI Verification (Test Environment)
**Instructions**:
1. Start test environment if not running:
   ```bash
   cd /home/pbrown/SkuInventory/docker && docker compose -f docker-compose.test.yml up -d
   ```
2. Access test app at http://172.16.20.50:2345
3. Create a Finished Goods Receipt transaction:
   - Navigate to any SKU page
   - Click the receive FG button
   - Enter quantity (e.g., 100) and location
   - Submit
4. Navigate to the created transaction
5. Verify:
   - Quantity is displayed
   - Location is displayed
   - No errors in console

**Completion Criteria**:
- [ ] FG Receipt transaction shows quantity
- [ ] FG Receipt transaction shows location
- [ ] No console errors

---

## Summary of Deliverables

**Files Modified**: 6
| File | Changes |
|------|---------|
| `/home/pbrown/SkuInventory/src/types/transaction.ts` | Add finishedGoodsLines to TransactionResponse |
| `/home/pbrown/SkuInventory/src/app/api/transactions/[id]/route.ts` | Include and return finishedGoodsLines |
| `/home/pbrown/SkuInventory/src/components/features/TransactionDetail.tsx` | Add interface and render finishedGoodsLines table |
| `/home/pbrown/SkuInventory/src/app/api/transactions/route.ts` | Include and return finishedGoodsLines (list API) |
| `/home/pbrown/SkuInventory/src/app/api/export/transactions/route.ts` | Include and export finishedGoodsLines |
| `/home/pbrown/SkuInventory/src/app/api/dashboard/route.ts` | (Optional) Include finishedGoodsLines if needed |

**Files Created**: 0

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 -> 2 -> 3 -> 4 -> 5)
2. Run TypeScript check after each phase
3. Test completion criteria before proceeding to next subtask
4. Follow reference patterns exactly as specified
5. Manual verification MUST use test environment (port 2345), NOT production

---

## Test Strategy Note

- Primary testing: Manual UI verification in test environment
- No new automated tests required (existing functionality)
- Verify TypeScript compilation and build
- E2E tests optional but would target http://172.16.20.50:2345

---

## Performance Metrics

| Phase | Duration |
|-------|----------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 10m |
| **Total** | **30m** |
