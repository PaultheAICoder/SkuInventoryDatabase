# Implementation Plan
**Generated**: 2026-01-01T12:00:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: Issue #349
**Estimated Build Time**: 4-6 hours
**Complexity**: Moderate

## Investigation Summary

### Request Analysis
**Type**: Feature
**Source**: GitHub Issue #349 (Parent: #338 - Complete Amazon Seller Central integration)
**Priority**: High (final automation for Amazon integration)

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="amazon-sync"` or None (manual cron testing)

### Issue Validation
**Status**: Valid
**Recent Changes**:
- `cc5e776` feat(issue #347): add Amazon Advertising Reports API for keyword metrics
- `1745e4a` feat(issue #346): add Amazon SP-API Orders integration
- Both dependencies (#346, #347) are COMPLETED per closed issues list

### Current State Assessment

#### Existing Components
1. **Cron Route**: `/src/app/api/cron/ads-sync/route.ts` - EXISTS
   - Uses X-Cron-Secret header authentication
   - Calls `syncAllActiveCredentials()` for amazon_ads only
   - Does NOT include amazon_sp credentials or orders sync

2. **Amazon Ads Sync Service**: `/src/services/amazon-ads/sync.ts` - EXISTS
   - `syncAll()` - Full sync for single credential
   - `syncAllActiveCredentials()` - Triggers syncs for all active amazon_ads credentials
   - Creates SyncLog entries and Notification on failure

3. **Amazon SP-API Order Sync**: `/src/services/amazon-sp-api/sync-orders.ts` - EXISTS
   - `syncOrders()` - Syncs orders for a specific credential+brand
   - Requires brandId parameter (credential.brandId relationship)
   - Creates SyncLog entries and Notification on failure

4. **Docker Configuration**: `/docker/docker-compose.prod.yml` - EXISTS
   - monitor container uses CRON_SECRET for webhook auth
   - No dedicated cron container exists

5. **Cron Scheduler Documentation**: `/docs/operations/CRON-SCHEDULER-SETUP.md` - EXISTS
   - Documents systemd timer approach (recommended)
   - Documents traditional crontab approach

### Dependencies & Blockers
1. **amazon_sp credentials need brandId** - IntegrationCredential has brandId field (nullable)
   - When syncing amazon_sp, we need to determine which brand to use
   - Solution: Use credential.brandId if set, otherwise skip (log warning)

2. **SYNC_TIMEZONE, SKIP_WEEKENDS, DISABLE_AMAZON_SYNC** - NEW env vars
   - Not currently in env.ts or .env.example
   - Need to add to both files

3. **Date range for order sync** - Orders sync requires startDate/endDate
   - For daily sync, use yesterday's date (previous day's complete data)

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Moderate
**Effort**: 4-6 hours
**Risk**: Low - extending existing patterns, not creating new architecture

### Patterns Identified

**Primary Pattern**: `/src/app/api/cron/ads-sync/route.ts`
- CRON_SECRET header authentication
- Call service function
- Return structured response with syncsTriggered, errors

**Secondary Pattern**: `/src/services/amazon-ads/sync.ts:syncAllActiveCredentials()`
- Query active credentials
- Loop and trigger sync for each
- Collect results and errors
- Fire-and-forget with background error logging

**Tertiary Pattern**: `/src/services/retention.ts:runRetentionCleanup()`
- Clean service interface with result type
- Track duration and counts
- Return structured result

### Ripple Effect Analysis

**Files Identified**: 6

| File Path | Why Affected |
|-----------|--------------|
| `/src/app/api/cron/ads-sync/route.ts` | UPDATE - enhance to call unified scheduler |
| `/src/services/amazon-sync/scheduler.ts` | CREATE - new sync orchestration service |
| `/src/lib/env.ts` | UPDATE - add new env vars |
| `/.env.example` | UPDATE - document new env vars |
| `/docker/cron/amazon-sync.sh` | CREATE - cron trigger script |
| `/docker/docker-compose.prod.yml` | UPDATE - add cron container (optional) |
| `/docs/operations/CRON-SCHEDULER-SETUP.md` | UPDATE - document amazon-sync schedule |

---

## Executive Summary

This implementation creates a unified scheduled Amazon data sync service that:
1. Enhances the existing `/api/cron/ads-sync` route to sync BOTH amazon_ads and amazon_sp credentials
2. Creates a new scheduler service with retry logic, staggered execution, and weekend skip options
3. Adds Docker cron configuration and documentation for systemd timer setup
4. Uses existing SyncLog and Notification patterns for audit trail and failure alerts

---

## Phase 0: Environment Configuration

### Subtask 0.1: Add New Environment Variables to env.ts
**File**: `/home/pbrown/SkuInventory/src/lib/env.ts`
**Pattern**: Follow existing CRON_SECRET definition (line 13)

**Instructions**:
1. Add after CRON_SECRET (around line 14):
```typescript
  // Amazon sync configuration
  SYNC_TIMEZONE: z.string().default('America/New_York'),
  DISABLE_AMAZON_SYNC: z.enum(['true', 'false']).default('false'),
  SKIP_WEEKENDS: z.enum(['true', 'false']).default('false'),
  SYNC_STAGGER_MS: z.coerce.number().min(0).max(60000).default(5000),
  SYNC_MAX_RETRIES: z.coerce.number().min(0).max(5).default(3),
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] New env vars added to schema
- [ ] Default values provided
- [ ] TypeScript compiles without errors

### Subtask 0.2: Document New Environment Variables in .env.example
**File**: `/home/pbrown/SkuInventory/.env.example`
**Pattern**: Follow existing documentation format

**Instructions**:
1. Add after CREDENTIAL_ENCRYPTION_KEY section (around line 111):
```bash
# ============================================================================
# AMAZON SYNC SCHEDULER CONFIGURATION
# ============================================================================
# Configuration for automated daily Amazon data sync (orders, ads, reports)

# Timezone for sync scheduling (default: America/New_York)
# Used to determine when 5 AM occurs for the cron schedule
SYNC_TIMEZONE=America/New_York

# Disable all Amazon sync jobs (default: false)
# Set to 'true' to pause syncing without removing configuration
DISABLE_AMAZON_SYNC=false

# Skip sync on weekends (Saturday/Sunday) (default: false)
# Useful if Amazon data is not updated on weekends
SKIP_WEEKENDS=false

# Delay between syncing multiple credentials (ms, default: 5000)
# Helps avoid rate limiting when multiple accounts are configured
SYNC_STAGGER_MS=5000

# Maximum retry attempts for failed syncs (default: 3)
SYNC_MAX_RETRIES=3
```

**Validation**:
```bash
grep "SYNC_TIMEZONE" /home/pbrown/SkuInventory/.env.example
```

**Completion Criteria**:
- [ ] All new env vars documented
- [ ] Clear descriptions provided
- [ ] Default values shown

---

## Phase 1: Create Amazon Sync Scheduler Service

### Subtask 1.1: Create Scheduler Service File
**File**: `/home/pbrown/SkuInventory/src/services/amazon-sync/scheduler.ts` (CREATE)
**Pattern**: Follow `/src/services/amazon-ads/sync.ts` and `/src/services/retention.ts`

**Instructions**:
Create new file with the following structure:

```typescript
/**
 * Amazon Data Sync Scheduler
 *
 * Orchestrates daily synchronization of Amazon data:
 * - Amazon Ads: portfolios, campaigns, ad groups, reports
 * - Amazon SP: orders (via SP-API)
 *
 * Features:
 * - Retry logic for transient failures
 * - Staggered execution to avoid rate limits
 * - Weekend skip option
 * - Configurable via environment variables
 */

import { prisma } from '@/lib/db'
import { syncAll as syncAmazonAds, type SyncOptions as AdsSyncOptions } from '@/services/amazon-ads/sync'
import { syncOrders, type OrderSyncOptions } from '@/services/amazon-sp-api/sync-orders'
import { format, subDays } from 'date-fns'

// ============================================
// Types
// ============================================

export interface ScheduledSyncResult {
  totalCredentials: number
  syncsTriggered: number
  syncsCompleted: number
  syncsFailed: number
  amazonAdsResults: CredentialSyncResult[]
  amazonSpResults: CredentialSyncResult[]
  skipped: SkipReason | null
  duration: number
}

export interface CredentialSyncResult {
  credentialId: string
  integrationType: 'amazon_ads' | 'amazon_sp'
  status: 'completed' | 'partial' | 'failed' | 'skipped'
  syncLogId?: string
  error?: string
  retryCount: number
}

export type SkipReason = 'disabled' | 'weekend'

// ============================================
// Configuration
// ============================================

function getConfig() {
  return {
    disabled: process.env.DISABLE_AMAZON_SYNC === 'true',
    skipWeekends: process.env.SKIP_WEEKENDS === 'true',
    timezone: process.env.SYNC_TIMEZONE || 'America/New_York',
    staggerMs: parseInt(process.env.SYNC_STAGGER_MS || '5000', 10),
    maxRetries: parseInt(process.env.SYNC_MAX_RETRIES || '3', 10),
  }
}

function isWeekend(): boolean {
  const now = new Date()
  const day = now.getDay()
  return day === 0 || day === 6 // Sunday = 0, Saturday = 6
}

function getYesterdayDateRange(): { startDate: string; endDate: string } {
  const yesterday = subDays(new Date(), 1)
  const dateStr = format(yesterday, 'yyyy-MM-dd')
  return { startDate: dateStr, endDate: dateStr }
}

// ============================================
// Retry Logic
// ============================================

async function syncWithRetry<T>(
  operation: () => Promise<T>,
  maxRetries: number,
  credentialId: string,
  integrationType: string
): Promise<{ result?: T; error?: string; retryCount: number }> {
  let lastError: string | undefined

  for (let attempt = 0; attempt <= maxRetries; attempt++) {
    try {
      const result = await operation()
      return { result, retryCount: attempt }
    } catch (error) {
      lastError = error instanceof Error ? error.message : 'Unknown error'
      console.error(
        `[Amazon Sync] Attempt ${attempt + 1}/${maxRetries + 1} failed for ${integrationType} ${credentialId}: ${lastError}`
      )

      if (attempt < maxRetries) {
        // Exponential backoff: 2^attempt * 1000ms (1s, 2s, 4s, 8s...)
        const backoffMs = Math.pow(2, attempt) * 1000
        await new Promise(resolve => setTimeout(resolve, backoffMs))
      }
    }
  }

  return { error: lastError, retryCount: maxRetries }
}

// ============================================
// Stagger Helper
// ============================================

function delay(ms: number): Promise<void> {
  return new Promise(resolve => setTimeout(resolve, ms))
}

// ============================================
// Main Scheduler Function
// ============================================

/**
 * Run scheduled sync for all active Amazon credentials
 * Called by /api/cron/ads-sync at 5 AM daily
 */
export async function runScheduledAmazonSync(): Promise<ScheduledSyncResult> {
  const startTime = Date.now()
  const config = getConfig()

  // Check if disabled
  if (config.disabled) {
    console.log('[Amazon Sync] Sync is disabled via DISABLE_AMAZON_SYNC')
    return {
      totalCredentials: 0,
      syncsTriggered: 0,
      syncsCompleted: 0,
      syncsFailed: 0,
      amazonAdsResults: [],
      amazonSpResults: [],
      skipped: 'disabled',
      duration: Date.now() - startTime,
    }
  }

  // Check weekend skip
  if (config.skipWeekends && isWeekend()) {
    console.log('[Amazon Sync] Skipping sync on weekend (SKIP_WEEKENDS=true)')
    return {
      totalCredentials: 0,
      syncsTriggered: 0,
      syncsCompleted: 0,
      syncsFailed: 0,
      amazonAdsResults: [],
      amazonSpResults: [],
      skipped: 'weekend',
      duration: Date.now() - startTime,
    }
  }

  console.log('[Amazon Sync] Starting scheduled sync...')

  // Fetch all active Amazon credentials
  const credentials = await prisma.integrationCredential.findMany({
    where: {
      integrationType: { in: ['amazon_ads', 'amazon_sp'] },
      status: 'active',
    },
    select: {
      id: true,
      integrationType: true,
      brandId: true,
      companyId: true,
    },
  })

  const amazonAdsResults: CredentialSyncResult[] = []
  const amazonSpResults: CredentialSyncResult[] = []
  let syncsCompleted = 0
  let syncsFailed = 0

  const dateRange = getYesterdayDateRange()

  // Process Amazon Ads credentials
  const adsCredentials = credentials.filter(c => c.integrationType === 'amazon_ads')
  console.log(`[Amazon Sync] Processing ${adsCredentials.length} Amazon Ads credentials`)

  for (const credential of adsCredentials) {
    const options: AdsSyncOptions = {
      credentialId: credential.id,
      syncType: 'full',
      dateRange,
    }

    const { result, error, retryCount } = await syncWithRetry(
      () => syncAmazonAds(options),
      config.maxRetries,
      credential.id,
      'amazon_ads'
    )

    if (result) {
      amazonAdsResults.push({
        credentialId: credential.id,
        integrationType: 'amazon_ads',
        status: result.status,
        syncLogId: result.syncLogId,
        retryCount,
      })
      if (result.status === 'completed' || result.status === 'partial') {
        syncsCompleted++
      } else {
        syncsFailed++
      }
    } else {
      amazonAdsResults.push({
        credentialId: credential.id,
        integrationType: 'amazon_ads',
        status: 'failed',
        error,
        retryCount,
      })
      syncsFailed++
    }

    // Stagger between credentials
    if (config.staggerMs > 0 && adsCredentials.indexOf(credential) < adsCredentials.length - 1) {
      await delay(config.staggerMs)
    }
  }

  // Process Amazon SP credentials (orders)
  const spCredentials = credentials.filter(c => c.integrationType === 'amazon_sp')
  console.log(`[Amazon Sync] Processing ${spCredentials.length} Amazon SP credentials`)

  for (const credential of spCredentials) {
    // SP-API orders sync requires brandId
    if (!credential.brandId) {
      console.warn(`[Amazon Sync] Skipping amazon_sp ${credential.id}: no brandId configured`)
      amazonSpResults.push({
        credentialId: credential.id,
        integrationType: 'amazon_sp',
        status: 'skipped',
        error: 'No brandId configured for credential',
        retryCount: 0,
      })
      continue
    }

    const options: OrderSyncOptions = {
      credentialId: credential.id,
      brandId: credential.brandId,
      dateRange,
    }

    const { result, error, retryCount } = await syncWithRetry(
      () => syncOrders(options),
      config.maxRetries,
      credential.id,
      'amazon_sp'
    )

    if (result) {
      amazonSpResults.push({
        credentialId: credential.id,
        integrationType: 'amazon_sp',
        status: result.status,
        syncLogId: result.syncLogId,
        retryCount,
      })
      if (result.status === 'completed' || result.status === 'partial') {
        syncsCompleted++
      } else {
        syncsFailed++
      }
    } else {
      amazonSpResults.push({
        credentialId: credential.id,
        integrationType: 'amazon_sp',
        status: 'failed',
        error,
        retryCount,
      })
      syncsFailed++
    }

    // Stagger between credentials
    if (config.staggerMs > 0 && spCredentials.indexOf(credential) < spCredentials.length - 1) {
      await delay(config.staggerMs)
    }
  }

  const duration = Date.now() - startTime
  console.log(
    `[Amazon Sync] Completed: ${syncsCompleted} succeeded, ${syncsFailed} failed, ` +
    `${amazonSpResults.filter(r => r.status === 'skipped').length} skipped. ` +
    `Duration: ${duration}ms`
  )

  return {
    totalCredentials: credentials.length,
    syncsTriggered: credentials.length,
    syncsCompleted,
    syncsFailed,
    amazonAdsResults,
    amazonSpResults,
    skipped: null,
    duration,
  }
}
```

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] File created at correct path
- [ ] All imports resolve
- [ ] TypeScript compiles without errors
- [ ] Follows existing service patterns

---

## Phase 2: Update Cron Route

### Subtask 2.1: Update ads-sync Route to Use New Scheduler
**File**: `/home/pbrown/SkuInventory/src/app/api/cron/ads-sync/route.ts`
**Pattern**: Existing file structure, enhance response

**Instructions**:
Replace content with:

```typescript
/**
 * POST /api/cron/ads-sync
 *
 * Scheduled endpoint for daily Amazon data sync (Ads + Orders).
 * Authenticated via CRON_SECRET header.
 *
 * Syncs:
 * - All active amazon_ads credentials (portfolios, campaigns, reports)
 * - All active amazon_sp credentials (orders to SalesDaily)
 *
 * Configuration (via environment variables):
 * - DISABLE_AMAZON_SYNC: Set to 'true' to disable
 * - SKIP_WEEKENDS: Set to 'true' to skip Saturday/Sunday
 * - SYNC_STAGGER_MS: Delay between credentials (default 5000)
 * - SYNC_MAX_RETRIES: Max retry attempts (default 3)
 */

import { NextRequest, NextResponse } from 'next/server'
import { runScheduledAmazonSync } from '@/services/amazon-sync/scheduler'

// Force dynamic rendering
export const dynamic = 'force-dynamic'

// Maximum execution time (10 minutes for large syncs)
export const maxDuration = 600

export async function POST(request: NextRequest) {
  try {
    // Verify cron secret
    const cronSecret = process.env.CRON_SECRET
    const providedSecret = request.headers.get('X-Cron-Secret')

    if (!cronSecret || cronSecret.length < 16) {
      console.error('[Amazon Sync Cron] CRON_SECRET not properly configured')
      return NextResponse.json(
        { error: 'Server configuration error' },
        { status: 500 }
      )
    }

    if (providedSecret !== cronSecret) {
      return NextResponse.json(
        { error: 'Invalid cron secret' },
        { status: 401 }
      )
    }

    // Run scheduled sync
    const result = await runScheduledAmazonSync()

    // Check if skipped
    if (result.skipped) {
      return NextResponse.json({
        success: true,
        skipped: result.skipped,
        message: result.skipped === 'disabled'
          ? 'Amazon sync is disabled via DISABLE_AMAZON_SYNC'
          : 'Amazon sync skipped on weekend (SKIP_WEEKENDS=true)',
        duration: result.duration,
      })
    }

    return NextResponse.json({
      success: true,
      totalCredentials: result.totalCredentials,
      syncsTriggered: result.syncsTriggered,
      syncsCompleted: result.syncsCompleted,
      syncsFailed: result.syncsFailed,
      amazonAdsResults: result.amazonAdsResults.map(r => ({
        credentialId: r.credentialId,
        status: r.status,
        syncLogId: r.syncLogId,
        error: r.error,
        retries: r.retryCount,
      })),
      amazonSpResults: result.amazonSpResults.map(r => ({
        credentialId: r.credentialId,
        status: r.status,
        syncLogId: r.syncLogId,
        error: r.error,
        retries: r.retryCount,
      })),
      duration: result.duration,
    })
  } catch (error) {
    console.error('[Amazon Sync Cron] Error:', error)
    return NextResponse.json(
      {
        success: false,
        error: error instanceof Error ? error.message : 'Failed to run Amazon sync',
      },
      { status: 500 }
    )
  }
}
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Route updated with new scheduler call
- [ ] Includes dynamic and maxDuration exports
- [ ] Response includes both amazon_ads and amazon_sp results
- [ ] Build passes

---

## Phase 3: Docker Cron Configuration

### Subtask 3.1: Create Cron Trigger Script
**File**: `/home/pbrown/SkuInventory/docker/cron/amazon-sync.sh` (CREATE)
**Pattern**: Follow `/docker/monitor/monitor.sh`

**Instructions**:
1. Create directory: `mkdir -p /home/pbrown/SkuInventory/docker/cron`
2. Create script:

```bash
#!/bin/sh
# Amazon Sync Cron Trigger Script
# Called by systemd timer or crontab at 5 AM daily

set -e

# Configuration from environment
APP_URL="${APP_URL:-http://172.16.20.50:4545}"
CRON_SECRET="${CRON_SECRET:-}"
LOG_FILE="${LOG_FILE:-/var/log/inventory/amazon-sync.log}"

log() {
    echo "[$(date -Iseconds)] $1" | tee -a "$LOG_FILE"
}

if [ -z "$CRON_SECRET" ]; then
    log "ERROR: CRON_SECRET not configured"
    exit 1
fi

log "Starting Amazon sync..."

# Make the request
RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$APP_URL/api/cron/ads-sync" \
    -H "X-Cron-Secret: $CRON_SECRET" \
    -H "Content-Type: application/json" \
    --max-time 660)

# Extract HTTP code (last line) and body (everything else)
HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
BODY=$(echo "$RESPONSE" | sed '$d')

log "HTTP Response: $HTTP_CODE"
log "Response: $BODY"

if [ "$HTTP_CODE" -eq 200 ]; then
    log "Amazon sync completed successfully"
    exit 0
else
    log "ERROR: Amazon sync failed with HTTP $HTTP_CODE"
    exit 1
fi
```

3. Make executable: `chmod +x /home/pbrown/SkuInventory/docker/cron/amazon-sync.sh`

**Validation**:
```bash
ls -la /home/pbrown/SkuInventory/docker/cron/amazon-sync.sh
cat /home/pbrown/SkuInventory/docker/cron/amazon-sync.sh | head -5
```

**Completion Criteria**:
- [ ] Script created
- [ ] Made executable
- [ ] Uses CRON_SECRET for auth
- [ ] Logs to file

---

## Phase 4: Documentation Updates

### Subtask 4.1: Update CRON-SCHEDULER-SETUP.md
**File**: `/home/pbrown/SkuInventory/docs/operations/CRON-SCHEDULER-SETUP.md`
**Pattern**: Follow existing documentation format

**Instructions**:
1. Update the table at lines 9-14 to change ads-sync to 5 AM:
```markdown
| `/api/cron/ads-sync` | POST | Daily 5:00 AM | Sync Amazon Ads + Orders data |
```

2. Update the schedule table (around line 42):
```markdown
| ads-sync | Daily 5:00 AM | `0 5 * * *` | Amazon data updated overnight |
```

3. Add new section after Authentication section (around line 35):

```markdown
## Amazon Sync Configuration

The `/api/cron/ads-sync` endpoint can be configured with these environment variables:

| Variable | Default | Description |
|----------|---------|-------------|
| `DISABLE_AMAZON_SYNC` | `false` | Set to `true` to disable all Amazon syncs |
| `SKIP_WEEKENDS` | `false` | Set to `true` to skip sync on Saturday/Sunday |
| `SYNC_TIMEZONE` | `America/New_York` | Timezone for scheduling (informational) |
| `SYNC_STAGGER_MS` | `5000` | Delay (ms) between syncing credentials |
| `SYNC_MAX_RETRIES` | `3` | Maximum retry attempts for failed syncs |

### What Gets Synced

1. **Amazon Ads** (`amazon_ads` credentials):
   - Advertising profiles
   - Portfolios
   - Campaigns
   - Ad groups
   - Search term reports (yesterday's data)

2. **Amazon SP-API** (`amazon_sp` credentials):
   - Orders from yesterday
   - Aggregated to SalesDaily records by ASIN

### Sync Results

The endpoint returns detailed results for each credential:

```json
{
  "success": true,
  "totalCredentials": 3,
  "syncsCompleted": 2,
  "syncsFailed": 1,
  "amazonAdsResults": [
    { "credentialId": "...", "status": "completed", "syncLogId": "...", "retries": 0 }
  ],
  "amazonSpResults": [
    { "credentialId": "...", "status": "completed", "syncLogId": "...", "retries": 0 }
  ],
  "duration": 45000
}
```
```

4. Update the Ads Sync Timer section (around line 107) to use 5 AM:
```markdown
OnCalendar=*-*-* 05:00:00
```

5. Update the traditional crontab section (around line 157):
```bash
# Amazon sync - daily at 5 AM
0 5 * * * root curl -s -X POST "${INVENTORY_URL}/api/cron/ads-sync" -H "X-Cron-Secret: ${CRON_SECRET}" >> /var/log/inventory/ads-sync.log 2>&1
```

**Validation**:
```bash
grep "5:00 AM" /home/pbrown/SkuInventory/docs/operations/CRON-SCHEDULER-SETUP.md
grep "DISABLE_AMAZON_SYNC" /home/pbrown/SkuInventory/docs/operations/CRON-SCHEDULER-SETUP.md
```

**Completion Criteria**:
- [ ] Schedule updated to 5 AM
- [ ] Configuration variables documented
- [ ] Response format documented
- [ ] systemd timer example updated

---

## Phase 5: Final Validation

### Subtask 5.1: Full Build and TypeScript Check
**Instructions**:
```bash
cd /home/pbrown/SkuInventory
npx tsc --noEmit
npm run build
npm run lint
```

**Completion Criteria**:
- [ ] TypeScript check passes
- [ ] Build succeeds
- [ ] Lint passes (or only pre-existing warnings)

### Subtask 5.2: Manual Endpoint Test (Optional)
**Instructions**:
```bash
# Test with disabled flag
DISABLE_AMAZON_SYNC=true curl -X POST "http://172.16.20.50:2345/api/cron/ads-sync" \
  -H "X-Cron-Secret: $(grep CRON_SECRET /home/pbrown/SkuInventory/docker/.env | cut -d= -f2)"

# Expected response: {"success":true,"skipped":"disabled",...}
```

**Completion Criteria**:
- [ ] Endpoint responds with 200
- [ ] Returns expected JSON structure

---

## Summary of Deliverables

**Files Created**: 2
- `/home/pbrown/SkuInventory/src/services/amazon-sync/scheduler.ts`
- `/home/pbrown/SkuInventory/docker/cron/amazon-sync.sh`

**Files Modified**: 4
- `/home/pbrown/SkuInventory/src/lib/env.ts` - Add new env vars
- `/home/pbrown/SkuInventory/.env.example` - Document env vars
- `/home/pbrown/SkuInventory/src/app/api/cron/ads-sync/route.ts` - Use new scheduler
- `/home/pbrown/SkuInventory/docs/operations/CRON-SCHEDULER-SETUP.md` - Update docs

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 0 -> 1 -> 2 -> 3 -> 4 -> 5)
2. Create directories before files (`mkdir -p` for docker/cron, src/services/amazon-sync)
3. Test completion criteria before moving to next subtask
4. Follow reference patterns exactly (especially CRON_SECRET auth pattern)
5. Run `npm run build` after each TypeScript file change

---

## Test Strategy Note

- This feature requires manual testing via curl commands
- E2E tests are not applicable (cron endpoint, no UI)
- Unit tests could be added for scheduler.ts but are not in scope for this issue
- Verify via SyncLog entries after first scheduled run

---

## Performance Metrics

| Phase | Estimated Duration |
|-------|-------------------|
| Phase 0: Environment Config | 15m |
| Phase 1: Scheduler Service | 45m |
| Phase 2: Cron Route Update | 15m |
| Phase 3: Docker Cron Script | 15m |
| Phase 4: Documentation | 30m |
| Phase 5: Validation | 15m |
| **Total** | **~2.5 hours** |

---

## Notes

1. **Timezone handling**: The SYNC_TIMEZONE is informational - actual scheduling is done by systemd/cron at the OS level. Document recommends setting OS timezone or using explicit OnCalendar with timezone.

2. **Brand requirement for SP-API**: If a credential has no brandId, the sync will skip it with a warning. This is by design - credentials should be configured with brandId during OAuth setup.

3. **Retry backoff**: Exponential backoff (1s, 2s, 4s, 8s...) prevents hammering the API during transient failures.

4. **SyncLog and Notifications**: The existing sync services already create SyncLog entries and Notifications on failure - no changes needed there.
