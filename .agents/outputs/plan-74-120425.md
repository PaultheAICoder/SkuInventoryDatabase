# Implementation Plan
**Generated**: 2025-12-04T03:45:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #74 - [Parent #9] Phase 7: Comprehensive testing, migration verification, and polish
**Estimated Build Time**: 12-16 hours
**Complexity**: High

## Investigation Summary

### Request Analysis
**Type**: Enhancement (Testing and Validation)
**Source**: GitHub Issue #74, part of Parent Issue #9 (Multi-location inventory)
**Priority**: High (Final phase of multi-location feature, production readiness)

### Task Classification
**Category**: VERIFICATION
**Test Strategy**: FULL - This IS the comprehensive testing phase
**Suggested Filter**: None - Run all tests

### Issue Validation
**Status**: Valid
**Recent Changes**: Phases 1-6 completed (issues #68-73):
- Phase 1: Location model and management UI (issue #68)
- Phase 2: LocationId on transactions (issue #69)
- Phase 3: Location-aware inventory queries (issue #70)
- Phase 4: Transfer transactions (issue #71)
- Phase 5: Finished goods output (issue #72)
- Phase 6: Per-location UI views and filters (issue #73)

All infrastructure is in place. This phase adds comprehensive test coverage.

### Current State Assessment

**Existing Test Infrastructure:**
- Unit tests: `tests/unit/` - 14 test files, Vitest with jsdom
- Integration tests: `tests/integration/` - 5 test files, Vitest with real PostgreSQL
- E2E tests: `tests/e2e/` - 21 spec files, Playwright with Chromium
- Test helpers: `tests/helpers/` - 4 helper modules (db, auth-mock, api, integration-context)

**Test Configuration Files:**
- `vitest.config.ts` - Unit test configuration
- `vitest.integration.config.ts` - Integration test configuration
- `playwright.config.ts` - E2E test configuration

**Services to Test (already implemented):**
- `src/services/location.ts` - Location CRUD operations
- `src/services/transfer.ts` - Transfer transaction atomicity
- `src/services/finished-goods.ts` - Finished goods inventory
- `src/services/inventory.ts` - Location-aware quantity queries

**API Routes to Test:**
- `src/app/api/locations/route.ts` - Location management endpoints
- `src/app/api/locations/[id]/route.ts` - Individual location CRUD
- `src/app/api/transactions/transfer/route.ts` - Transfer creation
- `src/app/api/transactions/build/route.ts` - Build with output location

**Migration Files:**
- `20251203230836_add_location_model` - Location table
- `20251203234127_add_location_to_transaction` - LocationId on transactions
- `20251204021458_add_transfer_transaction_type` - Transfer type enum
- `20251204024531_add_finished_goods_line` - FinishedGoodsLine table

### Dependencies & Blockers
1. **Depends on**: All Phase 1-6 features complete (verified - issues #68-73 closed)
2. **auth-mock needs update**: Missing `selectedCompanyId` in test sessions (session structure changed)
3. **cleanupTestData needs update**: Does not clean up Location, FinishedGoodsLine tables

**Can Proceed?**: YES - with fixes to test infrastructure

### Complexity Assessment
**Complexity**: High
**Effort**: 12-16 hours
**Risk**: Medium - primarily new test code, minimal production changes

### Patterns Identified
**Primary**: `tests/integration/transactions.test.ts` - Integration test pattern for transaction APIs
**Secondary**: `tests/unit/inventory-quantity.test.ts` - Unit test pattern with mocked Prisma
**E2E Pattern**: `tests/e2e/location-management.spec.ts` - E2E test pattern with login flow

### Ripple Effect Analysis
**Files Identified**: 4 existing files require modification
- `tests/helpers/auth-mock.ts` - Add selectedCompanyId to session structure
- `tests/helpers/db.ts` - Add cleanup for Location, FinishedGoodsLine tables
- `tests/helpers/integration-context.ts` - Add location test helpers
- `tests/unit/inventory-quantity.test.ts` - Add location-filtered test cases

**New Files Required**: 11 test files
- 4 unit test files
- 2 integration test files
- 3 E2E test files
- 2 performance-related test cases (embedded in unit tests)

---

## Executive Summary
This phase creates comprehensive test coverage for the multi-location inventory feature completed in Phases 1-6. We will create unit tests for location, transfer, and finished-goods services, integration tests for location-aware transactions and APIs, E2E tests for complete user workflows, and verify migration safety. The goal is production readiness with >80% code coverage on location features.

## Phase 0: Test Infrastructure Updates

### Subtask 0.1: Update auth-mock.ts for selectedCompanyId
**File**: `/home/pbrown/SkuInventory/tests/helpers/auth-mock.ts`
**Pattern**: Follow existing session structure in `src/lib/auth.ts`
**Instructions**:
1. Add `selectedCompanyId` to `TestUserSession` interface
2. Update `initializeTestSessions` to populate `selectedCompanyId` from company.id
3. Ensure session matches NextAuth session structure used by API routes

**Code Changes**:
```typescript
// Update TestUserSession interface (around line 32)
export interface TestUserSession {
  user: {
    id: string
    email: string
    name: string
    role: 'admin' | 'ops' | 'viewer'
    companyId: string
    companyName: string
    selectedCompanyId: string  // ADD THIS
  }
}

// Update TEST_SESSIONS initialization (around line 92-101)
TEST_SESSIONS.admin = {
  user: {
    id: admin.id,
    email: admin.email,
    name: admin.name,
    role: admin.role as 'admin',
    companyId: company.id,
    companyName: company.name,
    selectedCompanyId: company.id,  // ADD THIS
  },
}
// Same for ops and viewer sessions
```

**Validation**:
```bash
npx tsc --noEmit
npm run test:integration -- --run
```
**Completion Criteria**:
- [ ] TestUserSession interface includes selectedCompanyId
- [ ] All three session types (admin, ops, viewer) have selectedCompanyId
- [ ] Existing integration tests still pass

### Subtask 0.2: Update db.ts cleanup for new tables
**File**: `/home/pbrown/SkuInventory/tests/helpers/db.ts`
**Pattern**: Follow existing deletion order respecting foreign keys
**Instructions**:
1. Add deletion of `FinishedGoodsLine` before `Transaction`
2. Add deletion of `Location` after transactions (but keep company)
3. Maintain proper foreign key order

**Code Changes**:
```typescript
// Update cleanupTestData function (around line 33-42)
export async function cleanupTestData(prisma: PrismaClient): Promise<void> {
  // Delete in correct order to respect foreign keys
  await prisma.finishedGoodsLine.deleteMany({})  // ADD - before transactions
  await prisma.transactionLine.deleteMany({})
  await prisma.transaction.deleteMany({})
  await prisma.bOMLine.deleteMany({})
  await prisma.bOMVersion.deleteMany({})
  await prisma.sKU.deleteMany({})
  await prisma.component.deleteMany({})
  await prisma.location.deleteMany({})  // ADD - after transactions
  await prisma.securityEvent.deleteMany({})
  // Don't delete users/brands/companies as they may be needed for auth
}
```

**Validation**:
```bash
npm run test:integration -- --run
```
**Completion Criteria**:
- [ ] cleanupTestData deletes FinishedGoodsLine records
- [ ] cleanupTestData deletes Location records
- [ ] Integration tests pass without foreign key errors

### Subtask 0.3: Add location test helpers to integration-context.ts
**File**: `/home/pbrown/SkuInventory/tests/helpers/integration-context.ts`
**Pattern**: Follow `createTestComponentInDb` pattern
**Instructions**:
1. Add `createTestLocationInDb` helper function
2. Add `createTestTransferInDb` helper function
3. Add helper to get default location for a company

**Code Changes**:
```typescript
/**
 * Create test location in database
 */
export async function createTestLocationInDb(
  companyId: string,
  overrides: Partial<{
    name: string
    type: 'warehouse' | 'threepl' | 'fba' | 'finished_goods'
    isDefault: boolean
  }> = {}
): Promise<{ id: string; name: string; type: string }> {
  const db = getIntegrationPrisma()
  const timestamp = Date.now()

  const location = await db.location.create({
    data: {
      companyId,
      name: overrides.name ?? `Test Location ${timestamp}`,
      type: overrides.type ?? 'warehouse',
      isDefault: overrides.isDefault ?? false,
      isActive: true,
    },
  })

  return { id: location.id, name: location.name, type: location.type }
}

/**
 * Get or create default location for a company
 */
export async function getOrCreateDefaultLocation(
  companyId: string
): Promise<{ id: string; name: string }> {
  const db = getIntegrationPrisma()

  let location = await db.location.findFirst({
    where: { companyId, isDefault: true },
  })

  if (!location) {
    location = await db.location.create({
      data: {
        companyId,
        name: 'Main Warehouse',
        type: 'warehouse',
        isDefault: true,
        isActive: true,
      },
    })
  }

  return { id: location.id, name: location.name }
}
```

**Validation**:
```bash
npx tsc --noEmit
```
**Completion Criteria**:
- [ ] createTestLocationInDb function exported
- [ ] getOrCreateDefaultLocation function exported
- [ ] TypeScript compiles without errors

---

## Phase 1: Unit Tests

### Subtask 1.1: Create location-service.test.ts
**File**: `/home/pbrown/SkuInventory/tests/unit/location-service.test.ts`
**Pattern**: Follow `tests/unit/inventory-service.test.ts`
**Instructions**:
Create unit tests for location service functions:
1. `ensureDefaultLocation` - creates default when none exists, makes first location default
2. `setDefaultLocation` - unsets other defaults, sets new default
3. `canDeactivateLocation` - cannot deactivate default
4. `canDeleteLocation` - cannot delete default
5. `getDefaultLocation` - returns correct location
6. `getDefaultLocationId` - returns id or null

**Test Cases**:
```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest'

// Mock prisma before imports
vi.mock('@/lib/db', () => ({
  prisma: {
    location: {
      findMany: vi.fn(),
      findFirst: vi.fn(),
      findUnique: vi.fn(),
      create: vi.fn(),
      update: vi.fn(),
      updateMany: vi.fn(),
    },
    $transaction: vi.fn(),
  },
}))

import {
  ensureDefaultLocation,
  setDefaultLocation,
  canDeactivateLocation,
  canDeleteLocation,
  getDefaultLocation,
  getDefaultLocationId,
} from '@/services/location'
import { prisma } from '@/lib/db'

describe('Location Service', () => {
  beforeEach(() => {
    vi.clearAllMocks()
  })

  describe('ensureDefaultLocation', () => {
    it('creates default warehouse when no locations exist', async () => {...})
    it('makes first location default when none is marked default', async () => {...})
    it('does nothing when default location already exists', async () => {...})
  })

  describe('setDefaultLocation', () => {
    it('unsets existing defaults before setting new one', async () => {...})
  })

  describe('canDeactivateLocation', () => {
    it('returns false with reason for default location', async () => {...})
    it('returns true for non-default location', async () => {...})
  })

  describe('canDeleteLocation', () => {
    it('returns false with reason for default location', async () => {...})
    it('returns true for non-default location', async () => {...})
  })

  describe('getDefaultLocation', () => {
    it('returns the default active location', async () => {...})
    it('returns null when no default exists', async () => {...})
  })

  describe('getDefaultLocationId', () => {
    it('returns id of default location', async () => {...})
    it('returns null when no default exists', async () => {...})
  })
})
```

**Validation**:
```bash
npm run test -- tests/unit/location-service.test.ts
```
**Completion Criteria**:
- [ ] All 10+ test cases pass
- [ ] Tests cover happy path and error cases
- [ ] No TypeScript errors

### Subtask 1.2: Create transfer-service.test.ts
**File**: `/home/pbrown/SkuInventory/tests/unit/transfer-service.test.ts`
**Pattern**: Follow `tests/unit/inventory-quantity.test.ts`
**Instructions**:
Create unit tests for transfer service:
1. `createTransferTransaction` validation tests
2. Atomicity test (mock $transaction)
3. Error cases for same location, not found, insufficient inventory

**Test Cases**:
```typescript
describe('Transfer Service', () => {
  describe('createTransferTransaction', () => {
    it('rejects transfer to same location', async () => {...})
    it('rejects transfer when component not found', async () => {...})
    it('rejects transfer when source location not found', async () => {...})
    it('rejects transfer when destination location not active', async () => {...})
    it('rejects transfer when insufficient inventory at source', async () => {...})
    it('creates transaction with two lines (negative and positive)', async () => {...})
    it('uses $transaction for atomicity', async () => {...})
    it('returns correct TransferResult structure', async () => {...})
  })
})
```

**Validation**:
```bash
npm run test -- tests/unit/transfer-service.test.ts
```
**Completion Criteria**:
- [ ] All 8+ test cases pass
- [ ] Tests verify atomicity requirement
- [ ] Tests cover all validation errors

### Subtask 1.3: Create finished-goods-service.test.ts
**File**: `/home/pbrown/SkuInventory/tests/unit/finished-goods-service.test.ts`
**Pattern**: Follow `tests/unit/inventory-quantity.test.ts`
**Instructions**:
Create unit tests for finished goods service:
1. `getSkuQuantity` - with and without locationId
2. `getSkuQuantities` - batch query with location filter
3. `getSkuInventorySummary` - grouped by location
4. `adjustFinishedGoods` - creates adjustment transaction
5. `transferFinishedGoods` - validates and transfers

**Test Cases**:
```typescript
describe('Finished Goods Service', () => {
  describe('getSkuQuantity', () => {
    it('returns global total when no locationId', async () => {...})
    it('returns location-specific total when locationId provided', async () => {...})
    it('returns 0 when no finished goods lines exist', async () => {...})
  })

  describe('getSkuQuantities', () => {
    it('returns quantities for multiple SKUs', async () => {...})
    it('handles empty SKU list', async () => {...})
    it('filters by location when provided', async () => {...})
  })

  describe('getSkuInventorySummary', () => {
    it('groups quantities by location', async () => {...})
    it('includes location details', async () => {...})
    it('excludes locations with zero quantity', async () => {...})
  })

  describe('adjustFinishedGoods', () => {
    it('creates adjustment transaction with finished goods line', async () => {...})
    it('allows positive and negative adjustments', async () => {...})
  })

  describe('transferFinishedGoods', () => {
    it('rejects transfer to same location', async () => {...})
    it('rejects when insufficient at source', async () => {...})
    it('creates two finished goods lines (negative and positive)', async () => {...})
  })
})
```

**Validation**:
```bash
npm run test -- tests/unit/finished-goods-service.test.ts
```
**Completion Criteria**:
- [ ] All 14+ test cases pass
- [ ] Tests cover query and mutation operations
- [ ] Tests verify location filtering

### Subtask 1.4: Update inventory-quantity.test.ts for location filtering
**File**: `/home/pbrown/SkuInventory/tests/unit/inventory-quantity.test.ts`
**Pattern**: Add to existing test file
**Instructions**:
Add new test cases for location-filtered queries:
1. `getComponentQuantity` with locationId parameter
2. `getComponentQuantities` with locationId parameter
3. Backward compatibility (no location = all locations)
4. Transfer handling in location queries

**Test Cases to Add**:
```typescript
describe('getComponentQuantity with locationId', () => {
  it('returns quantity at specific location', async () => {...})
  it('handles non-transfer transactions at location', async () => {...})
  it('handles transfer FROM location (negative)', async () => {...})
  it('handles transfer TO location (positive)', async () => {...})
  it('combines regular and transfer quantities correctly', async () => {...})
})

describe('getComponentQuantities with locationId', () => {
  it('returns location-filtered quantities for multiple components', async () => {...})
  it('handles transfers correctly for each component', async () => {...})
})
```

**Validation**:
```bash
npm run test -- tests/unit/inventory-quantity.test.ts
```
**Completion Criteria**:
- [ ] New location-filtered test cases pass
- [ ] Existing tests still pass (backward compatibility)
- [ ] Transfer handling tested

---

## Phase 2: Integration Tests

### Subtask 2.1: Create location-transactions.test.ts
**File**: `/home/pbrown/SkuInventory/tests/integration/location-transactions.test.ts`
**Pattern**: Follow `tests/integration/transactions.test.ts`
**Instructions**:
Create integration tests for location-aware transactions:
1. Receipt to specific location increases that location's inventory
2. Receipt without location uses default location
3. Adjustment at location only affects that location
4. Build consumes from specified location
5. Build outputs finished goods to specified location
6. Insufficient inventory at location blocks build (unless override)
7. Transfer decreases source, increases destination
8. Transfer is atomic (both or neither)
9. Cannot transfer more than available at source
10. Cannot transfer between same location

**Key Test Setup**:
```typescript
import { describe, it, expect, beforeAll, beforeEach, afterAll } from 'vitest'
import { setTestSession, clearTestSession, TEST_SESSIONS, initializeTestSessions } from '../helpers/auth-mock'
import {
  getIntegrationPrisma,
  cleanupBeforeTest,
  createTestRequest,
  parseRouteResponse,
  createTestComponentInDb,
  createTestSKUInDb,
  createTestLocationInDb,
  getOrCreateDefaultLocation,
} from '../helpers/integration-context'
import { disconnectTestDb } from '../helpers/db'

// Import route handlers
import { POST as createReceipt } from '@/app/api/transactions/receipt/route'
import { POST as createAdjustment } from '@/app/api/transactions/adjustment/route'
import { POST as createBuild } from '@/app/api/transactions/build/route'
import { POST as createTransfer } from '@/app/api/transactions/transfer/route'

describe('Location-Aware Transactions', () => {
  beforeAll(async () => {
    const prisma = getIntegrationPrisma()
    await initializeTestSessions(prisma)
  })

  beforeEach(async () => {
    await cleanupBeforeTest()
    clearTestSession()
  })

  afterAll(async () => {
    await disconnectTestDb()
  })

  describe('Receipt to specific location', () => {
    it('increases inventory at specified location only', async () => {...})
    it('uses default location when none specified', async () => {...})
  })

  describe('Adjustment at location', () => {
    it('only affects specified location inventory', async () => {...})
  })

  describe('Build with location', () => {
    it('consumes from specified location', async () => {...})
    it('outputs finished goods to output location', async () => {...})
    it('blocks when insufficient at location unless override', async () => {...})
  })

  describe('Transfer between locations', () => {
    it('decreases source and increases destination atomically', async () => {...})
    it('rejects transfer exceeding available quantity', async () => {...})
    it('rejects transfer to same location', async () => {...})
    it('appears correctly in transaction history', async () => {...})
  })
})
```

**Validation**:
```bash
npm run test:integration -- tests/integration/location-transactions.test.ts
```
**Completion Criteria**:
- [ ] All 10+ test cases pass
- [ ] Tests verify actual database state
- [ ] Transfer atomicity verified

### Subtask 2.2: Create location-api.test.ts
**File**: `/home/pbrown/SkuInventory/tests/integration/location-api.test.ts`
**Pattern**: Follow `tests/integration/settings.test.ts`
**Instructions**:
Create integration tests for location API endpoints:
1. Location management endpoints (CRUD)
2. Authorization (admin can create, viewer cannot)
3. Location-filtered component queries
4. Location-filtered dashboard stats
5. Tenant isolation (cannot access other company's locations)

**Test Cases**:
```typescript
describe('Location API', () => {
  describe('GET /api/locations', () => {
    it('lists locations for authenticated user', async () => {...})
    it('filters by type', async () => {...})
    it('filters by isActive', async () => {...})
    it('respects pagination', async () => {...})
    it('scopes to selected company', async () => {...})
  })

  describe('POST /api/locations', () => {
    it('admin can create location', async () => {...})
    it('ops cannot create location (403)', async () => {...})
    it('viewer cannot create location (403)', async () => {...})
    it('rejects duplicate name in same company', async () => {...})
    it('handles setting as default (unsets others)', async () => {...})
  })

  describe('PATCH /api/locations/[id]', () => {
    it('admin can update location', async () => {...})
    it('cannot deactivate default location', async () => {...})
  })

  describe('DELETE /api/locations/[id]', () => {
    it('admin can deactivate location', async () => {...})
    it('cannot delete default location', async () => {...})
  })

  describe('Location-filtered queries', () => {
    it('GET /api/components respects locationId filter', async () => {...})
    it('GET /api/dashboard/stats respects locationId filter', async () => {...})
  })

  describe('Tenant isolation', () => {
    it('cannot list locations from another company', async () => {...})
    it('cannot update location from another company', async () => {...})
  })
})
```

**Validation**:
```bash
npm run test:integration -- tests/integration/location-api.test.ts
```
**Completion Criteria**:
- [ ] All 15+ test cases pass
- [ ] Authorization properly tested
- [ ] Tenant isolation verified

---

## Phase 3: E2E Tests

### Subtask 3.1: Update location-management.spec.ts (existing file)
**File**: `/home/pbrown/SkuInventory/tests/e2e/location-management.spec.ts`
**Pattern**: Follow existing patterns in file
**Instructions**:
Add additional E2E tests:
1. Create location with valid data
2. Create location with duplicate name (should fail)
3. Deactivate location (soft delete)
4. Cannot deactivate default location
5. Edit location name and type

**Test Cases to Add**:
```typescript
test('Can create new location', async ({ page }) => {
  await page.goto('/settings/locations/new')
  await page.fill('input[name="name"]', 'Test Warehouse')
  await page.click('button[role="combobox"]')
  await page.click('[role="option"]:has-text("Warehouse")')
  await page.click('button[type="submit"]')
  await page.waitForURL(/\/settings\/locations$/)
  await expect(page.locator('text=Test Warehouse')).toBeVisible()
})

test('Duplicate name shows error', async ({ page }) => {...})

test('Can deactivate non-default location', async ({ page }) => {...})

test('Cannot deactivate default location', async ({ page }) => {...})
```

**Validation**:
```bash
npx playwright test tests/e2e/location-management.spec.ts
```
**Completion Criteria**:
- [ ] All new test cases pass
- [ ] Existing tests still pass
- [ ] Tests run in <60 seconds

### Subtask 3.2: Create location-transactions.spec.ts
**File**: `/home/pbrown/SkuInventory/tests/e2e/location-transactions.spec.ts`
**Pattern**: Follow `tests/e2e/full-workflow.spec.ts`
**Instructions**:
Create E2E tests for transaction flows with locations:
1. Receipt to specific location via UI
2. Adjustment at specific location via UI
3. Build with location selection
4. Build with output location for finished goods
5. View transactions filtered by location

**Test Cases**:
```typescript
test.describe('Location-Aware Transactions', () => {
  test('Receipt assigns to selected location', async ({ page }) => {...})
  test('Adjustment updates correct location inventory', async ({ page }) => {...})
  test('Build consumes from selected location', async ({ page }) => {...})
  test('Build outputs finished goods to output location', async ({ page }) => {...})
  test('Transaction list filters by location', async ({ page }) => {...})
})
```

**Validation**:
```bash
npx playwright test tests/e2e/location-transactions.spec.ts
```
**Completion Criteria**:
- [ ] All 5 test cases pass
- [ ] UI interactions verified
- [ ] Data persists correctly

### Subtask 3.3: Create transfer-flow.spec.ts
**File**: `/home/pbrown/SkuInventory/tests/e2e/transfer-flow.spec.ts`
**Pattern**: Follow `tests/e2e/full-workflow.spec.ts`
**Instructions**:
Create E2E tests for complete transfer workflow:
1. Navigate to transfer form
2. Select component, source, destination, quantity
3. Submit and verify success
4. Verify source inventory decreased
5. Verify destination inventory increased
6. Verify transaction appears in history

**Test Cases**:
```typescript
test.describe('Transfer Workflow', () => {
  test('Complete transfer flow from start to finish', async ({ page }) => {
    // Setup: Create component with inventory at source location
    // Step 1: Navigate to transfer form
    // Step 2: Fill form (component, source, destination, quantity)
    // Step 3: Submit transfer
    // Step 4: Verify success message
    // Step 5: Check source location inventory decreased
    // Step 6: Check destination location inventory increased
    // Step 7: Verify transfer in transaction history
  })

  test('Transfer shows validation error when insufficient inventory', async ({ page }) => {...})

  test('Transfer shows error when selecting same location', async ({ page }) => {...})
})
```

**Validation**:
```bash
npx playwright test tests/e2e/transfer-flow.spec.ts
```
**Completion Criteria**:
- [ ] All 3 test cases pass
- [ ] Complete workflow verified
- [ ] Error handling tested

### Subtask 3.4: Create finished-goods-flow.spec.ts
**File**: `/home/pbrown/SkuInventory/tests/e2e/finished-goods-flow.spec.ts`
**Pattern**: Follow `tests/e2e/full-workflow.spec.ts`
**Instructions**:
Create E2E tests for finished goods flow:
1. Build with output location creates finished goods
2. SKU detail page shows finished goods by location
3. Finished goods can be transferred between locations
4. Finished goods appear in exports

**Test Cases**:
```typescript
test.describe('Finished Goods Flow', () => {
  test('Build creates finished goods at output location', async ({ page }) => {...})
  test('SKU detail shows finished goods inventory by location', async ({ page }) => {...})
  test('Finished goods transfer between locations', async ({ page }) => {...})
})
```

**Validation**:
```bash
npx playwright test tests/e2e/finished-goods-flow.spec.ts
```
**Completion Criteria**:
- [ ] All 3 test cases pass
- [ ] Finished goods workflow verified
- [ ] Location breakdown displayed

---

## Phase 4: Performance Tests

### Subtask 4.1: Add performance test cases to unit tests
**File**: `/home/pbrown/SkuInventory/tests/unit/inventory-quantity.test.ts`
**Pattern**: Add timed assertions
**Instructions**:
Add performance-focused test cases:
1. Query across 10 locations under 100ms
2. Batch query for 100 components under 200ms

**Test Cases**:
```typescript
describe('Performance', () => {
  it('queries component quantity across multiple locations efficiently', async () => {
    // Setup mock to simulate 10 locations
    const start = Date.now()
    // Call function
    const duration = Date.now() - start
    expect(duration).toBeLessThan(100)
  })

  it('batch queries 100 components efficiently', async () => {
    const componentIds = Array.from({ length: 100 }, (_, i) => `comp-${i}`)
    const start = Date.now()
    // Call function
    const duration = Date.now() - start
    expect(duration).toBeLessThan(200)
  })
})
```

**Note**: For comprehensive performance testing with real data, integration tests would be more meaningful. These unit tests verify code path efficiency with mocks.

**Validation**:
```bash
npm run test -- tests/unit/inventory-quantity.test.ts
```
**Completion Criteria**:
- [ ] Performance test cases pass
- [ ] Query times within acceptable thresholds

---

## Phase 5: Migration Verification

### Subtask 5.1: Document migration verification checklist
**File**: `/home/pbrown/SkuInventory/completion-docs/migration-verification-74.md`
**Instructions**:
Create documentation with migration verification checklist and manual verification steps.

**Content**:
```markdown
# Migration Verification Checklist - Issue #74

## Fresh Database Migration
- [ ] Run `npx prisma migrate deploy` on empty database
- [ ] Verify all tables created: Location, FinishedGoodsLine, updated Transaction
- [ ] Verify indexes created on Location, Transaction location fields
- [ ] Verify enum values added (TransactionType.transfer, LocationType)

## Existing Database Migration
- [ ] Backup existing database
- [ ] Run `npx prisma migrate deploy`
- [ ] Verify default location created per company
- [ ] Verify existing transactions assigned default location
- [ ] Verify application works immediately after migration

## Rollback Verification
- [ ] Document rollback procedure
- [ ] Test rollback on staging environment

## Post-Migration Validation
- [ ] Run full test suite: `npm run test:all`
- [ ] Run E2E tests: `npm run test:e2e`
- [ ] Manual smoke test of all user flows
```

**Validation**:
N/A - Documentation only
**Completion Criteria**:
- [ ] Checklist document created
- [ ] All migration files documented
- [ ] Rollback procedure documented

---

## Phase 6: Index Optimization Review

### Subtask 6.1: Review and verify location-related indexes
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Instructions**:
Review existing indexes and verify they are optimal for location queries. Document findings.

**Current Indexes to Verify**:
```prisma
// Location model
@@unique([companyId, name])
@@index([companyId, isActive])

// Transaction model
@@index([locationId])
@@index([fromLocationId])
@@index([toLocationId])

// FinishedGoodsLine model
@@index([skuId])
@@index([locationId])
@@index([transactionId])
```

**Potential Optimizations** (if needed):
- Compound index on Transaction: `@@index([companyId, locationId])`
- Compound index on FinishedGoodsLine: `@@index([skuId, locationId])`

**Validation**:
```bash
# Analyze query plans (manual step)
psql -d $DATABASE_URL -c "EXPLAIN ANALYZE SELECT ... FROM transactions WHERE locationId = '...' AND companyId = '...'"
```
**Completion Criteria**:
- [ ] All indexes reviewed
- [ ] Query performance verified
- [ ] Any new indexes added if needed

---

## Summary of Deliverables

**Files Created**: 11 files
- Unit Tests: 3 new files
  - `tests/unit/location-service.test.ts`
  - `tests/unit/transfer-service.test.ts`
  - `tests/unit/finished-goods-service.test.ts`
- Integration Tests: 2 new files
  - `tests/integration/location-transactions.test.ts`
  - `tests/integration/location-api.test.ts`
- E2E Tests: 3 new files
  - `tests/e2e/location-transactions.spec.ts`
  - `tests/e2e/transfer-flow.spec.ts`
  - `tests/e2e/finished-goods-flow.spec.ts`
- Documentation: 1 new file
  - `completion-docs/migration-verification-74.md`

**Files Modified**: 5 files
- `tests/helpers/auth-mock.ts` - Add selectedCompanyId
- `tests/helpers/db.ts` - Clean up new tables
- `tests/helpers/integration-context.ts` - Add location helpers
- `tests/unit/inventory-quantity.test.ts` - Add location-filtered tests
- `tests/e2e/location-management.spec.ts` - Add CRUD tests

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 0 first - infrastructure must be fixed before tests)
2. Complete Phase 0 fully before Phase 1 - existing tests must pass with updated helpers
3. Test completion criteria before next subtask
4. Follow reference patterns exactly (especially for mock setup in unit tests)
5. Run validation commands after each subtask

## Test Strategy Note
- Use Vitest for unit tests (`npm run test`)
- Use Vitest with integration config for integration tests (`npm run test:integration`)
- Use Playwright for E2E tests (`npm run test:e2e`)

## Final Validation Commands
```bash
# After all phases complete:
npm run build          # Must pass
npx tsc --noEmit       # Must pass
npm run lint           # Must pass
npm run test           # Unit tests must pass
npm run test:integration  # Integration tests must pass
npm run test:e2e       # E2E tests must pass

# Coverage check (if configured)
npm run test -- --coverage
```

## Performance Metrics
| Phase | Estimated Duration |
|-------|----------|
| Phase 0: Infrastructure | 1h |
| Phase 1: Unit Tests | 4h |
| Phase 2: Integration Tests | 4h |
| Phase 3: E2E Tests | 3h |
| Phase 4: Performance Tests | 30m |
| Phase 5: Migration Docs | 30m |
| Phase 6: Index Review | 30m |
| **Total** | **~13.5h** |

---

## Acceptance Criteria (from Issue #74)
- [ ] All unit tests for location services pass
- [ ] All integration tests for location APIs pass
- [ ] All E2E tests for location workflows pass
- [ ] Existing tests still pass (backward compatibility)
- [ ] Fresh database migration works correctly
- [ ] Existing database migration backfills correctly
- [ ] No performance regression (queries under 100ms for typical datasets)
- [ ] All indexes are properly defined
- [ ] Code coverage for location features > 80%
- [ ] Manual smoke test of all user flows passes
- [ ] `npm test` passes all tests
- [ ] `npm run build` passes without errors
- [ ] `npx tsc --noEmit` passes without errors
