# Implementation Plan
**Generated**: 2025-12-04T10:30:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: Issue #94
**Estimated Build Time**: 4-6 hours
**Complexity**: Moderate

## Investigation Summary

### Request Analysis
**Type**: Feature
**Source**: GitHub Issue #94 (Parent #24)
**Priority**: Medium

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: None (manual testing recommended for UI components)

### Issue Validation
**Status**: Valid
**Recent Changes**:
- Issue #77 added UserCompany join table (prerequisite complete)
- Issue #92 added company management CRUD (prerequisite complete)
- Issue #96 updated data queries for company scoping (complete)

### Current State Assessment
- **Existing components**:
  - `UserForm.tsx` - Handles user create/edit, needs company assignment section
  - `UserTable.tsx` - Displays user list, needs company count column
  - User edit page fetches user data from `/api/users/[id]`
- **Database**: UserCompany model exists in Prisma schema (lines 120-132)
- **API Routes**:
  - GET/PATCH `/api/users/[id]` - Exists but does not return/handle company assignments
  - GET `/api/companies` - Returns all companies (admin only)
- **Types**:
  - `UserResponse` in `src/types/user.ts` - Does not include company assignments
  - `CompanyResponse` in `src/types/company.ts` - Exists

### Dependencies & Blockers
1. **UserCompany model** - EXISTS (schema lines 120-132)
2. **Company list API** - EXISTS at `/api/companies` (admin only)
3. **Checkbox UI component** - EXISTS at `src/components/ui/checkbox.tsx`
4. **Label UI component** - EXISTS at `src/components/ui/label.tsx`

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Moderate
**Effort**: 4-6 hours
**Risk**: Low - follows existing patterns

### Patterns Identified
**Primary**: `src/components/features/UserForm.tsx` - Form structure to extend
**Secondary**: `src/components/features/CompanyTable.tsx` - Table pattern with badges
**API Pattern**: `src/app/api/users/[id]/route.ts` - Admin-only route pattern

### Ripple Effect Analysis
**Files Identified**: 6 files
- `/home/pbrown/SkuInventory/src/types/user.ts` - Add company assignment types
- `/home/pbrown/SkuInventory/src/app/api/users/[id]/route.ts` - Return user's companies in GET, handle assignments in PATCH
- `/home/pbrown/SkuInventory/src/app/api/users/[id]/companies/route.ts` - NEW dedicated endpoint
- `/home/pbrown/SkuInventory/src/components/features/CompanyAssignment.tsx` - NEW component
- `/home/pbrown/SkuInventory/src/components/features/UserTable.tsx` - Add company column
- `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/users/[id]/edit/page.tsx` - Integrate company assignment

---

## Executive Summary
This implementation adds user-company assignment management capabilities. Admins will be able to assign users to multiple companies via a checkbox list on the user edit page. The UserTable will display company assignments, and new API endpoints will handle the assignment CRUD operations.

## Phase 1: Types Layer

### Subtask 1.1: Extend User Types
**File**: `/home/pbrown/SkuInventory/src/types/user.ts`
**Pattern**: Follow existing interface structure
**Instructions**:
1. Add `UserCompanyAssignment` interface with fields: `id`, `companyId`, `companyName`, `role`, `assignedAt`
2. Extend `UserResponse` to optionally include `companies?: UserCompanyAssignment[]`
3. Add `UpdateUserCompaniesInput` schema with `companyIds: string[]` validation
4. Ensure at least one company required validation

**Code to add** (after line 50, before `changePasswordSchema`):
```typescript
// User's company assignment (what API returns)
export interface UserCompanyAssignment {
  id: string
  companyId: string
  companyName: string
  role: 'admin' | 'ops' | 'viewer'
  assignedAt: string
}

// Extended user response with company assignments
export interface UserWithCompaniesResponse extends UserResponse {
  companies: UserCompanyAssignment[]
}

// Update user company assignments schema
export const updateUserCompaniesSchema = z.object({
  companyIds: z.array(z.string().uuid()).min(1, 'At least one company is required'),
})

export type UpdateUserCompaniesInput = z.infer<typeof updateUserCompaniesSchema>
```

**Completion Criteria**:
- [ ] Types compile without errors
- [ ] `npx tsc --noEmit` passes

---

## Phase 2: API Layer

### Subtask 2.1: Update GET /api/users/[id] to Return Companies
**File**: `/home/pbrown/SkuInventory/src/app/api/users/[id]/route.ts`
**Pattern**: Follow existing query pattern with Prisma includes
**Instructions**:
1. Update the Prisma query in GET handler to include `userCompanies` with company relation
2. Transform the response to include company assignment data
3. Ensure company names are included in response

**Modify GET handler** (around lines 26-54):
- Add to select: `userCompanies: { include: { company: { select: { id: true, name: true } } } }`
- Transform response to include companies array with `id`, `companyId`, `companyName`, `role`, `assignedAt`

**Completion Criteria**:
- [ ] GET /api/users/[id] returns `companies` array
- [ ] Each company has `id`, `companyId`, `companyName`, `role`, `assignedAt`
- [ ] `npm run build` passes

### Subtask 2.2: Create Dedicated Companies Assignment Endpoint
**File**: `/home/pbrown/SkuInventory/src/app/api/users/[id]/companies/route.ts` (NEW)
**Pattern**: Follow `/home/pbrown/SkuInventory/src/app/api/users/[id]/route.ts` authentication pattern
**Instructions**:
1. Create new route.ts file
2. Implement GET handler - return user's company assignments
3. Implement PUT handler:
   - Validate admin role
   - Validate companyIds array (min 1)
   - Validate all company IDs exist
   - Use Prisma transaction to delete old assignments and create new ones
   - Ensure primary company (User.companyId) is in the list or update it
   - Return updated assignments

**Code structure**:
```typescript
import { NextRequest, NextResponse } from 'next/server'
import { getServerSession } from 'next-auth'
import { authOptions } from '@/lib/auth'
import { prisma } from '@/lib/db'
import { updateUserCompaniesSchema } from '@/types/user'

// GET /api/users/[id]/companies - Get user's company assignments
export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  // 1. Check session and admin role
  // 2. Fetch user's company assignments
  // 3. Return formatted response
}

// PUT /api/users/[id]/companies - Update company assignments
export async function PUT(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  // 1. Check session and admin role
  // 2. Validate request body with updateUserCompaniesSchema
  // 3. Validate user exists in same company
  // 4. Validate all companyIds exist
  // 5. Use transaction to:
  //    a. Delete existing UserCompany records for user
  //    b. Create new UserCompany records
  //    c. Update User.companyId if needed (first company in list)
  // 6. Return updated assignments
}
```

**Completion Criteria**:
- [ ] GET returns current assignments
- [ ] PUT updates assignments
- [ ] PUT prevents removing all companies
- [ ] PUT validates company IDs exist
- [ ] Handles transaction properly
- [ ] `npm run build` passes

---

## Phase 3: Component Layer

### Subtask 3.1: Create CompanyAssignment Component
**File**: `/home/pbrown/SkuInventory/src/components/features/CompanyAssignment.tsx` (NEW)
**Pattern**: Follow shadcn/ui checkbox usage from issue description
**Instructions**:
1. Create client component with checkbox list
2. Props: `userId`, `assignedCompanyIds`, `allCompanies`, `onAssignmentChange`, `disabled`
3. Prevent unchecking last company (disable checkbox when only one selected)
4. Show loading state during save
5. Use Checkbox component from `@/components/ui/checkbox`
6. Use Label component from `@/components/ui/label`

**Code**:
```typescript
'use client'

import { useState } from 'react'
import { Checkbox } from '@/components/ui/checkbox'
import { Label } from '@/components/ui/label'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'

interface Company {
  id: string
  name: string
}

interface CompanyAssignmentProps {
  userId: string
  assignedCompanyIds: string[]
  allCompanies: Company[]
  onAssignmentChange: (companyIds: string[]) => Promise<void>
  disabled?: boolean
}

export function CompanyAssignment({
  userId,
  assignedCompanyIds,
  allCompanies,
  onAssignmentChange,
  disabled,
}: CompanyAssignmentProps) {
  const [isUpdating, setIsUpdating] = useState<string | null>(null)
  const [error, setError] = useState<string | null>(null)

  const handleToggle = async (companyId: string, checked: boolean) => {
    const newIds = checked
      ? [...assignedCompanyIds, companyId]
      : assignedCompanyIds.filter((id) => id !== companyId)

    // Prevent removing all companies
    if (newIds.length === 0) {
      setError('User must be assigned to at least one company')
      return
    }

    setError(null)
    setIsUpdating(companyId)
    try {
      await onAssignmentChange(newIds)
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to update assignment')
    } finally {
      setIsUpdating(null)
    }
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle>Company Assignments</CardTitle>
        <CardDescription>
          Select which companies this user can access. At least one company is required.
        </CardDescription>
      </CardHeader>
      <CardContent className="space-y-3">
        {error && (
          <div className="rounded-md bg-destructive/10 p-3 text-sm text-destructive">
            {error}
          </div>
        )}
        {allCompanies.length === 0 ? (
          <p className="text-sm text-muted-foreground">No companies available.</p>
        ) : (
          allCompanies.map((company) => {
            const isAssigned = assignedCompanyIds.includes(company.id)
            const isLastAssigned = isAssigned && assignedCompanyIds.length === 1
            const isCurrentlyUpdating = isUpdating === company.id

            return (
              <div key={company.id} className="flex items-center space-x-3">
                <Checkbox
                  id={`company-${company.id}`}
                  checked={isAssigned}
                  onCheckedChange={(checked) => handleToggle(company.id, !!checked)}
                  disabled={disabled || isLastAssigned || isUpdating !== null}
                />
                <Label
                  htmlFor={`company-${company.id}`}
                  className={isCurrentlyUpdating ? 'text-muted-foreground' : ''}
                >
                  {company.name}
                  {isLastAssigned && (
                    <span className="ml-2 text-xs text-muted-foreground">(primary)</span>
                  )}
                  {isCurrentlyUpdating && (
                    <span className="ml-2 text-xs text-muted-foreground">Saving...</span>
                  )}
                </Label>
              </div>
            )
          })
        )}
      </CardContent>
    </Card>
  )
}
```

**Completion Criteria**:
- [ ] Component renders checkbox list
- [ ] Cannot uncheck last company
- [ ] Shows loading state while saving
- [ ] Handles errors gracefully
- [ ] `npx tsc --noEmit` passes

### Subtask 3.2: Update UserTable to Show Company Count
**File**: `/home/pbrown/SkuInventory/src/components/features/UserTable.tsx`
**Pattern**: Follow existing column patterns, see `CompanyTable.tsx` Badge pattern
**Instructions**:
1. Update `UserTableProps` to accept `UserWithCompaniesResponse[]` (or make companies optional)
2. Add "Companies" column after "Role" column
3. Display company count as badge, or comma-separated list if <= 2
4. Handle case where companies array is undefined (backwards compatibility)

**Modifications**:
- Line 33: Update import to include `UserWithCompaniesResponse` or modify type
- Lines 106-114: Add new TableHead for "Companies" after "Role"
- After line 129: Add TableCell showing company info

**Code to add** (around line 130, after Role badge):
```typescript
<TableCell>
  {user.companies ? (
    user.companies.length <= 2 ? (
      <span className="text-sm">
        {user.companies.map(c => c.companyName).join(', ')}
      </span>
    ) : (
      <Badge variant="outline">
        {user.companies.length} companies
      </Badge>
    )
  ) : (
    <span className="text-muted-foreground">-</span>
  )}
</TableCell>
```

**Completion Criteria**:
- [ ] Companies column added to table
- [ ] Shows company names or count
- [ ] `npm run build` passes

---

## Phase 4: Page Integration

### Subtask 4.1: Fetch Companies and Integrate CompanyAssignment in Edit Page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/users/[id]/edit/page.tsx`
**Pattern**: Follow existing data fetching pattern
**Instructions**:
1. Import `CompanyAssignment` component
2. Add state for all companies list
3. Fetch all companies from `/api/companies` on mount
4. Add callback to update company assignments via PUT `/api/users/[id]/companies`
5. Render `CompanyAssignment` below `UserForm`

**Code modifications**:
- Add imports: `CompanyAssignment`, type for Company
- Add state: `allCompanies`, `companiesLoading`
- Add useEffect to fetch companies
- Add `handleCompanyAssignment` callback
- Render CompanyAssignment after UserForm

**Updated component structure**:
```typescript
'use client'

import { useState, useEffect, useCallback } from 'react'
import Link from 'next/link'
import { useParams } from 'next/navigation'
import { Button } from '@/components/ui/button'
import { ArrowLeft } from 'lucide-react'
import { UserForm } from '@/components/features/UserForm'
import { CompanyAssignment } from '@/components/features/CompanyAssignment'
import type { UserWithCompaniesResponse } from '@/types/user'

interface Company {
  id: string
  name: string
}

export default function EditUserPage() {
  const params = useParams()
  const id = params.id as string
  const [user, setUser] = useState<UserWithCompaniesResponse | null>(null)
  const [allCompanies, setAllCompanies] = useState<Company[]>([])
  const [isLoading, setIsLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  useEffect(() => {
    async function fetchData() {
      try {
        const [userRes, companiesRes] = await Promise.all([
          fetch(`/api/users/${id}`),
          fetch('/api/companies?pageSize=100'),
        ])

        if (!userRes.ok) throw new Error('User not found')
        if (!companiesRes.ok) throw new Error('Failed to load companies')

        const userData = await userRes.json()
        const companiesData = await companiesRes.json()

        setUser(userData?.data)
        setAllCompanies(companiesData?.data?.map((c: { id: string; name: string }) => ({
          id: c.id,
          name: c.name,
        })) ?? [])
      } catch (err) {
        setError(err instanceof Error ? err.message : 'An error occurred')
      } finally {
        setIsLoading(false)
      }
    }

    fetchData()
  }, [id])

  const handleCompanyAssignment = useCallback(async (companyIds: string[]) => {
    const res = await fetch(`/api/users/${id}/companies`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ companyIds }),
    })

    if (!res.ok) {
      const data = await res.json().catch(() => ({}))
      throw new Error(data?.error || 'Failed to update company assignments')
    }

    const data = await res.json()
    // Update local state with new assignments
    setUser(prev => prev ? { ...prev, companies: data.data } : null)
  }, [id])

  // ... rest of render logic with CompanyAssignment added
}
```

**Render section** (after UserForm):
```typescript
{user && (
  <div className="mt-6">
    <CompanyAssignment
      userId={user.id}
      assignedCompanyIds={user.companies?.map(c => c.companyId) ?? []}
      allCompanies={allCompanies}
      onAssignmentChange={handleCompanyAssignment}
    />
  </div>
)}
```

**Completion Criteria**:
- [ ] Page fetches both user and companies
- [ ] CompanyAssignment renders below UserForm
- [ ] Assignments save correctly
- [ ] UI updates after save
- [ ] `npm run build` passes

### Subtask 4.2: Update User List to Fetch Companies Data
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/users/page.tsx`
**Pattern**: Follow existing list page pattern
**Instructions**:
1. Ensure the users API returns company data
2. Pass data to UserTable component

**Note**: This may not require changes if the API is updated to always include company data. Verify after Phase 2.

**Completion Criteria**:
- [ ] User list shows company info
- [ ] `npm run build` passes

---

## Phase 5: Update Users List API (if needed)

### Subtask 5.1: Update GET /api/users to Include Company Count
**File**: `/home/pbrown/SkuInventory/src/app/api/users/route.ts`
**Pattern**: Follow existing query pattern
**Instructions**:
1. Add userCompanies include with company name to the select
2. Transform response to include companies array

**Modifications** (around lines 61-78):
- Add to select: `userCompanies: { select: { id: true, companyId: true, company: { select: { name: true } }, role: true, assignedAt: true } }`
- Transform in response mapping

**Completion Criteria**:
- [ ] GET /api/users returns companies array per user
- [ ] `npm run build` passes

---

## Summary of Deliverables
**Files Created**: 2
- `/home/pbrown/SkuInventory/src/app/api/users/[id]/companies/route.ts`
- `/home/pbrown/SkuInventory/src/components/features/CompanyAssignment.tsx`

**Files Modified**: 4
- `/home/pbrown/SkuInventory/src/types/user.ts`
- `/home/pbrown/SkuInventory/src/app/api/users/[id]/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/users/route.ts`
- `/home/pbrown/SkuInventory/src/components/features/UserTable.tsx`
- `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/users/[id]/edit/page.tsx`

## Handoff to Build Agent
1. Execute subtasks in exact order (1.1, 2.1, 2.2, 3.1, 3.2, 4.1, 4.2, 5.1)
2. Run validation commands after each phase
3. Test completion criteria before next subtask
4. Follow reference patterns exactly

## Validation Commands
```bash
# TypeScript check
npx tsc --noEmit

# Build check
npm run build

# Lint check
npm run lint
```

## Acceptance Criteria Checklist
- [ ] User edit page shows list of all companies with checkboxes
- [ ] Assigned companies are checked, unassigned are unchecked
- [ ] Toggling checkbox calls API to update assignments
- [ ] Cannot remove all companies (at least one required)
- [ ] User table shows company assignment count/names
- [ ] API validates admin permissions
- [ ] API validates company IDs exist
- [ ] `npm run build` passes
- [ ] `npx tsc --noEmit` passes

## Test Strategy Note
- Use manual testing for UI interactions
- Verify checkbox toggle behavior
- Test edge case: trying to uncheck the last company
- Test with users assigned to 1, 2, and 3+ companies

## Performance Metrics
| Phase | Estimated Duration |
|-------|----------|
| Types | 15m |
| API - Single User | 30m |
| API - Companies Endpoint | 45m |
| Component | 45m |
| Page Integration | 45m |
| User List Updates | 30m |
| Testing & Fixes | 30m |
| **Total** | **4-5h** |
