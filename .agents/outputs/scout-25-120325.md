# Scout Report: Add E2E and component tests for feedback submission flow

## Request Analysis
**Type**: Enhancement
**Source**: GitHub Issue #25
**Priority**: Medium

## Task Classification
**Category**: VERIFICATION
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="feedback"` for targeted test execution

## Issue Validation
**Status**: Valid and active
**Recent Changes**:
- Issue #1 (feedback system) closed on 2025-12-02 after successful implementation
- Commits: `cc9ceff` (initial implementation), `d5b4a5d` (fixes)
- Current test coverage: 22 unit tests (types + Claude client), 1 basic E2E test
- Multiple test issues (#42-52) created during feedback system testing - all closed

**Verification**: Code is live and functional. Issue #25 requests additional test coverage as enhancement.

## Current State

### Feedback System Implementation
The feedback system is **fully implemented and operational**:

**Components**:
- `/home/pbrown/SkuInventory/src/components/features/FeedbackDialog.tsx` (389 lines, 6-step state machine)
- `/home/pbrown/SkuInventory/src/components/features/FeedbackButton.tsx` (27 lines, trigger button)
- `/home/pbrown/SkuInventory/src/app/(dashboard)/layout.tsx` (integrates button in header, line 126)

**API Routes**:
- `/home/pbrown/SkuInventory/src/app/api/feedback/route.ts` (222 lines, main submission endpoint)
- `/home/pbrown/SkuInventory/src/app/api/feedback/clarify/route.ts` (36 lines, AI questions endpoint)

**Types & Utilities**:
- `/home/pbrown/SkuInventory/src/types/feedback.ts` (43 lines, schemas & types)
- `/home/pbrown/SkuInventory/src/lib/claude.ts` (103 lines, AI integration)

**State Machine Flow** (6 steps):
1. `select-type` - Choose bug or feature
2. `describe` - Enter description (min 10 chars, max 2000)
3. `clarify` - Answer 3 AI-generated questions
4. `submitting` - Loading state during GitHub issue creation
5. `success` - Confirmation with issue URL
6. `error` - Error display with retry option

**Key Features**:
- Rate limiting: 5 submissions per hour per user (in-memory)
- Form validation: Description min 10 chars, exactly 3 answers required
- Error handling: Graceful fallback questions if Claude API unavailable
- GitHub integration: Creates issues using Octokit REST API
- Toast notifications: Success/error feedback via Sonner

### Existing Test Infrastructure

**Test Frameworks** (confirmed in `package.json`):
- Vitest 4.0.15 (unit tests, jsdom environment)
- Playwright 1.57.0 (E2E tests, Chromium)
- React Testing Library 16.3.0 (component testing)
- @testing-library/jest-dom 6.9.1 (matchers)

**Configuration Files**:
- `/home/pbrown/SkuInventory/vitest.config.ts` - Unit test config
- `/home/pbrown/SkuInventory/playwright.config.ts` - E2E config (baseURL: http://172.16.20.50:4545)
- `/home/pbrown/SkuInventory/tests/setup.ts` - Jest DOM matchers
- `/home/pbrown/SkuInventory/tests/setup.integration.ts` - Integration test setup

**Test Structure**:
```
tests/
├── e2e/ (19 files, 18 .spec.ts)
├── unit/ (18 files, 17 .test.ts, 1 .test.tsx)
├── integration/ (4 .test.ts files)
├── fixtures/ (test data)
└── helpers/ (test utilities)
```

**Current Test Commands**:
- `npm test` - Run unit tests (Vitest)
- `npm run test:integration` - Run integration tests
- `npm run test:all` - Run both unit + integration
- `npm run test:e2e` - Run Playwright E2E tests

### Current Test Coverage for Feedback System

**Unit Tests** (existing):
1. `/home/pbrown/SkuInventory/tests/unit/feedback-types.test.ts` (15 tests, 162 lines)
   - Tests Zod schemas: `clarifyRequestSchema`, `submitFeedbackSchema`
   - Validates type enums: `FeedbackType`, `FeedbackStep`
   - Coverage: Schema validation, boundary conditions

2. `/home/pbrown/SkuInventory/tests/unit/claude-client.test.ts` (7 tests, 142 lines)
   - Tests `generateClarifyingQuestions` function
   - Mocks Anthropic SDK
   - Coverage: Fallback behavior when API key missing, question structure

**E2E Tests** (existing):
1. `/home/pbrown/SkuInventory/tests/e2e/test-feedback-api.spec.ts` (1 test, 46 lines)
   - Tests direct API call to `/api/feedback` endpoint
   - Validates response format and GitHub issue creation
   - **Limitation**: Does NOT test dialog UI or state transitions

**Coverage Gaps** (what Issue #25 addresses):
- FeedbackDialog component rendering and state machine
- User interaction flows (clicking, typing, form submission)
- Form validation UI feedback
- Loading states and error messages
- Dialog open/close/reset behavior
- Rate limiting UI response
- Accessibility (keyboard navigation, ARIA attributes)
- Complete E2E flows through the dialog (not just API)

## Dependencies & Blockers

**All dependencies are in place**:
- Vitest configured with React plugin
- React Testing Library installed
- Playwright configured and working
- No missing packages

**Authentication requirement for E2E tests**:
- All E2E tests must login first (pattern: admin@tonsil.tech / changeme123)
- Example pattern in `/home/pbrown/SkuInventory/tests/e2e/build-dialog-error-handling.spec.ts`

**Can Proceed?**: YES - No blockers identified

## Complexity Assessment
**Complexity**: Simple to Moderate
**Effort**: 4-6 hours total
- E2E test implementation: 2-3 hours
- Component test implementation: 2-3 hours
**Risk**: Low - Tests only, no production code changes

**Breakdown**:
- **E2E Tests**: 2-3 hours
  - Bug submission happy path (30 min)
  - Feature submission happy path (30 min)
  - Rate limiting test (45 min)
  - Error handling scenarios (45 min)
  - Setup and utilities (30 min)

- **Component Tests**: 2-3 hours
  - State machine transitions (60 min)
  - Form validation (45 min)
  - Loading states (30 min)
  - Accessibility tests (45 min)

## Patterns to Follow

### Component Test Pattern
**Primary**: `/home/pbrown/SkuInventory/tests/unit/BuildFooter.test.tsx`
- Uses `render` and `screen` from React Testing Library
- Mocks external dependencies (version.json) with `vi.mock`
- Tests rendering, props, className merging
- Uses `toBeInTheDocument()`, `toHaveClass()` matchers

**Pattern to copy**:
```typescript
import { describe, it, expect, vi } from 'vitest'
import { render, screen } from '@testing-library/react'
import { ComponentName } from '@/components/...'

describe('ComponentName', () => {
  it('renders without crashing', () => {
    render(<ComponentName />)
    expect(screen.getByRole('dialog')).toBeInTheDocument()
  })
})
```

### E2E Test Pattern
**Primary**: `/home/pbrown/SkuInventory/tests/e2e/build-dialog-error-handling.spec.ts`
- Playwright test structure with `test.describe` and `test.beforeEach`
- Login pattern in beforeEach
- Uses `page.goto`, `page.waitForSelector`, `page.click`, `page.fill`
- Locator patterns: `page.locator('[role="dialog"]')`, `page.locator('button:has-text("Submit")')`
- Assertions: `expect(element).toBeVisible()`, `expect(element).not.toBeVisible()`

**Secondary**: `/home/pbrown/SkuInventory/tests/e2e/settings-integration.spec.ts`
- Multi-step user flow testing
- Form submission testing
- State persistence verification

## Files to Create/Modify

### Files to Create

**E2E Tests**:
1. `/home/pbrown/SkuInventory/tests/e2e/feedback-submission.spec.ts`
   - Purpose: Complete E2E flows for feedback submission
   - Tests: Bug flow, feature flow, rate limiting, error handling
   - ~200-250 lines

**Component Tests**:
2. `/home/pbrown/SkuInventory/tests/unit/FeedbackDialog.test.tsx`
   - Purpose: Component rendering and state transitions
   - Tests: All 6 state steps, form validation, loading states, accessibility
   - ~300-400 lines

**Optional Helper** (if needed):
3. `/home/pbrown/SkuInventory/tests/helpers/feedback-helpers.ts`
   - Purpose: Shared utilities for mocking fetch, AI responses, GitHub API
   - ~50-100 lines

### Files to Modify
**None** - This is a test-only enhancement

## Final Sweep Results

**Comprehensive grep for feedback-related code**:
```bash
# Found all feedback implementations
src/components/features/FeedbackDialog.tsx
src/components/features/FeedbackButton.tsx
src/app/(dashboard)/layout.tsx (usage)
src/app/api/feedback/route.ts
src/app/api/feedback/clarify/route.ts
src/types/feedback.ts
src/lib/claude.ts

# Found all existing tests
tests/unit/feedback-types.test.ts
tests/unit/claude-client.test.ts
tests/e2e/test-feedback-api.spec.ts
```

**Service Layer**: Not applicable - no service layer for feedback (direct API routes)

**API Routes Search**: All feedback routes identified (2 routes)

**Type Definitions**: All types in `/src/types/feedback.ts`

**Components Search**:
- FeedbackDialog used in: `src/app/(dashboard)/layout.tsx` (line 133)
- FeedbackButton used in: `src/app/(dashboard)/layout.tsx` (line 126)

**Test Files**: 3 existing feedback test files

**All Affected Files** (comprehensive list):
- `/home/pbrown/SkuInventory/src/components/features/FeedbackDialog.tsx` - Component under test
- `/home/pbrown/SkuInventory/src/components/features/FeedbackButton.tsx` - Trigger component
- `/home/pbrown/SkuInventory/src/app/api/feedback/route.ts` - Submission API
- `/home/pbrown/SkuInventory/src/app/api/feedback/clarify/route.ts` - Clarify API
- `/home/pbrown/SkuInventory/src/types/feedback.ts` - Type definitions
- `/home/pbrown/SkuInventory/src/lib/claude.ts` - AI integration
- `/home/pbrown/SkuInventory/tests/unit/feedback-types.test.ts` - Existing tests
- `/home/pbrown/SkuInventory/tests/unit/claude-client.test.ts` - Existing tests
- `/home/pbrown/SkuInventory/tests/e2e/test-feedback-api.spec.ts` - Existing tests

## Ripple Effect Analysis

**Impact**: Isolated - No production code changes
**Scope**: Test files only
**Risk**: Zero risk to production code

This is a pure testing enhancement. No function signatures change, no APIs modified.

## Acceptance Criteria

### E2E Tests
- [ ] Test complete bug report submission flow
  - Open dialog → Select bug → Enter description → Answer questions → Submit → Verify GitHub issue created

- [ ] Test complete feature request submission flow
  - Open dialog → Select feature → Enter description → Answer questions → Submit → Verify GitHub issue created

- [ ] Test rate limiting (5 submissions per hour)
  - Submit 5 feedback items → Verify 6th submission shows rate limit error

- [ ] Test error handling when GitHub CLI fails
  - Mock GitHub API failure → Verify error state displayed → Verify retry option

- [ ] Test error handling when Claude API fails
  - Test graceful fallback to default questions when AI unavailable

- [ ] Test dialog close/reset behavior
  - Open dialog → Enter data → Close → Reopen → Verify form reset

### Component Tests (React Testing Library)
- [ ] Test FeedbackDialog state transitions between all 6 steps
  - select-type → describe → clarify → submitting → success
  - select-type → describe → clarify → submitting → error

- [ ] Test form validation (10 char minimum description)
  - Try submitting with <10 chars → Verify error message
  - Submit with ≥10 chars → Verify accepted

- [ ] Test answer validation (all 3 questions required)
  - Try submitting with empty answers → Verify error
  - Submit with all answers → Verify accepted

- [ ] Test loading states during API calls
  - Verify "Getting Questions..." loading state
  - Verify "Submitting Feedback" loading state
  - Verify spinner visibility

- [ ] Test success/error message display
  - Verify success message with issue URL
  - Verify error message on failure

- [ ] Test accessibility (keyboard navigation, ARIA attributes)
  - Verify dialog has role="dialog"
  - Verify form inputs have proper labels
  - Verify buttons have aria-label attributes

## Handoff to Plan Agent

**Summary**:
Issue #25 requests comprehensive test coverage for the fully-functional feedback submission system implemented in issue #1. The system includes a 6-step dialog flow, two API endpoints (clarify + submit), rate limiting, and GitHub issue creation. Current coverage includes 22 unit tests for types and utilities, plus 1 basic E2E API test. This enhancement will add ~500-650 lines of test code across 2 new test files: E2E tests for complete user flows and component tests for UI state management. All infrastructure is in place (Vitest, Playwright, React Testing Library), and no production code changes are required.

**Key Points**:
1. **Existing implementation is solid**: Zero TypeScript errors, 277 unit tests passing, build succeeds
2. **Clear patterns to follow**: BuildFooter.test.tsx for component tests, build-dialog-error-handling.spec.ts for E2E
3. **Test infrastructure ready**: Vitest 4.0.15, Playwright 1.57.0, React Testing Library 16.3.0 configured
4. **6-step state machine to test**: select-type → describe → clarify → submitting → success/error
5. **Rate limiting**: 5 submissions/hour per user (in-memory), must test UI response
6. **Authentication required**: E2E tests must login as admin@tonsil.tech
7. **No blockers**: All dependencies installed, no production code changes needed

**Suggested Phases**:
1. **Phase 1**: Component tests (FeedbackDialog.test.tsx)
   - State machine transitions
   - Form validation
   - Loading states
   - Basic accessibility

2. **Phase 2**: E2E tests (feedback-submission.spec.ts)
   - Happy path flows (bug + feature)
   - Rate limiting
   - Error scenarios
   - Dialog reset behavior

**Testing Strategy**:
- Use `npm test -- --filter="FeedbackDialog"` for component tests during development
- Use `npx playwright test feedback-submission` for E2E tests during development
- Final validation: `npm run test:all && npm run test:e2e`

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Issue Parsing | 2m |
| Codebase Exploration | 8m |
| Pattern Identification | 5m |
| Report Writing | 12m |
| **Total** | **27m** |
