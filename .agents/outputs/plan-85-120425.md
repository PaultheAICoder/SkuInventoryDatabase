# Implementation Plan
**Generated**: 2025-12-04T12:30:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #85 - SKU Channel Mapping API and UI
**Estimated Build Time**: 8-10 hours
**Complexity**: Moderate

## Investigation Summary

### Request Analysis
**Type**: Feature
**Source**: GitHub Issue #85 (Part of Parent Issue #10 - Shopify order integration)
**Priority**: High (blocks #81 - Order sync)

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED (affected modules - API routes and UI components)
**Suggested Filter**: `--filter="mapping"` or None

### Issue Validation
**Status**: Valid
**Recent Changes**: Issue #76 (database schema) was completed on 2025-12-04, creating the foundational `SkuChannelMapping` model in Prisma schema.

### Current State Assessment
- **Database**: `SkuChannelMapping` model EXISTS in `prisma/schema.prisma` (line 520-536)
  - Fields: id, companyId, channelType, externalId, externalSku, skuId, isActive, createdAt, updatedAt
  - Unique constraint: `[companyId, channelType, externalId]`
  - Indexes: `[companyId, channelType]`, `[skuId]`
- **API Routes**: NO existing routes for `/api/shopify/mappings/` - must be created
- **UI Pages**: NO existing settings/integrations pages - must create entire directory structure
- **Components**: NO existing `SkuMappingTable.tsx` or `SkuMappingForm.tsx` - must be created
- **Types**: `src/types/shopify.ts` exists but no mapping-specific types yet
- **Services**: `src/services/shopify.ts` exists (ShopifyClient for API calls) - no mapping service yet

### Dependencies & Blockers
1. **Resolved**: Issue #76 database schema complete - `SkuChannelMapping` model exists
2. **Available**: Existing patterns for API routes (`/api/locations/route.ts`, `/api/skus/route.ts`)
3. **Available**: Existing patterns for table components (`LocationTable.tsx`, `SKUTable.tsx`)
4. **Available**: Existing patterns for form components (`LocationForm.tsx`, `SKUForm.tsx`)
5. **Available**: CSV import patterns in `src/services/import.ts` and `/api/import/components/route.ts`

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Moderate
**Effort**: 8-10 hours
**Risk**: Low - well-defined scope with clear patterns to follow

### Patterns Identified
**Primary API Route**: `src/app/api/locations/route.ts` - CRUD pattern with auth, validation, company scoping
**Secondary API Route**: `src/app/api/skus/route.ts` - Pagination, search, filtering
**Primary Table Component**: `src/components/features/LocationTable.tsx` - Table with actions menu, delete dialog
**Secondary Table Component**: `src/components/features/SKUTable.tsx` - Search, filters, pagination
**Form Component**: `src/components/features/SKUForm.tsx` - Form with Select dropdowns
**Import Pattern**: `src/services/import.ts` + `src/app/api/import/components/route.ts`
**Page Pattern**: `src/app/(dashboard)/settings/locations/page.tsx` - Client-side data fetching with filters

### Ripple Effect Analysis
**Files Identified**: 0 existing files to modify (all new files)
**New Files to Create**: 7
- `src/types/channel-mapping.ts` - New types/schemas
- `src/app/api/shopify/mappings/route.ts` - API route for CRUD
- `src/app/api/shopify/mappings/[id]/route.ts` - API route for individual mapping
- `src/app/api/shopify/mappings/import/route.ts` - CSV bulk import endpoint
- `src/app/(dashboard)/settings/integrations/mappings/page.tsx` - UI page
- `src/components/features/SkuMappingTable.tsx` - Table component
- `src/components/features/SkuMappingForm.tsx` - Form component (dialog-based)

**TOTAL FILES TO CREATE**: 7
**TOTAL FILES TO MODIFY**: 0 (possibly 1 - adding mapping type exports to `src/types/index.ts`)

---

## Executive Summary
Create a complete SKU channel mapping feature including: API endpoints for CRUD operations on `SkuChannelMapping`, a management UI page under settings/integrations/mappings, table component for listing/deleting mappings, form component for creating/editing mappings with SKU selector, and CSV bulk import capability. This enables users to map Shopify variant IDs to internal SKUs, which is required for automatic order processing.

## Phase 1: Types Layer
### Subtask 1.1: Create Channel Mapping Types and Schemas
**File**: `src/types/channel-mapping.ts` (NEW)
**Pattern**: Follow `src/types/sku.ts` and `src/types/location.ts`
**Instructions**:
1. Create Zod schemas for mapping validation:
   ```typescript
   import { z } from 'zod'

   export const channelTypes = ['shopify', 'amazon', 'tiktok'] as const
   export type ChannelType = (typeof channelTypes)[number]

   export const createMappingSchema = z.object({
     channelType: z.enum(channelTypes).default('shopify'),
     externalId: z.string().min(1, 'External ID is required'),
     externalSku: z.string().optional(),
     skuId: z.string().uuid('Invalid SKU ID'),
   })

   export type CreateMappingInput = z.infer<typeof createMappingSchema>

   export const updateMappingSchema = z.object({
     skuId: z.string().uuid('Invalid SKU ID').optional(),
     isActive: z.boolean().optional(),
   })

   export type UpdateMappingInput = z.infer<typeof updateMappingSchema>

   export const mappingListQuerySchema = z.object({
     page: z.coerce.number().int().positive().default(1),
     pageSize: z.coerce.number().int().positive().max(100).default(50),
     search: z.string().optional(),
     channelType: z.string().optional(),
     isActive: z.string().transform((val) => val === 'true').optional(),
   })

   export type MappingListQuery = z.infer<typeof mappingListQuerySchema>

   export interface MappingResponse {
     id: string
     channelType: string
     externalId: string
     externalSku: string | null
     skuId: string
     sku: { id: string; name: string; internalCode: string }
     isActive: boolean
     createdAt: string
     updatedAt: string
   }
   ```
2. Export types for API responses and list queries
**Validation**:
```bash
npx tsc --noEmit
```
**Completion Criteria**:
- [ ] File created with all schemas and types
- [ ] TypeScript compiles without errors
- [ ] Schemas match Prisma model field names

## Phase 2: API Routes Layer
### Subtask 2.1: Create Main Mappings API Route (GET, POST)
**File**: `src/app/api/shopify/mappings/route.ts` (NEW)
**Pattern**: Follow `src/app/api/locations/route.ts` (lines 1-183)
**Instructions**:
1. Create directory: `src/app/api/shopify/mappings/`
2. Implement GET handler:
   - Authenticate with `getServerSession(authOptions)`
   - Parse query params with `mappingListQuerySchema`
   - Scope by `session.user.selectedCompanyId`
   - Support pagination, search (by externalId or SKU internalCode), channelType filter
   - Include related SKU data in response
   - Return paginated response
3. Implement POST handler:
   - Admin role check required (`session.user.role !== 'admin'` returns 403)
   - Validate body with `createMappingSchema`
   - Check unique constraint: no duplicate `[companyId, channelType, externalId]`
   - Verify SKU exists and belongs to selected company
   - Create mapping with `prisma.skuChannelMapping.create()`
   - Return created mapping with 201 status
**Validation**:
```bash
npx tsc --noEmit
npm run build
```
**Completion Criteria**:
- [ ] GET returns paginated list of mappings with SKU details
- [ ] POST creates new mapping with validation
- [ ] Duplicate externalId returns 409 conflict
- [ ] Admin-only for mutations enforced

### Subtask 2.2: Create Individual Mapping API Route (PATCH, DELETE)
**File**: `src/app/api/shopify/mappings/[id]/route.ts` (NEW)
**Pattern**: Follow `src/app/api/locations/[id]/route.ts`
**Instructions**:
1. Create directory: `src/app/api/shopify/mappings/[id]/`
2. Implement PATCH handler:
   - Admin role check
   - Validate body with `updateMappingSchema`
   - Verify mapping exists and belongs to company
   - If changing skuId, verify new SKU belongs to company
   - Update mapping
3. Implement DELETE handler:
   - Admin role check
   - Verify mapping exists and belongs to company
   - Delete mapping (or soft-delete by setting isActive=false)
**Validation**:
```bash
npx tsc --noEmit
npm run build
```
**Completion Criteria**:
- [ ] PATCH updates mapping fields
- [ ] DELETE removes mapping
- [ ] 404 returned for non-existent mapping
- [ ] 403 returned for non-admin users

### Subtask 2.3: Create CSV Bulk Import Route
**File**: `src/app/api/shopify/mappings/import/route.ts` (NEW)
**Pattern**: Follow `src/app/api/import/components/route.ts` (lines 1-153)
**Instructions**:
1. Create directory: `src/app/api/shopify/mappings/import/`
2. Implement POST handler:
   - Admin role check
   - Parse multipart form data to extract CSV file
   - Use `parseCSV` from `src/services/import.ts`
   - Expected columns: `channel_type`, `external_id`, `external_sku`, `internal_sku_code`
   - For each row:
     - Validate fields
     - Look up SKU by internalCode within company
     - Check for duplicate externalId
     - Create mapping if valid
   - Return import summary with counts and errors
**Validation**:
```bash
npx tsc --noEmit
npm run build
```
**Completion Criteria**:
- [ ] Accepts CSV file upload
- [ ] Maps internal_sku_code to SKU ID
- [ ] Reports success/failure per row
- [ ] Skips duplicates without crashing

## Phase 3: UI Components Layer
### Subtask 3.1: Create Mapping Table Component
**File**: `src/components/features/SkuMappingTable.tsx` (NEW)
**Pattern**: Follow `src/components/features/LocationTable.tsx` (lines 1-250)
**Instructions**:
1. Create table component with props: `{ mappings: MappingResponse[], onRefresh: () => void }`
2. Columns: External ID, External SKU, Internal SKU (link to SKU detail), Channel, Status, Actions
3. Actions dropdown with:
   - Edit (opens form dialog)
   - Toggle Active/Inactive
   - Delete (with confirmation dialog)
4. Use shadcn/ui components: Table, Badge, Button, DropdownMenu, AlertDialog
5. Handle delete with confirmation dialog
6. Support bulk selection checkbox (optional enhancement)
**Validation**:
```bash
npx tsc --noEmit
npm run build
```
**Completion Criteria**:
- [ ] Displays mappings in table format
- [ ] Actions menu works (edit, toggle, delete)
- [ ] Delete confirmation dialog appears
- [ ] Calls onRefresh after successful action

### Subtask 3.2: Create Mapping Form Component (Dialog)
**File**: `src/components/features/SkuMappingForm.tsx` (NEW)
**Pattern**: Follow `src/components/features/SKUForm.tsx` for form fields, `src/components/features/LocationForm.tsx` for dialog integration
**Instructions**:
1. Create form component (can be inline or dialog-based)
2. Props: `{ mapping?: MappingResponse, onSuccess: () => void, onCancel: () => void }`
3. Form fields:
   - Channel Type: Select dropdown (shopify, amazon, tiktok) - default "shopify"
   - External ID: Text input (required) - Shopify variant ID
   - External SKU: Text input (optional) - for reference
   - Internal SKU: Searchable Select dropdown (required)
     - Fetch SKUs from `/api/skus?pageSize=100` on mount
     - Show SKU name + internalCode
   - Active: Toggle/Checkbox (only for edit mode)
4. Validation with Zod schemas
5. Submit to POST (create) or PATCH (update) endpoints
6. Show loading state and error messages
**Validation**:
```bash
npx tsc --noEmit
npm run build
```
**Completion Criteria**:
- [ ] Form renders with all fields
- [ ] SKU selector loads SKUs from API
- [ ] Create mode submits to POST endpoint
- [ ] Edit mode submits to PATCH endpoint
- [ ] Error messages display properly

## Phase 4: UI Page Layer
### Subtask 4.1: Create Mappings Management Page
**File**: `src/app/(dashboard)/settings/integrations/mappings/page.tsx` (NEW)
**Pattern**: Follow `src/app/(dashboard)/settings/locations/page.tsx` (lines 1-134)
**Instructions**:
1. Create directory structure: `src/app/(dashboard)/settings/integrations/mappings/`
2. Create 'use client' page component
3. State management:
   - `mappings: MappingResponse[]`
   - `isLoading: boolean`
   - `error: string | null`
   - `search: string`
   - `channelFilter: string`
   - `showAddDialog: boolean`
   - `editingMapping: MappingResponse | null`
4. Data fetching:
   - `fetchMappings()` - GET `/api/shopify/mappings` with query params
   - Call on mount and when filters change
5. Page layout:
   - Header: "SKU Channel Mappings" title + "Add Mapping" button
   - Filters row: Search input, Channel type dropdown
   - Action buttons: "Import CSV" button (opens file dialog)
   - Table: SkuMappingTable component
   - Dialog: SkuMappingForm for add/edit
6. Import CSV functionality:
   - File input (hidden)
   - Click "Import CSV" triggers file selection
   - On file select, POST to `/api/shopify/mappings/import`
   - Show toast with results
**Validation**:
```bash
npx tsc --noEmit
npm run build
```
**Completion Criteria**:
- [ ] Page accessible at `/settings/integrations/mappings`
- [ ] Lists all mappings for selected company
- [ ] Search and filter work
- [ ] Add Mapping button opens form dialog
- [ ] CSV import works and shows results

### Subtask 4.2: Add Import Form Integration
**File**: Modify `src/app/(dashboard)/settings/integrations/mappings/page.tsx`
**Pattern**: Follow `src/components/features/ImportForm.tsx` for file upload UI
**Instructions**:
1. Add file input (hidden) with ref
2. Add "Import CSV" button next to "Add Mapping"
3. On click, trigger file input click
4. On file selection:
   - Create FormData with file
   - POST to `/api/shopify/mappings/import`
   - Show loading state
   - On success, show toast with import summary
   - Refresh mappings list
4. Add "Download Template" link that generates sample CSV
**Validation**:
```bash
npm run build
```
**Completion Criteria**:
- [ ] Import CSV button visible
- [ ] File selection triggers upload
- [ ] Import results shown in toast
- [ ] Table refreshes after import

---

## Summary of Deliverables
**Files Created**: 7
1. `src/types/channel-mapping.ts` - Types and Zod schemas
2. `src/app/api/shopify/mappings/route.ts` - GET (list) + POST (create)
3. `src/app/api/shopify/mappings/[id]/route.ts` - PATCH + DELETE
4. `src/app/api/shopify/mappings/import/route.ts` - CSV bulk import
5. `src/components/features/SkuMappingTable.tsx` - Table component
6. `src/components/features/SkuMappingForm.tsx` - Form component
7. `src/app/(dashboard)/settings/integrations/mappings/page.tsx` - Management page

**Files Modified**: 0-1
- Optional: `src/types/index.ts` - Add channel-mapping exports

## Handoff to Build Agent
1. Execute subtasks in exact order (Phase 1 -> 2 -> 3 -> 4)
2. Create directories before files (`mkdir -p` pattern)
3. Test each API endpoint with curl after creation
4. Verify TypeScript compilation after each file
5. Follow reference patterns exactly for consistency

## Test Strategy Note
- Use manual testing with curl for API routes
- Verify UI in browser at http://172.16.20.50:4545/settings/integrations/mappings
- Test authorization: viewer should get 403 on POST/PATCH/DELETE
- Test validation: missing required fields should return 400
- Test duplicate constraint: same externalId should return 409

## Performance Metrics
| Phase | Estimated Duration |
|-------|----------|
| Phase 1 (Types) | 30m |
| Phase 2 (API Routes) | 3h |
| Phase 3 (UI Components) | 2.5h |
| Phase 4 (UI Page) | 2h |
| **Total** | **8h** |

## Authorization Matrix
| Role | List | Create | Update | Delete |
|------|------|--------|--------|--------|
| Admin | Yes | Yes | Yes | Yes |
| Ops | Yes | No | No | No |
| Viewer | No | No | No | No |

## API Endpoint Summary
| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| GET | `/api/shopify/mappings` | List mappings with pagination | All |
| POST | `/api/shopify/mappings` | Create new mapping | Admin |
| PATCH | `/api/shopify/mappings/[id]` | Update mapping | Admin |
| DELETE | `/api/shopify/mappings/[id]` | Delete mapping | Admin |
| POST | `/api/shopify/mappings/import` | Bulk import from CSV | Admin |
