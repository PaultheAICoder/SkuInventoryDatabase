# Implementation Plan
**Generated**: 2025-12-04T15:30:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #79
**Estimated Build Time**: 4-6 hours
**Complexity**: Medium

## Investigation Summary

### Request Analysis
**Type**: Enhancement
**Source**: GitHub Issue #79 - [Parent #14] Extend build transactions to output finished goods inventory
**Priority**: High

### Task Classification
**Category**: NEW_FEATURE (extending existing functionality)
**Test Strategy**: TARGETED - Affected modules including inventory service, build route, and finished goods tests
**Suggested Filter**: `--filter="build|finished"`

### Issue Validation
**Status**: Valid - Key requirements NOT yet implemented
**Recent Changes**:
- Commit `1bc6c25` feat(issue #72): add finished goods inventory tracking from builds
- Issue #72 implemented `FinishedGoodsLine` model and optional FG output, but NOT the `outputToFinishedGoods` default behavior or atomic transaction pattern specified in Issue #79

### Critical Finding: Issue #79 is NOT Obsolete

The plan-75-120425.md document incorrectly suggested this issue might be obsolete. Upon detailed code analysis:

| Requirement from Issue #79 | Current State | Gap? |
|---------------------------|---------------|------|
| `outputToFinishedGoods` boolean param (default: true) | NOT implemented - uses `outputLocationId` (optional, no default) | **YES - GAP** |
| Atomic component consumption + FG increment | NOT atomic - transaction created first, then FG line separately | **YES - GAP** |
| `SkuInventoryBalance` upsert | Using `FinishedGoodsLine` instead (acceptable alternative) | No - OK |
| Cost tracking for finished goods | Implemented (`costPerUnit` on FG line) | No - OK |
| Build response includes FG output quantity | Implemented (`outputQuantity` in response) | No - OK |

### Current State Assessment

**Existing components:**
- `FinishedGoodsLine` model in Prisma schema (lines 290-304)
- `createBuildTransaction()` in `src/services/inventory.ts` (lines 632-838)
- Build API route at `src/app/api/transactions/build/route.ts`
- Types in `src/types/transaction.ts` with `outputLocationId` and `outputQuantity`
- `BuildDialog` component with output location selector

**Database:**
- `FinishedGoodsLine` table exists with migration `20251204024531_add_finished_goods_line`
- No schema changes needed

**API Routes:**
- `POST /api/transactions/build` - Already passes output params, needs `outputToFinishedGoods` support

**Types:**
- `createBuildSchema` needs `outputToFinishedGoods` field

### Dependencies & Blockers
1. **Dependency on #75**: SATISFIED - FinishedGoodsLine schema exists (alternative to SkuInventoryBalance)
2. **No blocking issues identified**

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Medium
**Effort**: 4-6 hours
**Risk**: Low - Extending existing patterns, backward compatible

### Patterns Identified

**Primary**: `src/services/inventory.ts:createReceiptTransaction()` (lines 275-362)
- Uses `prisma.$transaction()` for atomic operations
- Pattern for wrapping multiple writes

**Secondary**: `src/services/finished-goods.ts:transferFinishedGoods()` (lines 154-231)
- Uses `prisma.$transaction()` with callback pattern
- Creates multiple FG lines atomically

### Ripple Effect Analysis
**Files Identified**: 4 files

| File | Why Affected |
|------|--------------|
| `src/services/inventory.ts` | Main change - wrap build in $transaction, add outputToFinishedGoods |
| `src/types/transaction.ts` | Add outputToFinishedGoods to createBuildSchema |
| `src/app/api/transactions/build/route.ts` | Pass outputToFinishedGoods to service |
| `src/components/features/BuildDialog.tsx` | UI already supports FG output; minor enhancement for default behavior |

---

## Executive Summary

Extend the `createBuildTransaction()` function to:
1. Add `outputToFinishedGoods` boolean parameter that defaults to `true`
2. Wrap all writes (Transaction + TransactionLines + FinishedGoodsLine) in a single `prisma.$transaction()` for atomicity
3. When `outputToFinishedGoods=true` and no `outputLocationId` provided, use the company's default location

This ensures build transactions atomically consume components AND produce finished goods inventory in a single database transaction.

---

## Phase 1: Type Definitions

### Subtask 1.1: Add outputToFinishedGoods to createBuildSchema
**File**: `/home/pbrown/SkuInventory/src/types/transaction.ts`
**Pattern**: Follow existing optional boolean fields like `allowInsufficientInventory` (line 64)
**Instructions**:
1. Add `outputToFinishedGoods` field to `createBuildSchema`:
   ```typescript
   // After line 64 (allowInsufficientInventory)
   outputToFinishedGoods: z.boolean().default(true),
   ```
2. This makes FG output the default behavior (builds produce finished goods unless explicitly disabled)

**Validation Commands**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] `outputToFinishedGoods` field added with default `true`
- [ ] `CreateBuildInput` type includes the new field
- [ ] TypeScript compiles without errors

---

## Phase 2: Service Layer - Atomic Transaction

### Subtask 2.1: Update createBuildTransaction signature
**File**: `/home/pbrown/SkuInventory/src/services/inventory.ts`
**Pattern**: Follow existing optional parameters pattern
**Instructions**:
1. Add `outputToFinishedGoods` parameter to the function params (after line 647):
   ```typescript
   outputToFinishedGoods?: boolean  // defaults to true in implementation
   ```
2. Update the BuildTransactionResult interface if needed to include FG output confirmation

**Completion Criteria**:
- [ ] Parameter added to function signature
- [ ] TypeScript compiles

### Subtask 2.2: Wrap build transaction in prisma.$transaction
**File**: `/home/pbrown/SkuInventory/src/services/inventory.ts`
**Pattern**: Follow `createReceiptTransaction()` pattern (lines 302-361)
**Instructions**:
1. Locate `createBuildTransaction()` (line 632)
2. Replace the current implementation (lines 706-804) with a `prisma.$transaction()` wrapper
3. Move the following into the transaction callback:
   - Transaction creation with lines (lines 706-769)
   - FinishedGoodsLine creation (lines 775-804)
4. Implementation approach:

```typescript
// Replace current implementation starting at line 706 with:
return prisma.$transaction(async (tx) => {
  // Determine output behavior
  const shouldOutputFG = params.outputToFinishedGoods !== false  // default true

  // Get output location (use default if not specified)
  let outputLocationForFG: string | null = null
  if (shouldOutputFG) {
    outputLocationForFG = params.outputLocationId ?? await getDefaultLocationId(params.companyId)

    // Validate output location exists and belongs to company
    if (outputLocationForFG) {
      const outputLoc = await tx.location.findFirst({
        where: {
          id: outputLocationForFG,
          companyId: params.companyId,
          isActive: true,
        },
      })
      if (!outputLoc) {
        throw new Error('Output location not found or not active')
      }
    }
  }

  // Create transaction with lines (existing logic)
  const transaction = await tx.transaction.create({
    // ... existing data object
  })

  // Create finished goods line atomically if outputting FG
  if (shouldOutputFG && outputLocationForFG) {
    const outputQty = params.outputQuantity ?? params.unitsToBuild
    await tx.finishedGoodsLine.create({
      data: {
        transactionId: transaction.id,
        skuId: params.skuId,
        locationId: outputLocationForFG,
        quantityChange: new Prisma.Decimal(outputQty),
        costPerUnit: new Prisma.Decimal(unitBomCost),
      },
    })
  }

  return { transaction, outputLocationForFG }
})
```

5. Update the defect threshold evaluation to happen AFTER the transaction (cannot be inside $transaction as it may make additional queries)
6. Update return value construction to use data from transaction result

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] All writes (Transaction, TransactionLine, FinishedGoodsLine) happen in single $transaction
- [ ] Default behavior outputs FG to default location when outputToFinishedGoods not explicitly false
- [ ] Explicit outputLocationId still works as before
- [ ] Backward compatible - existing calls without outputToFinishedGoods continue working
- [ ] TypeScript compiles without errors
- [ ] Build succeeds

### Subtask 2.3: Update BuildTransactionResult type if needed
**File**: `/home/pbrown/SkuInventory/src/services/inventory.ts`
**Instructions**:
1. Review `BuildTransactionResult` interface (lines 599-626)
2. Ensure it includes `outputToFinishedGoods` field in response:
   ```typescript
   outputToFinishedGoods?: boolean
   ```
3. Update the result construction to include this field

**Completion Criteria**:
- [ ] Result type includes FG output confirmation
- [ ] TypeScript compiles

---

## Phase 3: API Route Updates

### Subtask 3.1: Pass outputToFinishedGoods to service
**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/build/route.ts`
**Pattern**: Follow existing parameter passing pattern (lines 99-115)
**Instructions**:
1. Add `outputToFinishedGoods` to the service call parameters (after line 114):
   ```typescript
   outputToFinishedGoods: data.outputToFinishedGoods,
   ```
2. Include `outputToFinishedGoods` in the API response (after line 144):
   ```typescript
   outputToFinishedGoods: result.transaction.outputToFinishedGoods ?? true,
   ```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] API accepts outputToFinishedGoods parameter
- [ ] API response includes outputToFinishedGoods status
- [ ] TypeScript compiles without errors
- [ ] Build succeeds

---

## Phase 4: UI Considerations (Optional/Minor)

### Subtask 4.1: Review BuildDialog behavior
**File**: `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx`
**Instructions**:
1. Review current behavior (lines 390-430)
2. Current behavior: User must explicitly select output location to enable FG output
3. With `outputToFinishedGoods=true` as default, consider:
   - Adding a "Output to Finished Goods" checkbox that defaults to checked
   - When checked but no location selected, uses default location
   - When unchecked, sends `outputToFinishedGoods: false`
4. **OPTIONAL**: This UI enhancement can be deferred to Issue #TBD (sub-issue #4) per the issue description

**Note**: The issue states "UI changes to BuildDialog (sub-issue #4)" are NOT included in this scope. The service-layer changes ensure backward compatibility - existing UI continues to work.

**Completion Criteria**:
- [ ] Existing BuildDialog continues to function correctly
- [ ] No breaking changes to UI behavior

---

## Phase 5: Tests

### Subtask 5.1: Add unit tests for atomic build transaction with FG output
**File**: `/home/pbrown/SkuInventory/tests/unit/inventory-service.test.ts` (or create new file)
**Instructions**:
1. Add test cases for:
   - Build with `outputToFinishedGoods: true` (explicit) creates FG line
   - Build with `outputToFinishedGoods: false` does NOT create FG line
   - Build with no `outputToFinishedGoods` (default true) creates FG line
   - Build with `outputLocationId` uses specified location
   - Build without `outputLocationId` uses default location
   - Atomicity: if FG line creation would fail, entire transaction rolls back

**Test Example**:
```typescript
describe('createBuildTransaction with finished goods', () => {
  it('outputs to finished goods by default', async () => {
    // Mock setup
    // Call createBuildTransaction without outputToFinishedGoods
    // Verify FinishedGoodsLine was created
  })

  it('uses default location when outputLocationId not provided', async () => {
    // Mock default location
    // Call createBuildTransaction with outputToFinishedGoods: true
    // Verify FG line uses default location
  })

  it('does not output FG when outputToFinishedGoods is false', async () => {
    // Call with outputToFinishedGoods: false
    // Verify NO FinishedGoodsLine created
  })
})
```

**Validation Commands**:
```bash
npm test -- --filter="createBuildTransaction"
```

**Completion Criteria**:
- [ ] Tests for default FG output behavior
- [ ] Tests for explicit false disables FG output
- [ ] Tests for location selection logic
- [ ] All tests pass

### Subtask 5.2: Update integration tests
**File**: `/home/pbrown/SkuInventory/tests/integration/location-transactions.test.ts`
**Instructions**:
1. Review existing test at line 331 ("Build with output location")
2. Add test case for default FG output behavior (no outputLocationId specified)
3. Add test case for `outputToFinishedGoods: false`

**Completion Criteria**:
- [ ] Integration tests cover new behavior
- [ ] All existing tests still pass

---

## Phase 6: Final Verification

### Subtask 6.1: Build and type check
**Instructions**:
```bash
cd /home/pbrown/SkuInventory
npx tsc --noEmit
npm run build
npm run lint
```

**Completion Criteria**:
- [ ] TypeScript compiles without errors
- [ ] Build succeeds
- [ ] Lint passes

### Subtask 6.2: Run full test suite
**Instructions**:
```bash
npm test
```

**Completion Criteria**:
- [ ] All unit tests pass
- [ ] All integration tests pass

---

## Summary of Deliverables

**Files Modified**: 4
| File | Changes |
|------|---------|
| `src/types/transaction.ts` | Add `outputToFinishedGoods` to schema |
| `src/services/inventory.ts` | Wrap in $transaction, add default FG behavior |
| `src/app/api/transactions/build/route.ts` | Pass and return new parameter |
| `tests/unit/*.test.ts` | Add tests for new behavior |

**Files Created**: 0 (potentially new test file if needed)

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 -> 2 -> 3 -> 4 -> 5 -> 6)
2. Phase 2 is the critical implementation - follow the atomic transaction pattern carefully
3. Test completion criteria before each next subtask
4. Preserve backward compatibility - existing builds without new param should still work

## Technical Notes

**Atomic Transaction Pattern**:
The key change is wrapping the build transaction in `prisma.$transaction()`:
- Currently: `prisma.transaction.create()` then `prisma.finishedGoodsLine.create()` (2 separate calls)
- After: Both inside single `prisma.$transaction()` callback

**Default Location Logic**:
When `outputToFinishedGoods=true` (or undefined/default):
1. If `outputLocationId` provided -> use it
2. If not provided -> call `getDefaultLocationId(companyId)`
3. If no default location exists -> FG output skipped (graceful degradation)

**Backward Compatibility**:
- Existing API calls without `outputToFinishedGoods` will default to `true`
- Existing calls with `outputLocationId` continue to work exactly as before
- UI (BuildDialog) continues to function - enhanced UI is separate issue (#4)

---

## Test Strategy Note
- Use Vitest for unit tests (mocked Prisma)
- Integration tests use real database via test helpers
- Focus tests on atomicity and default behavior

## Performance Metrics

| Phase | Duration |
|-------|----------|
| Investigation | 25m |
| Validation | 10m |
| Planning | 20m |
| **Total** | **55m** |

---

## Acceptance Criteria from Issue #79

- [ ] Build transactions atomically update both component quantities and FG balance
- [ ] `outputToFinishedGoods` parameter controls FG output (default true)
- [ ] `FinishedGoodsLine` row created on first build for a SKU (using default location)
- [ ] Subsequent builds increment existing FG balance (via new FG lines)
- [ ] API response includes finished goods output quantity
- [ ] Unit tests cover atomic write behavior
- [ ] `npm run build` and `npx tsc --noEmit` pass
