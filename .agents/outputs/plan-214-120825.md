# Implementation Plan
**Generated**: 2025-12-08T10:30:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: Issue #214 - Refactor: Consolidate User-Company relationship to single source of truth
**Estimated Build Time**: 16-24 hours
**Complexity**: High

---

## Investigation Summary

### Request Analysis
**Type**: Refactoring (Architectural)
**Source**: GitHub Issue #214
**Priority**: Medium (Technical Debt, not blocking features)

### Task Classification
**Category**: REFACTORING
**Test Strategy**: FULL (architectural changes affecting auth and data access)
**Suggested Filter**: None - full test suite required

### Issue Validation
**Status**: Valid - Active technical debt
**Recent Changes**: Multiple issues (#82, #94, #96, #158, #167, #173, #192) have worked around this dual source of truth
**Related Closed Issues**:
- #24: Multi-company user assignments (parent issue)
- #82: Update session and auth to support multi-company context
- #94: Add user-company assignment UI and API
- #77: Add UserCompany join table and direct companyId to Component/SKU models

### Current State Assessment

#### Database Schema
```
User Model:
- id, email, name, role, isActive, etc.
- companyId (FK) -> Company  [DIRECT RELATIONSHIP - To be removed]
- userCompanies -> UserCompany[]  [JUNCTION TABLE - Source of truth]

UserCompany Model:
- userId, companyId (unique constraint)
- role: UserRole
- assignedAt: DateTime
```

#### Current Data State (Test DB)
| Users | Companies | UserCompany Records |
|-------|-----------|---------------------|
| 5 | 3 | 6 |

**Problem Evidence**:
- `ops@tonsil.tech`: Has `companyId` but 0 UserCompany records
- `viewer@tonsil.tech`: Has `companyId` but 0 UserCompany records
- Other users have inconsistent UserCompany counts vs companyId

#### Code Patterns Using Dual Sources

1. **src/lib/auth.ts** (15 occurrences) - Core authentication
   - Lines 52-56: Manual inclusion of primary company in accessibleCompanyIds
   - Lines 107-111: "backward compatibility" comments
   - Lines 190-195: Fallback for selectedCompanyId
   - Lines 206-208: Keeping companyId in sync

2. **src/app/api/companies/switch/route.ts** - Company switching
   - Lines 47-54: Dual check for userCompany OR user.companyId

3. **src/app/api/users/[id]/companies/route.ts** - User company assignments
   - Lines 147-159: Manual sync of User.companyId when updating assignments

4. **src/app/api/users/route.ts** - User creation
   - Lines 176-183: Creates User with companyId but NO UserCompany record

5. **src/app/api/companies/[id]/route.ts** - Company details
   - Lines 331-344: Counts both `_count.users` AND `_count.userCompanies` (confusing)

### Dependencies & Blockers

1. **Migration Required**: Must ensure all users have UserCompany records before removing companyId
2. **Session Structure**: JWT tokens store both `companyId` and `selectedCompanyId`
3. **Existing Users**: Some users exist without UserCompany records
4. **Test Data**: Test database needs to be migrated

**Can Proceed?**: YES (with careful migration strategy)

### Complexity Assessment
**Complexity**: High
**Effort**: 16-24 hours
**Risk**: Medium - Auth changes require careful testing

**Risk Factors**:
- Breaking existing user sessions
- Migration failure leaving orphaned users
- JWT token structure changes affecting active sessions

### Patterns Identified
**Primary**: `src/app/api/users/[id]/companies/route.ts` - Shows correct UserCompany CRUD patterns
**Secondary**: `src/lib/auth.ts` - Shows all backward compatibility workarounds to eliminate

### Ripple Effect Analysis

**Files Directly Affected**: 21 files (66 occurrences of companyId patterns)

| Category | Files | Description |
|----------|-------|-------------|
| Auth Core | 1 | `src/lib/auth.ts` - 15 occurrences |
| User API | 4 | `users/route.ts`, `users/[id]/route.ts`, `users/[id]/companies/route.ts` |
| Company API | 2 | `companies/route.ts`, `companies/[id]/route.ts`, `companies/switch/route.ts` |
| Import Routes | 4 | `import/components`, `import/skus`, `import/initial-inventory`, `import/inventory-snapshot` |
| Services | 3 | `forecast.ts`, `alert.ts`, `lowstock-alert.ts` |
| Other Routes | 6 | `brands`, `categories`, `chatbot`, `analytics/defects`, `alerts/defects`, `transactions`, `export/transactions` |
| Types | 2 | `src/types/index.ts`, `src/types/user.ts` |
| Schema | 1 | `prisma/schema.prisma` |

---

## Executive Summary

This refactor consolidates the User-Company relationship from a dual-source model (direct FK + junction table) to a single source of truth (UserCompany table only). The implementation follows **Option A** from the issue: remove `User.companyId` and add `isPrimary` flag to `UserCompany`. This eliminates ~15 "backward compatibility" workarounds in auth.ts and prevents counting confusion across the codebase.

---

## RECOMMENDATION: PROCEED WITH PHASED APPROACH

Given the complexity and risk, I recommend **proceeding** with this refactor, but in 3 separate issues/PRs:

1. **Issue #214-A (This Plan)**: Add `isPrimary` to UserCompany, create migration script, update user creation
2. **Issue #214-B (Follow-up)**: Update auth.ts and session handling to use UserCompany exclusively
3. **Issue #214-C (Follow-up)**: Remove User.companyId column and clean up remaining workarounds

**Rationale**: This allows incremental testing and rollback capability. Phase 1 is non-breaking and can be deployed safely.

---

## Phase 0: Environment Verification

### Subtask 0.1: Verify Test Environment
**Instructions**:
```bash
# Verify targeting test database
docker exec inventory-db-test psql -U inventory_test -d inventory_test -c "SELECT current_database();"
# Expected: inventory_test

# Check current user/company state
docker exec inventory-db-test psql -U inventory_test -d inventory_test -c "
  SELECT u.email, u.\"companyId\", COUNT(uc.id) as uc_count
  FROM \"User\" u
  LEFT JOIN \"UserCompany\" uc ON u.id = uc.\"userId\"
  GROUP BY u.id, u.email, u.\"companyId\";"
```
**Completion Criteria**:
- [ ] Confirmed targeting inventory_test database
- [ ] Documented current user/company state

---

## Phase 1: Database Schema Changes

### Subtask 1.1: Add isPrimary Column to UserCompany
**File**: `prisma/schema.prisma`
**Pattern**: Follow existing boolean column patterns in schema
**Instructions**:
1. Add `isPrimary Boolean @default(false)` to UserCompany model
2. Add partial unique index comment for documentation (one primary per user)

**Code Change**:
```prisma
model UserCompany {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyId  String
  company    Company  @relation("UserCompanies", fields: [companyId], references: [id], onDelete: Cascade)
  role       UserRole @default(ops)
  isPrimary  Boolean  @default(false)  // NEW: Designates user's default company
  assignedAt DateTime @default(now())

  @@unique([userId, companyId])
  @@index([userId])
  @@index([companyId])
  // Note: Application logic enforces one isPrimary=true per userId
}
```

**Validation**:
```bash
npx prisma validate
npx prisma format
```
**Completion Criteria**:
- [ ] Schema validates without errors
- [ ] isPrimary field added to UserCompany

### Subtask 1.2: Create and Run Migration
**File**: New migration file
**Instructions**:
```bash
DATABASE_URL="postgresql://inventory_test:inventory_test_2025@localhost:2346/inventory_test" npx prisma migrate dev --name add_isprimary_to_usercompany
```

**Validation**:
```bash
# Verify column exists
docker exec inventory-db-test psql -U inventory_test -d inventory_test -c "\d \"UserCompany\""
```
**Completion Criteria**:
- [ ] Migration runs successfully
- [ ] isPrimary column exists in UserCompany table

### Subtask 1.3: Create Data Migration Script
**File**: `prisma/migrations/data-migrate-usercompany-primary.ts` (new file)
**Instructions**:
Create a script that:
1. For each User, check if they have a UserCompany record for their current companyId
2. If no UserCompany exists, create one with isPrimary=true
3. If UserCompany exists for companyId, set isPrimary=true
4. Ensure exactly one isPrimary=true per user

**Code**:
```typescript
import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient()

async function main() {
  console.log('Starting UserCompany data migration...')

  // Get all users with their companyId and userCompanies
  const users = await prisma.user.findMany({
    include: {
      userCompanies: true,
    },
  })

  console.log(`Processing ${users.length} users...`)

  for (const user of users) {
    const existingPrimaryRecord = user.userCompanies.find(uc => uc.companyId === user.companyId)

    if (!existingPrimaryRecord) {
      // Create missing UserCompany record
      await prisma.userCompany.create({
        data: {
          userId: user.id,
          companyId: user.companyId,
          role: user.role,
          isPrimary: true,
        },
      })
      console.log(`Created UserCompany for ${user.email} -> company ${user.companyId}`)
    } else {
      // Ensure isPrimary is set
      await prisma.userCompany.update({
        where: { id: existingPrimaryRecord.id },
        data: { isPrimary: true },
      })
      console.log(`Set isPrimary for ${user.email} -> company ${user.companyId}`)
    }

    // Clear any other isPrimary flags for this user
    await prisma.userCompany.updateMany({
      where: {
        userId: user.id,
        companyId: { not: user.companyId },
      },
      data: { isPrimary: false },
    })
  }

  console.log('Migration complete!')

  // Verify
  const orphanedUsers = await prisma.user.findMany({
    where: {
      userCompanies: { none: {} },
    },
  })

  if (orphanedUsers.length > 0) {
    console.error('ERROR: Users without UserCompany records:', orphanedUsers.map(u => u.email))
  } else {
    console.log('SUCCESS: All users have at least one UserCompany record')
  }
}

main()
  .catch(console.error)
  .finally(() => prisma.$disconnect())
```

**Validation**:
```bash
DATABASE_URL="postgresql://inventory_test:inventory_test_2025@localhost:2346/inventory_test" npx ts-node prisma/migrations/data-migrate-usercompany-primary.ts
```
**Completion Criteria**:
- [ ] Script runs without errors
- [ ] All users have at least one UserCompany record
- [ ] Each user has exactly one isPrimary=true

---

## Phase 2: Update User Creation Flow

### Subtask 2.1: Update POST /api/users to Create UserCompany
**File**: `/home/pbrown/SkuInventory/src/app/api/users/route.ts`
**Lines**: 176-194
**Pattern**: Follow existing transaction patterns
**Instructions**:
Update user creation to:
1. Use a transaction to create User AND UserCompany atomically
2. Set isPrimary=true for the initial company assignment

**Code Change** (lines 175-195):
```typescript
    // Create user in the selected company with UserCompany record
    const user = await prisma.$transaction(async (tx) => {
      const newUser = await tx.user.create({
        data: {
          companyId: selectedCompanyId,
          email,
          passwordHash,
          name,
          role,
        },
        select: {
          id: true,
          email: true,
          name: true,
          role: true,
          isActive: true,
          lastLoginAt: true,
          createdAt: true,
          updatedAt: true,
        },
      })

      // Create UserCompany record (source of truth for company access)
      await tx.userCompany.create({
        data: {
          userId: newUser.id,
          companyId: selectedCompanyId,
          role,
          isPrimary: true,
        },
      })

      return newUser
    })
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```
**Completion Criteria**:
- [ ] User creation includes UserCompany record
- [ ] isPrimary=true on initial assignment
- [ ] Build passes

### Subtask 2.2: Update TypeScript Types
**File**: `/home/pbrown/SkuInventory/src/types/user.ts`
**Instructions**:
Add UserCompany types if not already present:

```typescript
// UserCompany record (source of truth for company membership)
export interface UserCompanyRecord {
  id: string
  companyId: string
  companyName: string
  role: 'admin' | 'ops' | 'viewer'
  isPrimary: boolean
  assignedAt: string
}
```

**Validation**:
```bash
npx tsc --noEmit
```
**Completion Criteria**:
- [ ] Types updated
- [ ] TypeScript compiles

---

## Phase 3: Update Company Assignment Logic

### Subtask 3.1: Update PUT /api/users/[id]/companies
**File**: `/home/pbrown/SkuInventory/src/app/api/users/[id]/companies/route.ts`
**Lines**: 136-177
**Instructions**:
Update to properly handle isPrimary:
1. When reassigning companies, preserve the isPrimary flag
2. If primary company is removed, set first new company as primary
3. Update User.companyId to match primary (for backward compatibility during transition)

**Code Change** (update transaction block):
```typescript
    const result = await prisma.$transaction(async (tx) => {
      // Get current primary company
      const currentPrimary = await tx.userCompany.findFirst({
        where: { userId: id, isPrimary: true },
      })

      // Determine new primary: keep current if still in list, otherwise first
      const newPrimaryCompanyId = currentPrimary && companyIds.includes(currentPrimary.companyId)
        ? currentPrimary.companyId
        : companyIds[0]

      // Delete existing UserCompany records
      await tx.userCompany.deleteMany({
        where: { userId: id },
      })

      // Create new UserCompany records with proper isPrimary
      const userCompanyRecords = companyIds.map((companyId) => ({
        userId: id,
        companyId,
        role: user.companyId === companyId ? UserRole.admin : UserRole.ops,
        isPrimary: companyId === newPrimaryCompanyId,
      }))

      await tx.userCompany.createMany({
        data: userCompanyRecords,
      })

      // Keep User.companyId in sync (backward compatibility)
      await tx.user.update({
        where: { id },
        data: { companyId: newPrimaryCompanyId },
      })

      return tx.userCompany.findMany({
        where: { userId: id },
        select: {
          id: true,
          companyId: true,
          company: { select: { name: true } },
          role: true,
          isPrimary: true,
          assignedAt: true,
        },
      })
    })
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```
**Completion Criteria**:
- [ ] isPrimary properly managed during reassignment
- [ ] User.companyId stays in sync (transitional)
- [ ] Build passes

---

## Phase 4: Update API Response Types

### Subtask 4.1: Include isPrimary in UserCompany Responses
**Files**:
- `/home/pbrown/SkuInventory/src/app/api/users/[id]/companies/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/users/[id]/route.ts`
- `/home/pbrown/SkuInventory/src/app/api/users/route.ts`

**Instructions**:
Update all UserCompany response mappings to include isPrimary:

```typescript
companies: user.userCompanies.map((uc) => ({
  id: uc.id,
  companyId: uc.companyId,
  companyName: uc.company.name,
  role: uc.role,
  isPrimary: uc.isPrimary,  // NEW
  assignedAt: uc.assignedAt.toISOString(),
})),
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```
**Completion Criteria**:
- [ ] All UserCompany responses include isPrimary
- [ ] Build passes

---

## Phase 5: Testing

### Subtask 5.1: Verify Data Migration
**Instructions**:
```bash
# Run data migration
DATABASE_URL="postgresql://inventory_test:inventory_test_2025@localhost:2346/inventory_test" npx ts-node prisma/migrations/data-migrate-usercompany-primary.ts

# Verify all users have UserCompany records
docker exec inventory-db-test psql -U inventory_test -d inventory_test -c "
  SELECT u.email,
         u.\"companyId\" as primary_company,
         COUNT(uc.id) as uc_count,
         MAX(CASE WHEN uc.\"isPrimary\" THEN 'YES' ELSE 'NO' END) as has_primary
  FROM \"User\" u
  LEFT JOIN \"UserCompany\" uc ON u.id = uc.\"userId\"
  GROUP BY u.id, u.email, u.\"companyId\"
  ORDER BY u.email;"
```

**Completion Criteria**:
- [ ] All users have at least 1 UserCompany record
- [ ] All users have exactly 1 isPrimary=true record
- [ ] isPrimary company matches User.companyId

### Subtask 5.2: Test User Creation
**Instructions**:
1. Create a new user via UI or API
2. Verify UserCompany record is created with isPrimary=true
3. Verify User.companyId matches

```bash
# After creating user, verify
docker exec inventory-db-test psql -U inventory_test -d inventory_test -c "
  SELECT u.email, uc.\"companyId\", uc.\"isPrimary\", uc.role
  FROM \"User\" u
  JOIN \"UserCompany\" uc ON u.id = uc.\"userId\"
  WHERE u.email = '[NEW_USER_EMAIL]';"
```

**Completion Criteria**:
- [ ] New user has UserCompany record
- [ ] isPrimary=true on initial company

### Subtask 5.3: Test Company Assignment Updates
**Instructions**:
1. Update a user's company assignments via admin UI
2. Verify isPrimary is preserved or correctly transferred
3. Verify User.companyId stays in sync

**Completion Criteria**:
- [ ] Company reassignment works
- [ ] isPrimary correctly managed

### Subtask 5.4: Run Full Test Suite
**Instructions**:
```bash
npm test
npm run build
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] All tests pass
- [ ] Build succeeds
- [ ] No TypeScript errors

---

## Summary of Deliverables

**Files Created**: 2
- `prisma/migrations/[timestamp]_add_isprimary_to_usercompany/migration.sql` (auto-generated)
- `prisma/migrations/data-migrate-usercompany-primary.ts` (manual)

**Files Modified**: 5
- `prisma/schema.prisma` - Add isPrimary to UserCompany
- `src/app/api/users/route.ts` - Create UserCompany on user creation
- `src/app/api/users/[id]/companies/route.ts` - Handle isPrimary in assignments
- `src/app/api/users/[id]/route.ts` - Include isPrimary in responses
- `src/types/user.ts` - Add isPrimary to types

---

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 0 -> Phase 1 -> ... -> Phase 5)
2. Complete Phase 0 verification before proceeding
3. Run data migration script AFTER schema migration
4. Test completion criteria after each subtask
5. Follow reference patterns exactly

**CRITICAL**: Do NOT remove User.companyId column in this PR. That is Phase 2 work (Issue #214-B).

---

## Test Strategy Note

- **Unit Tests**: Run full Vitest suite
- **E2E Tests**: Test user creation and company assignment flows
- **Manual Testing**: Verify admin UI works correctly

---

## Future Work (Not in This PR)

These items are tracked for follow-up issues:

### Issue #214-B: Update Auth to Use UserCompany Exclusively
- Update `src/lib/auth.ts` to derive companies from UserCompany only
- Remove "backward compatibility" workarounds
- Update session token structure
- Files affected: ~8 files

### Issue #214-C: Remove User.companyId Column
- Remove `companyId` from User model
- Remove all remaining backward compatibility code
- Final cleanup
- Files affected: ~15 files

---

## Performance Metrics

| Phase | Estimated Duration |
|-------|-------------------|
| Investigation | 45m |
| Validation | 15m |
| Planning | 30m |
| **Total Scout-Plan** | **90m** |
| **Estimated Build** | **8-12h** |

---

## Appendix: All Affected Files (Full List)

### Phase 1 (This PR)
1. `prisma/schema.prisma`
2. `prisma/migrations/data-migrate-usercompany-primary.ts` (new)
3. `src/app/api/users/route.ts`
4. `src/app/api/users/[id]/companies/route.ts`
5. `src/app/api/users/[id]/route.ts`
6. `src/types/user.ts`

### Future Phases (Not This PR)
7. `src/lib/auth.ts` (15 occurrences)
8. `src/types/index.ts` (SessionUser type)
9. `src/app/api/companies/switch/route.ts`
10. `src/app/api/companies/[id]/route.ts`
11. `src/app/api/analytics/defects/route.ts`
12. `src/app/api/alerts/defects/route.ts`
13. `src/app/api/chatbot/route.ts`
14. `src/app/api/transactions/[id]/route.ts`
15. `src/app/api/export/transactions/route.ts`
16. `src/app/api/brands/route.ts`
17. `src/app/api/categories/route.ts`
18. `src/app/api/import/components/route.ts`
19. `src/app/api/import/skus/route.ts`
20. `src/app/api/import/initial-inventory/route.ts`
21. `src/app/api/import/inventory-snapshot/route.ts`
22. `src/app/api/import/template/[type]/route.ts`
23. `src/services/forecast.ts`
24. `src/services/alert.ts`
25. `src/services/lowstock-alert.ts`
