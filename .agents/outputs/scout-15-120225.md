# Scout Report: Capture defect/quality notes per BOM version and build

## Request Analysis
**Type**: Enhancement
**Source**: GitHub Issue #15
**Priority**: Medium

## Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="defect|quality|bom|build"`

## Issue Validation
**Status**: ✅ Valid
**Recent Changes**: No defect/quality fields exist in current schema (verified 2025-12-02)
**Recent Commits**: Schema last modified for Phase 2 and Phase 3 (component inventory management)
**Current State**: Fresh feature - no existing defect/quality tracking infrastructure

## Current State

### Database (Prisma Schema)
**BOMVersion model** (lines 196-214):
- ✅ Has `notes` field (String?, @db.Text) - general notes
- ❌ No defect-specific fields
- ❌ No quality metadata fields

**Transaction model** (lines 128-154):
- ✅ Has `notes` field (String?, @db.Text) - general notes
- ❌ No defect count fields
- ❌ No quality metadata fields
- ❌ No structured defect tracking (JSON or separate fields)

### API Routes
**BOM Version Routes**:
- ✅ `/home/pbrown/SkuInventory/src/app/api/skus/[id]/bom-versions/route.ts` - GET/POST BOM versions
- ✅ `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/route.ts` - GET/PATCH/DELETE specific version
- ✅ `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/activate/route.ts` - Activate version
- ✅ `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/clone/route.ts` - Clone version

**Build Transaction Routes**:
- ✅ `/home/pbrown/SkuInventory/src/app/api/transactions/build/route.ts` - POST build transaction
- ✅ `/home/pbrown/SkuInventory/src/app/api/transactions/route.ts` - GET list transactions
- ✅ `/home/pbrown/SkuInventory/src/app/api/transactions/[id]/route.ts` - GET transaction detail

### Services
**BOM Service** (`/home/pbrown/SkuInventory/src/services/bom.ts`):
- ✅ `createBOMVersion()` - accepts `notes` parameter (line 167-236)
- ❌ No defect/quality specific parameters

**Inventory Service** (`/home/pbrown/SkuInventory/src/services/inventory.ts`):
- ✅ `createBuildTransaction()` - accepts `notes` parameter (line 415-536)
- ❌ No defect/quality specific parameters

### TypeScript Types
**BOM Types** (`/home/pbrown/SkuInventory/src/types/bom.ts`):
- ✅ `createBOMVersionSchema` - includes `notes` field (optional)
- ✅ `BOMVersionResponse` interface - includes `notes` field
- ❌ No defect/quality specific types

**Transaction Types** (`/home/pbrown/SkuInventory/src/types/transaction.ts`):
- ✅ `createBuildSchema` - includes `notes` field (optional)
- ✅ `TransactionResponse` interface - includes `notes` field
- ❌ No defect/quality specific types

### Frontend Components
**BOM Version Components**:
- ✅ `/home/pbrown/SkuInventory/src/components/features/BOMVersionForm.tsx` - Create BOM version form (has notes textarea)
- ✅ `/home/pbrown/SkuInventory/src/components/features/BOMVersionList.tsx` - Display BOM versions (shows notes)

**Build Transaction Components**:
- ✅ `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx` - Build dialog form (has notes input)
- ✅ `/home/pbrown/SkuInventory/src/components/features/TransactionDetail.tsx` - Transaction detail view (shows notes)

### Export Functionality
**Export Service** (`/home/pbrown/SkuInventory/src/services/export.ts`):
- ✅ Has transaction export columns including `notes` field
- ❌ No defect/quality specific columns

**Export Routes**:
- ✅ `/home/pbrown/SkuInventory/src/app/api/export/transactions/route.ts` - Exports transactions
- ❌ Would need to add defect/quality columns

## Dependencies & Blockers

**Prerequisites Met**:
1. ✅ BOM version CRUD operations exist
2. ✅ Build transaction creation exists
3. ✅ User authentication and authorization in place
4. ✅ Tenant scoping implemented (Issue #2)

**Blockers**: None

**Can Proceed?**: YES

## Complexity Assessment
**Complexity**: Small to Moderate
**Effort**: 4-8 hours
**Risk**: Low

### Breakdown:
1. **Database Migration** (~1 hour): Add new fields to BOMVersion and Transaction models
2. **Backend Updates** (~2-3 hours): Update services, API routes, and validation schemas
3. **Frontend Updates** (~2-3 hours): Add form fields and display in existing components
4. **Export Updates** (~1 hour): Add columns to transaction export
5. **Testing** (~1 hour): Targeted tests for new functionality

## Patterns to Follow

**Primary Reference**: Existing `notes` field pattern
- Already implemented in BOMVersion model
- Already implemented in Transaction model
- Frontend already has textarea/input for notes
- Backend already accepts and stores notes

**Secondary References**:
1. **JSON field pattern**: `Company.settings` field (schema line 16) - for structured defect metadata
2. **Nullable optional fields**: `Transaction.supplier`, `Transaction.reason` - for defect fields
3. **Type safety**: All existing Zod schemas in `/home/pbrown/SkuInventory/src/types/`

## Files to Create/Modify

### Database Layer (1 file)
- **MODIFY**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
  - Add fields to `BOMVersion` model: `defectNotes`, `qualityMetadata` (JSON)
  - Add fields to `Transaction` model: `defectCount`, `defectNotes`, `affectedUnits`

### Migration (1 file)
- **CREATE**: Migration file (auto-generated via `npx prisma migrate dev`)

### Backend - Types (2 files)
- **MODIFY**: `/home/pbrown/SkuInventory/src/types/bom.ts`
  - Update `createBOMVersionSchema` to include defect/quality fields
  - Update `BOMVersionResponse` interface

- **MODIFY**: `/home/pbrown/SkuInventory/src/types/transaction.ts`
  - Update `createBuildSchema` to include defect fields
  - Update `TransactionResponse` interface

### Backend - Services (2 files)
- **MODIFY**: `/home/pbrown/SkuInventory/src/services/bom.ts`
  - Update `createBOMVersion()` to accept defect/quality parameters

- **MODIFY**: `/home/pbrown/SkuInventory/src/services/inventory.ts`
  - Update `createBuildTransaction()` to accept defect parameters

### Backend - API Routes (4 files)
- **MODIFY**: `/home/pbrown/SkuInventory/src/app/api/skus/[id]/bom-versions/route.ts`
  - Update POST handler to accept and save defect/quality data
  - Update GET handler to return defect/quality data

- **MODIFY**: `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/route.ts`
  - Update GET handler to return defect/quality data
  - Update PATCH handler to allow editing defect/quality data

- **MODIFY**: `/home/pbrown/SkuInventory/src/app/api/transactions/build/route.ts`
  - Update POST handler to accept defect data

- **MODIFY**: `/home/pbrown/SkuInventory/src/app/api/transactions/route.ts`
  - Update GET handler to return defect data

### Frontend - Components (4 files)
- **MODIFY**: `/home/pbrown/SkuInventory/src/components/features/BOMVersionForm.tsx`
  - Add defect/quality notes fields to form

- **MODIFY**: `/home/pbrown/SkuInventory/src/components/features/BOMVersionList.tsx`
  - Display defect/quality notes in expanded view

- **MODIFY**: `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx`
  - Add defect count/notes fields to build form

- **MODIFY**: `/home/pbrown/SkuInventory/src/components/features/TransactionDetail.tsx`
  - Display defect data in transaction detail view

### Export Layer (2 files)
- **MODIFY**: `/home/pbrown/SkuInventory/src/services/export.ts`
  - Add defect/quality columns to transaction export

- **MODIFY**: `/home/pbrown/SkuInventory/src/app/api/export/transactions/route.ts`
  - Include defect data in exported CSV

## Final Sweep Results

**Comprehensive grep for BOMVersion/Transaction usage**:

### BOMVersion References (22 files)
All files that reference BOMVersion or bomVersion:
- `/home/pbrown/SkuInventory/src/services/inventory.ts` - Uses bomVersionId
- `/home/pbrown/SkuInventory/src/types/transaction.ts` - References bomVersion
- `/home/pbrown/SkuInventory/src/app/api/dashboard/route.ts` - Queries BOM versions
- `/home/pbrown/SkuInventory/src/app/api/components/[id]/route.ts` - Checks BOM usage
- `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/clone/route.ts` - Clones BOM
- `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/activate/route.ts` - Activates BOM
- `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/route.ts` - CRUD operations
- `/home/pbrown/SkuInventory/src/app/api/skus/[id]/bom-versions/route.ts` - List/create BOMs
- `/home/pbrown/SkuInventory/src/app/api/skus/[id]/route.ts` - SKU detail with BOMs
- `/home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/page.tsx` - Display SKU with BOMs
- `/home/pbrown/SkuInventory/src/types/sku.ts` - SKU response with BOM info
- `/home/pbrown/SkuInventory/src/app/(dashboard)/skus/page.tsx` - SKU list
- `/home/pbrown/SkuInventory/src/services/bom.ts` - BOM service layer
- `/home/pbrown/SkuInventory/src/types/bom.ts` - BOM type definitions
- `/home/pbrown/SkuInventory/src/components/features/TransactionDetail.tsx` - Shows BOM version
- `/home/pbrown/SkuInventory/src/components/features/BOMVersionForm.tsx` - BOM form
- `/home/pbrown/SkuInventory/src/components/features/BOMVersionList.tsx` - BOM list
- `/home/pbrown/SkuInventory/src/app/api/skus/route.ts` - SKU list API
- `/home/pbrown/SkuInventory/src/app/api/transactions/[id]/route.ts` - Transaction detail
- `/home/pbrown/SkuInventory/src/app/api/transactions/route.ts` - Transaction list
- `/home/pbrown/SkuInventory/src/app/api/export/skus/route.ts` - SKU export
- `/home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/bom/new/page.tsx` - New BOM page

### Build Transaction References (2 files)
Direct references to build transaction creation:
- `/home/pbrown/SkuInventory/src/services/inventory.ts` - createBuildTransaction()
- `/home/pbrown/SkuInventory/src/types/index.ts` - Type exports

### Services Layer Analysis
**Key service methods affected**:
1. `createBOMVersion()` in `/home/pbrown/SkuInventory/src/services/bom.ts`
   - Used by: `/home/pbrown/SkuInventory/src/app/api/skus/[id]/bom-versions/route.ts` (POST)

2. `createBuildTransaction()` in `/home/pbrown/SkuInventory/src/services/inventory.ts`
   - Used by: `/home/pbrown/SkuInventory/src/app/api/transactions/build/route.ts` (POST)

**No ripple effect beyond direct callers** - these are leaf functions called only by their respective API routes.

### Display/UI Files
All files that would need to display the new defect/quality data:
- `/home/pbrown/SkuInventory/src/components/features/BOMVersionList.tsx` - Shows BOM version details
- `/home/pbrown/SkuInventory/src/components/features/TransactionDetail.tsx` - Shows transaction details
- `/home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/page.tsx` - SKU detail page (includes BOM list)

**Total Files Requiring Changes**: 18 files
- Database schema: 1
- Type definitions: 2
- Service layer: 2
- API routes: 5
- Frontend components: 4
- Export functionality: 2
- Pages: 2 (likely minor or no changes needed)

## Acceptance Criteria

From Issue #15:

- [ ] Users can save defect/quality notes on BOM versions and see them in SKU/BOM views
- [ ] Build transactions can include defect notes/counts; data shows in transaction detail and exports
- [ ] API enforces authZ (viewer cannot modify); validations allow optional fields
- [ ] Tests cover saving and retrieving defect metadata on BOM versions and builds

## Handoff to Plan Agent

**Summary**:
This is a straightforward feature addition that extends existing BOM version and build transaction functionality with optional defect/quality tracking fields. The codebase already has a solid foundation with `notes` fields on both models, and we're essentially adding more specialized fields following the same pattern. The implementation follows clear existing patterns: nullable optional fields in the database, Zod validation for API inputs, service layer parameter additions, and form field additions in existing components.

**Key Points**:
1. **Low Risk**: Only adding optional fields, not modifying core business logic
2. **Clear Patterns**: Existing `notes` field implementation provides exact template
3. **No Blockers**: All prerequisites met, tenant scoping already implemented
4. **Minimal Ripple**: Changes are contained to specific files with clear boundaries
5. **Test Strategy**: TARGETED testing - focus on new defect/quality fields in BOM and build flows

**Suggested Phases**:
1. **Phase 1 - Database & Types**: Schema migration + TypeScript type updates
2. **Phase 2 - Backend**: Service and API route updates
3. **Phase 3 - Frontend**: Form and display component updates
4. **Phase 4 - Export**: CSV export column additions
5. **Phase 5 - Testing**: Targeted tests for new functionality

**Implementation Strategy**:
- Use JSON field type for `qualityMetadata` on BOMVersion (flexible structured data)
- Use simple nullable fields for Transaction defect tracking (defectCount, defectNotes, affectedUnits)
- All new fields are optional (nullable) to maintain backward compatibility
- Follow existing authorization patterns (viewer role check already exists)

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Issue Parsing | 2m |
| Codebase Exploration | 15m |
| Schema Analysis | 8m |
| Pattern Identification | 10m |
| Comprehensive Grep | 5m |
| Report Writing | 12m |
| **Total** | **52m** |

---

AGENT_RETURN: scout-15-120225
