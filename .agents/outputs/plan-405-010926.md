# Implementation Plan

**Issue**: #405 - Add TACOS metric to analytics dashboard
**Tier**: 2 (Standard)
**Type**: Enhancement
**Est. Time**: 3-4 hours
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED

**Generated**: 2026-01-09
**Generated By**: Scout-and-Plan Agent (combined workflow)

---

## Summary

Add TACOS (Total Advertising Cost of Sale) metric to the Amazon analytics dashboard. TACOS differs from ACOS in that it calculates advertising efficiency as a percentage of TOTAL sales (organic + ad-attributed), providing a blended view of advertising efficiency. The formula is: `TACOS = (Ad Spend / Total Sales) * 100`. This enhancement requires updates to the types, API response, summary cards, and trend chart to display TACOS alongside ACOS.

---

## Investigation Summary

### Request Analysis
**Type**: Enhancement (add new metric)
**Source**: GitHub Issue #405
**Priority**: P2 (Medium)

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: None (standard test suite)

### Issue Validation
**Status**: Valid
**Recent Changes**: Recent commits (within 30 days) added the Amazon Analytics Dashboard UI including the AcosRoasChart component

### Current State Assessment

**Data Availability (CRITICAL)**: All required data already exists:
- `SalesDaily` model has `totalSales`, `adAttributedSales`, `organicSales` fields
- `KeywordMetric` model has `spend` field
- Sales-daily API already returns `totalSales` in summary
- Amazon analytics API already returns `totalSpend` from keyword metrics

**Existing Components**:
- `src/app/api/analytics/amazon/route.ts` - Returns keyword metrics with ACOS/ROAS (no TACOS)
- `src/components/analytics/AcosRoasChart.tsx` - Displays ACOS/ROAS trend chart (needs TACOS line)
- `src/app/(dashboard)/amazon/page.tsx` - Dashboard page with summary cards showing ACOS (not TACOS)
- `src/types/amazon-analytics.ts` - Types for analytics data (needs `tacos` field)

**Types Affected**:
- `AcosRoasDataPoint` - needs `tacos` field
- `AmazonAnalyticsSummary` - needs `overallTacos` field
- `KeywordMetricsResponse.totals` - needs `overallTacos` field

### Dependencies & Blockers
No blockers. All required data is available from existing APIs.

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Simple-Moderate
**Effort**: 3-4 hours
**Risk**: Low - additive change to existing functionality

### Patterns Identified
**Primary**: `src/components/analytics/AcosRoasChart.tsx` - Pattern for adding chart lines
**Secondary**: `src/app/(dashboard)/amazon/page.tsx` (lines 572-585) - Pattern for StatCard display

### Ripple Effect Analysis
**Files Identified**: 6 files

| File | Why Affected |
|------|--------------|
| `src/types/amazon-analytics.ts` | Add `tacos` to types |
| `src/app/api/analytics/amazon/route.ts` | Calculate and return TACOS |
| `src/app/(dashboard)/amazon/page.tsx` | Add TACOS summary card, calculate TACOS for trend data |
| `src/components/analytics/AcosRoasChart.tsx` | Add TACOS line to chart |
| `src/components/analytics/KeywordMetricsTable.tsx` | Optional: Add TACOS column |
| `src/components/analytics/CampaignTable.tsx` | Optional: Add TACOS column |

---

## Changes Required

### Phase 1: Types Layer

| Subtask | File | Change | Completion Criteria |
|---------|------|--------|---------------------|
| 1.1 | `src/types/amazon-analytics.ts` | Add `tacos` field to `AcosRoasDataPoint`, add `overallTacos` to `AmazonAnalyticsSummary` and `KeywordMetricsResponse.totals` | [ ] Types compile without errors |

**Detailed Instructions for 1.1**:
1. Update `AcosRoasDataPoint` interface (line 18-24):
   - Add `tacos: number // percentage - Total Ad Cost of Sale`
   - Add `totalSales: number` (needed for tooltip context)
2. Update `AmazonAnalyticsSummary` interface (line 89-97):
   - Add `overallTacos: number` after `overallAcos`
3. Update `KeywordMetricsResponse.totals` interface (line 107-114):
   - Add `overallTacos: number` after `overallAcos`
   - Add `totalTotalSales: number` (total sales including organic) for TACOS calculation

### Phase 2: API Layer

| Subtask | File | Change | Completion Criteria |
|---------|------|--------|---------------------|
| 2.1 | `src/app/api/analytics/amazon/route.ts` | Calculate and return TACOS in totals | [ ] API returns `overallTacos` field |

**Detailed Instructions for 2.1**:
1. After calculating `overallAcos` (line 152), add TACOS calculation:
   ```typescript
   // To calculate TACOS, we need total sales (organic + ad-attributed)
   // This data comes from sales-daily, so for now we return 0
   // The frontend will calculate TACOS using data from both APIs
   const overallTacos = 0 // Frontend calculates from combined data
   ```
2. Update the `totals` object in the response (lines 162-169) to include:
   - `overallTacos: 0` - placeholder, actual calculation happens on frontend

**Note**: The Amazon analytics API only has ad-attributed sales from keyword metrics. To calculate TACOS, we need total sales which comes from the sales-daily API. The frontend already fetches both APIs and combines the data.

### Phase 3: Frontend - Dashboard Page

| Subtask | File | Change | Completion Criteria |
|---------|------|--------|---------------------|
| 3.1 | `src/app/(dashboard)/amazon/page.tsx` | Add TACOS calculation, add TACOS summary card, update ACOS/ROAS trend data | [ ] TACOS card displays, [ ] TACOS appears in chart data |

**Detailed Instructions for 3.1**:

1. **Update summary state calculation** (lines 196-204 and 307-315):
   Add `overallTacos` calculation when setting summary:
   ```typescript
   // Calculate TACOS: Ad Spend / Total Sales * 100
   const overallTacos = prev.totalSales > 0
     ? (data.totals.totalSpend / prev.totalSales) * 100
     : 0
   ```
   Update the setSummary call to include `overallTacos`:
   ```typescript
   setSummary((prev) => {
     if (!prev) return prev
     const overallTacos = prev.totalSales > 0
       ? (data.totals.totalSpend / prev.totalSales) * 100
       : 0
     return {
       ...prev,
       totalSpend: data.totals.totalSpend,
       overallAcos: data.totals.overallAcos,
       overallRoas: data.totals.overallRoas,
       overallTacos: Math.round(overallTacos * 100) / 100,
     }
   })
   ```

2. **Update ACOS/ROAS trend data** (lines 320-327):
   Add `tacos` and `totalSales` to each data point:
   ```typescript
   const acosRoasTrend: AcosRoasDataPoint[] = salesTrendData.map((d) => ({
     date: d.date,
     acos: data.totals.overallAcos,
     roas: data.totals.overallRoas,
     spend: data.totals.totalSpend / salesTrendData.length,
     sales: d.adAttributedSales,
     totalSales: d.totalSales,
     tacos: d.totalSales > 0
       ? (data.totals.totalSpend / salesTrendData.length / d.totalSales) * 100
       : 0,
   }))
   ```

3. **Add TACOS summary card** (after line 578, before ROAS card):
   ```tsx
   <StatCard
     title="TACOS"
     value={`${summary.overallTacos.toFixed(1)}%`}
     subValue="Total Ad Cost of Sale"
     icon={TrendingDown}
     trend={summary.overallTacos > 15 ? 'down' : 'up'}
   />
   ```
   Note: TACOS thresholds are typically lower than ACOS (e.g., 15% TACOS is considered good vs 30% ACOS)

4. **Update grid to accommodate 5 cards** (line 541):
   Change from `lg:grid-cols-4` to `lg:grid-cols-5`:
   ```tsx
   <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-5">
   ```

### Phase 4: Frontend - Chart Component

| Subtask | File | Change | Completion Criteria |
|---------|------|--------|---------------------|
| 4.1 | `src/components/analytics/AcosRoasChart.tsx` | Add TACOS line, update tooltip, update legend | [ ] TACOS line visible in chart, [ ] Tooltip shows TACOS with explanation |

**Detailed Instructions for 4.1**:

1. **Update COLORS constant** (lines 24-27):
   ```typescript
   const COLORS = {
     acos: '#ef4444', // red-500
     roas: '#22c55e', // green-500
     tacos: '#3b82f6', // blue-500
   }
   ```

2. **Update card title and description** (lines 48-52):
   ```tsx
   <CardTitle>ACOS, TACOS & ROAS Trends</CardTitle>
   <CardDescription>
     Advertising Cost of Sales (ACOS), Total Advertising Cost of Sales (TACOS),
     and Return on Ad Spend (ROAS) over time
   </CardDescription>
   ```

3. **Update tooltip content** (lines 103-135):
   Add TACOS display after ACOS in the tooltip:
   ```tsx
   <p>
     <span style={{ color: COLORS.tacos }}>TACOS:</span>{' '}
     {tooltipData.tacos.toFixed(1)}%
   </p>
   <p className="text-xs text-muted-foreground ml-4">
     (Ad Cost / Total Sales)
   </p>
   ```

4. **Add TACOS Line element** (after ACOS Line, around line 148):
   ```tsx
   <Line
     yAxisId="left"
     type="monotone"
     dataKey="tacos"
     name="TACOS (%)"
     stroke={COLORS.tacos}
     strokeWidth={2}
     strokeDasharray="5 5"
     dot={{ fill: COLORS.tacos, strokeWidth: 2 }}
     activeDot={{ r: 6 }}
   />
   ```
   Note: Using `strokeDasharray="5 5"` to visually distinguish TACOS from ACOS (dashed line)

5. **Update empty state message** (line 61):
   ```tsx
   No ACOS/TACOS/ROAS data available
   ```

---

## Summary of Deliverables

**Files Created**: 0
**Files Modified**: 4

| File | Changes |
|------|---------|
| `src/types/amazon-analytics.ts` | Add `tacos`, `totalSales` to `AcosRoasDataPoint`; add `overallTacos` to summary types |
| `src/app/api/analytics/amazon/route.ts` | Add placeholder `overallTacos` to response (actual calc on frontend) |
| `src/app/(dashboard)/amazon/page.tsx` | Calculate TACOS, add summary card, update grid cols, update trend data |
| `src/components/analytics/AcosRoasChart.tsx` | Add TACOS line, update colors, tooltip, legend, title |

---

## Validation

```bash
# TypeScript check
npx tsc --noEmit

# Build check
npm run build

# Lint check
npm run lint

# Run targeted tests (analytics related)
npm test -- --testPathPattern="analytics"
```

---

## UI Acceptance Criteria

- [ ] TACOS summary card displays on dashboard with correct value
- [ ] TACOS card shows appropriate trend indicator (up=good if <15%, down=bad if >15%)
- [ ] TACOS line visible in ACOS/ROAS chart (blue dashed line)
- [ ] Tooltip shows TACOS value with explanation "(Ad Cost / Total Sales)"
- [ ] Chart legend includes TACOS entry
- [ ] All 5 summary cards visible on desktop (1024px+)
- [ ] Summary cards wrap appropriately on mobile (<768px)

---

## Notes

- **TACOS Interpretation**: Lower TACOS is better. If organic sales increase while ad spend stays constant, TACOS decreases (showing ads are helping overall business health)
- **Typical TACOS benchmarks**: <10% excellent, 10-15% good, 15-20% average, >20% needs optimization
- **ACOS vs TACOS**: ACOS only considers ad-attributed sales; TACOS considers total sales (organic + ad). A brand with high ACOS but low TACOS indicates strong organic performance being supported by advertising
- **Future Enhancement**: Could add a toggle to show/hide TACOS line on chart
- **Future Enhancement**: Could add TACOS column to KeywordMetricsTable and CampaignTable (deferred for simplicity)
