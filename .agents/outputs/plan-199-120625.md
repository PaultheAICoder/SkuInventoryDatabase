# Implementation Plan
**Generated**: 2025-12-06T16:55:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #199
**Estimated Build Time**: 3-4 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Enhancement (Security/Multi-tenancy)
**Source**: GitHub Issue #199
**Priority**: High (data integrity, part of V1 audit)
**Parent Issue**: #195 - Architectural Audit: Technical Debt and Design Issues from V1 Review

### Task Classification
**Category**: REFACTORING
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="inventory"` for unit tests

### Issue Validation
**Status**: Valid
**Recent Changes**: Issue #198 (BOM service layer) was recently completed with similar pattern - can use as reference.

### Current State Assessment

**Functions requiring updates in `src/services/inventory.ts`:**

| Function | Current Status | Required Change |
|----------|----------------|-----------------|
| `getComponentQuantity(componentId, companyId, locationId?)` | Has companyId, uses in query, but NO verification | Add component ownership verification |
| `getComponentQuantities(componentIds, companyId, locationId?)` | Has companyId, uses in query, but NO filter | Add component filter by company |
| `getComponentQuantitiesByLocation(componentId, companyId)` | Has companyId, uses in query, but NO verification | Add component ownership verification |

**Functions already correct (no changes needed):**
- `createReceiptTransaction` - already requires and uses companyId
- `createAdjustmentTransaction` - already requires and uses companyId
- `createInitialTransaction` - already requires and uses companyId
- `createBuildTransaction` - already requires and uses companyId
- `checkInsufficientInventory` - already requires companyId (calls getComponentQuantities which needs fixing)
- `getCompanySettings` - already requires and uses companyId

**Functions that need companyId added:**
| Function | Current Signature | Action |
|----------|-------------------|--------|
| `canDeleteComponent(componentId)` | No companyId | Add companyId, scope queries to company |

### Dependencies & Blockers
None - this can be done independently.

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Low (simple additions to existing functions)
**Effort**: 3-4 hours
**Risk**: Low (additive changes, existing tests already pass companyId)

### Patterns Identified
**Primary**: Issue #198 (BOM service companyId enforcement) - recently completed
**Secondary**: Existing inventory service functions already use companyId in queries

### Ripple Effect Analysis
**Files Identified**: 1 main file + tests

**Direct Changes:**
- `/home/pbrown/SkuInventory/src/services/inventory.ts` - Add verification to 3 functions, add companyId param to 1 function

**Caller Updates Required:**
After reviewing callers, NO caller updates are needed because:
1. `getComponentQuantity` - All 6 callers already pass companyId (lines 66, 119, 265, 181, 331 in various files)
2. `getComponentQuantities` - All 13 callers already pass companyId
3. `getComponentQuantitiesByLocation` - All 2 callers already pass companyId
4. `canDeleteComponent` - Only 1 caller (`/home/pbrown/SkuInventory/src/app/api/components/[id]/route.ts:382`) needs to pass companyId

**Callers of canDeleteComponent:**
- `src/app/api/components/[id]/route.ts:382` - needs to add companyId parameter

---

## Executive Summary
Add component ownership verification to `getComponentQuantity`, `getComponentQuantities`, and `getComponentQuantitiesByLocation` functions to ensure components belong to the calling company before returning inventory data. Also add `companyId` parameter to `canDeleteComponent` and scope its queries by company. These changes enforce multi-tenant isolation at the service layer.

## Phase 1: Update Inventory Service Functions

### Subtask 1.1: Add component verification to getComponentQuantity
**File**: `/home/pbrown/SkuInventory/src/services/inventory.ts`
**Lines**: 46-121
**Pattern**: See Implementation Notes in issue #199

**Instructions**:
1. At the start of the function (after line 50), add component ownership check:
```typescript
// Verify component belongs to company
const component = await prisma.component.findFirst({
  where: { id: componentId, companyId },
  select: { id: true }
})
if (!component) {
  throw new Error('Component not found or access denied')
}
```
2. The rest of the function remains unchanged (already uses companyId in transaction queries)

**Validation**:
```bash
npx tsc --noEmit
npm test -- --filter="inventory-quantity"
```

**Completion Criteria**:
- [ ] Function throws error if component doesn't belong to company
- [ ] Existing functionality preserved for valid components
- [ ] TypeScript compiles without errors

### Subtask 1.2: Add component filtering to getComponentQuantities
**File**: `/home/pbrown/SkuInventory/src/services/inventory.ts`
**Lines**: 133-238
**Pattern**: See Implementation Notes in issue #199

**Instructions**:
1. At the start of the function (after line 137), add:
```typescript
// Filter to only components the company owns
if (componentIds.length === 0) {
  return new Map()
}
const validComponents = await prisma.component.findMany({
  where: { id: { in: componentIds }, companyId },
  select: { id: true }
})
const validIds = validComponents.map(c => c.id)

// If no valid components, return empty map with zeros for requested IDs
if (validIds.length === 0) {
  const quantities = new Map<string, number>()
  for (const id of componentIds) {
    quantities.set(id, 0)
  }
  return quantities
}
```
2. Replace `componentIds` with `validIds` in all queries in the function:
   - Line 143: `componentId: { in: validIds },`
   - Line 179: `componentId: { in: validIds },`
   - Line 199: `componentId: { in: validIds },`
   - Line 219: `componentId: { in: validIds },`
3. At the end (around line 157-163), ensure all ORIGINAL componentIds have entries:
```typescript
// Ensure all originally requested components have an entry (even if 0)
for (const id of componentIds) {
  if (!quantities.has(id)) {
    quantities.set(id, 0)
  }
}
```

**Validation**:
```bash
npx tsc --noEmit
npm test -- --filter="inventory-quantity"
```

**Completion Criteria**:
- [ ] Only components belonging to company are queried
- [ ] Invalid component IDs return 0 quantity (not error)
- [ ] All requested IDs are present in return map
- [ ] TypeScript compiles without errors

### Subtask 1.3: Add component verification to getComponentQuantitiesByLocation
**File**: `/home/pbrown/SkuInventory/src/services/inventory.ts`
**Lines**: 244-280
**Pattern**: Follow getComponentQuantity pattern

**Instructions**:
1. At the start of the function (after line 247), add:
```typescript
// Verify component belongs to company
const component = await prisma.component.findFirst({
  where: { id: componentId, companyId },
  select: { id: true }
})
if (!component) {
  throw new Error('Component not found or access denied')
}
```
2. The rest of the function remains unchanged

**Validation**:
```bash
npx tsc --noEmit
npm test -- --filter="inventory"
```

**Completion Criteria**:
- [ ] Function throws error if component doesn't belong to company
- [ ] Existing functionality preserved for valid components
- [ ] TypeScript compiles without errors

### Subtask 1.4: Add companyId to canDeleteComponent
**File**: `/home/pbrown/SkuInventory/src/services/inventory.ts`
**Lines**: 626-663
**Pattern**: Follow existing patterns in file

**Instructions**:
1. Update function signature from:
```typescript
export async function canDeleteComponent(
  componentId: string
): Promise<{ canDelete: boolean; reason?: string }> {
```
To:
```typescript
export async function canDeleteComponent(
  componentId: string,
  companyId: string
): Promise<{ canDelete: boolean; reason?: string }> {
```
2. Add component ownership check at start of function:
```typescript
// Verify component belongs to company
const component = await prisma.component.findFirst({
  where: { id: componentId, companyId },
  select: { id: true }
})
if (!component) {
  return { canDelete: false, reason: 'Component not found or access denied' }
}
```
3. Update the transaction line count query (line 630-632) to scope by company:
```typescript
const transactionLineCount = await prisma.transactionLine.count({
  where: {
    componentId,
    transaction: { companyId }
  },
})
```
4. Update the BOM line count query (line 641-643) to scope by company:
```typescript
const bomLineCount = await prisma.bOMLine.count({
  where: {
    componentId,
    bomVersion: { sku: { companyId } }
  },
})
```
5. Lot query already scopes through componentId which is now verified

**Validation**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] Function requires companyId parameter
- [ ] Returns false if component doesn't belong to company
- [ ] Queries are scoped by company
- [ ] TypeScript compiles without errors

## Phase 2: Update Caller

### Subtask 2.1: Update canDeleteComponent caller in API route
**File**: `/home/pbrown/SkuInventory/src/app/api/components/[id]/route.ts`
**Line**: 382
**Pattern**: Other service calls in same file pass selectedCompanyId

**Instructions**:
1. Update line 382 from:
```typescript
const deleteCheck = await canDeleteComponent(id)
```
To:
```typescript
const deleteCheck = await canDeleteComponent(id, selectedCompanyId!)
```

**Validation**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] Caller passes companyId
- [ ] TypeScript compiles without errors
- [ ] Build succeeds

## Phase 3: Update Tests

### Subtask 3.1: Add multi-tenant isolation tests
**File**: `/home/pbrown/SkuInventory/tests/unit/inventory-quantity.test.ts`
**Pattern**: Existing test patterns in file

**Instructions**:
1. Add new describe block for multi-tenant isolation tests:
```typescript
describe('Multi-tenant isolation', () => {
  beforeEach(() => {
    vi.clearAllMocks()
  })

  it('getComponentQuantity throws for component from different company', async () => {
    // Mock component lookup to return null (not found)
    vi.mocked(prisma.component.findFirst).mockResolvedValue(null)

    await expect(
      getComponentQuantity('comp-1', 'company-different')
    ).rejects.toThrow('Component not found or access denied')
  })

  it('getComponentQuantities filters out components from different companies', async () => {
    // Mock component lookup to return only some valid components
    vi.mocked(prisma.component.findMany).mockResolvedValue([
      { id: 'comp-1' }
    ] as never)

    vi.mocked(prisma.transactionLine.groupBy).mockResolvedValue([
      { componentId: 'comp-1', _sum: { quantityChange: new Prisma.Decimal(100) } }
    ] as never)

    const result = await getComponentQuantities(['comp-1', 'comp-2'], 'company-1')

    // comp-1 should have real quantity, comp-2 (not owned) should have 0
    expect(result.get('comp-1')).toBe(100)
    expect(result.get('comp-2')).toBe(0)
  })
})
```

2. Add mock for `prisma.component` at the top of the mock setup if not already present:
```typescript
vi.mock('@/lib/db', () => ({
  prisma: {
    transactionLine: {
      aggregate: vi.fn(),
      groupBy: vi.fn(),
    },
    component: {
      findFirst: vi.fn(),
      findMany: vi.fn(),
    },
  },
}))
```

3. Update existing tests to mock the component verification if needed (some tests may need adjustment)

**Validation**:
```bash
npm test -- --filter="inventory-quantity"
```

**Completion Criteria**:
- [ ] Tests verify cross-tenant access is blocked
- [ ] All existing tests still pass
- [ ] Test coverage maintained

### Subtask 3.2: Add canDeleteComponent test with companyId
**File**: `/home/pbrown/SkuInventory/tests/unit/inventory-delete.test.ts`
**Pattern**: Existing test patterns

**Instructions**:
1. Update existing tests to pass companyId to canDeleteComponent
2. Add test for component not found/access denied case:
```typescript
it('returns false for component from different company', async () => {
  vi.mocked(prisma.component.findFirst).mockResolvedValue(null)

  const result = await canDeleteComponent('comp-1', 'other-company')

  expect(result.canDelete).toBe(false)
  expect(result.reason).toBe('Component not found or access denied')
})
```

**Validation**:
```bash
npm test -- --filter="inventory-delete"
```

**Completion Criteria**:
- [ ] Tests pass companyId to canDeleteComponent
- [ ] Test for access denial case added
- [ ] All tests pass

## Phase 4: Final Verification

### Subtask 4.1: Run full build and test suite
**Instructions**:
```bash
npx tsc --noEmit
npm run build
npm test -- --filter="inventory"
```

**Completion Criteria**:
- [ ] TypeScript compiles without errors
- [ ] Build completes without errors
- [ ] All inventory-related tests pass

---

## Summary of Deliverables
**Files Modified**: 3
- `src/services/inventory.ts` - 4 functions updated
- `src/app/api/components/[id]/route.ts` - 1 caller updated
- `tests/unit/inventory-quantity.test.ts` - multi-tenant tests added
- `tests/unit/inventory-delete.test.ts` - tests updated for companyId

## Handoff to Build Agent
1. Execute subtasks in exact order (Phase 1 -> Phase 2 -> Phase 3 -> Phase 4)
2. Each subtask must pass its validation commands before proceeding
3. Follow reference patterns from Issue #198 (BOM service) if uncertain
4. Use exact code snippets provided

## Test Strategy Note
- Use Vitest for unit tests
- Run with `--filter="inventory"` for targeted testing
- Full test suite can be run after completion

## Acceptance Criteria Mapping
From Issue #199:
- [x] `getComponentQuantity` requires and enforces companyId -> Subtask 1.1
- [x] `getComponentQuantities` requires and enforces companyId -> Subtask 1.2
- [x] All callers updated to pass companyId -> Subtask 2.1 (only canDeleteComponent caller needs update)
- [x] Unit tests verify cross-tenant access is blocked -> Subtask 3.1, 3.2
- [x] `npm run build` and `npx tsc --noEmit` complete without errors -> Subtask 4.1
- [x] Existing tests pass -> Subtask 4.1

## Performance Metrics
| Phase | Estimated Duration |
|-------|-------------------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 10m |
| **Total** | **30m** |
