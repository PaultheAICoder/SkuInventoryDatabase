# Scout Report: Defect Rate Analytics Dashboard

## Request Analysis
**Type**: Enhancement
**Source**: GitHub Issue #46
**Priority**: Medium

## Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="analytics|defect|dashboard|chart"`

## Issue Validation
**Status**: ✅ Valid
**Recent Changes**: Issue #15 completed on 2025-12-02 (commit 9eb5bc4)
**Dependencies**: Issue #15 (defect/quality tracking) is COMPLETE

### Data Foundation Confirmed
Based on schema and recent commits:
- ✅ `BOMVersion.defectNotes` (String?, @db.Text) - line 208
- ✅ `BOMVersion.qualityMetadata` (Json) - line 209
- ✅ `Transaction.defectCount` (Int?) - line 145
- ✅ `Transaction.defectNotes` (String?, @db.Text) - line 146
- ✅ `Transaction.affectedUnits` (Int?) - line 147

All defect tracking infrastructure is in place and ready for analytics.

## Current State

### Database (Prisma Schema)
**Available Data Fields**:
- `BOMVersion` table (lines 199-219):
  - `defectNotes`: Text field for defect notes
  - `qualityMetadata`: JSON field for structured quality data
  - `skuId`: Links to SKU
  - `versionName`: Version identifier
  - `effectiveStartDate`, `effectiveEndDate`: Date range for version
  - `isActive`: Current active status

- `Transaction` table (lines 128-157):
  - `type`: TransactionType enum (receipt, build, adjustment, initial)
  - `date`: Transaction date (@db.Date)
  - `defectCount`: Number of defects
  - `defectNotes`: Text description of defects
  - `affectedUnits`: Number of units affected
  - `unitsBuild`: Total units built (for calculating defect rate)
  - `skuId`, `bomVersionId`: Links to SKU and BOM version
  - `salesChannel`: Sales channel information
  - `companyId`: Tenant scoping

**Key Relationships**:
- Transaction -> BOMVersion -> SKU (via bomVersionId and skuId)
- Transaction -> Company (via companyId for tenant scoping)

### API Routes
**Existing Routes**:
- ✅ `/home/pbrown/SkuInventory/src/app/api/dashboard/route.ts` - Dashboard data endpoint (pattern to follow)
- ✅ `/home/pbrown/SkuInventory/src/app/api/transactions/route.ts` - Transaction listing with filtering
- ✅ `/home/pbrown/SkuInventory/src/app/api/export/transactions/route.ts` - CSV export (includes defect fields)

**Missing Routes**:
- ❌ No analytics-specific API endpoint
- ❌ No defect aggregation queries

### Services
**Existing Services**:
- ✅ `/home/pbrown/SkuInventory/src/services/inventory.ts` - Has `createBuildTransaction()` with defect fields
- ✅ `/home/pbrown/SkuInventory/src/services/bom.ts` - BOM operations
- ✅ `/home/pbrown/SkuInventory/src/services/export.ts` - CSV export with defect columns

**Missing Services**:
- ❌ No analytics service for defect rate calculations
- ❌ No aggregation functions for defect trends

### Frontend Components
**Existing Dashboard Infrastructure**:
- ✅ `/home/pbrown/SkuInventory/src/app/(dashboard)/page.tsx` - Main dashboard page (pattern to follow)
- ✅ `/home/pbrown/SkuInventory/src/components/features/DashboardStats.tsx` - Stats display component
- ✅ `/home/pbrown/SkuInventory/src/components/ui/card.tsx` - Card UI component (shadcn/ui)
- ✅ `/home/pbrown/SkuInventory/src/components/ui/table.tsx` - Table UI component

**Missing Components**:
- ❌ No analytics dashboard page
- ❌ No chart components (recharts not installed)
- ❌ No defect rate visualization components

### TypeScript Types
**Existing Types**:
- ✅ `/home/pbrown/SkuInventory/src/types/transaction.ts` - Includes defectCount, defectNotes, affectedUnits
- ✅ `/home/pbrown/SkuInventory/src/types/bom.ts` - Includes defectNotes, qualityMetadata

**Missing Types**:
- ❌ No analytics-specific types (defect rate aggregations, trend data)

## Dependencies & Blockers

**Prerequisites Met**:
1. ✅ Issue #15 complete - defect tracking fields exist in database
2. ✅ Build transactions capture defect data
3. ✅ BOM versions store quality metadata
4. ✅ Export functionality includes defect fields
5. ✅ Tenant scoping implemented (companyId filtering)
6. ✅ Authentication and authorization in place

**Missing Dependencies**:
1. ❌ **Charting Library**: No charting library installed (recharts, chart.js, etc.)
   - Package.json shows no chart dependencies
   - Need to add recharts (recommended for React/Next.js projects)

**Blockers**: None - ready to proceed once charting library is added

**Can Proceed?**: YES (with charting library installation as first step)

## Complexity Assessment
**Complexity**: Moderate
**Effort**: 10-15 hours
**Risk**: Low-Medium

### Breakdown:
1. **Install Charting Library** (~0.5 hour): Add recharts to dependencies
2. **Analytics Service** (~3-4 hours):
   - Defect rate calculations
   - Trend aggregations by time period
   - BOM version comparisons
   - Correlation analysis
3. **API Route** (~2-3 hours):
   - New `/api/analytics/defects` endpoint
   - Query parameters for filtering (date range, SKU, BOM version)
   - Aggregation queries with Prisma
4. **Dashboard Page** (~3-4 hours):
   - New route: `/app/(dashboard)/analytics/defects/page.tsx`
   - Layout with filters and charts
   - Responsive design
5. **Chart Components** (~2-3 hours):
   - Defect rate over time (line chart)
   - Defect rate by BOM version (bar chart)
   - Correlation charts
6. **Export Functionality** (~1-2 hours):
   - CSV export for analytics data
   - Download button integration
7. **Testing** (~2 hours): Unit tests for analytics calculations

## Patterns to Follow

**Primary Reference - Dashboard Pattern**: `/home/pbrown/SkuInventory/src/app/(dashboard)/page.tsx`
- Dashboard route structure
- Data fetching pattern
- Stats display layout

**Secondary References**:

1. **API Route Pattern**: `/home/pbrown/SkuInventory/src/app/api/dashboard/route.ts`
   - Session authentication
   - Tenant scoping (companyId filtering)
   - Response formatting
   - Error handling

2. **Transaction Query Pattern**: `/home/pbrown/SkuInventory/src/app/api/transactions/route.ts`
   - Date filtering
   - Type filtering
   - Pagination (if needed)
   - Complex Prisma queries

3. **Export Pattern**: `/home/pbrown/SkuInventory/src/services/export.ts`
   - CSV generation
   - Column definitions
   - Data transformation

4. **Stats Component**: `/home/pbrown/SkuInventory/src/components/features/DashboardStats.tsx`
   - Card-based layout
   - Stat display pattern

5. **shadcn/ui Components**:
   - Card: `/home/pbrown/SkuInventory/src/components/ui/card.tsx`
   - Table: `/home/pbrown/SkuInventory/src/components/ui/table.tsx`
   - Button: `/home/pbrown/SkuInventory/src/components/ui/button.tsx`
   - Select: `/home/pbrown/SkuInventory/src/components/ui/select.tsx` (for filters)

## Files to Create/Modify

### Dependencies (1 file)
- **MODIFY**: `/home/pbrown/SkuInventory/package.json`
  - Add `recharts` library (~2.10.0 or latest)
  - Add `@types/recharts` if available

### Backend - Services (1 file to create)
- **CREATE**: `/home/pbrown/SkuInventory/src/services/analytics.ts`
  - `getDefectRateTrends()` - Calculate defect rates over time
  - `getDefectRatesByBOMVersion()` - Compare defect rates across BOM versions
  - `getDefectRatesBySkU()` - Defect rates grouped by SKU
  - `getDefectCorrelations()` - Correlation between BOM changes and defects
  - `exportDefectAnalytics()` - Generate CSV export data

### Backend - API Routes (1 file to create)
- **CREATE**: `/home/pbrown/SkuInventory/src/app/api/analytics/defects/route.ts`
  - GET handler with query parameters:
    - `dateFrom`, `dateTo` - Date range filtering
    - `skuId` - Filter by specific SKU
    - `bomVersionId` - Filter by BOM version
    - `salesChannel` - Filter by sales channel
  - Returns aggregated defect analytics data
  - Enforces tenant scoping via companyId

### Backend - Types (1 file to create)
- **CREATE**: `/home/pbrown/SkuInventory/src/types/analytics.ts`
  - `DefectRateTrend` interface (time series data)
  - `DefectRateByBOM` interface (BOM version comparison)
  - `DefectAnalyticsQuery` schema (Zod validation)
  - `DefectAnalyticsResponse` interface

### Frontend - Pages (1 file to create)
- **CREATE**: `/home/pbrown/SkuInventory/src/app/(dashboard)/analytics/defects/page.tsx`
  - Dashboard layout with filters
  - Chart display area
  - Export button
  - Loading states
  - Error handling

### Frontend - Components (3-4 files to create)
- **CREATE**: `/home/pbrown/SkuInventory/src/components/features/DefectAnalyticsDashboard.tsx`
  - Main analytics component
  - Integrates all charts and filters

- **CREATE**: `/home/pbrown/SkuInventory/src/components/features/DefectTrendChart.tsx`
  - Line chart for defect rate trends over time
  - Uses recharts LineChart

- **CREATE**: `/home/pbrown/SkuInventory/src/components/features/DefectBOMComparisonChart.tsx`
  - Bar chart comparing defect rates across BOM versions
  - Uses recharts BarChart

- **CREATE**: `/home/pbrown/SkuInventory/src/components/features/DefectAnalyticsFilters.tsx`
  - Date range picker
  - SKU selector
  - BOM version selector
  - Apply/Clear filters

### Navigation (1 file to modify)
- **MODIFY**: `/home/pbrown/SkuInventory/src/app/(dashboard)/layout.tsx`
  - Add "Analytics" navigation item
  - Link to `/analytics/defects`

## Final Sweep Results

**Comprehensive search for defect-related data**:

### Files Currently Using Defect Fields (14 files)
All files that read/write defect data:
1. `/home/pbrown/SkuInventory/src/app/api/export/transactions/route.ts` - Exports defect data
2. `/home/pbrown/SkuInventory/src/services/export.ts` - Defect export columns
3. `/home/pbrown/SkuInventory/src/components/features/TransactionDetail.tsx` - Displays defect info
4. `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx` - Captures defect data
5. `/home/pbrown/SkuInventory/src/components/features/BOMVersionList.tsx` - Shows BOM defect notes
6. `/home/pbrown/SkuInventory/src/components/features/BOMVersionForm.tsx` - Captures BOM quality data
7. `/home/pbrown/SkuInventory/src/services/bom.ts` - Stores BOM defect notes
8. `/home/pbrown/SkuInventory/src/app/api/transactions/[id]/route.ts` - Returns defect data
9. `/home/pbrown/SkuInventory/src/app/api/transactions/route.ts` - Lists transactions with defects
10. `/home/pbrown/SkuInventory/src/app/api/bom-versions/[id]/route.ts` - BOM defect CRUD
11. `/home/pbrown/SkuInventory/src/app/api/skus/[id]/bom-versions/route.ts` - BOM list with defects
12. `/home/pbrown/SkuInventory/src/services/inventory.ts` - Build transaction with defects
13. `/home/pbrown/SkuInventory/src/types/bom.ts` - BOM defect types
14. `/home/pbrown/SkuInventory/src/types/transaction.ts` - Transaction defect types

**No modifications needed** - these files already have defect data; analytics will READ from same data sources.

### Ripple Effect Analysis

**New Analytics Service**:
- Will QUERY Transaction and BOMVersion tables (read-only)
- NO changes to existing code required
- Self-contained aggregation logic

**New API Route**:
- Independent endpoint `/api/analytics/defects`
- Calls new analytics service
- NO modifications to existing API routes

**New Dashboard Page**:
- New route in app router
- NO modifications to existing pages
- Uses existing UI components (Card, Table, Button, Select)

**Navigation Update**:
- Minor change to layout.tsx to add menu item
- Non-breaking change

**Total New Files**: 8-9 files
**Total Modified Files**: 2 files (package.json, layout.tsx)

## UI Visibility Requirements

### Analytics Dashboard Visibility
**Element**: Defect Analytics Dashboard
**Location**:
  - Primary: Sidebar navigation (desktop)
  - Secondary: Header navigation or dashboard cards (mobile fallback)

**Visibility**: ALL devices (desktop, tablet, mobile)

**Implementation Notes**:
- Add "Analytics" to sidebar navigation (visible on desktop `lg:` breakpoint)
- Dashboard page itself should be responsive and work on all screen sizes
- Charts should resize responsively using recharts' ResponsiveContainer
- Filter controls should stack vertically on mobile

**CSS classes to avoid**:
- Do NOT use `lg:hidden` on navigation items (would hide on desktop)
- Do NOT use `hidden lg:block` on dashboard content (would hide on mobile)

**Recommended approach**:
- Make navigation item visible on all devices
- Use responsive chart containers that adapt to screen size
- Ensure filter controls are touch-friendly on mobile

## Acceptance Criteria

From Issue #46:

- [ ] Dashboard page showing defect rate trends over time
- [ ] Charts/graphs comparing defect rates across different BOM versions
- [ ] Correlation analysis between BOM changes and quality outcomes
- [ ] Filterable by date range, SKU, BOM version
- [ ] Export analytics data to CSV
- [ ] Optional: Defect rate alerts/thresholds with notifications

## Handoff to Plan Agent

**Summary**:
This feature builds a comprehensive analytics dashboard on top of the defect tracking infrastructure completed in Issue #15. All required data fields exist in the database (Transaction.defectCount, Transaction.defectNotes, Transaction.affectedUnits, BOMVersion.defectNotes, BOMVersion.qualityMetadata). The implementation requires creating new isolated components (analytics service, API route, dashboard page, chart components) with minimal modifications to existing code. The main new dependency is a charting library (recharts recommended for React/Next.js compatibility). This is a read-only analytics feature that aggregates existing data, making it low-risk with clear boundaries.

**Key Points**:
1. **Data Foundation Complete**: Issue #15 provided all necessary defect tracking fields
2. **Clear Isolation**: New analytics code is self-contained, minimal ripple effect
3. **One New Dependency**: Recharts library needed for visualizations
4. **Existing Patterns**: Dashboard, API route, and export patterns already established
5. **Tenant Scoping**: Must filter by companyId in all queries (existing pattern)
6. **Test Strategy**: TARGETED testing - focus on analytics calculations and aggregations

**Suggested Phases**:
1. **Phase 1 - Setup**: Install recharts, create types and schemas
2. **Phase 2 - Analytics Service**: Implement defect rate calculations and aggregations
3. **Phase 3 - API Route**: Create `/api/analytics/defects` endpoint
4. **Phase 4 - Chart Components**: Build individual chart components with recharts
5. **Phase 5 - Dashboard Page**: Assemble dashboard with filters and charts
6. **Phase 6 - Export**: Add CSV export for analytics data
7. **Phase 7 - Navigation**: Add analytics link to sidebar
8. **Phase 8 - Testing**: Unit tests for analytics calculations

**Implementation Strategy**:
- Use Prisma aggregation queries (groupBy, count, avg) for efficiency
- Calculate defect rate as: (defectCount / unitsBuild) * 100 for build transactions
- Filter only "build" type transactions for defect rate analysis
- Group by time periods (day, week, month) based on Transaction.date
- Compare BOM versions by aggregating defects across all builds using that version
- Ensure all queries include `companyId` filter for tenant isolation
- Use recharts ResponsiveContainer for mobile-friendly charts
- Follow existing dashboard page layout patterns

**Analytics Calculations Needed**:
1. **Defect Rate Trend**: GROUP BY date, calculate avg defect rate per time period
2. **BOM Comparison**: GROUP BY bomVersionId, calculate defect rate per version
3. **SKU Analysis**: GROUP BY skuId, calculate defect rate per SKU
4. **Correlation**: Compare defect rates before/after BOM version changes (using effectiveStartDate)

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Issue Parsing | 3m |
| Dependency Check (Issue #15) | 5m |
| Codebase Exploration | 18m |
| Data Model Analysis | 12m |
| Pattern Identification | 15m |
| Ripple Effect Analysis | 8m |
| UI/UX Considerations | 5m |
| Report Writing | 22m |
| **Total** | **88m** |

---

AGENT_RETURN: scout-46-120325
