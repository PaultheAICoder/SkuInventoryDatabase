# Implementation Plan

**Generated**: 2026-01-09
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #408
**Estimated Build Time**: 4-6 hours
**Complexity**: Medium (Tier 2)

---

## Investigation Summary

### Request Analysis
**Type**: Enhancement
**Source**: GitHub Issue #408
**Priority**: Medium

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="transaction"` or `--filter="photo"`

### Issue Validation
**Status**: Valid
**Related Issue**: #401 (Add photo upload capability for transactions) - CLOSED
**Recent Changes**: Issue #409 changed photo storage from AWS S3 to local filesystem

### Current State Assessment

**Existing Photo Infrastructure (from #401):**
- `TransactionPhoto` model in Prisma schema (lines 435-455)
- `TransactionPhotoUpload.tsx` - Upload component with drag/drop, validation, preview
- `TransactionPhotoGallery.tsx` - Display component with thumbnails, lightbox, delete
- `TransactionPhotoResponse` type in `src/types/transaction.ts` (lines 188-201)
- Photo API routes:
  - `POST /api/transactions/[id]/photos` - Upload photos
  - `GET /api/transactions/[id]/photos` - List photos
  - `DELETE /api/transactions/photos/[photoId]` - Delete photo
- Photo storage service in `src/services/photo-storage.ts`

**Files to Modify:**
1. `/src/components/features/QuickEntryForm.tsx` (1283 lines) - Add photo staging for build transactions
2. `/src/app/(dashboard)/transactions/[id]/edit/page.tsx` (919 lines) - Add photo display/management

**Integration Already Complete:**
- `TransactionDetail.tsx` already has photo gallery and upload (lines 567-606)

### Dependencies & Blockers
None - all dependencies are in place from #401

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Moderate
**Effort**: 4-6 hours
**Risk**: Low - reusing existing components with new integration patterns

### Patterns Identified

**Primary Pattern**: `src/components/features/TransactionDetail.tsx`
- Shows how `TransactionPhotoGallery` and `TransactionPhotoUpload` are integrated
- Shows photo state management (lines 147-171)
- Shows photo delete handler (lines 156-171)

**Secondary Pattern**: `src/components/features/TransactionPhotoUpload.tsx`
- Current design requires `transactionId` prop (line 10)
- Need to adapt for staging photos before transaction exists

### Ripple Effect Analysis
**Files Identified**: 2 primary files, no indirect callers affected

| File | Change Type | Impact |
|------|-------------|--------|
| `QuickEntryForm.tsx` | Add photo staging | Contained |
| `transactions/[id]/edit/page.tsx` | Add photo section | Contained |

---

## Executive Summary

This enhancement adds photo upload capability to two transaction entry points that were deferred from #401:

1. **QuickEntryForm (Build Transactions)**: Users can select photos locally during form entry. After the transaction is created successfully, photos are uploaded to the transaction. The success message shows photo count.

2. **Transaction Edit Page**: Displays existing photos using `TransactionPhotoGallery` and allows adding/deleting photos using existing components.

Both integrations reuse the existing photo components with minimal modifications.

---

## Phase 1: QuickEntryForm Photo Integration

### Design Approach

The key challenge is that `TransactionPhotoUpload` requires a `transactionId` to upload to, but in QuickEntryForm the transaction doesn't exist yet.

**Solution**: Create a local photo staging mechanism:
1. Collect files locally (reuse validation logic from TransactionPhotoUpload)
2. Store as FilePreview objects in local state
3. After transaction creation succeeds, upload photos to the new transaction ID
4. Show photo count in success message

### Subtask 1.1: Add Photo Staging State to QuickEntryForm

**File**: `/home/pbrown/SkuInventory/src/components/features/QuickEntryForm.tsx`

**Pattern**: Follow `TransactionPhotoUpload.tsx` file handling pattern (lines 18-66)

**Instructions**:
1. Add imports for photo handling:
```typescript
import { Upload, X, Camera } from 'lucide-react'
```

2. Add new state variables after existing state declarations (around line 165):
```typescript
// Photo staging for build transactions
const [stagedPhotos, setStagedPhotos] = useState<Array<{
  file: File
  preview: string
  caption: string
}>>([])
const [photoError, setPhotoError] = useState<string | null>(null)
```

3. Add file validation constants (copy from TransactionPhotoUpload):
```typescript
const MAX_PHOTO_SIZE = 10 * 1024 * 1024 // 10MB
const ALLOWED_PHOTO_TYPES = ['image/jpeg', 'image/png', 'image/webp', 'image/heic']
```

4. Add file handling functions (similar to TransactionPhotoUpload lines 38-117):
```typescript
const validatePhotoFile = (file: File): string | null => {
  if (file.size > MAX_PHOTO_SIZE) {
    return `File "${file.name}" is too large. Maximum size is 10MB.`
  }
  if (!ALLOWED_PHOTO_TYPES.includes(file.type)) {
    return `File "${file.name}" has an invalid type. Allowed: JPEG, PNG, WebP, HEIC.`
  }
  return null
}

const handlePhotoSelect = (files: FileList | null) => {
  if (!files) return
  const fileArray = Array.from(files)
  const newPhotos: typeof stagedPhotos = []

  for (const file of fileArray) {
    const error = validatePhotoFile(file)
    if (error) {
      setPhotoError(error)
      continue
    }
    newPhotos.push({
      file,
      preview: URL.createObjectURL(file),
      caption: '',
    })
  }

  setStagedPhotos(prev => [...prev, ...newPhotos])
  setPhotoError(null)
}

const removeStagedPhoto = (index: number) => {
  setStagedPhotos(prev => {
    const updated = [...prev]
    URL.revokeObjectURL(updated[index].preview)
    updated.splice(index, 1)
    return updated
  })
}

const updatePhotoCaption = (index: number, caption: string) => {
  setStagedPhotos(prev => {
    const updated = [...prev]
    updated[index] = { ...updated[index], caption }
    return updated
  })
}
```

**Completion Criteria**:
- [ ] New state variables added
- [ ] File validation function works
- [ ] Photo select/remove/caption functions implemented
- [ ] No TypeScript errors

### Subtask 1.2: Add Photo Upload Function for Post-Transaction Upload

**File**: `/home/pbrown/SkuInventory/src/components/features/QuickEntryForm.tsx`

**Instructions**:
1. Add function to upload staged photos after transaction creation:
```typescript
const uploadStagedPhotos = async (transactionId: string): Promise<number> => {
  let uploadedCount = 0

  for (const { file, caption } of stagedPhotos) {
    try {
      const formData = new FormData()
      formData.append('file', file)
      if (caption) {
        formData.append('caption', caption)
      }

      const response = await fetch(`/api/transactions/${transactionId}/photos`, {
        method: 'POST',
        body: formData,
      })

      if (response.ok) {
        uploadedCount++
      }
    } catch (err) {
      console.error('Failed to upload photo:', err)
    }
  }

  // Clean up preview URLs
  stagedPhotos.forEach(p => URL.revokeObjectURL(p.preview))
  setStagedPhotos([])

  return uploadedCount
}
```

**Completion Criteria**:
- [ ] Function uploads photos sequentially
- [ ] Function cleans up preview URLs
- [ ] Function returns count of successfully uploaded photos

### Subtask 1.3: Integrate Photo Upload into Form Submission

**File**: `/home/pbrown/SkuInventory/src/components/features/QuickEntryForm.tsx`

**Instructions**:
1. Modify the `handleSubmit` function (around line 342) to upload photos after successful build transaction creation.

2. After the transaction is successfully created (around line 505), before setting success message:
```typescript
// Upload staged photos if this was a build transaction
let photoCount = 0
if (transactionType === 'build' && stagedPhotos.length > 0 && data?.id) {
  photoCount = await uploadStagedPhotos(data.id)
}
```

3. Update success message for build transactions (around line 496) to include photo count:
```typescript
} else if (transactionType === 'build') {
  const buildableSkus = skus.filter((s) => s.hasActiveBom)
  const sku = buildableSkus.find((s) => s.id === buildFormData.skuId)
  const photoText = photoCount > 0 ? ` with ${photoCount} photo${photoCount !== 1 ? 's' : ''}` : ''
  successText = isDraft
    ? `Draft saved: Build ${buildFormData.unitsToBuild} x ${sku?.name || 'SKU'}`
    : `Build recorded: ${buildFormData.unitsToBuild} x ${sku?.name || 'SKU'}${photoText}`
}
```

**Completion Criteria**:
- [ ] Photos uploaded after successful build transaction
- [ ] Success message shows photo count
- [ ] Staged photos cleared after upload

### Subtask 1.4: Add Photo UI Section to Build Form

**File**: `/home/pbrown/SkuInventory/src/components/features/QuickEntryForm.tsx`

**Instructions**:
1. Add photo section inside the build form fields (after the Notes field, around line 1234):
```tsx
{/* Photos Section for Build Transactions */}
<div className="grid grid-cols-4 items-start gap-4">
  <Label className="text-right pt-2">
    <Camera className="h-4 w-4 inline mr-1" />
    Photos
  </Label>
  <div className="col-span-3 space-y-3">
    {photoError && (
      <div className="rounded-md bg-destructive/10 p-2 text-sm text-destructive">
        {photoError}
      </div>
    )}

    {/* Photo preview grid */}
    {stagedPhotos.length > 0 && (
      <div className="grid grid-cols-3 gap-2">
        {stagedPhotos.map((photo, index) => (
          <div key={index} className="relative group">
            <img
              src={photo.preview}
              alt={`Preview ${index + 1}`}
              className="w-full aspect-square object-cover rounded border"
            />
            <button
              type="button"
              onClick={() => removeStagedPhoto(index)}
              className="absolute top-1 right-1 p-1 bg-destructive text-destructive-foreground rounded-full opacity-0 group-hover:opacity-100 transition-opacity"
            >
              <X className="h-3 w-3" />
            </button>
            <Input
              placeholder="Caption (optional)"
              value={photo.caption}
              onChange={(e) => updatePhotoCaption(index, e.target.value)}
              className="mt-1 text-xs"
            />
          </div>
        ))}
      </div>
    )}

    {/* Add photos button */}
    <div>
      <input
        type="file"
        id="build-photos"
        multiple
        accept={ALLOWED_PHOTO_TYPES.join(',')}
        onChange={(e) => handlePhotoSelect(e.target.files)}
        className="hidden"
      />
      <Button
        type="button"
        variant="outline"
        size="sm"
        onClick={() => document.getElementById('build-photos')?.click()}
      >
        <Upload className="h-4 w-4 mr-2" />
        {stagedPhotos.length > 0 ? 'Add More Photos' : 'Add Photos'}
      </Button>
      <p className="text-xs text-muted-foreground mt-1">
        JPEG, PNG, WebP, or HEIC. Max 10MB per file.
      </p>
    </div>
  </div>
</div>
```

**Completion Criteria**:
- [ ] Photo section appears in build form
- [ ] Can select multiple photos
- [ ] Photos display with previews
- [ ] Can remove photos
- [ ] Can add captions

### Subtask 1.5: Clear Staged Photos on Form Reset

**File**: `/home/pbrown/SkuInventory/src/components/features/QuickEntryForm.tsx`

**Instructions**:
1. In `handleRecordAnother` function (around line 515), add cleanup for build transactions:
```typescript
} else if (transactionType === 'build') {
  setBuildFormData({
    date: today,
    skuId: '',
    unitsToBuild: '',
    salesChannel: buildFormData.salesChannel, // Keep sales channel
    locationId: '',
    notes: '',
  })
  setInsufficientItems([])
  setShowBuildWarning(false)
  // Clear staged photos
  stagedPhotos.forEach(p => URL.revokeObjectURL(p.preview))
  setStagedPhotos([])
  setPhotoError(null)
}
```

2. Also add cleanup in `handleTypeChange` when switching away from build (around line 568):
```typescript
const handleTypeChange = (type: TransactionTypeValue) => {
  setTransactionType(type)
  setSuccessMessage(null)
  setError(null)
  // Clear staged photos when changing transaction type
  if (stagedPhotos.length > 0) {
    stagedPhotos.forEach(p => URL.revokeObjectURL(p.preview))
    setStagedPhotos([])
    setPhotoError(null)
  }
}
```

**Completion Criteria**:
- [ ] Staged photos cleared on Record Another
- [ ] Staged photos cleared on transaction type change
- [ ] No memory leaks from preview URLs

---

## Phase 2: Transaction Edit Page Photo Integration

### Subtask 2.1: Add Photo State and Imports

**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/transactions/[id]/edit/page.tsx`

**Instructions**:
1. Add imports at the top of the file:
```typescript
import { TransactionPhotoGallery } from '@/components/features/TransactionPhotoGallery'
import { TransactionPhotoUpload } from '@/components/features/TransactionPhotoUpload'
import type { TransactionPhotoResponse } from '@/types/transaction'
import { Camera } from 'lucide-react'
```

2. Add photo state after other state declarations (around line 67):
```typescript
// Photo state
const [photos, setPhotos] = useState<TransactionPhotoResponse[]>([])
const [isLoadingPhotos, setIsLoadingPhotos] = useState(false)
const [photoError, setPhotoError] = useState<string | null>(null)
```

**Completion Criteria**:
- [ ] Imports added
- [ ] State variables declared
- [ ] No TypeScript errors

### Subtask 2.2: Add Photo Fetch Function

**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/transactions/[id]/edit/page.tsx`

**Instructions**:
1. Add photo fetch function (after `fetchReferenceData`, around line 96):
```typescript
const fetchPhotos = useCallback(async () => {
  setIsLoadingPhotos(true)
  try {
    const res = await fetch(`/api/transactions/${id}/photos`)
    if (res.ok) {
      const data = await res.json()
      setPhotos(data.data || [])
    }
  } catch (err) {
    console.error('Failed to fetch photos:', err)
  } finally {
    setIsLoadingPhotos(false)
  }
}, [id])
```

2. Call fetch in useEffect (around line 121, after `fetchReferenceData()`):
```typescript
fetchPhotos()
```

**Completion Criteria**:
- [ ] Photos fetched on page load
- [ ] Loading state managed
- [ ] Error handling in place

### Subtask 2.3: Add Photo Event Handlers

**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/transactions/[id]/edit/page.tsx`

**Instructions**:
1. Add handler functions (after `handleInputChange`, around line 203):
```typescript
const handlePhotoUploaded = useCallback((photo: TransactionPhotoResponse) => {
  setPhotos((prev) => [...prev, photo])
  setPhotoError(null)
}, [])

const handlePhotoDelete = useCallback(async (photoId: string) => {
  try {
    const res = await fetch(`/api/transactions/photos/${photoId}`, {
      method: 'DELETE',
    })

    if (!res.ok) {
      const data = await res.json().catch(() => ({}))
      throw new Error(data?.message || 'Failed to delete photo')
    }

    setPhotos((prev) => prev.filter((p) => p.id !== photoId))
  } catch (error) {
    setPhotoError(error instanceof Error ? error.message : 'Failed to delete photo')
  }
}, [])
```

**Completion Criteria**:
- [ ] Upload handler adds photo to state
- [ ] Delete handler removes photo from state
- [ ] Error handling in place

### Subtask 2.4: Add Photos Card to Edit Form UI

**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/transactions/[id]/edit/page.tsx`

**Instructions**:
1. Add a new Card section after the main form Card (around line 914, before closing `</div>` of the page):
```tsx
{/* Photos Section */}
<Card className="mt-6">
  <CardHeader>
    <CardTitle className="flex items-center gap-2">
      <Camera className="h-5 w-5" />
      Photos
    </CardTitle>
    <CardDescription>
      {photos.length === 0
        ? 'No photos attached to this transaction'
        : `${photos.length} photo${photos.length !== 1 ? 's' : ''} attached`}
    </CardDescription>
  </CardHeader>
  <CardContent className="space-y-4">
    {photoError && (
      <div className="rounded-md bg-destructive/10 p-3 text-sm text-destructive">
        {photoError}
      </div>
    )}

    {/* Photo Gallery */}
    <TransactionPhotoGallery
      photos={photos}
      canDelete={true}
      onDelete={handlePhotoDelete}
      loading={isLoadingPhotos}
    />

    {/* Upload Section */}
    <div className="pt-4 border-t">
      <h4 className="text-sm font-medium mb-3">Add Photos</h4>
      <TransactionPhotoUpload
        transactionId={id}
        onUploadComplete={handlePhotoUploaded}
        onError={setPhotoError}
      />
    </div>
  </CardContent>
</Card>
```

**Completion Criteria**:
- [ ] Photos Card displays after main form
- [ ] Gallery shows existing photos
- [ ] Upload component allows adding photos
- [ ] Delete functionality works
- [ ] Loading state shows spinner

---

## Phase 3: Validation

### Subtask 3.1: TypeScript and Build Verification

**Instructions**:
1. Run TypeScript check:
```bash
cd /home/pbrown/SkuInventory && npx tsc --noEmit
```

2. Run build:
```bash
cd /home/pbrown/SkuInventory && npm run build
```

3. Run lint:
```bash
cd /home/pbrown/SkuInventory && npm run lint
```

**Completion Criteria**:
- [ ] TypeScript check passes
- [ ] Build succeeds
- [ ] Lint passes (no errors)

### Subtask 3.2: Manual Testing Checklist

**Test Environment**: http://172.16.20.50:2345

**QuickEntryForm Tests**:
- [ ] Navigate to /transactions/new
- [ ] Select "Build" transaction type
- [ ] Photo section appears in form
- [ ] Can select multiple photos
- [ ] Photos display with previews
- [ ] Can remove individual photos
- [ ] Can add captions to photos
- [ ] Create build transaction
- [ ] Success message shows photo count
- [ ] Photos appear on transaction detail page
- [ ] "Record Another" clears staged photos

**Transaction Edit Page Tests**:
- [ ] Navigate to existing transaction edit page
- [ ] Photos Card appears below main form
- [ ] Existing photos display in gallery
- [ ] Can view photo in lightbox
- [ ] Can delete existing photos
- [ ] Can upload new photos
- [ ] New photos appear immediately in gallery

**Completion Criteria**:
- [ ] All QuickEntryForm tests pass
- [ ] All Transaction Edit tests pass

---

## Summary of Deliverables

**Files Created**: 0
**Files Modified**: 2

| File | Lines Added (est.) | Change Summary |
|------|-------------------|----------------|
| `src/components/features/QuickEntryForm.tsx` | ~120 | Photo staging, upload after creation, UI section |
| `src/app/(dashboard)/transactions/[id]/edit/page.tsx` | ~80 | Photo fetch/display, add/delete handlers, UI card |

## Technical Notes

1. **Photo Staging Pattern**: QuickEntryForm uses local staging because transaction ID doesn't exist during form entry. Photos are uploaded after successful transaction creation.

2. **Reusing Existing Components**: Both integrations reuse `TransactionPhotoGallery` and `TransactionPhotoUpload` (edit page only) to maintain consistency.

3. **Memory Management**: All preview URLs (created with `URL.createObjectURL`) must be revoked when no longer needed to prevent memory leaks.

4. **Error Handling**: Photo upload errors don't fail the transaction - the transaction is created first, then photos are uploaded. Partial upload failures are logged but don't block success.

---

## Performance Metrics

| Phase | Duration |
|-------|----------|
| Investigation | 12m |
| Validation | 3m |
| Planning | 10m |
| **Total** | **25m** |
