# Implementation Plan
**Generated**: 2025-12-10T22:50:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #257
**Estimated Build Time**: 2-3 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Bug Fix (Follow-up to #245)
**Source**: GitHub Issue #257
**Priority**: Medium (affects user experience - display issue)

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="date"` (run date-related tests)

### Issue Validation
**Status**: Valid - incomplete fix from #245
**Recent Changes**:
- Commit `ef861d8` fixed date PARSING (input side) for form-based entry
- The fix did NOT address date DISPLAY (output side)

### Root Cause Analysis (Complete)

**The Bug (from user's perspective)**: User selects 12/8/25 in the form, then sees 12/7/25 in the transaction list.

**The Truth**: The database correctly stores 12/8/25. The BUG is in the **display** code, not the input code.

**Root Cause #1 (Fixed in #245)**: Input parsing with `z.coerce.date()` caused wrong dates to be stored.
- **Status**: FIXED

**Root Cause #2 (THIS ISSUE)**: Date display using `new Date(dateString).toLocaleDateString()` shows wrong date.
- **Status**: NOT FIXED - THIS IS THE ISSUE

**Technical Explanation**:

When displaying dates:
```typescript
// tx.date comes from API as "2025-12-08" (just the date, no time)
new Date("2025-12-08").toLocaleDateString()
```

On a server in UTC, this works correctly. But when the code runs in the **browser** (client-side), the user's local timezone applies:
- `new Date("2025-12-08")` = December 8, 2025 00:00:00 **UTC**
- In Pacific Time (UTC-8), UTC midnight is Dec 7, 4:00 PM **local time**
- `.toLocaleDateString()` shows "12/7/2025" (the local date)

**The Fix**:
Create a `formatDateString()` helper that parses date-only strings as local dates before formatting:
```typescript
export function formatDateString(dateStr: string, options?: Intl.DateTimeFormatOptions): string {
  // Append T00:00:00 to force local timezone interpretation
  const localDate = dateStr.includes('T') ? new Date(dateStr) : new Date(`${dateStr}T00:00:00`)
  return localDate.toLocaleDateString('en-US', options)
}
```

### Current State Assessment

**Data in Database**: CORRECT (dates are stored properly after #245 fix)
**Display in UI**: INCORRECT (off by -1 day for users west of UTC)

### Dependencies & Blockers
None - this is a surgical fix with clear pattern.

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Simple (pattern replacement across multiple files)
**Effort**: 2-3 hours
**Risk**: Low (display-only change, no database modifications)

### Patterns Identified
**Primary Reference**: `src/lib/utils.ts:parseLocalDate()` - same fix concept, different direction
**Secondary Reference**: Existing date formatting in various components

### Ripple Effect Analysis
**Files Identified**: 19 files with date display issues

**Display occurrences by file**:
1. `src/app/(dashboard)/page.tsx:199` - Dashboard recent transactions
2. `src/app/(dashboard)/skus/[id]/page.tsx:238,239,284` - SKU detail dates
3. `src/app/(dashboard)/lots/[id]/page.tsx:205,211,262` - Lot detail dates
4. `src/app/(dashboard)/components/[id]/page.tsx:356` - Component transaction history
5. `src/app/(dashboard)/transactions/page.tsx:359` - Transaction list
6. `src/components/features/TransactionDetail.tsx:186,450` - Transaction detail view
7. `src/components/features/DraftTransactionList.tsx:181` - Draft transaction dates
8. `src/components/features/DraftTransactionCard.tsx:93` - Draft card dates
9. `src/components/features/ForecastTable.tsx:66` - Forecast dates
10. `src/components/features/LotTable.tsx:258` - Lot expiry dates
11. `src/components/features/ParsedTransactionPreview.tsx:61` - AI parsed preview
12. `src/components/features/ComponentSparkline.tsx:29` - Tooltip dates
13. `src/components/features/ChatMessage.tsx:48` - Chat timestamps
14. `src/components/features/UserTable.tsx:158` - User last login
15. `src/components/features/CompanyTable.tsx:116` - Company created at
16. `src/components/features/DefectTrendChart.tsx:23` - Chart dates
17. `src/_deferred/shopify/components/OrderReviewTable.tsx:179` - Shopify orders
18. `src/_deferred/shopify/components/OrderDetail.tsx:160` - Shopify order detail

**Note**: Some of these (createdAt, updatedAt, lastLoginAt) have full timestamps and may work correctly. The critical ones are those displaying date-only strings (transaction dates, expiry dates).

---

## Executive Summary

Issue #245's fix was incomplete. It correctly addressed **input** parsing (storing dates), but did not address **output** formatting (displaying dates). Users in timezones west of UTC see dates shifted -1 day when viewing transactions. The fix is to create a `formatDateString()` helper and use it consistently across all date displays.

## Phase 1: Create Date Display Utility

### Subtask 1.1: Add formatDateString Helper Function
**File**: `/home/pbrown/SkuInventory/src/lib/utils.ts`
**Pattern**: Follow existing `parseLocalDate()` in same file
**Instructions**:
1. Add a new function `formatDateString(dateStr: string, options?: Intl.DateTimeFormatOptions): string`
2. If input contains 'T' (full ISO timestamp), parse directly
3. If input is date-only (YYYY-MM-DD), append `T00:00:00` before parsing
4. Return formatted date using `toLocaleDateString('en-US', options)`

```typescript
/**
 * Format a date string for display, ensuring correct timezone interpretation.
 *
 * IMPORTANT: JavaScript's new Date("YYYY-MM-DD") parses as UTC midnight,
 * which can shift the date by -1 day for users west of UTC when displayed.
 * By appending "T00:00:00", we force local timezone interpretation.
 *
 * @param dateStr - Date string (YYYY-MM-DD or ISO timestamp)
 * @param options - Intl.DateTimeFormatOptions for formatting
 * @returns Formatted date string in user's locale
 */
export function formatDateString(
  dateStr: string,
  options?: Intl.DateTimeFormatOptions
): string {
  // If no time component, append T00:00:00 to force local timezone
  const dateString = dateStr.includes('T') ? dateStr : `${dateStr}T00:00:00`
  const date = new Date(dateString)
  return date.toLocaleDateString('en-US', options)
}
```

**Completion Criteria**:
- [ ] Function added to `src/lib/utils.ts`
- [ ] TypeScript compiles: `npx tsc --noEmit`
- [ ] JSDoc comment explains the timezone issue

## Phase 2: Update Critical Transaction Dates

These are the most visible and critical date displays affecting the user's reported issue.

### Subtask 2.1: Update Transaction List Page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/transactions/page.tsx`
**Line**: 359
**Instructions**:
1. Add import at top: `import { formatDateString } from '@/lib/utils'`
2. Replace:
```typescript
{new Date(tx.date).toLocaleDateString()}
```
With:
```typescript
{formatDateString(tx.date)}
```

**Completion Criteria**:
- [ ] Import added
- [ ] Line 359 updated
- [ ] TypeScript compiles

### Subtask 2.2: Update Transaction Detail Component
**File**: `/home/pbrown/SkuInventory/src/components/features/TransactionDetail.tsx`
**Lines**: 186, 450
**Instructions**:
1. Add import at top: `import { formatDateString } from '@/lib/utils'`
2. Replace both occurrences of:
```typescript
{new Date(transaction.date).toLocaleDateString()}
```
With:
```typescript
{formatDateString(transaction.date)}
```

**Completion Criteria**:
- [ ] Import added
- [ ] Lines 186 and 450 updated
- [ ] TypeScript compiles

### Subtask 2.3: Update Dashboard Page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/page.tsx`
**Line**: 199
**Instructions**:
1. Add import at top: `import { formatDateString } from '@/lib/utils'`
2. Replace:
```typescript
{new Date(tx.date).toLocaleDateString()}
```
With:
```typescript
{formatDateString(tx.date)}
```

**Completion Criteria**:
- [ ] Import added
- [ ] Line 199 updated
- [ ] TypeScript compiles

### Subtask 2.4: Update SKU Detail Page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/page.tsx`
**Lines**: 238, 239, 284
**Instructions**:
1. Add import at top: `import { formatDateString } from '@/lib/utils'`
2. Line 238 (createdAt - this is a timestamp, may keep as-is or update)
3. Line 239 (updatedAt - this is a timestamp, may keep as-is or update)
4. Line 284 - Replace:
```typescript
{new Date(tx.date).toLocaleDateString()}
```
With:
```typescript
{formatDateString(tx.date)}
```

Note: createdAt and updatedAt are full timestamps with timezone info (ISO format with Z suffix), so they should display correctly. Only transaction dates (line 284) need the fix.

**Completion Criteria**:
- [ ] Import added
- [ ] Line 284 updated
- [ ] TypeScript compiles

### Subtask 2.5: Update Component Detail Page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/components/[id]/page.tsx`
**Line**: 356
**Instructions**:
1. Add import at top: `import { formatDateString } from '@/lib/utils'`
2. Replace:
```typescript
{new Date(tx.date).toLocaleDateString()}
```
With:
```typescript
{formatDateString(tx.date)}
```

**Completion Criteria**:
- [ ] Import added
- [ ] Line 356 updated
- [ ] TypeScript compiles

## Phase 3: Update Lot-Related Date Displays

### Subtask 3.1: Update Lot Detail Page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/lots/[id]/page.tsx`
**Lines**: 205 (createdAt), 211 (expiryDate), 262 (tx.date)
**Instructions**:
1. Add import at top: `import { formatDateString } from '@/lib/utils'`
2. Line 211 - Replace expiry date display to use `formatDateString`
3. Line 262 - Replace transaction date display to use `formatDateString`

Note: Line 205 is createdAt (full timestamp), which may be fine as-is.

**Completion Criteria**:
- [ ] Import added
- [ ] Lines 211, 262 updated
- [ ] TypeScript compiles

### Subtask 3.2: Update Lot Table Component
**File**: `/home/pbrown/SkuInventory/src/components/features/LotTable.tsx`
**Line**: 258
**Instructions**:
1. Add import at top: `import { formatDateString } from '@/lib/utils'`
2. Replace:
```typescript
{lot.expiryDate ? new Date(lot.expiryDate).toLocaleDateString() : '-'}
```
With:
```typescript
{lot.expiryDate ? formatDateString(lot.expiryDate) : '-'}
```

**Completion Criteria**:
- [ ] Import added
- [ ] Line 258 updated
- [ ] TypeScript compiles

## Phase 4: Update Draft and Forecast Components

### Subtask 4.1: Update Draft Transaction List
**File**: `/home/pbrown/SkuInventory/src/components/features/DraftTransactionList.tsx`
**Line**: ~181 (check exact line)
**Instructions**:
1. Add import at top: `import { formatDateString } from '@/lib/utils'`
2. Replace the date formatting function to use `formatDateString`

Note: This file already has a helper function `formatDate` - update it to use the same logic.

**Completion Criteria**:
- [ ] Import added or function updated
- [ ] Date display fixed
- [ ] TypeScript compiles

### Subtask 4.2: Update Draft Transaction Card
**File**: `/home/pbrown/SkuInventory/src/components/features/DraftTransactionCard.tsx`
**Line**: ~93
**Instructions**:
1. Add import at top: `import { formatDateString } from '@/lib/utils'`
2. Replace the date formatting function to use `formatDateString`

**Completion Criteria**:
- [ ] Import added or function updated
- [ ] Date display fixed
- [ ] TypeScript compiles

### Subtask 4.3: Update Forecast Table
**File**: `/home/pbrown/SkuInventory/src/components/features/ForecastTable.tsx`
**Line**: 66
**Instructions**:
1. Add import at top: `import { formatDateString } from '@/lib/utils'`
2. Replace the date formatting to use `formatDateString`

**Completion Criteria**:
- [ ] Import added
- [ ] Line 66 updated
- [ ] TypeScript compiles

## Phase 5: Update Other Components

### Subtask 5.1: Update Parsed Transaction Preview
**File**: `/home/pbrown/SkuInventory/src/components/features/ParsedTransactionPreview.tsx`
**Line**: ~61
**Instructions**:
1. Add import at top: `import { formatDateString } from '@/lib/utils'`
2. Update the `formatDate` helper function to use the same timezone-safe logic

**Completion Criteria**:
- [ ] Function updated
- [ ] TypeScript compiles

### Subtask 5.2: Update Component Sparkline
**File**: `/home/pbrown/SkuInventory/src/components/features/ComponentSparkline.tsx`
**Line**: 29
**Instructions**:
1. Add import at top: `import { formatDateString } from '@/lib/utils'`
2. Replace:
```typescript
{new Date(data.date).toLocaleDateString()}
```
With:
```typescript
{formatDateString(data.date)}
```

**Completion Criteria**:
- [ ] Import added
- [ ] Line 29 updated
- [ ] TypeScript compiles

### Subtask 5.3: Update Defect Trend Chart
**File**: `/home/pbrown/SkuInventory/src/components/features/DefectTrendChart.tsx`
**Line**: 23
**Instructions**:
1. Add import at top: `import { formatDateString } from '@/lib/utils'`
2. Update the date parsing to use timezone-safe approach

**Completion Criteria**:
- [ ] Import added
- [ ] Line 23 updated
- [ ] TypeScript compiles

## Phase 6: Update Tests and Verification

### Subtask 6.1: Add Unit Tests for formatDateString
**File**: `/home/pbrown/SkuInventory/tests/unit/date-utils.test.ts` (existing file)
**Pattern**: Follow existing tests in this file
**Instructions**:
Add tests for the new `formatDateString` function:

```typescript
describe('formatDateString', () => {
  it('should format date-only string without timezone shift', () => {
    // This is the key test - regardless of machine timezone,
    // "2025-12-08" should format to show December 8
    const result = formatDateString('2025-12-08')
    expect(result).toContain('12')  // Month
    expect(result).toContain('8')   // Day (not 7!)
    expect(result).toContain('2025') // Year
  })

  it('should handle ISO timestamp correctly', () => {
    const result = formatDateString('2025-12-08T14:30:00.000Z')
    expect(result).toBeDefined()
  })

  it('should accept formatting options', () => {
    const result = formatDateString('2025-12-08', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    })
    expect(result).toContain('Dec')
    expect(result).toContain('8')
    expect(result).toContain('2025')
  })
})
```

**Completion Criteria**:
- [ ] Tests added
- [ ] Tests pass: `npm test -- tests/unit/date-utils.test.ts`

### Subtask 6.2: Build Verification
**Instructions**:
1. Run TypeScript compiler: `npx tsc --noEmit`
2. Run build: `npm run build`
3. Run linter: `npm run lint`

**Completion Criteria**:
- [ ] No TypeScript errors
- [ ] Build succeeds
- [ ] No new lint warnings

### Subtask 6.3: Docker Container Rebuild
**Instructions**:
1. Rebuild Docker container: `cd docker && docker compose up -d --build inventory-app`
2. Verify container is healthy: `docker ps`
3. Check container logs for errors: `docker logs inventory-app --tail 50`

**Completion Criteria**:
- [ ] Container rebuilt successfully
- [ ] Container shows "healthy" status
- [ ] No errors in logs

---

## Summary of Deliverables

**Files Created**: 0
**Files Modified**:
- 1 utility file (add formatDateString)
- ~15 UI files (update date display calls)
- 1 test file (add new tests)

**Total Occurrences to Fix**: ~24 date display calls across 15+ files

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 -> Phase 2 -> ... -> Phase 6)
2. Run `npx tsc --noEmit` after each file modification
3. The fix pattern is consistent - add import, replace `new Date().toLocaleDateString()` with `formatDateString()`
4. Pay attention to files that have their own `formatDate` helper - update those helpers to use the same logic

## Test Strategy Note

- Use Vitest for unit tests (project standard)
- Test filter: `npm test -- --filter="date"`
- Key test: `formatDateString("2025-12-08")` must show "8" (not "7") in all timezones

## Performance Metrics
| Phase | Estimated Duration |
|-------|----------|
| Investigation | 30m |
| Validation | 10m |
| Planning | 15m |
| **Total** | **55m** |

---

## Related Issues
- **Issue #217**: Date bug in natural language parser (fixed in `transaction-parser.ts`)
- **Issue #245**: Date bug in form entry (fixed in Zod schemas) - INCOMPLETE
- **Issue #257**: This issue - date bug in display (NOT FIXED YET)

## Key Insight

The #245 fix was correct for **input** but missed the **output** side:
- Input: `"2025-12-08"` -> `parseLocalDate()` -> `Date` (stored correctly)
- Output: `"2025-12-08"` -> `new Date()` -> `.toLocaleDateString()` -> "12/7/2025" (WRONG!)

The data is correct in the database. Only the display is wrong.

## References
- Fix pattern: `/home/pbrown/SkuInventory/src/lib/utils.ts:parseLocalDate`
- Test pattern: `/home/pbrown/SkuInventory/tests/unit/date-utils.test.ts`
- MDN Date docs: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date/Date#date_string
