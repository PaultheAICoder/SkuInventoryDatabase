# Implementation Plan
**Generated**: 2026-01-08
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #401
**Estimated Build Time**: 10-14 hours
**Complexity**: High (Tier 3)

---

## Investigation Summary

### Request Analysis
**Type**: Feature
**Source**: GitHub Issue #401 - Add photo upload capability for transactions
**Priority**: P2

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="transaction|photo|upload"`

### Issue Validation
**Status**: Valid
**Recent Changes**: Multiple transaction-related commits in last 60 days (draft workflow, soft deletes, edit capability). No photo-related work.

### Current State Assessment

**Existing Transaction Model** (`prisma/schema.prisma` lines 328-390):
- Transaction model has standard fields: id, companyId, type, date, notes, etc.
- No photo/image fields currently exist
- TransactionLine for line items already exists
- No TransactionPhoto model

**Existing File Upload Pattern** (`src/app/api/csv/upload/route.ts`):
- Uses Next.js native `request.formData()` for multipart uploads
- Validates file size and type
- Creates SyncLog for tracking
- Pattern available for photo upload adaptation

**Cloud Storage**:
- No AWS S3 SDK installed (`@aws-sdk/client-s3` NOT in package.json)
- AWS credentials exist in `.env.example` for SP-API (`AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`)
- `aws4` package installed (for API signing only)

**UI Components**:
- TransactionDetail.tsx displays transaction info (lines 162-549)
- QuickEntryForm.tsx handles transaction creation (1225 lines)
- Edit page at `src/app/(dashboard)/transactions/[id]/edit/page.tsx`
- No image upload components exist currently

### Dependencies & Blockers

1. **BLOCKER - Cloud Storage**: AWS S3 SDK not installed. Need `@aws-sdk/client-s3` package.
2. **DEPENDENCY - S3 Bucket**: Requires S3 bucket configuration (bucket name, region in env vars)
3. **DEPENDENCY - Image Compression**: Consider `sharp` package for server-side compression

**Can Proceed?**: YES WITH FIXES (Install S3 SDK, configure bucket)

### Complexity Assessment
**Complexity**: Complex (Tier 3)
**Effort**: 10-14 hours
**Risk**: Medium - New feature with external dependency (S3), multiple UI integration points

### Patterns Identified

**Primary**: `src/app/api/csv/upload/route.ts` - File upload handling pattern
- Uses `request.formData()` for multipart
- File validation (size, type)
- Auth check with `getServerSession`

**Secondary**: `src/components/features/TransactionDetail.tsx` - Display pattern
- Card-based layout with sections
- Responsive grid display

**UI Reference**: `src/components/integrations/csv-upload.tsx` - Upload component pattern (if exists)

### Ripple Effect Analysis
**Files Identified**: 12-15

**Core Changes Required**:
- `prisma/schema.prisma` - Add TransactionPhoto model
- `src/types/transaction.ts` - Add photo types
- `src/app/api/transactions/photos/route.ts` - NEW: Upload endpoint
- `src/app/api/transactions/[id]/photos/route.ts` - NEW: Per-transaction photos
- `src/services/photo-storage.ts` - NEW: S3 service layer
- `src/components/features/TransactionDetail.tsx` - Add photo gallery section
- `src/components/features/TransactionPhotoUpload.tsx` - NEW: Upload component
- `src/components/features/TransactionPhotoGallery.tsx` - NEW: Gallery component
- `src/components/features/QuickEntryForm.tsx` - Add photo upload option
- `src/app/(dashboard)/transactions/[id]/edit/page.tsx` - Add photo management
- `.env.example` - Add S3 config vars

**Test Files**:
- `tests/unit/photo-storage.test.ts` - NEW
- `tests/integration/transaction-photos.test.ts` - NEW (optional)

---

## Executive Summary

This feature adds photo upload capability to transactions, allowing users to attach images (e.g., BOM components laid out before a build) for documentation. Implementation requires:

1. New `TransactionPhoto` database model with S3 URL storage
2. S3 integration service for secure upload/download
3. Upload API endpoint with image validation and compression
4. Photo upload component for transaction forms
5. Photo gallery component for transaction detail view

The primary use case is photographing BOM components before builds, but the feature will work for all transaction types.

---

## Phase 0: Environment Setup & Dependencies

### Subtask 0.1: Verify Environment Dependencies
**Instructions**:
1. Check AWS credentials exist in `.env`
2. Verify S3 bucket is configured or can be created
3. Document fallback behavior if S3 unavailable

**Completion Criteria**:
- [ ] AWS credentials verified or documented as needed
- [ ] S3 bucket name determined

### Subtask 0.2: Install Required Packages
**File**: `package.json`
**Instructions**:
```bash
npm install @aws-sdk/client-s3 @aws-sdk/s3-request-presigner sharp
npm install --save-dev @types/sharp
```

**Completion Criteria**:
- [ ] `@aws-sdk/client-s3` installed
- [ ] `@aws-sdk/s3-request-presigner` installed (for signed URLs)
- [ ] `sharp` installed for image compression
- [ ] `npm run build` passes

---

## Phase 1: Database Schema

### Subtask 1.1: Add TransactionPhoto Model
**File**: `/home/pbrown/SkuInventory/prisma/schema.prisma`
**Pattern**: Follow existing model structure (e.g., TransactionLine)
**Instructions**:

Add after TransactionLine model (around line 405):

```prisma
model TransactionPhoto {
  id            String      @id @default(uuid())
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  // S3 storage info
  s3Key         String      @db.VarChar(500)  // Full S3 key path
  s3Bucket      String      @db.VarChar(100)  // Bucket name

  // File metadata
  filename      String      @db.VarChar(255)  // Original filename
  mimeType      String      @db.VarChar(50)   // image/jpeg, image/png, etc.
  fileSize      Int                            // Size in bytes

  // Optional metadata
  caption       String?     @db.VarChar(500)
  sortOrder     Int         @default(0)       // For ordering photos

  uploadedAt    DateTime    @default(now())
  uploadedById  String
  uploadedBy    User        @relation("PhotoUploadedBy", fields: [uploadedById], references: [id])

  @@index([transactionId])
  @@index([uploadedAt])
}
```

Update Transaction model to add relation:
```prisma
// Add to Transaction model relations (around line 374)
photos TransactionPhoto[]
```

Update User model to add relation:
```prisma
// Add to User model relations
photosUploaded TransactionPhoto[] @relation("PhotoUploadedBy")
```

**Validation**:
```bash
npx prisma validate
DATABASE_URL="postgresql://inventory_test:inventory_test_2025@localhost:2346/inventory_test" npx prisma migrate dev --name add_transaction_photos
```

**Completion Criteria**:
- [ ] TransactionPhoto model added to schema
- [ ] Transaction relation added
- [ ] User relation added
- [ ] Migration runs successfully on test database
- [ ] `npx prisma generate` completes

---

## Phase 2: TypeScript Types

### Subtask 2.1: Add Photo Types
**File**: `/home/pbrown/SkuInventory/src/types/transaction.ts`
**Pattern**: Follow existing `TransactionLineResponse` interface
**Instructions**:

Add after TransactionLineResponse (around line 182):

```typescript
// Transaction photo types
export interface TransactionPhotoResponse {
  id: string
  transactionId: string
  filename: string
  mimeType: string
  fileSize: number
  caption: string | null
  sortOrder: number
  uploadedAt: string
  uploadedBy: { id: string; name: string }
  // URL will be generated at runtime (signed URL or public URL)
  url: string
  thumbnailUrl?: string
}

export interface UploadPhotoInput {
  transactionId: string
  caption?: string
}

// Update TransactionResponse to include photos
// (Note: Add to existing interface)
```

Update `TransactionResponse` interface to include photos array.

**Completion Criteria**:
- [ ] `TransactionPhotoResponse` interface defined
- [ ] `UploadPhotoInput` interface defined
- [ ] TransactionResponse updated with `photos?: TransactionPhotoResponse[]`
- [ ] `npx tsc --noEmit` passes

### Subtask 2.2: Add Photo-Specific Types File (Optional)
**File**: `/home/pbrown/SkuInventory/src/types/photo.ts`
**Instructions**:

```typescript
// Photo upload configuration
export interface PhotoUploadConfig {
  maxSizeBytes: number    // 10MB default
  allowedTypes: string[]  // ['image/jpeg', 'image/png', 'image/webp']
  maxDimension: number    // Max width/height for compression
  thumbnailSize: number   // Thumbnail dimension
}

export const DEFAULT_PHOTO_CONFIG: PhotoUploadConfig = {
  maxSizeBytes: 10 * 1024 * 1024,  // 10MB
  allowedTypes: ['image/jpeg', 'image/png', 'image/webp', 'image/heic'],
  maxDimension: 2048,
  thumbnailSize: 300,
}
```

**Completion Criteria**:
- [ ] Photo config types defined
- [ ] Default config exported
- [ ] `npx tsc --noEmit` passes

---

## Phase 3: S3 Storage Service

### Subtask 3.1: Add Environment Variables
**File**: `/home/pbrown/SkuInventory/.env.example`
**Instructions**:

Add new section:

```bash
# ============================================================================
# PHOTO STORAGE (AWS S3)
# ============================================================================
# S3 bucket for transaction photos
# Create bucket with private ACL, enable versioning recommended
PHOTO_S3_BUCKET=trevor-inventory-photos
PHOTO_S3_REGION=us-east-1

# Optional: Use existing AWS credentials from SP-API section
# AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY are shared
```

**Completion Criteria**:
- [ ] S3 bucket env var documented
- [ ] S3 region env var documented

### Subtask 3.2: Create Photo Storage Service
**File**: `/home/pbrown/SkuInventory/src/services/photo-storage.ts` (NEW)
**Pattern**: Follow `src/services/inventory.ts` service pattern
**Instructions**:

```typescript
import { S3Client, PutObjectCommand, GetObjectCommand, DeleteObjectCommand } from '@aws-sdk/client-s3'
import { getSignedUrl } from '@aws-sdk/s3-request-presigner'
import sharp from 'sharp'
import { DEFAULT_PHOTO_CONFIG, type PhotoUploadConfig } from '@/types/photo'

const s3Client = new S3Client({
  region: process.env.PHOTO_S3_REGION || 'us-east-1',
  credentials: {
    accessKeyId: process.env.AWS_ACCESS_KEY_ID!,
    secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY!,
  },
})

const BUCKET = process.env.PHOTO_S3_BUCKET || 'trevor-inventory-photos'

export interface UploadResult {
  s3Key: string
  s3Bucket: string
  fileSize: number
  mimeType: string
}

/**
 * Validates image file
 */
export function validateImageFile(
  file: { size: number; type: string; name: string },
  config: PhotoUploadConfig = DEFAULT_PHOTO_CONFIG
): { valid: boolean; error?: string } {
  if (file.size > config.maxSizeBytes) {
    return { valid: false, error: `File too large. Maximum ${config.maxSizeBytes / 1024 / 1024}MB allowed.` }
  }
  if (!config.allowedTypes.includes(file.type)) {
    return { valid: false, error: `Invalid file type. Allowed: ${config.allowedTypes.join(', ')}` }
  }
  return { valid: true }
}

/**
 * Compress and resize image using sharp
 */
export async function processImage(
  buffer: Buffer,
  config: PhotoUploadConfig = DEFAULT_PHOTO_CONFIG
): Promise<{ main: Buffer; thumbnail: Buffer; mimeType: string }> {
  const image = sharp(buffer)
  const metadata = await image.metadata()

  // Resize main image if too large
  let mainImage = image
  if (metadata.width && metadata.width > config.maxDimension) {
    mainImage = mainImage.resize(config.maxDimension, undefined, { withoutEnlargement: true })
  }
  if (metadata.height && metadata.height > config.maxDimension) {
    mainImage = mainImage.resize(undefined, config.maxDimension, { withoutEnlargement: true })
  }

  // Convert to webp for efficiency, maintain quality
  const main = await mainImage.webp({ quality: 85 }).toBuffer()

  // Create thumbnail
  const thumbnail = await sharp(buffer)
    .resize(config.thumbnailSize, config.thumbnailSize, { fit: 'cover' })
    .webp({ quality: 75 })
    .toBuffer()

  return { main, thumbnail, mimeType: 'image/webp' }
}

/**
 * Upload image to S3
 */
export async function uploadToS3(
  buffer: Buffer,
  key: string,
  mimeType: string
): Promise<void> {
  await s3Client.send(new PutObjectCommand({
    Bucket: BUCKET,
    Key: key,
    Body: buffer,
    ContentType: mimeType,
  }))
}

/**
 * Generate signed URL for private S3 object
 */
export async function getSignedPhotoUrl(
  s3Key: string,
  expiresIn: number = 3600  // 1 hour default
): Promise<string> {
  const command = new GetObjectCommand({
    Bucket: BUCKET,
    Key: s3Key,
  })
  return getSignedUrl(s3Client, command, { expiresIn })
}

/**
 * Delete photo from S3
 */
export async function deleteFromS3(s3Key: string): Promise<void> {
  await s3Client.send(new DeleteObjectCommand({
    Bucket: BUCKET,
    Key: s3Key,
  }))
}

/**
 * Generate S3 key path for transaction photo
 */
export function generateS3Key(
  companyId: string,
  transactionId: string,
  filename: string,
  type: 'main' | 'thumbnail' = 'main'
): string {
  const timestamp = Date.now()
  const sanitizedFilename = filename.replace(/[^a-zA-Z0-9.-]/g, '_')
  const baseName = sanitizedFilename.replace(/\.[^.]+$/, '')

  if (type === 'thumbnail') {
    return `photos/${companyId}/${transactionId}/thumb_${timestamp}_${baseName}.webp`
  }
  return `photos/${companyId}/${transactionId}/${timestamp}_${baseName}.webp`
}
```

**Completion Criteria**:
- [ ] S3Client configured
- [ ] Image validation function
- [ ] Image processing with sharp (resize, compress, thumbnail)
- [ ] Upload/download/delete functions
- [ ] Signed URL generation
- [ ] S3 key path generation
- [ ] `npx tsc --noEmit` passes

---

## Phase 4: API Routes

### Subtask 4.1: Create Photo Upload Endpoint
**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/[id]/photos/route.ts` (NEW)
**Pattern**: Follow `src/app/api/csv/upload/route.ts`
**Instructions**:

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { getServerSession } from 'next-auth'
import { authOptions, getSelectedCompanyRole } from '@/lib/auth'
import { prisma } from '@/lib/db'
import { error, unauthorized, notFound, created, success } from '@/lib/api-response'
import {
  validateImageFile,
  processImage,
  uploadToS3,
  generateS3Key,
  getSignedPhotoUrl,
  deleteFromS3,
} from '@/services/photo-storage'
import { DEFAULT_PHOTO_CONFIG } from '@/types/photo'

interface RouteParams {
  params: Promise<{ id: string }>
}

// POST /api/transactions/[id]/photos - Upload photo(s) to transaction
export async function POST(request: NextRequest, { params }: RouteParams) {
  try {
    const session = await getServerSession(authOptions)
    if (!session?.user?.id) {
      return unauthorized()
    }

    const companyRole = getSelectedCompanyRole(session)
    if (companyRole === 'viewer') {
      return unauthorized('Viewers cannot upload photos')
    }

    const selectedCompanyId = session.user.selectedCompanyId
    if (!selectedCompanyId) {
      return error('No company selected', 400)
    }

    const { id: transactionId } = await params

    // Verify transaction exists and belongs to company
    const transaction = await prisma.transaction.findFirst({
      where: {
        id: transactionId,
        companyId: selectedCompanyId,
        deletedAt: null,
      },
    })

    if (!transaction) {
      return notFound('Transaction')
    }

    // Parse multipart form data
    const formData = await request.formData()
    const file = formData.get('file') as File | null
    const caption = formData.get('caption') as string | null

    if (!file) {
      return error('No file provided', 400)
    }

    // Validate file
    const validation = validateImageFile({
      size: file.size,
      type: file.type,
      name: file.name,
    })

    if (!validation.valid) {
      return error(validation.error!, 400)
    }

    // Read file buffer
    const buffer = Buffer.from(await file.arrayBuffer())

    // Process image (compress, create thumbnail)
    const processed = await processImage(buffer)

    // Generate S3 keys
    const mainKey = generateS3Key(selectedCompanyId, transactionId, file.name, 'main')
    const thumbKey = generateS3Key(selectedCompanyId, transactionId, file.name, 'thumbnail')

    // Upload to S3
    await Promise.all([
      uploadToS3(processed.main, mainKey, processed.mimeType),
      uploadToS3(processed.thumbnail, thumbKey, processed.mimeType),
    ])

    // Get current max sort order
    const maxOrder = await prisma.transactionPhoto.aggregate({
      where: { transactionId },
      _max: { sortOrder: true },
    })

    // Create database record
    const photo = await prisma.transactionPhoto.create({
      data: {
        transactionId,
        s3Key: mainKey,
        s3Bucket: process.env.PHOTO_S3_BUCKET!,
        filename: file.name,
        mimeType: processed.mimeType,
        fileSize: processed.main.length,
        caption: caption || null,
        sortOrder: (maxOrder._max.sortOrder ?? -1) + 1,
        uploadedById: session.user.id,
      },
      include: {
        uploadedBy: { select: { id: true, name: true } },
      },
    })

    // Generate signed URLs
    const [url, thumbnailUrl] = await Promise.all([
      getSignedPhotoUrl(mainKey),
      getSignedPhotoUrl(thumbKey),
    ])

    return created({
      data: {
        id: photo.id,
        transactionId: photo.transactionId,
        filename: photo.filename,
        mimeType: photo.mimeType,
        fileSize: photo.fileSize,
        caption: photo.caption,
        sortOrder: photo.sortOrder,
        uploadedAt: photo.uploadedAt.toISOString(),
        uploadedBy: photo.uploadedBy,
        url,
        thumbnailUrl,
      },
    })
  } catch (err) {
    console.error('Photo upload error:', err)
    return error('Failed to upload photo', 500)
  }
}

// GET /api/transactions/[id]/photos - List photos for transaction
export async function GET(request: NextRequest, { params }: RouteParams) {
  try {
    const session = await getServerSession(authOptions)
    if (!session?.user?.id) {
      return unauthorized()
    }

    const selectedCompanyId = session.user.selectedCompanyId
    if (!selectedCompanyId) {
      return error('No company selected', 400)
    }

    const { id: transactionId } = await params

    // Verify transaction exists and belongs to company
    const transaction = await prisma.transaction.findFirst({
      where: {
        id: transactionId,
        companyId: selectedCompanyId,
        deletedAt: null,
      },
    })

    if (!transaction) {
      return notFound('Transaction')
    }

    const photos = await prisma.transactionPhoto.findMany({
      where: { transactionId },
      orderBy: { sortOrder: 'asc' },
      include: {
        uploadedBy: { select: { id: true, name: true } },
      },
    })

    // Generate signed URLs for all photos
    const photosWithUrls = await Promise.all(
      photos.map(async (photo) => {
        const thumbKey = photo.s3Key.replace(/\/(\d+_)/, '/thumb_$1')
        const [url, thumbnailUrl] = await Promise.all([
          getSignedPhotoUrl(photo.s3Key),
          getSignedPhotoUrl(thumbKey),
        ])
        return {
          id: photo.id,
          transactionId: photo.transactionId,
          filename: photo.filename,
          mimeType: photo.mimeType,
          fileSize: photo.fileSize,
          caption: photo.caption,
          sortOrder: photo.sortOrder,
          uploadedAt: photo.uploadedAt.toISOString(),
          uploadedBy: photo.uploadedBy,
          url,
          thumbnailUrl,
        }
      })
    )

    return success({ data: photosWithUrls })
  } catch (err) {
    console.error('Photo list error:', err)
    return error('Failed to list photos', 500)
  }
}
```

**Completion Criteria**:
- [ ] POST handler for photo upload
- [ ] GET handler for listing photos
- [ ] Auth checks (session, company, role)
- [ ] Transaction ownership validation
- [ ] File validation
- [ ] Image processing
- [ ] S3 upload
- [ ] Database record creation
- [ ] Signed URL generation
- [ ] `npx tsc --noEmit` passes

### Subtask 4.2: Create Single Photo Management Endpoint
**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/photos/[photoId]/route.ts` (NEW)
**Instructions**:

Implement DELETE for removing a photo, PATCH for updating caption/order.

**Completion Criteria**:
- [ ] DELETE handler implemented
- [ ] PATCH handler for caption/sortOrder
- [ ] S3 cleanup on delete
- [ ] `npx tsc --noEmit` passes

### Subtask 4.3: Update Transaction Detail API
**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/[id]/route.ts`
**Instructions**:

Update GET handler to include photos in response. Add `include: { photos: true }` to Prisma query and generate signed URLs for each photo.

**Completion Criteria**:
- [ ] Photos included in transaction detail response
- [ ] Signed URLs generated for photos
- [ ] Types updated if needed
- [ ] `npx tsc --noEmit` passes

---

## Phase 5: Frontend Components

### Subtask 5.1: Create Photo Upload Component
**File**: `/home/pbrown/SkuInventory/src/components/features/TransactionPhotoUpload.tsx` (NEW)
**Pattern**: Follow existing form components (dropzone style)
**Instructions**:

Create component with:
- Dropzone area for drag-and-drop
- File input for click-to-select
- Progress indicator during upload
- Preview of selected images before upload
- Caption input (optional)
- Multiple file support

Props interface:
```typescript
interface TransactionPhotoUploadProps {
  transactionId: string
  onUploadComplete?: (photo: TransactionPhotoResponse) => void
  onError?: (error: string) => void
  disabled?: boolean
}
```

**Completion Criteria**:
- [ ] Dropzone UI implemented
- [ ] File selection handling
- [ ] Upload to API endpoint
- [ ] Progress indication
- [ ] Error handling
- [ ] Preview display
- [ ] `npx tsc --noEmit` passes

### Subtask 5.2: Create Photo Gallery Component
**File**: `/home/pbrown/SkuInventory/src/components/features/TransactionPhotoGallery.tsx` (NEW)
**Pattern**: Grid of thumbnails with lightbox
**Instructions**:

Create component with:
- Grid of thumbnail images
- Click to view full-size (modal/lightbox)
- Delete button (for authorized users)
- Caption display
- Empty state when no photos

Props interface:
```typescript
interface TransactionPhotoGalleryProps {
  photos: TransactionPhotoResponse[]
  canDelete?: boolean
  onDelete?: (photoId: string) => void
  loading?: boolean
}
```

**Completion Criteria**:
- [ ] Thumbnail grid layout
- [ ] Full-size view modal
- [ ] Delete functionality
- [ ] Empty state
- [ ] Loading state
- [ ] `npx tsc --noEmit` passes

### Subtask 5.3: Update TransactionDetail Component
**File**: `/home/pbrown/SkuInventory/src/components/features/TransactionDetail.tsx`
**Instructions**:

Add new Card section for photos after existing content:

1. Add photos to the props interface (around line 85)
2. Add new Card section with:
   - TransactionPhotoGallery for viewing
   - TransactionPhotoUpload for adding (when canEdit)
3. Place after "Finished Goods Lines" section

**Completion Criteria**:
- [ ] Photos prop added to interface
- [ ] Photo gallery section added
- [ ] Upload component added for editable transactions
- [ ] `npm run build` passes

### Subtask 5.4: Update Transaction Detail Page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/transactions/[id]/page.tsx`
**Instructions**:

Ensure photos are passed through from API response to TransactionDetail component. May need to refetch photos after upload.

**Completion Criteria**:
- [ ] Photos displayed in detail view
- [ ] Upload triggers refresh
- [ ] `npm run build` passes

### Subtask 5.5: Add Photo Upload to QuickEntryForm (Build transactions)
**File**: `/home/pbrown/SkuInventory/src/components/features/QuickEntryForm.tsx`
**Instructions**:

For build transaction type specifically (primary use case), add optional photo upload section:

1. Add state for pending photos (selected but not uploaded)
2. Show photo upload dropzone for build transactions
3. After successful transaction creation, upload photos to the new transaction
4. Show success message with photo count

**Pattern**: Place after notes field, before submit button for build form

**Completion Criteria**:
- [ ] Photo upload section for build transactions
- [ ] Photos uploaded after transaction created
- [ ] Success message includes photo count
- [ ] `npm run build` passes

---

## Phase 6: Integration & Testing

### Subtask 6.1: Update Transaction Edit Page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/transactions/[id]/edit/page.tsx`
**Instructions**:

Add photo management section to edit page:
- Display existing photos
- Allow adding new photos
- Allow deleting existing photos

**Completion Criteria**:
- [ ] Photo section in edit page
- [ ] Add/delete photos
- [ ] `npm run build` passes

### Subtask 6.2: Add Unit Tests for Photo Storage Service
**File**: `/home/pbrown/SkuInventory/tests/unit/photo-storage.test.ts` (NEW)
**Instructions**:

Test:
- `validateImageFile` - valid/invalid files
- `generateS3Key` - correct path structure
- Image processing (mock sharp)

**Completion Criteria**:
- [ ] Validation tests
- [ ] Key generation tests
- [ ] `npm test` passes

### Subtask 6.3: Final Validation
**Instructions**:

```bash
# TypeScript check
npx tsc --noEmit

# Build check
npm run build

# Lint check
npm run lint

# Run tests
npm test
```

**Completion Criteria**:
- [ ] All checks pass
- [ ] No TypeScript errors
- [ ] No lint warnings
- [ ] Tests pass

---

## Summary of Deliverables

**Files Created**: 8
- `prisma/migrations/xxx_add_transaction_photos/migration.sql` (auto-generated)
- `src/types/photo.ts`
- `src/services/photo-storage.ts`
- `src/app/api/transactions/[id]/photos/route.ts`
- `src/app/api/transactions/photos/[photoId]/route.ts`
- `src/components/features/TransactionPhotoUpload.tsx`
- `src/components/features/TransactionPhotoGallery.tsx`
- `tests/unit/photo-storage.test.ts`

**Files Modified**: 7
- `package.json` (add S3 SDK, sharp)
- `.env.example` (add S3 config)
- `prisma/schema.prisma` (add TransactionPhoto model)
- `src/types/transaction.ts` (add photo types)
- `src/components/features/TransactionDetail.tsx` (add gallery)
- `src/components/features/QuickEntryForm.tsx` (add upload for builds)
- `src/app/(dashboard)/transactions/[id]/edit/page.tsx` (add photo management)

---

## Required Environment Configuration

```bash
# New environment variables needed
PHOTO_S3_BUCKET=trevor-inventory-photos
PHOTO_S3_REGION=us-east-1

# Existing variables (shared with SP-API)
AWS_ACCESS_KEY_ID=...
AWS_SECRET_ACCESS_KEY=...
```

---

## Test Strategy Note

- **Unit Tests**: Photo storage service (validation, key generation)
- **Integration Tests**: Photo upload API (manual testing recommended)
- **E2E Tests**: Not required for initial implementation

---

## UI Acceptance Criteria

- [ ] Photo upload dropzone visible in transaction detail (when user can edit)
- [ ] Photo thumbnails displayed in grid layout
- [ ] Click thumbnail to view full-size image in modal
- [ ] Delete button visible for authorized users
- [ ] Works on desktop (1024px+)
- [ ] Works on tablet (768px-1023px)
- [ ] Works on mobile (<768px)
- [ ] Progress indicator during upload
- [ ] Error messages displayed for failed uploads

---

## Performance Metrics Target

| Phase | Duration |
|-------|----------|
| Investigation | 25m |
| Validation | 10m |
| Planning | 30m |
| **Total Planning** | **65m** |
| **Estimated Build** | **10-14h** |

---

## Risk Mitigation

1. **S3 Configuration**: Include clear error messages if S3 not configured
2. **Image Processing**: Use try/catch around sharp operations
3. **Large Files**: Enforce 10MB limit server-side
4. **Signed URL Expiry**: Generate fresh URLs on each request (1 hour expiry)
