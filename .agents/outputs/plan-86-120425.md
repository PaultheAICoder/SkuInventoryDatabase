# Implementation Plan
**Generated**: 2025-12-04T14:30:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: Issue #86
**Estimated Build Time**: 4-6 hours
**Complexity**: Moderate

## Investigation Summary

### Request Analysis
**Type**: Feature
**Source**: GitHub Issue #86
**Priority**: Medium

### Task Classification
**Category**: NEW_FEATURE
**Test Strategy**: TARGETED
**Suggested Filter**: `--filter="SKU"` for tests

### Issue Validation
**Status**: Valid
**Recent Changes**:
- Issue #72 added FG inventory tracking from builds (1bc6c25)
- Issue #73 added location-based filtering to UI pages (4d2ae49)
- SKU API routes already include `finishedGoodsQuantity` in list response
- SKU detail page already displays FG inventory when present (lines 181-198)
- FG adjustment/receipt API endpoints already exist (Issue #83)

### Current State Assessment

**Existing Infrastructure (ALREADY DONE)**:
- `finishedGoodsQuantity` field already included in SKU list API response (src/app/api/skus/route.ts:113)
- `finishedGoodsInventory` field already included in SKU detail API response (src/app/api/skus/[id]/route.ts:125)
- SKU detail page ALREADY displays FG inventory (src/app/(dashboard)/skus/[id]/page.tsx:181-198)
- FG adjustment endpoint exists: `POST /api/skus/:id/inventory` (src/app/api/skus/[id]/inventory/route.ts)
- FG receipt endpoint exists: `POST /api/skus/:id/inventory/receipt` (src/app/api/skus/[id]/inventory/receipt/route.ts)
- `SKUResponse` type already has `finishedGoodsQuantity` (src/types/sku.ts:61)
- `SKUDetailResponse` type already has `finishedGoodsInventory` (src/types/sku.ts:74)

**What STILL NEEDS TO BE DONE**:
1. SKUTable already has "FG Qty" column (line 161) - **DONE**
2. Create `FinishedGoodsAdjustmentDialog.tsx` component
3. Create `FinishedGoodsReceiptDialog.tsx` component
4. Add "Adjust FG" and "Receive FG" buttons to SKU detail page
5. Wire up dialogs to refresh data after submission

### Dependencies & Blockers
1. Issue #75 (schema) - COMPLETE
2. Issue #79 (build output) - COMPLETE
3. Issue #83 (adjustment endpoints) - COMPLETE

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Moderate
**Effort**: 4-6 hours
**Risk**: Low - all backend infrastructure already exists

### Patterns Identified
**Primary**: `/home/pbrown/SkuInventory/src/components/features/AdjustmentDialog.tsx` - Dialog structure for component adjustments
**Secondary**: `/home/pbrown/SkuInventory/src/components/features/ReceiptDialog.tsx` - Dialog structure for receipts
**Additional**: `/home/pbrown/SkuInventory/src/components/features/BuildDialog.tsx` - SKU-based dialog with location selection

### Ripple Effect Analysis
**Files Identified**: 3 files affected
- `/home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/page.tsx` - Add buttons and dialog state
- `/home/pbrown/SkuInventory/src/components/features/FinishedGoodsAdjustmentDialog.tsx` - CREATE NEW
- `/home/pbrown/SkuInventory/src/components/features/FinishedGoodsReceiptDialog.tsx` - CREATE NEW

---

## Executive Summary

Create two new dialog components for managing finished goods inventory on SKUs: `FinishedGoodsAdjustmentDialog` (for add/subtract adjustments) and `FinishedGoodsReceiptDialog` (for returns/corrections). Add "Adjust FG" and "Receive FG" buttons to the SKU detail page that open these dialogs. The backend API endpoints already exist from Issue #83.

---

## Phase 1: Create FinishedGoodsAdjustmentDialog Component

### Subtask 1.1: Create FinishedGoodsAdjustmentDialog.tsx

**File**: `/home/pbrown/SkuInventory/src/components/features/FinishedGoodsAdjustmentDialog.tsx` (CREATE)
**Pattern**: Follow `/home/pbrown/SkuInventory/src/components/features/AdjustmentDialog.tsx` (lines 1-289)

**Instructions**:
1. Create new dialog component similar to `AdjustmentDialog.tsx`
2. Props interface:
```typescript
interface FinishedGoodsAdjustmentDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  skuId: string
  skuName: string
  currentQuantity: number
}
```
3. Form fields:
   - `date` (required) - date picker, default to today
   - `adjustmentType` (required) - select: 'add' | 'subtract'
   - `quantity` (required) - number input, positive integer
   - `locationId` (required) - select from active locations
   - `reason` (required) - select with predefined reasons:
     - "Inventory count correction"
     - "Damaged goods"
     - "Lost/missing"
     - "Sample/testing"
     - "Other (specify in notes)"
   - `notes` (optional) - text input

4. On submit:
   - Calculate signed quantity based on adjustmentType
   - POST to `/api/skus/${skuId}/inventory` with body:
     ```json
     {
       "skuId": "...",
       "locationId": "...",
       "quantity": signed_number,
       "reason": "...",
       "notes": "...",
       "date": "YYYY-MM-DD"
     }
     ```
   - Close dialog and call router.refresh() on success

5. Display preview of new quantity (current + adjustment)

**API Schema Reference** (from `/home/pbrown/SkuInventory/src/types/finished-goods.ts` lines 4-13):
```typescript
export const adjustFinishedGoodsSchema = z.object({
  skuId: z.string().uuid('Invalid SKU ID'),
  locationId: z.string().uuid('Invalid location ID'),
  quantity: z.coerce.number().refine((val) => val !== 0, 'Quantity cannot be zero'),
  reason: z.string().min(1, 'Reason is required').max(200),
  notes: z.string().optional().nullable(),
  date: z.coerce.date(),
})
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run lint
```

**Completion Criteria**:
- [ ] Component file created
- [ ] Dialog opens/closes correctly
- [ ] Locations load from API
- [ ] Form validates required fields
- [ ] Submits to correct endpoint
- [ ] TypeScript compiles without errors

---

## Phase 2: Create FinishedGoodsReceiptDialog Component

### Subtask 2.1: Create FinishedGoodsReceiptDialog.tsx

**File**: `/home/pbrown/SkuInventory/src/components/features/FinishedGoodsReceiptDialog.tsx` (CREATE)
**Pattern**: Follow `/home/pbrown/SkuInventory/src/components/features/ReceiptDialog.tsx` (lines 1-303)

**Instructions**:
1. Create new dialog component similar to `ReceiptDialog.tsx`
2. Props interface:
```typescript
interface FinishedGoodsReceiptDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  skuId: string
  skuName: string
  currentQuantity: number
}
```
3. Form fields:
   - `date` (required) - date picker, default to today
   - `quantity` (required) - positive number input
   - `locationId` (required) - select from active locations
   - `source` (required) - text input (e.g., "Customer Return", "Correction")
   - `costPerUnit` (optional) - decimal number input
   - `notes` (optional) - text input

4. On submit:
   - POST to `/api/skus/${skuId}/inventory/receipt` with body:
     ```json
     {
       "locationId": "...",
       "quantity": positive_number,
       "source": "...",
       "costPerUnit": optional_number,
       "notes": "...",
       "date": "YYYY-MM-DD"
     }
     ```
   - Close dialog and call router.refresh() on success

**API Schema Reference** (from `/home/pbrown/SkuInventory/src/types/finished-goods.ts` lines 42-51):
```typescript
export const receiveFinishedGoodsSchema = z.object({
  locationId: z.string().uuid('Invalid location ID'),
  quantity: z.coerce.number().positive('Quantity must be positive'),
  source: z.string().min(1, 'Source is required').max(100),
  costPerUnit: z.coerce.number().nonnegative().optional(),
  notes: z.string().optional().nullable(),
  date: z.coerce.date(),
})
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run lint
```

**Completion Criteria**:
- [ ] Component file created
- [ ] Dialog opens/closes correctly
- [ ] Locations load from API
- [ ] Form validates required fields (quantity positive, source required)
- [ ] Submits to correct endpoint
- [ ] TypeScript compiles without errors

---

## Phase 3: Integrate Dialogs into SKU Detail Page

### Subtask 3.1: Add FG Action Buttons and Dialog State to SKU Detail Page

**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/page.tsx` (MODIFY)
**Pattern**: Follow existing `buildDialogOpen` state pattern (line 35)

**Instructions**:

1. **Add imports** (after line 21):
```typescript
import { FinishedGoodsAdjustmentDialog } from '@/components/features/FinishedGoodsAdjustmentDialog'
import { FinishedGoodsReceiptDialog } from '@/components/features/FinishedGoodsReceiptDialog'
import { Minus, Plus } from 'lucide-react'
```

2. **Add state variables** (after line 35 where `buildDialogOpen` is defined):
```typescript
const [fgAdjustmentDialogOpen, setFgAdjustmentDialogOpen] = useState(false)
const [fgReceiptDialogOpen, setFgReceiptDialogOpen] = useState(false)
```

3. **Add FG action buttons** in the header section (around line 117-130), within the `{canEdit && (` block, add two new buttons after the Build button:
```tsx
{/* FG action buttons - only show if user can edit */}
{sku.finishedGoodsInventory && (
  <>
    <Button variant="outline" onClick={() => setFgAdjustmentDialogOpen(true)}>
      <Minus className="h-4 w-4 mr-2" />
      Adjust FG
    </Button>
    <Button variant="outline" onClick={() => setFgReceiptDialogOpen(true)}>
      <Plus className="h-4 w-4 mr-2" />
      Receive FG
    </Button>
  </>
)}
```

NOTE: After review, FG buttons should ALWAYS show for ops/admin users (not just when finishedGoodsInventory exists), since users may want to receive FG even when current balance is 0. Update condition to just `{canEdit && (...)}` without the finishedGoodsInventory check.

4. **Add dialogs** at the end of the component (after the BuildDialog around line 302):
```tsx
{/* Finished Goods Dialogs */}
{skuId && (
  <>
    <FinishedGoodsAdjustmentDialog
      open={fgAdjustmentDialogOpen}
      onOpenChange={(open) => {
        setFgAdjustmentDialogOpen(open)
        if (!open) handleRefresh()
      }}
      skuId={skuId}
      skuName={sku.name}
      currentQuantity={sku.finishedGoodsInventory?.totalQuantity ?? 0}
    />
    <FinishedGoodsReceiptDialog
      open={fgReceiptDialogOpen}
      onOpenChange={(open) => {
        setFgReceiptDialogOpen(open)
        if (!open) handleRefresh()
      }}
      skuId={skuId}
      skuName={sku.name}
      currentQuantity={sku.finishedGoodsInventory?.totalQuantity ?? 0}
    />
  </>
)}
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run lint
npm run build
```

**Completion Criteria**:
- [ ] "Adjust FG" button visible on SKU detail page for ops/admin users
- [ ] "Receive FG" button visible on SKU detail page for ops/admin users
- [ ] Clicking buttons opens respective dialogs
- [ ] Dialogs refresh data after closing
- [ ] TypeScript compiles without errors
- [ ] Build completes successfully

---

## Phase 4: Final Validation and Testing

### Subtask 4.1: Run Full Build and Type Check

**Instructions**:
```bash
npx tsc --noEmit
npm run build
npm run lint
```

**Completion Criteria**:
- [ ] TypeScript compiles with no errors
- [ ] Build succeeds with no errors
- [ ] No lint errors or warnings

### Subtask 4.2: Manual Testing Checklist

**Instructions**:
1. Navigate to SKU list page (/skus)
2. Verify "FG Qty" column displays values
3. Click on a SKU to go to detail page
4. Verify FG balance is displayed in left card
5. As ops/admin user, verify "Adjust FG" and "Receive FG" buttons appear
6. Click "Adjust FG" button:
   - Verify dialog opens
   - Verify locations load
   - Fill in form and submit
   - Verify data refreshes
7. Click "Receive FG" button:
   - Verify dialog opens
   - Verify locations load
   - Fill in form and submit
   - Verify data refreshes
8. As viewer user, verify buttons do NOT appear

**Completion Criteria**:
- [ ] SKU list shows FG Qty column (already implemented)
- [ ] SKU detail page displays FG balance (already implemented)
- [ ] "Adjust FG" button opens adjustment dialog
- [ ] "Receive FG" button opens receipt dialog
- [ ] Dialogs submit to correct API endpoints
- [ ] Data refreshes after successful adjustments
- [ ] Role-based visibility (ops/admin only for buttons)
- [ ] Consistent styling with existing UI patterns

---

## Summary of Deliverables

**Files Created**: 2
- `/home/pbrown/SkuInventory/src/components/features/FinishedGoodsAdjustmentDialog.tsx`
- `/home/pbrown/SkuInventory/src/components/features/FinishedGoodsReceiptDialog.tsx`

**Files Modified**: 1
- `/home/pbrown/SkuInventory/src/app/(dashboard)/skus/[id]/page.tsx`

## Handoff to Build Agent

1. Execute subtasks in exact order (Phase 1 -> Phase 2 -> Phase 3 -> Phase 4)
2. Complete each subtask fully before moving to next
3. Test completion criteria before next subtask
4. Follow reference patterns exactly from AdjustmentDialog.tsx and ReceiptDialog.tsx

## Key Pattern References

### Dialog Structure Pattern (from AdjustmentDialog.tsx)
```typescript
'use client'

import { useState, useEffect } from 'react'
import { useRouter } from 'next/navigation'
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'

interface DialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  // ... other props
}

export function MyDialog({ open, onOpenChange, ...props }: DialogProps) {
  const router = useRouter()
  const [isLoading, setIsLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)
  const [locations, setLocations] = useState<Array<{ id: string; name: string }>>([])
  const [isLoadingLocations, setIsLoadingLocations] = useState(false)
  const [formData, setFormData] = useState({ /* initial state */ })

  useEffect(() => {
    if (open) {
      fetchLocations()
    }
  }, [open])

  const fetchLocations = async () => {
    setIsLoadingLocations(true)
    try {
      const res = await fetch('/api/locations?isActive=true&pageSize=50')
      if (res.ok) {
        const data = await res.json()
        setLocations(data.data || [])
      }
    } catch (err) {
      console.error('Failed to fetch locations:', err)
    } finally {
      setIsLoadingLocations(false)
    }
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setIsLoading(true)
    setError(null)

    try {
      const res = await fetch('/api/...', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ /* form data */ }),
      })

      if (!res.ok) {
        const data = await res.json().catch(() => ({}))
        throw new Error(data?.message || 'Failed')
      }

      onOpenChange(false)
      router.refresh()
      // Reset form
    } catch (err) {
      setError(err instanceof Error ? err.message : 'An error occurred')
    } finally {
      setIsLoading(false)
    }
  }

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-[425px]">
        <form onSubmit={handleSubmit}>
          <DialogHeader>
            <DialogTitle>Title</DialogTitle>
            <DialogDescription>Description</DialogDescription>
          </DialogHeader>
          <div className="grid gap-4 py-4">
            {error && (
              <div className="rounded-md bg-destructive/10 p-3 text-sm text-destructive">
                {error}
              </div>
            )}
            {/* Form fields */}
          </div>
          <DialogFooter>
            <Button type="button" variant="outline" onClick={() => onOpenChange(false)}>
              Cancel
            </Button>
            <Button type="submit" disabled={isLoading}>
              {isLoading ? 'Submitting...' : 'Submit'}
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  )
}
```

## Test Strategy Note
- Use Vitest for unit tests (if adding tests later)
- Use Playwright for E2E tests (if configured)
- Manual testing checklist provided in Phase 4

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 15m |
| Validation | 5m |
| Planning | 10m |
| **Total** | **30m** |

---

## Acceptance Criteria Checklist (from Issue #86)
- [x] SKU list shows "Finished Goods" column with balance (already done in SKUTable.tsx line 161)
- [x] SKU detail page displays FG balance (already done in page.tsx lines 181-198)
- [ ] "Adjust FG" button opens adjustment dialog (Phase 3)
- [ ] "Receive FG" button opens receipt dialog (Phase 3)
- [ ] Dialogs submit to correct API endpoints (Phase 1, 2)
- [ ] Data refreshes after successful adjustments (Phase 3)
- [ ] Role-based visibility (ops/admin only for buttons) (Phase 3)
- [ ] Consistent styling with existing UI patterns (Phase 1, 2)
- [ ] `npm run build` and `npx tsc --noEmit` pass (Phase 4)
