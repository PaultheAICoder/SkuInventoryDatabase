# Implementation Plan
**Generated**: 2025-12-04 20:15 UTC
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: GitHub Issue #161
**Estimated Build Time**: 1-2 hours
**Complexity**: Low

## Investigation Summary

### Request Analysis
**Type**: Bug
**Source**: GitHub Issue #161
**Priority**: High

### Task Classification
**Category**: BUG_FIX
**Test Strategy**: TARGETED
**Suggested Filter**: `--testPathPattern="settings"` or None (rely on existing E2E tests)

### Issue Validation
**Status**: Valid
**Recent Changes**: No recent changes to settings/page.tsx - bug existed since page creation

### Root Cause Analysis

The `/settings` page hangs on "Loading settings..." indefinitely because of a **missing session loading state check**.

**Current Code Flow** (`src/app/(dashboard)/settings/page.tsx`):
1. Line 9: `const { data: session } = useSession()` - does NOT destructure `status`
2. Line 11: `isLoading` is initialized to `true`
3. Lines 31-35: `useEffect` only calls `fetchSettings()` when `session?.user?.selectedCompanyId` is truthy
4. Lines 53-63: If `isLoading` is `true`, show "Loading settings..." message

**The Bug**: When the session is still loading (during initial page load), `session?.user?.selectedCompanyId` is `undefined`. The `useEffect` never fires, so `fetchSettings()` is never called, and `isLoading` remains `true` forever.

**Evidence**:
- The `SettingsForm` component correctly handles rendering when settings are available
- The API route (`/api/settings`) correctly returns settings data
- The issue is that the page never reaches the form because loading state never transitions

**Comparison with fixed pages**:
- `src/app/(dashboard)/orders/page.tsx` (lines 10, 59-70, 72): Fixed in commit `176cec9` - uses `status` from `useSession`
- `src/app/(dashboard)/forecasts/page.tsx` (lines 25, 102-112, 172): Fixed in commit `9adc77d` - uses `status` from `useSession`
- `src/app/(dashboard)/settings/alerts/page.tsx` (lines 21, 51-72, 74): Already correctly handles `status`

### Current State Assessment
- **Existing components**: `SettingsForm` handles rendering correctly once data is available
- **API Routes**: `/api/settings` returns proper response
- **Types**: No changes needed (`src/types/settings.ts` is correct)
- **Database**: No changes needed

### Dependencies & Blockers
None - this is a simple frontend fix identical to issues #150 and #157.

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Simple
**Effort**: 1-2 hours
**Risk**: Low - surgical fix following established pattern from #150 and #157

### Patterns Identified
**Primary**: `src/app/(dashboard)/orders/page.tsx` - fixed pattern for useSession status handling
**Secondary**: `src/app/(dashboard)/forecasts/page.tsx` - additional reference for same pattern

### Ripple Effect Analysis
**Files Identified**: 1
- `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/page.tsx` - primary fix location

**No additional files affected** - this is an isolated page fix.

---

## Executive Summary

Fix the settings page loading state by destructuring `status` from `useSession()` and properly handling the session loading state. When session is loading, show the loading indicator. When session is loaded but `selectedCompanyId` is missing, properly transition to an appropriate state. This is the exact same fix applied to issues #150 (orders) and #157 (forecasts).

---

## Phase 1: Fix Loading State Logic

### Subtask 1.1: Add session status to useSession destructuring

**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/page.tsx`
**Pattern**: Follow `src/app/(dashboard)/orders/page.tsx` line 10
**Line**: 9

**Current Code**:
```typescript
const { data: session } = useSession()
```

**New Code**:
```typescript
const { data: session, status } = useSession()
```

**Instructions**:
1. Destructure `status` from `useSession()` hook on line 9
2. This provides access to the session loading state ('loading', 'authenticated', 'unauthenticated')

**Completion Criteria**:
- [ ] `status` is destructured from `useSession()`
- [ ] No TypeScript errors

---

### Subtask 1.2: Update useEffect to handle session loading properly

**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/page.tsx`
**Pattern**: Follow `src/app/(dashboard)/orders/page.tsx` lines 59-70
**Lines**: 31-35

**Current Code**:
```typescript
// Refetch when company changes
useEffect(() => {
  if (session?.user?.selectedCompanyId) {
    fetchSettings()
  }
}, [session?.user?.selectedCompanyId, fetchSettings])
```

**New Code**:
```typescript
// Refetch when company changes
useEffect(() => {
  // Don't fetch while session is loading
  if (status === 'loading') return

  // If authenticated with a company selected, fetch settings
  if (session?.user?.selectedCompanyId) {
    fetchSettings()
  } else {
    // Session loaded but no company - stop loading
    setIsLoading(false)
  }
}, [status, session?.user?.selectedCompanyId, fetchSettings])
```

**Instructions**:
1. Add early return when `status === 'loading'` to wait for session
2. Add `else` branch to set `isLoading(false)` when session is loaded but no company is selected
3. Add `status` to the dependency array
4. Keep the existing comment and update it to reflect the full logic

**Completion Criteria**:
- [ ] Loading state properly handles session loading
- [ ] Loading state transitions to false when session loaded but no company
- [ ] `status` is in the dependency array

---

### Subtask 1.3: Update the loading state render condition

**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/page.tsx`
**Pattern**: Follow `src/app/(dashboard)/orders/page.tsx` line 72
**Lines**: 53

**Current Code**:
```typescript
if (isLoading) {
```

**New Code**:
```typescript
if (status === 'loading' || isLoading) {
```

**Instructions**:
1. Update condition to check both `status === 'loading'` and `isLoading`
2. This ensures we show loading while session is being determined AND while fetching settings

**Completion Criteria**:
- [ ] Loading UI shows during session loading
- [ ] Loading UI shows during settings fetch
- [ ] Loading UI disappears when both are done

---

## Phase 2: Validation

### Subtask 2.1: Run TypeScript check

**Command**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] No TypeScript errors

---

### Subtask 2.2: Run build

**Command**:
```bash
npm run build
```

**Completion Criteria**:
- [ ] Build completes successfully
- [ ] No warnings related to settings page

---

### Subtask 2.3: Run lint

**Command**:
```bash
npm run lint
```

**Completion Criteria**:
- [ ] Lint passes
- [ ] No ESLint warnings on modified file

---

### Subtask 2.4: Manual verification (via test environment)

**Test URL**: http://172.16.20.50:2345/settings

**Test Steps**:
1. Login as admin (admin@tonsil.tech / changeme123)
2. Navigate to /settings page
3. Observe that page shows "Loading settings..." briefly then shows the SettingsForm
4. Verify no perpetual loading state

**Completion Criteria**:
- [ ] Page does not hang on "Loading settings..."
- [ ] Settings form is displayed with all sections
- [ ] Page is functional and responsive

---

## Phase 3: E2E Test Addition

### Subtask 3.1: Create E2E test for settings page loading

**File**: `/home/pbrown/SkuInventory/tests/e2e/settings-loading.spec.ts` (new file)
**Pattern**: Follow `tests/e2e/orders-loading.spec.ts`

**Instructions**:
Create a new E2E test file with the following tests:
1. Test that settings page does not hang on loading state
2. Test that settings page shows proper content after loading

**Test File Content**:
```typescript
import { test, expect } from '@playwright/test'
import { loginAsAdmin } from './helpers/login'

test.describe('Settings Page Loading State', () => {
  test.beforeEach(async ({ page }) => {
    await loginAsAdmin(page)
  })

  test('Settings page does not hang on loading state', async ({ page }) => {
    // Navigate to settings page
    await page.goto('/settings')

    // Wait for page to load - should NOT stay in loading state forever
    await page.waitForSelector('h1:has-text("Settings")', { timeout: 10000 })

    // Wait for loading to complete - page should NOT show "Loading settings..." for more than 5 seconds
    const loadingComplete = await Promise.race([
      // Option 1: Form appears (settings loaded)
      page.waitForSelector('form', { timeout: 10000 }),
      // Option 2: Loading text disappears
      page.waitForFunction(() => {
        const loadingText = document.body.textContent
        return loadingText && !loadingText.includes('Loading settings...')
      }, { timeout: 10000 })
    ]).then(() => true).catch(() => false)

    // The key assertion: if we see "Loading settings..." after 10 seconds, the bug is NOT fixed
    const pageContent = await page.textContent('body')
    expect(loadingComplete || !pageContent?.includes('Loading settings...')).toBeTruthy()
  })

  test('Settings page shows form after loading', async ({ page }) => {
    // Navigate to settings page
    await page.goto('/settings')

    // Wait for page to finish loading (max 10 seconds)
    await page.waitForSelector('h1:has-text("Settings")', { timeout: 10000 })

    // Wait for loading to complete
    await page.waitForFunction(() => {
      const body = document.body.textContent || ''
      return !body.includes('Loading settings...')
    }, { timeout: 10000 })

    // Page should now show either:
    // 1. Settings form with sections
    // 2. Error message (if API failed)
    // 3. Some other completed state (not loading)
    const pageText = await page.textContent('body')
    expect(pageText).not.toContain('Loading settings...')

    // Verify form is visible (admin should see settings form)
    await expect(page.locator('form').first()).toBeVisible({ timeout: 5000 })
  })
})
```

**Completion Criteria**:
- [ ] Test file created at correct path
- [ ] Tests pass when run with `npx playwright test tests/e2e/settings-loading.spec.ts`

---

### Subtask 3.2: Run E2E tests

**Command**:
```bash
npx playwright test tests/e2e/settings-loading.spec.ts
```

**Completion Criteria**:
- [ ] Both tests pass
- [ ] No timeout errors

---

## Summary of Deliverables

**Files Created**: 1
- `/home/pbrown/SkuInventory/tests/e2e/settings-loading.spec.ts`

**Files Modified**: 1
- `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/page.tsx`

**Changes Summary**:
1. Destructure `status` from `useSession()` (line 9)
2. Update useEffect to handle session loading state (lines 31-35)
3. Update loading condition to include session status (line 53)

---

## Handoff to Build Agent

1. Execute subtasks in exact order (1.1 -> 1.2 -> 1.3 -> 2.1 -> 2.2 -> 2.3 -> 2.4 -> 3.1 -> 3.2)
2. Each subtask has specific code changes - follow exactly
3. Test completion criteria before moving to next subtask
4. Follow reference patterns from `orders/page.tsx` (the most recently fixed page)

---

## Test Strategy Note

- **Unit tests**: No existing unit tests for settings page - E2E coverage is sufficient
- **E2E tests**: Create new test file following `orders-loading.spec.ts` pattern
- **Regression**: The fix is surgical and follows established patterns from #150 and #157

---

## Related Context

This fix is part of a series of similar fixes:
- Issue #150 (orders page) - Fixed in commit `176cec9`
- Issue #157 (forecasts page) - Fixed in commit `9adc77d`
- Issue #161 (settings page) - This issue

All three issues have the same root cause: missing `status` handling from `useSession()`.

---

## Performance Metrics
| Phase | Duration |
|-------|----------|
| Investigation | 10m |
| Validation | 2m |
| Planning | 5m |
| **Total** | **17m** |
