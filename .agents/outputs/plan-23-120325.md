# Implementation Plan
**Generated**: 2025-12-03T10:30:00Z
**Task ID**: Issue #23 - Add Sales Channel Filter to Transactions View
**Estimated Build Time**: 1.5 hours
**Complexity**: Low

## Executive Summary

This feature adds a sales channel filter dropdown to the Transactions page, allowing users to filter transactions by their associated sales channel (Amazon, Shopify, TikTok, Generic). The salesChannel field already exists in the database and is returned in API responses; we only need to add filtering capability across 4 files: the type schema, API route, export route, and UI component.

## Schema Verification (Completed)

**Database field verified**: `Transaction.salesChannel` exists as `String? @db.VarChar(50)` (line 138 in schema.prisma)

**Available sales channels verified**: `['Amazon', 'Shopify', 'TikTok', 'Generic']` defined at `/home/pbrown/SkuInventory/src/types/index.ts` line 34

**No migration required** - field already exists in database.

## Ripple Effect Analysis (Validated)

Scout's file count verified - 4 core files + 1 optional test file:
1. `/home/pbrown/SkuInventory/src/types/transaction.ts` - Add salesChannel to query schema
2. `/home/pbrown/SkuInventory/src/app/api/transactions/route.ts` - Add filter logic
3. `/home/pbrown/SkuInventory/src/app/(dashboard)/transactions/page.tsx` - Add UI filter
4. `/home/pbrown/SkuInventory/src/app/api/export/transactions/route.ts` - Add export filter
5. `/home/pbrown/SkuInventory/tests/integration/transactions.test.ts` - Add test (optional but recommended)

**No additional files identified** - salesChannel is self-contained within transactions functionality.

## UI Acceptance Criteria

- [x] Element visible in filter bar on desktop (1024px+)
- [x] Element visible in filter bar on tablet (768px-1023px)
- [x] Element visible in filter bar on mobile (<768px)
- [x] Element is interactive (Select dropdown)
- [x] Filter works with existing filters (type, dates)
- [x] Clear Filters button resets salesChannel

**UI Location**: Filter card, between "Date To" input and Apply/Clear buttons (follows existing pattern)

---

## Phase 1: Type Schema Update

### Subtask 1.1: Add salesChannel to transactionListQuerySchema

**File**: `/home/pbrown/SkuInventory/src/types/transaction.ts`
**Lines**: 72-82
**Pattern Reference**: Current schema structure uses Zod with optional string parameters

**Instructions**:
1. Locate the `transactionListQuerySchema` (lines 72-82)
2. Add `salesChannel: z.string().optional()` after `skuId` field (line 77)

**Code Change**:
```typescript
// Before (lines 72-82):
export const transactionListQuerySchema = z.object({
  page: z.coerce.number().int().positive().default(1),
  pageSize: z.coerce.number().int().positive().max(100).default(50),
  type: z.enum(['receipt', 'build', 'adjustment', 'initial']).optional(),
  componentId: z.string().uuid().optional(),
  skuId: z.string().uuid().optional(),
  dateFrom: z.coerce.date().optional(),
  dateTo: z.coerce.date().optional(),
  sortBy: z.enum(['date', 'createdAt', 'type']).default('createdAt'),
  sortOrder: z.enum(['asc', 'desc']).default('desc'),
})

// After:
export const transactionListQuerySchema = z.object({
  page: z.coerce.number().int().positive().default(1),
  pageSize: z.coerce.number().int().positive().max(100).default(50),
  type: z.enum(['receipt', 'build', 'adjustment', 'initial']).optional(),
  componentId: z.string().uuid().optional(),
  skuId: z.string().uuid().optional(),
  salesChannel: z.string().optional(),
  dateFrom: z.coerce.date().optional(),
  dateTo: z.coerce.date().optional(),
  sortBy: z.enum(['date', 'createdAt', 'type']).default('createdAt'),
  sortOrder: z.enum(['asc', 'desc']).default('desc'),
})
```

**Validation Commands**:
```bash
npx tsc --noEmit
```

**Completion Criteria**:
- [ ] TypeScript compiles without errors
- [ ] `TransactionListQuery` type now includes `salesChannel?: string`

---

## Phase 2: API Route Updates

### Subtask 2.1: Add salesChannel filter to transactions GET route

**File**: `/home/pbrown/SkuInventory/src/app/api/transactions/route.ts`
**Lines**: 21-42
**Pattern Reference**: Existing filter pattern uses conditional spread syntax

**Instructions**:
1. Add `salesChannel` to destructured variables on line 21
2. Add salesChannel filter to where clause after `skuId` filter (around line 28)

**Code Changes**:

**Change 1 - Line 21 (destructure)**:
```typescript
// Before:
const { page, pageSize, type, componentId, skuId, dateFrom, dateTo, sortBy, sortOrder } =
  queryResult.data

// After:
const { page, pageSize, type, componentId, skuId, salesChannel, dateFrom, dateTo, sortBy, sortOrder } =
  queryResult.data
```

**Change 2 - Lines 25-42 (where clause)**:
```typescript
// Before (partial):
const where: Prisma.TransactionWhereInput = {
  companyId: session.user.companyId,
  ...(type && { type }),
  ...(skuId && { skuId }),
  ...(componentId && {
    lines: {
      some: { componentId },
    },
  }),
  // ... date filters
}

// After:
const where: Prisma.TransactionWhereInput = {
  companyId: session.user.companyId,
  ...(type && { type }),
  ...(skuId && { skuId }),
  ...(salesChannel && { salesChannel }),
  ...(componentId && {
    lines: {
      some: { componentId },
    },
  }),
  // ... date filters remain unchanged
}
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] TypeScript compiles without errors
- [ ] Build succeeds
- [ ] API returns filtered results when `?salesChannel=Amazon` is passed

---

### Subtask 2.2: Add salesChannel filter to export transactions route

**File**: `/home/pbrown/SkuInventory/src/app/api/export/transactions/route.ts`
**Lines**: 22-61
**Pattern Reference**: Existing filter pattern reads from searchParams and adds to where clause conditionally

**Instructions**:
1. Read salesChannel from searchParams (after line 25)
2. Add salesChannel filter to where clause (after type filter, around line 51)

**Code Changes**:

**Change 1 - Line 25 (read param)**:
```typescript
// Before:
const type = searchParams.get('type')
const dateFrom = searchParams.get('dateFrom')
const dateTo = searchParams.get('dateTo')

// After:
const type = searchParams.get('type')
const salesChannel = searchParams.get('salesChannel')
const dateFrom = searchParams.get('dateFrom')
const dateTo = searchParams.get('dateTo')
```

**Change 2 - After line 51 (add filter)**:
```typescript
// Before:
if (type) {
  where.type = type as Prisma.EnumTransactionTypeFilter
}

if (dateFrom || dateTo) {
  // ...
}

// After:
if (type) {
  where.type = type as Prisma.EnumTransactionTypeFilter
}

if (salesChannel) {
  where.salesChannel = salesChannel
}

if (dateFrom || dateTo) {
  // ... unchanged
}
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
```

**Completion Criteria**:
- [ ] TypeScript compiles without errors
- [ ] Build succeeds
- [ ] Export API filters by salesChannel when parameter provided

---

## Phase 3: Frontend UI Update

### Subtask 3.1: Add salesChannel filter to Transactions page

**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/transactions/page.tsx`
**Pattern Reference**: SKUTable component lines 93-108 at `/home/pbrown/SkuInventory/src/components/features/SKUTable.tsx`

**Instructions**:

**Step 1 - Line 4-26 area: Add import for salesChannels**
```typescript
// Add to imports (after line 26):
import { salesChannels } from '@/types'
```

**Step 2 - Lines 49-55: Add salesChannel to filters state**
```typescript
// Before:
const [filters, setFilters] = useState({
  type: searchParams.get('type') ?? '',
  componentId: searchParams.get('componentId') ?? '',
  skuId: searchParams.get('skuId') ?? '',
  dateFrom: searchParams.get('dateFrom') ?? '',
  dateTo: searchParams.get('dateTo') ?? '',
})

// After:
const [filters, setFilters] = useState({
  type: searchParams.get('type') ?? '',
  componentId: searchParams.get('componentId') ?? '',
  skuId: searchParams.get('skuId') ?? '',
  salesChannel: searchParams.get('salesChannel') ?? '',
  dateFrom: searchParams.get('dateFrom') ?? '',
  dateTo: searchParams.get('dateTo') ?? '',
})
```

**Step 3 - Line 84 area: Add salesChannel to fetch params**
```typescript
// After line 84 (if (filters.dateTo) params.set('dateTo', filters.dateTo)):
if (filters.salesChannel) params.set('salesChannel', filters.salesChannel)
```

**Step 4 - Lines 109-115: Add salesChannel to clear filters**
```typescript
// Before:
const handleClearFilters = () => {
  setFilters({
    type: '',
    componentId: '',
    skuId: '',
    dateFrom: '',
    dateTo: '',
  })
  router.push('/transactions')
}

// After:
const handleClearFilters = () => {
  setFilters({
    type: '',
    componentId: '',
    skuId: '',
    salesChannel: '',
    dateFrom: '',
    dateTo: '',
  })
  router.push('/transactions')
}
```

**Step 5 - Lines 150-154: Add salesChannel to exportQueryParams**
```typescript
// Before:
const exportQueryParams = {
  type: filters.type,
  dateFrom: filters.dateFrom,
  dateTo: filters.dateTo,
}

// After:
const exportQueryParams = {
  type: filters.type,
  salesChannel: filters.salesChannel,
  dateFrom: filters.dateFrom,
  dateTo: filters.dateTo,
}
```

**Step 6 - After line 212 (after Date To div, before flex gap-2 div): Add Sales Channel Select**
```tsx
<div className="space-y-1">
  <label className="text-xs text-muted-foreground">Sales Channel</label>
  <Select
    value={filters.salesChannel || 'all'}
    onValueChange={(value) => setFilters((prev) => ({ ...prev, salesChannel: value === 'all' ? '' : value }))}
  >
    <SelectTrigger className="w-[150px]">
      <SelectValue placeholder="All Channels" />
    </SelectTrigger>
    <SelectContent>
      <SelectItem value="all">All Channels</SelectItem>
      {salesChannels.map((channel) => (
        <SelectItem key={channel} value={channel}>
          {channel}
        </SelectItem>
      ))}
    </SelectContent>
  </Select>
</div>
```

**Validation Commands**:
```bash
npx tsc --noEmit
npm run build
npm run lint
```

**Completion Criteria**:
- [ ] TypeScript compiles without errors
- [ ] Build succeeds
- [ ] Lint passes
- [ ] Sales Channel dropdown appears in filter bar
- [ ] Selecting a channel updates URL params
- [ ] Clear Filters resets Sales Channel to "All Channels"
- [ ] Export button passes salesChannel filter

---

## Phase 4: Testing (Optional but Recommended)

### Subtask 4.1: Add integration test for salesChannel filter

**File**: `/home/pbrown/SkuInventory/tests/integration/transactions.test.ts`
**Pattern Reference**: Existing test structure in same file

**Instructions**:
Add a new test case within the existing describe block to verify salesChannel filtering.

**Code to Add** (at end of describe block, before closing):
```typescript
describe('Transaction Filtering', () => {
  it('filters transactions by salesChannel', async () => {
    setTestSession(TEST_SESSIONS.admin!)
    const prisma = getIntegrationPrisma()

    // Create a component and SKU for build transactions
    const component = await createTestComponentInDb(TEST_SESSIONS.admin!.user.companyId)
    const sku = await createTestSKUInDb(TEST_SESSIONS.admin!.user.companyId, {
      salesChannel: 'Amazon',
    })

    // Create BOM version for the SKU
    const bomVersion = await prisma.bOMVersion.create({
      data: {
        skuId: sku.id,
        versionName: 'v1.0',
        isDefault: true,
        createdById: TEST_SESSIONS.admin!.user.id,
        items: {
          create: {
            componentId: component.id,
            quantityNeeded: 1,
          },
        },
      },
    })

    // First add inventory via receipt
    const receiptRequest = createTestRequest('/api/transactions/receipt', {
      method: 'POST',
      body: {
        componentId: component.id,
        quantity: 100,
        supplier: 'Test',
        date: new Date().toISOString().split('T')[0],
      },
    })
    await createReceipt(receiptRequest)

    // Create a build transaction with Amazon channel
    const buildRequest = createTestRequest('/api/transactions/build', {
      method: 'POST',
      body: {
        skuId: sku.id,
        unitsToBuild: 5,
        salesChannel: 'Amazon',
        date: new Date().toISOString().split('T')[0],
      },
    })
    await createBuild(buildRequest)

    // Filter by Amazon - should find the build
    const amazonRequest = createTestRequest('/api/transactions?salesChannel=Amazon')
    const amazonResponse = await getTransactions(amazonRequest)
    const amazonResult = await parseRouteResponse(amazonResponse)

    expect(amazonResult.status).toBe(200)
    expect(amazonResult.body.data.some((tx: { salesChannel: string }) => tx.salesChannel === 'Amazon')).toBe(true)

    // Filter by Shopify - should not find the Amazon build
    const shopifyRequest = createTestRequest('/api/transactions?salesChannel=Shopify')
    const shopifyResponse = await getTransactions(shopifyRequest)
    const shopifyResult = await parseRouteResponse(shopifyResponse)

    expect(shopifyResult.status).toBe(200)
    const shopifyBuilds = shopifyResult.body.data.filter((tx: { type: string; salesChannel: string }) =>
      tx.type === 'build' && tx.salesChannel === 'Shopify'
    )
    expect(shopifyBuilds.length).toBe(0)
  })
})
```

**Validation Commands**:
```bash
npm test -- --testPathPattern="transactions.test.ts"
```

**Completion Criteria**:
- [ ] Test passes
- [ ] No test regressions

---

## Summary of Deliverables

**Files Created**: 0
**Files Modified**: 4 (+ 1 optional test file)

| File | Type | Changes |
|------|------|---------|
| `/home/pbrown/SkuInventory/src/types/transaction.ts` | Type Schema | Add salesChannel to query schema |
| `/home/pbrown/SkuInventory/src/app/api/transactions/route.ts` | API Route | Add salesChannel filter to where clause |
| `/home/pbrown/SkuInventory/src/app/api/export/transactions/route.ts` | API Route | Add salesChannel filter to export |
| `/home/pbrown/SkuInventory/src/app/(dashboard)/transactions/page.tsx` | UI Component | Add Select dropdown and wire up state |
| `/home/pbrown/SkuInventory/tests/integration/transactions.test.ts` | Test (Optional) | Add filter test |

---

## Acceptance Criteria Mapping

| Acceptance Criteria | Implementation Location | Subtask |
|---------------------|------------------------|---------|
| Add salesChannel param to API schema | `src/types/transaction.ts` | 1.1 |
| API filters by salesChannel | `src/app/api/transactions/route.ts` | 2.1 |
| UI has Select dropdown with channels | `src/app/(dashboard)/transactions/page.tsx` | 3.1 |
| Shows "All Channels" + Amazon/Shopify/TikTok/Generic | `src/app/(dashboard)/transactions/page.tsx` | 3.1 |
| Filter matches existing UI pattern | Copy from SKUTable pattern | 3.1 |
| Clear Filters resets salesChannel | `handleClearFilters` function | 3.1 |
| Export respects salesChannel filter | `src/app/api/export/transactions/route.ts` + `exportQueryParams` | 2.2, 3.1 |
| Filter combines with other filters | Where clause uses spread syntax | 2.1 |
| URL params updated when filter changes | `updateFilters` function | 3.1 |
| Page resets to page 1 on filter | `updateFilters` already does this | N/A |

---

## Handoff to Build Agent

1. Execute subtasks in exact order (1.1 -> 2.1 -> 2.2 -> 3.1 -> 4.1)
2. Run validation commands after each subtask
3. Test completion criteria before moving to next subtask
4. Copy code patterns exactly from the reference files
5. Do NOT skip the import statement for `salesChannels`

### Manual Testing Checklist (After Build)

1. [ ] Navigate to Transactions page
2. [ ] Verify Sales Channel dropdown appears between Date To and Apply button
3. [ ] Select "Amazon" and click Apply - URL should update, table should filter
4. [ ] Select a Type filter AND Sales Channel - both should work together
5. [ ] Click Clear - all filters reset including Sales Channel
6. [ ] With Sales Channel filter active, click Export - verify exported CSV only contains filtered transactions
7. [ ] Test on mobile viewport - filter should still be visible

---

## Performance Metrics

| Phase | Duration |
|-------|----------|
| Scout Review | 5m |
| Schema Verification | 3m |
| Pattern Research | 5m |
| Plan Writing | 12m |
| **Total** | **25m** |

---

AGENT_RETURN: plan-23-120325
