# Implementation Plan
**Generated**: 2025-12-31T05:00:00Z
**Generated By**: Scout-and-Plan Agent (combined workflow)
**Task ID**: Issue #339 - Feature: Shopify integration - enable data views and verify sync
**Estimated Build Time**: 4-6 hours
**Complexity**: Moderate

## Investigation Summary

### Request Analysis
**Type**: Feature (Enable existing functionality)
**Source**: GitHub Issue #339
**Priority**: High

### Task Classification
**Category**: VERIFICATION + CHORE (minimal new code, mostly enabling existing code)
**Test Strategy**: TARGETED (affected modules, manual verification)
**Suggested Filter**: None - manual verification required

### Issue Validation
**Status**: Valid
**Recent Changes**: Issue #313 fixed selectedCompanyId bug in Shopify routes (Dec 17)

### Current State Assessment

**The Shopify integration is already 90% implemented.** Key findings:

1. **Fully Working - Orders UI**:
   - `/shopify/orders` page shows synced orders (accessible via sidebar for admins)
   - `/shopify/orders/[id]` order detail page with line item mapping
   - `OrderReviewTable`, `OrderDetail`, `LineMappingDialog` components work
   - API routes: `/api/shopify/orders/*` fully implemented

2. **Fully Working - Connection Management**:
   - `ShopifyCard` component on `/integrations` page allows connect/sync/disconnect
   - OAuth flow in `/api/integrations/shopify/*` routes
   - Sync service at `src/services/shopify/sync.ts` fully implemented

3. **Fully Working - SKU Mappings API**:
   - `/api/shopify/mappings/*` routes for CRUD operations
   - `SkuMappingTable`, `SkuMappingForm` components ready

4. **DISABLED - Settings/Integrations Page**:
   - `/src/app/(dashboard)/settings/integrations/page.tsx` shows V2 placeholder
   - This page should be replaced or removed since `/integrations` works

5. **MISSING - Dedicated SKU Mappings Page**:
   - The page exists in `src/_deferred/shopify/pages/settings/mappings/page.tsx`
   - Needs to be activated at a proper route (e.g., `/shopify/mappings`)

6. **NEEDS VERIFICATION**:
   - Sync actually works with real Shopify credentials
   - Order data includes all expected fields
   - Line item mapping workflow complete

### Dependencies & Blockers
1. Environment variables must be configured:
   - `SHOPIFY_CLIENT_ID`
   - `SHOPIFY_CLIENT_SECRET`
   - `SHOPIFY_REDIRECT_URI`
2. Shopify store must be connected to test sync

**Can Proceed?**: YES

### Complexity Assessment
**Complexity**: Moderate
**Effort**: 4-6 hours
**Risk**: Low (mostly enabling existing code, minimal new development)

### Patterns Identified
**Primary**: Existing Shopify components in `src/components/features/` and `src/components/integrations/`
**Secondary**: Existing API routes in `src/app/api/shopify/`

### Ripple Effect Analysis
**Files Identified**: 8 files to modify/create
- `/src/app/(dashboard)/settings/integrations/page.tsx` - Redirect or replace
- `/src/app/(dashboard)/shopify/mappings/page.tsx` - NEW (activate from deferred)
- Layout navigation - possibly add mappings link under Shopify
- Test files for sync verification

---

## Executive Summary

This issue requires enabling the already-implemented Shopify integration by:
1. Replacing the V2 placeholder in settings/integrations with a redirect (since `/integrations` works)
2. Activating the deferred SKU channel mappings page at `/shopify/mappings`
3. Adding navigation to the mappings page
4. Verifying the sync works correctly with test data
5. Documenting the SKU mapping workflow

## Phase 0: Environment Verification

### Subtask 0.1: Verify Shopify Environment Variables
**File**: Check `.env` or environment configuration
**Instructions**:
1. Verify these env vars are configured:
   - `SHOPIFY_CLIENT_ID` - Shopify app client ID
   - `SHOPIFY_CLIENT_SECRET` - Shopify app client secret
   - `SHOPIFY_REDIRECT_URI` - OAuth callback URL (e.g., `http://172.16.20.50:2345/api/integrations/shopify/callback`)
2. If not configured, document as a blocker (requires manual setup by user)
**Completion Criteria**: [ ] Env vars documented, [ ] Fallback behavior noted if missing

### Subtask 0.2: Verify Test Environment Running
**Instructions**:
```bash
cd /home/pbrown/SkuInventory/docker
docker compose -f docker-compose.test.yml ps
```
Ensure test containers are running.
**Completion Criteria**: [ ] Test environment accessible at http://172.16.20.50:2345

---

## Phase 1: Replace Settings/Integrations V2 Placeholder

### Subtask 1.1: Update Settings Integrations Page
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/settings/integrations/page.tsx`
**Pattern**: N/A - simple redirect or replacement
**Instructions**:
1. Replace the V2 placeholder content with a redirect to `/integrations`
2. OR simply render the actual integration cards like the `/integrations` page does
3. Recommended approach: Use `redirect('/integrations')` from `next/navigation`

**Option A - Simple Redirect:**
```typescript
import { redirect } from 'next/navigation'

export default function IntegrationsPage() {
  redirect('/integrations')
}
```

**Option B - Match /integrations page content:**
Copy the working content from `/src/app/(dashboard)/integrations/page.tsx`

**Completion Criteria**:
- [ ] Settings > Integrations no longer shows "Coming in V2" placeholders
- [ ] Users can access Shopify connection functionality

---

## Phase 2: Activate SKU Channel Mappings Page

### Subtask 2.1: Create Mappings Page Route
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/shopify/mappings/page.tsx` (NEW)
**Pattern**: Copy from `/home/pbrown/SkuInventory/src/_deferred/shopify/pages/settings/mappings/page.tsx`
**Instructions**:
1. Create directory: `/src/app/(dashboard)/shopify/mappings/`
2. Copy the deferred mappings page to the new location
3. Verify all imports resolve correctly (they should, as the components are active)
4. Test the page loads at `/shopify/mappings`

**Validation:**
```bash
npm run build
# Verify /shopify/mappings route is generated
```

**Completion Criteria**:
- [ ] Page accessible at `/shopify/mappings`
- [ ] Mappings table loads (may be empty if no mappings exist)
- [ ] Add Mapping button opens form
- [ ] Import CSV functionality works

### Subtask 2.2: Add Mappings Link to Shopify Navigation
**File**: `/home/pbrown/SkuInventory/src/app/(dashboard)/layout.tsx`
**Instructions**:
1. Modify the Shopify nav item or add a sub-navigation for Shopify:
   - Option A: Change href from `/shopify/orders` to `/shopify` and add sub-items
   - Option B: Add a separate "SKU Mappings" nav item for admins

**Option B (simpler):**
Add after the Shopify item in `mainNavigation`:
```typescript
{ name: 'SKU Mappings', href: '/shopify/mappings', icon: Link2, adminOnly: true },
```

Or modify to be a dropdown like Settings (more complex).

**Recommended**: Just add as separate nav item for now.

**Completion Criteria**:
- [ ] SKU Mappings accessible from sidebar
- [ ] Link only visible to admins

---

## Phase 3: Sync Verification

### Subtask 3.1: Manual Sync Test
**Instructions**:
1. Navigate to `/integrations` as admin
2. If Shopify is connected, click "Sync Now" button
3. Verify sync completes without errors
4. Navigate to `/shopify/orders` and verify orders appear
5. Check an order detail to see line items

**If Shopify is NOT connected:**
1. Document that connection is required first
2. Connection requires OAuth flow with real Shopify store

**Completion Criteria**:
- [ ] Sync runs without API errors
- [ ] Orders appear in orders list (if connected)
- [ ] Line items show correct data

### Subtask 3.2: Verify Order Data Structure
**Instructions**:
1. View an order at `/shopify/orders/[id]`
2. Verify these fields display correctly:
   - Order number
   - Order date
   - Fulfillment status (fulfilled/unfulfilled)
   - Financial status
   - Line items with titles, SKUs, quantities, prices
3. Check line item mapping status badges

**Completion Criteria**:
- [ ] All order fields display correctly
- [ ] Line items show mapping status (Mapped/No SKU/Not Found)

### Subtask 3.3: Verify SKU Mapping Workflow
**Instructions**:
1. On an order with unmapped line items, click "Map" button on a line
2. Verify LineMappingDialog opens
3. Search/select an internal SKU
4. Save the mapping
5. Verify mapping status updates to "Mapped"
6. Navigate to `/shopify/mappings` and verify the mapping appears

**Completion Criteria**:
- [ ] Line mapping dialog works
- [ ] Mapping saves correctly
- [ ] Mapping appears in mappings table

---

## Phase 4: Fulfilled vs Unfulfilled Order Handling

### Subtask 4.1: Verify Fulfillment Status Display
**File**: `/home/pbrown/SkuInventory/src/components/features/OrderDetail.tsx`
**Instructions**:
1. Review the fulfillment status display in OrderDetail component
2. Current implementation: Shows "Unfulfilled" when `fulfillmentStatus` is null
3. Verify this displays correctly for both fulfilled and unfulfilled orders

**Already Implemented** - Line 166:
```tsx
<p className="font-medium capitalize">{order.fulfillmentStatus || 'Unfulfilled'}</p>
```

**Completion Criteria**:
- [ ] Fulfilled orders show "fulfilled" or similar
- [ ] Unfulfilled orders show "Unfulfilled"

### Subtask 4.2: Document Fulfilled Order Handling (if needed)
**Instructions**:
If business logic requires different handling for fulfilled vs unfulfilled orders:
1. Document requirements in issue comments
2. Create follow-up issue if changes are needed

Current behavior: All orders sync regardless of fulfillment status. The status is displayed but doesn't affect processing.

**Completion Criteria**:
- [ ] Fulfillment status handling documented

---

## Phase 5: Final Validation

### Subtask 5.1: Build and Type Check
**Instructions**:
```bash
cd /home/pbrown/SkuInventory
npm run build
npx tsc --noEmit
npm run lint
```
**Completion Criteria**:
- [ ] Build passes with no errors
- [ ] TypeScript check passes
- [ ] No lint warnings

### Subtask 5.2: End-to-End Verification
**Instructions**:
1. As admin user, verify this flow works:
   - Navigate to `/integrations` - see Shopify card
   - If connected, see shop name and orders count
   - Navigate to `/shopify/orders` - see order list
   - View order detail - see line items
   - Map a line item to internal SKU
   - Navigate to `/shopify/mappings` - see mapping
2. Verify Settings > Integrations redirects or shows real content

**Completion Criteria**:
- [ ] Full user flow works
- [ ] No console errors in browser

---

## Summary of Deliverables

**Files Created**: 1
- `/src/app/(dashboard)/shopify/mappings/page.tsx` - Channel mappings page

**Files Modified**: 2
- `/src/app/(dashboard)/settings/integrations/page.tsx` - Replace V2 placeholder
- `/src/app/(dashboard)/layout.tsx` - Add SKU Mappings nav link

**Files Verified** (no changes needed): 6+
- All existing Shopify API routes
- All existing Shopify components
- Sync service

## Handoff to Build Agent

1. Execute subtasks in exact order
2. Phase 0 is critical - if env vars not set, document and continue with UI work
3. Phase 3 requires manual testing in browser - document results
4. Follow reference patterns exactly

## Test Strategy Note

- Manual verification required for sync and mapping workflow
- No automated E2E tests for Shopify (would require mock Shopify API)
- Build and TypeScript checks are automated

## Performance Metrics

| Phase | Duration |
|-------|----------|
| Investigation | 25m |
| Validation | 5m |
| Planning | 15m |
| **Total** | **45m** |

---

## Additional Notes

### What Was Already Implemented

The vast majority of Shopify integration was already built:

1. **Database Schema** (Prisma):
   - `ShopifyConnection` - OAuth tokens, shop name, sync status
   - `ShopifyOrder` - Synced order data
   - `ShopifyOrderLine` - Line items with mapping status
   - `SkuChannelMapping` - External ID to internal SKU mappings

2. **API Routes**:
   - `/api/integrations/shopify/connect` - OAuth initiation
   - `/api/integrations/shopify/callback` - OAuth callback
   - `/api/integrations/shopify/disconnect` - Remove connection
   - `/api/integrations/shopify/sync` - Trigger manual sync
   - `/api/integrations/shopify/status` - Connection status
   - `/api/shopify/orders` - List/filter orders
   - `/api/shopify/orders/[id]` - Order detail
   - `/api/shopify/orders/[id]/approve` - Approve order
   - `/api/shopify/orders/[id]/skip` - Skip order
   - `/api/shopify/orders/[id]/lines/[lineId]` - Update line mapping
   - `/api/shopify/mappings` - List/create mappings
   - `/api/shopify/mappings/[id]` - Update/delete mapping
   - `/api/shopify/mappings/import` - CSV import

3. **Services**:
   - `src/services/shopify/client.ts` - Shopify API client
   - `src/services/shopify/sync.ts` - Order sync orchestration
   - `src/services/shopify-sync.ts` - Additional sync utilities

4. **UI Components**:
   - `ShopifyCard` - Connection status and sync button
   - `OrderReviewTable` - Orders list with filters
   - `OrderDetail` - Order detail with line items
   - `LineMappingDialog` - Map line to SKU
   - `SkuMappingTable` - Channel mappings list
   - `SkuMappingForm` - Create/edit mapping

### Why V2 Placeholder Exists

The `settings/integrations` page shows V2 placeholder from earlier PRD V1 decisions that excluded integrations. However, the actual integration was built and is available at `/integrations`. This is a navigation/routing inconsistency that needs cleanup.

### Deferred V2 Code Location

Some code remains in `src/_deferred/shopify/` as reference. The mappings page from there will be activated in Phase 2.
